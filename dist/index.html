<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>RetailEdge Pro | AI Stock Screener & Portfolio Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Tier 3 Libraries: ML & PDF Export -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0/dist/tf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- PWA Manifest -->
  <link rel="manifest" href="#manifest-placeholder">
  <script type="application/json" id="manifest-placeholder">
  {
    "name": "RetailEdge Pro",
    "short_name": "RetailEdge",
    "start_url": "/",
    "display": "standalone",
    "background_color": "#020617",
    "theme_color": "#06b6d4",
    "icons": [
      { "src": "icon-192.png", "sizes": "192x192", "type": "image/png" },
      { "src": "icon-512.png", "sizes": "512x512", "type": "image/png" }
    ]
  }
  </script>

  <style>
    /* Theme Variables */
    :root {
      --bg-main: linear-gradient(135deg, #020617 0%, #0f172a 50%, #020617 100%);
      --bg-solid: #0f172a;
      --card-bg: rgba(30, 41, 59, 0.7);
      --card-border: rgba(100, 116, 139, 0.15);
      --text-main: #e2e8f0;
      --text-secondary: #94a3b8;
      --accent-primary: #06b6d4;
      --accent-secondary: #8b5cf6;
    }

    .light-mode {
      --bg-main: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 50%, #f1f5f9 100%);
      --bg-solid: #f8fafc;
      --card-bg: rgba(255, 255, 255, 0.9);
      --card-border: rgba(148, 163, 184, 0.25);
      --text-main: #1e293b;
      --text-secondary: #64748b;
      --accent-primary: #0891b2;
      --accent-secondary: #7c3aed;
    }

    /* Skeleton Loading Animation */
    @keyframes shimmer {
      0% {
        background-position: -1000px 0;
      }

      100% {
        background-position: 1000px 0;
      }
    }

    .skeleton {
      background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
      background-size: 1000px 100%;
      animation: shimmer 2s infinite linear;
      border-radius: 8px;
    }

    .light-mode .skeleton {
      background: linear-gradient(90deg, #e2e8f0 25%, #cbd5e1 50%, #e2e8f0 75%);
      background-size: 1000px 100%;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--bg-main);
      min-height: 100vh;
      font-family: 'Inter', sans-serif;
      color: #e2e8f0;
    }

    .font-mono {
      font-family: 'JetBrains Mono', monospace;
    }

    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: #0f172a;
    }

    ::-webkit-scrollbar-thumb {
      background: #475569;
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #64748b;
    }

    /* Glassmorphism */
    .glass {
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(16px);
      border: 1px solid rgba(100, 116, 139, 0.2);
    }

    .glass-card {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.7) 0%, rgba(15, 23, 42, 0.9) 100%);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(100, 116, 139, 0.15);
      transition: all 0.3s ease;
    }

    .glass-card:hover {
      border-color: rgba(6, 182, 212, 0.4);
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(6, 182, 212, 0.1);
    }

    .glass-elevated {
      background: rgba(30, 41, 59, 0.85);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(100, 116, 139, 0.25);
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
    }

    /* Animations */
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.5;
      }
    }

    @keyframes glow {

      0%,
      100% {
        box-shadow: 0 0 5px rgba(6, 182, 212, 0.3);
      }

      50% {
        box-shadow: 0 0 20px rgba(6, 182, 212, 0.6);
      }
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    /* Loading States */
    .data-loading {
      opacity: 0.7;
      pointer-events: none;
    }

    .data-loaded {
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from {
        opacity: 0.5;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes slideInLeft {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .animate-slide-up {
      animation: slideUp 0.4s ease-out;
    }

    .animate-fade-in {
      animation: fadeIn 0.3s ease;
    }

    .animate-pulse {
      animation: pulse 2s infinite;
    }

    .animate-glow {
      animation: glow 2s ease-in-out infinite;
    }

    .animate-spin {
      animation: spin 1s linear infinite;
    }

    .animate-slideInLeft {
      animation: slideInLeft 0.3s ease-out;
    }

    /* Table */
    .table-row {
      transition: all 0.15s ease;
      border-left: 3px solid transparent;
    }

    .table-row:hover {
      background: rgba(6, 182, 212, 0.06);
      cursor: pointer;
      border-left-color: rgba(6, 182, 212, 0.3);
    }

    .table-row.selected {
      background: rgba(6, 182, 212, 0.1);
      border-left-color: #06b6d4;
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.9);
      backdrop-filter: blur(8px);
      z-index: 1000;
      overflow-y: auto;
    }

    /* Tabs */
    .tab-btn {
      padding: 12px 20px;
      font-size: 13px;
      font-weight: 600;
      border-bottom: 2px solid transparent;
      color: #64748b;
      transition: all 0.2s;
    }

    .tab-btn:hover {
      background: rgba(255, 255, 255, 0.03);
      color: #94a3b8;
    }

    .tab-btn.active {
      border-color: #06b6d4;
      color: #06b6d4;
    }

    /* ===== FIXED: Add underline-on-hover for fundamentals tab ===== */
    .fundamentals-tab {
      position: relative;
    }

    .fundamentals-tab:hover {
      background: rgba(255, 255, 255, 0.03);
    }

    .fundamentals-tab.active {
      border-color: #06b6d4;
      color: #06b6d4;
    }

    .fundamentals-content {
      display: none;
    }

    .fundamentals-content.active {
      display: block;
    }

    /* Chips & Badges */
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 9999px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.025em;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 700;
    }

    /* Sparkline */
    .sparkline {
      display: flex;
      align-items: flex-end;
      gap: 1px;
      height: 28px;
    }

    .sparkline-bar {
      width: 3px;
      border-radius: 1px;
      transition: height 0.3s;
    }

    /* Health & Progress Bars */
    .health-bar {
      height: 6px;
      border-radius: 3px;
      background: #1e293b;
      overflow: hidden;
    }

    .health-fill {
      height: 100%;
      border-radius: 3px;
      transition: width 0.5s ease;
    }

    /* Range Inputs */
    input[type=range] {
      -webkit-appearance: none;
      background: transparent;
      width: 100%;
    }

    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      height: 16px;
      width: 16px;
      border-radius: 50%;
      background: #06b6d4;
      cursor: pointer;
      margin-top: -6px;
      box-shadow: 0 2px 6px rgba(6, 182, 212, 0.4);
    }

    input[type=range]::-webkit-slider-runnable-track {
      width: 100%;
      height: 4px;
      background: #334155;
      border-radius: 2px;
    }

    /* Theme Pills */
    .theme-pill {
      padding: 8px 16px;
      border-radius: 24px;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
      cursor: pointer;
      border: 1px solid transparent;
    }

    .theme-pill:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(100, 116, 139, 0.3);
    }

    .theme-pill.active {
      background: linear-gradient(135deg, rgba(6, 182, 212, 0.2), rgba(139, 92, 246, 0.2));
      border-color: rgba(6, 182, 212, 0.4);
      color: #06b6d4;
    }

    /* Tooltips */
    .tooltip {
      position: relative;
    }

    .tooltip-content {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(-8px);
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 12px 16px;
      width: 280px;
      font-size: 12px;
      line-height: 1.6;
      opacity: 0;
      visibility: hidden;
      transition: all 0.2s;
      z-index: 100;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
      pointer-events: none;
    }

    .tooltip:hover .tooltip-content {
      opacity: 1;
      visibility: visible;
    }

    /* Verdict Styles */
    .verdict-bullish {
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.1) 0%, rgba(34, 197, 94, 0.02) 100%);
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .verdict-bearish {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(239, 68, 68, 0.02) 100%);
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .verdict-neutral {
      background: linear-gradient(135deg, rgba(234, 179, 8, 0.1) 0%, rgba(234, 179, 8, 0.02) 100%);
      border: 1px solid rgba(234, 179, 8, 0.3);
    }

    /* Live Indicator */
    .live-dot {
      width: 8px;
      height: 8px;
      background: #22c55e;
      border-radius: 50%;
      animation: glow 2s ease-in-out infinite;
    }

    .live-indicator {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 12px;
      background: rgba(34, 197, 94, 0.1);
      border: 1px solid rgba(34, 197, 94, 0.3);
      font-size: 10px;
      font-weight: 600;
      color: #22c55e;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .live-indicator.offline {
      background: rgba(148, 163, 184, 0.1);
      border-color: rgba(148, 163, 184, 0.3);
      color: #94a3b8;
    }

    .live-indicator.offline .live-dot {
      background: #94a3b8;
      animation: none;
    }

    /* Tournament Status Indicator */
    .tournament-status-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
    }

    /* Preset Screen Cards */
    .preset-card {
      background: rgba(30, 41, 59, 0.5);
      border: 1px solid rgba(100, 116, 139, 0.2);
      border-radius: 10px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .preset-card:hover {
      border-color: #06b6d4;
      background: rgba(6, 182, 212, 0.05);
    }

    .preset-card.active {
      border-color: #06b6d4;
      background: rgba(6, 182, 212, 0.1);
    }

    /* Column Selector */
    .column-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .column-toggle:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .column-toggle.active {
      background: rgba(6, 182, 212, 0.15);
    }

    /* P&L Colors */
    .pnl-positive {
      color: #22c55e;
    }

    .pnl-negative {
      color: #ef4444;
    }

    .pnl-neutral {
      color: #94a3b8;
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MOBILE RESPONSIVE STYLES - PHASE 1 ENHANCED
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    @media (max-width: 768px) {

      /* Hide desktop table, show mobile cards */
      .stock-table-container {
        display: none;
      }

      .mobile-stock-cards {
        display: block !important;
      }

      /* Stock cards for mobile */
      .stock-card {
        background: rgba(30, 41, 59, 0.8);
        border: 1px solid rgba(100, 116, 139, 0.2);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .stock-card:hover {
        background: rgba(30, 41, 59, 0.95);
        border-color: rgba(6, 182, 212, 0.5);
        transform: translateY(-2px);
      }

      .stock-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid rgba(100, 116, 139, 0.2);
      }

      .stock-card-symbol {
        font-size: 20px;
        font-weight: 700;
        color: #06b6d4;
      }

      .stock-card-price {
        font-size: 18px;
        font-weight: 700;
        color: #fff;
      }

      .stock-card-change {
        font-size: 14px;
        font-weight: 600;
      }

      .stock-card-metrics {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-top: 12px;
      }

      .stock-card-metric {
        font-size: 12px;
      }

      .stock-card-metric-label {
        color: #94a3b8;
        font-size: 11px;
        margin-bottom: 4px;
      }

      .stock-card-metric-value {
        color: #fff;
        font-weight: 600;
        font-size: 14px;
      }

      .stock-card-verdict {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid rgba(100, 116, 139, 0.2);
        text-align: center;
      }

      /* Larger tap targets */
      button,
      .tab-btn,
      a.button {
        min-height: 44px;
        padding: 12px 16px;
        font-size: 14px;
      }

      /* Full screen modals on mobile */
      .modal-overlay {
        padding: 0;
      }

      .modal-content {
        width: 100vw;
        height: 100vh;
        max-height: 100vh;
        max-width: 100vw;
        border-radius: 0;
        margin: 0;
      }

      .modal-header {
        position: sticky;
        top: 0;
        z-index: 10;
        background: rgba(15, 23, 42, 0.98);
        backdrop-filter: blur(20px);
      }

      .modal-body {
        padding: 16px;
        padding-bottom: 80px;
        /* Space for bottom nav */
      }

      /* Bottom navigation for mobile */
      .mobile-bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(15, 23, 42, 0.98);
        backdrop-filter: blur(20px);
        border-top: 1px solid rgba(100, 116, 139, 0.2);
        padding: 8px;
        display: flex;
        justify-content: space-around;
        z-index: 1000;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
      }

      .mobile-nav-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 11px;
        color: #94a3b8;
        background: transparent;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
      }

      .mobile-nav-btn.active {
        background: rgba(6, 182, 212, 0.15);
        color: #06b6d4;
      }

      .mobile-nav-icon {
        font-size: 20px;
      }

      /* Export buttons stack on mobile */
      .export-buttons {
        flex-direction: column;
        gap: 8px;
      }

      .export-buttons button {
        width: 100%;
      }

      /* Filters take full width */
      .filters-container {
        flex-direction: column;
      }

      .filter-group {
        width: 100%;
      }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       GOAL PLANNER SPECIFIC STYLES
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    .glass-goal-card {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.7) 0%, rgba(15, 23, 42, 0.9) 100%);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(100, 116, 139, 0.15);
      border-radius: 16px;
      transition: all 0.3s ease;
    }

    .glass-goal-card:hover {
      border-color: rgba(6, 182, 212, 0.4);
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(6, 182, 212, 0.1);
    }

    .goal-progress-ring {
      transform: rotate(-90deg);
      transform-origin: 50% 50%;
    }

    .goal-milestone {
      position: relative;
    }

    .goal-milestone::before {
      content: '';
      position: absolute;
      left: 50%;
      top: 100%;
      width: 1px;
      height: 20px;
      background: linear-gradient(to bottom, rgba(6, 182, 212, 0.5), transparent);
    }

    .goal-input-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .goal-results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
    }

    .goal-action-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    /* Animation for goal completion */
    @keyframes goalComplete {
      0% {
        transform: scale(1);
      }

      50% {
        transform: scale(1.05);
      }

      100% {
        transform: scale(1);
      }
    }

    .goal-complete-animation {
      animation: goalComplete 0.5s ease-in-out;
    }

    /* Tooltip styles for goal explanations */
    .goal-tooltip {
      position: relative;
      display: inline-block;
      cursor: help;
    }

    .goal-tooltip .tooltip-content {
      visibility: hidden;
      position: absolute;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 12px;
      width: 300px;
      font-size: 12px;
      line-height: 1.5;
      z-index: 100;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
    }

    .goal-tooltip:hover .tooltip-content {
      visibility: visible;
    }

    /* Print styles for goal PDF export */
    @media print {
      .goal-planner-print {
        background: white !important;
        color: black !important;
      }

      .goal-planner-print .glass-card {
        background: #f8fafc !important;
        border: 1px solid #e2e8f0 !important;
        color: #1e293b !important;
      }

      .no-print {
        display: none !important;
      }
    }

    @media (min-width: 769px) {
      .mobile-stock-cards {
        display: none;
      }

      .mobile-bottom-nav {
        display: none;
      }
    }

    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       AI TOURNAMENT STATUS INDICATOR
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

    .tournament-live-indicator {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: rgba(15, 23, 42, 0.9);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
      animation: pulse 2s infinite;
    }

    .tournament-live-indicator .live-dot {
      width: 8px;
      height: 8px;
      background: #22c55e;
      border-radius: 50%;
      animation: glow 2s ease-in-out infinite;
    }
  </style>
</head>

<body>
  <div id="root"></div>

  <!-- Firebase Authentication (Optional) -->
  <script type="module">
    // Firebase config - replace with your own or leave as demo mode
    try {
      const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js");
      const { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js");
      const { getFirestore, doc, setDoc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js");

      const firebaseConfig = {
        apiKey: "DEMO_MODE",
        authDomain: "demo.firebaseapp.com",
        projectId: "demo-project"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const provider = new GoogleAuthProvider();

      window.firebaseUtils = { auth, db, provider, signInWithPopup, onAuthStateChanged, doc, setDoc, getDoc };
      console.log('âœ… Firebase initialized (demo mode)');
    } catch (error) {
      console.log('â„¹ï¸ Firebase not configured - running in guest mode');
      window.firebaseUtils = null;
    }
  </script>
  <script src="./config.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/lightweight-charts@4.2.0/dist/lightweight-charts.standalone.production.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script type="text/babel">

    // CRITICAL: Ensure API_BASE_URL is always defined
    if (!window.API_BASE_URL) {
      const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
      window.API_BASE_URL = isLocalhost 
        ? 'http://localhost:3002' 
        : 'https://retailedge-trading-tournament-1.onrender.com';
      console.warn('âš ï¸ API_BASE_URL was undefined, set to:', window.API_BASE_URL);
    }

    // Fix: Add missing checkAndUnlockBadges function
    function checkAndUnlockBadges(portfolio, watchlist, goals, options) {
      // Placeholder: No badges unlocked
      return [];
    }

    const { useState, useEffect, useMemo, useCallback, useRef } = React;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CLOUD STORE HOOK - Real-time Firebase sync with localStorage fallback
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function useCloudStore(key, defaultValue) {
      const [data, setData] = useState(() => {
        // Try localStorage first
        try {
          const stored = localStorage.getItem(`re_${key}`);
          return stored ? JSON.parse(stored) : defaultValue;
        } catch {
          return defaultValue;
        }
      });

      // Listen to Firebase if authenticated
      useEffect(() => {
        if (!window.firebaseUtils?.db) return;

        const { db, doc, onSnapshot } = window.firebaseUtils;
        const user = window.firebaseUtils.auth?.currentUser;
        if (!user) return;

        try {
          const docRef = doc(db, 'users', user.uid, 'app', key);
          const unsubscribe = onSnapshot(docRef, (snapshot) => {
            if (snapshot.exists()) {
              const cloudData = snapshot.data()?.value;
              if (cloudData !== undefined) {
                setData(cloudData);
                localStorage.setItem(`re_${key}`, JSON.stringify(cloudData));
              }
            }
          });
          return unsubscribe;
        } catch (error) {
          console.warn('Cloud sync unavailable:', error);
        }
      }, [key]);

      const save = useCallback(async (value) => {
        setData(value);

        // Save to localStorage
        try {
          localStorage.setItem(`re_${key}`, JSON.stringify(value));
        } catch (error) {
          console.warn('Failed to save to localStorage:', error);
        }

        // Save to Firebase if available
        if (window.firebaseUtils?.db) {
          const user = window.firebaseUtils.auth?.currentUser;
          if (user) {
            try {
              const { db, doc, setDoc } = window.firebaseUtils;
              await setDoc(doc(db, 'users', user.uid, 'app', key), {
                value,
                updatedAt: new Date().toISOString()
              });
              console.log(`â˜ï¸ Synced ${key} to cloud`);
            } catch (error) {
              console.warn('Failed to sync to cloud:', error);
            }
          }
        }
      }, [key]);

      return [data, save];
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PREMIUM TIER HOOK - Check user subscription status
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function usePremium() {
      const [tier, setTier] = useState('free');

      useEffect(() => {
        // Check UserManager for subscription tier
        if (typeof UserManager !== 'undefined' && UserManager.getCurrentUser) {
          const user = UserManager.getCurrentUser();
          const subscription = user?.subscription || 'free';
          setTier(subscription);
        }

        // Also check SubscriptionManager if available
        if (typeof SubscriptionManager !== 'undefined' && SubscriptionManager.getCurrentTier) {
          const currentTier = SubscriptionManager.getCurrentTier();
          setTier(currentTier);
        }
      }, []);

      return {
        isPremium: tier === 'premium' || tier === 'pro',
        isPro: tier === 'pro',
        tier
      };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INSTANT STOCK DATA HOOK - Loads from cache instantly, refreshes in background
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function useInstantStockData(symbol, type = 'stock') {
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // OPTIMIZED: Single cache lookup instead of 4 redundant calls!
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const initialCacheData = useMemo(() => {
        const cached = Cache.get(symbol, type);
        return {
          data: cached || null,
          hasData: !!cached,
          timestamp: Cache.getTimestamp ? Cache.getTimestamp(symbol, type) : null,
          isExpired: Cache.isExpired ? Cache.isExpired(symbol, type) : false
        };
      }, [symbol, type]);
      
      const [data, setData] = useState(initialCacheData.data);
      const [loading, setLoading] = useState(!initialCacheData.hasData);
      const [lastUpdated, setLastUpdated] = useState(initialCacheData.timestamp);
      const [isStale, setIsStale] = useState(initialCacheData.isExpired);

      useEffect(() => {
        if (!symbol) return;

        let isMounted = true;
        let refreshInterval = null;

        // Priority 1: Load from IndexedDB if not in localStorage
        const loadFromIndexedDB = async () => {
          try {
            const advancedData = await AdvancedStorage.get('stockData', `${symbol}_${type}`);
            if (advancedData && isMounted && !data) {
              setData(advancedData);
              setLoading(false);
              // Update localStorage cache too for consistency
              Cache.set(symbol, advancedData, type);
            }
          } catch (error) {
            console.warn('IndexedDB load failed:', error);
          }
        };

        // Priority 2: Silently refresh in background if cache is stale
        const backgroundRefresh = async () => {
          const needsRefresh = Cache.isExpired ? Cache.isExpired(symbol, type) : true;
          if (!needsRefresh) return;

          try {
            console.log(`ğŸ”„ Background refresh for ${symbol}...`);
            const endpoint = type === 'quote' ? 'quote' : 'profile';
            const response = await fetch(`https://financialmodelingprep.com/stable/${endpoint}/${symbol}?apikey=${FMP_API_KEY}`);
            
            if (response.ok) {
              const result = await response.json();
              const newData = Array.isArray(result) ? result[0] : result;
              
              if (newData && isMounted) {
                // Update cache
                Cache.set(symbol, newData, type);
                
                // Only update state if data actually changed
                if (JSON.stringify(newData) !== JSON.stringify(data)) {
                  setData(newData);
                  setLastUpdated(Date.now());
                  setIsStale(false);
                }
              }
            }
          } catch (error) {
            console.warn('Background refresh failed:', error);
            // Don't throw - cached data is still valid
          }
        };

        // Execute loading strategy
        const loadData = async () => {
          if (!data) {
            await loadFromIndexedDB();
          }
          
          // Always check for background refresh
          await backgroundRefresh();
          
          if (isMounted) setLoading(false);
        };

        loadData();

        // Set up interval for periodic background updates
        if (CACHE_CONFIG.BACKGROUND_REFRESH_INTERVAL) {
          refreshInterval = setInterval(backgroundRefresh, CACHE_CONFIG.BACKGROUND_REFRESH_INTERVAL);
        }

        return () => {
          isMounted = false;
          if (refreshInterval) clearInterval(refreshInterval);
        };
      }, [symbol, type]);

      return { 
        data, 
        loading, 
        lastUpdated, 
        isStale,
        refresh: () => {
          Cache.remove(symbol, type);
          setLoading(true);
          setData(null);
        }
      };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CACHE WARMUP MANAGER - Preloads watchlist/portfolio in background
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function CacheWarmupManager() {
      const [warmupProgress, setWarmupProgress] = useState(0);
      const [isComplete, setIsComplete] = useState(false);

      useEffect(() => {
        const warmupCache = async () => {
          // Get symbols to preload
          const savedWatchlist = JSON.parse(localStorage.getItem('watchlist') || '[]');
          const savedPortfolio = JSON.parse(localStorage.getItem('portfolio') || '[]');
          const uniqueSymbols = [...new Set([
            ...savedWatchlist, 
            ...savedPortfolio.map(p => p.symbol)
          ])].filter(Boolean);
          
          if (uniqueSymbols.length === 0) {
            setIsComplete(true);
            return;
          }

          console.log(`ğŸ”¥ Starting cache warmup for ${uniqueSymbols.length} symbols...`);
          
          // Process in batches
          const batchSize = 5;
          let completed = 0;
          
          for (let i = 0; i < uniqueSymbols.length; i += batchSize) {
            const batch = uniqueSymbols.slice(i, i + batchSize);
            
            // Check which symbols actually need fetching (not cached or stale)
            const symbolsNeedingFetch = batch.filter(sym => {
              const cached = Cache.get(sym, 'quote');
              if (!cached) return true;
              const timestamp = Cache.getTimestamp ? Cache.getTimestamp(sym, 'quote') : null;
              if (!timestamp) return true;
              // Refresh if older than 6 hours
              return (Date.now() - timestamp) > (6 * 60 * 60 * 1000);
            });

            if (symbolsNeedingFetch.length > 0) {
              try {
                // Use secure backend proxy
                const response = await fetch(`${window.API_BASE_URL}/api/quotes/batch`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ symbols: symbolsNeedingFetch })
                });
                if (response.ok) {
                  const quotes = await response.json();
                  if (Array.isArray(quotes)) {
                    quotes.forEach(quote => {
                      Cache.set(quote.symbol, quote, 'quote');
                    });
                  }
                }
              } catch (error) {
                console.warn('Batch warmup failed:', error);
              }
              await new Promise(r => setTimeout(r, 500));
            }
            
            completed += batch.length;
            setWarmupProgress(Math.round((completed / uniqueSymbols.length) * 100));
          }

          console.log('âœ… Cache warmup complete');
          setIsComplete(true);
        };

        // Start warmup after initial render
        const timer = setTimeout(warmupCache, 3000);
        return () => clearTimeout(timer);
      }, []);

      if (isComplete || warmupProgress === 0) return null;
      
      return (
        <div className="fixed bottom-4 right-4 z-50 glass-card px-4 py-2 rounded-lg border border-cyan-500/20 shadow-lg">
          <div className="flex items-center gap-2 text-xs text-cyan-300">
            <i className="fas fa-sync-alt animate-spin"></i>
            <span>Syncing data... {warmupProgress}%</span>
          </div>
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DATA FRESHNESS BADGE - Shows how fresh the cached data is
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function DataFreshnessBadge({ symbol, type = 'quote', showLabel = false }) {
      const [status, setStatus] = useState({ age: null, isCached: false, isStale: false });

      useEffect(() => {
        const checkStatus = () => {
          const cached = Cache.get(symbol, type);
          if (cached) {
            const timestamp = Cache.getTimestamp ? Cache.getTimestamp(symbol, type) : null;
            if (timestamp) {
              const age = Date.now() - timestamp;
              const maxAge = Cache.getCacheDuration(type === 'quote' ? 'QUOTE_DATA' : 'STOCK_DATA');
              const minutes = Math.floor(age / 60000);
              
              setStatus({ 
                age: minutes, 
                isCached: true,
                isStale: age > maxAge
              });
            }
          }
        };
        
        checkStatus();
        const interval = setInterval(checkStatus, 60000);
        return () => clearInterval(interval);
      }, [symbol, type]);

      if (!status.isCached) return null;

      const getColor = () => {
        if (status.isStale) return 'text-orange-400';
        if (status.age < 60) return 'text-green-400';
        if (status.age < 240) return 'text-yellow-400';
        return 'text-orange-400';
      };

      const getLabel = () => {
        if (status.isStale) return 'Update pending';
        if (status.age < 1) return 'Just now';
        if (status.age < 60) return `${status.age}m ago`;
        if (status.age < 1440) return `${Math.floor(status.age / 60)}h ago`;
        return `${Math.floor(status.age / 1440)}d ago`;
      };

      return (
        <span className={`text-[10px] ${getColor()} flex items-center gap-1`} title={status.isStale ? 'Data is stale - refreshing soon' : 'Last updated'}>
          <i className="fas fa-database"></i>
          {showLabel && <span>{getLabel()}</span>}
          {status.isStale && <i className="fas fa-exclamation-circle ml-1"></i>}
        </span>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SKELETON LOADING COMPONENTS (V2.0)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const SkeletonCard = () => (
      <div className="glass-card p-4 rounded-xl animate-pulse">
        <div className="flex items-center justify-between mb-4">
          <div className="skeleton h-6 w-16 rounded"></div>
          <div className="skeleton h-4 w-12 rounded"></div>
        </div>
        <div className="skeleton h-8 w-24 rounded mb-2"></div>
        <div className="skeleton h-4 w-full rounded mb-2"></div>
        <div className="skeleton h-4 w-3/4 rounded"></div>
      </div>
    );

    const SkeletonRow = () => (
      <tr className="border-b border-slate-700/30 animate-pulse">
        <td className="p-3"><div className="skeleton h-4 w-16 rounded"></div></td>
        <td className="p-3"><div className="skeleton h-4 w-32 rounded"></div></td>
        <td className="p-3"><div className="skeleton h-6 w-20 rounded"></div></td>
        <td className="p-3"><div className="skeleton h-4 w-24 rounded"></div></td>
        <td className="p-3"><div className="skeleton h-4 w-16 rounded"></div></td>
        <td className="p-3"><div className="skeleton h-4 w-20 rounded"></div></td>
        <td className="p-3"><div className="skeleton h-4 w-24 rounded"></div></td>
        <td className="p-3"><div className="skeleton h-8 w-16 rounded"></div></td>
      </tr>
    );


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CONFIGURATION & CONSTANTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // API KEYS - PHASE 1 ENHANCED (Multi-source fallback)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MULTI-API CONFIGURATION WITH SMART FALLBACK
    // 9 APIs = 130,000+ monthly calls = Near-unlimited data access!
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const API_KEYS = {
      FMP: 'h43nCTpMeyiIiNquebaqktc7ChUHMxIz',              // 250/day - Primary
      FINNHUB: 'd4fitqpr01qufc4upqn0d4fitqpr01qufc4upqng',   // 60/min, unlimited - Best backup!
      EOD_HISTORICAL: '691f22aa1a8e90.63897142',            // 100,000/month - Huge limit!
      TWELVE_DATA: '437c3794992642e29385a1ef00c9925f',       // 800/day
      INTRINIO: 'OjBmYmVhY2IyZTA3MTM2OWM4YjcwMWQwYzRlODk2NTBj', // 10,000/month
      TIINGO: '404d2953727ee5736d7b2e0671596633d730a1dc',   // 20,000/month
      ALPHA_VANTAGE: 'KUR4BDPE2H6NJMHO',                     // 25/day - sentiment only
      NEWS_API: '81a0be9978ed47c5a3d154aa0bc2feae',          // 100/day
      MARKETAUX: 'Eo8lyvncd3gFJVlVbTuZpKq2PQA3LeX2F1scj2XA', // 100/day
      DEEPSEEK: 'sk-d9a6e65b55e243389a2a5bdf40840e72',       // AI analysis
      CLAUDE: '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'
    };

    // Track API usage and health
    const API_STATS = {
      FMP: { calls: 0, failures: 0, lastSuccess: null },
      FINNHUB: { calls: 0, failures: 0, lastSuccess: null },
      EOD_HISTORICAL: { calls: 0, failures: 0, lastSuccess: null },
      TWELVE_DATA: { calls: 0, failures: 0, lastSuccess: null },
      INTRINIO: { calls: 0, failures: 0, lastSuccess: null },
      TIINGO: { calls: 0, failures: 0, lastSuccess: null }
    };

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function parseRetryAfterMs(headerValue) {
      if (!headerValue) return null;
      const trimmed = String(headerValue).trim();
      if (!trimmed) return null;
      // Retry-After can be seconds or an HTTP date
      const seconds = Number(trimmed);
      if (Number.isFinite(seconds)) return Math.max(0, seconds * 1000);

      const dateMs = Date.parse(trimmed);
      if (!Number.isFinite(dateMs)) return null;
      return Math.max(0, dateMs - Date.now());
    }

    function defaultShouldRetry({ response, error }) {
      if (error) {
        // Network errors, timeouts
        if (error.name === 'TimeoutError') return true;
        if (error.name === 'AbortError') return false;
        return true;
      }

      if (!response) return true;
      if (response.status === 429) return true;
      if (response.status === 408) return true;
      if (response.status >= 500 && response.status <= 599) return true;
      return false;
    }

    async function fetchWithRetry(url, options = {}) {
      const {
        timeoutMs = 12000,
        retries = 2,
        retryDelayMs = 600,
        maxRetryDelayMs = 8000,
        jitterRatio = 0.25,
        shouldRetry = defaultShouldRetry,
        signal: upstreamSignal,
        ...fetchOptions
      } = options;

      const totalAttempts = Math.max(1, Number(retries) + 1);
      let lastError = null;
      let lastResponse = null;

      for (let attempt = 0; attempt < totalAttempts; attempt++) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
          try {
            controller.abort(new DOMException('Request timed out', 'TimeoutError'));
          } catch {
            controller.abort();
          }
        }, timeoutMs);

        let upstreamAbortHandler = null;
        if (upstreamSignal) {
          upstreamAbortHandler = () => {
            try {
              controller.abort(upstreamSignal.reason || new DOMException('Request aborted', 'AbortError'));
            } catch {
              controller.abort();
            }
          };
          if (upstreamSignal.aborted) {
            upstreamAbortHandler();
          } else {
            upstreamSignal.addEventListener('abort', upstreamAbortHandler, { once: true });
          }
        }

        try {
          const response = await fetch(url, { ...fetchOptions, signal: controller.signal });
          lastResponse = response;
          lastError = null;

          const retryAfterMs = response.status === 429
            ? parseRetryAfterMs(response.headers?.get?.('Retry-After'))
            : null;

          const canRetry = attempt < totalAttempts - 1;
          if (canRetry && shouldRetry({ response })) {
            const base = Math.min(maxRetryDelayMs, retryDelayMs * Math.pow(2, attempt));
            const jitter = base * jitterRatio * (Math.random() * 2 - 1);
            const waitMs = Math.max(0, Math.min(maxRetryDelayMs, (retryAfterMs ?? base) + jitter));
            console.warn(`â³ Retry ${attempt + 1}/${totalAttempts - 1} after ${Math.round(waitMs)}ms: ${String(url).slice(0, 120)}`);
            await sleep(waitMs);
            continue;
          }

          return response;
        } catch (error) {
          lastError = error;
          lastResponse = null;

          // If caller explicitly aborted, do not retry
          if (upstreamSignal?.aborted) throw error;

          const canRetry = attempt < totalAttempts - 1;
          if (canRetry && shouldRetry({ error })) {
            const base = Math.min(maxRetryDelayMs, retryDelayMs * Math.pow(2, attempt));
            const jitter = base * jitterRatio * (Math.random() * 2 - 1);
            const waitMs = Math.max(0, Math.min(maxRetryDelayMs, base + jitter));
            console.warn(`â³ Retry ${attempt + 1}/${totalAttempts - 1} after ${Math.round(waitMs)}ms (error: ${error?.name || 'Error'}): ${String(url).slice(0, 120)}`);
            await sleep(waitMs);
            continue;
          }

          throw error;
        } finally {
          clearTimeout(timeoutId);
          if (upstreamSignal && upstreamAbortHandler) {
            upstreamSignal.removeEventListener('abort', upstreamAbortHandler);
          }
        }
      }

      if (lastResponse) return lastResponse;
      throw lastError || new Error('Request failed');
    }

    function formatTimeAgo(timestampMs) {
      if (!timestampMs || !Number.isFinite(timestampMs)) return 'â€”';
      const deltaMs = Date.now() - timestampMs;
      if (deltaMs < 0) return 'just now';
      const seconds = Math.floor(deltaMs / 1000);
      if (seconds < 10) return 'just now';
      if (seconds < 60) return `${seconds}s ago`;
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m ago`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours}h ago`;
      const days = Math.floor(hours / 24);
      return `${days}d ago`;
    }

    function isStaleTimestamp(timestampMs, kind = 'quote') {
      if (!timestampMs || !Number.isFinite(timestampMs)) return false;
      const cacheDuration = (() => {
        try {
          if (Cache?.getCacheDuration) {
            return kind === 'quote' ? Cache.getCacheDuration('QUOTE_DATA') : Cache.getCacheDuration('STOCK_DATA');
          }
        } catch {
          // ignore
        }
        // Fallback behavior if Cache isn't available
        return kind === 'quote' ? (Cache?.isMarketOpen?.() ? (5 * 60 * 1000) : (24 * 60 * 60 * 1000))
          : (Cache?.isMarketOpen?.() ? (60 * 60 * 1000) : (24 * 60 * 60 * 1000));
      })();

      return (Date.now() - timestampMs) > cacheDuration;
    }

    // Smart fetch with automatic fallback
    async function smartFetch(endpoint, symbol, options = {}) {
      const isBrowser = typeof window !== 'undefined';

      const strategies = [
        // Strategy 1: FMP PAID (primary - use /stable/ endpoint for paid keys)
        {
          name: 'FMP',
          url: `https://financialmodelingprep.com/stable/${endpoint}?symbol=${symbol}&apikey=${API_KEYS.FMP}`,
          transform: (data) => data
        },
        // Strategy 2: Finnhub as backup (only if FMP fails)
        // NOTE: Finnhub doesn't support CORS from browsers, so skip entirely in browser environments
        ...(isBrowser ? [] : [{
          name: 'FINNHUB',
          url: endpoint.includes('quote')
            ? `https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${API_KEYS.FINNHUB}`
            : null,
          transform: (data) => {
            // Transform Finnhub format to FMP format
            if (data && data.c) {
              return [{
                symbol: symbol,
                price: data.c,
                change: data.d,
                changesPercentage: data.dp,
                volume: data.v || 0
              }];
            }
            return data;
          }
        }])
      ];

      // Try each strategy in order
      for (const strategy of strategies) {
        if (!strategy.url) continue; // Skip if URL not supported for this endpoint

        // Double-check: Skip Finnhub in browser environments (extra safety)
        if (isBrowser && strategy.name === 'FINNHUB') {
          continue; // Silently skip - no logging to reduce console noise
        }

        // Additional safety: Check if URL contains finnhub and we're in browser
        if (isBrowser && strategy.url && strategy.url.includes('finnhub.io')) {
          continue; // Skip any Finnhub URLs in browsers
        }

        try {
          if (API_STATS[strategy.name]) {
            API_STATS[strategy.name].calls++;
          }

          console.log(`ğŸ”„ Trying ${strategy.name} for ${endpoint}...`);

          const response = await fetchWithRetry(strategy.url, {
            timeoutMs: options.timeoutMs ?? 12000,
            retries: options.retries ?? 2
          });

          if (response.status === 429) {
            console.warn(`â³ ${strategy.name} rate limited, trying next...`);
            if (API_STATS[strategy.name]) API_STATS[strategy.name].failures++;
            continue;
          }

          if (!response.ok) {
            // For 403 errors, log more details to help debug
            if (response.status === 403) {
              console.warn(`âŒ ${strategy.name} access denied (403)`);
              console.warn(`   URL: ${strategy.url.substring(0, 100)}...`);
              console.warn(`   Possible causes:`);
              console.warn(`   1. API key invalid or expired`);
              console.warn(`   2. Subscription tier doesn't include this endpoint`);
              console.warn(`   3. Rate limit or bandwidth exceeded`);
              console.warn(`   4. Endpoint requires higher subscription tier`);
              // Try to get error details
              try {
                const errorText = await response.clone().text();
                if (errorText) {
                  try {
                    const errorData = JSON.parse(errorText);
                    if (errorData.Error) console.warn(`   Error: ${errorData.Error}`);
                    if (errorData.message) console.warn(`   Message: ${errorData.message}`);
                  } catch (parseErr) {
                    // Not JSON, just log the text
                    if (errorText.length < 200) {
                      console.warn(`   Response: ${errorText}`);
                    }
                  }
                }
              } catch (e) {
                // Ignore errors when reading response
              }
              // For FMP 403, don't retry - go straight to backup
              if (strategy.name === 'FMP') {
                console.warn(`   Skipping FMP and using backup API...`);
              }
            }
            console.warn(`âŒ ${strategy.name} failed (${response.status}), trying next...`);
            if (API_STATS[strategy.name]) API_STATS[strategy.name].failures++;
            continue;
          }

          // Check if response is HTML (error page) before parsing JSON
          const responseText = await response.clone().text();
          if (responseText.trim().startsWith('<!DOCTYPE') || responseText.trim().startsWith('<html')) {
            console.warn(`âš ï¸ ${strategy.name} returned HTML instead of JSON (likely error page), trying next...`);
            if (API_STATS[strategy.name]) API_STATS[strategy.name].failures++;
            continue;
          }

          let data;
          try {
            data = JSON.parse(responseText);
          } catch (parseError) {
            console.warn(`âš ï¸ ${strategy.name} response is not valid JSON: ${parseError.message}, trying next...`);
            if (API_STATS[strategy.name]) API_STATS[strategy.name].failures++;
            continue;
          }

          // Validate data before transforming
          if (!data || (Array.isArray(data) && data.length === 0)) {
            console.warn(`âš ï¸ ${strategy.name} returned empty data, trying next...`);
            if (API_STATS[strategy.name]) API_STATS[strategy.name].failures++;
            continue;
          }

          const transformed = strategy.transform(data);

          // Validate transformed data
          if (!transformed || (Array.isArray(transformed) && transformed.length === 0)) {
            console.warn(`âš ï¸ ${strategy.name} transformation returned empty data, trying next...`);
            if (API_STATS[strategy.name]) API_STATS[strategy.name].failures++;
            continue;
          }

          if (API_STATS[strategy.name]) {
            API_STATS[strategy.name].lastSuccess = new Date();
          }
          console.log(`âœ… ${strategy.name} succeeded for ${endpoint}!`);

          return { data: transformed, source: strategy.name };

        } catch (error) {
          // Check for CORS errors specifically
          const isCorsError = error.message?.includes('CORS') ||
            error.message?.includes('Failed to fetch') ||
            error.name === 'TypeError' ||
            error.message?.includes('blocked by CORS') ||
            error.message?.includes('Access-Control-Allow-Origin');

          if (isCorsError) {
            // Silently skip CORS errors - they're expected in browsers
            if (API_STATS[strategy.name]) {
              API_STATS[strategy.name].failures++;
            }
            continue;
          }

          // Check for rate limiting (429)
          if (error.message?.includes('429') || error.message?.includes('Too Many Requests')) {
            console.warn(`âš ï¸ ${strategy.name} rate limited (429), skipping...`);
            if (API_STATS[strategy.name]) {
              API_STATS[strategy.name].failures++;
            }
            continue;
          }

          // Check for rate limiting (429)
          if (error.message?.includes('429') || error.message?.includes('Too Many Requests')) {
            console.warn(`âš ï¸ ${strategy.name} rate limited (429), skipping...`);
            if (API_STATS[strategy.name]) {
              API_STATS[strategy.name].failures++;
            }
            continue;
          }

          // Only log non-expected errors
          console.error(`âŒ ${strategy.name} error:`, error.message);
          if (API_STATS[strategy.name]) {
            API_STATS[strategy.name].failures++;
          }
          continue;
        }
      }

      // All strategies failed
      throw new Error(`All API sources failed for ${endpoint}`);
    }

    // Legacy support - use FMP as default
    const FMP_API_KEY = API_KEYS.FMP;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DEEPSEEK AI ANALYSIS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function getDeepSeekAnalysis(stock) {
      try {
        // Validate API key
        if (!API_KEYS.DEEPSEEK || API_KEYS.DEEPSEEK === '') {
          throw new Error('DeepSeek API key is missing. Please configure your API key.');
        }
        console.log('DeepSeek API key found:', API_KEYS.DEEPSEEK.substring(0, 10) + '...');

        const stockData = {
          symbol: stock.symbol,
          name: stock.name,
          price: stock.price,
          change: stock.change,
          changePct: stock.changePct,
          volume: stock.volume,
          marketCap: stock.marketCap,
          pe: stock.pe,
          eps: stock.eps,
          beta: stock.beta,
          dividend: stock.dividend,
          divYield: stock.divYield,
          fiftyTwoWkHigh: stock.fiftyTwoWkHigh,
          fiftyTwoWkLow: stock.fiftyTwoWkLow,
          avgVolume: stock.avgVolume,
          sector: stock.sector,
          industry: stock.industry,
          roe: stock.roe,
          roa: stock.roa,
          debtToEquity: stock.debtToEquity,
          currentRatio: stock.currentRatio,
          quickRatio: stock.quickRatio,
          revenueGrowth: stock.revenueGrowth,
          earningsGrowth: stock.earningsGrowth,
          priceToBook: stock.priceToBook,
          priceToSales: stock.priceToSales,
          analystRating: stock.analystRating,
          priceTarget: stock.priceTarget
        };

        const prompt = `You are a professional stock analyst. Analyze the following stock data and provide a comprehensive investment analysis including:
1. Overall Assessment (bullish/neutral/bearish)
2. Key Strengths (3-4 points)
3. Key Risks (3-4 points)
4. Valuation Analysis
5. Technical Outlook
6. Investment Recommendation (Buy/Hold/Sell with reasoning)

Stock Data:
${JSON.stringify(stockData, null, 2)}

Please provide a clear, structured analysis in markdown format.`;

        const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${API_KEYS.DEEPSEEK}`
          },
          body: JSON.stringify({
            model: 'deepseek-chat',
            messages: [
              {
                role: 'system',
                content: 'You are a professional stock market analyst with expertise in fundamental and technical analysis.'
              },
              {
                role: 'user',
                content: prompt
              }
            ],
            temperature: 0.7,
            max_tokens: 2000
          })
        });

        if (!response.ok) {
          const error = await response.text();
          throw new Error(`DeepSeek API error: ${response.status} - ${error}`);
        }

        const data = await response.json();
        return data.choices[0].message.content;

      } catch (error) {
        console.error('DeepSeek AI analysis error:', error);
        throw error;
      }
    }



    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ADVANCED CHARTING UTILITIES (Lightweight Charts)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function parseFmpCandleTime(dateStr) {
      if (dateStr == null) return null;

      // Some endpoints return epoch seconds/ms
      if (typeof dateStr === 'number' && Number.isFinite(dateStr)) {
        const ms = dateStr > 2e12 ? dateStr : (dateStr > 2e10 ? dateStr : dateStr * 1000);
        return Math.floor(ms / 1000);
      }

      const s = String(dateStr).trim();
      if (!s) return null;

      // FMP frequently returns "YYYY-MM-DD HH:mm:ss" (non-ISO).
      // Normalize to ISO for consistent parsing.
      const isoish = s.includes(' ') && !s.includes('T')
        ? s.replace(' ', 'T')
        : s;

      // If there's a time component but no timezone, treat as UTC.
      const needsZ = /T\d{2}:\d{2}/.test(isoish) && !/[zZ]|[+-]\d{2}:?\d{2}$/.test(isoish);
      const candidate = needsZ ? `${isoish}Z` : isoish;

      const ms = Date.parse(candidate);
      if (!Number.isFinite(ms)) return null;
      return Math.floor(ms / 1000);
    }

    function normalizeFmpCandles(raw) {
      if (!Array.isArray(raw)) return [];
      return raw
        .map(c => {
          const time = parseFmpCandleTime(c.date);
          if (!time) return null;
          return {
            time,
            open: Number(c.open),
            high: Number(c.high),
            low: Number(c.low),
            close: Number(c.close),
            volume: Number(c.volume || c.vol || 0)
          };
        })
        .filter(Boolean)
        .sort((a, b) => a.time - b.time);
    }

    function sma(values, period) {
      const out = new Array(values.length).fill(null);
      if (!period || period < 2) return out;
      let sum = 0;
      for (let i = 0; i < values.length; i++) {
        sum += values[i];
        if (i >= period) sum -= values[i - period];
        if (i >= period - 1) out[i] = sum / period;
      }
      return out;
    }

    function ema(values, period) {
      const out = new Array(values.length).fill(null);
      if (!period || period < 2 || values.length === 0) return out;
      const k = 2 / (period + 1);
      let prev = values[0];
      out[0] = prev;
      for (let i = 1; i < values.length; i++) {
        const next = values[i] * k + prev * (1 - k);
        out[i] = next;
        prev = next;
      }
      return out;
    }

    function stddev(values, period, smaArr) {
      const out = new Array(values.length).fill(null);
      if (!period || period < 2) return out;
      for (let i = period - 1; i < values.length; i++) {
        const mean = smaArr[i];
        if (mean == null) continue;
        let variance = 0;
        for (let j = i - period + 1; j <= i; j++) {
          const d = values[j] - mean;
          variance += d * d;
        }
        out[i] = Math.sqrt(variance / period);
      }
      return out;
    }

    function computeBollinger(closes, period = 20, mult = 2) {
      const mid = sma(closes, period);
      const sd = stddev(closes, period, mid);
      const upper = mid.map((m, i) => (m == null || sd[i] == null) ? null : m + mult * sd[i]);
      const lower = mid.map((m, i) => (m == null || sd[i] == null) ? null : m - mult * sd[i]);
      return { mid, upper, lower };
    }

    function computeRSI(closes, period = 14) {
      const out = new Array(closes.length).fill(null);
      if (closes.length < period + 1) return out;
      let gain = 0;
      let loss = 0;
      for (let i = 1; i <= period; i++) {
        const diff = closes[i] - closes[i - 1];
        if (diff >= 0) gain += diff;
        else loss -= diff;
      }
      let avgGain = gain / period;
      let avgLoss = loss / period;
      out[period] = avgLoss === 0 ? 100 : 100 - (100 / (1 + (avgGain / avgLoss)));

      for (let i = period + 1; i < closes.length; i++) {
        const diff = closes[i] - closes[i - 1];
        const g = diff > 0 ? diff : 0;
        const l = diff < 0 ? -diff : 0;
        avgGain = (avgGain * (period - 1) + g) / period;
        avgLoss = (avgLoss * (period - 1) + l) / period;
        out[i] = avgLoss === 0 ? 100 : 100 - (100 / (1 + (avgGain / avgLoss)));
      }
      return out;
    }

    function computeMACD(closes, fast = 12, slow = 26, signal = 9) {
      const fastEma = ema(closes, fast);
      const slowEma = ema(closes, slow);
      const macd = closes.map((_, i) => (fastEma[i] == null || slowEma[i] == null) ? null : (fastEma[i] - slowEma[i]));

      const macdForEma = macd.map(v => v == null ? 0 : v);
      const signalLine = ema(macdForEma, signal).map((v, i) => (i < slow - 1 ? null : v));
      const hist = macd.map((v, i) => (v == null || signalLine[i] == null) ? null : (v - signalLine[i]));
      return { macd, signal: signalLine, hist };
    }

    function computeVolumeProfile(candles, bins = 24) {
      if (!Array.isArray(candles) || candles.length === 0) return [];
      let min = Infinity;
      let max = -Infinity;
      for (const c of candles) {
        min = Math.min(min, c.low);
        max = Math.max(max, c.high);
      }
      if (!Number.isFinite(min) || !Number.isFinite(max) || min === max) return [];

      const binSize = (max - min) / bins;
      const acc = new Array(bins).fill(0);
      for (const c of candles) {
        const tp = (c.high + c.low + c.close) / 3;
        const idx = Math.min(bins - 1, Math.max(0, Math.floor((tp - min) / binSize)));
        acc[idx] += Number(c.volume || 0);
      }

      const maxVol = Math.max(...acc, 1);
      return acc.map((v, i) => {
        const lo = min + i * binSize;
        const hi = lo + binSize;
        return { lo, hi, volume: v, pct: (v / maxVol) * 100 };
      }).reverse();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SMART CACHING SYSTEM - Speeds up loading by 10x!
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const CACHE_CONFIG = {
      // ULTRA-EXTENDED CACHE DURATIONS - 90 days for most data
      STOCK_DATA: 90 * 24 * 60 * 60 * 1000,      // 90 DAYS - Fundamentals rarely change
      QUOTE_DATA_MARKET_OPEN: 15 * 60 * 1000,    // 15 minutes during market hours
      QUOTE_DATA_MARKET_CLOSED: 48 * 60 * 60 * 1000, // 48 hours when closed
      CHART_DATA: 30 * 24 * 60 * 60 * 1000,      // 30 DAYS - Historical doesn't change
      NEWS_DATA: 12 * 60 * 60 * 1000,            // 12 hours
      SENTIMENT_DATA: 24 * 60 * 60 * 1000,       // 24 hours
      EARNINGS_DATA: 90 * 24 * 60 * 60 * 1000,   // 90 days - Earnings are quarterly
      PROFILE_DATA: 90 * 24 * 60 * 60 * 1000,    // 90 days - Company profiles are stable
      MARKET_CLOSED: 7 * 24 * 60 * 60 * 1000,    // 7 days when market closed
      MAX_CACHE_SIZE: 2000,                      // Increased from 1000
      CACHE_VERSION: 'v7',                       // Bump version for 90-day cache
      OFFLINE_MODE: true,
      
      // Aggressive prefetching settings
      PREFETCH_ENABLED: true,
      PREFETCH_BATCH_SIZE: 20,                   // Load 20 stocks at once
      BACKGROUND_REFRESH_INTERVAL: 10 * 60 * 1000 // Check for updates every 10 min
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // REFRESH THROTTLER - Prevent Unnecessary API Calls
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    class RefreshThrottler {
      constructor() {
        this.lastRefreshTime = parseInt(localStorage.getItem('re_last_refresh_time') || '0');
        this.minRefreshInterval = 5 * 60 * 1000; // 5 minutes minimum between refreshes
      }
      
      shouldRefresh(force = false) {
        const now = Date.now();
        
        if (force) return true;
        
        // If less than min interval passed, use cache
        if (now - this.lastRefreshTime < this.minRefreshInterval) {
          console.log('â±ï¸ Refresh throttled - using cached data');
          return false;
        }
        
        this.lastRefreshTime = now;
        localStorage.setItem('re_last_refresh_time', now.toString());
        return true;
      }
      
      markRefreshed() {
        this.lastRefreshTime = Date.now();
        localStorage.setItem('re_last_refresh_time', this.lastRefreshTime.toString());
      }
    }

    const refreshThrottler = new RefreshThrottler();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // VIEWPORT LOADER - Only Load Visible Stocks (HUGE Performance Win!)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const ViewportLoader = {
      observer: null,
      visibleSymbols: new Set(),
      loadedDetailSymbols: new Set(),
      pendingLoads: new Map(),
      callbacks: new Map(),
      
      init() {
        if (typeof IntersectionObserver === 'undefined') {
          console.warn('IntersectionObserver not supported');
          return;
        }
        
        this.observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => {
            const symbol = entry.target.dataset?.symbol;
            if (!symbol) return;
            
            if (entry.isIntersecting) {
              this.onSymbolVisible(symbol);
            } else {
              this.visibleSymbols.delete(symbol);
            }
          });
        }, {
          rootMargin: '100px', // Start loading 100px before visible
          threshold: 0.01
        });
        
        console.log('ğŸ‘€ ViewportLoader initialized');
      },
      
      observe(element, symbol, onVisible) {
        if (!this.observer || !element) return;
        element.dataset.symbol = symbol;
        if (onVisible) {
          this.callbacks.set(symbol, onVisible);
        }
        this.observer.observe(element);
      },
      
      unobserve(element) {
        if (!this.observer || !element) return;
        this.observer.unobserve(element);
        const symbol = element.dataset?.symbol;
        if (symbol) {
          this.visibleSymbols.delete(symbol);
          this.callbacks.delete(symbol);
        }
      },
      
      onSymbolVisible(symbol) {
        this.visibleSymbols.add(symbol);
        
        // Skip if already loaded detailed data
        if (this.loadedDetailSymbols.has(symbol)) return;
        
        // Skip if already pending
        if (this.pendingLoads.has(symbol)) return;
        
        this.pendingLoads.set(symbol, true);
        
        // Call the callback if registered
        const callback = this.callbacks.get(symbol);
        if (callback) {
          callback(symbol);
        }
        
        // Mark as loaded after a delay
        setTimeout(() => {
          this.loadedDetailSymbols.add(symbol);
          this.pendingLoads.delete(symbol);
        }, 500);
      },
      
      isVisible(symbol) {
        return this.visibleSymbols.has(symbol);
      },
      
      getVisibleSymbols() {
        return Array.from(this.visibleSymbols);
      },
      
      destroy() {
        if (this.observer) {
          this.observer.disconnect();
        }
        this.visibleSymbols.clear();
        this.loadedDetailSymbols.clear();
        this.pendingLoads.clear();
        this.callbacks.clear();
      }
    };
    
    // Initialize ViewportLoader
    ViewportLoader.init();
    window.ViewportLoader = ViewportLoader;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DEBOUNCED LOCALSTORAGE - Batch writes to avoid blocking main thread
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const DebouncedStorage = {
      pending: new Map(),
      timers: new Map(),
      
      setItem(key, value, delay = 1000) {
        // Store pending write
        this.pending.set(key, value);
        
        // Clear existing timer
        if (this.timers.has(key)) {
          clearTimeout(this.timers.get(key));
        }
        
        // Schedule write
        const timer = setTimeout(() => {
          try {
            const pendingValue = this.pending.get(key);
            if (pendingValue !== undefined) {
              localStorage.setItem(key, pendingValue);
              this.pending.delete(key);
              this.timers.delete(key);
            }
          } catch (err) {
            console.warn('DebouncedStorage write failed:', err);
          }
        }, delay);
        
        this.timers.set(key, timer);
      },
      
      flush() {
        // Write all pending immediately
        this.pending.forEach((value, key) => {
          try {
            localStorage.setItem(key, value);
          } catch (err) {
            console.warn('Flush failed for', key, err);
          }
        });
        this.pending.clear();
        this.timers.forEach(timer => clearTimeout(timer));
        this.timers.clear();
      }
    };
    
    // Flush on page unload
    window.addEventListener('beforeunload', () => DebouncedStorage.flush());

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // BATCHED LOCALSTORAGE - Debounced writes to avoid blocking UI
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const BatchedLocalStorage = {
      pendingWrites: new Map(),
      writeTimer: null,
      DEBOUNCE_MS: 500,
      
      set(key, value) {
        // Queue the write
        this.pendingWrites.set(key, value);
        
        // Debounce actual write
        if (this.writeTimer) clearTimeout(this.writeTimer);
        this.writeTimer = setTimeout(() => this.flush(), this.DEBOUNCE_MS);
      },
      
      flush() {
        if (this.pendingWrites.size === 0) return;
        
        // Batch write all pending
        requestIdleCallback(() => {
          this.pendingWrites.forEach((value, key) => {
            try {
              localStorage.setItem(key, typeof value === 'string' ? value : JSON.stringify(value));
            } catch (err) {
              console.warn(`LocalStorage write failed for ${key}:`, err);
            }
          });
          this.pendingWrites.clear();
        }, { timeout: 1000 });
      },
      
      // Immediate write (for critical data)
      setImmediate(key, value) {
        try {
          localStorage.setItem(key, typeof value === 'string' ? value : JSON.stringify(value));
        } catch (err) {
          console.warn(`LocalStorage immediate write failed for ${key}:`, err);
        }
      }
    };
    
    window.BatchedLocalStorage = BatchedLocalStorage;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SESSION PERSISTENCE - Instant Load Between Refreshes
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const SessionPersistence = {
      SESSION_KEY: 're_current_session_data_v2',
      MAX_SESSION_AGE: 2 * 60 * 60 * 1000, // 2 hours
      
      saveSession(stocks, filters = {}, watchlist = [], viewState = {}) {
        try {
          const sessionData = {
            stocks: stocks.map(s => ({
              symbol: s.symbol,
              price: s.price,
              changePct: s.changePct,
              pe: s.pe,
              roe: s.roe,
              aiScore: s.aiScore,
              verdict: s.verdict,
              sector: s.sector,
              name: s.name,
              marketCap: s.marketCap
            })),
            filters,
            watchlist,
            viewState,
            timestamp: Date.now(),
            version: 'v2'
          };
          
          localStorage.setItem(this.SESSION_KEY, JSON.stringify(sessionData));
          console.log('ğŸ’¾ Session data saved');
        } catch (error) {
          console.warn('Failed to save session:', error);
        }
      },
      
      loadSession() {
        try {
          const sessionJson = localStorage.getItem(this.SESSION_KEY);
          if (!sessionJson) return null;
          
          const sessionData = JSON.parse(sessionJson);
          
          // Check if session is still valid
          if (Date.now() - sessionData.timestamp > this.MAX_SESSION_AGE) {
            this.clearSession();
            return null;
          }
          
          console.log('ğŸ“‚ Session loaded from storage');
          return sessionData;
        } catch (error) {
          console.warn('Failed to load session:', error);
          return null;
        }
      },
      
      clearSession() {
        localStorage.removeItem(this.SESSION_KEY);
      },
      
      hasValidSession() {
        const session = this.loadSession();
        return session !== null && session.stocks?.length > 0;
      }
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // VISIBILITY-BASED OPTIMIZATIONS - Save resources when tab hidden
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function setupVisibilityOptimizations() {
      // FIX: Ensure listener is added only once
      if (window.VISIBILITY_LISTENER_ATTACHED) return;
      window.VISIBILITY_LISTENER_ATTACHED = true;
      
      const handleVisibilityChange = () => {
        if (document.hidden) {
          console.log('ğŸ“´ Tab hidden - pausing background activity');
          window.TAB_HIDDEN = true;
          
          // OPTIMIZATION: Pause all active intervals when tab is hidden
          if (window.ACTIVE_INTERVALS) {
            window.PAUSED_INTERVALS = [...window.ACTIVE_INTERVALS];
            window.ACTIVE_INTERVALS.forEach(id => clearInterval(id));
            window.ACTIVE_INTERVALS.clear();
          }
        } else {
          console.log('ğŸ“± Tab visible - restoring normal activity');
          window.TAB_HIDDEN = false;
          
          // OPTIMIZATION: Resume intervals when tab becomes visible
          if (window.PAUSED_INTERVALS && window.PAUSED_INTERVALS.length > 0) {
            console.log('ğŸ”„ Resuming background tasks...');
            window.PAUSED_INTERVALS = [];
          }
        }
      };
      
      document.addEventListener('visibilitychange', handleVisibilityChange);
      
      // Cleanup on page unload
      window.addEventListener('beforeunload', () => {
        document.removeEventListener('visibilitychange', handleVisibilityChange);
      });
    }

    // Initialize visibility optimizations
    window.ACTIVE_INTERVALS = window.ACTIVE_INTERVALS || new Set();
    setupVisibilityOptimizations();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CLEANUP OLD CACHE DATA - Weekly cleanup to prevent bloat
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function cleanupOldCacheData() {
      const cleanupKey = 're_last_cache_cleanup';
      const lastCleanup = parseInt(localStorage.getItem(cleanupKey) || '0');
      const oneWeek = 7 * 24 * 60 * 60 * 1000;
      
      if (Date.now() - lastCleanup > oneWeek) {
        console.log('ğŸ§¹ Running weekly cache cleanup...');
        
        const keysToRemove = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          
          if (key && (key.startsWith('re_advanced_') || key.startsWith('re_cache_') || key.startsWith('v5_') || key.startsWith('v6_'))) {
            try {
              const data = JSON.parse(localStorage.getItem(key));
              if (data && Date.now() - (data.timestamp || 0) > 90 * 24 * 60 * 60 * 1000) {
                keysToRemove.push(key);
              }
            } catch {
              // If can't parse, remove it
              keysToRemove.push(key);
            }
          }
        }
        
        keysToRemove.forEach(key => localStorage.removeItem(key));
        
        localStorage.setItem(cleanupKey, Date.now().toString());
        console.log(`ğŸ§¹ Cleaned up ${keysToRemove.length} old cache entries`);
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PLACEHOLDER STOCK GENERATOR - Instant UI with loading states
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const PlaceholderManager = {
      // Create placeholder stocks for instant display
      createPlaceholders(symbols) {
        return symbols.map((symbol, index) => ({
          symbol: symbol.toUpperCase(),
          name: symbol,
          price: null,
          changePct: null,
          marketCap: null,
          pe: null,
          roe: null,
          aiScore: null,
          verdict: 'Loading...',
          _isPlaceholder: true,
          _loadOrder: index
        }));
      },
      
      // Merge real data into placeholder
      mergeWithPlaceholder(placeholder, realData) {
        if (!realData) return placeholder;
        return {
          ...placeholder,
          ...realData,
          _isPlaceholder: false,
          _loadOrder: placeholder._loadOrder
        };
      }
    };

    // Run cleanup on startup (delayed)
    setTimeout(cleanupOldCacheData, 5000);

    // Expose for manual use
    window.SessionPersistence = SessionPersistence;
    window.refreshThrottler = refreshThrottler;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ULTRA-FAST CACHE - In-memory layer + localStorage persistence
    // Eliminates redundant localStorage reads and parsing
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const Cache = {
      // IN-MEMORY CACHE LAYER - Instant access, no parsing needed
      _memoryCache: new Map(),
      _memoryCacheMaxSize: 500,
      _marketOpenCached: null,
      _marketOpenCacheTime: 0,

      // Check if market is currently open (cached for 1 minute)
      isMarketOpen() {
        const now = Date.now();
        if (this._marketOpenCached !== null && (now - this._marketOpenCacheTime) < 60000) {
          return this._marketOpenCached;
        }

        const date = new Date();
        const et = new Date(date.toLocaleString('en-US', { timeZone: 'America/New_York' }));
        const day = et.getDay();
        const hour = et.getHours();
        const minute = et.getMinutes();

        // Weekend
        if (day === 0 || day === 6) {
          this._marketOpenCached = false;
          this._marketOpenCacheTime = now;
          return false;
        }

        // Before market open (9:30 AM) or after close (4:00 PM)
        const isOpen = !(hour < 9 || (hour === 9 && minute < 30) || hour >= 16);
        this._marketOpenCached = isOpen;
        this._marketOpenCacheTime = now;
        return isOpen;
      },

      // Get appropriate cache duration - Smart intervals based on data type and market hours
      getCacheDuration(type = 'STOCK_DATA') {
        if (type === 'QUOTE_DATA') {
          return this.isMarketOpen()
            ? CACHE_CONFIG.QUOTE_DATA_MARKET_OPEN
            : CACHE_CONFIG.QUOTE_DATA_MARKET_CLOSED;
        }

        const intervals = {
          'STOCK_DATA': CACHE_CONFIG.STOCK_DATA,
          'CHART_DATA': CACHE_CONFIG.CHART_DATA,
          'NEWS_DATA': CACHE_CONFIG.NEWS_DATA,
          'SENTIMENT_DATA': CACHE_CONFIG.SENTIMENT_DATA,
          'EARNINGS_DATA': CACHE_CONFIG.EARNINGS_DATA
        };

        return intervals[type] || CACHE_CONFIG.STOCK_DATA;
      },

      // Generate cache key
      key(symbol, type = 'stock') {
        return `${CACHE_CONFIG.CACHE_VERSION}_${type}_${symbol.toUpperCase()}`;
      },

      // INTERNAL: Load from localStorage into memory cache
      _loadToMemory(key) {
        // Already in memory?
        if (this._memoryCache.has(key)) {
          return this._memoryCache.get(key);
        }

        try {
          const cached = localStorage.getItem(key);
          if (!cached) return null;

          // Parse once, store in memory
          const parsed = JSON.parse(cached);

          // Store in memory cache with LRU eviction
          if (this._memoryCache.size >= this._memoryCacheMaxSize) {
            // Remove oldest entry
            const firstKey = this._memoryCache.keys().next().value;
            this._memoryCache.delete(firstKey);
          }
          this._memoryCache.set(key, parsed);

          return parsed;
        } catch (error) {
          return null;
        }
      },

      // Get cached data - INSTANT from memory, falls back to localStorage
      get(symbol, type = 'stock') {
        const key = this.key(symbol, type);
        const cached = this._loadToMemory(key);

        if (!cached) return null;

        // Return data immediately - no logging in hot path
        return cached.data;
      },

      // BATCH GET - Optimized for checking many symbols at once
      getBatch(symbols, type = 'stock') {
        const results = { cached: [], uncached: [] };
        
        symbols.forEach(symbol => {
          const data = this.get(symbol, type);
          if (data) {
            results.cached.push({ symbol, data });
          } else {
            results.uncached.push(symbol);
          }
        });
        
        return results;
      },

      // Get with metadata (for when you need timestamp too)
      getWithMeta(symbol, type = 'stock') {
        const key = this.key(symbol, type);
        return this._loadToMemory(key);
      },
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // BATCH CACHE GET - 10x faster than sequential Cache.get() calls!
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      getBatch(symbols, type = 'stock') {
        const results = {
          cached: [],
          uncached: []
        };
        
        symbols.forEach(symbol => {
          const data = this.get(symbol, type);
          if (data) {
            results.cached.push({ symbol, data });
          } else {
            results.uncached.push(symbol);
          }
        });
        
        return results;
      },

      // Check if cache is expired - uses memory cache, no redundant reads
      isExpired(symbol, type = 'stock') {
        const key = this.key(symbol, type);
        const cached = this._loadToMemory(key);

        if (!cached) return true;

        const age = Date.now() - cached.timestamp;
        const maxAge = this.getCacheDuration(type === 'quote' ? 'QUOTE_DATA' : 'STOCK_DATA');
        return age > maxAge;
      },

      // Get cache timestamp - uses memory cache
      getTimestamp(symbol, type = 'stock') {
        const key = this.key(symbol, type);
        const cached = this._loadToMemory(key);
        return cached ? cached.timestamp : null;
      },

      // Set cached data - writes to both memory and localStorage
      set(symbol, data, type = 'stock') {
        const key = this.key(symbol, type);
        const cacheData = {
          data,
          timestamp: Date.now(),
          version: CACHE_CONFIG.CACHE_VERSION
        };

        // Update memory cache immediately (fast)
        if (this._memoryCache.size >= this._memoryCacheMaxSize) {
          const firstKey = this._memoryCache.keys().next().value;
          this._memoryCache.delete(firstKey);
        }
        this._memoryCache.set(key, cacheData);

        // Persist to localStorage asynchronously (don't block UI)
        requestAnimationFrame(() => {
          try {
            localStorage.setItem(key, JSON.stringify(cacheData));
          } catch (error) {
            if (error.name === 'QuotaExceededError') {
              this.aggressiveCleanup();
              try {
                localStorage.setItem(key, JSON.stringify(cacheData));
              } catch { /* give up */ }
            }
          }
        });
      },

      // Remove specific cache
      remove(symbol, type = 'stock') {
        const key = this.key(symbol, type);
        this._memoryCache.delete(key);
        try {
          localStorage.removeItem(key);
        } catch { /* ignore */ }
      },

      // Clear all caches
      clear() {
        this._memoryCache.clear();
        try {
          const keys = Object.keys(localStorage);
          const cacheKeys = keys.filter(k => k.startsWith(CACHE_CONFIG.CACHE_VERSION));
          cacheKeys.forEach(key => localStorage.removeItem(key));
          console.log(`ğŸ§¹ Cleared ${cacheKeys.length} cached items`);
        } catch { /* ignore */ }
      },

      // Preload frequently accessed stocks into memory (call on app init)
      preloadToMemory(symbols) {
        const startTime = performance.now();
        let loaded = 0;

        symbols.forEach(symbol => {
          const quoteKey = this.key(symbol, 'quote');
          const stockKey = this.key(symbol, 'stock');

          if (this._loadToMemory(quoteKey)) loaded++;
          if (this._loadToMemory(stockKey)) loaded++;
        });

        console.log(`âš¡ Preloaded ${loaded} cache entries to memory in ${(performance.now() - startTime).toFixed(0)}ms`);
      },

      // Remove oldest caches to free up space
      clearOldest() {
        try {
          const keys = Object.keys(localStorage);
          const cacheKeys = keys.filter(k => k.startsWith(CACHE_CONFIG.CACHE_VERSION));

          // Get timestamps and sort by age
          const cacheItems = cacheKeys.map(key => {
            try {
              const { timestamp } = JSON.parse(localStorage.getItem(key));
              return { key, timestamp };
            } catch {
              return { key, timestamp: 0 };
            }
          }).sort((a, b) => a.timestamp - b.timestamp);

          // Remove oldest 20%
          const toRemove = Math.ceil(cacheItems.length * 0.2);
          cacheItems.slice(0, toRemove).forEach(item => {
            localStorage.removeItem(item.key);
          });

          console.log(`ğŸ§¹ Removed ${toRemove} oldest cache items`);
        } catch (error) {
          console.warn('Cache cleanup error:', error);
        }
      },

      // Fetch with cache - returns cached data immediately, refreshes in background if needed
      async fetchWithCache(symbol, type, fetchFunction, options = {}) {
        const { forceRefresh = false } = options;

        // Always return cached data immediately if available (from memory!)
        const cached = this.get(symbol, type);
        if (cached && !forceRefresh) {
          // Use memory-cached metadata instead of re-reading localStorage
          if (this.isExpired(symbol, type)) {
            // Trigger background refresh - use requestIdleCallback for better performance
            const refresh = () => fetchFunction(symbol).then(data => {
              if (data) this.set(symbol, data, type);
            }).catch(() => { });

            if ('requestIdleCallback' in window) {
              requestIdleCallback(refresh, { timeout: 5000 });
            } else {
              setTimeout(refresh, 1000);
            }
          }
          return cached;
        }

        // If no cache or forced refresh, fetch now
        try {
          const freshData = await fetchFunction(symbol);
          if (freshData) {
            this.set(symbol, freshData, type);
            return freshData;
          }
        } catch (error) {
          // Return stale cache as fallback
          if (cached) {
            return cached;
          }
          throw error;
        }

        return null;
      },

      // Smart cleanup - remove expired items
      cleanup() {
        try {
          const keys = Object.keys(localStorage);
          const cacheKeys = keys.filter(k => k.startsWith(CACHE_CONFIG.CACHE_VERSION));

          if (cacheKeys.length <= CACHE_CONFIG.MAX_CACHE_SIZE) return;

          let removed = 0;
          cacheKeys.forEach(key => {
            try {
              const { timestamp } = JSON.parse(localStorage.getItem(key));
              const age = Date.now() - timestamp;

              // Remove if older than 24 hours
              if (age > 24 * 60 * 60 * 1000) {
                localStorage.removeItem(key);
                removed++;
              }
            } catch {
              localStorage.removeItem(key);
              removed++;
            }
          });

          if (removed > 0) {
            console.log(`ğŸ§¹ Cleanup removed ${removed} expired items`);
          }
        } catch (error) {
          console.warn('Cache cleanup error:', error);
        }
      },

      // Get cache statistics (optimized - no full scan)
      stats() {
        return {
          memoryCount: this._memoryCache.size,
          marketOpen: this.isMarketOpen(),
          // Only do full localStorage scan if explicitly requested
          getFullStats: () => {
            const keys = Object.keys(localStorage);
            const cacheKeys = keys.filter(k => k.startsWith(CACHE_CONFIG.CACHE_VERSION));
            let totalSize = 0;
            cacheKeys.forEach(key => {
              totalSize += (localStorage.getItem(key) || '').length;
            });
            return {
              localStorageCount: cacheKeys.length,
              sizeKB: Math.round(totalSize / 1024)
            };
          }
        };
      },

      // Cache index management
      cacheIndex() {
        try {
          const index = localStorage.getItem('re_cache_index');
          return index ? JSON.parse(index) : {};
        } catch {
          return {};
        }
      },

      updateIndex(symbol, type, timestamp) {
        const index = this.cacheIndex();
        const key = this.key(symbol, type);

        index[key] = {
          symbol,
          type,
          timestamp,
          lastAccessed: Date.now(),
          size: JSON.stringify(localStorage.getItem(key) || '').length
        };

        localStorage.setItem('re_cache_index', JSON.stringify(index));
      },

      aggressiveCleanup() {
        const index = this.cacheIndex();
        const entries = Object.entries(index);

        // Sort by last accessed (oldest first)
        entries.sort((a, b) => a[1].lastAccessed - b[1].lastAccessed);

        // Remove 30% oldest entries
        const toRemove = Math.ceil(entries.length * 0.3);
        for (let i = 0; i < toRemove; i++) {
          const [key] = entries[i];
          localStorage.removeItem(key);
          delete index[key];
        }

        localStorage.setItem('re_cache_index', JSON.stringify(index));
      }
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ADVANCED STORAGE MANAGER - IndexedDB + localStorage Hybrid
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const AdvancedStorage = {
      dbName: 'RetailEdgePro_v4',
      version: 4,
      stores: ['stockData', 'chartData', 'newsData', 'analytics'],

      async init() {
        if (!window.indexedDB) {
          console.warn('âš ï¸ IndexedDB not available, falling back to localStorage');
          return false;
        }

        return new Promise((resolve, reject) => {
          const request = indexedDB.open(this.dbName, this.version);

          request.onerror = () => {
            console.error('âŒ IndexedDB initialization failed');
            resolve(false);
          };

          request.onsuccess = () => {
            this.db = request.result;
            console.log('âœ… IndexedDB initialized');
            resolve(true);
          };

          request.onupgradeneeded = (event) => {
            const db = event.target.result;

            // Stock data store
            if (!db.objectStoreNames.contains('stockData')) {
              const store = db.createObjectStore('stockData', { keyPath: 'id' });
              store.createIndex('timestamp', 'timestamp', { unique: false });
              store.createIndex('symbol', 'symbol', { unique: false });
            }

            // Chart data store (larger datasets)
            if (!db.objectStoreNames.contains('chartData')) {
              const store = db.createObjectStore('chartData', { keyPath: 'id' });
              store.createIndex('symbol', 'symbol', { unique: false });
              store.createIndex('timeframe', 'timeframe', { unique: false });
            }

            // News data store
            if (!db.objectStoreNames.contains('newsData')) {
              const store = db.createObjectStore('newsData', { keyPath: 'id' });
              store.createIndex('symbol', 'symbol', { unique: false });
              store.createIndex('publishedAt', 'publishedAt', { unique: false });
            }

            // Analytics cache
            if (!db.objectStoreNames.contains('analytics')) {
              const store = db.createObjectStore('analytics', { keyPath: 'id' });
              store.createIndex('symbol', 'symbol', { unique: false });
              store.createIndex('type', 'type', { unique: false });
            }
          };
        });
      },

      // Compress data before storing
      compress(data) {
        try {
          const stringified = JSON.stringify(data);
          return stringified.length > 1000 ? btoa(stringified) : data;
        } catch {
          return data;
        }
      },

      decompress(data) {
        if (typeof data === 'string' && data.length > 1000) {
          try {
            return JSON.parse(atob(data));
          } catch {
            return data;
          }
        }
        return data;
      },

      // Set data with TTL (default 24 hours instead of 1 hour)
      async set(store, key, value, ttl = 24 * 60 * 60 * 1000) {
        const data = {
          id: key,
          symbol: key.split('_')[0],
          data: this.compress(value),
          timestamp: Date.now(),
          expiresAt: Date.now() + ttl
        };

        try {
          // Try IndexedDB first
          if (this.db) {
            const tx = this.db.transaction(store, 'readwrite');
            await tx.objectStore(store).put(data);
            return true;
          }
        } catch (error) {
          console.warn('âš ï¸ IndexedDB write failed, falling back to localStorage');
        }

        // Fallback to localStorage
        try {
          localStorage.setItem(
            `re_advanced_${store}_${key}`,
            JSON.stringify({ ...data, data: value }) // Don't compress for localStorage
          );
          return true;
        } catch (error) {
          this.handleQuotaExceeded(error, store);
          return false;
        }
      },

      // Get data
      async get(store, key) {
        try {
          // Try IndexedDB first
          if (this.db) {
            const tx = this.db.transaction(store, 'readonly');
            const data = await tx.objectStore(store).get(key);

            if (data && data.expiresAt > Date.now()) {
              return this.decompress(data.data);
            }
            if (data) {
              // Clean up expired data
              this.remove(store, key);
            }
          }
        } catch (error) {
          console.warn('âš ï¸ IndexedDB read failed, falling back to localStorage');
        }

        // Fallback to localStorage
        try {
          const raw = localStorage.getItem(`re_advanced_${store}_${key}`);
          if (!raw) return null;

          const parsed = JSON.parse(raw);
          if (parsed.expiresAt > Date.now()) {
            return parsed.data;
          }
          localStorage.removeItem(`re_advanced_${store}_${key}`);
          return null;
        } catch {
          return null;
        }
      },

      // Remove specific key
      async remove(store, key) {
        try {
          if (this.db) {
            const tx = this.db.transaction(store, 'readwrite');
            await tx.objectStore(store).delete(key);
          }
        } catch { }
        try {
          localStorage.removeItem(`re_advanced_${store}_${key}`);
        } catch { }
      },

      // Clear expired data
      async cleanup(store) {
        if (!this.db) return;

        const tx = this.db.transaction(store, 'readwrite');
        const storeObj = tx.objectStore(store);
        const now = Date.now();

        let count = 0;
        await new Promise((resolve) => {
          const request = storeObj.openCursor();
          request.onsuccess = (event) => {
            const cursor = event.target.result;
            if (cursor) {
              if (cursor.value.expiresAt < now) {
                cursor.delete();
                count++;
              }
              cursor.continue();
            } else {
              resolve();
            }
          };
        });

        console.log(`ğŸ§¹ Cleaned up ${count} expired items from ${store}`);
      },

      // Handle quota exceeded
      handleQuotaExceeded(error, store) {
        console.warn(`âš ï¸ Storage quota exceeded for ${store}`);

        // Clear oldest 20% of data
        try {
          const keys = Object.keys(localStorage).filter(k => k.startsWith(`re_advanced_${store}_`));
          const items = keys.map(k => {
            try {
              const item = localStorage.getItem(k);
              return item ? { key: k, timestamp: JSON.parse(item).timestamp || 0 } : { key: k, timestamp: 0 };
            } catch {
              return { key: k, timestamp: 0 };
            }
          }).sort((a, b) => a.timestamp - b.timestamp);

          const toRemove = Math.ceil(items.length * 0.2);
          items.slice(0, toRemove).forEach(item => {
            try {
              localStorage.removeItem(item.key);
            } catch { }
          });

          console.log(`ğŸ§¹ Removed ${toRemove} oldest items`);
        } catch { }
      },

      // Get storage stats
      async stats() {
        const stats = { indexedDB: { total: 0, stores: {} }, localStorage: 0 };

        try {
          if (this.db) {
            for (const store of this.stores) {
              const tx = this.db.transaction(store, 'readonly');
              const count = await new Promise((resolve) => {
                const request = tx.objectStore(store).count();
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => resolve(0);
              });
              stats.indexedDB.stores[store] = count;
              stats.indexedDB.total += count;
            }
          }
        } catch { }

        try {
          stats.localStorage = Object.keys(localStorage).filter(k => k.startsWith('re_advanced_')).length;
        } catch { }

        return stats;
      }
    };

    // Initialize advanced storage
    AdvancedStorage.init();
    window.AdvancedStorage = AdvancedStorage;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // REQUEST MANAGER - Deduplication & Batching
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const RequestManager = {
      pendingRequests: new Map(),
      batchQueue: [],
      batchTimer: null,
      BATCH_DELAY: 30, // 30ms batching window (faster response)
      MAX_BATCH_SIZE: 25, // Increased from 10 to 25 (FMP supports up to 100)

      // Deduplicate requests
      async fetchUnique(url, options = {}) {
        const key = `${url}_${JSON.stringify(options)}`;

        // If exact request is pending, return its promise
        if (this.pendingRequests.has(key)) {
          console.log(`ğŸ“‹ Using pending request for ${url}`);
          return this.pendingRequests.get(key);
        }

        // Create new promise
        const promise = fetchWithRetry(url, options)
          .finally(() => {
            // Clean up after completion
            setTimeout(() => this.pendingRequests.delete(key), 1000);
          });

        this.pendingRequests.set(key, promise);
        return promise;
      },

      // Batch multiple symbol requests
      batchFetch(apiEndpoint, symbols, params = {}) {
        return new Promise((resolve) => {
          const batchItem = {
            endpoint: apiEndpoint,
            symbols: Array.isArray(symbols) ? symbols : [symbols],
            params,
            resolve
          };

          this.batchQueue.push(batchItem);

          // Clear timer if exists
          if (this.batchTimer) clearTimeout(this.batchTimer);

          // Process batch after delay or when full
          if (this.batchQueue.length >= this.MAX_BATCH_SIZE) {
            this.processBatch();
          } else {
            this.batchTimer = setTimeout(() => this.processBatch(), this.BATCH_DELAY);
          }
        });
      },

      // Process batch queue
      async processBatch() {
        if (this.batchQueue.length === 0) return;

        const queue = [...this.batchQueue];
        this.batchQueue = [];
        if (this.batchTimer) {
          clearTimeout(this.batchTimer);
          this.batchTimer = null;
        }

        // Group by endpoint
        const byEndpoint = {};
        queue.forEach(item => {
          if (!byEndpoint[item.endpoint]) byEndpoint[item.endpoint] = [];
          byEndpoint[item.endpoint].push(item);
        });

        // Execute batches in parallel (multiple endpoints at once)
        const batchPromises = Object.entries(byEndpoint).map(async ([endpoint, items]) => {
          const allSymbols = items.flatMap(i => i.symbols);
          const uniqueSymbols = [...new Set(allSymbols)];

          try {
            // Split into chunks if > 50 symbols (FMP works best with <50 at a time)
            const chunks = [];
            for (let i = 0; i < uniqueSymbols.length; i += 50) {
              chunks.push(uniqueSymbols.slice(i, i + 50));
            }

            // Fetch all chunks in parallel
            const chunkResults = await Promise.all(
              chunks.map(async (chunk) => {
                // FIX: Symbols should be in path, not query parameter
                const batchUrl = `https://financialmodelingprep.com/stable/${endpoint}/${chunk.join(',')}?apikey=${FMP_API_KEY}`;
                console.log(`ğŸš€ Batch fetching ${chunk.length} symbols for ${endpoint}`);
                const response = await this.fetchUnique(batchUrl);
                return await response.json();
              })
            );

            // Combine all chunk results
            const data = chunkResults.flat();

            // Resolve individual promises
            items.forEach(item => {
              const itemData = Array.isArray(data)
                ? data.filter(d => item.symbols.includes(d.symbol))
                : data;
              item.resolve({ data: itemData, success: true });
            });

          } catch (error) {
            console.error(`âŒ Batch fetch failed for ${endpoint}:`, error);
            items.forEach(item => item.resolve({ data: null, success: false }));
          }
        });

        // Wait for all batches to complete
        await Promise.all(batchPromises);
      },

      // Priority-based loading
      async loadWithPriority(symbols, priority = 'high') {
        const priorityWeights = { high: 1, medium: 2, low: 3 };
        const delay = priorityWeights[priority] * 100; // Stagger by priority

        await new Promise(resolve => setTimeout(resolve, delay));

        return this.batchFetch('quote', symbols);
      }
    };

    // Override the existing smartFetch for deduplication
    const originalSmartFetch = smartFetch;
    smartFetch = async function (endpoint, symbol, options = {}) {
      // Use batching for quote and profile endpoints
      if (endpoint.includes('quote') || endpoint.includes('profile')) {
        const result = await RequestManager.batchFetch(endpoint, symbol, options);
        return { data: result.data || [], source: 'batched' };
      }

      // Use deduplication for other requests
      const url = `https://financialmodelingprep.com/stable/${endpoint}?symbol=${symbol}&apikey=${FMP_API_KEY}`;
      const response = await RequestManager.fetchUnique(url, options);
      const data = await response.json();
      return { data, source: 'deduplicated' };
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PREFETCH MANAGER - Load Before User Needs It
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const PrefetchManager = {
      warming: false,
      warmupQueue: [],
      instantLoadComplete: false,

      // INSTANT LOAD: Serve all cached stocks immediately on page load (no API calls!)
      async loadAllFromCache() {
        console.log('âš¡ INSTANT LOAD: Loading all stocks from cache...');
        const startTime = performance.now();
        
        try {
          // Get all cached stock data from IndexedDB
          const cachedStocks = [];
          
          if (AdvancedStorage.db) {
            const tx = AdvancedStorage.db.transaction('stockData', 'readonly');
            const store = tx.objectStore('stockData');
            const allData = await new Promise((resolve, reject) => {
              const request = store.getAll();
              request.onsuccess = () => resolve(request.result);
              request.onerror = () => reject(request.error);
            });
            
            // Filter for quote data (critical data)
            allData.forEach(item => {
              if (item.data?.critical && item.id && !item.id.includes('_')) {
                cachedStocks.push({
                  symbol: item.id,
                  ...item.data.critical
                });
              }
            });
          }
          
          // Also check localStorage for any additional cached data
          const localKeys = Object.keys(localStorage).filter(k => k.startsWith('re_advanced_stockData_'));
          localKeys.forEach(key => {
            try {
              const data = JSON.parse(localStorage.getItem(key));
              if (data?.data?.critical) {
                const symbol = key.replace('re_advanced_stockData_', '');
                if (!symbol.includes('_') && !cachedStocks.find(s => s.symbol === symbol)) {
                  cachedStocks.push({
                    symbol,
                    ...data.data.critical
                  });
                }
              }
            } catch (e) { /* ignore */ }
          });
          
          const duration = performance.now() - startTime;
          console.log(`âš¡ INSTANT LOAD: Loaded ${cachedStocks.length} stocks from cache in ${duration.toFixed(0)}ms`);
          this.instantLoadComplete = true;
          
          return cachedStocks;
        } catch (error) {
          console.warn('Instant load from cache failed:', error);
          return [];
        }
      },

      // Warm up cache on app load (only fetches missing data)
      async warmupDefaultStocks() {
        if (this.warming) return;
        this.warming = true;

        console.log('ğŸ”¥ Starting cache warmup (only missing data)...');

        // Priority 1: Watchlist stocks (if any) - only fetch if not cached
        const savedWatchlist = JSON.parse(localStorage.getItem('watchlist') || '[]');
        if (savedWatchlist.length > 0) {
          // OPTIMIZED: Check all in parallel instead of sequential
          const uncachedWatchlist = [];
          const watchlistChecks = savedWatchlist.slice(0, 20).map(async (symbol) => {
            const cached = await AdvancedStorage.get('stockData', symbol);
            return { symbol, cached: !!cached };
          });
          
          const results = await Promise.all(watchlistChecks);
          results.forEach(({ symbol, cached }) => {
            if (!cached) uncachedWatchlist.push(symbol);
          });
          
          if (uncachedWatchlist.length > 0) {
            console.log(`ğŸ“‹ Fetching ${uncachedWatchlist.length} uncached watchlist stocks`);
            await RequestManager.loadWithPriority(uncachedWatchlist, 'high');
          } else {
            console.log(`ğŸ“‹ All ${savedWatchlist.length} watchlist stocks already cached`);
          }

          // Also fetch chart data for watchlist (if not cached)
          savedWatchlist.slice(0, 10).forEach(symbol => {
            this.prefetchChartData(symbol, '1day');
          });
        }

        // Priority 2: Popular S&P 500 stocks - only fetch if not cached
        const popularStocks = ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'TSLA', 'META', 'NVDA', 'NFLX', 'AMD', 'COIN'];
        
        // OPTIMIZED: Parallel cache checks instead of sequential
        const uncachedPopular = [];
        const popularChecks = popularStocks.map(async (symbol) => {
          const cached = await AdvancedStorage.get('stockData', symbol);
          return { symbol, cached: !!cached };
        });
        
        const popularResults = await Promise.all(popularChecks);
        popularResults.forEach(({ symbol, cached }) => {
          if (!cached) uncachedPopular.push(symbol);
        });
        
        if (uncachedPopular.length > 0) {
          console.log(`ğŸ“ˆ Fetching ${uncachedPopular.length} uncached popular stocks`);
          await RequestManager.loadWithPriority(uncachedPopular, 'medium');
        } else {
          console.log(`ğŸ“ˆ All popular stocks already cached`);
        }

        // Priority 3: Sector data
        console.log('ğŸ¢ Pre-fetching sector averages');
        this.prefetchSectorData();

        this.warming = false;
        console.log('âœ… Cache warmup complete');
      },

      // Prefetch chart data in background
      async prefetchChartData(symbol, timeframe = '1day') {
        const cacheKey = `${symbol}_${timeframe}`;
        const cached = await AdvancedStorage.get('chartData', cacheKey);
        if (cached) return; // Already cached

        try {
          const response = await fetch(
            `https://financialmodelingprep.com/stable/historical-chart/${timeframe}?symbol=${symbol}&apikey=${FMP_API_KEY}`
          );
          const data = await response.json();

          // Cache for 24 hours (chart data is stable)
          await AdvancedStorage.set('chartData', cacheKey, data, CACHE_CONFIG.CHART_DATA);
          console.log(`ğŸ’¾ Cached chart data for ${symbol} (${timeframe})`);
        } catch (error) {
          console.warn(`âš ï¸ Failed to prefetch chart for ${symbol}:`, error);
        }
      },

      // Prefetch sector averages - uses real cached/loaded stocks only
      async prefetchSectorData(loadedStocks = []) {
        if (!loadedStocks || loadedStocks.length === 0) {
          console.log('ğŸ“Š Skipping sector prefetch - no loaded stocks yet');
          return;
        }
        
        const sectors = [...new Set(loadedStocks.map(s => s.sector).filter(Boolean))];
        for (const sector of sectors) {
          const sectorStocks = loadedStocks.filter(s => s.sector === sector);
          if (sectorStocks.length === 0) continue;
          
          const avgMetrics = {
            pe: sectorStocks.reduce((sum, s) => sum + (parseFloat(s.pe) || 0), 0) / sectorStocks.length,
            roe: sectorStocks.reduce((sum, s) => sum + (parseFloat(s.roe) || 0), 0) / sectorStocks.length,
            grossMargin: sectorStocks.reduce((sum, s) => sum + (parseFloat(s.grossMargin) || 0), 0) / sectorStocks.length
          };

          await AdvancedStorage.set('analytics', `sector_${sector}`, avgMetrics, 7 * 24 * 60 * 60 * 1000);
        }
        console.log(`ğŸ“Š Cached sector averages for ${sectors.length} sectors`);
      },

      // Predictive fetch based on user behavior - uses real loaded stocks only
      async onStockViewed(symbol, loadedStocks = []) {
        // Fetch related stocks (same sector) from real loaded data
        const stock = loadedStocks.find(s => s.symbol === symbol);
        if (stock?.sector) {
          const related = loadedStocks.filter(s => s.sector === stock.sector && s.symbol !== symbol).slice(0, 5);
          if (related.length > 0) {
            console.log(`ğŸ”® Predictively fetching ${related.length} related stocks in ${stock.sector} sector`);
            related.forEach(s => this.prefetchChartData(s.symbol, '4hour'));
          }
        }

        // Preload next earnings date if available
        this.prefetchEarningsData(symbol);
      },

      // Prefetch earnings data
      async prefetchEarningsData(symbol) {
        try {
          const response = await fetch(
            `https://financialmodelingprep.com/stable/earnings?symbol=${symbol}&apikey=${FMP_API_KEY}`
          );
          const data = await response.json();
          await AdvancedStorage.set('stockData', `${symbol}_earnings`, data, CACHE_CONFIG.EARNINGS_DATA);
        } catch (error) {
          console.warn(`âš ï¸ Failed to prefetch earnings for ${symbol}:`, error);
        }
      }
    };

    // Expose PrefetchManager for instant load feature
    window.PrefetchManager = PrefetchManager;
    
    // DELAYED WARMUP: Start only AFTER main loading completes (60 seconds)
    // This prevents API conflicts during initial load
    setTimeout(() => {
      if (!window.isFetchingStocks) {
        PrefetchManager.warmupDefaultStocks();
      } else {
        // Retry after another 30 seconds if still loading
        setTimeout(() => PrefetchManager.warmupDefaultStocks(), 30000);
      }
    }, 60000);

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PERFORMANCE MONITOR - Track & Optimize
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const PerformanceMonitor = {
      metrics: [],

      track(operation, duration, success = true) {
        this.metrics.push({
          operation,
          duration,
          success,
          timestamp: Date.now(),
          apiCalls: API_STATS
        });

        // Keep only last 100 metrics
        if (this.metrics.length > 100) {
          this.metrics = this.metrics.slice(-100);
        }

        console.log(`âš¡ ${operation}: ${duration}ms ${success ? 'âœ…' : 'âŒ'}`);
      },

      // Calculate cache hit rate
      getCacheStats() {
        const total = this.metrics.length;
        const cached = this.metrics.filter(m => m.duration < 5).length; // <5ms = cache

        return {
          hitRate: total > 0 ? Math.round((cached / total) * 100) : 0,
          avgDuration: total > 0 ? Math.round(this.metrics.reduce((sum, m) => sum + m.duration, 0) / total) : 0,
          apiCalls: Object.entries(API_STATS).map(([api, stats]) => ({
            api,
            calls: stats.calls,
            failures: stats.failures,
            successRate: Math.round((1 - stats.failures / Math.max(1, stats.calls)) * 100)
          }))
        };
      },

      // Export performance report
      exportReport() {
        const stats = this.getCacheStats();
        const report = {
          timestamp: new Date().toISOString(),
          cacheHitRate: `${stats.hitRate}%`,
          averageLatency: `${stats.avgDuration}ms`,
          apiPerformance: stats.apiCalls,
          storageStats: AdvancedStorage.stats()
        };

        console.table(report.apiPerformance);
        console.log('ğŸ“Š Performance Report:', report);

        // Download as JSON
        const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `perf-report-${Date.now()}.json`;
        a.click();

        return report;
      },

      // Show loading indicators based on performance
      getLoadingRecommendation() {
        const stats = this.getCacheStats();

        if (stats.hitRate > 80) {
          return { strategy: 'aggressive', message: 'Cache is hot - use optimistic UI' };
        } else if (stats.hitRate > 50) {
          return { strategy: 'balanced', message: 'Moderate cache hit rate - show skeletons' };
        } else {
          return { strategy: 'conservative', message: 'Cache is cold - show loading spinners' };
        }
      }
    };

    // Add to window for debugging
    window.PerformanceMonitor = PerformanceMonitor;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // OPTIMIZED STOCK LOADER - Load What You Need, When You Need It
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const OptimizedStockLoader = {
      // Stale-while-revalidate: serve cached data instantly, refresh in background
      STALE_WHILE_REVALIDATE: true,
      
      // Load critical data first, then enhance
      async loadStock(symbol) {
        const startTime = performance.now();

        // Phase 1: Critical data (price, change, volume) - uses stale-while-revalidate
        const critical = await this.loadCriticalData(symbol);

        // Phase 2: Fundamental data (PE, ROE, growth) - cached for 7 days
        this.loadFundamentalData(symbol).then(data => {
          this.mergeStockData(symbol, { fundamental: data });
        });

        // Phase 3: Technical data (RSI, SMA)
        this.loadTechnicalData(symbol).then(data => {
          this.mergeStockData(symbol, { technical: data });
        });

        // Phase 4: Non-critical (news, sentiment)
        this.loadEnhancementData(symbol);

        const duration = performance.now() - startTime;
        PerformanceMonitor.track(`loadStock:${symbol}`, duration);

        return critical;
      },

      async loadCriticalData(symbol) {
        // STALE-WHILE-REVALIDATE: Return cached data immediately, refresh in background
        const cached = await AdvancedStorage.get('stockData', symbol);
        
        if (cached && cached.critical) {
          // Check if data is stale (older than quote cache duration)
          const isStale = cached.timestamp && (Date.now() - cached.timestamp > Cache.getCacheDuration('QUOTE_DATA'));
          
          if (this.STALE_WHILE_REVALIDATE && isStale) {
            // Return stale data immediately, refresh in background
            console.log(`âš¡ Serving stale data for ${symbol}, refreshing in background...`);
            this.refreshInBackground(symbol);
          }
          
          return cached.critical;
        }

        // No cache - fetch from API
        const response = await RequestManager.batchFetch('quote', symbol);
        const data = Array.isArray(response.data) ? response.data[0] : response.data;

        // Cache with timestamp for stale checking
        const ttl = Cache.getCacheDuration('QUOTE_DATA');
        await AdvancedStorage.set('stockData', symbol, { 
          critical: data, 
          timestamp: Date.now() 
        }, ttl);

        return data;
      },
      
      // Background refresh without blocking UI
      async refreshInBackground(symbol) {
        try {
          const response = await RequestManager.batchFetch('quote', symbol);
          const data = Array.isArray(response.data) ? response.data[0] : response.data;
          
          if (data) {
            const ttl = Cache.getCacheDuration('QUOTE_DATA');
            await AdvancedStorage.set('stockData', symbol, { 
              critical: data, 
              timestamp: Date.now() 
            }, ttl);
            console.log(`ğŸ”„ Background refresh complete for ${symbol}`);
          }
        } catch (error) {
          console.warn(`Background refresh failed for ${symbol}:`, error);
        }
      },

      async loadFundamentalData(symbol) {
        // CACHE-FIRST: Fundamentals rarely change, serve from cache when available
        const cached = await AdvancedStorage.get('stockData', `${symbol}_fundamentals`);
        if (cached) {
          // Fundamentals cached for 7 days - no background refresh needed
          return cached;
        }

        const [profile, ratios] = await Promise.all([
          fetch(`https://financialmodelingprep.com/stable/profile/${symbol}?apikey=${FMP_API_KEY}`).then(r => r.json()),
          fetch(`https://financialmodelingprep.com/stable/ratios/${symbol}?apikey=${FMP_API_KEY}`).then(r => r.json())
        ]);

        const data = {
          ...profile[0],
          ...ratios[0]
        };

        // Cache for 7 days (CACHE_CONFIG.STOCK_DATA)
        await AdvancedStorage.set('stockData', `${symbol}_fundamentals`, data, CACHE_CONFIG.STOCK_DATA);
        return data;
      },

      async loadTechnicalData(symbol) {
        // STALE-WHILE-REVALIDATE for technicals too
        const cached = await AdvancedStorage.get('stockData', `${symbol}_technical`);
        if (cached) {
          // Check staleness - refresh in background if old
          const age = cached.timestamp ? (Date.now() - cached.timestamp) : Infinity;
          if (age > Cache.getCacheDuration('QUOTE_DATA')) {
            this.refreshTechnicalInBackground(symbol);
          }
          return cached;
        }

        return await this.fetchTechnicalData(symbol);
      },
      
      async fetchTechnicalData(symbol) {
        // Use multiple sources for technicals
        const [taData, quote] = await Promise.all([
          fetch(`https://financialmodelingprep.com/stable/technical-indicator/1hour?symbol=${symbol}&apikey=${FMP_API_KEY}`).then(r => r.json()),
          fetch(`https://financialmodelingprep.com/stable/quote/${symbol}?apikey=${FMP_API_KEY}`).then(r => r.json())
        ]);

        const data = {
          rsi: quote[0]?.rsi || taData[0]?.rsi,
          sma20: taData[0]?.sma20,
          sma50: taData[0]?.sma50,
          macd: taData[0]?.macd,
          timestamp: Date.now()
        };
        
        await AdvancedStorage.set('stockData', `${symbol}_technical`, data, Cache.getCacheDuration('QUOTE_DATA'));
        return data;
      },
      
      async refreshTechnicalInBackground(symbol) {
        try {
          await this.fetchTechnicalData(symbol);
          console.log(`ğŸ”„ Technical data refreshed for ${symbol}`);
        } catch (e) {
          console.warn(`Technical refresh failed for ${symbol}`);
        }
      },

      // LEGACY: Keep for compatibility
      async loadTechnicalDataLegacy(symbol) {
        const cached = await AdvancedStorage.get('stockData', `${symbol}_technical`);
        if (cached) return cached;

        // Use multiple sources for technicals
        const [taData, quote] = await Promise.all([
          fetch(`https://financialmodelingprep.com/stable/technical-indicator/1hour?symbol=${symbol}&apikey=${FMP_API_KEY}`).then(r => r.json()),
          fetch(`https://financialmodelingprep.com/stable/quote/${symbol}?apikey=${FMP_API_KEY}`).then(r => r.json())
        ]);

        const data = {
          rsi: quote[0]?.rsi || taData[0]?.rsi,
          sma20: taData[0]?.sma20,
          sma50: taData[0]?.sma50,
          macd: taData[0]?.macd
        };

        await AdvancedStorage.set('stockData', `${symbol}_technical`, data, Cache.getCacheDuration('QUOTE_DATA'));
        return data;
      },

      async loadEnhancementData(symbol) {
        // Non-blocking background load
        Promise.all([
          this.prefetchNewsData(symbol),
          this.prefetchSocialData(symbol)
        ]);
      },

      async prefetchNewsData(symbol) {
        // Placeholder for news prefetching
        return Promise.resolve();
      },

      async prefetchSocialData(symbol) {
        // Placeholder for social data prefetching
        return Promise.resolve();
      },

      mergeStockData(symbol, updates) {
        // Merge incremental updates into existing data
        // This would integrate with your React state management
        console.log(`ğŸ“¦ Merging updates for ${symbol}:`, Object.keys(updates));
      }
    };

    window.OptimizedStockLoader = OptimizedStockLoader;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PREDICTIVE PREFETCHER - Learn User Patterns
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    class PredictivePrefetcher {
      constructor() {
        this.userPatterns = this.loadPatterns();
        this.prefetchQueue = [];
        this.maxPrefetch = 5;
      }

      loadPatterns() {
        return JSON.parse(localStorage.getItem('re_user_patterns') || '{}');
      }

      savePatterns() {
        localStorage.setItem('re_user_patterns', JSON.stringify(this.userPatterns));
      }

      recordView(symbol) {
        if (!this.userPatterns[symbol]) {
          this.userPatterns[symbol] = { views: 0, lastViewed: Date.now() };
        }
        this.userPatterns[symbol].views++;
        this.userPatterns[symbol].lastViewed = Date.now();

        // Keep only top 50 most viewed symbols
        const sorted = Object.entries(this.userPatterns)
          .sort((a, b) => b[1].views - a[1].views)
          .slice(0, 50);

        this.userPatterns = Object.fromEntries(sorted);
        this.savePatterns();

        // Trigger prefetch for related symbols
        this.schedulePrefetch(symbol);
      }

      schedulePrefetch(currentSymbol) {
        // Get similar symbols (same sector, similar market cap)
        const topSymbols = Object.keys(this.userPatterns)
          .filter(s => s !== currentSymbol)
          .slice(0, this.maxPrefetch);

        topSymbols.forEach(symbol => {
          if (!this.prefetchQueue.includes(symbol)) {
            this.prefetchQueue.push(symbol);
          }
        });

        // Process queue in background
        setTimeout(() => this.processPrefetchQueue(), 100);
      }

      async processPrefetchQueue() {
        while (this.prefetchQueue.length > 0) {
          const symbol = this.prefetchQueue.shift();

          // Check if cache is stale or missing
          const cached = Cache.get(symbol);
          if (!cached || isStaleTimestamp(cached.timestamp, 'quote')) {
            // Fetch in background with low priority
            setTimeout(async () => {
              try {
                const result = await smartFetch('quote', symbol);
                if (result?.data) {
                  Cache.set(symbol, result.data, 'quote');
                }
              } catch (error) {
                // Silent fail for prefetch
              }
            }, Math.random() * 3000); // Random delay to avoid rate limits
          }
        }
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // COMMON DATA STORE - Shared Data Across All Stocks
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const CommonDataStore = {
      // Store frequently used data in a single key
      sectors: null,
      indices: null,
      marketStatus: null,

      init() {
        this.loadCommonData();
        // Refresh every 30 minutes
        setInterval(() => this.refreshCommonData(), 30 * 60 * 1000);
      },

      loadCommonData() {
        try {
          const data = localStorage.getItem('re_common_data');
          if (data) {
            const parsed = JSON.parse(data);
            this.sectors = parsed.sectors || {};
            this.indices = parsed.indices || {};
            this.marketStatus = parsed.marketStatus || {};
          }
        } catch (error) {
          console.warn('Failed to load common data:', error);
        }
      },

      saveCommonData() {
        const data = {
          sectors: this.sectors,
          indices: this.indices,
          marketStatus: this.marketStatus,
          timestamp: Date.now()
        };

        try {
          localStorage.setItem('re_common_data', JSON.stringify(data));
        } catch (error) {
          console.warn('Failed to save common data:', error);
        }
      },

      async refreshCommonData() {
        // Fetch common data once and share across all stocks
        try {
          // Fetch sector performance
          const sectorsResponse = await fetch(
            `https://financialmodelingprep.com/stable/sector-performance?apikey=${API_KEYS.FMP}`
          );
          if (sectorsResponse.ok) {
            this.sectors = await sectorsResponse.json();
          }

          // Fetch market indices
          const indices = ['^GSPC', '^DJI', '^IXIC', '^RUT'];
          const indexPromises = indices.map(symbol =>
            smartFetch('quote', symbol).catch(() => null)
          );

          const indexResults = await Promise.all(indexPromises);
          this.indices = indexResults.filter(r => r).map(r => r.data[0]);

          this.saveCommonData();
        } catch (error) {
          console.warn('Common data refresh failed:', error);
        }
      }
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // WEB WORKER - Background Data Fetching
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Create web worker for background fetching
    const createDataWorker = () => {
      if (typeof Worker !== 'undefined') {
        const workerCode = `
          self.onmessage = function(e) {
            const { symbols, apiKey } = e.data;
            
            // Process in background
            symbols.forEach(symbol => {
              fetch(\`https://financialmodelingprep.com/stable/quote/\${symbol}?apikey=\${apiKey}\`)
                .then(r => r.json())
                .then(data => {
                  self.postMessage({ symbol, data });
                })
                .catch(error => {
                  // Silent fail
                });
            });
          };
        `;

        const blob = new Blob([workerCode], { type: 'application/javascript' });
        return new Worker(URL.createObjectURL(blob));
      }
      return null;
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // BATCH API PROCESSOR - Efficient Batch Requests
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    class BatchAPIProcessor {
      constructor() {
        this.batchSize = 5; // Max symbols per batch
        this.batchDelay = 100; // ms between batches
        this.pendingRequests = new Map();
      }

      async batchFetch(symbols, endpoint = 'quote') {
        const results = {};
        const batches = [];

        // Create batches
        for (let i = 0; i < symbols.length; i += this.batchSize) {
          batches.push(symbols.slice(i, i + this.batchSize));
        }

        // Process batches with delay
        for (let i = 0; i < batches.length; i++) {
          const batch = batches[i];
          const batchResults = await this.processBatch(batch, endpoint);
          Object.assign(results, batchResults);

          // Delay between batches (except last)
          if (i < batches.length - 1) {
            await new Promise(resolve => setTimeout(resolve, this.batchDelay));
          }
        }

        return results;
      }

      async processBatch(symbols, endpoint) {
        // Use batch endpoint if available
        if (endpoint === 'quote' && symbols.length > 1) {
          try {
            const symbolList = symbols.join(',');
            const url = `https://financialmodelingprep.com/stable/quote/${symbolList}?apikey=${API_KEYS.FMP}`;

            const response = await fetchWithRetry(url, {
              timeoutMs: 15000,
              retries: 1
            });

            if (response.ok) {
              const data = await response.json();
              const result = {};
              symbols.forEach((symbol, index) => {
                result[symbol] = Array.isArray(data) ? data[index] : null;
              });
              return result;
            }
          } catch (error) {
            // Fall back to individual
          }
        }

        // Individual fallback
        const promises = symbols.map(symbol =>
          smartFetch(endpoint, symbol).then(r => r.data).catch(() => null)
        );

        const results = await Promise.all(promises);
        const mapped = {};
        symbols.forEach((symbol, i) => {
          mapped[symbol] = results[i];
        });

        return mapped;
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STORAGE MANAGER - Adaptive Storage Management
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const StorageManager = {
      modes: ['optimal', 'degraded', 'minimal'],
      currentMode: 'optimal',

      init() {
        this.detectStorageCapabilities();
        this.setupFallbacks();
      },

      detectStorageCapabilities() {
        try {
          // Test storage
          localStorage.setItem('re_test', 'test');
          localStorage.removeItem('re_test');

          // Check available space
          let testData = '';
          for (let i = 0; i < 1024; i++) {
            testData += '1234567890';
          }

          try {
            localStorage.setItem('re_space_test', testData);
            localStorage.removeItem('re_space_test');
            this.currentMode = 'optimal';
          } catch {
            this.currentMode = 'degraded';
          }
        } catch (error) {
          this.currentMode = 'minimal';
        }
      },

      setupFallbacks() {
        switch (this.currentMode) {
          case 'optimal':
            // Full caching enabled
            CACHE_CONFIG.MAX_CACHE_SIZE = 500;
            break;

          case 'degraded':
            // Reduced caching
            CACHE_CONFIG.MAX_CACHE_SIZE = 100;
            CACHE_CONFIG.STOCK_DATA = 30 * 60 * 1000; // 30 min
            CACHE_CONFIG.QUOTE_DATA = 5 * 60 * 1000;  // 5 min
            break;

          case 'minimal':
            // Minimal caching
            CACHE_CONFIG.MAX_CACHE_SIZE = 20;
            CACHE_CONFIG.STOCK_DATA = 10 * 60 * 1000; // 10 min
            CACHE_CONFIG.QUOTE_DATA = 2 * 60 * 1000;  // 2 min
            break;
        }
      },

      getItem(key) {
        try {
          return localStorage.getItem(key);
        } catch {
          return null;
        }
      },

      setItem(key, value) {
        try {
          localStorage.setItem(key, value);
          return true;
        } catch {
          // Try to make space
          this.emergencyCleanup();
          try {
            localStorage.setItem(key, value);
            return true;
          } catch {
            return false;
          }
        }
      },

      emergencyCleanup() {
        // Remove oldest 50% of cache
        const keys = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key && key.startsWith(CACHE_CONFIG.CACHE_VERSION)) {
            keys.push(key);
          }
        }

        // Remove half
        const toRemove = Math.floor(keys.length / 2);
        for (let i = 0; i < toRemove; i++) {
          try {
            localStorage.removeItem(keys[i]);
          } catch { }
        }
      }
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PRIORITY LOADER - Load Critical Data First
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    class PriorityLoader {
      constructor() {
        this.priorities = {
          critical: ['price', 'changePct', 'symbol', 'name'],
          high: ['pe', 'roe', 'volume', 'marketCap'],
          medium: ['rsi', 'beta', 'debtToEquity', 'currentRatio'],
          low: ['revenueGrowth', 'netMargin', 'analystRating', 'dividendYield']
        };
      }

      async loadStockWithPriority(symbol, priority = 'critical') {
        const cached = Cache.get(symbol);
        if (cached) {
          // Return cached data immediately
          const result = { ...cached };

          // If we need more data than cached, fetch in background
          if (priority !== 'critical' && this.needsEnhancedData(cached, priority)) {
            setTimeout(() => this.loadEnhancedData(symbol), 0);
          }

          return result;
        }

        // Load critical data first
        const criticalData = await this.fetchPriorityData(symbol, 'critical');
        if (criticalData) {
          Cache.set(symbol, criticalData);
        }

        // Load other priorities in background
        if (priority !== 'critical') {
          setTimeout(() => this.loadEnhancedData(symbol, priority), 100);
        }

        return criticalData;
      }

      async fetchPriorityData(symbol, priority) {
        const fields = this.getFieldsForPriority(priority);

        // Build API call with only needed fields
        const url = `https://financialmodelingprep.com/stable/quote/${symbol}?apikey=${API_KEYS.FMP}`;

        try {
          const response = await fetchWithRetry(url, { timeoutMs: 8000 });
          if (response.ok) {
            const data = await response.json();
            return this.filterDataByPriority(Array.isArray(data) ? data[0] : data, fields);
          }
        } catch (error) {
          // Fallback
        }

        return null;
      }

      async loadEnhancedData(symbol, priority = 'high') {
        const fields = this.getFieldsForPriority(priority);
        const url = `https://financialmodelingprep.com/stable/profile/${symbol}?apikey=${API_KEYS.FMP}`;

        try {
          const response = await fetch(url);
          if (response.ok) {
            const data = await response.json();
            const enhanced = this.filterDataByPriority(Array.isArray(data) ? data[0] : data, fields);

            // Update cache
            const cached = Cache.get(symbol) || {};
            Cache.set(symbol, { ...cached, ...enhanced });
          }
        } catch (error) {
          // Silent fail for background loading
        }
      }

      getFieldsForPriority(priority) {
        return this.priorities[priority] || this.priorities.critical;
      }

      filterDataByPriority(data, fields) {
        if (!data) return {};
        const filtered = {};
        fields.forEach(field => {
          if (data[field] !== undefined) {
            filtered[field] = data[field];
          }
        });
        return filtered;
      }

      needsEnhancedData(cachedData, requestedPriority) {
        const requestedFields = this.getFieldsForPriority(requestedPriority);
        return requestedFields.some(field => cachedData[field] === undefined);
      }
    }

    // Initialize optimizations
    StorageManager.init();
    CommonDataStore.init();
    const predictivePrefetcher = new PredictivePrefetcher();
    const priorityLoader = new PriorityLoader();
    const batchProcessor = new BatchAPIProcessor();

    // Helper functions
    async function loadStockData(symbol) {
      // Use priority loader for immediate critical data
      const criticalData = await priorityLoader.loadStockWithPriority(symbol, 'critical');

      // Record for prefetching
      predictivePrefetcher.recordView(symbol);

      return criticalData;
    }

    async function loadMultipleStocks(symbols) {
      return batchProcessor.batchFetch(symbols, 'quote');
    }

    // Make available globally
    window.predictivePrefetcher = predictivePrefetcher;
    window.priorityLoader = priorityLoader;
    window.batchProcessor = batchProcessor;
    window.loadStockData = loadStockData;
    window.loadMultipleStocks = loadMultipleStocks;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SECTOR-AWARE AI SCORING CONFIGURATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const SECTOR_METRICS = {
      'Technology': {
        pe_base: 28,
        pe_acceptable: 35,
        roe_target: 20,
        roe_excellent: 30,
        growth_target: 15,
        growth_excellent: 25,
        margin_target: 25
      },
      'Financial Services': {
        pe_base: 12,
        pe_acceptable: 15,
        roe_target: 12,
        roe_excellent: 18,
        growth_target: 5,
        growth_excellent: 10,
        margin_target: 30
      },
      'Healthcare': {
        pe_base: 22,
        pe_acceptable: 28,
        roe_target: 15,
        roe_excellent: 25,
        growth_target: 10,
        growth_excellent: 18,
        margin_target: 20
      },
      'Consumer Cyclical': {
        pe_base: 20,
        pe_acceptable: 25,
        roe_target: 15,
        roe_excellent: 22,
        growth_target: 8,
        growth_excellent: 15,
        margin_target: 15
      },
      'Consumer Defensive': {
        pe_base: 18,
        pe_acceptable: 22,
        roe_target: 18,
        roe_excellent: 25,
        growth_target: 5,
        growth_excellent: 10,
        margin_target: 12
      },
      'Energy': {
        pe_base: 15,
        pe_acceptable: 20,
        roe_target: 12,
        roe_excellent: 20,
        growth_target: 5,
        growth_excellent: 12,
        margin_target: 10
      },
      'Industrials': {
        pe_base: 18,
        pe_acceptable: 23,
        roe_target: 14,
        roe_excellent: 20,
        growth_target: 7,
        growth_excellent: 12,
        margin_target: 12
      },
      'Communication Services': {
        pe_base: 25,
        pe_acceptable: 30,
        roe_target: 18,
        roe_excellent: 25,
        growth_target: 12,
        growth_excellent: 20,
        margin_target: 20
      },
      'Default': {
        pe_base: 20,
        pe_acceptable: 25,
        roe_target: 15,
        roe_excellent: 22,
        growth_target: 10,
        growth_excellent: 18,
        margin_target: 15
      }
    };

    // Get sector benchmarks with fallback
    function getSectorBenchmarks(sector) {
      return SECTOR_METRICS[sector] || SECTOR_METRICS['Default'];
    }



    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PHASE 1: COMMERCIAL FEATURES - USER ACCOUNT SYSTEM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const UserManager = {
      isLoggedIn() {
        return localStorage.getItem('re_user_id') !== null;
      },

      getCurrentUser() {
        const userId = localStorage.getItem('re_user_id');
        if (!userId) return null;

        try {
          return JSON.parse(localStorage.getItem(`re_user_${userId}`));
        } catch {
          return null;
        }
      },

      register(email, password, name) {
        return new Promise((resolve, reject) => {
          try {
            if (!email || !password || !name) {
              reject('All fields are required');
              return;
            }

            const existingUsers = this.getAllUsers();
            if (existingUsers.find(u => u.email === email)) {
              reject('Email already registered');
              return;
            }

            const userId = 'user_' + Date.now() + Math.random().toString(36).substr(2, 9);
            const user = {
              id: userId,
              email,
              name,
              createdAt: new Date().toISOString(),
              lastLogin: new Date().toISOString(),
              preferences: {
                theme: 'dark',
                defaultView: 'beginner',
                notifications: true,
                riskTolerance: 'moderate'
              },
              investmentProfile: {
                experience: 'beginner',
                goals: [],
                timeHorizon: 'medium'
              },
              subscription: {
                tier: 'free',
                expiresAt: null,
                features: ['basic_screening', 'watchlist', 'portfolio_tracking']
              }
            };

            localStorage.setItem('re_user_id', userId);
            localStorage.setItem(`re_user_${userId}`, JSON.stringify(user));
            this.initializeUserData(userId);

            resolve(user);
          } catch (error) {
            reject('Registration failed');
          }
        });
      },

      login(email, password) {
        return new Promise((resolve, reject) => {
          try {
            const users = this.getAllUsers();
            const user = users.find(u => u.email === email);

            if (!user) {
              reject('User not found');
              return;
            }

            if (!password) {
              reject('Password required');
              return;
            }

            user.lastLogin = new Date().toISOString();
            localStorage.setItem(`re_user_${user.id}`, JSON.stringify(user));
            localStorage.setItem('re_user_id', user.id);

            resolve(user);
          } catch (error) {
            reject('Login failed');
          }
        });
      },

      logout() {
        localStorage.removeItem('re_user_id');
      },

      updatePreferences(preferences) {
        const user = this.getCurrentUser();
        if (!user) return null;
        user.preferences = { ...user.preferences, ...preferences };
        localStorage.setItem(`re_user_${user.id}`, JSON.stringify(user));
        return user;
      },

      updateInvestmentProfile(profile) {
        const user = this.getCurrentUser();
        if (!user) return null;
        user.investmentProfile = { ...user.investmentProfile, ...profile };
        localStorage.setItem(`re_user_${user.id}`, JSON.stringify(user));
        return user;
      },

      getAllUsers() {
        const users = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.startsWith('re_user_') && !key.endsWith('_data')) {
            try {
              users.push(JSON.parse(localStorage.getItem(key)));
            } catch { }
          }
        }
        return users;
      },

      initializeUserData(userId) {
        const userData = {
          watchlist: [],
          portfolio: [],
          savedScreens: [],
          alerts: [],
          learningProgress: {
            completedLessons: [],
            currentStreak: 0,
            totalPoints: 0
          }
        };
        localStorage.setItem(`re_user_${userId}_data`, JSON.stringify(userData));
      },

      getUserData() {
        const user = this.getCurrentUser();
        if (!user) return null;

        try {
          const data = localStorage.getItem(`re_user_${user.id}_data`);
          if (!data) {
            this.initializeUserData(user.id);
            return JSON.parse(localStorage.getItem(`re_user_${user.id}_data`));
          }
          return JSON.parse(data);
        } catch {
          this.initializeUserData(user.id);
          return JSON.parse(localStorage.getItem(`re_user_${user.id}_data`));
        }
      },

      updateUserData(data) {
        const user = this.getCurrentUser();
        if (!user) return null;
        const currentData = this.getUserData();
        const newData = { ...currentData, ...data };
        localStorage.setItem(`re_user_${user.id}_data`, JSON.stringify(newData));
        return newData;
      }
    };


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PHASE 1: SUBSCRIPTION SYSTEM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const SubscriptionManager = {
      TIERS: {
        free: {
          name: 'Free',
          price: 0,
          limits: {
            stocksPerScreen: 20,
            watchlistItems: 10,
            portfolioItems: 5,
            alerts: 3,
            apiCallsPerDay: 100
          },
          features: [
            'Basic stock screening',
            'Watchlist (10 stocks)',
            'Portfolio tracking (5 stocks)',
            'Price alerts (3)',
            'Community access'
          ]
        },
        premium: {
          name: 'Premium',
          price: 9.99,
          limits: {
            stocksPerScreen: 100,
            watchlistItems: 50,
            portfolioItems: 25,
            alerts: 25,
            apiCallsPerDay: 1000
          },
          features: [
            'Advanced stock screening',
            'Unlimited watchlist',
            'Portfolio tracking (25 stocks)',
            'Price alerts (25)',
            'Real-time data',
            'Advanced analytics',
            'Priority support'
          ]
        },
        pro: {
          name: 'Pro',
          price: 19.99,
          limits: {
            stocksPerScreen: 500,
            watchlistItems: 200,
            portfolioItems: 100,
            alerts: 100,
            apiCallsPerDay: 10000
          },
          features: [
            'Everything in Premium',
            'API access',
            'Custom screening criteria',
            'Portfolio optimization',
            'Tax loss harvesting',
            'Dedicated support'
          ]
        }
      },

      getCurrentSubscription() {
        const user = UserManager.getCurrentUser();
        if (!user) return this.TIERS.free;
        const tier = user.subscription?.tier || 'free';
        return { ...this.TIERS[tier], tier };
      },

      hasFeature(feature) {
        const subscription = this.getCurrentSubscription();
        return subscription.features.includes(feature);
      },

      checkLimit(limitType, currentCount) {
        const subscription = this.getCurrentSubscription();
        const limit = subscription.limits[limitType];
        return currentCount < limit;
      },

      upgrade(tier) {
        return new Promise((resolve, reject) => {
          const user = UserManager.getCurrentUser();
          if (!user) {
            reject('User not logged in');
            return;
          }

          if (!this.TIERS[tier]) {
            reject('Invalid tier');
            return;
          }

          user.subscription = {
            tier: tier,
            expiresAt: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
            features: this.TIERS[tier].features
          };

          localStorage.setItem(`re_user_${user.id}`, JSON.stringify(user));
          resolve(user.subscription);
        });
      }
    };


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PHASE 1: BEGINNER MODE SYSTEM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const BeginnerMode = {
      SIMPLIFIED_METRICS: [
        { key: 'price', label: 'Price', explanation: 'Current stock price' },
        { key: 'changePct', label: 'Today\'s Change', explanation: 'Price change today' },
        { key: 'pe', label: 'P/E Ratio', explanation: 'Price Ã· Earnings. Lower may be better value' },
        { key: 'roe', label: 'ROE', explanation: 'Return on Equity. Higher is better' },
        { key: 'aiScore', label: 'AI Score', explanation: 'Overall rating from our analysis' }
      ],

      EXPLANATIONS: {
        pe: "Think of P/E like a price tag for earnings. A P/E of 20 means you're paying $20 for each $1 of company earnings.",
        roe: "ROE measures how efficiently a company uses your money. 15%+ is excellent.",
        debtToEquity: "This shows how much debt a company has compared to its value. Lower is safer.",
        rsi: "RSI measures if a stock is overbought (above 70) or oversold (below 30).",
        marketCap: "Market Cap is the total value of all the company's shares. Larger companies are usually more stable.",
        volume: "Volume shows how many shares were traded. Higher volume means more interest in the stock.",
        changePct: "This shows how much the stock price moved today. Green (positive) is up, red (negative) is down."
      },

      shouldShowBeginnerMode() {
        const user = UserManager.getCurrentUser();
        if (!user) return true;
        return user.preferences?.defaultView === 'beginner' ||
          user.investmentProfile?.experience === 'beginner';
      },

      getSimplifiedView(stock) {
        return this.SIMPLIFIED_METRICS.map(metric => ({
          ...metric,
          value: stock[metric.key],
          formattedValue: this.formatValue(stock[metric.key], metric.key)
        }));
      },

      formatValue(value, key) {
        if (value == null || isNaN(value)) return 'â€”';

        switch (key) {
          case 'price': return `$${value.toFixed(2)}`;
          case 'changePct': return `${value > 0 ? '+' : ''}${value.toFixed(2)}%`;
          case 'pe': return value.toFixed(1);
          case 'roe': return `${value.toFixed(1)}%`;
          case 'aiScore': return `${Math.round(value)}/100`;
          default: return value.toString();
        }
      },

      getExplanation(key) {
        return this.EXPLANATIONS[key] || 'No explanation available.';
      }
    };


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FINANCIAL GLOSSARY - Tooltips for key metrics
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const FINANCIAL_GLOSSARY = {
      'P/E': '<strong>Price-to-Earnings Ratio</strong><br>Shows how much investors pay for $1 of earnings.<br><em>Lower = potentially better value</em>',
      'ROE': '<strong>Return on Equity</strong><br>Measures how efficiently a company uses shareholder money.<br><em>15%+ is excellent</em>',
      'Market Cap': '<strong>Market Capitalization</strong><br>Total value of all company shares.<br><em>Large cap: $10B+, Mid: $2-10B, Small: <$2B</em>',
      'Revenue Growth': '<strong>Revenue Growth Rate</strong><br>Year-over-year sales increase.<br><em>10%+ is strong growth</em>',
      'Net Margin': '<strong>Net Profit Margin</strong><br>What % of revenue becomes profit.<br><em>20%+ is excellent</em>',
      'Debt/Equity': '<strong>Debt-to-Equity Ratio</strong><br>Company debt vs shareholder equity.<br><em>Lower = less financial risk</em>',
      'RSI': '<strong>Relative Strength Index</strong><br>Momentum indicator (0-100).<br><em>>70 = overbought, <30 = oversold</em>',
      'AI Score': '<strong>AI Composite Score</strong><br>Combines fundamentals, technicals & risk.<br><em>80+ = Strong Buy, 60-80 = Buy, 40-60 = Hold</em>',
      'Confidence': '<strong>AI Confidence Level</strong><br>How certain the AI is about its rating.<br><em>Higher = more reliable signal</em>',
      'Current Ratio': '<strong>Current Ratio</strong><br>Can the company pay short-term debts?<br><em>1.5+ = healthy liquidity</em>',
      'Gross Margin': '<strong>Gross Profit Margin</strong><br>Revenue minus cost of goods sold.<br><em>40%+ is strong</em>',
      'Dividend Yield': '<strong>Dividend Yield</strong><br>Annual dividend as % of stock price.<br><em>3-6% is attractive for income</em>'
    };


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DEMO MODE - Sample Stock Data
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const DEMO_STOCKS = [
      {
        symbol: 'AAPL', name: 'Apple Inc.', price: 182.45, changePct: 2.34,
        pe: 28.5, roe: 147.2, revenueGrowth: 16.3, grossMargin: 44.1,
        netMargin: 25.3, debtToEquity: 1.8, currentRatio: 1.0,
        marketCap: 2.85e12, volume: 52431000, rsi: 58,
        sector: 'Technology', index: 'S&P500'
      },
      {
        symbol: 'MSFT', name: 'Microsoft Corporation', price: 378.91, changePct: 1.87,
        pe: 34.2, roe: 38.4, revenueGrowth: 13.1, grossMargin: 69.8,
        netMargin: 34.1, debtToEquity: 0.4, currentRatio: 1.8,
        marketCap: 2.81e12, volume: 23456000, rsi: 62,
        sector: 'Technology', index: 'S&P500'
      },
      {
        symbol: 'GOOGL', name: 'Alphabet Inc.', price: 141.23, changePct: 1.45,
        pe: 24.8, roe: 25.1, revenueGrowth: 11.2, grossMargin: 56.9,
        netMargin: 23.7, debtToEquity: 0.1, currentRatio: 2.6,
        marketCap: 1.78e12, volume: 28901000, rsi: 54,
        sector: 'Technology', index: 'S&P500'
      },
      {
        symbol: 'NVDA', name: 'NVIDIA Corporation', price: 495.22, changePct: 3.12,
        pe: 72.1, roe: 74.3, revenueGrowth: 126.0, grossMargin: 72.4,
        netMargin: 48.9, debtToEquity: 0.3, currentRatio: 4.1,
        marketCap: 1.22e12, volume: 45678000, rsi: 68,
        sector: 'Technology', index: 'NASDAQ100'
      },
      {
        symbol: 'AMZN', name: 'Amazon.com Inc.', price: 151.94, changePct: 0.89,
        pe: 58.3, roe: 16.8, revenueGrowth: 10.8, grossMargin: 48.1,
        netMargin: 5.7, debtToEquity: 0.7, currentRatio: 1.0,
        marketCap: 1.57e12, volume: 39012000, rsi: 51,
        sector: 'Consumer', index: 'S&P500'
      },
      {
        symbol: 'TSLA', name: 'Tesla Inc.', price: 238.72, changePct: -1.23,
        pe: 62.4, roe: 22.4, revenueGrowth: 18.8, grossMargin: 18.2,
        netMargin: 14.5, debtToEquity: 0.1, currentRatio: 1.7,
        marketCap: 758e9, volume: 98234000, rsi: 45,
        sector: 'Consumer', index: 'NASDAQ100'
      },
      {
        symbol: 'META', name: 'Meta Platforms Inc.', price: 352.89, changePct: 2.67,
        pe: 26.1, roe: 30.2, revenueGrowth: 23.4, grossMargin: 81.5,
        netMargin: 29.1, debtToEquity: 0.0, currentRatio: 2.9,
        marketCap: 895e9, volume: 15678000, rsi: 65,
        sector: 'Technology', index: 'S&P500'
      },
      {
        symbol: 'BRK.B', name: 'Berkshire Hathaway', price: 383.45, changePct: 0.34,
        pe: 8.9, roe: 14.2, revenueGrowth: 8.1, grossMargin: 22.3,
        netMargin: 16.8, debtToEquity: 0.3, currentRatio: 1.4,
        marketCap: 878e9, volume: 3421000, rsi: 52,
        sector: 'Financials', index: 'S&P500'
      },
      {
        symbol: 'JPM', name: 'JPMorgan Chase', price: 155.67, changePct: 1.12,
        pe: 11.3, roe: 15.8, revenueGrowth: 9.4, grossMargin: 35.2,
        netMargin: 28.9, debtToEquity: 1.2, currentRatio: 1.1,
        marketCap: 456e9, volume: 8234000, rsi: 56,
        sector: 'Financials', index: 'S&P500'
      },
      {
        symbol: 'V', name: 'Visa Inc.', price: 267.43, changePct: 0.78,
        pe: 30.2, roe: 41.5, revenueGrowth: 11.3, grossMargin: 98.2,
        netMargin: 52.4, debtToEquity: 0.6, currentRatio: 1.4,
        marketCap: 548e9, volume: 5123000, rsi: 59,
        sector: 'Financials', index: 'S&P500'
      },
      {
        symbol: 'UNH', name: 'UnitedHealth Group', price: 524.89, changePct: 0.56,
        pe: 24.7, roe: 25.3, revenueGrowth: 14.2, grossMargin: 27.8,
        netMargin: 6.1, debtToEquity: 0.6, currentRatio: 0.8,
        marketCap: 489e9, volume: 2345000, rsi: 53,
        sector: 'Healthcare', index: 'S&P500'
      },
      {
        symbol: 'JNJ', name: 'Johnson & Johnson', price: 157.23, changePct: -0.23,
        pe: 15.8, roe: 22.1, revenueGrowth: 5.3, grossMargin: 68.4,
        netMargin: 16.7, debtToEquity: 0.5, currentRatio: 1.2,
        marketCap: 378e9, volume: 6789000, rsi: 48,
        sector: 'Healthcare', index: 'S&P500'
      },
      {
        symbol: 'XOM', name: 'Exxon Mobil', price: 103.45, changePct: -0.89,
        pe: 9.2, roe: 17.4, revenueGrowth: -2.1, grossMargin: 35.6,
        netMargin: 10.2, debtToEquity: 0.2, currentRatio: 1.3,
        marketCap: 421e9, volume: 18234000, rsi: 42,
        sector: 'Energy', index: 'S&P500'
      },
      {
        symbol: 'WMT', name: 'Walmart Inc.', price: 162.34, changePct: 0.45,
        pe: 28.4, roe: 18.9, revenueGrowth: 5.9, grossMargin: 24.8,
        netMargin: 2.4, debtToEquity: 0.7, currentRatio: 0.8,
        marketCap: 441e9, volume: 7123000, rsi: 55,
        sector: 'Consumer', index: 'S&P500'
      },
      {
        symbol: 'PG', name: 'Procter & Gamble', price: 152.89, changePct: 0.34,
        pe: 25.3, roe: 28.4, revenueGrowth: 4.2, grossMargin: 49.8,
        netMargin: 16.1, debtToEquity: 0.5, currentRatio: 0.6,
        marketCap: 362e9, volume: 5678000, rsi: 51,
        sector: 'Consumer', index: 'S&P500'
      },
      {
        symbol: 'HD', name: 'Home Depot', price: 342.56, changePct: 1.23,
        pe: 22.1, roe: 1247.3, revenueGrowth: 6.4, grossMargin: 33.6,
        netMargin: 10.9, debtToEquity: -8.2, currentRatio: 1.1,
        marketCap: 348e9, volume: 3456000, rsi: 58,
        sector: 'Consumer', index: 'S&P500'
      },
      {
        symbol: 'MA', name: 'Mastercard Inc.', price: 437.89, changePct: 0.89,
        pe: 35.6, roe: 148.2, revenueGrowth: 13.1, grossMargin: 100.0,
        netMargin: 45.3, debtToEquity: 2.1, currentRatio: 1.3,
        marketCap: 412e9, volume: 2891000, rsi: 60,
        sector: 'Financials', index: 'S&P500'
      },
      {
        symbol: 'DIS', name: 'Walt Disney Co.', price: 92.34, changePct: -0.56,
        pe: 42.1, roe: 3.2, revenueGrowth: -0.8, grossMargin: 34.2,
        netMargin: 2.9, debtToEquity: 0.5, currentRatio: 1.0,
        marketCap: 168e9, volume: 9234000, rsi: 44,
        sector: 'Consumer', index: 'S&P500'
      },
      {
        symbol: 'NFLX', name: 'Netflix Inc.', price: 447.12, changePct: 2.34,
        pe: 41.3, roe: 28.9, revenueGrowth: 9.2, grossMargin: 42.8,
        netMargin: 16.0, debtToEquity: 1.1, currentRatio: 1.2,
        marketCap: 192e9, volume: 4567000, rsi: 63,
        sector: 'Technology', index: 'NASDAQ100'
      },
      {
        symbol: 'COST', name: 'Costco Wholesale', price: 672.45, changePct: 0.67,
        pe: 47.2, roe: 29.4, revenueGrowth: 6.7, grossMargin: 11.0,
        netMargin: 2.6, debtToEquity: 0.4, currentRatio: 1.0,
        marketCap: 298e9, volume: 1789000, rsi: 57,
        sector: 'Consumer', index: 'S&P500'
      }
    ];


    // Process demo stocks with enhanced analysis
    const processedDemoStocks = DEMO_STOCKS.map(stock => {
      const analysis = computeEnhancedAnalysis(stock);
      return { ...stock, ...analysis };
    });


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // EDUCATION CENTER - Investing 101 & Learning Modules
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const EDUCATION_CENTER = {
      tutorials: [
        {
          id: 'what-is-stock',
          title: 'What is a Stock?',
          category: 'basics',
          duration: '5 min',
          icon: 'ğŸ“ˆ',
          content: {
            intro: 'A stock represents ownership in a company. When you buy a share, you own a small piece of that business.',
            keyPoints: [
              'Stocks give you partial ownership of a company',
              'Share prices go up and down based on company performance and investor sentiment',
              'You can make money through price appreciation or dividends',
              'Stocks are traded on exchanges like NYSE and NASDAQ'
            ],
            example: 'If Apple has 16 billion shares and you own 100 shares, you own 0.00000625% of Apple.',
            nextSteps: ['Learn about P/E Ratio', 'Understanding Market Cap', 'How to Read Stock Charts']
          }
        },
        {
          id: 'pe-ratio-explained',
          title: 'Understanding P/E Ratio',
          category: 'metrics',
          duration: '7 min',
          icon: 'ğŸ”¢',
          content: {
            intro: 'The Price-to-Earnings (P/E) ratio is one of the most important valuation metrics for stocks.',
            keyPoints: [
              'P/E = Stock Price Ã· Earnings Per Share',
              'Shows how much investors pay for each $1 of company earnings',
              'Lower P/E might indicate undervaluation',
              'Compare P/E ratios within the same industry',
              'Tech stocks typically have higher P/E ratios than utilities'
            ],
            example: 'If a stock costs $100 and earns $5 per share, its P/E is 20. You\'re paying $20 for every $1 of earnings.',
            whyItMatters: 'P/E helps you determine if a stock is overpriced or a good value compared to its earnings power.',
            practicalTip: 'A P/E under 15 is often considered undervalued, 15-25 is fair, and over 25 might be overvalued (but growth stocks are exceptions).',
            nextSteps: ['Learn ROE', 'Explore Debt-to-Equity', 'Master Market Cap']
          }
        },
        {
          id: 'roe-explained',
          title: 'Return on Equity (ROE)',
          category: 'metrics',
          duration: '6 min',
          icon: 'ğŸ’°',
          content: {
            intro: 'ROE measures how efficiently a company uses shareholder money to generate profits.',
            keyPoints: [
              'ROE = Net Income Ã· Shareholder Equity',
              'Shows profit generated from shareholder investments',
              '15%+ ROE is considered strong',
              '20%+ ROE is excellent',
              'Compare ROE within the same industry'
            ],
            example: 'If a company has $1 million equity and makes $200,000 profit, ROE is 20%. For every $1 invested, they generate $0.20 profit.',
            whyItMatters: 'ROE tells you if management is good at growing the business with your money.',
            practicalTip: 'Look for companies with consistently high ROE over several yearsâ€”it shows sustainable competitive advantage.',
            nextSteps: ['Understand ROIC', 'Learn Profit Margins', 'Study Buffett Strategy']
          }
        },
        {
          id: 'market-cap-sizes',
          title: 'Market Cap: Small, Mid, Large',
          category: 'basics',
          duration: '5 min',
          icon: 'ğŸ¢',
          content: {
            intro: 'Market capitalization (market cap) is the total value of all a company\'s shares.',
            keyPoints: [
              'Market Cap = Share Price Ã— Total Shares Outstanding',
              'Large Cap: $10 billion+ (stable, lower risk)',
              'Mid Cap: $2-10 billion (growth + stability)',
              'Small Cap: Under $2 billion (higher growth, higher risk)',
              'Mega Cap: $200 billion+ (Apple, Microsoft, etc.)'
            ],
            example: 'Apple with 16B shares at $180 = $2.88 trillion market cap (mega cap)',
            whyItMatters: 'Market cap indicates company size, risk level, and growth potential.',
            practicalTip: 'Beginners should focus on large caps for stability. Once comfortable, add mid and small caps for growth.',
            nextSteps: ['Portfolio Diversification', 'Risk Management', 'Asset Allocation']
          }
        },
        {
          id: 'reading-charts',
          title: 'How to Read Stock Charts',
          category: 'technical',
          duration: '10 min',
          icon: 'ğŸ“Š',
          content: {
            intro: 'Stock charts visualize price movements over time, helping you spot trends and patterns.',
            keyPoints: [
              'Candlesticks show Open, High, Low, Close prices',
              'Green/white candles = price went up, Red/black = down',
              'Support levels: price tends to bounce back up',
              'Resistance levels: price struggles to break through',
              'Volume bars show trading activity'
            ],
            example: 'If you see multiple bounces at $150, that\'s a support level. If price keeps hitting $175 but can\'t break through, that\'s resistance.',
            whyItMatters: 'Charts help you time your entry and exit points for better returns.',
            practicalTip: 'Start with simple trend lines. Uptrend = series of higher lows. Downtrend = series of lower highs.',
            nextSteps: ['RSI Indicator', 'Moving Averages', 'MACD Strategy']
          }
        },
        {
          id: 'rsi-indicator',
          title: 'RSI: Overbought or Oversold?',
          category: 'technical',
          duration: '8 min',
          icon: 'ğŸ“‰',
          content: {
            intro: 'The Relative Strength Index (RSI) measures momentum to identify overbought or oversold conditions.',
            keyPoints: [
              'RSI ranges from 0 to 100',
              'Above 70 = overbought (potential pullback coming)',
              'Below 30 = oversold (potential bounce coming)',
              'Best used with other indicators, not alone',
              '14-period RSI is the standard'
            ],
            example: 'If RSI hits 80, the stock may have risen too fast and could drop soon. If RSI is 25, it may have fallen too much and could bounce.',
            whyItMatters: 'RSI helps you avoid buying at peaks and identifies potential buying opportunities at dips.',
            practicalTip: 'Don\'t sell just because RSI is highâ€”strong trends can stay "overbought" for weeks. Use with trend analysis.',
            nextSteps: ['MACD Divergence', 'Bollinger Bands', 'Combine Indicators']
          }
        },
        {
          id: 'diversification',
          title: 'Portfolio Diversification 101',
          category: 'strategy',
          duration: '8 min',
          icon: 'ğŸ¯',
          content: {
            intro: 'Diversification means spreading your money across different investments to reduce risk.',
            keyPoints: [
              'Don\'t put all your eggs in one basket',
              'Diversify across sectors (tech, healthcare, finance, etc.)',
              'Mix large, mid, and small cap stocks',
              'Include different asset classes (stocks, bonds, real estate)',
              'International diversification reduces country-specific risk'
            ],
            example: 'Instead of putting $10,000 in one tech stock, spread it across 10 stocks in 5 different sectors.',
            whyItMatters: 'If one stock or sector crashes, you don\'t lose everything. Diversification smooths out returns.',
            practicalTip: 'Start with 8-15 stocks across different sectors. Too few = too risky. Too many = hard to track.',
            nextSteps: ['Asset Allocation', 'Sector Rotation', 'Rebalancing Strategy']
          }
        },
        {
          id: 'dollar-cost-averaging',
          title: 'Dollar-Cost Averaging Strategy',
          category: 'strategy',
          duration: '6 min',
          icon: 'ğŸ’µ',
          content: {
            intro: 'Dollar-cost averaging (DCA) means investing a fixed amount regularly, regardless of price.',
            keyPoints: [
              'Invest the same amount weekly/monthly',
              'Buy more shares when prices are low',
              'Buy fewer shares when prices are high',
              'Reduces impact of market volatility',
              'Removes emotion from investing decisions'
            ],
            example: 'Invest $500/month. When stock is $50, you buy 10 shares. When it drops to $25, you buy 20 shares. Your average cost is lower.',
            whyItMatters: 'DCA prevents you from investing everything at the peak and helps build wealth steadily.',
            practicalTip: 'Set up automatic monthly investments so you stick with it through market ups and downs.',
            nextSteps: ['Index Fund Investing', 'Long-term Wealth Building', 'Compound Growth']
          }
        }
      ],

      caseStudies: [
        {
          id: 'buffett-coca-cola',
          title: 'Warren Buffett & Coca-Cola',
          investor: 'Warren Buffett',
          year: '1988',
          icon: 'ğŸ¥¤',
          summary: 'How Buffett turned $1 billion into $25 billion by buying a simple, understandable business.',
          story: 'In 1988, Warren Buffett bought $1 billion worth of Coca-Cola stock when the market undervalued it during a temporary setback. He recognized Coke\'s powerful brand, global reach, and consistent earnings.',
          keyLessons: [
            'Invest in businesses you understand',
            'Look for strong brands with pricing power',
            'Buy quality companies when they\'re temporarily down',
            'Hold for the long term (35+ years and counting)',
            'Focus on business fundamentals, not market noise'
          ],
          metrics: {
            initialInvestment: '$1 billion',
            currentValue: '$25+ billion',
            annualReturn: '~10% per year',
            holdingPeriod: '35+ years'
          },
          takeaway: 'Simple businesses with strong competitive advantages can generate massive wealth if you\'re patient.'
        },
        {
          id: 'lynch-fidelity',
          title: 'Peter Lynch\'s 10-Baggers',
          investor: 'Peter Lynch',
          year: '1977-1990',
          icon: 'ğŸ¯',
          summary: 'How a retail investor mindset helped Lynch beat the market by finding everyday winners.',
          story: 'Peter Lynch ran Fidelity Magellan Fund and achieved 29% annual returns by investing in companies he encountered in daily lifeâ€”Dunkin\' Donuts, Hanes, Home Depot. He called these "10-baggers" (stocks that returned 10x).',
          keyLessons: [
            'Look for investment ideas in your daily life',
            'Do your homeworkâ€”understand what the company does',
            'Small companies can become big winners',
            'Visit stores, talk to customers, read annual reports',
            'You don\'t need Wall Street connections to find great stocks'
          ],
          metrics: {
            annualReturn: '29.2%',
            period: '13 years',
            $10kGrowth: '$280,000',
            famousWins: 'Taco Bell, Home Depot, Chrysler'
          },
          takeaway: 'Retail investors have an edgeâ€”you can discover great companies before Wall Street does.'
        },
        {
          id: 'oneil-canslim',
          title: 'William O\'Neil\'s CANSLIM',
          investor: 'William O\'Neil',
          year: '1960s+',
          icon: 'ğŸš€',
          summary: 'A systematic approach to finding growth stocks before they skyrocket.',
          story: 'William O\'Neil studied the best-performing stocks from 1953-1993 and found patterns. He created CANSLIMâ€”a checklist for identifying winning stocks. His system helped countless retail investors.',
          keyLessons: [
            'C: Current quarterly earnings up 25%+',
            'A: Annual earnings growth consistent',
            'N: New products, management, or highs',
            'S: Supply & Demandâ€”low float stocks move more',
            'L: Leader in industry, not laggard',
            'I: Institutional sponsorship present',
            'M: Market direction is upward'
          ],
          metrics: {
            avgWinner: '+100-300%',
            timeframe: '3-12 months',
            successRate: '~33% (1 in 3 big winners)',
            strategy: 'Growth stocks with momentum'
          },
          takeaway: 'Follow a proven system. Cut losses quickly at -7%, let winners run.'
        },
        {
          id: 'reit-income',
          title: 'Building Income with REITs',
          investor: 'Retail Investor Case',
          year: '2010-2025',
          icon: 'ğŸ˜ï¸',
          summary: 'How a teacher built $500/month passive income with real estate stocks.',
          story: 'A school teacher invested $50,000 into diversified REITs (Real Estate Investment Trusts) yielding 5-8% dividends. After 15 years, between dividends and growth, her portfolio generates $500+/month in passive income.',
          keyLessons: [
            'REITs must pay 90% of income as dividends',
            'Diversify across property types (retail, office, residential)',
            'Reinvest dividends in early years for compound growth',
            'REITs provide real estate exposure without property management',
            'Focus on quality REITs with strong balance sheets'
          ],
          metrics: {
            initialInvestment: '$50,000',
            monthlyIncome: '$500+',
            totalValue: '$125,000',
            averageYield: '6%',
            period: '15 years'
          },
          takeaway: 'Dividend-paying stocks can create reliable passive income streams over time.'
        }
      ],

      getProgress(userId) {
        const key = `re_education_progress_${userId || 'guest'}`;
        const stored = localStorage.getItem(key);
        return stored ? JSON.parse(stored) : { completed: [], inProgress: [] };
      },

      markComplete(userId, tutorialId) {
        const progress = this.getProgress(userId);
        if (!progress.completed.includes(tutorialId)) {
          progress.completed.push(tutorialId);
          progress.inProgress = progress.inProgress.filter(id => id !== tutorialId);
          localStorage.setItem(`re_education_progress_${userId || 'guest'}`, JSON.stringify(progress));
        }
      },

      markInProgress(userId, tutorialId) {
        const progress = this.getProgress(userId);
        if (!progress.completed.includes(tutorialId) && !progress.inProgress.includes(tutorialId)) {
          progress.inProgress.push(tutorialId);
          localStorage.setItem(`re_education_progress_${userId || 'guest'}`, JSON.stringify(progress));
        }
      },

      getCompletionRate(userId) {
        const progress = this.getProgress(userId);
        return Math.round((progress.completed.length / this.tutorials.length) * 100);
      },

      getTutorialsByCategory(category) {
        return this.tutorials.filter(t => t.category === category);
      },

      getNextTutorial(userId) {
        const progress = this.getProgress(userId);
        return this.tutorials.find(t =>
          !progress.completed.includes(t.id) &&
          !progress.inProgress.includes(t.id)
        );
      }
    };


    // Demo mode state
    let isDemoMode = false;

    // INVESTMENT STYLES
    const INVESTMENT_STYLES = {
      growth: {
        name: 'Growth', emoji: 'ğŸš€', description: 'High growth tech & innovation',
        symbols: ['NVDA', 'SMCI', 'ARM', 'SNOW', 'TTD', 'UBER', 'SQ', 'SHOP', 'NET', 'DDOG']
      },
      value: {
        name: 'Value', emoji: 'ğŸ’°', description: 'Undervalued stable businesses',
        symbols: ['BRK.B', 'JNJ', 'MMM', 'VZ', 'T', 'KO', 'PG', 'WMT', 'CVX', 'XOM']
      },
      momentum: {
        name: 'Momentum', emoji: 'âš¡', description: 'Strong price trends',
        symbols: ['TSLA', 'META', 'AMD', 'MU', 'COIN', 'MARA', 'PLTR', 'HOOD']
      },
      quality: {
        name: 'Quality', emoji: 'â­', description: 'Excellent businesses',
        symbols: ['MSFT', 'AAPL', 'GOOGL', 'COST', 'HD', 'ADBE', 'INTU', 'MA', 'V']
      },
      dividend: {
        name: 'Dividend', emoji: 'ğŸ’µ', description: 'Reliable income',
        symbols: ['VZ', 'T', 'KO', 'PG', 'MMM', 'JNJ', 'XOM', 'CVX', 'MO', 'ABBV']
      }
    };


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ENHANCED AI ANALYSIS - Tier 1 Features
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function computeEnhancedAnalysis(stock) {
      // Calculate subscores
      const fundamentalScore = calculateFundamentalScore(stock);
      const technicalScore = calculateTechnicalScore(stock);
      const riskScore = calculateRiskScore(stock);

      const aiScore = Math.round((fundamentalScore * 0.5) + (technicalScore * 0.3) + (riskScore * 0.2));
      const verdict = getVerdict(aiScore);
      const confidence = calculateConfidence(stock);

      // Generate factor analysis (Bulls vs Bears)
      const factors = generateFactorAnalysis(stock);

      // Generate AI takeaway
      const takeaway = generateTakeaway(stock, verdict, factors);

      // Generate watchlist guidance
      const watchlistGuidance = generateWatchlistGuidance(stock, factors);

      return {
        aiScore,
        verdict,
        confidence,
        subscores: {
          fundamental: Math.round(fundamentalScore),
          technical: Math.round(technicalScore),
          risk: Math.round(riskScore)
        },
        topDrivers: {
          positive: factors.bullish,
          negative: factors.bearish
        },
        takeaway,
        watchlistGuidance,
        reassurance: "Remember: this is a data-driven assessment. Always do your own research and consider your risk tolerance before investing."
      };
    }

    function calculateFundamentalScore(stock) {
      let score = 50;

      // Get sector-specific benchmarks
      const benchmarks = getSectorBenchmarks(stock.sector);

      // === SECTOR-AWARE ROE SCORING ===
      if (stock.roe !== undefined && stock.roe !== null) {
        if (stock.roe > benchmarks.roe_excellent) {
          score += 15; // Exceptional profitability
        } else if (stock.roe > benchmarks.roe_target) {
          score += 10; // Strong profitability
        } else if (stock.roe > benchmarks.roe_target * 0.5) {
          score += 5; // Acceptable
        } else if (stock.roe < 0) {
          score -= 15; // Unprofitable
        } else {
          score -= 5; // Below sector standards
        }
      }

      // === SECTOR-AWARE P/E SCORING ===
      if (stock.pe > 0) {
        if (stock.pe < benchmarks.pe_base * 0.7) {
          score += 15; // Significantly undervalued
        } else if (stock.pe < benchmarks.pe_base) {
          score += 10; // Undervalued
        } else if (stock.pe < benchmarks.pe_acceptable) {
          score += 5; // Fairly valued
        } else if (stock.pe < benchmarks.pe_acceptable * 1.3) {
          score -= 5; // Slightly overvalued
        } else {
          score -= 10; // Significantly overvalued
        }
      }

      // === SECTOR-AWARE GROWTH SCORING ===
      if (stock.revenueGrowth !== undefined && stock.revenueGrowth !== null) {
        if (stock.revenueGrowth > benchmarks.growth_excellent) {
          score += 15; // Exceptional growth
        } else if (stock.revenueGrowth > benchmarks.growth_target) {
          score += 10; // Strong growth
        } else if (stock.revenueGrowth > benchmarks.growth_target * 0.5) {
          score += 5; // Moderate growth
        } else if (stock.revenueGrowth < -10) {
          score -= 15; // Significant decline
        } else if (stock.revenueGrowth < 0) {
          score -= 10; // Declining
        }
      }

      // === SECTOR-AWARE MARGIN SCORING ===
      if (stock.grossMargin !== undefined && stock.grossMargin !== null) {
        if (stock.grossMargin > benchmarks.margin_target * 1.5) {
          score += 12; // Exceptional margins
        } else if (stock.grossMargin > benchmarks.margin_target) {
          score += 8; // Strong margins
        } else if (stock.grossMargin > benchmarks.margin_target * 0.7) {
          score += 4; // Acceptable margins
        }
      }

      // Net margin bonus
      if (stock.netMargin !== undefined && stock.netMargin !== null) {
        if (stock.netMargin > 20) score += 5;
        else if (stock.netMargin < 0) score -= 5;
      }

      return Math.max(0, Math.min(100, score));
    }

    function calculateTechnicalScore(stock) {
      let score = 50;

      // RSI
      if (stock.rsi >= 30 && stock.rsi <= 70) score += 15;
      else if (stock.rsi > 70) score -= 10;
      else if (stock.rsi < 30) score += 5; // oversold can be opportunity

      // Price momentum
      if (stock.changePct > 5) score += 10;
      else if (stock.changePct > 0) score += 5;
      else if (stock.changePct < -5) score -= 10;

      return Math.max(0, Math.min(100, score));
    }

    function calculateRiskScore(stock) {
      let score = 50;

      // Debt/Equity
      if (stock.debtToEquity < 0.5) score += 20;
      else if (stock.debtToEquity < 1) score += 10;
      else if (stock.debtToEquity > 2) score -= 20;

      // Current ratio
      if (stock.currentRatio > 2) score += 15;
      else if (stock.currentRatio > 1.5) score += 10;
      else if (stock.currentRatio < 1) score -= 15;

      return Math.max(0, Math.min(100, score));
    }

    function getVerdict(score) {
      if (score >= 80) return "STRONG BUY";
      if (score >= 65) return "BUY";
      if (score >= 45) return "HOLD";
      if (score >= 30) return "REDUCE";
      return "SELL";
    }

    function calculateConfidence(stock) {
      let confidence = 50;

      // More data points = higher confidence
      const hasData = [
        stock.pe, stock.roe, stock.revenueGrowth,
        stock.grossMargin, stock.debtToEquity,
        stock.currentRatio, stock.rsi
      ].filter(v => v != null && !isNaN(v)).length;

      confidence += (hasData * 5);

      return Math.min(95, Math.max(30, confidence));
    }

    function generateFactorAnalysis(stock) {
      const bullish = [];
      const bearish = [];

      // ROE analysis
      if (stock.roe > 20) {
        bullish.push({
          factor: "Exceptional ROE",
          detail: `${stock.roe?.toFixed(1)}% ROE indicates strong profitability and efficient capital use`
        });
      } else if (stock.roe > 15) {
        bullish.push({
          factor: "Strong ROE",
          detail: `${stock.roe?.toFixed(1)}% ROE shows solid return on equity`
        });
      } else if (stock.roe < 10) {
        bearish.push({
          factor: "Low ROE",
          detail: `${stock.roe?.toFixed(1)}% ROE is below industry standards`
        });
      }

      // Growth analysis
      if (stock.revenueGrowth > 20) {
        bullish.push({
          factor: "High Growth",
          detail: `Revenue growing at ${stock.revenueGrowth?.toFixed(1)}% YoY shows strong demand`
        });
      } else if (stock.revenueGrowth < 0) {
        bearish.push({
          factor: "Revenue Decline",
          detail: `Revenue down ${Math.abs(stock.revenueGrowth)?.toFixed(1)}% YoY raises concerns`
        });
      }

      // Valuation analysis
      if (stock.pe > 0 && stock.pe < 15) {
        bullish.push({
          factor: "Attractive Valuation",
          detail: `P/E of ${stock.pe?.toFixed(1)} suggests stock may be undervalued`
        });
      } else if (stock.pe > 30) {
        bearish.push({
          factor: "High Valuation",
          detail: `P/E of ${stock.pe?.toFixed(1)} indicates premium pricing vs sector average`
        });
      }

      // Debt analysis
      if (stock.debtToEquity < 0.5) {
        bullish.push({
          factor: "Low Debt",
          detail: `Debt/Equity of ${stock.debtToEquity?.toFixed(2)} shows conservative balance sheet`
        });
      } else if (stock.debtToEquity > 1.5) {
        bearish.push({
          factor: "High Leverage",
          detail: `Debt/Equity of ${stock.debtToEquity?.toFixed(2)} indicates elevated financial risk`
        });
      }

      // Momentum analysis
      if (stock.changePct > 5) {
        bullish.push({
          factor: "Strong Momentum",
          detail: `Price up ${stock.changePct?.toFixed(1)}% shows positive market sentiment`
        });
      } else if (stock.changePct < -5) {
        bearish.push({
          factor: "Negative Momentum",
          detail: `Price down ${Math.abs(stock.changePct)?.toFixed(1)}% indicates selling pressure`
        });
      }

      // RSI analysis
      if (stock.rsi < 30) {
        bullish.push({
          factor: "Oversold Condition",
          detail: `RSI of ${stock.rsi?.toFixed(0)} suggests potential buying opportunity`
        });
      } else if (stock.rsi > 70) {
        bearish.push({
          factor: "Overbought",
          detail: `RSI of ${stock.rsi?.toFixed(0)} warns of potential pullback`
        });
      }

      // Ensure we always have at least some factors
      if (bullish.length === 0) {
        bullish.push({
          factor: "Stable Metrics",
          detail: "Core financials appear stable with no major red flags"
        });
      }
      if (bearish.length === 0) {
        bearish.push({
          factor: "Market Volatility",
          detail: "General market conditions warrant monitoring"
        });
      }

      return { bullish: bullish.slice(0, 3), bearish: bearish.slice(0, 3) };
    }

    function generateTakeaway(stock, verdict, factors) {
      const symbol = stock.symbol;

      if (verdict === "STRONG BUY" || verdict === "BUY") {
        return `Overall, ${symbol} presents a compelling opportunity. The combination of ${factors.bullish[0]?.factor.toLowerCase() || 'strong fundamentals'} and positive momentum suggests this could be a solid addition to a growth-focused portfolio. While ${factors.bearish[0]?.factor.toLowerCase() || 'some risks exist'}, the bullish factors currently outweigh concerns.`;
      } else if (verdict === "HOLD") {
        return `${symbol} shows mixed signals. While ${factors.bullish[0]?.factor.toLowerCase() || 'some positives exist'}, concerns around ${factors.bearish[0]?.factor.toLowerCase() || 'valuation'} suggest a wait-and-see approach. Consider this a watchlist candidate while monitoring for better entry points or improving fundamentals.`;
      } else {
        return `${symbol} faces headwinds that warrant caution. Key concerns include ${factors.bearish[0]?.factor.toLowerCase() || 'valuation pressure'} and ${factors.bearish[1]?.factor.toLowerCase() || 'weakening fundamentals'}. Unless you have strong conviction in a turnaround thesis, consider reducing exposure or avoiding new positions at current levels.`;
      }
    }

    function generateWatchlistGuidance(stock, factors) {
      const topBearish = factors.bearish[0]?.factor || "earnings surprises";
      const keyMetric = stock.roe > stock.revenueGrowth ? "ROE and profit margins" : "revenue growth and market share";

      return {
        headline: "What to Watch Next",
        items: [
          {
            label: "Next check-in",
            value: "Review after the next earnings cycle (typically quarterly)"
          },
          {
            label: "Key metric to monitor",
            value: keyMetric
          },
          {
            label: "Main risk to watch",
            value: topBearish
          }
        ]
      };
    }


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TIER 2: PORTFOLIO SECTOR ALLOCATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function computePortfolioAllocation(stocks, watchlist) {
      if (!watchlist || watchlist.length === 0) {
        return { stocks: [], sectorWeights: {}, isEmpty: true };
      }

      const watchlistedStocks = stocks.filter(s => watchlist && Array.isArray(watchlist) && watchlist.some(w => w && w.toUpperCase() === s.symbol.toUpperCase()));

      if (watchlistedStocks.length === 0) {
        return { stocks: [], sectorWeights: {}, isEmpty: true };
      }

      // Equal weight allocation
      const weight = 100 / watchlistedStocks.length;

      const allocation = watchlistedStocks.map(s => ({
        symbol: s.symbol,
        name: s.name || s.symbol,
        sector: s.sector || 'Other',
        weight: weight,
        price: s.price,
        aiScore: s.aiScore,
        verdict: s.verdict
      }));

      // Calculate sector weights
      const sectorWeights = {};
      allocation.forEach(a => {
        sectorWeights[a.sector] = (sectorWeights[a.sector] || 0) + a.weight;
      });

      return {
        stocks: allocation,
        sectorWeights,
        isEmpty: false,
        totalStocks: watchlistedStocks.length,
        sectorCount: Object.keys(sectorWeights).length
      };
    }

    function getSectorColor(sector) {
      const colors = {
        'Technology': 'from-cyan-500 to-blue-500',
        'Healthcare': 'from-green-500 to-emerald-500',
        'Financials': 'from-yellow-500 to-orange-500',
        'Consumer': 'from-purple-500 to-pink-500',
        'Energy': 'from-red-500 to-orange-500',
        'Industrials': 'from-gray-500 to-slate-500',
        'Materials': 'from-amber-500 to-yellow-500',
        'Utilities': 'from-blue-500 to-cyan-500',
        'Real Estate': 'from-indigo-500 to-purple-500',
        'Communication': 'from-pink-500 to-rose-500',
        'Other': 'from-slate-500 to-gray-500'
      };
      return colors[sector] || colors['Other'];
    }


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ML MODELS: Advanced Analytics
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const MLModels = {
      optimizePortfolio(positions, riskFreeRate = 0.02) {
        try {
          if (!positions || positions.length === 0) throw new Error('No positions provided');
          const n = positions.length;
          const returns = positions.map(pos => pos.expectedReturn || 0.08);
          const volatilities = positions.map(pos => pos.volatility || 0.15);
          const correlation = 0.3; // Simplified correlation assumption

          // Build covariance matrix
          const covarianceMatrix = Array(n).fill().map((_, i) =>
            Array(n).fill().map((_, j) => {
              if (i === j) return Math.pow(volatilities[i], 2);
              return correlation * volatilities[i] * volatilities[j];
            })
          );

          // Monte Carlo simulation - generate 1000 random portfolios
          const portfolios = [];
          const numPortfolios = 1000;

          for (let p = 0; p < numPortfolios; p++) {
            // Generate random weights
            let weights = Array.from({ length: n }, () => Math.random());
            const sum = weights.reduce((a, b) => a + b, 0);
            weights = weights.map(w => w / sum); // Normalize to sum to 1

            // Calculate portfolio return
            const portfolioReturn = weights.reduce((sum, w, i) => sum + w * returns[i], 0);

            // Calculate portfolio variance
            let portfolioVariance = 0;
            for (let i = 0; i < n; i++) {
              for (let j = 0; j < n; j++) {
                portfolioVariance += weights[i] * weights[j] * covarianceMatrix[i][j];
              }
            }
            const portfolioVolatility = Math.sqrt(portfolioVariance);

            // Calculate Sharpe Ratio
            const sharpeRatio = (portfolioReturn - riskFreeRate) / portfolioVolatility;

            portfolios.push({
              weights,
              return: portfolioReturn,
              volatility: portfolioVolatility,
              sharpeRatio
            });
          }

          // Find optimal portfolios
          const maxSharpe = portfolios.reduce((best, current) =>
            current.sharpeRatio > best.sharpeRatio ? current : best
          );
          const minVolatility = portfolios.reduce((best, current) =>
            current.volatility < best.volatility ? current : best
          );

          // Get efficient frontier (subset of portfolios)
          const efficientFrontier = [...portfolios]
            .sort((a, b) => a.volatility - b.volatility)
            .filter((p, i) => i % 10 === 0)
            .slice(0, 20);

          return {
            maxSharpePortfolio: {
              ...maxSharpe,
              weights: maxSharpe.weights.map((w, i) => ({
                symbol: positions[i].symbol,
                weight: w * 100,
                contribution: w * returns[i]
              }))
            },
            minVolatilityPortfolio: {
              ...minVolatility,
              weights: minVolatility.weights.map((w, i) => ({
                symbol: positions[i].symbol,
                weight: w * 100,
                contribution: w * returns[i]
              }))
            },
            efficientFrontier,
            individualMetrics: positions.map((pos, i) => ({
              symbol: pos.symbol,
              expectedReturn: returns[i],
              volatility: volatilities[i],
              sharpeRatio: (returns[i] - riskFreeRate) / volatilities[i]
            }))
          };
        } catch (error) {
          console.error('Portfolio optimization error:', error);
          throw error;
        }
      }
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // RETAIL INVESTOR FEATURES: SLEEP-WELL SCORE & CRASH SIMULATOR
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Calculate "Sleep-Well" score - measures portfolio comfort/volatility risk
    function calcSleepWellScore(stock) {
      const vol = stock.beta ? Math.abs((stock.beta - 1) * 30) : 25; // Estimate volatility from beta
      const maxDD = stock.changePct ? Math.abs(Math.min(0, stock.changePct)) * 3 : 30; // Rough drawdown estimate
      const de = stock.debtToEquity || 0.5;
      const rsi = stock.rsi || 50;

      let score = 100;

      // Volatility penalty
      if (vol > 35) score -= 20;
      else if (vol > 25) score -= 10;

      // Drawdown penalty
      if (maxDD > 40) score -= 25;
      else if (maxDD > 25) score -= 15;

      // Debt penalty
      if (de > 1) score -= 20;
      else if (de > 0.5) score -= 10;

      // RSI extremes penalty
      if (rsi > 70 || rsi < 30) score -= 10;

      return Math.max(0, Math.round(score));
    }

    // Market crash scenarios
    const CRASH_SCENARIOS = {
      '2008 Financial Crisis': { drop: -57, weeks: 78, name: '2008' },
      '2020 COVID Crash': { drop: -34, weeks: 5, name: '2020' },
      '2000 Dot-com Bust': { drop: -49, weeks: 63, name: '2000' },
      '1987 Black Monday': { drop: -34, weeks: 1, name: '1987' },
    };

    function simulateMarketCrash(portfolioHoldings, scenarioKey) {
      const scenario = CRASH_SCENARIOS[scenarioKey];
      if (!scenario) return null;

      const totalValue = portfolioHoldings.reduce((sum, h) => sum + h.currentValue, 0);
      const lossUsd = totalValue * Math.abs(scenario.drop) / 100;
      const lossPct = Math.abs(scenario.drop);
      const perWeek = lossUsd / scenario.weeks;
      const finalValue = totalValue - lossUsd;

      return {
        scenarioName: scenarioKey,
        totalValue,
        lossUsd,
        lossPct,
        weeks: scenario.weeks,
        perWeek,
        finalValue,
        percentRemaining: 100 - lossPct
      };
    }

    // TIER 3: ML PRICE PREDICTION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Request queue for ML predictions to avoid rate limits
    let mlPredictionQueue = [];
    let mlPredictionProcessing = false;
    const ML_PREDICTION_DELAY = 500; // 500ms delay between ML prediction requests

    async function processMLPredictionQueue() {
      if (mlPredictionProcessing || mlPredictionQueue.length === 0) return;
      mlPredictionProcessing = true;

      while (mlPredictionQueue.length > 0) {
        const { symbol, resolve, reject } = mlPredictionQueue.shift();
        try {
          const result = await computeMLPredictionInternal(symbol);
          resolve(result);
        } catch (error) {
          reject(error);
        }
        // Delay between requests to avoid rate limits
        if (mlPredictionQueue.length > 0) {
          await new Promise(r => setTimeout(r, ML_PREDICTION_DELAY));
        }
      }

      mlPredictionProcessing = false;
    }

    async function computeMLPrediction(symbol) {
      return new Promise((resolve, reject) => {
        mlPredictionQueue.push({ symbol, resolve, reject });
        processMLPredictionQueue();
      });
    }

    async function computeMLPredictionInternal(symbol) {
      try {
        console.log(`ğŸ¤– Computing ML prediction for ${symbol}...`);

        // Fetch 60 days of historical data using stable endpoint with rate limit handling
        const url = `https://financialmodelingprep.com/stable/historical-price-eod/full?symbol=${symbol}&apikey=${FMP_API_KEY}`;

        // Use fetchWithRetry with better retry logic for rate limits
        const resp = await fetchWithRetry(url, {
          timeoutMs: 20000,
          retries: 3,
          retryDelayMs: 2000, // 2 second delay on retry
          shouldRetry: ({ response, error }) => {
            if (error) return true;
            if (!response) return true;
            // Retry on 429 (rate limit) and 5xx errors
            if (response.status === 429) return true;
            if (response.status >= 500) return true;
            return false;
          }
        });

        if (!resp || !resp.ok) {
          // 403 means premium endpoint not accessible - silently skip ML predictions
          if (resp?.status === 403) {
            console.log(`âš ï¸ ML predictions require FMP premium subscription (skipping for ${symbol})`);
          } else if (resp?.status === 429) {
            console.warn(`â³ ML prediction rate limited for ${symbol} - skipping`);
          } else {
            console.warn(`ML prediction fetch failed for ${symbol} - Status: ${resp?.status || 'unknown'}`);
          }
          return { predPct: null, conf: null, trend: null };
        }

        const data = await resp.json();

        // Stable endpoint returns array directly
        const historical = Array.isArray(data) ? data.slice(0, 60) : [];

        // Add delay after successful request to avoid rate limits
        await new Promise(r => setTimeout(r, 300));

        console.log(`   ğŸ“Š Got ${historical.length} historical data points for ${symbol}`);
        if (historical.length > 0) {
          console.log(`   ğŸ“… Sample data point:`, historical[0]);
        }

        if (historical.length < 60) {
          console.warn(`Insufficient historical data for ${symbol} (need 60 days, got ${historical.length})`);
          return { predPct: null, conf: null, trend: null };
        }

        // Get last 60 days of closing prices (reverse to chronological order)
        const prices = historical.slice(0, 60).reverse().map(d => d.close);
        console.log(`   ğŸ’° Extracted prices for ${symbol}: [${prices.slice(0, 5).join(', ')}...]`);
        console.log(`   ğŸ“ Current price: ${prices[prices.length - 1]}`);
        const current = prices[prices.length - 1];

        // Create simple linear regression model using TensorFlow.js
        console.log(`   ğŸ§  Creating tensors for ${symbol}...`);
        // Create 2D tensors for training (reshape to [60, 1])
        const xs = tf.tensor2d(Array.from({ length: 60 }, (_, i) => [i]));
        const ys = tf.tensor2d(prices.map(p => [p]));

        const model = tf.sequential();
        model.add(tf.layers.dense({ units: 1, inputShape: [1] }));
        model.compile({
          optimizer: tf.train.adam(0.1),
          loss: 'meanSquaredError'
        });

        console.log(`   ğŸ“ Training model for ${symbol}...`);
        // Train the model (100 epochs with Adam optimizer)
        const history = await model.fit(xs, ys, {
          epochs: 100,
          verbose: 0,
          shuffle: false
        });

        console.log(`   âœ“ Training complete, final loss: ${history.history.loss[history.history.loss.length - 1]}`);

        // Predict the next day (day 60)
        console.log(`   ğŸ”® Predicting for ${symbol}...`);
        const prediction = model.predict(tf.tensor2d([[60]]));
        const predictedPrice = prediction.dataSync()[0];
        console.log(`   ğŸ’ Predicted price: ${predictedPrice}, Current: ${current}`);

        // Calculate percentage change
        const predPct = ((predictedPrice - current) / current) * 100;
        console.log(`   ğŸ“ˆ Percentage change: ${predPct}%`);

        // Estimate confidence (heuristic: smaller predictions = higher confidence)
        // Confidence decreases as prediction magnitude increases
        const rawConf = 100 - Math.abs(predPct) * 1.5;
        const conf = Math.round(Math.max(10, Math.min(90, rawConf)));

        // Determine trend
        const trend = predPct > 2 ? 'bullish' : predPct < -2 ? 'bearish' : 'neutral';

        // Generate interpretation
        let interpretation = '';
        const absPct = Math.abs(predPct);

        if (predPct > 10) {
          interpretation = `Strong upward trend predicted. Model suggests ${absPct.toFixed(1)}% potential gain based on recent price momentum.`;
        } else if (predPct > 5) {
          interpretation = `Moderate bullish signal. Technical analysis indicates ${absPct.toFixed(1)}% upside potential.`;
        } else if (predPct > 2) {
          interpretation = `Slight positive movement expected. Model forecasts ${absPct.toFixed(1)}% modest gain.`;
        } else if (predPct > -2) {
          interpretation = `Neutral forecast. Price expected to remain relatively stable with minimal movement (${Math.abs(predPct).toFixed(1)}%).`;
        } else if (predPct > -5) {
          interpretation = `Slight bearish trend. Model suggests ${absPct.toFixed(1)}% potential decline.`;
        } else if (predPct > -10) {
          interpretation = `Moderate downward pressure. Technical indicators point to ${absPct.toFixed(1)}% downside risk.`;
        } else {
          interpretation = `Strong bearish signal. Model predicts ${absPct.toFixed(1)}% potential loss based on recent trends.`;
        }

        // Add confidence context
        if (conf > 70) {
          interpretation += ` High confidence (${conf}%).`;
        } else if (conf > 50) {
          interpretation += ` Moderate confidence (${conf}%).`;
        } else {
          interpretation += ` Low confidence (${conf}%) - use caution.`;
        }

        // Cleanup tensors to prevent memory leaks
        xs.dispose();
        ys.dispose();
        prediction.dispose();

        console.log(`âœ“ ML prediction for ${symbol}: ${predPct.toFixed(1)}% (conf: ${conf}%)`);

        return {
          predPct: parseFloat(predPct.toFixed(1)),
          conf,
          trend,
          predictedPrice: parseFloat(predictedPrice.toFixed(2)),
          interpretation
        };

      } catch (error) {
        console.error(`ML prediction error for ${symbol}:`, error);
        return { predPct: null, conf: null, trend: null };
      }


      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ENHANCED ML PREDICTION (V2.0) - Uses RSI, Volume, and Price History
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

      async function computeAdvancedMLPrediction(priceHistory, currentRsi, currentVolume) {
        try {
          if (!priceHistory || priceHistory.length < 20) {
            console.warn('âš ï¸  Insufficient price history for advanced ML');
            return null;
          }

          const prices = priceHistory.map(d => d.close);
          const volumes = priceHistory.map(d => d.volume || currentVolume);
          const rsiValues = priceHistory.map((d, i) => currentRsi + (Math.random() - 0.5) * 10); // Simulated RSI history

          // Prepare training data: [price, rsi, volume] -> next_price
          const features = [];
          const labels = [];

          for (let i = 0; i < prices.length - 1; i++) {
            features.push([
              prices[i],
              rsiValues[i],
              volumes[i] / 1000000  // Normalize volume
            ]);
            labels.push(prices[i + 1]);
          }

          // Create tensors
          const xs = tf.tensor2d(features);
          const ys = tf.tensor2d(labels, [labels.length, 1]);

          // Build enhanced model
          const model = tf.sequential();
          model.add(tf.layers.dense({
            units: 16,
            activation: 'relu',
            inputShape: [3]
          }));
          model.add(tf.layers.dropout({ rate: 0.2 }));
          model.add(tf.layers.dense({
            units: 8,
            activation: 'relu'
          }));
          model.add(tf.layers.dense({
            units: 1
          }));

          // Compile model
          model.compile({
            optimizer: tf.train.adam(0.01),
            loss: 'meanSquaredError',
            metrics: ['mae']
          });

          // Train model
          await model.fit(xs, ys, {
            epochs: 50,
            verbose: 0,
            shuffle: true,
            validationSplit: 0.1
          });

          // Make prediction for next price
          const lastInput = tf.tensor2d([[
            prices[prices.length - 1],
            currentRsi,
            currentVolume / 1000000
          ]]);

          const prediction = model.predict(lastInput);
          const predictedPrice = prediction.dataSync()[0];

          // Calculate confidence based on recent volatility
          const recentPrices = prices.slice(-10);
          const volatility = calculateVolatility(recentPrices);
          const confidence = Math.max(0, Math.min(100, 100 - (volatility * 2)));

          // Cleanup tensors
          xs.dispose();
          ys.dispose();
          lastInput.dispose();
          prediction.dispose();
          model.dispose();

          console.log(`âœ… Advanced ML prediction: $${predictedPrice.toFixed(2)} (confidence: ${confidence.toFixed(0)}%)`);

          return {
            predictedPrice: predictedPrice,
            confidence: confidence,
            method: 'enhanced_ml'
          };

        } catch (error) {
          console.error('âŒ Advanced ML prediction error:', error);
          return null;
        }
      }

      // Helper: Calculate volatility
      function calculateVolatility(prices) {
        if (prices.length < 2) return 0;
        const returns = [];
        for (let i = 1; i < prices.length; i++) {
          returns.push((prices[i] - prices[i - 1]) / prices[i - 1]);
        }
        const mean = returns.reduce((a, b) => a + b, 0) / returns.length;
        const variance = returns.reduce((sum, r) => sum + Math.pow(r - mean, 2), 0) / returns.length;
        return Math.sqrt(variance) * 100;
      }
    }

    function formatMLPrediction(pred) {
      if (pred == null || isNaN(pred)) return 'â€”';
      const sign = pred > 0 ? '+' : '';
      return `${sign}${pred.toFixed(1)}%`;
    }


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TIER 3: PDF EXPORT / TEAR SHEET
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function exportStockTearSheet(stock) {
      try {
        console.log(`ğŸ“„ Generating PDF tear sheet for ${stock.symbol}...`);

        // Get the modal content element
        const element = document.getElementById('stock-modal-content');
        if (!element) {
          console.error('Stock modal content not found');
          return;
        }

        // Show loading indicator
        const originalContent = element.innerHTML;
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
        loadingDiv.innerHTML = '<div class="text-white text-lg"><i class="fas fa-spinner animate-spin mr-2"></i>Generating PDF...</div>';
        element.appendChild(loadingDiv);

        // Wait a moment for rendering
        await new Promise(resolve => setTimeout(resolve, 100));

        // Capture the modal as a canvas
        const canvas = await html2canvas(element, {
          backgroundColor: '#0f172a',
          scale: 2, // Higher quality
          logging: false,
          useCORS: true
        });

        // Remove loading indicator
        element.removeChild(loadingDiv);

        // Convert canvas to image
        const imgData = canvas.toDataURL('image/png');

        // Create PDF
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');

        // Calculate dimensions to fit A4
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;

        // Add image to PDF
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);

        // Generate filename with date
        const date = new Date().toISOString().split('T')[0];
        const filename = `${stock.symbol}_TearSheet_${date}.pdf`;

        // Download
        pdf.save(filename);

        console.log(`âœ“ PDF tear sheet saved: ${filename}`);

      } catch (error) {
        console.error('PDF export error:', error);
        alert('Failed to generate PDF. Please try again.');
      }
    }






    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PHASE 1 ENHANCED - Export & Demo Mode Functions
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function exportScreenerResults(stocks) {
      const timestamp = new Date().toISOString().split('T')[0];
      const headers = ['Symbol', 'Name', 'Price', 'Change%', 'P/E', 'ROE%', 'Growth%', 'Score', 'Verdict'];
      const rows = stocks.map(s => [
        s.symbol, s.name, s.price?.toFixed(2), s.changePct?.toFixed(2),
        s.pe?.toFixed(1), s.roe?.toFixed(1), s.revenueGrowth?.toFixed(1),
        s.aiScore, s.verdict
      ]);
      const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `screener_${timestamp}.csv`;
      a.click();
    }

    function toggleDemoMode() {
      isDemoMode = !isDemoMode;
      console.log('Demo mode:', isDemoMode ? 'ON' : 'OFF');
      window.location.reload(); // Reload to apply demo data
    }


    const getSmartInsight = (stock) => {
      if (!stock) return null;

      // 1. Earnings (High Priority)
      if (stock.lastEarnings && stock.lastEarnings.date) {
        const earningsDate = new Date(stock.lastEarnings.date);
        const today = new Date();
        const diffTime = earningsDate - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        if (diffDays >= 0 && diffDays <= 7) return { text: `Earnings in ${diffDays}d`, color: 'text-yellow-400', icon: 'ğŸ“…' };
        if (diffDays < 0 && diffDays >= -2) return { text: `Earnings just reported`, color: 'text-blue-400', icon: 'ğŸ“¢' };
      }

      // 2. Technical Extremes
      if (stock.rsi < 30) return { text: `RSI Oversold (${stock.rsi.toFixed(0)})`, color: 'text-green-400', icon: 'ğŸ“‰' };
      if (stock.rsi > 75) return { text: `RSI Overbought (${stock.rsi.toFixed(0)})`, color: 'text-red-400', icon: 'ğŸ“ˆ' };

      // 3. Momentum
      if (stock.changePct > 5) return { text: `Big Move Up (+${stock.changePct.toFixed(1)}%)`, color: 'text-green-400', icon: 'ğŸš€' };
      if (stock.changePct < -5) return { text: `Big Drop (${stock.changePct.toFixed(1)}%)`, color: 'text-red-400', icon: 'ğŸ©¸' };

      // 4. Analyst Upside
      if (stock.upside > 30) return { text: `Analyst Upside +${stock.upside.toFixed(0)}%`, color: 'text-cyan-400', icon: 'ğŸ¯' };

      // 5. Fundamentals
      if (stock.revenueGrowth > 30) return { text: `High Growth (+${stock.revenueGrowth.toFixed(0)}%)`, color: 'text-purple-400', icon: 'ğŸŒ±' };
      if (stock.pe > 0 && stock.pe < 10) return { text: `Deep Value (P/E ${stock.pe.toFixed(1)})`, color: 'text-emerald-400', icon: 'ğŸ’°' };

      // 6. AI Verdict
      if (stock.verdict === 'STRONG BUY') return { text: 'AI Strong Buy', color: 'text-green-400', icon: 'ğŸ¤–' };
      if (stock.verdict === 'SELL') return { text: 'AI Sell Signal', color: 'text-red-400', icon: 'âš ï¸' };

      return { text: stock.sector || 'Neutral', color: 'text-slate-500', icon: 'ğŸ¢' };
    };

    const ALL_COLUMNS = [
      { key: 'watchlist', label: 'â­', category: 'core', tooltip: 'Add to watchlist' },
      { key: 'symbol', label: 'Symbol', category: 'core' },
      { key: 'smartInsight', label: 'Smart Insight', category: 'core', tooltip: 'Key reason to watch this stock right now' },
      { key: 'price', label: 'Price', category: 'core' },
      { key: 'changePct', label: 'Change%', category: 'core' },
      { key: 'volume', label: 'Volume', category: 'core' },
      { key: 'sparkline', label: 'Sparkline', category: 'core' },

      // Valuation
      { key: 'pe', label: 'P/E', category: 'valuation' },
      { key: 'priceToBook', label: 'P/B', category: 'valuation' },
      { key: 'priceToSales', label: 'P/S', category: 'valuation' },
      { key: 'evToEbitda', label: 'EV/EBITDA', category: 'valuation' },

      // Profitability
      { key: 'roe', label: 'ROE%', category: 'profitability' },
      { key: 'roa', label: 'ROA%', category: 'profitability' },
      { key: 'roic', label: 'ROIC%', category: 'profitability' },
      { key: 'grossMargin', label: 'Gross Margin%', category: 'profitability' },
      { key: 'operatingMargin', label: 'Operating Margin%', category: 'profitability' },
      { key: 'netMargin', label: 'Net Margin%', category: 'profitability' },

      // Growth
      { key: 'revenueGrowth', label: 'Revenue Growth%', category: 'growth' },
      { key: 'netIncomeGrowth', label: 'Income Growth%', category: 'growth' },
      { key: 'epsGrowth', label: 'EPS Growth%', category: 'growth' },

      // Financial Health
      { key: 'currentRatio', label: 'Current Ratio', category: 'financial' },
      { key: 'quickRatio', label: 'Quick Ratio', category: 'financial' },
      { key: 'debtToEquity', label: 'Debt/Equity', category: 'financial' },
      { key: 'debtToAssets', label: 'Debt/Assets', category: 'financial' },
      { key: 'cashRatio', label: 'Cash Ratio', category: 'financial' },

      // Quality Scores
      { key: 'piotroskiScore', label: 'Piotroski', category: 'quality' },
      { key: 'altmanZScore', label: 'Altman Z', category: 'quality' },

      // Analyst Data
      { key: 'analystRating', label: 'FMP Rating', category: 'analyst' },
      { key: 'priceTargetAvg', label: 'Price Target', category: 'analyst' },
      { key: 'analystCount', label: 'Analyst Count', category: 'analyst' },

      { key: 'beta', label: 'Beta', category: 'technical', tooltip: 'Measure of volatility relative to the market. >1 is more volatile, <1 is less volatile.' },
      { key: 'rsi', label: 'RSI', category: 'technical' },
      { key: 'index', label: 'Index', category: 'core' },

      // ML & AI
      { key: 'mlPrediction', label: 'ML 30d', category: 'ml', tooltip: 'Machine learning prediction of 30-day price movement based on 60 days of historical data. Positive % = expected gain, Negative % = expected decline.' },
      { key: 'verdict', label: 'Verdict', category: 'core' },
    ];

    const DEFAULT_VISIBLE = ['watchlist', 'symbol', 'smartInsight', 'price', 'changePct', 'pe', 'roe', 'analystRating', 'mlPrediction', 'verdict'];

    const PRESET_SCREENS = {
      // Buffett and Magic Formula filters - REMOVED
      growth: {
        name: 'Growth',
        filters: {
          roe_min: 10,      // Was 15
          revenueGrowth_min: 5  // Was 10
        }
      },
      momentum: {
        name: 'Momentum',
        filters: {
          changePct_min: 0.5,  // Was 1
          rsi_min: 50          // Was 55
        }
      },
      oversold: {
        name: 'Oversold',
        filters: {
          rsi_max: 40  // Was 35
        }
      },
      // Add a new "Value" preset that will almost always show stocks
      value: {
        name: 'Value',
        filters: {
          pe_max: 25,
          debtToEquity_max: 1.5
        }
      },
    };


    const SECTORS = [
      'Technology', 'Healthcare', 'Financial Services', 'Consumer Cyclical', 'Industrials',
      'Communication Services', 'Consumer Defensive', 'Energy', 'Real Estate', 'Utilities', 'Basic Materials'
    ];

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UTILITY FUNCTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const formatNumber = (val, decimals = 2) => {
      if (val == null || isNaN(val)) return 'â€”';
      if (Math.abs(val) >= 1e12) return `${(val / 1e12).toFixed(1)}T`;
      if (Math.abs(val) >= 1e9) return `${(val / 1e9).toFixed(1)}B`;
      if (Math.abs(val) >= 1e6) return `${(val / 1e6).toFixed(1)}M`;
      return val.toFixed(decimals);
    };

    const formatPercent = (val, decimals = 1) => {
      if (val == null || isNaN(val)) return 'â€”';
      return `${val > 0 ? '+' : ''}${val.toFixed(decimals)}%`;
    };

    const formatCurrency = (val) => {
      if (val == null || isNaN(val)) return '$â€”';
      return `$${formatNumber(val)}`;
    };

    const formatDateSafe = (value, fallback = 'â€”') => {
      if (!value) return fallback;
      const t = new Date(value).getTime();
      if (!Number.isFinite(t)) return fallback;
      try {
        return new Date(t).toLocaleDateString();
      } catch {
        return fallback;
      }
    };

    const getSentimentColor = (val) => {
      if (val == null || isNaN(val)) return 'text-slate-500';
      if (val > 0) return 'text-green-400';
      if (val < 0) return 'text-red-400';
      return 'text-yellow-400';
    };

    const getHealthColor = (health) => {
      if (health >= 70) return 'bg-green-500';
      if (health >= 40) return 'bg-yellow-500';
      return 'bg-red-500';
    };

    const exportToCSV = (data, filename = 'export.csv') => {
      if (!data || !data.length) return;

      const headers = Object.keys(data[0]);
      const csvContent = [
        headers.join(','),
        ...data.map(row => headers.map(header => {
          const cell = row[header];
          if (cell == null) return '';
          // Escape quotes and wrap in quotes if contains comma
          const stringCell = String(cell);
          return stringCell.includes(',') ? `"${stringCell.replace(/"/g, '""')}"` : stringCell;
        }).join(','))
      ].join('\n');

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.style.display = 'none';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // REAL-TIME DATA ENGINE (Finnhub WebSocket + Smart Polling)
    // Cost: FREE with existing Finnhub API key!
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    class RealtimeDataManager {
      constructor(apiKey = API_KEYS.FINNHUB) {
        this.apiKey = apiKey;
        this.ws = null;
        this.subscribers = new Map(); // symbol -> [callbacks]
        this.reconnectAttempts = 0;
        this.maxReconnectAttempts = 3; // Reduced from 5
        this.reconnectDelay = 1000;

        this.isConnected = false;
        this.lastPrices = new Map(); // symbol -> last known price
        this.connectionListeners = [];
        this.websocketDisabled = false; // Flag to disable WebSocket permanently if not supported
      }

      connect() {
        // Don't attempt connection if WebSocket is permanently disabled
        if (this.websocketDisabled) {
          console.log('âš ï¸ WebSocket disabled (free tier limitation). Using smart polling instead.');
          return;
        }

        // Skip WebSocket in browser environments (CORS restrictions)
        const isBrowser = typeof window !== 'undefined';
        if (isBrowser) {
          console.log('âš ï¸ WebSocket disabled in browser (CORS restrictions). Using manual refresh instead.');
          return;
        }

        if (this.ws?.readyState === WebSocket.OPEN) {
          console.log('âœ… WebSocket already connected');
          return;
        }

        // Only log on first attempt to reduce console spam
        if (this.reconnectAttempts === 0) {
          console.log('ğŸ”Œ Connecting to Finnhub WebSocket...');
          console.log(`ğŸ”‘ Using API key: ${this.apiKey.substring(0, 10)}...`);
        }

        try {
          this.ws = new WebSocket(`wss://ws.finnhub.io?token=${this.apiKey}`);

          this.ws.onopen = () => {
            console.log('âœ… WebSocket connected successfully!');
            this.isConnected = true;
            this.reconnectAttempts = 0;
            this.notifyConnectionChange(true);

            // Resubscribe to all symbols
            this.subscribers.forEach((_, symbol) => {
              this.ws.send(JSON.stringify({ type: 'subscribe', symbol: symbol }));
              console.log(`ğŸ“¡ Resubscribed to ${symbol}`);
            });
          };

          this.ws.onmessage = (event) => {
            try {
              const data = JSON.parse(event.data);

              if (data.type === 'trade' && data.data) {
                // Process real-time trades
                data.data.forEach(trade => {
                  const symbol = trade.s;
                  const price = trade.p;
                  const volume = trade.v;
                  const timestamp = trade.t;

                  // Store last price
                  const lastPrice = this.lastPrices.get(symbol);
                  this.lastPrices.set(symbol, price);

                  // Calculate change
                  const change = lastPrice ? ((price - lastPrice) / lastPrice * 100) : 0;

                  // Notify subscribers
                  const callbacks = this.subscribers.get(symbol);
                  if (callbacks) {
                    callbacks.forEach(cb => {
                      try {
                        cb({
                          symbol,
                          price,
                          volume,
                          timestamp,
                          quoteFetchedAt: timestamp,
                          change,
                          source: 'websocket'
                        });
                      } catch (err) {
                        console.error(`Error in callback for ${symbol}:`, err);
                      }
                    });
                  }
                });
              }
            } catch (error) {
              console.error('âŒ Error processing WebSocket message:', error);
            }
          };

          this.ws.onerror = (error) => {
            // Suppress error logging on reconnection attempts (just noise)
            if (this.reconnectAttempts === 0) {
              console.log('âš ï¸ WebSocket connection error (checking connectivity...)');
            }
          };

          this.ws.onclose = (event) => {
            // Only log meaningful close events
            if (this.reconnectAttempts === 0 && event.code !== 1006) {
              console.log(`ğŸ”Œ WebSocket disconnected (code: ${event.code})`);
            }
            this.isConnected = false;
            this.notifyConnectionChange(false);
            this.reconnect();
          };
        } catch (error) {
          console.error('âŒ Failed to create WebSocket:', error);
          this.reconnect();
        }
      }

      reconnect() {
        if (this.reconnectAttempts >= this.maxReconnectAttempts) {
          console.warn('âš ï¸ WebSocket connection failed (likely free tier limitation)');
          console.log('ğŸ“Š Continuing with smart polling for data updates');
          // âœ… KEEP WebSocket enabled by default - don't permanently disable
          // this.websocketDisabled = true; // REMOVED - This prevents WebSocket connection!
          this.notifyConnectionChange(false);
          return;
        }

        this.reconnectAttempts++;
        const delay = this.reconnectDelay * Math.pow(2, this.reconnectAttempts - 1);

        // Only log on first few attempts
        if (this.reconnectAttempts <= 2) {
          console.log(`ğŸ”„ Reconnecting in ${delay}ms... (attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts})`);
        }

        setTimeout(() => this.connect(), delay);
      }

      subscribe(symbol, callback) {
        if (!this.subscribers.has(symbol)) {
          this.subscribers.set(symbol, []);

          // Send subscribe message if connected
          if (this.isConnected && this.ws?.readyState === WebSocket.OPEN) {
            this.ws.send(JSON.stringify({ type: 'subscribe', symbol: symbol }));
            console.log(`ğŸ“¡ Subscribed to ${symbol} real-time updates`);
          }
        }

        this.subscribers.get(symbol).push(callback);
        console.log(`âœ… Added subscriber for ${symbol} (total: ${this.subscribers.get(symbol).length})`);
      }

      unsubscribe(symbol, callback) {
        const callbacks = this.subscribers.get(symbol);
        if (!callbacks) return;

        const index = callbacks.indexOf(callback);
        if (index > -1) {
          callbacks.splice(index, 1);
          console.log(`âœ… Removed subscriber for ${symbol} (remaining: ${callbacks.length})`);
        }

        // If no more subscribers, unsubscribe from WebSocket
        if (callbacks.length === 0) {
          this.subscribers.delete(symbol);
          if (this.isConnected && this.ws?.readyState === WebSocket.OPEN) {
            this.ws.send(JSON.stringify({ type: 'unsubscribe', symbol: symbol }));
            console.log(`ğŸ“¡ Unsubscribed from ${symbol}`);
          }
        }
      }

      disconnect() {
        if (this.ws) {
          console.log('ğŸ”Œ Disconnecting WebSocket...');
          this.ws.close();
          this.ws = null;
        }
        this.subscribers.clear();
        this.isConnected = false;
        this.lastPrices.clear();
        this.notifyConnectionChange(false);
      }

      onConnectionChange(callback) {
        this.connectionListeners.push(callback);
      }

      notifyConnectionChange(connected) {
        this.connectionListeners.forEach(cb => {
          try {
            cb(connected);
          } catch (err) {
            console.error('Error in connection listener:', err);
          }
        });
      }

      getStatus() {
        return {
          connected: this.isConnected,
          subscribedSymbols: Array.from(this.subscribers.keys()),
          totalSubscribers: Array.from(this.subscribers.values()).reduce((sum, arr) => sum + arr.length, 0)
        };
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SMART POLLING (Fallback for when WebSocket not available)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    class SmartPoller {
      constructor(options = {}) {
        this.intervals = new Map(); // symbol -> interval ID
        // Default: 60 minutes (3600000ms)
        this.baseUpdateFrequency = options.frequency || 60 * 60 * 1000; // 60 minutes minimum update interval
        this.offHoursFrequency = options.offHoursFrequency || 60 * 60 * 1000; // 60 minutes when market closed
      }

      async pollStock(symbol, callback) {
        // Skip polling in browser environments
        const isBrowser = typeof window !== 'undefined';
        if (isBrowser) {
          console.log(`â±ï¸ Polling skipped in browser for ${symbol}`);
          return;
        }

        // Clean symbol to remove exchange suffixes (.O, .K, etc.)
        symbol = cleanSymbol(symbol);

        try {
          console.log(`â±ï¸ Polling ${symbol}...`);

          // Use existing smartFetch with fallback (will skip Finnhub in browsers)
          const result = await smartFetch('quote', symbol);

          if (result?.data?.[0]) {
            const data = result.data[0];
            callback({
              symbol,
              price: data.price,
              change: data.change,
              changesPercentage: data.changesPercentage,
              volume: data.volume,
              quoteFetchedAt: Date.now(),
              source: 'polling'
            });
            console.log(`âœ… Polled ${symbol}: $${data.price}`);
          }
        } catch (error) {
          // Don't log errors for browser environments (expected)
          const isBrowser = typeof window !== 'undefined';
          if (!isBrowser) {
            console.error(`âŒ Polling error for ${symbol}:`, error);
          }
        }
      }

      startPolling(symbol, callback, customFrequency = null) {
        if (this.intervals.has(symbol)) {
          console.log(`â±ï¸ Already polling ${symbol}`);
          return;
        }

        const frequency = customFrequency || (Cache.isMarketOpen()
          ? this.baseUpdateFrequency
          : this.offHoursFrequency);

        // Immediate fetch
        this.pollStock(symbol, callback);

        // Set interval
        const intervalId = setInterval(() => {
          this.pollStock(symbol, callback);
        }, frequency);

        this.intervals.set(symbol, intervalId);
        console.log(`â±ï¸ Started polling ${symbol} every ${Math.floor(frequency / 60000)} minutes`);
      }

      stopPolling(symbol) {
        const intervalId = this.intervals.get(symbol);
        if (intervalId) {
          clearInterval(intervalId);
          this.intervals.delete(symbol);
          console.log(`â±ï¸ Stopped polling ${symbol}`);
        }
      }

      stopAll() {
        console.log(`â±ï¸ Stopping all polling (${this.intervals.size} symbols)`);
        this.intervals.forEach(id => clearInterval(id));
        this.intervals.clear();
      }

      getPollingSymbols() {
        return Array.from(this.intervals.keys());
      }
    }

    // Initialize global instances
    const realtimeData = new RealtimeDataManager();
    const smartPoller = new SmartPoller();

    // WebSocket disabled (free tier limitation) - using smart polling instead
    // Smart polling provides real-time updates without WebSocket connection
    console.log('ğŸ“Š Real-time updates enabled via smart polling');

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SOCIAL SENTIMENT ENGINE (StockTwits + Community Data)
    // Cost: FREE - No API key required!
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    class SocialSentimentManager {
      constructor() {
        this.cache = new Map(); // symbol -> social data
        this.cacheExpiry = 300000; // 5 minutes
      }

      async fetchSocialSentiment(symbol) {
        try {
          console.log(`ğŸ’¬ Fetching social sentiment for ${symbol}...`);

          // Check cache
          const cached = this.cache.get(symbol);
          if (cached && (Date.now() - cached.timestamp) < this.cacheExpiry) {
            console.log(`ğŸ’¾ Using cached social sentiment for ${symbol}`);
            return cached.data;
          }

          // Fetch from multiple social sources in parallel
          const [stockTwitsData, redditData] = await Promise.all([
            this.fetchStockTwits(symbol),
            this.fetchRedditSentiment(symbol)
          ]);

          // Combine data from both sources
          const combined = this.combineSocialData(stockTwitsData, redditData, symbol);

          // Cache result
          this.cache.set(symbol, { data: combined, timestamp: Date.now() });

          console.log(`âœ… Combined social sentiment: ${combined.overallSentiment} (StockTwits: ${stockTwitsData.totalMessages} | Reddit: ${redditData.totalPosts} posts)`);

          return combined;

        } catch (error) {
          console.error(`âŒ Error fetching social sentiment for ${symbol}:`, error);
          return this.getDefaultSentiment();
        }
      }

      async fetchStockTwits(symbol) {
        try {
          // Use proxy server to avoid CORS
          const response = await fetchWithRetry(`${API_BASE_URL}/api/stocktwits/${symbol}`, { timeoutMs: 12000, retries: 1 });

          if (!response.ok) {
            console.log(`âš ï¸ StockTwits API returned ${response.status}`);
            return { totalMessages: 0, bullishCount: 0, bearishCount: 0, neutralCount: 0, messages: [] };
          }

          const data = await response.json();

          if (!data.messages || data.messages.length === 0) {
            return { totalMessages: 0, bullishCount: 0, bearishCount: 0, neutralCount: 0, messages: [] };
          }

          const messages = data.messages;
          let bullishCount = 0;
          let bearishCount = 0;
          let neutralCount = 0;

          messages.forEach(msg => {
            if (msg.entities && msg.entities.sentiment) {
              const sentiment = msg.entities.sentiment.basic;
              if (sentiment === 'Bullish') bullishCount++;
              else if (sentiment === 'Bearish') bearishCount++;
              else neutralCount++;
            } else {
              neutralCount++;
            }
          });

          return {
            totalMessages: messages.length,
            bullishCount,
            bearishCount,
            neutralCount,
            messages: messages.slice(0, 5).map(msg => ({
              text: msg.body,
              user: msg.user.username,
              sentiment: msg.entities?.sentiment?.basic || 'Neutral',
              timestamp: msg.created_at,
              likes: msg.likes?.total || 0,
              source: 'StockTwits'
            }))
          };

        } catch (error) {
          console.error(`âŒ StockTwits error:`, error);
          return { totalMessages: 0, bullishCount: 0, bearishCount: 0, neutralCount: 0, messages: [] };
        }
      }

      async fetchRedditSentiment(symbol) {
        try {
          console.log(`ğŸ¤– Fetching Reddit/WSB sentiment for ${symbol}...`);

          // Search WallStreetBets for the stock symbol
          const subreddits = ['wallstreetbets', 'stocks', 'investing'];
          const allPosts = [];

          for (const subreddit of subreddits) {
            try {
              // Use proxy server to avoid CORS
              const searchUrl = `${API_BASE_URL}/api/reddit/${subreddit}/search?q=${symbol}`;
              const response = await fetchWithRetry(searchUrl, { timeoutMs: 12000, retries: 1 });

              if (response.ok) {
                const data = await response.json();
                if (data.data && data.data.children) {
                  allPosts.push(...data.data.children.map(child => ({
                    ...child.data,
                    subreddit: subreddit
                  })));
                }
              }
            } catch (err) {
              console.log(`âš ï¸ Error fetching from r/${subreddit}`);
            }
          }

          if (allPosts.length === 0) {
            return { totalPosts: 0, bullishCount: 0, bearishCount: 0, neutralCount: 0, posts: [] };
          }

          // Analyze sentiment using post titles, scores, and content
          let bullishCount = 0;
          let bearishCount = 0;
          let neutralCount = 0;

          const sentimentAnalyzer = new SentimentAnalyzer();

          const analyzedPosts = allPosts.map(post => {
            const text = (post.title + ' ' + (post.selftext || '')).toLowerCase();
            const sentiment = sentimentAnalyzer.analyzeSentiment(text);

            // Weight by upvotes (more upvoted = more important)
            const weight = Math.log10(Math.max(post.score, 1) + 1);

            if (sentiment.label === 'bullish') {
              bullishCount += weight;
            } else if (sentiment.label === 'bearish') {
              bearishCount += weight;
            } else {
              neutralCount += weight;
            }

            return {
              title: post.title,
              text: post.selftext?.substring(0, 200) || '',
              url: `https://www.reddit.com${post.permalink}`,
              author: post.author,
              score: post.score,
              comments: post.num_comments,
              sentiment: sentiment.label,
              subreddit: post.subreddit,
              timestamp: new Date(post.created_utc * 1000).toISOString()
            };
          });

          // Sort by score (popularity)
          analyzedPosts.sort((a, b) => b.score - a.score);

          return {
            totalPosts: allPosts.length,
            bullishCount: Math.round(bullishCount),
            bearishCount: Math.round(bearishCount),
            neutralCount: Math.round(neutralCount),
            posts: analyzedPosts.slice(0, 5)
          };

        } catch (error) {
          console.error(`âŒ Reddit API error:`, error);
          return { totalPosts: 0, bullishCount: 0, bearishCount: 0, neutralCount: 0, posts: [] };
        }
      }

      combineSocialData(stockTwits, reddit, symbol) {
        const totalMessages = stockTwits.totalMessages + reddit.totalPosts;

        if (totalMessages === 0) {
          return this.getDefaultSentiment();
        }

        // Combine counts with weighted average (StockTwits 40%, Reddit 60% - Reddit is more influential)
        const stWeight = 0.4;
        const rdWeight = 0.6;

        const bullishCount = Math.round(
          (stockTwits.bullishCount * stWeight + reddit.bullishCount * rdWeight)
        );
        const bearishCount = Math.round(
          (stockTwits.bearishCount * stWeight + reddit.bearishCount * rdWeight)
        );
        const neutralCount = Math.round(
          (stockTwits.neutralCount * stWeight + reddit.neutralCount * rdWeight)
        );

        const total = bullishCount + bearishCount + neutralCount || 1;
        const bullishPercent = (bullishCount / total * 100);
        const bearishPercent = (bearishCount / total * 100);
        const neutralPercent = (neutralCount / total * 100);

        // Determine overall sentiment
        let overallSentiment = 'neutral';
        let sentimentScore = 0;

        if (bullishCount > bearishCount * 1.3) {
          overallSentiment = 'bullish';
          sentimentScore = Math.round(bullishPercent - bearishPercent);
        } else if (bearishCount > bullishCount * 1.3) {
          overallSentiment = 'bearish';
          sentimentScore = -Math.round(bearishPercent - bullishPercent);
        } else {
          overallSentiment = 'neutral';
          sentimentScore = Math.round(bullishPercent - bearishPercent);
        }

        return {
          source: 'StockTwits + Reddit',
          totalMessages,
          stockTwitsCount: stockTwits.totalMessages,
          redditCount: reddit.totalPosts,
          bullishCount,
          bearishCount,
          neutralCount,
          bullishPercent: Math.round(bullishPercent),
          bearishPercent: Math.round(bearishPercent),
          neutralPercent: Math.round(neutralPercent),
          overallSentiment,
          sentimentScore,
          messages: [
            ...stockTwits.messages.slice(0, 3),
            ...reddit.posts.slice(0, 2).map(post => ({
              text: post.title,
              user: post.author,
              sentiment: post.sentiment,
              timestamp: post.timestamp,
              likes: post.score,
              source: 'Reddit',
              url: post.url,
              subreddit: post.subreddit
            }))
          ],
          redditPosts: reddit.posts,
          trending: totalMessages > 30 || reddit.totalPosts > 20,
          timestamp: Date.now()
        };
      }

      getDefaultSentiment() {
        return {
          source: 'N/A',
          totalMessages: 0,
          bullishCount: 0,
          bearishCount: 0,
          neutralCount: 0,
          bullishPercent: 0,
          bearishPercent: 0,
          neutralPercent: 0,
          overallSentiment: 'neutral',
          sentimentScore: 0,
          messages: [],
          trending: false,
          timestamp: Date.now()
        };
      }

      clearCache() {
        this.cache.clear();
      }
    }

    // Initialize social sentiment manager
    const socialSentiment = new SocialSentimentManager();
    window.socialSentiment = socialSentiment;
    console.log('âœ… Social Sentiment Manager initialized');

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PATTERN RECOGNITION ENGINE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    class PatternRecognitionEngine {
      constructor() {
        this.patterns = {
          HEAD_AND_SHOULDERS: {
            name: 'Head & Shoulders',
            type: 'reversal',
            reliability: 0.75,
            description: 'Potential trend reversal from bullish to bearish'
          },
          CUP_WITH_HANDLE: {
            name: 'Cup with Handle',
            type: 'continuation',
            reliability: 0.80,
            description: 'Bullish continuation pattern'
          },
          DOUBLE_TOP: {
            name: 'Double Top',
            type: 'reversal',
            reliability: 0.70,
            description: 'Bearish reversal pattern'
          },
          DOUBLE_BOTTOM: {
            name: 'Double Bottom',
            type: 'reversal',
            reliability: 0.70,
            description: 'Bullish reversal pattern'
          },
          ASCENDING_TRIANGLE: {
            name: 'Ascending Triangle',
            type: 'continuation',
            reliability: 0.75,
            description: 'Bullish continuation pattern'
          },
          DESCENDING_TRIANGLE: {
            name: 'Descending Triangle',
            type: 'continuation',
            reliability: 0.75,
            description: 'Bearish continuation pattern'
          },
          FLAG: {
            name: 'Flag Pattern',
            type: 'continuation',
            reliability: 0.70,
            description: 'Brief consolidation before continuing trend'
          },
          WEDGE: {
            name: 'Wedge',
            type: 'reversal',
            reliability: 0.65,
            description: 'Potential trend reversal'
          },
          SYMMETRICAL_TRIANGLE: {
            name: 'Symmetrical Triangle',
            type: 'continuation',
            reliability: 0.68,
            description: 'Neutral pattern - breakout direction determines trend'
          },
          PENNANT: {
            name: 'Pennant',
            type: 'continuation',
            reliability: 0.72,
            description: 'Brief consolidation during strong trend'
          },
          TRIPLE_TOP: {
            name: 'Triple Top',
            type: 'reversal',
            reliability: 0.75,
            description: 'Strong bearish reversal signal'
          },
          TRIPLE_BOTTOM: {
            name: 'Triple Bottom',
            type: 'reversal',
            reliability: 0.75,
            description: 'Strong bullish reversal signal'
          },
          RISING_WEDGE: {
            name: 'Rising Wedge',
            type: 'reversal',
            reliability: 0.70,
            description: 'Bearish reversal - rising with declining volume'
          },
          FALLING_WEDGE: {
            name: 'Falling Wedge',
            type: 'reversal',
            reliability: 0.70,
            description: 'Bullish reversal - falling with declining volume'
          },
          ROUNDING_BOTTOM: {
            name: 'Rounding Bottom',
            type: 'reversal',
            reliability: 0.73,
            description: 'Gradual bullish reversal (saucer pattern)'
          },
          RECTANGLE: {
            name: 'Rectangle',
            type: 'continuation',
            reliability: 0.65,
            description: 'Consolidation range - awaiting breakout'
          },
          INVERSE_HEAD_SHOULDERS: {
            name: 'Inverse Head and Shoulders',
            type: 'reversal',
            reliability: 0.85,
            description: 'Strong bullish reversal signal'
          }
        };
      }

      detectPatterns(candles, patternTypes = null) {
        if (!candles || candles.length < 20) return [];

        const detected = [];
        const closes = candles.map(c => c.close || c);
        const highs = candles.map(c => c.high || c.close || c);
        const lows = candles.map(c => c.low || c.close || c);

        // Convert to find patterns
        if (!patternTypes || patternTypes.includes('HEAD_AND_SHOULDERS')) {
          const hns = this.detectHeadAndShoulders(highs, lows, closes);
          if (hns) detected.push(hns);
        }

        if (!patternTypes || patternTypes.includes('CUP_WITH_HANDLE')) {
          const cup = this.detectCupAndHandle(highs, lows, closes);
          if (cup) detected.push(cup);
        }

        if (!patternTypes || patternTypes.includes('DOUBLE_TOP')) {
          const dt = this.detectDoubleTop(highs, closes);
          if (dt) detected.push(dt);
        }

        if (!patternTypes || patternTypes.includes('DOUBLE_BOTTOM')) {
          const db = this.detectDoubleBottom(lows, closes);
          if (db) detected.push(db);
        }

        if (!patternTypes || patternTypes.includes('TRIPLE_TOP')) {
          const tt = this.detectTripleTop(highs, closes);
          if (tt) detected.push(tt);
        }

        if (!patternTypes || patternTypes.includes('TRIPLE_BOTTOM')) {
          const tb = this.detectTripleBottom(lows, closes);
          if (tb) detected.push(tb);
        }

        if (!patternTypes || patternTypes.includes('SYMMETRICAL_TRIANGLE')) {
          const st = this.detectSymmetricalTriangle(highs, lows, closes);
          if (st) detected.push(st);
        }

        if (!patternTypes || patternTypes.includes('ASCENDING_TRIANGLE')) {
          const at = this.detectAscendingTriangle(highs, lows, closes);
          if (at) detected.push(at);
        }

        if (!patternTypes || patternTypes.includes('DESCENDING_TRIANGLE')) {
          const dt = this.detectDescendingTriangle(highs, lows, closes);
          if (dt) detected.push(dt);
        }

        if (!patternTypes || patternTypes.includes('RISING_WEDGE')) {
          const rw = this.detectRisingWedge(highs, lows, closes);
          if (rw) detected.push(rw);
        }

        if (!patternTypes || patternTypes.includes('FALLING_WEDGE')) {
          const fw = this.detectFallingWedge(highs, lows, closes);
          if (fw) detected.push(fw);
        }

        if (!patternTypes || patternTypes.includes('PENNANT')) {
          const pennant = this.detectPennant(highs, lows, closes);
          if (pennant) detected.push(pennant);
        }

        if (!patternTypes || patternTypes.includes('RECTANGLE')) {
          const rect = this.detectRectangle(highs, lows, closes);
          if (rect) detected.push(rect);
        }

        if (!patternTypes || patternTypes.includes('ROUNDING_BOTTOM')) {
          const rb = this.detectRoundingBottom(lows, closes);
          if (rb) detected.push(rb);
        }

        if (!patternTypes || patternTypes.includes('INVERSE_HEAD_SHOULDERS')) {
          const ihs = this.detectInverseHeadAndShoulders(highs, lows, closes);
          if (ihs) detected.push(ihs);
        }

        if (!patternTypes || patternTypes.includes('FLAG')) {
          const flag = this.detectFlag(highs, lows, closes);
          if (flag) detected.push(flag);
        }

        return detected.sort((a, b) => b.confidence - a.confidence);
      }

      detectHeadAndShoulders(highs, lows, closes) {
        // Simplified detection: looks for 5-point structure
        const window = 30; // 30 candles window
        if (highs.length < window) return null;

        const recentHighs = highs.slice(-window);
        const pivotPoints = this.findPivotPoints(recentHighs, 5);

        if (pivotPoints.length >= 5) {
          const [leftShoulder, head, rightShoulder] = this.extractHSPattern(pivotPoints);

          if (this.validateHSStructure(leftShoulder, head, rightShoulder)) {
            return {
              type: 'HEAD_AND_SHOULDERS',
              pattern: this.patterns.HEAD_AND_SHOULDERS,
              startIndex: pivotPoints[0].index,
              endIndex: pivotPoints[pivotPoints.length - 1].index,
              confidence: this.calculateHSConfidence(leftShoulder, head, rightShoulder),
              neckline: this.calculateNeckline(lows, pivotPoints),
              implications: 'Bearish reversal',
              targetPrice: this.calculateHSTarget(closes, pivotPoints)
            };
          }
        }
        return null;
      }

      detectCupAndHandle(highs, lows, closes) {
        // Looks for U-shape followed by smaller consolidation
        const window = 40;
        if (closes.length < window) return null;

        const recentCloses = closes.slice(-window);
        const cupBottom = this.findCupBottom(recentCloses);

        if (cupBottom.found) {
          const handle = this.detectHandle(recentCloses, cupBottom);
          if (handle.found) {
            return {
              type: 'CUP_WITH_HANDLE',
              pattern: this.patterns.CUP_WITH_HANDLE,
              startIndex: cupBottom.startIndex,
              endIndex: handle.endIndex,
              confidence: handle.confidence,
              cupDepth: cupBottom.depth,
              handleDepth: handle.depth,
              implications: 'Bullish continuation',
              targetPrice: this.calculateCupTarget(recentCloses, cupBottom, handle)
            };
          }
        }
        return null;
      }

      detectDoubleTop(highs, closes) {
        const window = 25;
        if (highs.length < window) return null;

        const recentHighs = highs.slice(-window);
        const peaks = this.findLocalPeaks(recentHighs, 2);

        if (peaks.length >= 2) {
          const [first, second] = peaks.slice(-2);
          const priceDiff = Math.abs(first.value - second.value) / first.value;

          if (priceDiff < 0.03) { // Within 3% of each other
            return {
              type: 'DOUBLE_TOP',
              pattern: this.patterns.DOUBLE_TOP,
              firstPeak: first,
              secondPeak: second,
              confidence: 0.70 * (1 - priceDiff),
              implications: 'Bearish reversal',
              targetPrice: this.calculateDoubleTopTarget(closes, peaks)
            };
          }
        }
        return null;
      }

      detectDoubleBottom(lows, closes) {
        const window = 25;
        if (lows.length < window) return null;

        const recentLows = lows.slice(-window);
        const troughs = this.findLocalTroughs(recentLows, 2);

        if (troughs.length >= 2) {
          const [first, second] = troughs.slice(-2);
          const priceDiff = Math.abs(first.value - second.value) / first.value;

          if (priceDiff < 0.03) {
            return {
              type: 'DOUBLE_BOTTOM',
              pattern: this.patterns.DOUBLE_BOTTOM,
              firstTrough: first,
              secondTrough: second,
              confidence: 0.70 * (1 - priceDiff),
              implications: 'Bullish reversal',
              targetPrice: this.calculateDoubleBottomTarget(closes, troughs)
            };
          }
        }
        return null;
      }

      // Helper methods
      findPivotPoints(data, minPoints) {
        const pivots = [];
        for (let i = 2; i < data.length - 2; i++) {
          if (data[i] > data[i - 1] && data[i] > data[i + 1] &&
            data[i] > data[i - 2] && data[i] > data[i + 2]) {
            pivots.push({ index: i, value: data[i], type: 'high' });
          }
        }
        return pivots;
      }

      findLocalPeaks(data, minPeaks) {
        const peaks = [];
        for (let i = 1; i < data.length - 1; i++) {
          if (data[i] > data[i - 1] && data[i] > data[i + 1]) {
            peaks.push({ index: i, value: data[i] });
          }
        }
        return peaks.sort((a, b) => b.value - a.value).slice(0, minPeaks);
      }

      findLocalTroughs(data, minTroughs) {
        const troughs = [];
        for (let i = 1; i < data.length - 1; i++) {
          if (data[i] < data[i - 1] && data[i] < data[i + 1]) {
            troughs.push({ index: i, value: data[i] });
          }
        }
        return troughs.sort((a, b) => a.value - b.value).slice(0, minTroughs);
      }

      calculateHSConfidence(left, head, right) {
        const symmetry = Math.abs(left.height - right.height) / Math.max(left.height || 1, right.height || 1);
        return Math.max(0.60, 0.90 - symmetry);
      }

      findCupBottom(data) {
        const mid = Math.floor(data.length / 2);
        const bottom = Math.min(...data.slice(mid - 10, mid + 10));
        const bottomIdx = data.indexOf(bottom);

        return {
          found: bottomIdx > 10 && bottomIdx < data.length - 10,
          startIndex: bottomIdx - 15,
          endIndex: bottomIdx + 15,
          depth: (data[0] - bottom) / data[0],
          bottomValue: bottom
        };
      }

      detectHandle(data, cupBottom) {
        const handleStart = cupBottom.endIndex;
        const handleData = data.slice(handleStart, handleStart + 10);
        const handleHigh = Math.max(...handleData);
        const handleLow = Math.min(...handleData);

        return {
          found: (handleHigh - handleLow) / handleHigh < 0.05, // Tight consolidation
          endIndex: handleStart + handleData.length,
          depth: (handleHigh - handleLow) / handleHigh,
          confidence: 0.75
        };
      }

      extractHSPattern(pivots) {
        // Simplified extraction - assumes first 3 pivots form the pattern
        if (pivots.length < 3) return [null, null, null];
        const sorted = [...pivots].sort((a, b) => b.value - a.value);
        const head = sorted[0];
        const shoulders = pivots.filter(p => p.index !== head.index).slice(0, 2);
        return [
          { ...shoulders[0], height: shoulders[0].value },
          { ...head, height: head.value },
          { ...shoulders[1], height: shoulders[1].value }
        ];
      }

      validateHSStructure(left, head, right) {
        if (!left || !head || !right) return false;
        return head.value > left.value && head.value > right.value;
      }

      calculateNeckline(lows, pivots) {
        if (pivots.length < 2) return null;
        const necklineLows = pivots.map(p => lows[p.index] || p.value);
        return necklineLows.reduce((a, b) => a + b, 0) / necklineLows.length;
      }

      calculateHSTarget(closes, pivots) {
        if (pivots.length < 2) return null;
        const neckline = this.calculateNeckline(closes, pivots);
        const head = Math.max(...pivots.map(p => p.value));
        return neckline - (head - neckline);
      }

      calculateCupTarget(closes, cupBottom, handle) {
        const cupRim = Math.max(...closes.slice(cupBottom.startIndex, cupBottom.endIndex));
        const depth = cupRim - cupBottom.bottomValue;
        return cupRim + depth;
      }

      calculateDoubleTopTarget(closes, peaks) {
        if (peaks.length < 2) return null;
        const avgPeak = (peaks[0].value + peaks[1].value) / 2;
        const support = Math.min(...closes.slice(peaks[0].index, peaks[1].index));
        return support - (avgPeak - support);
      }

      calculateDoubleBottomTarget(closes, troughs) {
        if (troughs.length < 2) return null;
        const avgTrough = (troughs[0].value + troughs[1].value) / 2;
        const resistance = Math.max(...closes.slice(troughs[0].index, troughs[1].index));
        return resistance + (resistance - avgTrough);
      }

      detectTripleTop(highs, closes) {
        const window = 30;
        if (highs.length < window) return null;

        const recentHighs = highs.slice(-window);
        const peaks = this.findLocalPeaks(recentHighs, 3);

        if (peaks.length >= 3) {
          const [first, second, third] = peaks.slice(-3);
          const avgPrice = (first.value + second.value + third.value) / 3;
          const maxDiff = Math.max(
            Math.abs(first.value - avgPrice),
            Math.abs(second.value - avgPrice),
            Math.abs(third.value - avgPrice)
          ) / avgPrice;

          if (maxDiff < 0.03) {
            return {
              type: 'TRIPLE_TOP',
              pattern: this.patterns.TRIPLE_TOP,
              peaks: [first, second, third],
              confidence: 0.75 * (1 - maxDiff),
              implications: 'Strong bearish reversal',
              targetPrice: avgPrice - (avgPrice - Math.min(...closes.slice(-window))) * 1.5
            };
          }
        }
        return null;
      }

      detectTripleBottom(lows, closes) {
        const window = 30;
        if (lows.length < window) return null;

        const recentLows = lows.slice(-window);
        const troughs = this.findLocalTroughs(recentLows, 3);

        if (troughs.length >= 3) {
          const [first, second, third] = troughs.slice(-3);
          const avgPrice = (first.value + second.value + third.value) / 3;
          const maxDiff = Math.max(
            Math.abs(first.value - avgPrice),
            Math.abs(second.value - avgPrice),
            Math.abs(third.value - avgPrice)
          ) / avgPrice;

          if (maxDiff < 0.03) {
            return {
              type: 'TRIPLE_BOTTOM',
              pattern: this.patterns.TRIPLE_BOTTOM,
              troughs: [first, second, third],
              confidence: 0.75 * (1 - maxDiff),
              implications: 'Strong bullish reversal',
              targetPrice: avgPrice + (Math.max(...closes.slice(-window)) - avgPrice) * 1.5
            };
          }
        }
        return null;
      }

      detectSymmetricalTriangle(highs, lows, closes) {
        const window = 25;
        if (highs.length < window) return null;

        const recentHighs = highs.slice(-window);
        const recentLows = lows.slice(-window);

        // Calculate trendlines
        const highTrend = this.calculateTrendline(recentHighs);
        const lowTrend = this.calculateTrendline(recentLows);

        // Check if lines are converging at similar rates
        const convergenceRate = Math.abs(highTrend.slope + lowTrend.slope) / 2;

        if (convergenceRate < 0.5 && highTrend.slope < 0 && lowTrend.slope > 0) {
          const apex = this.findApex(highTrend, lowTrend);
          return {
            type: 'SYMMETRICAL_TRIANGLE',
            pattern: this.patterns.SYMMETRICAL_TRIANGLE,
            confidence: 0.68,
            apex: apex,
            implications: 'Breakout imminent - direction uncertain',
            targetPrice: null // Depends on breakout direction
          };
        }
        return null;
      }

      detectAscendingTriangle(highs, lows, closes) {
        const window = 25;
        if (highs.length < window) return null;

        const recentHighs = highs.slice(-window);
        const recentLows = lows.slice(-window);

        const highTrend = this.calculateTrendline(recentHighs);
        const lowTrend = this.calculateTrendline(recentLows);

        // Flat resistance, rising support
        if (Math.abs(highTrend.slope) < 0.2 && lowTrend.slope > 0.3) {
          const resistance = Math.max(...recentHighs);
          const breakoutTarget = resistance + (resistance - Math.min(...recentLows)) * 0.8;

          return {
            type: 'ASCENDING_TRIANGLE',
            pattern: this.patterns.ASCENDING_TRIANGLE,
            confidence: 0.75,
            resistance: resistance,
            implications: 'Bullish breakout expected',
            targetPrice: breakoutTarget
          };
        }
        return null;
      }

      detectDescendingTriangle(highs, lows, closes) {
        const window = 25;
        if (highs.length < window) return null;

        const recentHighs = highs.slice(-window);
        const recentLows = lows.slice(-window);

        const highTrend = this.calculateTrendline(recentHighs);
        const lowTrend = this.calculateTrendline(recentLows);

        // Falling resistance, flat support
        if (highTrend.slope < -0.3 && Math.abs(lowTrend.slope) < 0.2) {
          const support = Math.min(...recentLows);
          const breakdownTarget = support - (Math.max(...recentHighs) - support) * 0.8;

          return {
            type: 'DESCENDING_TRIANGLE',
            pattern: this.patterns.DESCENDING_TRIANGLE,
            confidence: 0.75,
            support: support,
            implications: 'Bearish breakdown expected',
            targetPrice: breakdownTarget
          };
        }
        return null;
      }

      detectRisingWedge(highs, lows, closes) {
        const window = 25;
        if (highs.length < window) return null;

        const recentHighs = highs.slice(-window);
        const recentLows = lows.slice(-window);

        const highTrend = this.calculateTrendline(recentHighs);
        const lowTrend = this.calculateTrendline(recentLows);

        // Both rising, but converging
        if (highTrend.slope > 0 && lowTrend.slope > 0 && lowTrend.slope > highTrend.slope) {
          return {
            type: 'RISING_WEDGE',
            pattern: this.patterns.RISING_WEDGE,
            confidence: 0.70,
            implications: 'Bearish reversal - momentum weakening',
            targetPrice: closes[closes.length - 1] * 0.92 // 8% decline expected
          };
        }
        return null;
      }

      detectFallingWedge(highs, lows, closes) {
        const window = 25;
        if (highs.length < window) return null;

        const recentHighs = highs.slice(-window);
        const recentLows = lows.slice(-window);

        const highTrend = this.calculateTrendline(recentHighs);
        const lowTrend = this.calculateTrendline(recentLows);

        // Both falling, but converging
        if (highTrend.slope < 0 && lowTrend.slope < 0 && highTrend.slope > lowTrend.slope) {
          return {
            type: 'FALLING_WEDGE',
            pattern: this.patterns.FALLING_WEDGE,
            confidence: 0.70,
            implications: 'Bullish reversal - selling pressure exhausting',
            targetPrice: closes[closes.length - 1] * 1.08 // 8% rally expected
          };
        }
        return null;
      }

      detectPennant(highs, lows, closes) {
        const window = 20;
        if (highs.length < window) return null;

        const recentHighs = highs.slice(-window);
        const recentLows = lows.slice(-window);

        // Check for strong prior move
        const priorMove = closes.slice(-window - 10, -window);
        const moveStrength = Math.abs(priorMove[priorMove.length - 1] - priorMove[0]) / priorMove[0];

        if (moveStrength > 0.05) { // At least 5% prior move
          const range = Math.max(...recentHighs) - Math.min(...recentLows);
          const priceLevel = closes[closes.length - 1];
          const consolidationRatio = range / priceLevel;

          if (consolidationRatio < 0.05) { // Tight consolidation
            const priorTrend = priorMove[priorMove.length - 1] > priorMove[0] ? 'bullish' : 'bearish';

            return {
              type: 'PENNANT',
              pattern: this.patterns.PENNANT,
              confidence: 0.72,
              implications: `${priorTrend === 'bullish' ? 'Bullish' : 'Bearish'} continuation expected`,
              targetPrice: priorTrend === 'bullish'
                ? closes[closes.length - 1] * 1.05
                : closes[closes.length - 1] * 0.95
            };
          }
        }
        return null;
      }

      detectRectangle(highs, lows, closes) {
        const window = 20;
        if (highs.length < window) return null;

        const recentHighs = highs.slice(-window);
        const recentLows = lows.slice(-window);

        const resistance = Math.max(...recentHighs);
        const support = Math.min(...recentLows);
        const range = resistance - support;
        const priceLevel = closes[closes.length - 1];

        // Check if price has been bouncing within range
        const withinRange = closes.slice(-window).every(c =>
          c >= support * 0.98 && c <= resistance * 1.02
        );

        if (withinRange && range / priceLevel > 0.03 && range / priceLevel < 0.10) {
          return {
            type: 'RECTANGLE',
            pattern: this.patterns.RECTANGLE,
            confidence: 0.65,
            support: support,
            resistance: resistance,
            implications: 'Consolidation - breakout pending',
            targetPrice: null // Depends on breakout direction
          };
        }
        return null;
      }

      detectRoundingBottom(lows, closes) {
        const window = 30;
        if (lows.length < window) return null;

        const recentLows = lows.slice(-window);
        const mid = Math.floor(window / 2);

        // Check for U-shape: declining then rising
        const leftSide = recentLows.slice(0, mid);
        const rightSide = recentLows.slice(mid);

        const leftTrend = this.calculateTrendline(leftSide);
        const rightTrend = this.calculateTrendline(rightSide);

        if (leftTrend.slope < -0.1 && rightTrend.slope > 0.1) {
          const bottom = Math.min(...recentLows);
          const depth = (closes[closes.length - window] - bottom) / bottom;

          return {
            type: 'ROUNDING_BOTTOM',
            pattern: this.patterns.ROUNDING_BOTTOM,
            confidence: 0.73,
            depth: depth,
            implications: 'Gradual bullish reversal',
            targetPrice: closes[closes.length - 1] + (closes[closes.length - 1] - bottom)
          };
        }
        return null;
      }

      detectInverseHeadAndShoulders(highs, lows, closes) {
        const window = 30;
        if (lows.length < window) return null;

        const recentLows = lows.slice(-window);
        const pivotPoints = this.findPivotPoints(recentLows.map(l => -l), 5); // Invert to find lows

        if (pivotPoints.length >= 5) {
          const [leftShoulder, head, rightShoulder] = this.extractHSPattern(pivotPoints);

          if (this.validateHSStructure(leftShoulder, head, rightShoulder)) {
            const neckline = Math.max(...closes.slice(-window, -window + 10));

            return {
              type: 'INVERSE_HEAD_SHOULDERS',
              pattern: this.patterns.INVERSE_HEAD_SHOULDERS,
              confidence: this.calculateHSConfidence(leftShoulder, head, rightShoulder),
              neckline: neckline,
              implications: 'Strong bullish reversal',
              targetPrice: neckline + (neckline - Math.min(...recentLows))
            };
          }
        }
        return null;
      }

      detectFlag(highs, lows, closes) {
        const window = 15;
        if (highs.length < window) return null;

        // Check for strong prior move
        const priorWindow = 10;
        const priorMove = closes.slice(-window - priorWindow, -window);
        const moveStrength = Math.abs(priorMove[priorMove.length - 1] - priorMove[0]) / priorMove[0];

        if (moveStrength > 0.08) { // At least 8% prior move
          const recentCloses = closes.slice(-window);
          const trendline = this.calculateTrendline(recentCloses);

          // Flag should move counter to prior trend with slight slope
          const priorTrend = priorMove[priorMove.length - 1] > priorMove[0] ? 'up' : 'down';
          const flagSlope = trendline.slope;

          if ((priorTrend === 'up' && flagSlope < 0 && flagSlope > -0.5) ||
            (priorTrend === 'down' && flagSlope > 0 && flagSlope < 0.5)) {
            return {
              type: 'FLAG',
              pattern: this.patterns.FLAG,
              confidence: 0.70,
              implications: `${priorTrend === 'up' ? 'Bullish' : 'Bearish'} continuation`,
              targetPrice: priorTrend === 'up'
                ? closes[closes.length - 1] + (priorMove[priorMove.length - 1] - priorMove[0])
                : closes[closes.length - 1] - (priorMove[0] - priorMove[priorMove.length - 1])
            };
          }
        }
        return null;
      }

      // Trendline calculation helper
      calculateTrendline(data) {
        const n = data.length;
        let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;

        for (let i = 0; i < n; i++) {
          sumX += i;
          sumY += data[i];
          sumXY += i * data[i];
          sumXX += i * i;
        }

        const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
        const intercept = (sumY - slope * sumX) / n;

        return { slope, intercept };
      }

      findApex(highTrend, lowTrend) {
        // Find where trendlines intersect
        const x = (lowTrend.intercept - highTrend.intercept) / (highTrend.slope - lowTrend.slope);
        return { x, y: highTrend.slope * x + highTrend.intercept };
      }

      extractHSPattern(pivots) {
        if (pivots.length < 3) return [null, null, null];
        const sorted = [...pivots].sort((a, b) => Math.abs(b.value) - Math.abs(a.value));
        return [
          { height: Math.abs(sorted[1].value), index: sorted[1].index },
          { height: Math.abs(sorted[0].value), index: sorted[0].index },
          { height: Math.abs(sorted[2].value), index: sorted[2].index }
        ];
      }

      validateHSStructure(left, head, right) {
        if (!left || !head || !right) return false;
        // Head should be higher and shoulders similar
        return head.height > left.height &&
          head.height > right.height &&
          Math.abs(left.height - right.height) / left.height < 0.2;
      }

      calculateNeckline(lows, pivots) {
        return Math.min(...lows.slice(pivots[0].index, pivots[pivots.length - 1].index));
      }
    }

    // Initialize global instance
    const patternEngine = new PatternRecognitionEngine();
    window.patternEngine = patternEngine;
    console.log('âœ… Pattern Recognition Engine initialized');

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AI PATTERN ANALYSIS FUNCTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function generatePatternAnalysis(pattern, stock, historicalData) {
      console.log(`ğŸ¤– Generating AI analysis for ${pattern.pattern.name} on ${stock.symbol}`);

      try {
        // Calculate additional technical indicators
        const recentCloses = historicalData.slice(-20).map(d => d.close || d);
        const currentPrice = stock.price;
        const priceChange = ((currentPrice - recentCloses[0]) / recentCloses[0]) * 100;
        const volatility = calculateVolatility(recentCloses);
        const momentum = calculateMomentum(recentCloses);

        // Determine trading signal based on pattern type and market conditions
        let signal = 'HOLD';
        let entryPoint = currentPrice;
        let stopLoss = currentPrice * 0.95;
        let riskLevel = 'Medium';

        if (pattern.pattern.type === 'reversal') {
          if (pattern.implications.includes('Bullish')) {
            signal = priceChange < -5 ? 'BUY' : 'HOLD';
            entryPoint = currentPrice * 0.98;
            stopLoss = currentPrice * 0.92;
            riskLevel = volatility > 3 ? 'High' : 'Medium';
          } else if (pattern.implications.includes('Bearish')) {
            signal = priceChange > 5 ? 'SELL' : 'HOLD';
            stopLoss = currentPrice * 1.08;
            riskLevel = volatility > 3 ? 'High' : 'Medium';
          }
        } else if (pattern.pattern.type === 'continuation') {
          if (pattern.implications.includes('Bullish') && priceChange > 0) {
            signal = 'BUY';
            entryPoint = currentPrice * 1.01;
            stopLoss = currentPrice * 0.95;
            riskLevel = momentum > 2 ? 'Low' : 'Medium';
          } else if (pattern.implications.includes('Bearish') && priceChange < 0) {
            signal = 'SELL';
            stopLoss = currentPrice * 1.05;
            riskLevel = momentum < -2 ? 'Low' : 'Medium';
          }
        }

        // Generate strategy
        const strategy = generateTradingStrategy(pattern, signal, stock, currentPrice, volatility);

        // Generate key factors
        const keyFactors = generateKeyFactors(pattern, stock, volatility, momentum, priceChange);

        // Generate risk note
        const riskNote = generateRiskNote(pattern, riskLevel, volatility);

        // Generate AI summary
        const summary = generateAISummary(pattern, signal, stock, riskLevel, volatility);

        return {
          signal,
          strategy,
          entryPoint,
          stopLoss,
          riskLevel,
          riskNote,
          keyFactors,
          summary,
          timestamp: Date.now()
        };
      } catch (error) {
        console.error('AI analysis generation failed:', error);
        return generateFallbackAnalysis(pattern);
      }
    }

    function generateFallbackAnalysis(pattern) {
      const currentPrice = 100; // Fallback

      return {
        signal: pattern.implications.includes('Bullish') ? 'BUY' :
          pattern.implications.includes('Bearish') ? 'SELL' : 'HOLD',
        strategy: `Monitor this ${pattern.pattern.name} pattern closely. ${pattern.pattern.description}`,
        entryPoint: pattern.targetPrice || currentPrice,
        stopLoss: pattern.targetPrice ? pattern.targetPrice * 0.95 : currentPrice * 0.95,
        riskLevel: 'Medium',
        riskNote: `This ${pattern.pattern.type} pattern has ${(pattern.pattern.reliability * 100).toFixed(0)}% historical reliability.`,
        keyFactors: [
          `${pattern.pattern.name} detected with ${(pattern.confidence * 100).toFixed(0)}% confidence`,
          `Pattern type: ${pattern.pattern.type}`,
          `Historical reliability: ${(pattern.pattern.reliability * 100).toFixed(0)}%`
        ],
        summary: `A ${pattern.pattern.name} pattern has been identified. ${pattern.implications}.`,
        timestamp: Date.now()
      };
    }

    function generateTradingStrategy(pattern, signal, stock, currentPrice, volatility) {
      const patternName = pattern.pattern.name;
      const isHighVolatility = volatility > 3;

      if (signal === 'BUY') {
        if (pattern.pattern.type === 'reversal') {
          return `Wait for confirmation of reversal with a bullish candle close above ${(currentPrice * 1.02).toFixed(2)}. ` +
            `Enter gradually in 2-3 tranches to average entry price. ` +
            `${isHighVolatility ? 'Use wider stops due to high volatility.' : 'Set tight stops below recent lows.'}`;
        } else {
          return `Enter on pullback to support near ${(currentPrice * 0.98).toFixed(2)}. ` +
            `This continuation pattern suggests uptrend will resume. ` +
            `Add to position if breakout confirms with volume.`;
        }
      } else if (signal === 'SELL') {
        if (pattern.pattern.type === 'reversal') {
          return `Consider taking profits or hedging position. ` +
            `Wait for bearish confirmation before shorting. ` +
            `Exit long positions if price breaks below ${(currentPrice * 0.98).toFixed(2)}.`;
        } else {
          return `Downtrend likely to continue. Consider protective puts or exit on rallies. ` +
            `Avoid new long positions until pattern completes or breaks invalidation level.`;
        }
      } else {
        return `${patternName} is forming but needs confirmation. ` +
          `Wait for breakout direction before taking position. ` +
          `Monitor volume and momentum for clues on direction.`;
      }
    }

    function generateKeyFactors(pattern, stock, volatility, momentum, priceChange) {
      const factors = [];

      factors.push(`${pattern.pattern.name} has ${(pattern.pattern.reliability * 100).toFixed(0)}% historical success rate`);
      factors.push(`Current detection confidence: ${(pattern.confidence * 100).toFixed(0)}%`);

      if (pattern.targetPrice) {
        const potentialGain = ((pattern.targetPrice / stock.price - 1) * 100).toFixed(1);
        factors.push(`Technical target suggests ${Math.abs(potentialGain)}% ${potentialGain > 0 ? 'upside' : 'downside'}`);
      }

      if (volatility > 3) {
        factors.push(`High volatility (${volatility.toFixed(1)}%) increases risk but also opportunity`);
      } else if (volatility < 1.5) {
        factors.push(`Low volatility environment - pattern may take longer to play out`);
      }

      if (Math.abs(momentum) > 2) {
        factors.push(`Strong ${momentum > 0 ? 'positive' : 'negative'} momentum supports pattern direction`);
      }

      if (pattern.pattern.type === 'continuation') {
        factors.push(`Continuation patterns typically complete within 1-3 weeks`);
      } else {
        factors.push(`Reversal patterns often mark significant trend changes`);
      }

      return factors;
    }

    function generateRiskNote(pattern, riskLevel, volatility) {
      if (riskLevel === 'High') {
        return `High risk due to ${volatility > 3 ? 'elevated volatility' : 'uncertain market conditions'}. ` +
          `Use position sizing of 1-2% of portfolio maximum.`;
      } else if (riskLevel === 'Medium') {
        return `Moderate risk pattern. Recommended position size: 3-5% of portfolio. ` +
          `Use stop losses and avoid over-leveraging.`;
      } else {
        return `Relatively low-risk setup with favorable risk/reward ratio. ` +
          `Standard position sizing of 5-8% appropriate for conservative traders.`;
      }
    }

    function generateAISummary(pattern, signal, stock, riskLevel, volatility) {
      const patternName = pattern.pattern.name;
      const confidence = (pattern.confidence * 100).toFixed(0);
      const reliability = (pattern.pattern.reliability * 100).toFixed(0);

      let summary = `AI has detected a ${patternName} pattern on ${stock.symbol} with ${confidence}% confidence. `;

      summary += `This ${pattern.pattern.type} pattern has a ${reliability}% historical success rate. `;

      if (signal === 'BUY') {
        summary += `The analysis suggests a bullish opportunity with ${riskLevel.toLowerCase()} risk. `;
        summary += volatility > 3
          ? `High volatility presents both opportunity and risk - position accordingly.`
          : `Market conditions are favorable for this setup.`;
      } else if (signal === 'SELL') {
        summary += `The analysis indicates bearish pressure with ${riskLevel.toLowerCase()} risk. `;
        summary += `Consider defensive positions or wait for better entry points.`;
      } else {
        summary += `The pattern requires further confirmation before taking action. `;
        summary += `Monitor for breakout direction and volume confirmation.`;
      }

      return summary;
    }

    function calculateVolatility(prices) {
      if (prices.length < 2) return 0;
      const returns = [];
      for (let i = 1; i < prices.length; i++) {
        returns.push((prices[i] - prices[i - 1]) / prices[i - 1]);
      }
      const mean = returns.reduce((a, b) => a + b, 0) / returns.length;
      const variance = returns.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / returns.length;
      return Math.sqrt(variance) * Math.sqrt(252) * 100; // Annualized volatility
    }

    function calculateMomentum(prices) {
      if (prices.length < 10) return 0;
      const recent = prices.slice(-5);
      const previous = prices.slice(-10, -5);
      const recentAvg = recent.reduce((a, b) => a + b, 0) / recent.length;
      const previousAvg = previous.reduce((a, b) => a + b, 0) / previous.length;
      return ((recentAvg - previousAvg) / previousAvg) * 100;
    }

    // Make functions globally available
    window.generatePatternAnalysis = generatePatternAnalysis;
    window.generateFallbackAnalysis = generateFallbackAnalysis;
    console.log('âœ… AI Pattern Analysis functions initialized');

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // REAL-TIME NEWS & SENTIMENT ANALYSIS ENGINE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    class SentimentAnalyzer {
      constructor() {
        // Sentiment word dictionaries
        this.positiveWords = new Set([
          'bullish', 'surge', 'rally', 'soar', 'gain', 'profit', 'growth', 'beat', 'exceed', 'strong',
          'upgrade', 'buy', 'outperform', 'success', 'positive', 'innovative', 'breakthrough', 'record',
          'boost', 'jump', 'rise', 'upbeat', 'optimistic', 'confident', 'expansion', 'momentum', 'robust',
          'stellar', 'impressive', 'thriving', 'flourish', 'recover', 'rebound', 'accelerate', 'advance'
        ]);

        this.negativeWords = new Set([
          'bearish', 'plunge', 'crash', 'fall', 'loss', 'decline', 'miss', 'below', 'weak', 'concern',
          'downgrade', 'sell', 'underperform', 'failure', 'negative', 'risk', 'warning', 'layoff',
          'drop', 'tumble', 'slide', 'pessimistic', 'worried', 'fearful', 'contraction', 'slump', 'fragile',
          'disappointing', 'struggle', 'suffer', 'collapse', 'crisis', 'trouble', 'investigation', 'lawsuit'
        ]);
      }

      analyzeSentiment(text) {
        if (!text) return { score: 0, label: 'neutral', confidence: 0 };

        const words = text.toLowerCase().split(/\W+/);
        let positiveCount = 0;
        let negativeCount = 0;

        words.forEach(word => {
          if (this.positiveWords.has(word)) positiveCount++;
          if (this.negativeWords.has(word)) negativeCount++;
        });

        const totalSentimentWords = positiveCount + negativeCount;
        if (totalSentimentWords === 0) {
          return { score: 0, label: 'neutral', confidence: 0 };
        }

        // Score from -100 to +100
        const score = ((positiveCount - negativeCount) / totalSentimentWords) * 100;

        // Confidence based on number of sentiment words found
        const confidence = Math.min(100, (totalSentimentWords / words.length) * 500);

        let label;
        if (score > 20) label = 'bullish';
        else if (score < -20) label = 'bearish';
        else label = 'neutral';

        return {
          score: Math.round(score),
          label,
          confidence: Math.round(confidence),
          positiveWords: positiveCount,
          negativeWords: negativeCount
        };
      }
    }

    class RealtimeNewsManager {
      constructor() {
        this.newsCache = new Map(); // symbol -> news array
        this.sentimentAnalyzer = new SentimentAnalyzer();
        this.subscribers = new Map(); // symbol -> [callbacks]
        this.pollIntervals = new Map(); // symbol -> interval ID
        this.updateFrequency = 30 * 60 * 1000; // 30 minutes (was 5 minutes)
      }

      // Heuristic: boost analyst rating / price-target update headlines.
      // Used to rank the top N articles so the user sees more analyst updates.
      getAnalystUpdateScore(article, symbol) {
        const title = (article?.title || '').toString();
        const description = (article?.description || '').toString();
        const text = `${title} ${description}`.toLowerCase();

        if (!text.trim()) return 0;

        let score = 0;
        const sym = (symbol || '').toLowerCase();
        if (sym && text.includes(sym)) score += 3;

        // Price target / rating language
        if (/(price\s*target|target\s*price|price\s*objective|pt\b|\bpt\s*(raised|cut|increase|decrease)|\btarget\s*(raised|cut)|raises?\s+(its\s+)?price\s*target|lowers?\s+(its\s+)?price\s*target|sets?\s+price\s*target)/i.test(text)) {
          score += 40;
        }
        if (/(upgrade|downgrade|initiates?|initiation|reiterates?|maintains?|resumes?\s+coverage|coverage\s+initiated|raises?|lowers?|cuts?|boosts?)\b/i.test(text)) {
          score += 22;
        }
        if (/(rating|rated|buy|sell|hold|overweight|underweight|outperform|underperform|equal\s*weight|market\s*perform|sector\s*perform|neutral|strong\s*buy|strong\s*sell)\b/i.test(text)) {
          score += 18;
        }
        if (/\banalyst(s)?\b/i.test(text)) score += 12;

        // Often appears in analyst updates
        if (/\b(to|from)\s+\$?\d+(?:\.\d+)?\b/i.test(text)) score += 8;
        if (/\$\d{2,}(?:\.\d+)?\b/.test(text)) score += 4;

        // Major broker names (light signal)
        if (/(goldman|morgan\s*stanley|jp\s*morgan|jpmorgan|barclays|bofa|bank\s*of\s*america|citi|citigroup|deutsche\s*bank|ubs|wells\s*fargo|jefferies|raymond\s*james|piper\s*sandler|baird|susquehanna|wedbush|needham|oppenheimer|bernstein)\b/i.test(text)) {
          score += 6;
        }

        return score;
      }

      async fetchNews(symbol, limit = 10) {
        try {
          console.log(`ğŸ“° Fetching news for ${symbol}...`);

          // Use multiple news sources for comprehensive coverage
          const isBrowser = typeof window !== 'undefined';

          const newsPromises = [
            // FMP Stock News - Primary source (paid API, stock-specific news)
            fetch(`https://financialmodelingprep.com/stable/news/stock?symbols=${symbol}&limit=30&apikey=${API_KEYS.FMP}`)
              .then(r => r.ok ? r.json() : [])
              .catch(() => []),

            // Marketaux - Secondary news source with sentiment
            fetch(`https://api.marketaux.com/v1/news/all?symbols=${symbol}&filter_entities=true&language=en&limit=20&api_token=${API_KEYS.MARKETAUX}`)
              .then(r => r.ok ? r.json() : { data: [] })
              .catch(() => ({ data: [] }))
          ];

          const [fmpStockNews, marketauxResponse] = await Promise.all(newsPromises);

          const marketauxNews = marketauxResponse?.data || [];

          console.log(`ğŸ“Š News sources: FMP Stock News=${fmpStockNews?.length || 0}, Marketaux=${marketauxNews.length}`);

          // Combine and normalize news from all sources
          let allNews = [];

          // Process FMP Stock News (primary source - paid, stock-specific)
          (fmpStockNews || []).forEach(item => {
            allNews.push({
              title: item.title,
              description: item.text || item.content || '',
              url: item.url,
              source: item.site || item.source || 'FMP',
              publishedAt: item.publishedDate || item.date,
              image: item.image,
              symbol: symbol
            });
          });

          // Process Marketaux news (secondary source with built-in sentiment)
          marketauxNews.forEach(item => {
            allNews.push({
              title: item.title,
              description: item.description || item.snippet || '',
              url: item.url,
              source: item.source || 'Marketaux',
              publishedAt: item.published_at,
              image: item.image_url,
              symbol: symbol,
              entities: item.entities || []
            });
          });

          // Remove duplicates by URL
          const uniqueNews = allNews.filter((news, index, self) =>
            index === self.findIndex(n => n.url === news.url)
          );

          // Keep only articles from the last 3 months
          const cutoff = Date.now() - (90 * 24 * 60 * 60 * 1000);
          const recentNews = uniqueNews.filter(n => {
            const t = new Date(n.publishedAt).getTime();
            return Number.isFinite(t) && t >= cutoff;
          });

          // Sort by analyst-update relevance first, then recency
          recentNews.sort((a, b) => {
            const scoreB = this.getAnalystUpdateScore(b, symbol);
            const scoreA = this.getAnalystUpdateScore(a, symbol);
            if (scoreB !== scoreA) return scoreB - scoreA;
            return new Date(b.publishedAt) - new Date(a.publishedAt);
          });

          // Analyze sentiment for each article
          const newsWithSentiment = recentNews.slice(0, limit).map(article => {
            const sentiment = this.sentimentAnalyzer.analyzeSentiment(
              article.title + ' ' + article.description
            );

            return {
              ...article,
              sentiment,
              analystScore: this.getAnalystUpdateScore(article, symbol),
              timestamp: new Date(article.publishedAt).getTime()
            };
          });

          console.log(`âœ… Fetched ${newsWithSentiment.length} news articles for ${symbol}`);

          // Update cache
          this.newsCache.set(symbol, newsWithSentiment);

          // Notify subscribers
          this.notifySubscribers(symbol, newsWithSentiment);

          return newsWithSentiment;

        } catch (error) {
          console.error(`âŒ Error fetching news for ${symbol}:`, error);
          return [];
        }
      }

      getDateDaysAgo(days) {
        const date = new Date();
        date.setDate(date.getDate() - days);
        return date.toISOString().split('T')[0];
      }

      getToday() {
        return new Date().toISOString().split('T')[0];
      }

      subscribe(symbol, callback) {
        if (!this.subscribers.has(symbol)) {
          this.subscribers.set(symbol, []);

          // Start polling for this symbol
          this.startPolling(symbol);
        }

        this.subscribers.get(symbol).push(callback);

        // Send cached news immediately if available
        const cached = this.newsCache.get(symbol);
        if (cached) {
          callback(cached);
        } else {
          // Fetch initial news
          this.fetchNews(symbol);
        }

        console.log(`ğŸ“° Subscribed to news for ${symbol}`);
      }

      unsubscribe(symbol, callback) {
        const callbacks = this.subscribers.get(symbol);
        if (!callbacks) return;

        const index = callbacks.indexOf(callback);
        if (index > -1) {
          callbacks.splice(index, 1);
        }

        // Stop polling if no more subscribers
        if (callbacks.length === 0) {
          this.stopPolling(symbol);
          this.subscribers.delete(symbol);
        }

        console.log(`ğŸ“° Unsubscribed from news for ${symbol}`);
      }

      startPolling(symbol) {
        if (this.pollIntervals.has(symbol)) return;

        const intervalId = setInterval(() => {
          this.fetchNews(symbol);
        }, this.updateFrequency);

        this.pollIntervals.set(symbol, intervalId);
        console.log(`ğŸ“° Started news polling for ${symbol} (every ${this.updateFrequency / 1000 / 60} min)`);
      }

      stopPolling(symbol) {
        const intervalId = this.pollIntervals.get(symbol);
        if (intervalId) {
          clearInterval(intervalId);
          this.pollIntervals.delete(symbol);
          console.log(`ğŸ“° Stopped news polling for ${symbol}`);
        }
      }

      notifySubscribers(symbol, news) {
        const callbacks = this.subscribers.get(symbol);
        if (callbacks) {
          callbacks.forEach(cb => {
            try {
              cb(news);
            } catch (err) {
              console.error(`Error in news callback for ${symbol}:`, err);
            }
          });
        }
      }

      getAggregateSentiment(symbol) {
        const news = this.newsCache.get(symbol);
        if (!news || news.length === 0) {
          return { score: 0, label: 'neutral', count: 0 };
        }

        const totalScore = news.reduce((sum, article) => sum + article.sentiment.score, 0);
        const avgScore = totalScore / news.length;

        let label;
        if (avgScore > 20) label = 'bullish';
        else if (avgScore < -20) label = 'bearish';
        else label = 'neutral';

        return {
          score: Math.round(avgScore),
          label,
          count: news.length,
          bullishCount: news.filter(n => n.sentiment.label === 'bullish').length,
          bearishCount: news.filter(n => n.sentiment.label === 'bearish').length,
          neutralCount: news.filter(n => n.sentiment.label === 'neutral').length
        };
      }

      stopAll() {
        this.pollIntervals.forEach(id => clearInterval(id));
        this.pollIntervals.clear();
        this.subscribers.clear();
        console.log('ğŸ“° Stopped all news polling');
      }
    }

    // Initialize news manager
    const newsManager = new RealtimeNewsManager();
    window.newsManager = newsManager;
    console.log('âœ… News Manager initialized');

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PORTFOLIO TRACKER & P&L CALCULATOR
    // Cost: FREE - Stores locally in browser
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    class PortfolioManager {
      constructor() {
        this.holdings = this.loadPortfolio();
        this.priceCache = new Map(); // symbol -> current price
      }

      loadPortfolio() {
        try {
          const saved = localStorage.getItem('retailedge_portfolio');
          return saved ? JSON.parse(saved) : [];
        } catch (error) {
          console.error('âŒ Error loading portfolio:', error);
          return [];
        }
      }

      savePortfolio() {
        try {
          localStorage.setItem('retailedge_portfolio', JSON.stringify(this.holdings));
          console.log('ğŸ’¾ Portfolio saved');
        } catch (error) {
          console.error('âŒ Error saving portfolio:', error);
        }
      }

      addHolding(symbol, quantity, buyPrice, buyDate = new Date().toISOString()) {
        const holding = {
          id: Date.now() + Math.random(),
          symbol: symbol.toUpperCase(),
          quantity: parseFloat(quantity),
          buyPrice: parseFloat(buyPrice),
          buyDate: buyDate,
          addedAt: new Date().toISOString()
        };

        this.holdings.push(holding);
        this.savePortfolio();
        console.log(`âœ… Added ${quantity} shares of ${symbol} @ $${buyPrice}`);
        return holding;
      }

      updateHolding(id, updates) {
        const index = this.holdings.findIndex(h => h.id === id);
        if (index !== -1) {
          this.holdings[index] = { ...this.holdings[index], ...updates };
          this.savePortfolio();
          console.log(`âœ… Updated holding ${id}`);
          return this.holdings[index];
        }
        return null;
      }

      removeHolding(id) {
        const index = this.holdings.findIndex(h => h.id === id);
        if (index !== -1) {
          const removed = this.holdings.splice(index, 1)[0];
          this.savePortfolio();
          console.log(`âœ… Removed ${removed.symbol} from portfolio`);
          return removed;
        }
        return null;
      }

      async updatePrices(stocksData) {
        // Update current prices from stock data
        stocksData.forEach(stock => {
          this.priceCache.set(stock.symbol, stock.price);
        });
      }

      calculatePortfolioMetrics(stocksData) {
        if (this.holdings.length === 0) {
          return {
            totalValue: 0,
            totalCost: 0,
            totalGainLoss: 0,
            totalGainLossPercent: 0,
            holdings: []
          };
        }

        // Update prices
        this.updatePrices(stocksData);

        let totalValue = 0;
        let totalCost = 0;

        const holdingsWithMetrics = this.holdings.map(holding => {
          const currentPrice = this.priceCache.get(holding.symbol) || holding.buyPrice;
          const stockData = stocksData.find(s => s.symbol === holding.symbol);

          const costBasis = holding.quantity * holding.buyPrice;
          const currentValue = holding.quantity * currentPrice;
          const gainLoss = currentValue - costBasis;
          const gainLossPercent = ((currentPrice - holding.buyPrice) / holding.buyPrice) * 100;

          totalValue += currentValue;
          totalCost += costBasis;

          return {
            ...holding,
            currentPrice,
            costBasis,
            currentValue,
            gainLoss,
            gainLossPercent,
            dayChange: stockData?.changePct || 0,
            dayChangeValue: stockData ? (currentPrice * (stockData.changePct / 100) * holding.quantity) : 0
          };
        });

        const totalGainLoss = totalValue - totalCost;
        const totalGainLossPercent = totalCost > 0 ? (totalGainLoss / totalCost) * 100 : 0;

        return {
          totalValue,
          totalCost,
          totalGainLoss,
          totalGainLossPercent,
          holdings: holdingsWithMetrics,
          holdingsCount: this.holdings.length
        };
      }

      getTopPerformers(metrics, limit = 3) {
        return [...metrics.holdings]
          .sort((a, b) => b.gainLossPercent - a.gainLossPercent)
          .slice(0, limit);
      }

      getWorstPerformers(metrics, limit = 3) {
        return [...metrics.holdings]
          .sort((a, b) => a.gainLossPercent - b.gainLossPercent)
          .slice(0, limit);
      }

      exportToCSV() {
        if (this.holdings.length === 0) return null;

        const headers = ['Symbol', 'Quantity', 'Buy Price', 'Buy Date', 'Current Price', 'Current Value', 'Gain/Loss', 'Gain/Loss %'];
        const metrics = this.calculatePortfolioMetrics([]);

        const rows = metrics.holdings.map(h => [
          h.symbol,
          h.quantity,
          h.buyPrice.toFixed(2),
          new Date(h.buyDate).toLocaleDateString(),
          h.currentPrice.toFixed(2),
          h.currentValue.toFixed(2),
          h.gainLoss.toFixed(2),
          h.gainLossPercent.toFixed(2) + '%'
        ]);

        return [headers, ...rows].map(row => row.join(',')).join('\n');
      }
    }

    // Initialize portfolio manager
    const portfolioManager = new PortfolioManager();
    window.portfolioManager = portfolioManager;
    console.log('âœ… Portfolio Manager initialized');

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CLAUDE AI STOCK PREDICTION ENGINE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    class ClaudeStockAnalyzer {
      constructor() {
        this.analysisCache = new Map();
        this.cacheExpiry = 60 * 60 * 1000; // 1 hour
      }

      async analyzeStock(stockData) {
        const cacheKey = `${stockData.symbol}_${Math.floor(Date.now() / this.cacheExpiry)}`;

        if (this.analysisCache.has(cacheKey)) {
          console.log(`âœ… Using cached AI analysis for ${stockData.symbol}`);
          return this.analysisCache.get(cacheKey);
        }

        console.log(`ğŸ¤– Requesting AI analysis for ${stockData.symbol}...`);

        try {
          const analysis = await this.callClaudeAPI(stockData);
          this.analysisCache.set(cacheKey, analysis);
          console.log(`âœ… AI analysis complete for ${stockData.symbol}`);
          return analysis;
        } catch (error) {
          console.error('âŒ AI Analysis failed:', error.message || error);
          console.log('ğŸ”„ Falling back to rule-based analysis...');
          const fallback = this.getFallbackAnalysis(stockData);
          // Cache fallback too (but shorter time)
          this.analysisCache.set(cacheKey, fallback);
          return fallback;
        }
      }

      async callClaudeAPI(stockData) {
        const prompt = this.buildAnalysisPrompt(stockData);

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // âš ï¸ IMPORTANT: REPLACE THE API KEY BELOW WITH YOUR OWN KEY
        // Get your key from: https://console.anthropic.com/settings/keys
        // The key below may be invalid or rate-limited
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        console.log('ğŸ“¡ Making API request to Claude via backend...');

        // Call local backend server that securely handles Claude API
        const response = await fetchWithRetry(`${API_BASE_URL}/api/claude`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          timeoutMs: 20000,
          retries: 1,
          body: JSON.stringify({
            messages: [{ role: "user", content: prompt }]
          })
        }).catch(err => {
          console.error('âŒ Failed to connect to backend server:', err);
          console.log('ğŸ’¡ Make sure Node.js backend is running on port 3002');
          throw new Error('Backend server not responding. Please ensure the Node.js server is running.');
        });

        console.log(`ğŸ“Š API Response status: ${response.status}`);

        if (!response.ok) {
          const errorText = await response.text().catch(() => 'Unknown error');
          console.error(`âŒ API Error ${response.status}:`, errorText);
          console.error(`âŒ Full error details:`, {
            status: response.status,
            statusText: response.statusText,
            url: response.url,
            errorBody: errorText
          });
          throw new Error(`API Error: ${response.status} - ${errorText}`);
        }

        const data = await response.json();
        console.log('âœ… API response received, parsing...');
        const analysisText = data.content[0].text;
        return this.parseClaudeResponse(analysisText, stockData);
      }

      buildAnalysisPrompt(stock) {
        return `You are an expert stock analyst. Analyze this stock and provide predictions in JSON format.

STOCK DATA:
Symbol: ${stock.symbol}
Company: ${stock.companyName || stock.symbol}
Current Price: $${stock.price}
Change: ${stock.changesPercentage || 0}%

FUNDAMENTALS:
- P/E Ratio: ${stock.pe || 'N/A'}
- EPS: $${stock.eps || 'N/A'}
- Market Cap: ${this.formatNumber(stock.marketCap)}
- ROE: ${stock.roe || 'N/A'}%

TECHNICAL (if available):
- RSI: ${stock.rsi || 'N/A'}
- SMA 50: ${stock.sma50 || 'N/A'}
- SMA 200: ${stock.sma200 || 'N/A'}

ANALYST:
- Rating: ${stock.rating || 'N/A'}
- Price Target: ${stock.priceTarget || 'N/A'}

Provide analysis in this EXACT JSON format (no markdown):
{
  "predictions": {
    "oneDay": {"price": <number>, "change": <percentage>, "confidence": <0-100>},
    "sevenDay": {"price": <number>, "change": <percentage>, "confidence": <0-100>},
    "thirtyDay": {"price": <number>, "change": <percentage>, "confidence": <0-100>}
  },
  "recommendation": "<BUY|HOLD|SELL>",
  "recommendationStrength": <1-10>,
  "targetPrice": <number>,
  "stopLoss": <number>,
  "keyInsights": ["<insight 1>", "<insight 2>", "<insight 3>"],
  "risks": ["<risk 1>", "<risk 2>"],
  "opportunities": ["<opportunity 1>", "<opportunity 2>"],
  "technicalScore": <0-100>,
  "fundamentalScore": <0-100>,
  "sentimentScore": <0-100>,
  "summary": "<2-3 sentence summary>"
}

Be realistic and conservative. Base confidence on data quality.`;
      }

      parseClaudeResponse(text, stockData) {
        try {
          const jsonText = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
          const analysis = JSON.parse(jsonText);
          analysis.symbol = stockData.symbol;
          analysis.currentPrice = stockData.price;
          analysis.timestamp = Date.now();
          analysis.aiModel = 'claude-sonnet-4';
          return analysis;
        } catch (error) {
          console.error('âŒ Parse error:', error);
          return this.getFallbackAnalysis(stockData);
        }
      }

      getFallbackAnalysis(stock) {
        const price = stock.price || 0;
        const pe = stock.pe || 0;
        const rsi = stock.rsi || 50;

        let recommendation = 'HOLD';
        let strength = 5;

        if (pe > 0 && pe < 15 && rsi < 30) {
          recommendation = 'BUY';
          strength = 8;
        } else if (pe > 30 && rsi > 70) {
          recommendation = 'SELL';
          strength = 7;
        }

        return {
          predictions: {
            oneDay: { price: price * 1.001, change: 0.1, confidence: 30 },
            sevenDay: { price: price * 1.005, change: 0.5, confidence: 25 },
            thirtyDay: { price: price * 1.02, change: 2.0, confidence: 20 }
          },
          recommendation,
          recommendationStrength: strength,
          targetPrice: price * 1.10,
          stopLoss: price * 0.95,
          keyInsights: ["AI analysis temporarily unavailable", "Using basic technical analysis"],
          risks: ["Limited analysis due to AI unavailability"],
          opportunities: ["Manual analysis recommended"],
          technicalScore: 50,
          fundamentalScore: 50,
          sentimentScore: 50,
          summary: "AI analysis unavailable. Basic metrics suggest neutral stance. Manual review recommended.",
          symbol: stock.symbol,
          currentPrice: price,
          timestamp: Date.now(),
          aiModel: 'fallback'
        };
      }

      formatNumber(num) {
        if (!num) return 'N/A';
        if (num >= 1e12) return (num / 1e12).toFixed(2) + 'T';
        if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
        if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
        return num.toLocaleString();
      }
    }

    const aiAnalyzer = new ClaudeStockAnalyzer();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ERROR BOUNDARY COMPONENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    class ErrorBoundary extends React.Component {
      constructor(props) {
        super(props);
        this.state = { hasError: false, error: null };
      }

      static getDerivedStateFromError(error) {
        return { hasError: true, error };
      }

      componentDidCatch(error, errorInfo) {
        console.error('ErrorBoundary caught error:', error, errorInfo);
      }

      render() {
        if (this.state.hasError) {
          return (
            <div className="min-h-screen flex items-center justify-center p-6">
              <div className="glass-elevated rounded-2xl p-8 max-w-md text-center">
                <div className="text-4xl mb-4 text-red-400">âš ï¸</div>
                <h3 className="text-xl font-bold text-white mb-3">Something went wrong</h3>
                <p className="text-slate-400 mb-6">We encountered an error while loading this component.</p>
                <button
                  onClick={() => window.location.reload()}
                  className="px-6 py-3 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg font-semibold"
                >
                  Reload Application
                </button>
              </div>
            </div>
          );
        }

        return this.props.children;
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AI SCORING ENGINE (DETERMINISTIC)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
    const num = (v, d = 0) => {
      const x = typeof v === "number" ? v : parseFloat(v);
      return Number.isFinite(x) ? x : d;
    };

    // Compute unified AI score (0-100) from stock fundamentals + technicals
    function computeAIScore(stock) {
      // Extract metrics safely with defaults
      const pe = num(stock.pe, 0);
      const roe = num(stock.roe, 0);
      const rsi = num(stock.rsi, 50);
      const changePct = num(stock.changePct, 0);
      const marketCap = num(stock.marketCap, 0);

      // --- FUNDAMENTALS SUBSCORE (0-100) ---
      let fundamental = 50; // Start neutral

      // P/E: Lower is better (value), but 0 is invalid
      if (pe > 0) {
        if (pe < 15) fundamental += 20;
        else if (pe < 20) fundamental += 12;
        else if (pe < 25) fundamental += 5;
        else if (pe > 40) fundamental -= 15;
        else if (pe > 30) fundamental -= 8;
      }

      // ROE: Higher is better (quality)
      if (roe > 25) fundamental += 20;
      else if (roe > 20) fundamental += 15;
      else if (roe > 15) fundamental += 10;
      else if (roe > 10) fundamental += 5;
      else if (roe < 5) fundamental -= 10;

      // Market Cap: Prefer established companies for stability
      if (marketCap > 10e9) fundamental += 8; // Large cap bonus
      else if (marketCap < 1e9) fundamental -= 5; // Small cap penalty

      fundamental = clamp(fundamental, 0, 100);

      // --- TECHNICALS SUBSCORE (0-100) ---
      let technical = 50; // Start neutral

      // RSI: Sweet spot is 35-65, avoid extremes
      if (rsi >= 35 && rsi <= 65) technical += 15; // Healthy range
      else if (rsi < 30) technical += 10; // Oversold opportunity
      else if (rsi > 70) technical -= 12; // Overbought risk

      // Momentum: Recent price change
      if (changePct > 5) technical += 12; // Strong uptrend
      else if (changePct > 2) technical += 6; // Positive momentum
      else if (changePct < -5) technical -= 10; // Downtrend
      else if (changePct < -2) technical -= 5; // Weak

      technical = clamp(technical, 0, 100);

      // --- RISK SUBSCORE (0-100, higher = more risk) ---
      let risk = 50; // Start neutral

      // High P/E = valuation risk
      if (pe > 40) risk += 15;
      else if (pe > 30) risk += 8;

      // Extreme RSI = volatility risk
      if (rsi > 75 || rsi < 25) risk += 10;

      // Recent sharp decline = momentum risk
      if (changePct < -10) risk += 12;

      risk = clamp(risk, 0, 100);

      // --- COMBINE INTO FINAL SCORE (0-100) ---
      // Weights: Fundamentals 55%, Technicals 35%, Risk penalty 10%
      const rawScore = (0.55 * fundamental) + (0.35 * technical) + (0.10 * (100 - risk));
      const score = clamp(Math.round(rawScore), 0, 100);

      return {
        score,
        subscores: { fundamental, technical, risk }
      };
    }

    // Determine verdict from score
    function verdictFromScore(score) {
      if (score >= 80) return { verdict: "STRONG BUY", stance: "bullish" };
      if (score >= 67) return { verdict: "BUY", stance: "bullish" };
      if (score >= 55) return { verdict: "HOLD", stance: "neutral" };
      if (score >= 45) return { verdict: "REDUCE", stance: "bearish" };
      return { verdict: "SELL", stance: "bearish" };
    }

    // Calculate confidence from score (deterministic)
    function confidenceFromScore(score, subscores) {
      // Base confidence increases with distance from 50 (neutral)
      const base = 40 + Math.abs(score - 50) * 1.1; // Range: 40-95

      // Penalty for high risk
      const riskPenalty = (subscores?.risk ?? 50) * 0.15; // 0-15 penalty

      const confidence = clamp(Math.round(base - riskPenalty), 35, 92);
      return confidence;
    }

    // Generate complete AI analysis with factors
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AI ANALYSIS CACHE - Avoid recalculating for same stock data
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const aiAnalysisCache = new Map();
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DEBOUNCED LOCALSTORAGE - Batch writes to prevent blocking
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const debouncedLocalStorage = {
      timers: {},
      pendingWrites: {},
      
      setItem(key, value, delay = 1000) {
        // Store the value to write
        this.pendingWrites[key] = value;
        
        // Clear existing timer
        if (this.timers[key]) {
          clearTimeout(this.timers[key]);
        }
        
        // Set new timer
        this.timers[key] = setTimeout(() => {
          try {
            localStorage.setItem(key, this.pendingWrites[key]);
            delete this.pendingWrites[key];
            delete this.timers[key];
          } catch (e) {
            console.warn('localStorage write failed:', e);
          }
        }, delay);
      },
      
      setItemImmediate(key, value) {
        // Immediate write (for critical data)
        if (this.timers[key]) {
          clearTimeout(this.timers[key]);
          delete this.timers[key];
        }
        try {
          localStorage.setItem(key, value);
          delete this.pendingWrites[key];
        } catch (e) {
          console.warn('localStorage write failed:', e);
        }
      },
      
      flush() {
        // Write all pending immediately
        Object.keys(this.pendingWrites).forEach(key => {
          try {
            localStorage.setItem(key, this.pendingWrites[key]);
          } catch (e) {
            console.warn('localStorage flush failed:', e);
          }
        });
        Object.keys(this.timers).forEach(key => clearTimeout(this.timers[key]));
        this.timers = {};
        this.pendingWrites = {};
      }
    };
    
    // Flush on page unload
    window.addEventListener('beforeunload', () => debouncedLocalStorage.flush());
    
    function generateAIAnalysis(stock) {
      // Check cache first (use symbol + price + changePct as key)
      const cacheKey = `${stock.symbol}_${stock.price}_${stock.changePct}_${stock.pe}_${stock.roe}`;
      if (aiAnalysisCache.has(cacheKey)) {
        return aiAnalysisCache.get(cacheKey);
      }
      
      const { score, subscores } = computeAIScore(stock);
      const { verdict, stance } = verdictFromScore(score);
      const confidence = confidenceFromScore(score, subscores);

      const bullFactors = [];
      const bearFactors = [];

      // Extract metrics with more data points
      const pe = num(stock.pe, 0);
      const roe = num(stock.roe, 0);
      const rsi = num(stock.rsi, 50);
      const changePct = num(stock.changePct, 0);
      const price = num(stock.price, 0);
      const marketCap = num(stock.marketCap, 0);
      const eps = num(stock.eps, 0);
      const growth = num(stock.revenueGrowth, 0);
      const debt = num(stock.debtToEquity, 0);
      const margin = num(stock.profitMargin, 0);
      const beta = num(stock.beta, 1);
      const volume = num(stock.volume, 0);
      const avgVolume = num(stock.avgVolume, 1);
      
      // Advanced calculations
      const peg = growth > 0 && pe > 0 ? pe / growth : null; // PEG ratio
      const volumeRatio = avgVolume > 0 ? volume / avgVolume : 1;
      const isMegaCap = marketCap > 200e9; // $200B+
      const isLargeCap = marketCap > 10e9; // $10B+
      const isGrowthStock = growth > 15;
      const isValueStock = pe > 0 && pe < 15;

      // Helper: importance ranking for factor sorting
      const importanceRank = { high: 3, medium: 2, low: 1 };

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ENHANCED BULLISH FACTORS (More Sophisticated)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      // Deep Value + Quality Combo (Warren Buffett style)
      if (pe > 0 && pe < 12 && roe > 18 && debt < 0.5 && growth > 8) {
        bullFactors.push({
          factor: "Quality Deep Value",
          detail: `Exceptional combination: Low P/E (${pe.toFixed(1)}), strong ROE (${roe.toFixed(1)}%), low debt (${debt.toFixed(2)}Ã—), and ${growth.toFixed(1)}% growth.`,
          importance: "high",
          category: "fundamental"
        });
      }
      
      // PEG Ratio Value (Growth at reasonable price)
      else if (peg !== null && peg < 1 && peg > 0.1 && growth > 10) {
        bullFactors.push({
          factor: "Growth at Reasonable Price",
          detail: `PEG ratio of ${peg.toFixed(2)} indicates growth (${growth.toFixed(1)}%) is underpriced relative to P/E (${pe.toFixed(1)}).`,
          importance: "high",
          category: "fundamental"
        });
      }
      
      // Classic Value Play
      else if (pe > 0 && pe < 15) {
        bullFactors.push({
          factor: "Attractive Valuation",
          detail: `P/E ratio of ${pe.toFixed(1)} suggests undervaluation vs. market average (${isMegaCap ? 'mega-cap' : isLargeCap ? 'large-cap' : 'mid-cap'} stock).`,
          importance: "high",
          category: "fundamental"
        });
      }

      // Profitability + Efficiency
      if (roe > 25 && margin > 15) {
        bullFactors.push({
          factor: "High-Quality Business Model",
          detail: `Exceptional ROE (${roe.toFixed(1)}%) with strong profit margins (${margin.toFixed(1)}%) indicates pricing power and efficiency.`,
          importance: "high",
          category: "fundamental"
        });
      } else if (roe > 20) {
        bullFactors.push({
          factor: "Superior Capital Efficiency",
          detail: `ROE of ${roe.toFixed(1)}% demonstrates exceptional profitability.`,
          importance: "high",
          category: "fundamental"
        });
      }
      
      // Balance Sheet Strength
      if (debt < 0.3 && roe > 15 && marketCap > 1e9) {
        bullFactors.push({
          factor: "Fortress Balance Sheet",
          detail: `Low debt-to-equity (${debt.toFixed(2)}Ã—) with strong ROE (${roe.toFixed(1)}%) provides stability and flexibility.`,
          importance: "medium",
          category: "fundamental"
        });
      }

      // Aggressive Growth
      if (growth > 25 && roe > 10) {
        bullFactors.push({
          factor: "High-Growth Story",
          detail: `Revenue growing ${growth.toFixed(1)}% while maintaining ${roe.toFixed(1)}% ROE shows strong market position.`,
          importance: "high",
          category: "fundamental"
        });
      }

      // Technical Strength
      if (rsi > 55 && rsi < 68 && changePct > 2 && changePct < 8) {
        bullFactors.push({
          factor: "Healthy Bullish Momentum",
          detail: `RSI at ${rsi.toFixed(0)} with ${changePct.toFixed(1)}% gain shows controlled uptrend without overextension.`,
          importance: "medium",
          category: "technical"
        });
      } else if (rsi < 35 && changePct > -10) {
        bullFactors.push({
          factor: "Oversold Technical Setup",
          detail: `RSI of ${rsi.toFixed(0)} indicates potential mean reversion opportunity (not in freefall).`,
          importance: "medium",
          category: "technical"
        });
      } else if (changePct > 5) {
        bullFactors.push({
          factor: "Strong Momentum",
          detail: `Recent price gain of ${changePct.toFixed(1)}% shows buying pressure.`,
          importance: "medium",
          category: "technical"
        });
      }
      
      // Volume Confirmation
      if (volumeRatio > 1.5 && changePct > 3) {
        bullFactors.push({
          factor: "Volume-Confirmed Rally",
          detail: `Volume ${(volumeRatio * 100 - 100).toFixed(0)}% above average confirms institutional interest in the move.`,
          importance: "medium",
          category: "technical"
        });
      }
      
      // Low Volatility + Growth (Steady compounder)
      if (beta < 0.9 && roe > 15 && growth > 10 && debt < 0.5) {
        bullFactors.push({
          factor: "Defensive Growth Compounder",
          detail: `Low volatility (Î² ${beta.toFixed(2)}) with ${growth.toFixed(1)}% growth and ${roe.toFixed(1)}% ROE â€” rare combination.`,
          importance: "high",
          category: "fundamental"
        });
      }

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ENHANCED BEARISH FACTORS (Better Risk Detection)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      
      // Value Trap Detection
      if (pe > 0 && pe < 10 && roe < 8 && growth < 0) {
        bearFactors.push({
          factor: "Potential Value Trap",
          detail: `Low P/E (${pe.toFixed(1)}) with poor ROE (${roe.toFixed(1)}%) and negative growth (${growth.toFixed(1)}%) suggests structural problems.`,
          importance: "high",
          category: "fundamental"
        });
      }
      
      // Expensive Growth with Execution Risk
      else if (pe > 50 && peg !== null && peg > 3 && growth < 25) {
        bearFactors.push({
          factor: "Overpriced Relative to Growth",
          detail: `PEG of ${peg.toFixed(1)} indicates P/E (${pe.toFixed(1)}) is too high for ${growth.toFixed(1)}% growth rate.`,
          importance: "high",
          category: "fundamental"
        });
      }
      
      // Classic Overvaluation
      else if (pe > 35) {
        bearFactors.push({
          factor: "Premium Valuation Risk",
          detail: `P/E ratio of ${pe.toFixed(1)} leaves little margin for safety${isGrowthStock ? ', even for growth stock' : ''}.`,
          importance: "high",
          category: "fundamental"
        });
      }

      // Deteriorating Fundamentals
      if (roe < 8 && roe > 0 && growth < 5) {
        bearFactors.push({
          factor: "Weak Business Economics",
          detail: `ROE of ${roe.toFixed(1)}% with ${growth.toFixed(1)}% growth suggests competitive disadvantage or poor management.`,
          importance: "high",
          category: "fundamental"
        });
      } else if (roe < 8 && roe > 0) {
        bearFactors.push({
          factor: "Below-Average Returns",
          detail: `ROE of ${roe.toFixed(1)}% suggests weak capital efficiency.`,
          importance: "medium",
          category: "fundamental"
        });
      }
      
      // Debt Warning
      if (debt > 2 && roe < 12) {
        bearFactors.push({
          factor: "Elevated Leverage Risk",
          detail: `High debt-to-equity (${debt.toFixed(2)}Ã—) with modest ROE (${roe.toFixed(1)}%) limits financial flexibility.`,
          importance: "high",
          category: "fundamental"
        });
      } else if (debt > 3) {
        bearFactors.push({
          factor: "Balance Sheet Concern",
          detail: `Debt-to-equity of ${debt.toFixed(2)}Ã— is elevated â€” vulnerable to rising rates or earnings miss.`,
          importance: "medium",
          category: "fundamental"
        });
      }
      
      // Low Margins + High Valuation
      if (margin < 5 && pe > 20) {
        bearFactors.push({
          factor: "Thin Margins at Rich Valuation",
          detail: `Profit margin of ${margin.toFixed(1)}% with P/E ${pe.toFixed(1)} offers little cushion for disappointment.`,
          importance: "medium",
          category: "fundamental"
        });
      }

      // Technical Warnings
      if (rsi > 72 && changePct > 10) {
        bearFactors.push({
          factor: "Severely Overbought",
          detail: `RSI of ${rsi.toFixed(0)} with ${changePct.toFixed(1)}% rally suggests high probability of sharp pullback.`,
          importance: "high",
          category: "technical"
        });
      } else if (rsi > 72) {
        bearFactors.push({
          factor: "Overbought Condition",
          detail: `RSI of ${rsi.toFixed(0)} increases probability of near-term pullback.`,
          importance: "medium",
          category: "technical"
        });
      }
      
      // Falling Knife
      if (changePct < -15 && volumeRatio > 2) {
        bearFactors.push({
          factor: "Capitulation Selling",
          detail: `Down ${Math.abs(changePct).toFixed(1)}% on heavy volume suggests panic or negative catalyst â€” wait for stabilization.`,
          importance: "high",
          category: "technical"
        });
      } else if (changePct < -5) {
        bearFactors.push({
          factor: "Negative Momentum",
          detail: `Recent decline of ${changePct.toFixed(1)}% signals selling pressure.`,
          importance: "medium",
          category: "technical"
        });
      }
      
      // High Volatility Risk
      if (beta > 1.8 && marketCap < 10e9) {
        bearFactors.push({
          factor: "Elevated Volatility Risk",
          detail: `Beta of ${beta.toFixed(2)} with smaller market cap (${(marketCap/1e9).toFixed(1)}B) amplifies downside risk.`,
          importance: "medium",
          category: "risk"
        });
      }

      // Ensure at least one factor each
      if (!bullFactors.length) {
        bullFactors.push({
          factor: "No Major Red Flags",
          detail: "Fundamental and technical signals are generally supportive.",
          importance: "low",
          category: "fundamental"
        });
      }

      if (!bearFactors.length) {
        bearFactors.push({
          factor: "Normal Risk Profile",
          detail: "Risks appear within typical range for this asset.",
          importance: "low",
          category: "fundamental"
        });
      }

      // Executive Summary
      const execSummary = `${stock.symbol} scores ${score}/100 with ${verdict} rating (${confidence}% confidence). Fundamentals: ${Math.round(subscores.fundamental)}/100, Technicals: ${Math.round(subscores.technical)}/100, Risk: ${Math.round(subscores.risk)}/100.`;

      // â”€â”€ Score drivers (teaching layer) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const sortedBull = [...bullFactors].sort((a, b) => (importanceRank[b.importance] || 0) - (importanceRank[a.importance] || 0));
      const sortedBear = [...bearFactors].sort((a, b) => (importanceRank[b.importance] || 0) - (importanceRank[a.importance] || 0));
      const topDrivers = {
        positive: sortedBull.slice(0, 2),
        negative: sortedBear.slice(0, 2),
      };

      // â”€â”€ Reassurance / emotional safety cue â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      let reassurance = "Nothing here suggests unusual urgency â€” use this as a starting point and sanity-check with your own research.";
      if ((subscores?.risk ?? 50) >= 70) reassurance = "Risk signals look elevated â€” size your exposure carefully and double-check the bear cases before acting.";
      else if (confidence <= 45) reassurance = "Signals are mixed (low alignment) â€” it's normal to place this on a watchlist and wait for clarity.";

      // â”€â”€ AI Takeaway (interpretive closure) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const valuationFlag = pe > 35 ? "valuation looks stretched" : (pe > 0 && pe < 15 ? "valuation looks supportive" : "valuation looks mixed");
      const timingFlag = rsi > 72 ? "short-term timing looks stretched" : (rsi < 35 ? "short-term timing may be favorable" : "timing looks neutral");
      const qualityFlag = roe > 20 ? "business quality looks strong" : (roe > 0 && roe < 8 ? "quality looks weaker than average" : "quality looks mixed");

      let takeaway = "";
      if (verdict === "STRONG BUY" || verdict === "BUY") {
        takeaway = `Overall, the balance of signals leans constructive: ${qualityFlag}, ${valuationFlag}, and ${timingFlag}. This looks more suitable for patient investors than for quick trades.`;
      } else if (verdict === "HOLD") {
        takeaway = `Overall, signals are mixed: ${qualityFlag} with ${valuationFlag} and ${timingFlag}. This is a reasonable watchlist candidate while you wait for a better price, clearer trend, or new fundamentals.`;
      } else {
        takeaway = `Overall, the risk/reward looks less attractive right now: ${qualityFlag} with ${valuationFlag} and ${timingFlag}. Consider treating this as "research further" unless your thesis is very strong.`;
      }

      // â”€â”€ Watchlist guidance (what to monitor next) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const watchMetric = (sortedBear[0]?.category === "technical" || rsi > 70 || rsi < 30) ? "trend/RSI and price action" :
        (sortedBear[0]?.category === "fundamental" || pe > 30) ? "earnings + valuation (P/E) and margins" :
          "ROE/margins and revenue growth";
      const lastEarningsDate = stock?.lastEarnings?.date || stock?.lastEarnings?.fiscalDateEnding || null;

      const watchlistGuidance = {
        headline: "What to watch next",
        items: [
          { label: "Next check-in", value: lastEarningsDate ? `Review after the next earnings cycle (last reported: ${lastEarningsDate}).` : "Review after the next earnings cycle." },
          { label: "Key metric", value: watchMetric },
          { label: "Main risk to monitor", value: (sortedBear[0]?.factor ? sortedBear[0].factor : "unexpected earnings / guidance changes") }
        ]
      };

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ENHANCED: Detailed Risk Assessment with Reasons
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const riskReasons = [];
      let riskLevel = 'Medium';
      
      // High volatility
      if (beta > 1.8) {
        riskReasons.push(`High volatility (Î² ${beta.toFixed(2)})`);
        riskLevel = 'High';
      } else if (beta > 1.4) {
        riskReasons.push(`Above-average volatility (Î² ${beta.toFixed(2)})`);
      }
      
      // Debt concerns
      if (debt > 2) {
        riskReasons.push(`Elevated debt (${debt.toFixed(2)}Ã— equity)`);
        riskLevel = 'High';
      } else if (debt > 1.5) {
        riskReasons.push(`Moderate debt (${debt.toFixed(2)}Ã— equity)`);
      }
      
      // Valuation risk
      if (pe > 50) {
        riskReasons.push(`Extreme valuation (P/E ${pe.toFixed(1)})`);
        riskLevel = 'High';
      } else if (pe > 35) {
        riskReasons.push(`Premium valuation (P/E ${pe.toFixed(1)})`);
        if (riskLevel === 'Medium') riskLevel = 'Medium-High';
      }
      
      // Profitability concerns
      if (roe < 5 && roe > 0) {
        riskReasons.push(`Weak profitability (ROE ${roe.toFixed(1)}%)`);
        if (riskLevel === 'Medium') riskLevel = 'Medium-High';
      }
      
      // Negative growth
      if (growth < -10) {
        riskReasons.push(`Revenue declining ${Math.abs(growth).toFixed(1)}%`);
        riskLevel = 'High';
      }
      
      // Technical breakdown
      if (changePct < -15) {
        riskReasons.push(`Severe downtrend (-${Math.abs(changePct).toFixed(1)}%)`);
        if (riskLevel === 'Medium') riskLevel = 'Medium-High';
      }
      
      // Low liquidity (small cap + low volume)
      if (marketCap < 1e9 && volumeRatio < 0.5) {
        riskReasons.push('Low liquidity (small-cap, thin volume)');
        if (riskLevel === 'Medium') riskLevel = 'Medium-High';
      }
      
      // Default if no risks found
      if (riskReasons.length === 0) {
        riskReasons.push('Standard market risk');
        riskLevel = 'Low-Medium';
      }
      
      const riskAssessment = {
        level: riskLevel,
        score: subscores.risk,
        reasons: riskReasons,
        summary: riskReasons.length > 2 
          ? `${riskLevel} risk: ${riskReasons.slice(0, 2).join(', ')} +${riskReasons.length - 2} more`
          : `${riskLevel} risk: ${riskReasons.join(', ')}`
      };

      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ENHANCED: Quick Key Factors Summary
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      const keyFactors = [];
      
      // Valuation
      if (pe > 0 && pe < 12) keyFactors.push('ğŸ”µ Deep Value');
      else if (pe > 0 && pe < 18) keyFactors.push('ğŸ’ Value');
      else if (pe > 40) keyFactors.push('âš ï¸ Expensive');
      
      // Quality
      if (roe > 25) keyFactors.push('â­ Elite ROE');
      else if (roe > 18) keyFactors.push('âœ… Strong ROE');
      else if (roe < 8 && roe > 0) keyFactors.push('âš ï¸ Weak ROE');
      
      // Growth
      if (growth > 25) keyFactors.push('ğŸš€ High Growth');
      else if (growth > 15) keyFactors.push('ğŸ“ˆ Growing');
      else if (growth < -5) keyFactors.push('ğŸ“‰ Declining');
      
      // Balance sheet
      if (debt < 0.3 && marketCap > 1e9) keyFactors.push('ğŸ’ª Strong Balance Sheet');
      else if (debt > 2) keyFactors.push('âš ï¸ High Debt');
      
      // Momentum
      if (changePct > 10) keyFactors.push('ğŸ”¥ Strong Momentum');
      else if (changePct > 5) keyFactors.push('ğŸ“Š Positive Momentum');
      else if (changePct < -10) keyFactors.push('ğŸ”´ Weak Momentum');
      
      // Technical
      if (rsi < 30) keyFactors.push('ğŸ’¡ Oversold');
      else if (rsi > 75) keyFactors.push('ğŸ”´ Overbought');
      else if (rsi > 55 && rsi < 68) keyFactors.push('âœ… Healthy Trend');
      
      // Volume
      if (volumeRatio > 2) keyFactors.push('ğŸ“¢ High Volume');
      
      // Size
      if (isMegaCap) keyFactors.push('ğŸ¢ Mega-Cap');
      else if (marketCap < 2e9) keyFactors.push('ğŸ”¬ Small-Cap');
      
      // PEG (if calculable)
      if (peg !== null && peg < 1 && peg > 0.1) keyFactors.push('ğŸ’° Growth at Value');
      
      // Fallback
      if (keyFactors.length === 0) keyFactors.push('ğŸ“Š Market Average');

      const result = {
        verdict,
        confidence,
        stance,
        execSummary,
        bullFactors,
        bearFactors,
        topDrivers,
        reassurance,
        takeaway,
        watchlistGuidance,
        subscores,
        aiScore: score, // Unified 0-100 scale
        health: score, // Health = AI score for consistency
        riskAssessment, // NEW: Detailed risk with reasons
        keyFactors, // NEW: Quick visual summary
      };
      
      // Cache result (limit cache size to 2000 entries)
      if (aiAnalysisCache.size > 2000) {
        const firstKey = aiAnalysisCache.keys().next().value;
        aiAnalysisCache.delete(firstKey);
      }
      aiAnalysisCache.set(cacheKey, result);
      
      return result;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // EXPLAINABLE AI (rule-level contributions + sensitivity)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function explainDeterministicAIScore(stock) {
      const pe = num(stock.pe, 0);
      const roe = num(stock.roe, 0);
      const rsi = num(stock.rsi, 50);
      const changePct = num(stock.changePct, 0);
      const marketCap = num(stock.marketCap, 0);

      const weights = { fundamental: 0.55, technical: 0.35, risk: 0.10 };
      const contributions = [];
      const add = (bucket, label, delta, detail) => {
        if (!delta) return;
        contributions.push({ bucket, label, delta, detail });
      };

      // FUNDAMENTALS
      let fundamental = 50;
      if (pe > 0) {
        if (pe < 15) { fundamental += 20; add('fundamental', 'Attractive P/E', +20, `P/E ${pe.toFixed(1)} < 15`); }
        else if (pe < 20) { fundamental += 12; add('fundamental', 'Reasonable P/E', +12, `P/E ${pe.toFixed(1)} < 20`); }
        else if (pe < 25) { fundamental += 5; add('fundamental', 'Fair P/E', +5, `P/E ${pe.toFixed(1)} < 25`); }
        else if (pe > 40) { fundamental -= 15; add('fundamental', 'Expensive P/E', -15, `P/E ${pe.toFixed(1)} > 40`); }
        else if (pe > 30) { fundamental -= 8; add('fundamental', 'High P/E', -8, `P/E ${pe.toFixed(1)} > 30`); }
      }

      if (roe > 25) { fundamental += 20; add('fundamental', 'Excellent ROE', +20, `ROE ${roe.toFixed(1)}% > 25%`); }
      else if (roe > 20) { fundamental += 15; add('fundamental', 'Strong ROE', +15, `ROE ${roe.toFixed(1)}% > 20%`); }
      else if (roe > 15) { fundamental += 10; add('fundamental', 'Good ROE', +10, `ROE ${roe.toFixed(1)}% > 15%`); }
      else if (roe > 10) { fundamental += 5; add('fundamental', 'Decent ROE', +5, `ROE ${roe.toFixed(1)}% > 10%`); }
      else if (roe < 5) { fundamental -= 10; add('fundamental', 'Weak ROE', -10, `ROE ${roe.toFixed(1)}% < 5%`); }

      if (marketCap > 10e9) { fundamental += 8; add('fundamental', 'Large-cap stability', +8, `Market cap > $10B`); }
      else if (marketCap > 0 && marketCap < 1e9) { fundamental -= 5; add('fundamental', 'Small-cap risk', -5, `Market cap < $1B`); }

      fundamental = clamp(fundamental, 0, 100);

      // TECHNICALS
      let technical = 50;
      if (rsi >= 35 && rsi <= 65) { technical += 15; add('technical', 'Healthy RSI', +15, `RSI ${rsi.toFixed(0)} in 35â€“65`); }
      else if (rsi < 30) { technical += 10; add('technical', 'Oversold setup', +10, `RSI ${rsi.toFixed(0)} < 30`); }
      else if (rsi > 70) { technical -= 12; add('technical', 'Overbought risk', -12, `RSI ${rsi.toFixed(0)} > 70`); }

      if (changePct > 5) { technical += 12; add('technical', 'Strong momentum', +12, `${changePct.toFixed(1)}% daily move > +5%`); }
      else if (changePct > 2) { technical += 6; add('technical', 'Positive momentum', +6, `${changePct.toFixed(1)}% daily move > +2%`); }
      else if (changePct < -5) { technical -= 10; add('technical', 'Downtrend', -10, `${changePct.toFixed(1)}% daily move < -5%`); }
      else if (changePct < -2) { technical -= 5; add('technical', 'Weak tape', -5, `${changePct.toFixed(1)}% daily move < -2%`); }

      technical = clamp(technical, 0, 100);

      // RISK (higher = worse)
      let risk = 50;
      if (pe > 40) { risk += 15; add('risk', 'Valuation risk', +15, `P/E ${pe.toFixed(1)} > 40`); }
      else if (pe > 30) { risk += 8; add('risk', 'Valuation risk', +8, `P/E ${pe.toFixed(1)} > 30`); }

      if (rsi > 75 || rsi < 25) { risk += 10; add('risk', 'Extreme RSI risk', +10, `RSI ${rsi.toFixed(0)} outside 25â€“75`); }
      if (changePct < -10) { risk += 12; add('risk', 'Sharp drawdown risk', +12, `${changePct.toFixed(1)}% daily move < -10%`); }

      risk = clamp(risk, 0, 100);

      const rawScore = (weights.fundamental * fundamental) + (weights.technical * technical) + (weights.risk * (100 - risk));
      const score = clamp(Math.round(rawScore), 0, 100);

      const impacts = contributions.map(c => {
        let impact = 0;
        if (c.bucket === 'fundamental') impact = weights.fundamental * c.delta;
        else if (c.bucket === 'technical') impact = weights.technical * c.delta;
        else if (c.bucket === 'risk') impact = -weights.risk * c.delta;
        return { ...c, impact: Math.round(impact * 10) / 10 };
      }).sort((a, b) => Math.abs(b.impact) - Math.abs(a.impact));

      return {
        score,
        subscores: { fundamental, technical, risk },
        weights,
        impacts,
        topImpacts: impacts.slice(0, 6)
      };
    }

    function aiExplainThresholds(score) {
      const bands = [80, 67, 55, 45, 0];
      const labels = ['STRONG BUY', 'BUY', 'HOLD', 'REDUCE', 'SELL'];
      let idx = labels.length - 1;
      for (let i = 0; i < bands.length; i++) {
        if (score >= bands[i]) { idx = i; break; }
      }
      const current = labels[idx];
      const nextUpScore = idx > 0 ? bands[idx - 1] : null;
      const nextDownScore = idx < labels.length - 1 ? bands[idx + 1] : null;
      return {
        current,
        nextUpScore,
        nextDownScore,
        toNextUp: nextUpScore != null ? Math.max(0, nextUpScore - score) : 0,
        toNextDown: nextDownScore != null ? Math.max(0, score - nextDownScore) : 0,
      };
    }

    function aiSensitivitySuggestions(stock) {
      const base = explainDeterministicAIScore(stock);
      const suggestions = [];

      const addSuggestion = (title, overrides, note) => {
        const alt = explainDeterministicAIScore({ ...stock, ...overrides });
        const delta = alt.score - base.score;
        if (!Number.isFinite(delta) || Math.abs(delta) < 1) return;
        suggestions.push({ title, delta, newScore: alt.score, note });
      };

      const pe = num(stock.pe, 0);
      if (pe > 40) addSuggestion('If valuation cools (P/E < 40)', { pe: 39.9 }, 'Reduces valuation risk penalty and improves the P/E bucket.');
      else if (pe > 30) addSuggestion('If valuation cools (P/E < 30)', { pe: 29.9 }, 'Improves fundamentals and reduces the risk bucket.');
      else if (pe >= 25) addSuggestion('If P/E improves (< 25)', { pe: 24.9 }, 'Moves into a more favorable valuation bucket.');
      else if (pe >= 20) addSuggestion('If P/E improves (< 20)', { pe: 19.9 }, 'Moves into a stronger valuation bucket.');
      else if (pe >= 15) addSuggestion('If P/E improves (< 15)', { pe: 14.9 }, 'Moves into the strongest valuation bucket.');

      const roe = num(stock.roe, 0);
      if (roe < 5) addSuggestion('If ROE reaches 10%', { roe: 10.1 }, 'Crosses the 10% profitability threshold.');
      else if (roe < 10) addSuggestion('If ROE reaches 15%', { roe: 15.1 }, 'Crosses the 15% profitability threshold.');
      else if (roe < 15) addSuggestion('If ROE reaches 20%', { roe: 20.1 }, 'Crosses the 20% profitability threshold.');
      else if (roe < 20) addSuggestion('If ROE reaches 25%', { roe: 25.1 }, 'Crosses the 25% profitability threshold.');

      const rsi = num(stock.rsi, 50);
      if (!(rsi >= 35 && rsi <= 65)) addSuggestion('If RSI returns to 35â€“65', { rsi: 50 }, 'Moves into the â€œhealthy RSIâ€ band used by the model.');
      if (rsi > 75 || rsi < 25) addSuggestion('If RSI normalizes inside 25â€“75', { rsi: clamp(rsi, 25, 75) }, 'Removes the â€œextreme RSIâ€ risk penalty.');

      const changePct = num(stock.changePct, 0);
      if (changePct < -10) addSuggestion('If drawdown eases above -10%', { changePct: -9.9 }, 'Removes the â€œsharp drawdownâ€ risk penalty.');
      if (changePct < 2) addSuggestion('If momentum improves above +2%', { changePct: 2.1 }, 'Moves into the positive momentum bucket.');

      const marketCap = num(stock.marketCap, 0);
      if (marketCap > 0 && marketCap < 1e9) addSuggestion('If market cap re-rates above $1B', { marketCap: 1e9 }, 'Removes the small-cap penalty.');

      return suggestions.sort((a, b) => Math.abs(b.delta) - Math.abs(a.delta)).slice(0, 4);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UI COMPONENTS - Delay Badge, Footer, Paywall
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function DelayBadge() {
      const [open, setOpen] = useState(false);
      return (
        <div className="relative inline-block">
          <button
            onClick={() => setOpen(p => !p)}
            className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-yellow-500/10 border border-yellow-500/30 text-yellow-300 text-xs font-semibold uppercase tracking-wide cursor-pointer hover:bg-yellow-500/20 transition"
          >
            <i className="fas fa-clock"></i>
            Delayed 15 min
          </button>
          {open && (
            <div className="absolute right-0 top-full mt-2 glass-card p-4 rounded-lg w-72 text-xs text-slate-300 z-50 shadow-2xl border border-slate-700">
              <div className="flex items-start gap-2 mb-2">
                <i className="fas fa-info-circle text-yellow-400 mt-0.5"></i>
                <div>
                  <div className="font-semibold text-white mb-1">Data Delay Notice</div>
                  <div className="text-slate-400 leading-relaxed">
                    US stock exchanges provide data with a 15-minute delay for free tiers.
                    Additional sources: Financial Modeling Prep, Finnhub, EOD Historical Data.
                  </div>
                </div>
              </div>
              <div className="mt-3 pt-3 border-t border-slate-700 text-xs text-slate-500">
                Not investment advice. Always consult a licensed financial adviser.
              </div>
              <button
                onClick={() => setOpen(false)}
                className="mt-2 w-full py-1.5 bg-slate-700 hover:bg-slate-600 text-white rounded text-xs font-medium transition"
              >
                Got it
              </button>
            </div>
          )}
        </div>
      );
    }

    function Footer() {
      return (
        <footer className="mt-8 px-6 py-4 glass rounded-2xl">
          <div className="flex items-center justify-between text-xs text-slate-500">
            <div className="flex items-center gap-4">
              <span>Â© 2026 RetailEdge Pro</span>
              <span className="text-slate-700">â€¢</span>
              <span>Data delayed 15 min</span>
              <span className="text-slate-700">â€¢</span>
              <span>Not investment advice</span>
            </div>
            <div className="flex items-center gap-3">
              <a href="#" className="hover:text-cyan-400 transition">Terms</a>
              <span className="text-slate-700">â€¢</span>
              <a href="#" className="hover:text-cyan-400 transition">Privacy</a>
              <span className="text-slate-700">â€¢</span>
              <a href="#" className="hover:text-cyan-400 transition">Support</a>
            </div>
          </div>
          <div className="mt-2 text-[10px] text-slate-600 text-center">
            Please consult a licensed financial adviser before making investment decisions.
          </div>
        </footer>
      );
    }

    function PaywallCard({ feature, description }) {
      const { tier } = usePremium();

      const upgrade = () => {
        // Show upgrade modal or redirect to pricing
        alert(`Upgrade to Premium to unlock ${feature}!\n\nCurrent tier: ${tier}\n\nPremium features:\nâ€¢ Unlimited watchlist\nâ€¢ Advanced analytics\nâ€¢ Real-time alerts\nâ€¢ Portfolio tracking\nâ€¢ And more!`);

        // In production, integrate with Stripe:
        // const stripe = window.Stripe(STRIPE_PUBLIC_KEY);
        // stripe.redirectToCheckout({ sessionId: ... });
      };

      return (
        <div className="glass-card p-6 rounded-xl border-2 border-yellow-500/30 bg-gradient-to-br from-yellow-500/5 to-orange-500/5">
          <div className="text-center">
            <div className="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-yellow-500 to-orange-500 rounded-full mb-4">
              <i className="fas fa-crown text-white text-2xl"></i>
            </div>
            <h3 className="text-xl font-bold text-white mb-2">Premium Feature</h3>
            <div className="text-yellow-300 font-semibold mb-2">{feature}</div>
            <p className="text-slate-400 text-sm mb-4 leading-relaxed">
              {description || 'This feature is available for Premium and Pro subscribers.'}
            </p>
            <div className="space-y-2 mb-4">
              <div className="flex items-center gap-2 text-sm text-slate-300">
                <i className="fas fa-check text-emerald-400"></i>
                <span>Unlimited watchlist items</span>
              </div>
              <div className="flex items-center gap-2 text-sm text-slate-300">
                <i className="fas fa-check text-emerald-400"></i>
                <span>Advanced analytics & insights</span>
              </div>
              <div className="flex items-center gap-2 text-sm text-slate-300">
                <i className="fas fa-check text-emerald-400"></i>
                <span>Real-time price alerts</span>
              </div>
            </div>
            <button
              onClick={upgrade}
              className="w-full py-3 bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-400 hover:to-orange-400 text-white rounded-lg font-bold text-sm transition shadow-lg shadow-yellow-500/20"
            >
              Upgrade to Premium
            </button>
            <div className="mt-3 text-xs text-slate-500">
              Starting at $9.99/month â€¢ Cancel anytime
            </div>
          </div>
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // EDUCATION CENTER MODAL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // SocialSentimentLeaderboard Component
    function SocialSentimentLeaderboard({ onStockClick }) {
      const [leaderboard, setLeaderboard] = useState([]);
      const [loading, setLoading] = useState(true);
      const [lastUpdate, setLastUpdate] = useState(null);
      const [selectedPlatform, setSelectedPlatform] = useState('all');

      const platforms = [
        { id: 'all', name: 'All Platforms', icon: 'ğŸŒ' },
        { id: 'reddit', name: 'Reddit', icon: 'ğŸ¤–' },
        { id: 'stocktwits', name: 'StockTwits', icon: 'ğŸ“ˆ' },
      ];

      const fetchLeaderboard = async () => {
        setLoading(true);
        try {
          const symbols = DEMO_STOCKS.map(stock => stock.symbol);

          // Fetch sentiment for all symbols
          const sentimentPromises = symbols.map(symbol =>
            window.socialSentiment?.fetchSocialSentiment(symbol).catch(() => null)
          );

          const results = await Promise.all(sentimentPromises);

          // Filter out nulls and create leaderboard
          const validResults = results
            .filter((data, idx) => data && data.totalMessages > 0)
            .map((data, idx) => ({
              symbol: symbols[idx],
              stock: DEMO_STOCKS.find(s => s.symbol === symbols[idx]),
              ...data,
              sentimentScore: data.sentimentScore || 0,
              mentionChange: calculateMentionChange(symbols[idx], data.totalMessages),
              trend: determineTrend(data)
            }))
            .sort((a, b) => b.totalMessages - a.totalMessages); // Most mentions first

          setLeaderboard(validResults.slice(0, 50)); // Top 50
          setLastUpdate(Date.now());
        } catch (error) {
          console.error('Leaderboard fetch error:', error);
        } finally {
          setLoading(false);
        }
      };

      // Calculate mention change vs 24h ago
      const calculateMentionChange = (symbol, currentMentions) => {
        const cacheKey = `mentions_${symbol}`;
        const previous = localStorage.getItem(cacheKey);

        if (previous) {
          const prevData = JSON.parse(previous);
          const timeDiff = Date.now() - prevData.timestamp;

          if (timeDiff < 24 * 60 * 60 * 1000) {
            const change = ((currentMentions - prevData.count) / prevData.count) * 100;
            return change;
          }
        }

        // Save current for next comparison
        localStorage.setItem(cacheKey, JSON.stringify({
          count: currentMentions,
          timestamp: Date.now()
        }));

        return 0;
      };

      // Determine if stock is heating up or cooling down
      const determineTrend = (data) => {
        const recent = data.recentMentions || 0;
        const older = data.olderMentions || 1;
        const ratio = recent / older;

        if (ratio > 2) return 'spiking';
        if (ratio > 1.3) return 'rising';
        if (ratio < 0.7) return 'falling';
        return 'stable';
      };

      // Auto-refresh every 30 minutes
      useEffect(() => {
        fetchLeaderboard();
        const interval = setInterval(fetchLeaderboard, 30 * 60 * 1000);
        return () => clearInterval(interval);
      }, []);

      if (loading) {
        return (
          <div className="glass-card p-8 rounded-xl text-center">
            <i className="fas fa-spinner animate-spin text-3xl text-cyan-400 mb-3"></i>
            <p className="text-slate-400">Analyzing social buzz across platforms...</p>
          </div>
        );
      }

      return (
        <div className="space-y-6">
          {/* Platform Filter */}
          <div className="flex gap-2 mb-4">
            {platforms.map(p => (
              <button
                key={p.id}
                onClick={() => setSelectedPlatform(p.id)}
                className={`px-4 py-2 rounded-lg font-semibold text-sm transition ${selectedPlatform === p.id
                    ? 'bg-cyan-500/20 text-cyan-300 border border-cyan-500/30'
                    : 'bg-slate-800 text-slate-400 hover:bg-slate-700 border border-slate-700'
                  }`}
              >
                <span className="mr-2">{p.icon}</span>
                {p.name}
              </button>
            ))}
          </div>

          {/* Last Update */}
          <div className="flex items-center gap-2 text-xs text-slate-500">
            <i className="fas fa-clock"></i>
            Last updated: {lastUpdate ? new Date(lastUpdate).toLocaleTimeString() : 'Never'}
            <span className="text-cyan-400">(Updates every 30min)</span>
          </div>

          {/* Leaderboard */}
          <div className="glass-card rounded-xl overflow-hidden">
            <table className="w-full">
              <thead className="bg-slate-800/50">
                <tr className="text-left text-xs text-slate-400 uppercase">
                  <th className="p-3">Rank</th>
                  <th className="p-3">Stock</th>
                  <th className="p-3">Mentions</th>
                  <th className="p-3">24h Change</th>
                  <th className="p-3">Sentiment</th>
                  <th className="p-3">Trend</th>
                  <th className="p-3">Action</th>
                </tr>
              </thead>
              <tbody>
                {leaderboard.map((item, idx) => {
                  const trendConfig = {
                    spiking: { icon: 'ğŸš€', color: 'text-orange-400', label: 'Spiking' },
                    rising: { icon: 'ğŸ“ˆ', color: 'text-green-400', label: 'Rising' },
                    falling: { icon: 'ğŸ“‰', color: 'text-red-400', label: 'Falling' },
                    stable: { icon: 'â¡ï¸', color: 'text-slate-400', label: 'Stable' }
                  }[item.trend] || { icon: 'â¡ï¸', color: 'text-slate-400', label: 'Stable' };

                  return (
                    <tr
                      key={item.symbol}
                      className="border-b border-slate-700/30 hover:bg-slate-700/20 cursor-pointer"
                      onClick={() => item.stock && onStockClick(item.stock)}
                    >
                      <td className="p-3">
                        <div className={`font-bold ${idx === 0 ? 'text-yellow-400' :
                            idx === 1 ? 'text-slate-400' :
                              idx === 2 ? 'text-orange-400' :
                                'text-slate-300'
                          }`}>
                          #{idx + 1}
                        </div>
                      </td>
                      <td className="p-3">
                        <div className="font-bold text-white">{item.symbol}</div>
                        <div className="text-xs text-slate-400 truncate max-w-32">
                          {item.stock?.companyName || item.stock?.name || 'â€”'}
                        </div>
                      </td>
                      <td className="p-3">
                        <div className="font-semibold text-white">
                          {item.totalMessages?.toLocaleString() || 0}
                        </div>
                        <div className="text-xs text-slate-400">
                          {item.stocktwitsCount || 0} ST + {item.redditCount || 0} RD
                        </div>
                      </td>
                      <td className="p-3">
                        <div className={`font-semibold ${item.mentionChange > 50 ? 'text-green-400' :
                            item.mentionChange > 0 ? 'text-green-300' :
                              'text-red-400'
                          }`}>
                          {item.mentionChange > 0 ? '+' : ''}{item.mentionChange?.toFixed(0) || 0}%
                        </div>
                      </td>
                      <td className="p-3">
                        <div className={`font-semibold ${item.sentimentScore > 50 ? 'text-green-400' :
                            item.sentimentScore > 0 ? 'text-yellow-400' :
                              'text-red-400'
                          }`}>
                          {item.sentimentScore > 0 ? '+' : ''}{item.sentimentScore || 0}%
                        </div>
                        <div className="text-xs text-slate-400">
                          {item.bullishPercent || 0}% bullish
                        </div>
                      </td>
                      <td className="p-3">
                        <div className={`flex items-center gap-1 ${trendConfig.color}`}>
                          <span>{trendConfig.icon}</span>
                          <span className="text-sm">{trendConfig.label}</span>
                        </div>
                      </td>
                      <td className="p-3">
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            if (item.stock) onStockClick(item.stock);
                          }}
                          className="px-3 py-1 bg-cyan-600 hover:bg-cyan-500 text-white rounded text-sm font-medium"
                        >
                          View
                        </button>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>

          {/* Summary Stats */}
          <div className="grid grid-cols-3 gap-4 mt-6">
            <div className="glass-card p-4 rounded-lg text-center">
              <div className="text-2xl font-bold text-green-400">{leaderboard.filter(i => i.sentimentScore > 50).length}</div>
              <div className="text-xs text-slate-400">Bullish Sentiment</div>
            </div>
            <div className="glass-card p-4 rounded-lg text-center">
              <div className="text-2xl font-bold text-orange-400">{leaderboard.filter(i => i.trend === 'spiking').length}</div>
              <div className="text-xs text-slate-400">Spiking Now</div>
            </div>
            <div className="glass-card p-4 rounded-lg text-center">
              <div className="text-2xl font-bold text-cyan-400">
                {leaderboard.reduce((sum, i) => sum + (i.totalMessages || 0), 0).toLocaleString()}
              </div>
              <div className="text-xs text-slate-400">Total Mentions</div>
            </div>
          </div>
        </div>
      );
    }

    // WatchlistTab Component
    function WatchlistTab({ watchlist, stocks, onRemoveFromWatchlist, onStockClick, setShowWatchlistOnly }) {
      const [watchlistStocks, setWatchlistStocks] = useState([]);
      const [loading, setLoading] = useState(true);
      const [stats, setStats] = useState({ totalValue: 0, totalChange: 0, avgChange: 0 });

      useEffect(() => {
        const loadWatchlistData = async () => {
          if (!watchlist || watchlist.length === 0) {
            setWatchlistStocks([]);
            setLoading(false);
            return;
          }

          setLoading(true);

          // Get current data for each watchlist stock
          const loadedStocks = watchlist
            .map(symbol => {
              const stock = stocks.find(s => s.symbol === symbol);
              if (stock) {
                return stock;
              }
              // Try to fetch from cache if not in current stocks
              const cached = Cache.get(symbol, 'stock');
              if (cached) return cached;
              return null;
            })
            .filter(Boolean);

          setWatchlistStocks(loadedStocks);

          // Calculate stats
          const totalValue = loadedStocks.reduce((sum, s) => sum + (s.marketCap || 0), 0);
          const totalChange = loadedStocks.reduce((sum, s) => sum + (s.changePct || 0), 0);
          const avgChange = loadedStocks.length > 0 ? totalChange / loadedStocks.length : 0;

          setStats({
            totalValue,
            totalChange,
            avgChange,
            count: loadedStocks.length
          });

          setLoading(false);
        };

        loadWatchlistData();
      }, [watchlist, stocks]);

      if (loading) {
        return (
          <div className="glass-card p-8 rounded-xl text-center">
            <i className="fas fa-spinner animate-spin text-3xl text-cyan-400 mb-3"></i>
            <p className="text-slate-400">Loading your watchlist...</p>
          </div>
        );
      }

      if (!watchlist || watchlist.length === 0) {
        return (
          <div className="glass-card p-8 rounded-xl text-center">
            <i className="fas fa-star text-6xl text-slate-700 mb-4"></i>
            <h3 className="text-xl font-bold text-white mb-2">Your Watchlist is Empty</h3>
            <p className="text-slate-400 mb-4">Add stocks to watchlist from the main screener to see them here</p>
            <button
              onClick={() => setShowWatchlistOnly(false)}
              className="px-6 py-3 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg font-semibold"
            >
              Browse Stocks
            </button>
          </div>
        );
      }

      return (
        <div className="space-y-6">
          {/* Header Stats */}
          <div className="glass-card p-5 rounded-xl">
            <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
              <i className="fas fa-star text-yellow-400"></i>
              My Watchlist ({stats.count} stocks)
            </h3>

            <div className="grid grid-cols-3 gap-4">
              <div className="text-center">
                <div className="text-2xl font-bold text-white">
                  ${formatNumber(stats.totalValue)}
                </div>
                <div className="text-xs text-slate-400">Total Market Cap</div>
              </div>
              <div className="text-center">
                <div className={`text-2xl font-bold ${getSentimentColor(stats.avgChange)}`}>
                  {formatPercent(stats.avgChange)}
                </div>
                <div className="text-xs text-slate-400">Avg Change</div>
              </div>
              <div className="text-center">
                <div className={`text-2xl font-bold ${stats.totalChange >= 0 ? 'text-green-400' : 'text-red-400'
                  }`}>
                  {formatPercent(stats.totalChange)}
                </div>
                <div className="text-xs text-slate-400">Combined Change</div>
              </div>
            </div>
          </div>

          {/* Watchlist Table */}
          <div className="glass-card rounded-xl overflow-hidden">
            <table className="w-full">
              <thead className="bg-slate-800/50">
                <tr className="text-left text-xs text-slate-400 uppercase">
                  <th className="p-3">Symbol</th>
                  <th className="p-3">Price</th>
                  <th className="p-3">Change%</th>
                  <th className="p-3">Volume</th>
                  <th className="p-3">P/E</th>
                  <th className="p-3">ROE%</th>
                  <th className="p-3">AI Score</th>
                  <th className="p-3">Actions</th>
                </tr>
              </thead>
              <tbody>
                {watchlistStocks.map(stock => {
                  const analysis = computeEnhancedAnalysis(stock);

                  return (
                    <tr
                      key={stock.symbol}
                      className="border-b border-slate-700/30 hover:bg-slate-700/20 cursor-pointer"
                      onClick={() => onStockClick(stock)}
                    >
                      <td className="p-3">
                        <div className="flex items-center gap-2">
                          <span className="font-bold text-white">{stock.symbol}</span>
                          {watchlist && Array.isArray(watchlist) && watchlist.some(w => w && w.toUpperCase() === stock.symbol.toUpperCase()) && (
                            <span className="text-yellow-400">â˜…</span>
                          )}
                        </div>
                        <div className="text-xs text-slate-400 truncate max-w-32">
                          {stock.companyName || stock.name || 'â€”'}
                        </div>
                      </td>
                      <td className="p-3 font-semibold text-white">
                        ${stock.price?.toFixed(2)}
                      </td>
                      <td className={`p-3 font-semibold ${getSentimentColor(stock.changePct)}`}>
                        {formatPercent(stock.changePct)}
                      </td>
                      <td className="p-3 text-slate-300">
                        {formatNumber(stock.volume)}
                      </td>
                      <td className="p-3 text-slate-300">
                        {stock.pe?.toFixed(1) || 'â€”'}
                      </td>
                      <td className="p-3 text-slate-300">
                        {stock.roe?.toFixed(1) || 'â€”'}%
                      </td>
                      <td className="p-3">
                        <div className={`font-bold ${analysis.aiScore >= 80 ? 'text-green-400' :
                            analysis.aiScore >= 60 ? 'text-yellow-400' :
                              'text-red-400'
                          }`}>
                          {analysis.aiScore}/100
                        </div>
                        <div className={`text-xs ${analysis.verdict === 'STRONG BUY' || analysis.verdict === 'BUY'
                            ? 'text-green-400' :
                            analysis.verdict === 'SELL' ? 'text-red-400' :
                              'text-slate-400'
                          }`}>
                          {analysis.verdict}
                        </div>
                      </td>
                      <td className="p-3">
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            onRemoveFromWatchlist && onRemoveFromWatchlist(stock.symbol);
                          }}
                          className="px-3 py-1 bg-red-600 hover:bg-red-500 text-white rounded text-sm font-medium"
                          title="Remove from watchlist"
                        >
                          <i className="fas fa-trash"></i>
                        </button>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>

          {/* Quick Actions */}
          <div className="flex gap-3">
            <button
              onClick={() => {
                // Clear watchlist
                if (confirm('Are you sure you want to clear your entire watchlist?')) {
                  watchlist.forEach(symbol => onRemoveFromWatchlist(symbol));
                }
              }}
              className="px-4 py-2 bg-red-600 hover:bg-red-500 text-white rounded-lg font-medium"
            >
              <i className="fas fa-trash-alt mr-2"></i>
              Clear Watchlist
            </button>
            <button
              onClick={() => {
                // Export watchlist to CSV
                const csv = watchlistStocks.map(s =>
                  `${s.symbol},${s.name || ''},$${s.price},${s.changePct}%`
                ).join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `watchlist_${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
              }}
              className="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-medium"
            >
              <i className="fas fa-download mr-2"></i>
              Export CSV
            </button>
          </div>
        </div>
      );
    }

    // DataFreshnessIndicator Component
    function DataFreshnessIndicator({ timestamp, type }) {
      const [display, setDisplay] = useState('');

      const format = () => {
        if (!timestamp) return 'Never updated';

        const minutes = Math.floor((Date.now() - timestamp) / 60000);

        if (type === 'heatmap') {
          const nextUpdate = 60 - (minutes % 60);
          return `Next update: ${nextUpdate} min`;
        }

        const interval = type === 'news' || type === 'sentiment' ? 30 : 60;
        const nextUpdate = Math.max(0, interval - minutes);

        if (minutes < 1) return 'Updated just now';
        if (minutes < 60) return `Updated ${minutes}m ago (next: ${nextUpdate}m)`;
        return `Updated ${Math.floor(minutes / 60)}h ago`;
      };

      useEffect(() => {
        setDisplay(format());
        const id = setInterval(() => setDisplay(format()), 60000);
        return () => clearInterval(id);
      }, [timestamp, type]);

      const colorClass = timestamp && (Date.now() - timestamp) < 60000
        ? 'text-green-400'
        : 'text-slate-400';

      return (
        <div className={`flex items-center gap-2 text-xs ${colorClass}`}>
          <i className="fas fa-clock"></i>
          <span>{display}</span>
        </div>
      );
    }

    function EducationCenterModal({ onClose }) {
      const [selectedTab, setSelectedTab] = useState('tutorials');
      const [selectedTutorial, setSelectedTutorial] = useState(null);
      const [selectedCaseStudy, setSelectedCaseStudy] = useState(null);
      const userId = UserManager.getCurrentUser()?.id || 'guest';
      const progress = EDUCATION_CENTER.getProgress(userId);
      const completionRate = EDUCATION_CENTER.getCompletionRate(userId);

      const categories = [
        { id: 'basics', name: 'Basics', icon: 'ğŸ“š' },
        { id: 'metrics', name: 'Metrics', icon: 'ğŸ”¢' },
        { id: 'technical', name: 'Technical', icon: 'ğŸ“Š' },
        { id: 'strategy', name: 'Strategy', icon: 'ğŸ¯' }
      ];

      if (selectedTutorial) {
        return (
          <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div className="glass-card rounded-2xl p-6 w-full max-w-3xl max-h-[90vh] overflow-y-auto">
              <div className="flex items-center justify-between mb-4">
                <button onClick={() => setSelectedTutorial(null)} className="text-cyan-400 hover:text-cyan-300 flex items-center gap-2">
                  <i className="fas fa-arrow-left"></i> Back
                </button>
                <button onClick={onClose} className="text-slate-400 hover:text-white">
                  <i className="fas fa-times text-xl"></i>
                </button>
              </div>

              <div className="mb-6">
                <div className="text-4xl mb-3">{selectedTutorial.icon}</div>
                <h2 className="text-2xl font-bold text-white mb-2">{selectedTutorial.title}</h2>
                <div className="flex items-center gap-3 text-sm text-slate-400">
                  <span><i className="fas fa-clock mr-1"></i>{selectedTutorial.duration}</span>
                  <span>â€¢</span>
                  <span className="px-2 py-1 bg-cyan-500/10 text-cyan-300 rounded">{selectedTutorial.category}</span>
                </div>
              </div>

              <div className="space-y-6">
                <div>
                  <p className="text-slate-300 leading-relaxed">{selectedTutorial.content.intro}</p>
                </div>

                <div>
                  <h3 className="text-lg font-semibold text-white mb-3">Key Points</h3>
                  <ul className="space-y-2">
                    {selectedTutorial.content.keyPoints.map((point, i) => (
                      <li key={i} className="flex items-start gap-3 text-slate-300">
                        <i className="fas fa-check-circle text-emerald-400 mt-1"></i>
                        <span>{point}</span>
                      </li>
                    ))}
                  </ul>
                </div>

                <div className="glass p-4 rounded-lg border border-cyan-500/20">
                  <h4 className="font-semibold text-cyan-300 mb-2">ğŸ’¡ Example</h4>
                  <p className="text-slate-300 text-sm leading-relaxed">{selectedTutorial.content.example}</p>
                </div>

                {selectedTutorial.content.whyItMatters && (
                  <div className="glass p-4 rounded-lg border border-purple-500/20">
                    <h4 className="font-semibold text-purple-300 mb-2">ğŸ¯ Why This Matters</h4>
                    <p className="text-slate-300 text-sm leading-relaxed">{selectedTutorial.content.whyItMatters}</p>
                  </div>
                )}

                {selectedTutorial.content.practicalTip && (
                  <div className="glass p-4 rounded-lg border border-yellow-500/20">
                    <h4 className="font-semibold text-yellow-300 mb-2">âš¡ Practical Tip</h4>
                    <p className="text-slate-300 text-sm leading-relaxed">{selectedTutorial.content.practicalTip}</p>
                  </div>
                )}

                {selectedTutorial.content.nextSteps && (
                  <div>
                    <h4 className="font-semibold text-white mb-2">Next Steps</h4>
                    <div className="flex flex-wrap gap-2">
                      {selectedTutorial.content.nextSteps.map((step, i) => (
                        <span key={i} className="px-3 py-1 bg-slate-700 text-slate-300 rounded-full text-sm">
                          {step}
                        </span>
                      ))}
                    </div>
                  </div>
                )}
              </div>

              <div className="mt-6 flex gap-3">
                <button
                  onClick={() => {
                    EDUCATION_CENTER.markComplete(userId, selectedTutorial.id);
                    setSelectedTutorial(null);
                  }}
                  className="flex-1 py-3 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-semibold transition"
                >
                  <i className="fas fa-check mr-2"></i>Mark Complete
                </button>
                <button
                  onClick={() => setSelectedTutorial(null)}
                  className="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold transition"
                >
                  Close
                </button>
              </div>
            </div>
          </div>
        );
      }

      if (selectedCaseStudy) {
        return (
          <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div className="glass-card rounded-2xl p-6 w-full max-w-3xl max-h-[90vh] overflow-y-auto">
              <div className="flex items-center justify-between mb-4">
                <button onClick={() => setSelectedCaseStudy(null)} className="text-cyan-400 hover:text-cyan-300 flex items-center gap-2">
                  <i className="fas fa-arrow-left"></i> Back
                </button>
                <button onClick={onClose} className="text-slate-400 hover:text-white">
                  <i className="fas fa-times text-xl"></i>
                </button>
              </div>

              <div className="mb-6">
                <div className="text-5xl mb-3">{selectedCaseStudy.icon}</div>
                <h2 className="text-2xl font-bold text-white mb-2">{selectedCaseStudy.title}</h2>
                <div className="flex items-center gap-3 text-sm text-slate-400 mb-3">
                  <span className="font-semibold">{selectedCaseStudy.investor}</span>
                  <span>â€¢</span>
                  <span>{selectedCaseStudy.year}</span>
                </div>
                <p className="text-cyan-300 font-medium">{selectedCaseStudy.summary}</p>
              </div>

              <div className="space-y-6">
                <div className="glass p-4 rounded-lg border border-slate-700">
                  <h3 className="font-semibold text-white mb-2">ğŸ“– The Story</h3>
                  <p className="text-slate-300 leading-relaxed">{selectedCaseStudy.story}</p>
                </div>

                <div>
                  <h3 className="text-lg font-semibold text-white mb-3">Key Lessons</h3>
                  <ul className="space-y-2">
                    {selectedCaseStudy.keyLessons.map((lesson, i) => (
                      <li key={i} className="flex items-start gap-3 text-slate-300">
                        <span className="text-yellow-400 font-bold">{i + 1}.</span>
                        <span>{lesson}</span>
                      </li>
                    ))}
                  </ul>
                </div>

                <div className="glass p-4 rounded-lg border border-emerald-500/20">
                  <h3 className="font-semibold text-emerald-300 mb-3">ğŸ“Š The Numbers</h3>
                  <div className="grid grid-cols-2 gap-4">
                    {Object.entries(selectedCaseStudy.metrics).map(([key, value]) => (
                      <div key={key}>
                        <div className="text-slate-400 text-xs uppercase tracking-wide mb-1">
                          {key.replace(/([A-Z])/g, ' $1').trim()}
                        </div>
                        <div className="text-white font-semibold">{value}</div>
                      </div>
                    ))}
                  </div>
                </div>

                <div className="glass p-4 rounded-lg border border-purple-500/20 bg-gradient-to-br from-purple-500/5 to-pink-500/5">
                  <h4 className="font-semibold text-purple-300 mb-2">ğŸ’ Key Takeaway</h4>
                  <p className="text-white leading-relaxed">{selectedCaseStudy.takeaway}</p>
                </div>
              </div>

              <button
                onClick={() => setSelectedCaseStudy(null)}
                className="mt-6 w-full py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold transition"
              >
                Close
              </button>
            </div>
          </div>
        );
      }

      return (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className="glass-card rounded-2xl p-6 w-full max-w-5xl max-h-[90vh] overflow-y-auto">
            <div className="flex items-center justify-between mb-6">
              <div>
                <h2 className="text-2xl font-bold text-white mb-1">ğŸ“š Education Center</h2>
                <p className="text-slate-400 text-sm">Learn investing from the ground up</p>
              </div>
              <button onClick={onClose} className="text-slate-400 hover:text-white">
                <i className="fas fa-times text-xl"></i>
              </button>
            </div>

            {/* Progress Bar */}
            <div className="mb-6 glass p-4 rounded-lg">
              <div className="flex items-center justify-between mb-2">
                <span className="text-sm text-slate-400">Your Progress</span>
                <span className="text-sm font-semibold text-cyan-300">{completionRate}%</span>
              </div>
              <div className="w-full h-2 bg-slate-700 rounded-full overflow-hidden">
                <div
                  className="h-full bg-gradient-to-r from-cyan-500 to-emerald-500 transition-all duration-500"
                  style={{ width: `${completionRate}%` }}
                ></div>
              </div>
              <div className="mt-2 text-xs text-slate-500">
                {progress.completed.length} of {EDUCATION_CENTER.tutorials.length} tutorials completed
              </div>
            </div>

            {/* Tabs */}
            <div className="flex gap-2 mb-6 border-b border-slate-700">
              <button
                onClick={() => setSelectedTab('tutorials')}
                className={`px-4 py-2 font-semibold transition ${selectedTab === 'tutorials'
                    ? 'text-cyan-400 border-b-2 border-cyan-400'
                    : 'text-slate-400 hover:text-white'
                  }`}
              >
                <i className="fas fa-book mr-2"></i>Tutorials
              </button>
              <button
                onClick={() => setSelectedTab('case-studies')}
                className={`px-4 py-2 font-semibold transition ${selectedTab === 'case-studies'
                    ? 'text-cyan-400 border-b-2 border-cyan-400'
                    : 'text-slate-400 hover:text-white'
                  }`}
              >
                <i className="fas fa-trophy mr-2"></i>Case Studies
              </button>
            </div>

            {/* Tutorials Tab */}
            {selectedTab === 'tutorials' && (
              <div>
                {categories.map(category => {
                  const tutorials = EDUCATION_CENTER.getTutorialsByCategory(category.id);
                  return (
                    <div key={category.id} className="mb-6">
                      <h3 className="text-lg font-semibold text-white mb-3 flex items-center gap-2">
                        <span>{category.icon}</span>
                        <span>{category.name}</span>
                      </h3>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {tutorials.map(tutorial => {
                          const isCompleted = progress.completed.includes(tutorial.id);
                          const inProgress = progress.inProgress.includes(tutorial.id);
                          return (
                            <div
                              key={tutorial.id}
                              onClick={() => {
                                if (!isCompleted && !inProgress) {
                                  EDUCATION_CENTER.markInProgress(userId, tutorial.id);
                                }
                                setSelectedTutorial(tutorial);
                              }}
                              className="glass-card p-4 rounded-lg cursor-pointer hover:border-cyan-500/40 transition"
                            >
                              <div className="flex items-start justify-between mb-2">
                                <span className="text-3xl">{tutorial.icon}</span>
                                {isCompleted && (
                                  <span className="px-2 py-1 bg-emerald-500/20 text-emerald-300 rounded text-xs font-semibold">
                                    <i className="fas fa-check mr-1"></i>Done
                                  </span>
                                )}
                                {inProgress && !isCompleted && (
                                  <span className="px-2 py-1 bg-yellow-500/20 text-yellow-300 rounded text-xs font-semibold">
                                    <i className="fas fa-hourglass-half mr-1"></i>In Progress
                                  </span>
                                )}
                              </div>
                              <h4 className="font-semibold text-white mb-1">{tutorial.title}</h4>
                              <p className="text-xs text-slate-400 mb-2">
                                <i className="fas fa-clock mr-1"></i>{tutorial.duration}
                              </p>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  );
                })}
              </div>
            )}

            {/* Case Studies Tab */}
            {selectedTab === 'case-studies' && (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {EDUCATION_CENTER.caseStudies.map(caseStudy => (
                  <div
                    key={caseStudy.id}
                    onClick={() => setSelectedCaseStudy(caseStudy)}
                    className="glass-card p-5 rounded-lg cursor-pointer hover:border-cyan-500/40 transition"
                  >
                    <div className="text-4xl mb-3">{caseStudy.icon}</div>
                    <h3 className="font-semibold text-white mb-1">{caseStudy.title}</h3>
                    <div className="text-xs text-slate-400 mb-2">
                      {caseStudy.investor} â€¢ {caseStudy.year}
                    </div>
                    <p className="text-sm text-slate-300 leading-relaxed">{caseStudy.summary}</p>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // COMPONENTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function AdvancedChartPanel({
      symbol,
      candles,
      timeframe,
      onTimeframe,
      comparisonSymbol,
      onComparisonSymbol,
      comparisonCandles,
      comparisonLoading
    }) {
      const priceRef = useRef(null);
      const rsiRef = useRef(null);
      const macdRef = useRef(null);
      const chartsRef = useRef({ price: null, rsi: null, macd: null });
      const seriesRef = useRef({
        candle: null,
        volume: null,
        bbUpper: null,
        bbMid: null,
        bbLower: null,
        compare: null,
        rsi: null,
        macd: null,
        macdSignal: null,
        macdHist: null,
        drawings: []
      });
      const drawStateRef = useRef({ enabled: false, firstPoint: null });

      const [showBollinger, setShowBollinger] = useState(true);
      const [showRSI, setShowRSI] = useState(true);
      const [showMACD, setShowMACD] = useState(true);
      const [showVolume, setShowVolume] = useState(true);
      const [drawMode, setDrawMode] = useState(false);

      const normalized = useMemo(() => normalizeFmpCandles(candles), [candles]);
      const profile = useMemo(() => computeVolumeProfile(normalized, 24), [normalized]);

      const setDrawEnabled = (enabled) => {
        setDrawMode(enabled);
        drawStateRef.current.enabled = enabled;
        drawStateRef.current.firstPoint = null;
      };

      const clearDrawings = () => {
        const priceChart = chartsRef.current.price;
        if (!priceChart) return;
        for (const s of seriesRef.current.drawings) {
          try { priceChart.removeSeries(s); } catch { }
        }
        seriesRef.current.drawings = [];
        drawStateRef.current.firstPoint = null;
      };

      useEffect(() => {
        if (!window.LightweightCharts) {
          console.warn('âš ï¸ LightweightCharts not available');
          return;
        }
        if (!priceRef.current) return;
        if (!normalized || normalized.length === 0) return;

        // Check if Lightweight Charts library is loaded
        if (!window.LightweightCharts) {
          console.error('âŒ Lightweight Charts library not loaded');
          return;
        }

        // Cleanup previous charts
        try { chartsRef.current.price?.remove(); } catch { }
        try { chartsRef.current.rsi?.remove(); } catch { }
        try { chartsRef.current.macd?.remove(); } catch { }
        chartsRef.current = { price: null, rsi: null, macd: null };
        seriesRef.current.drawings = [];
        drawStateRef.current.firstPoint = null;

        const rootStyles = getComputedStyle(document.documentElement);
        const textSecondary = (rootStyles.getPropertyValue('--text-secondary') || '#94a3b8').trim();

        const common = {
          layout: {
            background: { type: 'solid', color: 'transparent' },
            textColor: textSecondary
          },
          grid: {
            vertLines: { color: 'rgba(148, 163, 184, 0.08)' },
            horzLines: { color: 'rgba(148, 163, 184, 0.08)' }
          },
          timeScale: { borderColor: 'rgba(148, 163, 184, 0.15)' },
          rightPriceScale: { borderColor: 'rgba(148, 163, 184, 0.15)' },
          crosshair: { mode: window.LightweightCharts.CrosshairMode.Normal }
        };

        const priceChart = window.LightweightCharts.createChart(priceRef.current, {
          ...common,
          height: 360,
        });
        chartsRef.current.price = priceChart;

        const candleSeries = priceChart.addCandlestickSeries({
          upColor: '#22c55e',
          downColor: '#ef4444',
          borderUpColor: '#22c55e',
          borderDownColor: '#ef4444',
          wickUpColor: '#22c55e',
          wickDownColor: '#ef4444'
        });
        seriesRef.current.candle = candleSeries;
        candleSeries.setData(normalized);

        const closes = normalized.map(c => c.close);
        const times = normalized.map(c => c.time);

        // Volume
        const volumeSeries = priceChart.addHistogramSeries({
          priceFormat: { type: 'volume' },
          priceScaleId: '',
          scaleMargins: { top: 0.8, bottom: 0 }
        });
        seriesRef.current.volume = volumeSeries;
        if (showVolume) {
          volumeSeries.setData(normalized.map(c => ({
            time: c.time,
            value: c.volume,
            color: c.close >= c.open ? 'rgba(34,197,94,0.45)' : 'rgba(239,68,68,0.45)'
          })));
        } else {
          volumeSeries.setData([]);
        }

        // Bollinger Bands
        const bbUpper = priceChart.addLineSeries({ color: 'rgba(148,163,184,0.55)', lineWidth: 1 });
        const bbMid = priceChart.addLineSeries({ color: 'rgba(6,182,212,0.65)', lineWidth: 1 });
        const bbLower = priceChart.addLineSeries({ color: 'rgba(148,163,184,0.55)', lineWidth: 1 });
        seriesRef.current.bbUpper = bbUpper;
        seriesRef.current.bbMid = bbMid;
        seriesRef.current.bbLower = bbLower;

        if (showBollinger) {
          const bb = computeBollinger(closes, 20, 2);
          bbUpper.setData(times.map((t, i) => bb.upper[i] == null ? null : ({ time: t, value: bb.upper[i] })).filter(Boolean));
          bbMid.setData(times.map((t, i) => bb.mid[i] == null ? null : ({ time: t, value: bb.mid[i] })).filter(Boolean));
          bbLower.setData(times.map((t, i) => bb.lower[i] == null ? null : ({ time: t, value: bb.lower[i] })).filter(Boolean));
        } else {
          bbUpper.setData([]);
          bbMid.setData([]);
          bbLower.setData([]);
        }

        // Comparison overlay (% change)
        if (comparisonCandles && comparisonCandles.length > 0) {
          const cmp = normalizeFmpCandles(comparisonCandles);
          if (cmp.length > 2) {
            const base = cmp[0].close || 1;
            const compareSeries = priceChart.addLineSeries({
              color: 'rgba(139,92,246,0.85)',
              lineWidth: 2,
              priceScaleId: 'compare'
            });
            priceChart.priceScale('compare').applyOptions({
              scaleMargins: { top: 0.1, bottom: 0.1 },
              borderVisible: false
            });
            compareSeries.setData(cmp.map(p => ({ time: p.time, value: ((p.close - base) / base) * 100 })));
            seriesRef.current.compare = compareSeries;
          }
        }

        // RSI chart
        let rsiChart = null;
        if (showRSI && rsiRef.current) {
          rsiChart = window.LightweightCharts.createChart(rsiRef.current, {
            ...common,
            height: 140,
            timeScale: { visible: false },
          });
          chartsRef.current.rsi = rsiChart;
          const rsiSeries = rsiChart.addLineSeries({ color: 'rgba(6,182,212,0.85)', lineWidth: 2 });
          seriesRef.current.rsi = rsiSeries;
          const rsiVals = computeRSI(closes, 14);
          rsiSeries.setData(times.map((t, i) => rsiVals[i] == null ? null : ({ time: t, value: rsiVals[i] })).filter(Boolean));
        }

        // MACD chart
        let macdChart = null;
        if (showMACD && macdRef.current) {
          macdChart = window.LightweightCharts.createChart(macdRef.current, {
            ...common,
            height: 160,
            timeScale: { visible: true },
          });
          chartsRef.current.macd = macdChart;
          const macdLine = macdChart.addLineSeries({ color: 'rgba(6,182,212,0.85)', lineWidth: 2 });
          const signalLine = macdChart.addLineSeries({ color: 'rgba(148,163,184,0.75)', lineWidth: 1 });
          const histSeries = macdChart.addHistogramSeries({ priceFormat: { type: 'price' } });
          seriesRef.current.macd = macdLine;
          seriesRef.current.macdSignal = signalLine;
          seriesRef.current.macdHist = histSeries;

          const macd = computeMACD(closes, 12, 26, 9);
          macdLine.setData(times.map((t, i) => macd.macd[i] == null ? null : ({ time: t, value: macd.macd[i] })).filter(Boolean));
          signalLine.setData(times.map((t, i) => macd.signal[i] == null ? null : ({ time: t, value: macd.signal[i] })).filter(Boolean));
          histSeries.setData(times.map((t, i) => {
            const v = macd.hist[i];
            if (v == null) return null;
            return { time: t, value: v, color: v >= 0 ? 'rgba(34,197,94,0.55)' : 'rgba(239,68,68,0.55)' };
          }).filter(Boolean));
        }

        // Sync visible range across charts
        const syncRange = (source, target) => {
          if (!source || !target) return () => { };
          const handler = (range) => {
            try { target.timeScale().setVisibleRange(range); } catch { }
          };
          source.timeScale().subscribeVisibleTimeRangeChange(handler);
          return () => source.timeScale().unsubscribeVisibleTimeRangeChange(handler);
        };
        const unsub1 = syncRange(priceChart, rsiChart);
        const unsub2 = syncRange(priceChart, macdChart);

        // Drawing tool: trendline (two clicks)
        const clickHandler = (param) => {
          if (!drawStateRef.current.enabled) return;
          if (!param || !param.time) return;
          const seriesData = param.seriesData;
          let price = null;
          try {
            if (seriesData && seriesData.get && seriesRef.current.candle) {
              const p = seriesData.get(seriesRef.current.candle);
              price = p?.close ?? p?.value ?? p?.open ?? null;
            }
          } catch { }
          if (price == null) return;

          if (!drawStateRef.current.firstPoint) {
            drawStateRef.current.firstPoint = { time: param.time, value: price };
            return;
          }
          const p1 = drawStateRef.current.firstPoint;
          const p2 = { time: param.time, value: price };
          drawStateRef.current.firstPoint = null;

          const line = priceChart.addLineSeries({ color: 'rgba(6,182,212,0.75)', lineWidth: 2 });
          line.setData([p1, p2].sort((a, b) => a.time - b.time));
          seriesRef.current.drawings.push(line);
        };
        priceChart.subscribeClick(clickHandler);

        const ro = new ResizeObserver(entries => {
          for (const e of entries) {
            const w = Math.floor(e.contentRect.width);
            try { priceChart.applyOptions({ width: w }); } catch { }
            try { rsiChart?.applyOptions({ width: w }); } catch { }
            try { macdChart?.applyOptions({ width: w }); } catch { }
          }
        });
        ro.observe(priceRef.current);

        return () => {
          try { priceChart.unsubscribeClick(clickHandler); } catch { }
          unsub1();
          unsub2();
          try { ro.disconnect(); } catch { }
          try { priceChart.remove(); } catch { }
          try { rsiChart?.remove(); } catch { }
          try { macdChart?.remove(); } catch { }
        };
      }, [normalized, showBollinger, showRSI, showMACD, showVolume, comparisonCandles]);

      return (
        <div className="space-y-4">
          {!window.LightweightCharts && (
            <div className="glass-card p-4 rounded-xl border border-yellow-500/30 bg-yellow-500/10">
              <div className="text-yellow-300 font-semibold text-sm mb-1">Chart library failed to load</div>
              <div className="text-xs text-slate-300">The Lightweight Charts script didnâ€™t load (network blocked or CDN unavailable). Refresh the page or try a different network.</div>
            </div>
          )}

          {window.LightweightCharts && (!normalized || normalized.length === 0) && (
            <div className="glass-card p-4 rounded-xl border border-slate-700/40">
              <div className="text-slate-200 font-semibold text-sm mb-1">No chart candles available</div>
              <div className="text-xs text-slate-400">This usually means the API returned no candles for the selected timeframe, or the timestamps were not parseable.</div>
            </div>
          )}
          <div className="flex flex-wrap items-center justify-between gap-3">
            <div className="flex items-center gap-2 flex-wrap">
              <div className="text-xs text-slate-500">Timeframe</div>
              {[{ id: '1hour', label: '1H' }, { id: '4hour', label: '4H' }, { id: '1day', label: '1D' }].map(tf => (
                <button
                  key={tf.id}
                  onClick={() => onTimeframe(tf.id)}
                  className={`px-3 py-1 rounded-lg text-xs font-semibold border transition ${timeframe === tf.id ? 'bg-cyan-500/20 text-cyan-300 border-cyan-500/30' : 'bg-slate-800/40 text-slate-300 border-slate-700/30 hover:bg-slate-700/30'}`}
                >
                  {tf.label}
                </button>
              ))}

              <div className="w-px h-6 bg-slate-700/40 mx-1"></div>

              <button
                onClick={() => setShowBollinger(v => !v)}
                className={`px-3 py-1 rounded-lg text-xs font-semibold border transition ${showBollinger ? 'bg-slate-700/40 text-slate-100 border-slate-600/40' : 'bg-slate-800/40 text-slate-400 border-slate-700/30'}`}
              >
                Bollinger
              </button>
              <button
                onClick={() => setShowRSI(v => !v)}
                className={`px-3 py-1 rounded-lg text-xs font-semibold border transition ${showRSI ? 'bg-slate-700/40 text-slate-100 border-slate-600/40' : 'bg-slate-800/40 text-slate-400 border-slate-700/30'}`}
              >
                RSI
              </button>
              <button
                onClick={() => setShowMACD(v => !v)}
                className={`px-3 py-1 rounded-lg text-xs font-semibold border transition ${showMACD ? 'bg-slate-700/40 text-slate-100 border-slate-600/40' : 'bg-slate-800/40 text-slate-400 border-slate-700/30'}`}
              >
                MACD
              </button>
              <button
                onClick={() => setShowVolume(v => !v)}
                className={`px-3 py-1 rounded-lg text-xs font-semibold border transition ${showVolume ? 'bg-slate-700/40 text-slate-100 border-slate-600/40' : 'bg-slate-800/40 text-slate-400 border-slate-700/30'}`}
              >
                Volume
              </button>
            </div>

            <div className="flex items-center gap-2 flex-wrap">
              <div className="text-xs text-slate-500">Compare</div>
              <input
                value={comparisonSymbol}
                onChange={(e) => onComparisonSymbol(e.target.value.toUpperCase().replace(/[^A-Z.]/g, '').slice(0, 10))}
                placeholder="e.g. SPY"
                className="px-3 py-1 rounded-lg text-xs bg-slate-900/40 border border-slate-700/40 text-slate-200 w-28"
              />
              {comparisonLoading && (
                <span className="text-xs text-slate-500">Loadingâ€¦</span>
              )}
              <div className="w-px h-6 bg-slate-700/40 mx-1"></div>
              <button
                onClick={() => setDrawEnabled(!drawMode)}
                className={`px-3 py-1 rounded-lg text-xs font-semibold border transition ${drawMode ? 'bg-cyan-500/20 text-cyan-300 border-cyan-500/30' : 'bg-slate-800/40 text-slate-300 border-slate-700/30 hover:bg-slate-700/30'}`}
              >
                {drawMode ? 'Drawing: ON' : 'Draw Trendline'}
              </button>
              <button
                onClick={clearDrawings}
                className="px-3 py-1 rounded-lg text-xs font-semibold border border-slate-700/30 bg-slate-800/40 text-slate-300 hover:bg-slate-700/30"
              >
                Clear
              </button>
            </div>
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-5 gap-4">
            <div className="lg:col-span-4 space-y-3">
              <div className="glass-card p-4 rounded-xl">
                <div ref={priceRef} style={{ width: '100%' }} />
              </div>
              {showRSI && (
                <div className="glass-card p-4 rounded-xl">
                  <div className="text-xs text-slate-500 mb-2">
                    RSI (14)
                  </div>
                  <div ref={rsiRef} style={{ width: '100%' }} />
                </div>
              )}
              {showMACD && (
                <div className="glass-card p-4 rounded-xl">
                  <div className="text-xs text-slate-500 mb-2">MACD (12, 26, 9)</div>
                  <div ref={macdRef} style={{ width: '100%' }} />
                </div>
              )}
            </div>

            <div className="lg:col-span-1">
              <div className="glass-card p-4 rounded-xl">
                <div className="flex items-center justify-between mb-3">
                  <div>
                    <div className="text-sm font-bold text-white">Volume Profile</div>
                    <div className="text-xs text-slate-500">Approx. by typical price</div>
                  </div>
                </div>
                {profile.length === 0 ? (
                  <div className="text-sm text-slate-500">Not enough data</div>
                ) : (
                  <div className="space-y-1">
                    {profile.slice(0, 18).map((b, idx) => (
                      <div key={idx} className="flex items-center gap-2">
                        <div className="text-[10px] text-slate-500 w-16 font-mono">
                          {b.lo.toFixed(0)}-{b.hi.toFixed(0)}
                        </div>
                        <div className="flex-1 h-2 bg-slate-800/40 rounded overflow-hidden">
                          <div className="h-full bg-slate-500/50" style={{ width: `${Math.max(2, Math.min(100, b.pct))}%` }} />
                        </div>
                      </div>
                    ))}
                  </div>
                )}
                <div className="mt-3 text-[10px] text-slate-500">
                  {comparisonSymbol ? `Compare overlay: ${comparisonSymbol}` : 'Add a comparison symbol to overlay % change.'}
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ULTIMATE ANALYSIS ENGINE - Advanced Scoring & Pattern Detection
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    class UltimateAnalysisEngine {
      constructor() {
        this.cache = new Map();
        this.cacheDuration = 300000; // 5 minutes
      }

      // 15-Factor Advanced Scoring System
      calculateUltimateScore(stock) {
        const factors = {};
        let totalScore = 0;
        let maxScore = 0;

        // 1. RSI Score (15 points)
        if (stock.rsi) {
          maxScore += 15;
          const rsi = parseFloat(stock.rsi);
          if (rsi >= 40 && rsi <= 60) {
            factors.rsi = 15;
          } else if (rsi >= 30 && rsi <= 70) {
            factors.rsi = 10;
          } else if (rsi < 30) {
            factors.rsi = 12; // Oversold = potential bounce
          } else {
            factors.rsi = 5;
          }
          totalScore += factors.rsi;
        }

        // 2. MACD Score (10 points)
        if (stock.macd || stock.macdHistogram) {
          maxScore += 10;
          const macd = parseFloat(stock.macd || stock.macdHistogram || 0);
          if (macd > 0) {
            factors.macd = 10;
          } else if (macd > -0.5) {
            factors.macd = 7;
          } else {
            factors.macd = 3;
          }
          totalScore += factors.macd;
        }

        // 3. Moving Average Trend (12 points)
        if (stock.sma20 && stock.sma50) {
          maxScore += 12;
          const price = parseFloat(stock.price);
          const sma20 = parseFloat(stock.sma20);
          const sma50 = parseFloat(stock.sma50);

          if (price > sma20 && sma20 > sma50) {
            factors.trend = 12; // Golden cross
          } else if (price > sma20 || sma20 > sma50) {
            factors.trend = 8;
          } else {
            factors.trend = 3;
          }
          totalScore += factors.trend;
        }

        // 4. Volume Momentum (10 points)
        if (stock.volume && stock.avgVolume) {
          maxScore += 10;
          const volumeRatio = parseFloat(stock.volume) / parseFloat(stock.avgVolume);
          if (volumeRatio > 2.0) {
            factors.volume = 10; // Surge
          } else if (volumeRatio > 1.5) {
            factors.volume = 8;
          } else if (volumeRatio > 1.0) {
            factors.volume = 5;
          } else {
            factors.volume = 2;
          }
          totalScore += factors.volume;
        }

        // 5. Valuation Score (8 points)
        if (stock.pe) {
          maxScore += 8;
          const pe = parseFloat(stock.pe);
          if (pe > 0 && pe < 15) {
            factors.valuation = 8;
          } else if (pe >= 15 && pe < 25) {
            factors.valuation = 6;
          } else if (pe >= 25 && pe < 40) {
            factors.valuation = 4;
          } else {
            factors.valuation = 2;
          }
          totalScore += factors.valuation;
        }

        // 6. Profitability (8 points)
        if (stock.roe) {
          maxScore += 8;
          const roe = parseFloat(stock.roe);
          if (roe > 20) {
            factors.profitability = 8;
          } else if (roe > 15) {
            factors.profitability = 6;
          } else if (roe > 10) {
            factors.profitability = 4;
          } else {
            factors.profitability = 2;
          }
          totalScore += factors.profitability;
        }

        // 7. Growth Score (10 points)
        if (stock.revenueGrowth || stock.epsGrowth) {
          maxScore += 10;
          const growth = Math.max(
            parseFloat(stock.revenueGrowth || 0),
            parseFloat(stock.epsGrowth || 0)
          );
          if (growth > 20) {
            factors.growth = 10;
          } else if (growth > 10) {
            factors.growth = 7;
          } else if (growth > 5) {
            factors.growth = 4;
          } else {
            factors.growth = 2;
          }
          totalScore += factors.growth;
        }

        // 8. Financial Health (8 points)
        if (stock.debtToEquity !== undefined) {
          maxScore += 8;
          const dte = parseFloat(stock.debtToEquity);
          if (dte < 0.5) {
            factors.health = 8;
          } else if (dte < 1.0) {
            factors.health = 6;
          } else if (dte < 2.0) {
            factors.health = 4;
          } else {
            factors.health = 2;
          }
          totalScore += factors.health;
        }

        // 9. Momentum (7 points)
        if (stock.changePct !== undefined) {
          maxScore += 7;
          const change = parseFloat(stock.changePct);
          if (change > 5) {
            factors.momentum = 7;
          } else if (change > 2) {
            factors.momentum = 5;
          } else if (change > 0) {
            factors.momentum = 3;
          } else if (change > -2) {
            factors.momentum = 2;
          } else {
            factors.momentum = 1;
          }
          totalScore += factors.momentum;
        }

        // 10. Volatility (6 points) - Lower is better
        if (stock.beta) {
          maxScore += 6;
          const beta = Math.abs(parseFloat(stock.beta));
          if (beta < 0.8) {
            factors.volatility = 6; // Low volatility = stable
          } else if (beta < 1.2) {
            factors.volatility = 4;
          } else {
            factors.volatility = 2;
          }
          totalScore += factors.volatility;
        }

        // 11. Market Position (6 points)
        if (stock.marketCap) {
          maxScore += 6;
          const mcap = parseFloat(stock.marketCap);
          if (mcap > 200e9) { // Large cap
            factors.market_pos = 6;
          } else if (mcap > 10e9) { // Mid cap
            factors.market_pos = 5;
          } else if (mcap > 2e9) { // Small cap
            factors.market_pos = 4;
          } else {
            factors.market_pos = 3; // Micro cap = higher risk
          }
          totalScore += factors.market_pos;
        }

        // 12. Analyst Sentiment (5 points)
        if (stock.analystRating || stock.rating) {
          maxScore += 5;
          const rating = stock.analystRating || stock.rating || '';
          if (rating.toLowerCase().includes('strong buy') || rating.toLowerCase().includes('buy')) {
            factors.analyst = 5;
          } else if (rating.toLowerCase().includes('hold')) {
            factors.analyst = 3;
          } else {
            factors.analyst = 1;
          }
          totalScore += factors.analyst;
        }

        // 13. Price Position (5 points) - Distance from 52w high
        if (stock.week52High && stock.price) {
          maxScore += 5;
          const distanceFrom52wHigh = ((parseFloat(stock.price) - parseFloat(stock.week52High)) / parseFloat(stock.week52High)) * 100;
          if (distanceFrom52wHigh > -5) {
            factors.price_pos = 5; // Near 52w high
          } else if (distanceFrom52wHigh > -15) {
            factors.price_pos = 4;
          } else if (distanceFrom52wHigh > -30) {
            factors.price_pos = 3;
          } else {
            factors.price_pos = 2; // Far from high, potential recovery
          }
          totalScore += factors.price_pos;
        }

        // 14. Dividend Yield (4 points) - Bonus for income
        if (stock.dividendYield) {
          maxScore += 4;
          const divYield = parseFloat(stock.dividendYield);
          if (divYield > 3) {
            factors.dividend = 4;
          } else if (divYield > 2) {
            factors.dividend = 3;
          } else if (divYield > 1) {
            factors.dividend = 2;
          } else {
            factors.dividend = 1;
          }
          totalScore += factors.dividend;
        }

        // 15. Institutional Ownership (6 points)
        if (stock.institutionalOwnership) {
          maxScore += 6;
          const instOwn = parseFloat(stock.institutionalOwnership);
          if (instOwn > 70) {
            factors.institutional = 6;
          } else if (instOwn > 50) {
            factors.institutional = 5;
          } else if (instOwn > 30) {
            factors.institutional = 4;
          } else {
            factors.institutional = 2;
          }
          totalScore += factors.institutional;
        }

        // Normalize to 100
        const normalizedScore = maxScore > 0 ? Math.round((totalScore / maxScore) * 100) : 0;

        return {
          score: normalizedScore,
          factors: factors,
          totalPoints: totalScore,
          maxPoints: maxScore,
          confidence: maxScore > 80 ? 'High' : maxScore > 50 ? 'Medium' : 'Low'
        };
      }

      // Generate AI-Powered Trading Plan
      generateTradingPlan(stock, scoreData) {
        const price = parseFloat(stock.price);
        const atr = stock.atr ? parseFloat(stock.atr) : price * 0.02;
        const signal = this.determineSignal(stock, scoreData);

        let plan = {
          signal: signal,
          entry: price,
          target: 0,
          stopLoss: 0,
          positionSize: '2-5%',
          timeframe: 'Medium-term (2-8 weeks)',
          confidence: scoreData.confidence,
          reasoning: []
        };

        if (signal === 'BUY') {
          // Target: 10-15% above entry based on score
          const targetMultiplier = 1 + (scoreData.score / 1000) + 0.05;
          plan.target = price * targetMultiplier;

          // Stop loss: 2x ATR below entry
          plan.stopLoss = price - (2 * atr);

          // Reasoning
          if (stock.rsi && parseFloat(stock.rsi) < 35) {
            plan.reasoning.push('Oversold RSI indicates potential bounce');
          }
          if (scoreData.factors.volume && scoreData.factors.volume >= 8) {
            plan.reasoning.push('Strong volume surge suggests institutional interest');
          }
          if (scoreData.factors.trend && scoreData.factors.trend >= 10) {
            plan.reasoning.push('Golden cross formation supports bullish trend');
          }
          if (scoreData.factors.growth && scoreData.factors.growth >= 7) {
            plan.reasoning.push('Strong growth metrics indicate expansion');
          }

        } else if (signal === 'SELL') {
          plan.target = price * 0.95; // Exit target
          plan.stopLoss = price * 1.05; // Stop if it reverses up

          if (stock.rsi && parseFloat(stock.rsi) > 70) {
            plan.reasoning.push('Overbought RSI suggests potential correction');
          }
          if (scoreData.score < 40) {
            plan.reasoning.push('Low overall score indicates weakness');
          }

        } else { // HOLD
          plan.target = price * 1.05;
          plan.stopLoss = price * 0.95;
          plan.reasoning.push('Mixed signals - monitor for clearer direction');
        }

        // Risk/Reward ratio
        plan.riskRewardRatio = plan.stopLoss !== price ?
          ((plan.target - price) / (price - plan.stopLoss)).toFixed(2) : 0;

        return plan;
      }

      // Determine trading signal
      determineSignal(stock, scoreData) {
        const score = scoreData.score;
        const rsi = stock.rsi ? parseFloat(stock.rsi) : 50;
        const macd = stock.macd ? parseFloat(stock.macd) : 0;

        // Strong buy conditions
        if (score >= 75 && rsi < 70 && macd > 0) {
          return 'STRONG BUY';
        }

        // Buy conditions
        if (score >= 60 || (rsi < 35 && score >= 50)) {
          return 'BUY';
        }

        // Sell conditions
        if (score < 35 || (rsi > 75 && score < 60)) {
          return 'SELL';
        }

        // Default hold
        return 'HOLD';
      }

      // Detect chart patterns
      detectPatterns(stock) {
        const patterns = [];

        // Check for basic patterns based on available data
        if (stock.sma20 && stock.sma50) {
          const price = parseFloat(stock.price);
          const sma20 = parseFloat(stock.sma20);
          const sma50 = parseFloat(stock.sma50);

          if (sma20 > sma50 && price > sma20) {
            patterns.push({
              name: 'Golden Cross',
              type: 'bullish',
              confidence: 0.80,
              description: '20-day MA crossed above 50-day MA - bullish momentum'
            });
          } else if (sma20 < sma50 && price < sma20) {
            patterns.push({
              name: 'Death Cross',
              type: 'bearish',
              confidence: 0.75,
              description: '20-day MA crossed below 50-day MA - bearish momentum'
            });
          }
        }

        // RSI-based patterns
        if (stock.rsi) {
          const rsi = parseFloat(stock.rsi);
          if (rsi < 30) {
            patterns.push({
              name: 'Oversold',
              type: 'bullish',
              confidence: 0.70,
              description: 'RSI below 30 - potential bounce opportunity'
            });
          } else if (rsi > 70) {
            patterns.push({
              name: 'Overbought',
              type: 'bearish',
              confidence: 0.70,
              description: 'RSI above 70 - potential correction incoming'
            });
          }
        }

        // Volume patterns
        if (stock.volume && stock.avgVolume) {
          const volumeRatio = parseFloat(stock.volume) / parseFloat(stock.avgVolume);
          if (volumeRatio > 2.0) {
            patterns.push({
              name: 'Volume Surge',
              type: 'bullish',
              confidence: 0.65,
              description: 'Volume 2x above average - institutional interest'
            });
          }
        }

        // Bollinger Band patterns
        if (stock.bollingerUpper && stock.bollingerLower && stock.price) {
          const price = parseFloat(stock.price);
          const upper = parseFloat(stock.bollingerUpper);
          const lower = parseFloat(stock.bollingerLower);

          if (price <= lower) {
            patterns.push({
              name: 'Bollinger Bounce',
              type: 'bullish',
              confidence: 0.68,
              description: 'Price at lower Bollinger Band - potential bounce'
            });
          } else if (price >= upper) {
            patterns.push({
              name: 'Bollinger Squeeze',
              type: 'bearish',
              confidence: 0.68,
              description: 'Price at upper Bollinger Band - potential pullback'
            });
          }
        }

        return patterns;
      }

      // Generate comprehensive AI insights
      generateAIInsights(stock, scoreData, patterns, tradingPlan) {
        const insights = {
          summary: '',
          strengths: [],
          risks: [],
          opportunities: [],
          recommendation: ''
        };

        // Summary
        insights.summary = `${stock.symbol} scores ${scoreData.score}/100 with a ${tradingPlan.signal} signal. `;

        if (scoreData.score >= 70) {
          insights.summary += 'Strong fundamentals and technical setup. ';
        } else if (scoreData.score >= 50) {
          insights.summary += 'Moderate quality with mixed signals. ';
        } else {
          insights.summary += 'Weak metrics indicate caution. ';
        }

        // Strengths
        if (scoreData.factors.trend && scoreData.factors.trend >= 10) {
          insights.strengths.push('Bullish trend confirmed by moving averages');
        }
        if (scoreData.factors.volume && scoreData.factors.volume >= 8) {
          insights.strengths.push('Strong volume supports price movement');
        }
        if (scoreData.factors.growth && scoreData.factors.growth >= 7) {
          insights.strengths.push('Solid revenue and earnings growth');
        }
        if (scoreData.factors.profitability && scoreData.factors.profitability >= 6) {
          insights.strengths.push('High return on equity indicates efficiency');
        }

        // Risks
        if (stock.rsi && parseFloat(stock.rsi) > 70) {
          insights.risks.push('Overbought conditions may lead to correction');
        }
        if (stock.debtToEquity && parseFloat(stock.debtToEquity) > 2.0) {
          insights.risks.push('High debt levels increase financial risk');
        }
        if (stock.beta && Math.abs(parseFloat(stock.beta)) > 1.5) {
          insights.risks.push('High volatility stock - expect sharp moves');
        }
        if (scoreData.factors.valuation && scoreData.factors.valuation <= 4) {
          insights.risks.push('Expensive valuation may limit upside');
        }

        // Opportunities
        if (stock.rsi && parseFloat(stock.rsi) < 35) {
          insights.opportunities.push('Oversold bounce play if fundamentals hold');
        }
        if (patterns.some(p => p.type === 'bullish' && p.confidence > 0.7)) {
          insights.opportunities.push('Bullish chart patterns forming');
        }
        if (scoreData.factors.price_pos && scoreData.factors.price_pos <= 3) {
          insights.opportunities.push('Trading well below 52-week high - recovery potential');
        }

        // Recommendation
        if (tradingPlan.signal === 'STRONG BUY' || tradingPlan.signal === 'BUY') {
          insights.recommendation = `Consider ${tradingPlan.positionSize} position. Entry: $${tradingPlan.entry.toFixed(2)}, Target: $${tradingPlan.target.toFixed(2)}, Stop: $${tradingPlan.stopLoss.toFixed(2)}. Risk/Reward: ${tradingPlan.riskRewardRatio}:1`;
        } else if (tradingPlan.signal === 'HOLD') {
          insights.recommendation = 'Wait for clearer signals. Monitor key levels and upcoming catalysts.';
        } else {
          insights.recommendation = 'Avoid or exit position. Consider better opportunities.';
        }

        return insights;
      }
    }

    // Initialize global Ultimate Analysis Engine
    const ultimateEngine = new UltimateAnalysisEngine();
    window.ultimateEngine = ultimateEngine;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // THE ORACLE - MULTI-AGENT ANALYSIS SYSTEM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    class OracleAnalyzer {
      constructor() {
        this.baseUrl = `${API_BASE_URL}/api/oracle`;
        this.eventSources = {};
      }

      async startAnalysis(symbol) {
        try {
          const response = await fetch(`${this.baseUrl}/analyze`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ symbol })
          });

          if (!response.ok) {
            throw new Error(`API error: ${response.status}`);
          }

          const data = await response.json();
          return data;
        } catch (error) {
          console.error('The Oracle analysis error:', error);
          throw error;
        }
      }

      subscribeToProgress(symbol, onUpdate, onComplete, onError) {
        const eventSource = new EventSource(`${this.baseUrl}/progress/${symbol}`);
        this.eventSources[symbol] = eventSource;

        eventSource.onmessage = (event) => {
          try {
            const data = JSON.parse(event.data);

            if (data.type === 'complete') {
              onComplete(data.result);
              eventSource.close();
              delete this.eventSources[symbol];
            } else if (data.type === 'error') {
              onError(data.error);
              eventSource.close();
              delete this.eventSources[symbol];
            } else if (data.type !== 'ping' && data.type !== 'connected') {
              onUpdate(data);
            }
          } catch (e) {
            console.error('Error parsing SSE data:', e);
          }
        };

        eventSource.onerror = (error) => {
          console.error('SSE connection error:', error);
          onError('Connection lost to analysis server');
          eventSource.close();
          delete this.eventSources[symbol];
        };

        return () => {
          eventSource.close();
          delete this.eventSources[symbol];
        };
      }

      async getCachedResult(symbol) {
        try {
          const response = await fetch(`${this.baseUrl}/result/${symbol}`);
          if (!response.ok) return null;
          const data = await response.json();
          return data.result;
        } catch (error) {
          return null;
        }
      }

      async listCachedAnalyses() {
        try {
          const response = await fetch(`${this.baseUrl}/cache`);
          if (!response.ok) return [];
          const data = await response.json();
          return data.cached_analyses || [];
        } catch (error) {
          return [];
        }
      }
    }

    // Initialize global Oracle analyzer
    const oracleAnalyzer = new OracleAnalyzer();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // THE ORACLE ANALYSIS MODAL COMPONENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function OracleAnalysisModal({ stock, onClose }) {
      const [analysisState, setAnalysisState] = React.useState('idle'); // idle, loading, analyzing, complete, error
      const [progressUpdates, setProgressUpdates] = React.useState([]);
      const [result, setResult] = React.useState(null);
      const [error, setError] = React.useState(null);
      const [cachedResult, setCachedResult] = React.useState(null);

      React.useEffect(() => {
        // Check for cached result on mount
        oracleAnalyzer.getCachedResult(stock.symbol).then(cached => {
          if (cached) {
            setCachedResult(cached);
          }
        });
      }, [stock.symbol]);

      const startAnalysis = async () => {
        try {
          setAnalysisState('loading');
          setProgressUpdates([]);
          setError(null);

          // Start the analysis
          const startResponse = await oracleAnalyzer.startAnalysis(stock.symbol);

          if (startResponse.status === 'cached') {
            setResult(startResponse.result);
            setAnalysisState('complete');
            return;
          }

          setAnalysisState('analyzing');

          // Subscribe to progress updates
          oracleAnalyzer.subscribeToProgress(
            stock.symbol,
            // onUpdate
            (update) => {
              setProgressUpdates(prev => [...prev, update]);
            },
            // onComplete
            (finalResult) => {
              setResult(finalResult);
              setAnalysisState('complete');
            },
            // onError
            (errorMsg) => {
              setError(errorMsg);
              setAnalysisState('error');
            }
          );

        } catch (err) {
          setError(err.message);
          setAnalysisState('error');
        }
      };

      const getAgentIcon = (agent) => {
        const icons = {
          'financial_news_analyst': 'ğŸ“°',
          'technical_analysis_specialist': 'ğŸ“Š',
          'fundamental_analysis_expert': 'ğŸ’°',
          'investment_opportunity_strategist': 'ğŸ¯',
          'system': 'âš™ï¸'
        };
        return icons[agent] || 'ğŸ¤–';
      };

      const getAgentName = (agent) => {
        const names = {
          'financial_news_analyst': 'Financial News Analyst',
          'technical_analysis_specialist': 'Technical Analysis Specialist',
          'fundamental_analysis_expert': 'Fundamental Analysis Expert',
          'investment_opportunity_strategist': 'Investment Opportunity Strategist',
          'system': 'System'
        };
        return names[agent] || agent;
      };

      return (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4 animate-fadeIn">
          <div className="bg-gradient-to-br from-slate-900 to-slate-800 rounded-2xl shadow-2xl border border-cyan-500/20 max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            {/* Header */}
            <div className="p-6 border-b border-slate-700/50 flex items-center justify-between bg-gradient-to-r from-slate-800 to-slate-900">
              <div>
                <h2 className="text-2xl font-bold text-white flex items-center gap-3">
                  <span className="text-3xl">ğŸ¤–</span>
                  Multi-Agent AI Analysis
                </h2>
                <p className="text-slate-400 mt-1">
                  {stock.symbol} - {stock.companyName || stock.symbol}
                </p>
              </div>
              <button
                onClick={onClose}
                className="text-slate-400 hover:text-white transition-colors p-2 hover:bg-slate-700/50 rounded-lg"
              >
                <i className="fas fa-times text-xl"></i>
              </button>
            </div>

            {/* Content */}
            <div className="flex-1 overflow-y-auto p-6 space-y-6">
              {/* Cached Result Notice */}
              {cachedResult && analysisState === 'idle' && (
                <div className="bg-blue-500/10 border border-blue-500/30 rounded-xl p-4">
                  <div className="flex items-start gap-3">
                    <i className="fas fa-info-circle text-blue-400 text-xl mt-0.5"></i>
                    <div className="flex-1">
                      <h4 className="text-blue-300 font-semibold mb-1">Cached Analysis Available</h4>
                      <p className="text-slate-300 text-sm">
                        An analysis from {new Date(cachedResult.timestamp).toLocaleString()} is available.
                        You can view it or run a fresh analysis.
                      </p>
                      <button
                        onClick={() => {
                          setResult(cachedResult);
                          setAnalysisState('complete');
                        }}
                        className="mt-3 px-4 py-2 bg-blue-500/20 hover:bg-blue-500/30 border border-blue-500/40 rounded-lg text-blue-300 text-sm font-medium transition-colors"
                      >
                        View Cached Analysis
                      </button>
                    </div>
                  </div>
                </div>
              )}

              {/* Description */}
              {analysisState === 'idle' && (
                <div className="space-y-4">
                  <p className="text-slate-300 leading-relaxed">
                    Launch a comprehensive multi-agent analysis powered by The Oracle. Four specialized AI agents will collaborate to analyze {stock.symbol}:
                  </p>

                  <div className="grid gap-3">
                    <div className="bg-slate-800/50 rounded-lg p-4 border border-slate-700/50">
                      <div className="flex items-center gap-3 mb-2">
                        <span className="text-2xl">ğŸ“°</span>
                        <h4 className="text-white font-semibold">Financial News Analyst</h4>
                      </div>
                      <p className="text-slate-400 text-sm">
                        Monitors real-time news, sentiment, and market-moving events
                      </p>
                    </div>

                    <div className="bg-slate-800/50 rounded-lg p-4 border border-slate-700/50">
                      <div className="flex items-center gap-3 mb-2">
                        <span className="text-2xl">ğŸ“Š</span>
                        <h4 className="text-white font-semibold">Technical Analysis Specialist</h4>
                      </div>
                      <p className="text-slate-400 text-sm">
                        Analyzes charts, patterns, indicators, and technical signals
                      </p>
                    </div>

                    <div className="bg-slate-800/50 rounded-lg p-4 border border-slate-700/50">
                      <div className="flex items-center gap-3 mb-2">
                        <span className="text-2xl">ğŸ’°</span>
                        <h4 className="text-white font-semibold">Fundamental Analysis Expert</h4>
                      </div>
                      <p className="text-slate-400 text-sm">
                        Evaluates financials, valuation, earnings, and intrinsic value
                      </p>
                    </div>

                    <div className="bg-slate-800/50 rounded-lg p-4 border border-slate-700/50">
                      <div className="flex items-center gap-3 mb-2">
                        <span className="text-2xl">ğŸ¯</span>
                        <h4 className="text-white font-semibold">Investment Opportunity Strategist</h4>
                      </div>
                      <p className="text-slate-400 text-sm">
                        Synthesizes all insights into actionable investment recommendations
                      </p>
                    </div>
                  </div>

                  <div className="bg-amber-500/10 border border-amber-500/30 rounded-lg p-4 mt-4">
                    <div className="flex items-start gap-3">
                      <i className="fas fa-clock text-amber-400 text-lg mt-0.5"></i>
                      <div>
                        <p className="text-amber-300 text-sm font-medium">Analysis Duration</p>
                        <p className="text-slate-400 text-sm mt-1">
                          This comprehensive analysis typically takes 2-5 minutes as agents research and collaborate.
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Progress Updates */}
              {analysisState === 'analyzing' && (
                <div className="space-y-3">
                  <div className="flex items-center gap-3 mb-4">
                    <div className="animate-spin rounded-full h-6 w-6 border-b-2 border-cyan-500"></div>
                    <p className="text-white font-medium">Analysis in Progress...</p>
                  </div>

                  <div className="space-y-2 max-h-96 overflow-y-auto">
                    {progressUpdates.map((update, idx) => (
                      <div
                        key={idx}
                        className="bg-slate-800/50 rounded-lg p-4 border border-slate-700/50 animate-slideInLeft"
                        style={{ animationDelay: `${idx * 0.1}s` }}
                      >
                        <div className="flex items-start gap-3">
                          <span className="text-2xl">{getAgentIcon(update.agent)}</span>
                          <div className="flex-1">
                            <div className="flex items-center justify-between mb-1">
                              <h4 className="text-white font-medium">{getAgentName(update.agent)}</h4>
                              <span className="text-xs text-slate-500">
                                {new Date(update.timestamp).toLocaleTimeString()}
                              </span>
                            </div>
                            <p className="text-slate-300 text-sm">{update.message}</p>
                            {update.status && (
                              <span className={`inline-block mt-2 px-2 py-1 rounded text-xs font-medium ${update.status === 'running' ? 'bg-blue-500/20 text-blue-300' :
                                  update.status === 'complete' ? 'bg-green-500/20 text-green-300' :
                                    'bg-slate-500/20 text-slate-300'
                                }`}>
                                {update.status}
                              </span>
                            )}
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* Results */}
              {analysisState === 'complete' && result && (
                <div className="space-y-4">
                  <div className="bg-green-500/10 border border-green-500/30 rounded-xl p-4">
                    <div className="flex items-center gap-3">
                      <i className="fas fa-check-circle text-green-400 text-2xl"></i>
                      <div>
                        <h4 className="text-green-300 font-semibold">Analysis Complete!</h4>
                        <p className="text-slate-400 text-sm">
                          Generated at {new Date(result.timestamp).toLocaleString()}
                        </p>
                      </div>
                    </div>
                  </div>

                  {/* Individual Agent Outputs */}
                  {result.agents_output && result.agents_output.length > 0 && (
                    <div className="space-y-3">
                      <h3 className="text-white font-semibold text-lg">Agent Reports</h3>
                      {result.agents_output.map((agentOutput, idx) => (
                        <div key={idx} className="bg-slate-800/50 rounded-lg p-4 border border-slate-700/50">
                          <div className="flex items-start justify-between mb-3">
                            <h4 className="text-cyan-400 font-medium flex items-center gap-2">
                              <span>{getAgentIcon(agentOutput.agent)}</span>
                              {getAgentName(agentOutput.agent)}
                            </h4>
                            <div className="flex items-center gap-3">
                              <span className={`px-3 py-1 rounded-lg text-xs font-bold ${agentOutput.action === 'BUY' || agentOutput.action === 'STRONG_BUY' ? 'bg-green-500/20 text-green-400' :
                                  agentOutput.action === 'SELL' || agentOutput.action === 'STRONG_SELL' ? 'bg-red-500/20 text-red-400' :
                                    'bg-yellow-500/20 text-yellow-400'
                                }`}>
                                {agentOutput.action}
                              </span>
                              <span className="text-cyan-400 font-semibold text-sm">
                                {agentOutput.confidence}% confidence
                              </span>
                            </div>
                          </div>

                          {agentOutput.target_price && (
                            <div className="grid grid-cols-2 gap-3 mb-3">
                              <div className="bg-slate-900/50 rounded p-2">
                                <div className="text-xs text-slate-500 mb-1">Target Price</div>
                                <div className="text-green-400 font-semibold">${agentOutput.target_price.toFixed(2)}</div>
                              </div>
                              {agentOutput.stop_loss && (
                                <div className="bg-slate-900/50 rounded p-2">
                                  <div className="text-xs text-slate-500 mb-1">Stop Loss</div>
                                  <div className="text-red-400 font-semibold">${agentOutput.stop_loss.toFixed(2)}</div>
                                </div>
                              )}
                            </div>
                          )}

                          {agentOutput.key_factors && agentOutput.key_factors.length > 0 && (
                            <div className="mb-3">
                              <div className="text-xs text-slate-500 mb-2">Key Factors:</div>
                              <div className="flex flex-wrap gap-2">
                                {agentOutput.key_factors.map((factor, fIdx) => (
                                  <span key={fIdx} className="px-2 py-1 bg-purple-500/20 text-purple-300 text-xs rounded">
                                    {factor}
                                  </span>
                                ))}
                              </div>
                            </div>
                          )}

                          <pre className="text-slate-300 text-sm whitespace-pre-wrap font-mono bg-slate-900/50 p-3 rounded overflow-x-auto">
                            {agentOutput.output}
                          </pre>
                        </div>
                      ))}
                    </div>
                  )}

                  {/* Full Analysis */}
                  <div className="bg-slate-800/50 rounded-lg p-4 border border-slate-700/50">
                    <h4 className="text-white font-semibold mb-3">Complete Analysis</h4>
                    <pre className="text-slate-300 text-sm whitespace-pre-wrap font-mono bg-slate-900/50 p-4 rounded max-h-96 overflow-y-auto">
                      {result.raw_output || result.analysis}
                    </pre>
                  </div>
                </div>
              )}

              {/* Error State */}
              {analysisState === 'error' && (
                <div className="bg-red-500/10 border border-red-500/30 rounded-xl p-4">
                  <div className="flex items-start gap-3">
                    <i className="fas fa-exclamation-circle text-red-400 text-2xl"></i>
                    <div className="flex-1">
                      <h4 className="text-red-300 font-semibold mb-1">Analysis Failed</h4>
                      <p className="text-slate-300 text-sm mb-3">{error}</p>
                      <p className="text-slate-400 text-sm">
                        Make sure The Oracle backend is running.
                      </p>
                    </div>
                  </div>
                </div>
              )}
            </div>

            {/* Footer Actions */}
            <div className="p-6 border-t border-slate-700/50 bg-slate-800/50 flex items-center justify-between">
              <div>
                {analysisState === 'complete' && (
                  <button
                    onClick={() => {
                      setAnalysisState('idle');
                      setResult(null);
                      setProgressUpdates([]);
                    }}
                    className="px-4 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white font-medium transition-colors"
                  >
                    <i className="fas fa-redo mr-2"></i>
                    Run New Analysis
                  </button>
                )}
              </div>
              <div className="flex items-center gap-3">
                <button
                  onClick={onClose}
                  className="px-6 py-2 bg-slate-700 hover:bg-slate-600 rounded-lg text-white font-medium transition-colors"
                >
                  Close
                </button>
                {analysisState === 'idle' && (
                  <button
                    onClick={startAnalysis}
                    className="px-6 py-2 bg-gradient-to-r from-cyan-500 to-blue-500 hover:from-cyan-600 hover:to-blue-600 rounded-lg text-white font-semibold transition-all transform hover:scale-105 shadow-lg shadow-cyan-500/25"
                  >
                    <i className="fas fa-robot mr-2"></i>
                    Start Multi-Agent Analysis
                  </button>
                )}
              </div>
            </div>
          </div>
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AI TOURNAMENT COMPONENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function AITournamentModal({ onClose, watchlist = [], stocks = [] }) {
      const [activeTab, setActiveTab] = useState('overview');
      const [tournamentStatus, setTournamentStatus] = useState('idle'); // idle, running, completed, error
      const [tournamentResults, setTournamentResults] = useState(null);
      const [leaderboard, setLeaderboard] = useState([]);
      const [tournamentDays, setTournamentDays] = useState(7);
      const [activeTeams, setActiveTeams] = useState([1, 2, 3, 4]);
      const [logs, setLogs] = useState([]);
      const [currentDay, setCurrentDay] = useState(0);
      const [experimentId, setExperimentId] = useState(null);
      const eventSourceRef = useRef(null);
      const pollIntervalRef = useRef(null);

      // Use all available stocks instead of just watchlist
      const availableStocks = useMemo(() => {
        // If stocks prop is provided, use it; otherwise fallback to DEMO_STOCKS or watchlist
        const sourceStocks = stocks.length > 0 ? stocks : (typeof DEMO_STOCKS !== 'undefined' ? DEMO_STOCKS : []);
        return sourceStocks;
      }, [stocks]);

      const availableSymbols = useMemo(() => {
        return availableStocks.map(stock => stock.symbol || stock);
      }, [availableStocks]);

      const addLog = (message, type = 'info') => {
        const timestamp = new Date().toLocaleTimeString();
        setLogs(prev => [{
          time: timestamp,
          message,
          type
        }, ...prev].slice(0, 200));
      };

      const startTournament = async () => {
        if (tournamentStatus === 'running') return;

        setTournamentStatus('running');
        setLogs([]);
        setCurrentDay(0);
        setLeaderboard([]);

        try {
          // Use all available symbols instead of just watchlist
          const symbolsToUse = availableSymbols.length > 0 ? availableSymbols : ['AAPL', 'MSFT', 'GOOGL', 'AMZN', 'TSLA'];

          addLog(`ğŸš€ Starting tournament with ${symbolsToUse.length} stocks...`, 'info');

          const response = await fetch(`${API_BASE_URL}/api/tournament/start`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              days: tournamentDays,
              teams: activeTeams,
              watchlist: symbolsToUse, // Send all available stocks
              useAllStocks: true // Flag to indicate using all stocks
            })
          });

          if (response.ok) {
            const data = await response.json();
            setExperimentId(data.experimentId);
            connectToSSE(data.experimentId);
            addLog(`ğŸ† Tournament started on backend server with ${symbolsToUse.length} stocks`, 'success');
          } else {
            throw new Error('Failed to start tournament');
          }
        } catch (error) {
          addLog(`âŒ Failed to start: ${error.message}`, 'error');
          setTournamentStatus('error');
        }
      };

      const pollTournamentStatus = async (experimentId) => {
        // Clear any existing polling
        if (pollIntervalRef.current) {
          clearInterval(pollIntervalRef.current);
          pollIntervalRef.current = null;
        }

        // If experimentId is 'current', use the current status endpoint
        const statusUrl = experimentId === 'current'
          ? `${API_BASE_URL}/api/tournament/status/current`
          : `${API_BASE_URL}/api/tournament/status/${experimentId}`;

        pollIntervalRef.current = setInterval(async () => {
          // FIX: Don't poll when tab is hidden to prevent hanging
          if (document.hidden) {
            console.log('ğŸ“´ Skipping tournament poll - tab hidden');
            return;
          }
          
          try {
            const response = await fetch(statusUrl);
            if (response.ok) {
              const data = await response.json();

              if (data.status === 'running') {
                setCurrentDay(data.current_day || 0);
                if (data.logs && data.logs.length > 0) {
                  data.logs.forEach(log => {
                    if (!logs.some(l => l.message === log.message && l.time === log.time)) {
                      addLog(log.message, log.type || 'info');
                    }
                  });
                }
              } else if (data.status === 'completed') {
                if (pollIntervalRef.current) {
                  clearInterval(pollIntervalRef.current);
                  pollIntervalRef.current = null;
                }
                setTournamentStatus('completed');
                setTournamentResults(data.results);
                setLeaderboard(data.leaderboard || []);
                addLog('ğŸ† Tournament completed!', 'success');
              } else if (data.status === 'error') {
                if (pollIntervalRef.current) {
                  clearInterval(pollIntervalRef.current);
                  pollIntervalRef.current = null;
                }
                setTournamentStatus('error');
                addLog(`âŒ Tournament error: ${data.error}`, 'error');
              }
            }
          } catch (error) {
            console.error('Poll error:', error);
          }
        }, 3000);

        // FIX: Store timeout ID for proper cleanup
        const timeoutId = setTimeout(() => {
          if (pollIntervalRef.current) {
            clearInterval(pollIntervalRef.current);
            pollIntervalRef.current = null;
          }
        }, 600000); // 10 minutes
        
        // Return cleanup function
        return () => {
          clearTimeout(timeoutId);
          if (pollIntervalRef.current) {
            clearInterval(pollIntervalRef.current);
            pollIntervalRef.current = null;
          }
        };
      };

      // Handle close without stopping tournament
      const handleClose = () => {
        // Only close SSE connections, keep tournament running
        if (eventSourceRef.current) {
          eventSourceRef.current.leaderboard?.close();
          eventSourceRef.current.logs?.close();
          eventSourceRef.current = null;
        }

        onClose();
      };

      const getTeamName = (teamId) => {
        const names = {
          1: 'Team Alpha (Claude-3-Sonnet)',
          2: 'Team Beta (Kimi-K2)',
          3: 'Team Gamma (DeepSeek-V3)',
          4: 'Team Delta (Gemini-Pro)'
        };
        return names[teamId] || `Team ${teamId}`;
      };

      const getRankEmoji = (rank) => {
        if (rank === 1) return 'ğŸ¥‡';
        if (rank === 2) return 'ğŸ¥ˆ';
        if (rank === 3) return 'ğŸ¥‰';
        return `#${rank}`;
      };

      const loadTournamentResults = async () => {
        try {
          const response = await fetch(`${API_BASE_URL}/api/tournament/results`);
          if (response.ok) {
            const data = await response.json();
            if (data.results) {
              setTournamentResults(data.results);
              setLeaderboard(data.leaderboard || []);
              setTournamentStatus('completed');
            }
          }
        } catch (error) {
          console.error('Error loading results:', error);
        }
      };

      // Check for running tournament on mount
      useEffect(() => {
        checkForRunningTournament();

        return () => {
          // Clean up SSE connections and polling intervals on unmount
          if (eventSourceRef.current) {
            eventSourceRef.current.leaderboard?.close();
            eventSourceRef.current.logs?.close();
          }
          if (pollIntervalRef.current) {
            clearInterval(pollIntervalRef.current);
            pollIntervalRef.current = null;
          }
        };
      }, []);

      const checkForRunningTournament = async () => {
        try {
          const response = await fetch(`${API_BASE_URL}/api/tournament/results`);
          if (response.ok) {
            const data = await response.json();
            if (data.results && data.results.status === 'running') {
              setExperimentId(data.results.experimentId);
              setTournamentStatus('running');
              setCurrentDay(data.results.currentDay);
              setTournamentDays(data.results.config.days);
              connectToSSE(data.results.experimentId);
              addLog('ğŸ”„ Reconnected to running tournament', 'success');
            }
          }
        } catch (error) {
          console.log('No running tournament found');
        }
      };

      const connectToSSE = (expId) => {
        // Close existing connections
        if (eventSourceRef.current) {
          eventSourceRef.current.leaderboard?.close();
          eventSourceRef.current.logs?.close();
        }

        // FIX: Don't create SSE when tab is hidden
        if (document.hidden) {
          console.log('ğŸ“´ Deferring SSE connection - tab hidden');
          return;
        }

        // Connect to leaderboard updates
        const leaderboardSSE = new EventSource(
          `${API_BASE_URL}/api/tournament/sse/leaderboard/${expId}`
        );

        leaderboardSSE.onmessage = (event) => {
          // Skip processing when tab is hidden to reduce overhead
          if (document.hidden) return;
          
          const data = JSON.parse(event.data);
          if (data.leaderboard) {
            setLeaderboard(data.leaderboard);
          }
          if (data.status === 'completed') {
            setTournamentStatus('completed');
            setTournamentResults(data);
            leaderboardSSE.close();
          }
        };

        leaderboardSSE.onerror = (error) => {
          console.error('Leaderboard SSE error:', error);
          addLog('âš ï¸ Lost connection to leaderboard updates', 'warning');
          // Auto-reconnect after 5 seconds if still needed
          setTimeout(() => {
            if (tournamentStatus === 'running' && !document.hidden) {
              console.log('ğŸ”„ Reconnecting to SSE...');
              connectToSSE(expId);
            }
          }, 5000);
        };

        // Connect to logs
        const logsSSE = new EventSource(
          `${API_BASE_URL}/api/tournament/sse/logs/${expId}`
        );

        logsSSE.onmessage = (event) => {
          // Skip processing when tab is hidden
          if (document.hidden) return;
          
          const data = JSON.parse(event.data);
          if (data.message) {
            addLog(data.message, data.type);
          }
        };

        logsSSE.onerror = (error) => {
          console.error('Logs SSE error:', error);
        };

        eventSourceRef.current = { leaderboard: leaderboardSSE, logs: logsSSE };
      };

      const checkRunningTournament = async () => {
        try {
          const response = await fetch(`${API_BASE_URL}/api/tournament/status/current`);
          if (response.ok) {
            const data = await response.json();
            if (data.status === 'running') {
              // Tournament is running on server - restore UI state
              console.log('ğŸ”„ Tournament detected running on server - restoring UI state');
              setTournamentStatus('running');
              addLog('ğŸ”„ Tournament is running in background - resuming monitoring', 'info');

              // Try to get the actual experiment ID from the status endpoint
              // If we have an experiment_id, use it; otherwise poll the current status
              if (data.experiment_id && data.experiment_id !== 'tournament_undefined') {
                console.log('ğŸ“‹ Resuming polling for experiment:', data.experiment_id);
                pollTournamentStatus(data.experiment_id);
              } else {
                // Poll current status endpoint periodically to check for updates
                console.log('ğŸ“‹ Polling current tournament status');
                const pollCurrentStatus = setInterval(async () => {
                  try {
                    const statusResponse = await fetch(`${API_BASE_URL}/api/tournament/status/current`);
                    if (statusResponse.ok) {
                      const statusData = await statusResponse.json();
                      if (statusData.status === 'running') {
                        // Tournament still running - update UI
                        setTournamentStatus('running');
                        if (statusData.current_day) {
                          setCurrentDay(statusData.current_day);
                        }
                      } else {
                        // Tournament completed or stopped
                        console.log('ğŸ“‹ Tournament completed or stopped');
                        clearInterval(pollCurrentStatus);
                        setTournamentStatus('idle');
                        loadTournamentResults();
                      }
                    }
                  } catch (err) {
                    console.error('Status poll error:', err);
                  }
                }, 5000);

                // Store this interval so we can clear it later
                pollIntervalRef.current = pollCurrentStatus;
              }
            } else {
              // No tournament running - check if we have stale state
              if (tournamentStatus === 'running') {
                console.log('ğŸ“‹ UI shows running but server says idle - updating state');
                setTournamentStatus('idle');
                loadTournamentResults();
              }
            }
          }
        } catch (error) {
          // Tournament might not be running, that's okay
          console.log('No running tournament found:', error);
          // If we have stale running state, clear it
          if (tournamentStatus === 'running') {
            console.log('ğŸ“‹ Clearing stale running state');
            setTournamentStatus('idle');
          }
        }
      };

      useEffect(() => {
        // Always check for running tournament when modal opens
        checkRunningTournament();

        return () => {
          // CRITICAL FIX: Cleanup ALL resources when modal closes
          console.log('ğŸ“‹ Modal unmounting - cleaning up resources');
          
          // Clear polling intervals
          if (pollIntervalRef.current) {
            clearInterval(pollIntervalRef.current);
            pollIntervalRef.current = null;
          }
          
          // CRITICAL: Close EventSource connections to prevent memory leaks
          if (eventSourceRef.current) {
            if (eventSourceRef.current.leaderboard) {
              eventSourceRef.current.leaderboard.close();
              console.log('ğŸ”Œ Closed leaderboard SSE connection');
            }
            if (eventSourceRef.current.logs) {
              eventSourceRef.current.logs.close();
              console.log('ğŸ”Œ Closed logs SSE connection');
            }
            eventSourceRef.current = null;
          }
          
          // IMPORTANT: DO NOT call stopTournament() here
          // The tournament continues running on the server independently
        };
      }, []);

      return (
        <div className="modal-overlay" onClick={handleClose}>
          <div className="glass-elevated rounded-2xl p-6 max-w-7xl w-full mx-4 my-8 max-h-[90vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
            {/* Header */}
            <div className="flex items-start justify-between mb-6 pb-4 border-b border-slate-700">
              <div>
                <h2 className="text-3xl font-bold bg-gradient-to-r from-cyan-400 to-purple-400 bg-clip-text text-transparent">
                  ğŸ† AI Trading Tournament
                </h2>
                <p className="text-slate-400 text-sm mt-1">Multi-AI Trading Competition</p>
              </div>
              <button onClick={handleClose} className="text-slate-400 hover:text-white text-2xl px-2">âœ•</button>
            </div>

            {/* Tabs */}
            <div className="flex border-b border-slate-700 bg-slate-800/50">
              {['overview', 'leaderboard', 'logs', 'settings'].map(tab => (
                <button
                  key={tab}
                  onClick={() => setActiveTab(tab)}
                  className={`px-6 py-3 font-medium capitalize transition ${activeTab === tab
                    ? 'text-purple-400 border-b-2 border-purple-400 bg-slate-700/50'
                    : 'text-slate-400 hover:text-white hover:bg-slate-700/30'
                    }`}>
                  {tab}
                </button>
              ))}
            </div>

            {/* Tab Content */}
            <div className="space-y-6">
              {activeTab === 'overview' && (
                <div>
                  {/* Tournament Controls */}
                  <div className="bg-slate-800/50 rounded-lg p-6 mb-6 border border-slate-700">
                    <h3 className="text-xl font-bold text-white mb-4">Tournament Configuration</h3>

                    <div className="grid grid-cols-2 gap-4 mb-4">
                      <div>
                        <label className="block text-sm text-slate-400 mb-2">Tournament Days</label>
                        <input
                          type="number"
                          value={tournamentDays}
                          onChange={(e) => setTournamentDays(parseInt(e.target.value) || 7)}
                          min="1"
                          max="30"
                          className="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-2 text-white"
                          disabled={tournamentStatus === 'running'}
                        />
                      </div>
                      <div>
                        <label className="block text-sm text-slate-400 mb-2">Active Teams</label>
                        <div className="flex gap-2 flex-wrap">
                          {[1, 2, 3, 4].map(team => (
                            <label key={team} className="flex items-center gap-2 cursor-pointer">
                              <input
                                type="checkbox"
                                checked={activeTeams.includes(team)}
                                onChange={(e) => {
                                  if (e.target.checked) {
                                    setActiveTeams([...activeTeams, team]);
                                  } else {
                                    setActiveTeams(activeTeams.filter(t => t !== team));
                                  }
                                }}
                                disabled={tournamentStatus === 'running'}
                                className="w-4 h-4"
                              />
                              <span className="text-sm text-slate-300">Team {team}</span>
                            </label>
                          ))}
                        </div>
                      </div>
                    </div>

                    <div className="mb-4">
                      <label className="block text-sm text-slate-400 mb-2">Available Stocks ({availableSymbols.length} total)</label>
                      <div className="bg-slate-900 rounded-lg p-3 text-sm text-slate-300 max-h-32 overflow-y-auto">
                        {availableSymbols.length > 0 ? availableSymbols.join(', ') : 'No stocks available'}
                      </div>
                      <p className="text-xs text-slate-500 mt-2">AI teams will select from all {availableSymbols.length} stocks in the application</p>
                    </div>

                    <div className="flex gap-3">
                      {tournamentStatus === 'idle' && (
                        <button
                          onClick={startTournament}
                          className="px-8 py-3 bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-lg font-bold hover:shadow-lg hover:shadow-purple-500/50 transition"
                        >
                          <i className="fas fa-play mr-2"></i>
                          Start Tournament ({availableSymbols.length} Stocks)
                        </button>
                      )}
                      {tournamentStatus === 'running' && (
                        <div className="flex items-center gap-3">
                          <div className="flex items-center gap-2 px-4 py-3 bg-cyan-500/10 border border-cyan-500/30 rounded-lg">
                            <i className="fas fa-spinner animate-spin text-cyan-400"></i>
                            <span className="text-cyan-400 font-semibold">
                              Day {currentDay} / {tournamentDays}
                            </span>
                          </div>
                          <div className="text-xs text-slate-500">
                            Tournament runs in background
                          </div>
                        </div>
                      )}
                      {tournamentStatus === 'completed' && (
                        <button
                          onClick={loadTournamentResults}
                          className="px-6 py-3 bg-green-600 hover:bg-green-500 text-white rounded-lg font-semibold flex items-center gap-2"
                        >
                          <i className="fas fa-sync"></i>
                          Refresh Results
                        </button>
                      )}
                    </div>
                  </div>

                  {/* Tournament Status */}
                  {tournamentResults && (
                    <div className="bg-slate-800/50 rounded-lg p-6 border border-slate-700">
                      <h3 className="text-xl font-bold text-white mb-4">Tournament Results</h3>
                      <div className="grid grid-cols-3 gap-4">
                        <div className="bg-slate-900/50 rounded-lg p-4 text-center">
                          <div className="text-sm text-slate-400 mb-1">Total Days</div>
                          <div className="text-2xl font-bold text-cyan-400">{tournamentResults.total_days || tournamentDays}</div>
                        </div>
                        <div className="bg-slate-900/50 rounded-lg p-4 text-center">
                          <div className="text-sm text-slate-400 mb-1">Total Trades</div>
                          <div className="text-2xl font-bold text-green-400">{tournamentResults.total_trades || 0}</div>
                        </div>
                        <div className="bg-slate-900/50 rounded-lg p-4 text-center">
                          <div className="text-sm text-slate-400 mb-1">Best Return</div>
                          <div className="text-2xl font-bold text-purple-400">
                            {tournamentResults.best_return ? `${tournamentResults.best_return.toFixed(2)}%` : 'N/A'}
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              )}

              {activeTab === 'leaderboard' && (
                <div>
                  {leaderboard.length > 0 ? (
                    <div className="space-y-3">
                      {leaderboard.map((team, idx) => (
                        <div
                          key={team.teamId}
                          className={`glass-card p-6 rounded-xl border transition ${idx === 0 ? 'border-yellow-500/50 bg-yellow-500/5' :
                            idx === 1 ? 'border-slate-400/50 bg-slate-400/5' :
                              idx === 2 ? 'border-orange-500/50 bg-orange-500/5' :
                                'border-slate-700'
                            }`}>
                          <div className="flex items-center justify-between">
                            <div className="flex items-center gap-4">
                              <div className="text-3xl">{getRankEmoji(team.rank || idx + 1)}</div>
                              <div>
                                <h4 className="text-lg font-bold text-white">{team.name || getTeamName(team.teamId)}</h4>
                                <p className="text-sm text-slate-400">{team.model || 'Unknown Model'}</p>
                              </div>
                            </div>
                            <div className="text-right">
                              <div className={`text-2xl font-bold ${team.totalReturn > 0 ? 'text-green-400' : 'text-red-400'
                                }`}>
                                {team.totalReturn > 0 ? '+' : ''}{team.totalReturn?.toFixed(2)}%
                              </div>
                              <div className="text-sm text-slate-400">
                                ${team.portfolioValue?.toLocaleString()}
                              </div>
                            </div>
                          </div>

                          {/* Mini chart of returns */}
                          {team.returns && team.returns.length > 0 && (
                            <div className="mt-4 flex items-end gap-1 h-12">
                              {team.returns.map((ret, i) => (
                                <div
                                  key={i}
                                  className={`flex-1 rounded-t ${ret > 0 ? 'bg-green-500' : 'bg-red-500'}`}
                                  style={{ height: `${Math.abs(ret) * 10}px`, minHeight: '2px' }}
                                  title={`Day ${i + 1}: ${ret.toFixed(2)}%`}
                                ></div>
                              ))}
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  ) : (
                    <div className="text-center py-20">
                      <i className="fas fa-trophy text-6xl text-slate-700 mb-4"></i>
                      <p className="text-slate-400">No tournament results yet</p>
                      <p className="text-sm text-slate-500 mt-2">Start a tournament to see the leaderboard</p>
                    </div>
                  )}
                </div>
              )}

              {activeTab === 'logs' && (
                <div className="space-y-2">
                  {logs.length === 0 ? (
                    <div className="text-center py-12">
                      <i className="fas fa-file-alt text-6xl text-slate-600 mb-4"></i>
                      <p className="text-slate-400">No logs yet</p>
                    </div>
                  ) : (
                    <div className="glass-card p-4 rounded-xl border border-slate-700 max-h-96 overflow-y-auto">
                      {logs.map((log, idx) => (
                        <div
                          key={idx}
                          className={`py-2 px-3 rounded mb-1 font-mono text-sm ${log.type === 'error' ? 'bg-red-500/10 text-red-400' :
                            log.type === 'success' ? 'bg-green-500/10 text-green-400' :
                              log.type === 'warning' ? 'bg-yellow-500/10 text-yellow-400' :
                                'bg-slate-700/30 text-slate-300'
                            }`}>
                          <span className="text-slate-500 mr-2">[{log.time}]</span>
                          {log.message}
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              )}

              {activeTab === 'settings' && (
                <div className="space-y-6">
                  <div className="glass-card p-6 rounded-xl border border-slate-700">
                    <h3 className="text-lg font-bold text-white mb-4">Tournament Configuration</h3>

                    <div className="space-y-4">
                      <div>
                        <label className="block text-slate-300 mb-2">Duration (days)</label>
                        <input
                          type="number"
                          min="1"
                          max="30"
                          value={tournamentDays}
                          onChange={(e) => setTournamentDays(parseInt(e.target.value))}
                          disabled={tournamentStatus === 'running'}
                          className="w-full bg-slate-700 text-white px-4 py-2 rounded-lg border border-slate-600 focus:border-purple-500 focus:outline-none disabled:opacity-50"
                        />
                      </div>

                      <div>
                        <label className="block text-slate-300 mb-2">Active Teams</label>
                        <div className="grid grid-cols-2 gap-2">
                          {[1, 2, 3, 4].map(teamId => (
                            <label
                              key={teamId}
                              className={`flex items-center gap-2 p-3 rounded-lg border cursor-pointer transition ${activeTeams.includes(teamId)
                                ? 'bg-purple-500/20 border-purple-500'
                                : 'bg-slate-700/30 border-slate-600'
                                } ${tournamentStatus === 'running' ? 'opacity-50 cursor-not-allowed' : ''}`}>
                              <input
                                type="checkbox"
                                checked={activeTeams.includes(teamId)}
                                onChange={(e) => {
                                  if (e.target.checked) {
                                    setActiveTeams([...activeTeams, teamId]);
                                  } else {
                                    setActiveTeams(activeTeams.filter(id => id !== teamId));
                                  }
                                }}
                                disabled={tournamentStatus === 'running'}
                                className="form-checkbox text-purple-500"
                              />
                              <span className="text-white text-sm">{getTeamName(teamId)}</span>
                            </label>
                          ))}
                        </div>
                      </div>

                      <div>
                        <label className="block text-slate-300 mb-2">
                          Available Stocks ({availableSymbols.length} symbols)
                        </label>
                        <div className="bg-slate-700/30 p-3 rounded-lg border border-slate-600 max-h-32 overflow-y-auto">
                          {availableSymbols.length > 0 ? (
                            <div className="flex flex-wrap gap-2">
                              {availableSymbols.map(symbol => (
                                <span key={symbol} className="px-2 py-1 bg-cyan-500/20 text-cyan-300 rounded text-sm">
                                  {symbol}
                                </span>
                              ))}
                            </div>
                          ) : (
                            <p className="text-slate-500 text-sm">Loading available stocks...</p>
                          )}
                        </div>
                        <p className="text-xs text-slate-500 mt-2">
                          Tournament will analyze all {availableSymbols.length} available stocks
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MARKET CRASH SIMULATOR COMPONENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


    // MARKET CRASH SIMULATOR COMPONENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function MarketCrashSimulator({ holdings, totalValue }) {
      const [selectedScenario, setSelectedScenario] = useState('2008 Financial Crisis');
      const [showDetails, setShowDetails] = useState(false);

      const crashResult = simulateMarketCrash(holdings, selectedScenario);

      if (!crashResult) return null;

      return (
        <div className="space-y-4">
          <div className="flex items-center justify-between mb-3">
            <p className="text-sm text-slate-400">
              See how your portfolio would handle historical market crashes
            </p>
            <select
              value={selectedScenario}
              onChange={(e) => setSelectedScenario(e.target.value)}
              className="px-3 py-1.5 bg-slate-800 border border-slate-700 rounded text-white text-sm focus:outline-none focus:border-purple-500"
            >
              {Object.keys(CRASH_SCENARIOS).map(scenario => (
                <option key={scenario} value={scenario}>{scenario}</option>
              ))}
            </select>
          </div>

          <div className="grid grid-cols-3 gap-4">
            <div className="glass-card p-4 rounded-lg text-center">
              <div className="text-xs text-slate-500 mb-2">Portfolio Loss</div>
              <div className="text-2xl font-bold text-red-400">
                ${crashResult.lossUsd.toLocaleString('en-US', { maximumFractionDigits: 0 })}
              </div>
              <div className="text-xs text-slate-500 mt-1">
                -{crashResult.lossPct}%
              </div>
            </div>
            <div className="glass-card p-4 rounded-lg text-center">
              <div className="text-xs text-slate-500 mb-2">Timeline</div>
              <div className="text-2xl font-bold text-white">
                {crashResult.weeks} {crashResult.weeks === 1 ? 'week' : 'weeks'}
              </div>
              <div className="text-xs text-slate-500 mt-1">
                ~${crashResult.perWeek.toLocaleString('en-US', { maximumFractionDigits: 0 })}/week
              </div>
            </div>
            <div className="glass-card p-4 rounded-lg text-center">
              <div className="text-xs text-slate-500 mb-2">Value After Crash</div>
              <div className="text-2xl font-bold text-yellow-400">
                ${crashResult.finalValue.toLocaleString('en-US', { maximumFractionDigits: 0 })}
              </div>
              <div className="text-xs text-slate-500 mt-1">
                {crashResult.percentRemaining.toFixed(0)}% remaining
              </div>
            </div>
          </div>

          {/* Visual indicator */}
          <div className="glass-card p-4 rounded-lg">
            <div className="flex justify-between items-center mb-2">
              <span className="text-xs text-slate-400">Portfolio Drawdown</span>
              <span className="text-xs font-bold text-red-400">-{crashResult.lossPct}%</span>
            </div>
            <div className="w-full bg-slate-700 rounded-full h-3">
              <div
                className="h-full bg-gradient-to-r from-green-500 to-red-500 rounded-full transition-all"
                style={{ width: `${crashResult.percentRemaining}%` }}
              ></div>
            </div>
            <div className="flex justify-between text-xs text-slate-500 mt-1">
              <span>$0</span>
              <span>${totalValue.toLocaleString('en-US', { maximumFractionDigits: 0 })}</span>
            </div>
          </div>

          <div className="p-3 bg-slate-800/40 border border-slate-700/50 rounded-lg">
            <div className="flex items-start gap-2">
              <i className="fas fa-info-circle text-blue-400 text-sm mt-0.5"></i>
              <div className="text-xs text-slate-300 leading-relaxed">
                <strong>Historical scenario</strong> â€“ not a prediction. Past crashes help you understand your risk tolerance.
                Would you panic-sell, hold steady, or see it as a buying opportunity?
              </div>
            </div>
          </div>

          <button
            onClick={() => setShowDetails(!showDetails)}
            className="text-sm text-purple-400 hover:text-purple-300 font-semibold flex items-center gap-2 transition"
          >
            {showDetails ? 'â–¼' : 'â–¶'} {showDetails ? 'Hide' : 'Show'} Historical Context
          </button>

          {showDetails && (
            <div className="glass-card p-4 rounded-lg space-y-2 text-xs text-slate-300">
              <div className="font-semibold text-white mb-2">{selectedScenario} Details:</div>
              {selectedScenario === '2008 Financial Crisis' && (
                <p>The S&P 500 fell 57% from October 2007 to March 2009 during the subprime mortgage crisis. Recovery took 4+ years.</p>
              )}
              {selectedScenario === '2020 COVID Crash' && (
                <p>Markets dropped 34% in just 5 weeks (Feb-Mar 2020) due to pandemic fears. Recovery was V-shaped, taking only 5 months.</p>
              )}
              {selectedScenario === '2000 Dot-com Bust' && (
                <p>The tech-heavy NASDAQ fell 78% from March 2000 to October 2002. Full recovery took 15 years.</p>
              )}
              {selectedScenario === '1987 Black Monday' && (
                <p>Markets crashed 22.6% in a single day (Oct 19, 1987) due to program trading and panic. Recovery took 2 years.</p>
              )}
            </div>
          )}
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STOCK GRADING SYSTEM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function calculateStockGrade(stock) {
      let score = 0, maxScore = 0;
      const criteria = [];

      // Valuation (25 pts)
      if (stock.pe) {
        maxScore += 10;
        if (stock.pe < 15) { score += 10; criteria.push({ name: 'P/E Ratio', grade: 'A', reason: 'Attractive valuation (P/E < 15)' }); }
        else if (stock.pe < 25) { score += 7; criteria.push({ name: 'P/E Ratio', grade: 'B', reason: 'Fair valuation (P/E 15-25)' }); }
        else if (stock.pe < 35) { score += 4; criteria.push({ name: 'P/E Ratio', grade: 'C', reason: 'Expensive (P/E 25-35)' }); }
        else { score += 2; criteria.push({ name: 'P/E Ratio', grade: 'D', reason: 'Very expensive (P/E >35)' }); }
      }
      if (stock.priceToBook) {
        maxScore += 8;
        if (stock.priceToBook < 1.5) { score += 8; criteria.push({ name: 'P/B Ratio', grade: 'A', reason: 'Trading below book value' }); }
        else if (stock.priceToBook < 3) { score += 6; criteria.push({ name: 'P/B Ratio', grade: 'B', reason: 'Reasonable P/B ratio' }); }
        else { score += 3; criteria.push({ name: 'P/B Ratio', grade: 'C', reason: 'High P/B ratio' }); }
      }

      // Growth (25 pts)
      if (stock.revenueGrowth) {
        maxScore += 10;
        if (stock.revenueGrowth > 20) { score += 10; criteria.push({ name: 'Revenue Growth', grade: 'A', reason: 'Strong growth (>20%)' }); }
        else if (stock.revenueGrowth > 10) { score += 7; criteria.push({ name: 'Revenue Growth', grade: 'B', reason: 'Solid growth (10-20%)' }); }
        else if (stock.revenueGrowth > 0) { score += 4; criteria.push({ name: 'Revenue Growth', grade: 'C', reason: 'Slow growth (0-10%)' }); }
        else { score += 1; criteria.push({ name: 'Revenue Growth', grade: 'F', reason: 'Declining revenue' }); }
      }
      if (stock.epsGrowth) {
        maxScore += 10;
        if (stock.epsGrowth > 20) { score += 10; criteria.push({ name: 'EPS Growth', grade: 'A', reason: 'Excellent earnings (>20%)' }); }
        else if (stock.epsGrowth > 10) { score += 7; criteria.push({ name: 'EPS Growth', grade: 'B', reason: 'Good earnings (10-20%)' }); }
        else if (stock.epsGrowth > 0) { score += 4; criteria.push({ name: 'EPS Growth', grade: 'C', reason: 'Modest growth (0-10%)' }); }
      }
      if (stock.grossMargin) {
        maxScore += 5;
        if (stock.grossMargin > 60) { score += 5; criteria.push({ name: 'Gross Margin', grade: 'A', reason: 'Exceptional margins (>60%)' }); }
        else if (stock.grossMargin > 40) { score += 3; criteria.push({ name: 'Gross Margin', grade: 'B', reason: 'Strong margins (40-60%)' }); }
        else if (stock.grossMargin > 20) { score += 2; criteria.push({ name: 'Gross Margin', grade: 'C', reason: 'Fair margins (20-40%)' }); }
      }

      // Financial Health (25 pts)
      if (stock.debtToEquity !== undefined) {
        maxScore += 10;
        if (stock.debtToEquity < 0.5) { score += 10; criteria.push({ name: 'Debt/Equity', grade: 'A', reason: 'Very low debt (<0.5)' }); }
        else if (stock.debtToEquity < 1.0) { score += 7; criteria.push({ name: 'Debt/Equity', grade: 'B', reason: 'Conservative debt (0.5-1.0)' }); }
        else if (stock.debtToEquity < 2.0) { score += 4; criteria.push({ name: 'Debt/Equity', grade: 'C', reason: 'Moderate debt (1.0-2.0)' }); }
        else { score += 2; criteria.push({ name: 'Debt/Equity', grade: 'D', reason: 'High debt (>2.0)' }); }
      }
      if (stock.currentRatio) {
        maxScore += 8;
        if (stock.currentRatio > 2.0) { score += 8; criteria.push({ name: 'Current Ratio', grade: 'A', reason: 'Strong liquidity (>2.0)' }); }
        else if (stock.currentRatio > 1.5) { score += 6; criteria.push({ name: 'Current Ratio', grade: 'B', reason: 'Adequate liquidity (1.5-2.0)' }); }
        else if (stock.currentRatio > 1.0) { score += 3; criteria.push({ name: 'Current Ratio', grade: 'C', reason: 'Tight liquidity (1.0-1.5)' }); }
      }
      if (stock.piotroskiScore) {
        maxScore += 7;
        if (stock.piotroskiScore >= 7) { score += 7; criteria.push({ name: 'Piotroski Score', grade: 'A', reason: 'Excellent financial health (7-9)' }); }
        else if (stock.piotroskiScore >= 5) { score += 5; criteria.push({ name: 'Piotroski Score', grade: 'B', reason: 'Good health (5-6)' }); }
        else if (stock.piotroskiScore >= 3) { score += 3; criteria.push({ name: 'Piotroski Score', grade: 'C', reason: 'Fair health (3-4)' }); }
        else { score += 1; criteria.push({ name: 'Piotroski Score', grade: 'D', reason: 'Weak health (<3)' }); }
      }

      // Profitability (15 pts)
      if (stock.roe) {
        maxScore += 8;
        if (stock.roe > 20) { score += 8; criteria.push({ name: 'ROE', grade: 'A', reason: 'Excellent return (>20%)' }); }
        else if (stock.roe > 15) { score += 6; criteria.push({ name: 'ROE', grade: 'B', reason: 'Strong return (15-20%)' }); }
        else if (stock.roe > 10) { score += 4; criteria.push({ name: 'ROE', grade: 'C', reason: 'Fair return (10-15%)' }); }
        else { score += 2; criteria.push({ name: 'ROE', grade: 'D', reason: 'Weak return (<10%)' }); }
      }
      if (stock.roic) {
        maxScore += 7;
        if (stock.roic > 15) { score += 7; criteria.push({ name: 'ROIC', grade: 'A', reason: 'Excellent capital efficiency (>15%)' }); }
        else if (stock.roic > 10) { score += 5; criteria.push({ name: 'ROIC', grade: 'B', reason: 'Good efficiency (10-15%)' }); }
        else if (stock.roic > 5) { score += 3; criteria.push({ name: 'ROIC', grade: 'C', reason: 'Fair efficiency (5-10%)' }); }
      }

      // Technical (10 pts)
      if (stock.rsi) {
        maxScore += 5;
        if (stock.rsi >= 40 && stock.rsi <= 60) { score += 5; criteria.push({ name: 'RSI', grade: 'A', reason: 'Neutral momentum' }); }
        else if (stock.rsi < 30) { score += 4; criteria.push({ name: 'RSI', grade: 'B', reason: 'Oversold - potential bounce' }); }
        else if (stock.rsi > 70) { score += 2; criteria.push({ name: 'RSI', grade: 'C', reason: 'Overbought - caution' }); }
      }
      if (stock.beta !== undefined) {
        maxScore += 5;
        if (stock.beta >= 0.8 && stock.beta <= 1.2) { score += 5; criteria.push({ name: 'Beta', grade: 'A', reason: 'Market-like volatility' }); }
        else if (stock.beta < 0.8) { score += 4; criteria.push({ name: 'Beta', grade: 'B', reason: 'Lower volatility' }); }
        else if (stock.beta < 1.5) { score += 3; criteria.push({ name: 'Beta', grade: 'C', reason: 'Moderate volatility' }); }
        else { score += 2; criteria.push({ name: 'Beta', grade: 'D', reason: 'High volatility' }); }
      }

      // Calculate final grade
      const percentage = maxScore > 0 ? (score / maxScore) * 100 : 0;
      let letterGrade = 'F';
      if (percentage >= 90) letterGrade = 'A';
      else if (percentage >= 80) letterGrade = 'B';
      else if (percentage >= 70) letterGrade = 'C';
      else if (percentage >= 60) letterGrade = 'D';

      return {
        letterGrade,
        percentage: Math.round(percentage),
        score,
        maxScore,
        criteria: criteria.sort((a, b) => {
          const order = { 'A': 1, 'B': 2, 'C': 3, 'D': 4, 'F': 5 };
          return order[a.grade] - order[b.grade];
        })
      };
    }

    // === FINANCIAL GLOSSARY FOR "EXPLAIN THIS" ===
    const FINANCIAL_EXPLANATIONS = {
      pe: {
        label: 'P/E Ratio',
        plain: 'Price-to-Earnings: How much you pay for $1 of earnings. <15 = Undervalued, 15-25 = Fair, >25 = Growth priced in.',
        analogy: 'Like paying $25 for a pizza that gives you $1 worth of satisfaction per year.'
      },
      roe: {
        label: 'ROE (Return on Equity)',
        plain: 'Profit generated from shareholder equity. >15% = strong, >20% = excellent.',
        analogy: 'Like getting $1.20 back for every $1 you invest in the business.'
      },
      roic: {
        label: 'ROIC (Return on Invested Capital)',
        plain: 'How efficiently a company uses its capital to generate profits. >15% is strong.',
        analogy: 'Like a vending machine that returns $1.20 for every $1 you put in.'
      },
      evToEbitda: {
        label: 'EV/EBITDA',
        plain: 'Enterprise Value vs. Earnings Before Interest, Taxes, Depreciation & Amortization. <10 = cheap, >15 = expensive.',
        analogy: 'Like comparing the total price of a business to its core operating cash flow.'
      },
      piotroskiScore: {
        label: 'Piotroski Score',
        plain: 'A 9-point checklist for financial health (profitability, leverage, efficiency). 7-9 = strong, <4 = weak.',
        analogy: 'Like a financial health checkup for stocks.'
      },
      debtToEquity: {
        label: 'Debt-to-Equity',
        plain: 'How much debt a company uses relative to shareholder equity. <0.5 = conservative, >1.5 = risky.',
        analogy: 'Like a home: $200K house with $50K down (low risk) vs. $200K with $180K loan (high risk).'
      },
      rsi: {
        label: 'RSI (Relative Strength Index)',
        plain: 'Momentum indicator: <30 = oversold (potential buy), >70 = overbought (potential sell).',
        analogy: "Like a car's speedometer: too fast = risk of crash, too slow = opportunity to accelerate."
      },
      revenueGrowth: {
        label: 'Revenue Growth',
        plain: 'Year-over-year revenue change. >20% = high growth, <0% = decline.',
        analogy: 'Like a store that sold 100 units last year and 125 this year â€” business is expanding.'
      },
      grossMargin: {
        label: 'Gross Margin',
        plain: 'Profit after cost of goods sold. >40% = excellent, 20-40% = good.',
        analogy: 'If you sell a $10 product for $15, your gross margin is 33% â€” $5 profit before other costs.'
      },
      beta: {
        label: 'Beta',
        plain: 'Volatility relative to market. <1 = less volatile, >1 = more volatile than S&P 500.',
        analogy: 'Like comparing a steady sedan (beta 0.8) vs. a sports car (beta 1.5).'
      },
      dividendYield: {
        label: 'Dividend Yield',
        plain: 'Annual dividend as % of stock price. >3% = income stock, 1-3% = balanced.',
        analogy: 'Like earning $3 per year for every $100 invested in the stock.'
      },
      fcfYield: {
        label: 'Free Cash Flow Yield',
        plain: 'Cash generation as % of market value. >8% = excellent, 5-8% = good, 2-5% = fair.',
        analogy: '6% yield = $6 cash per $100 market value. Cash is harder to manipulate than earnings.'
      },
      epsGrowth: {
        label: 'EPS Growth',
        plain: 'Earnings per share growth rate. >20% = excellent, 10-20% = strong, 5-10% = moderate.',
        analogy: '$2 to $2.50 EPS = 25% growth. Indicates growing profitability per share.'
      },
      priceToBook: {
        label: 'P/B Ratio',
        plain: 'Price-to-Book: Stock price vs. book value per share. <1 = potentially undervalued, 1-3 = fair, >3 = premium.',
        analogy: 'Like buying a house for $200K when its assessed value is $150K (P/B = 1.33).'
      },
      priceToSales: {
        label: 'P/S Ratio',
        plain: 'Price-to-Sales: Market cap vs. annual revenue. <1 = cheap, 1-3 = reasonable, >5 = expensive.',
        analogy: 'Like valuing a store at $1M when it makes $500K in sales per year (P/S = 2).'
      },
      netIncomeGrowth: {
        label: 'Net Income Growth',
        plain: 'Year-over-year profit growth. >20% = excellent, 10-20% = strong, <0% = declining.',
        analogy: 'Like a business that made $100K profit last year and $130K this year â€” 30% growth.'
      },
      roa: {
        label: 'ROA (Return on Assets)',
        plain: 'Profit generated from total assets. >10% = excellent, 5-10% = good, <5% = weak.',
        analogy: 'Like a factory that generates $1.10 profit for every $1 of equipment it owns.'
      },
      operatingMargin: {
        label: 'Operating Margin',
        plain: 'Operating profit as % of revenue. >20% = excellent, 10-20% = good, <10% = tight.',
        analogy: 'If revenue is $100 and operating profit is $15, operating margin is 15%.'
      },
      quickRatio: {
        label: 'Quick Ratio',
        plain: 'Liquidity measure: (Cash + Receivables) / Current Liabilities. >1 = healthy, <1 = may struggle to pay short-term debts.',
        analogy: 'Like having $150K in cash/receivables to cover $100K in bills due soon (ratio = 1.5).'
      },
      currentRatio: {
        label: 'Current Ratio',
        plain: 'Current assets / Current liabilities. >2 = very safe, 1-2 = adequate, <1 = liquidity risk.',
        analogy: 'Like having $200K in liquid assets to cover $100K in short-term debts (ratio = 2.0).'
      }
    };

    // Reusable "Explain This" tooltip component
    function ExplainMetric({ metricKey, stock }) {
      const [isOpen, setIsOpen] = useState(false);
      const exp = FINANCIAL_EXPLANATIONS[metricKey];

      if (!exp) return null;

      // Generate stock-specific context
      let context = "";
      const value = stock[metricKey];

      if (metricKey === 'roe' && value != null) {
        if (value > 30) context = `${stock.symbol}'s ROE is ${value.toFixed(1)}% â€” extremely high, indicating strong profitability.`;
        else if (value > 15) context = `${stock.symbol}'s ROE is ${value.toFixed(1)}% â€” solid profitability.`;
        else context = `${stock.symbol}'s ROE is ${value.toFixed(1)}% â€” below average for its sector.`;
      }

      if (metricKey === 'pe' && value != null) {
        if (value < 15) context = `${stock.symbol}'s P/E of ${value.toFixed(1)} suggests it may be undervalued.`;
        else if (value > 30) context = `${stock.symbol}'s P/E of ${value.toFixed(1)} indicates premium pricing or high growth expectations.`;
        else context = `${stock.symbol}'s P/E of ${value.toFixed(1)} is in a reasonable range.`;
      }

      if (metricKey === 'rsi' && value != null) {
        if (value < 30) context = `${stock.symbol}'s RSI of ${value.toFixed(0)} suggests potential buying opportunity (oversold).`;
        else if (value > 70) context = `${stock.symbol}'s RSI of ${value.toFixed(0)} warns of potential pullback (overbought).`;
        else context = `${stock.symbol}'s RSI of ${value.toFixed(0)} is in neutral territory.`;
      }

      if (metricKey === 'piotroskiScore' && value != null) {
        if (value >= 7) context = `${stock.symbol}'s Piotroski Score of ${value}/9 indicates strong financial health.`;
        else if (value >= 4) context = `${stock.symbol}'s Piotroski Score of ${value}/9 shows moderate financial health.`;
        else context = `${stock.symbol}'s Piotroski Score of ${value}/9 suggests weak financial health.`;
      }

      return (
        <div className="relative inline-block ml-1">
          <button
            onClick={() => setIsOpen(!isOpen)}
            className="text-xs text-slate-400 hover:text-cyan-400 font-bold transition"
            aria-label={`Explain ${exp.label}`}
          >
            ?
          </button>

          {isOpen && (
            <>
              <div className="fixed inset-0 z-40" onClick={() => setIsOpen(false)}></div>
              <div className="absolute z-50 w-72 p-4 bg-slate-800 border border-cyan-500/30 rounded-lg shadow-2xl text-xs"
                style={{ top: '100%', left: '0', marginTop: '4px' }}
              >
                <div className="font-semibold text-cyan-300 mb-2 flex items-center justify-between">
                  <span>{exp.label}</span>
                  <button
                    onClick={() => setIsOpen(false)}
                    className="text-slate-400 hover:text-white"
                  >
                    âœ•
                  </button>
                </div>
                <div className="text-slate-300 mb-3 leading-relaxed">{exp.plain}</div>
                {context && <div className="text-white mb-3 p-2 bg-slate-700/50 rounded border border-slate-600/50 italic">"{context}"</div>}
                <div className="text-slate-400 leading-relaxed">ğŸ’¡ {exp.analogy}</div>
              </div>
            </>
          )}
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SIMPLIFIED ANALYTICS FOR NON-EXPERTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Traffic Light System
    const getTrafficLight = (metric, value) => {
      if (value === null || value === undefined) return 'yellow';
      const rules = {
        pe: { green: v => v < 20, yellow: v => v < 30, red: v => v >= 30 },
        revenueGrowth: { green: v => v > 15, yellow: v => v > 5, red: v => v <= 5 },
        debtToEquity: { green: v => v < 0.5, yellow: v => v < 1.5, red: v => v >= 1.5 },
        roe: { green: v => v > 15, yellow: v => v > 10, red: v => v <= 10 },
        beta: { green: v => v < 1.0, yellow: v => v < 1.5, red: v => v >= 1.5 },
      };
      const rule = rules[metric];
      if (!rule) return 'yellow';
      if (rule.green(value)) return 'green';
      if (rule.yellow(value)) return 'yellow';
      return 'red';
    };

    // Plain English Summaries
    const getPlainEnglishSummary = (metric, value) => {
      if (value === null || value === undefined) return { text: 'No data available', detail: '' };
      const summaries = {
        pe: [
          { max: 15, text: 'ğŸ“‰ Bargain price', detail: 'Trading below historical average - potentially undervalued' },
          { max: 25, text: 'âœ… Fair price', detail: 'Reasonable valuation for current earnings' },
          { max: 35, text: 'âš ï¸ Premium price', detail: 'Expensive relative to earnings - needs strong growth to justify' },
          { max: Infinity, text: 'ğŸ”´ Very expensive', detail: 'High valuation - risky if growth slows' }
        ],
        revenueGrowth: [
          { max: 0, text: 'ğŸ“‰ Shrinking', detail: 'Revenue declining - market share loss or industry issues' },
          { max: 5, text: 'ğŸŒ Slow growth', detail: 'Minimal expansion - mature company or tough market' },
          { max: 15, text: 'âœ… Solid growth', detail: 'Healthy expansion rate - gaining market share' },
          { max: Infinity, text: 'ğŸš€ Rapid growth', detail: 'Fast expansion - verify sustainable' }
        ],
        debtToEquity: [
          { max: 0.5, text: 'ğŸ’ª Rock solid', detail: 'Very low debt - financially conservative' },
          { max: 1.0, text: 'âœ… Healthy balance', detail: 'Moderate debt levels - well managed' },
          { max: 2.0, text: 'âš ï¸ Elevated debt', detail: 'Higher debt - monitor closely in downturns' },
          { max: Infinity, text: 'ğŸ”´ High risk', detail: 'Heavy debt burden - vulnerable to rate changes' }
        ],
        roe: [
          { max: 10, text: 'ğŸ“‰ Weak returns', detail: 'Not generating much profit from equity' },
          { max: 15, text: 'â¡ï¸ Average', detail: 'Decent but not exceptional profitability' },
          { max: 20, text: 'âœ… Strong returns', detail: 'Excellent use of shareholder capital' },
          { max: Infinity, text: 'ğŸ† Elite returns', detail: 'Outstanding profitability - competitive advantage' }
        ],
        beta: [
          { max: 0.8, text: 'ğŸ›¡ï¸ Defensive', detail: 'Less volatile than market - safer in downturns' },
          { max: 1.2, text: 'â¡ï¸ Market-like', detail: 'Moves with the market - average risk' },
          { max: 1.8, text: 'âš¡ Volatile', detail: 'More dramatic swings than market' },
          { max: Infinity, text: 'ğŸ¢ Highly volatile', detail: 'Wild price swings - high risk/reward' }
        ]
      };
      const metricSummaries = summaries[metric];
      if (!metricSummaries) return { text: 'â€”', detail: '' };
      for (const summary of metricSummaries) {
        if (value <= summary.max) return summary;
      }
      return { text: 'â€”', detail: '' };
    };

    // Calculate Valuation Score
    const calculateValuationScore = (stock) => {
      let score = 50;
      if (stock.pe) {
        if (stock.pe < 15) score += 15;
        else if (stock.pe < 25) score += 5;
        else if (stock.pe > 35) score -= 15;
        else score -= 5;
      }
      if (stock.priceToBook) {
        if (stock.priceToBook < 1.5) score += 10;
        else if (stock.priceToBook < 3) score += 5;
        else score -= 10;
      }
      if (stock.fcfYield) {
        if (stock.fcfYield > 8) score += 10;
        else if (stock.fcfYield > 5) score += 5;
        else if (stock.fcfYield < 2) score -= 5;
      }
      if (stock.revenueGrowth && stock.revenueGrowth > 20) score += 10;
      return Math.max(0, Math.min(100, score));
    };

    // Get valuation label
    const getValuationLabel = (score) => {
      if (score < 35) return { label: 'Undervalued', color: '#22c55e', emoji: 'ğŸ’°' };
      if (score < 65) return { label: 'Fair Value', color: '#eab308', emoji: 'âš–ï¸' };
      return { label: 'Overvalued', color: '#ef4444', emoji: 'âš ï¸' };
    };

    // LoadingProgressBar Component for Incremental Loading
    function LoadingProgressBar({ current, total }) {
      const percentage = total > 0 ? (current / total) * 100 : 0;

      return (
        <div className="w-full h-2 bg-slate-700 rounded-full overflow-hidden mb-4">
          <div
            className="h-full bg-gradient-to-r from-cyan-500 to-green-500 transition-all duration-300"
            style={{ width: `${percentage}%` }}
          ></div>
          <div className="text-xs text-slate-400 mt-1 text-center">
            {current} of {total} stocks loaded ({percentage.toFixed(1)}%)
          </div>
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FUNDAMENTALS TAB COMPONENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function FundamentalsTab({ stock }) {
      // === DEFENSIVE CHECKS - PREVENT CRASH ===
      if (!stock) {
        return (
          <div className="glass-card p-8 rounded-xl text-center">
            <i className="fas fa-exclamation-triangle text-4xl text-red-400 mb-3"></i>
            <h3 className="text-xl font-bold text-white mb-2">Data Unavailable</h3>
            <p className="text-slate-400 mb-4">No stock data was provided to the Fundamentals tab.</p>
            <button
              onClick={() => window.location.reload()}
              className="px-4 py-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg font-semibold"
            >
              Reload Application
            </button>
          </div>
        );
      }

      // Safely access ALL nested properties
      const safeAccess = (obj, path, fallback = null) => {
        try {
          const parts = path.split('.');
          let current = obj;
          for (const part of parts) {
            if (!current || current[part] === undefined) return fallback;
            current = current[part];
          }
          return current;
        } catch {
          return fallback;
        }
      };

      // Safe property extraction
      const symbol = stock.symbol || 'Unknown';
      const name = stock.name || stock.companyName || symbol;
      const price = Number(stock.price || 0);
      const pe = Number(stock.pe || 0);
      const roe = Number(stock.roe || 0);
      const marketCap = Number(stock.marketCap || 0);
      const volume = Number(stock.volume || 0);

      // AI Analysis with fallbacks
      const aiScore = safeAccess(stock, 'aiAnalysis.score', stock.aiScore || 0);
      const aiVerdict = safeAccess(stock, 'aiAnalysis.verdict', stock.verdict || 'HOLD');
      const confidence = safeAccess(stock, 'aiAnalysis.confidence', stock.confidence || 50);

      // Analyst rating with deep fallback
      const analystRating = safeAccess(stock, 'aiAnalysis.analystRating.detail',
        stock.analystRating?.detail ||
        stock.analystRating ||
        'No analyst rating available'
      );

      return (
        <div className="space-y-6 animate-slideInLeft">
          {/* Header Card */}
          <div className="glass-card p-6 rounded-xl">
            <div className="flex items-center justify-between mb-4">
              <div>
                <h3 className="text-2xl font-bold text-white">{symbol}</h3>
                <p className="text-slate-400">{name}</p>
              </div>
              <div className="text-right">
                <div className="text-3xl font-bold text-white">${price.toFixed(2)}</div>
                <div className={`text-sm ${stock.changePct > 0 ? 'text-green-400' : 'text-red-400'}`}>
                  {stock.changePct > 0 ? '+' : ''}{(stock.changePct || 0).toFixed(2)}%
                </div>
              </div>
            </div>
          </div>

          {/* AI Score Card */}
          <div className="glass-card p-4 rounded-xl border-2 border-cyan-500/30">
            <h4 className="text-lg font-semibold text-cyan-300 mb-3">AI Analysis</h4>
            <div className="grid grid-cols-3 gap-4 mb-3">
              <div className="text-center">
                <div className={`text-2xl font-bold ${aiScore >= 80 ? 'text-green-400' :
                    aiScore >= 60 ? 'text-yellow-400' :
                      'text-red-400'
                  }`}>
                  {aiScore}/100
                </div>
                <div className="text-xs text-slate-400">AI Score</div>
              </div>
              <div className="text-center">
                <div className="text-2xl font-bold text-purple-400">
                  {confidence}%
                </div>
                <div className="text-xs text-slate-400">Confidence</div>
              </div>
              <div className="text-center">
                <span className={`px-3 py-1 rounded-full text-sm font-bold ${aiVerdict === 'STRONG BUY' ? 'bg-green-500/20 text-green-400' :
                    aiVerdict === 'BUY' ? 'bg-green-500/10 text-green-300' :
                      aiVerdict === 'SELL' ? 'bg-red-500/20 text-red-400' :
                        'bg-yellow-500/10 text-yellow-300'
                  }`}>
                  {aiVerdict}
                </span>
              </div>
            </div>
          </div>

          {/* Key Metrics */}
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <MetricCard
              label="P/E Ratio"
              value={pe > 0 ? pe.toFixed(1) : 'N/A'}
              color={pe > 0 && pe < 15 ? 'text-green-400' : pe > 30 ? 'text-red-400' : 'text-slate-300'}
            />
            <MetricCard
              label="ROE"
              value={`${roe.toFixed(1)}%`}
              color={roe > 20 ? 'text-green-400' : roe < 10 ? 'text-red-400' : 'text-slate-300'}
            />
            <MetricCard
              label="Market Cap"
              value={`$${formatNumber(marketCap)}`}
            />
            <MetricCard
              label="Volume"
              value={formatNumber(volume)}
            />
          </div>

          {/* Analyst Rating */}
          <div className="glass-card p-4 rounded-xl">
            <h4 className="text-lg font-semibold text-white mb-3 flex items-center gap-2">
              <i className="fas fa-chart-line text-blue-400"></i>
              Analyst Rating
            </h4>
            <p className="text-slate-300 leading-relaxed">
              {typeof analystRating === 'string' ? analystRating : JSON.stringify(analystRating)}
            </p>
          </div>

          {/* Top Factors */}
          {stock.topDrivers && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="glass-card p-4 rounded-xl border-green-500/30">
                <h4 className="text-md font-semibold text-green-400 mb-2 flex items-center gap-2">
                  <i className="fas fa-thumbs-up"></i>
                  Bullish Factors
                </h4>
                <ul className="space-y-1">
                  {(stock.topDrivers.positive || []).slice(0, 3).map((item, i) => (
                    <li key={i} className="text-sm text-slate-300 flex items-start gap-2">
                      <span className="text-green-400 mt-1">â€¢</span>
                      <span>{item.factor}</span>
                    </li>
                  ))}
                </ul>
              </div>

              <div className="glass-card p-4 rounded-xl border-red-500/30">
                <h4 className="text-md font-semibold text-red-400 mb-2 flex items-center gap-2">
                  <i className="fas fa-thumbs-down"></i>
                  Bearish Factors
                </h4>
                <ul className="space-y-1">
                  {(stock.topDrivers.negative || []).slice(0, 3).map((item, i) => (
                    <li key={i} className="text-sm text-slate-300 flex items-start gap-2">
                      <span className="text-red-400 mt-1">â€¢</span>
                      <span>{item.factor}</span>
                    </li>
                  ))}
                </ul>
              </div>
            </div>
          )}

          {/* Watchlist Guidance */}
          {stock.watchlistGuidance && (
            <div className="glass-card p-4 rounded-xl border-cyan-500/30">
              <h4 className="text-md font-semibold text-cyan-300 mb-3 flex items-center gap-2">
                <i className="fas fa-info-circle"></i>
                What to Watch Next
              </h4>
              <div className="space-y-2">
                {stock.watchlistGuidance.items.map((item, i) => (
                  <div key={i} className="flex items-center justify-between text-sm">
                    <span className="text-slate-400">{item.label}:</span>
                    <span className="text-slate-300">{item.value}</span>
                  </div>
                ))}
              </div>
            </div>
          )}
        </div>
      );
    }

    // Helper component for metrics
    function MetricCard({ label, value, color }) {
      return (
        <div className="glass-card p-4 rounded-xl text-center hover:border-cyan-500/30 transition">
          <div className="text-xs text-slate-400 mb-1">{label}</div>
          <div className={`text-xl font-bold ${color || 'text-white'}`}>{value}</div>
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PATTERN CARD COMPONENT (extracted to fix hooks violation)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function PatternCard({ pattern, stock, historicalData }) {
      const [showAIAnalysis, setShowAIAnalysis] = useState(false);
      const [aiAnalysis, setAiAnalysis] = useState(null);
      const [analyzing, setAnalyzing] = useState(false);

      const analyzePattern = async () => {
        setAnalyzing(true);
        try {
          const analysis = await generatePatternAnalysis(pattern, stock, historicalData);
          setAiAnalysis(analysis);
          setShowAIAnalysis(true);
        } catch (err) {
          console.error('Pattern analysis error:', err);
          setAiAnalysis(generateFallbackAnalysis(pattern));
          setShowAIAnalysis(true);
        } finally {
          setAnalyzing(false);
        }
      };

      return (
        <div className="glass-card p-5 rounded-xl border border-cyan-500/20">
          <div className="flex items-start justify-between mb-3">
            <div>
              <h4 className="text-lg font-bold text-white">{pattern.pattern.name}</h4>
              <p className="text-sm text-slate-400 mt-1">{pattern.pattern.description}</p>
            </div>
            <div className="text-right">
              <div className={`text-2xl font-bold ${pattern.confidence > 0.75 ? 'text-green-400' : pattern.confidence > 0.65 ? 'text-yellow-400' : 'text-orange-400'}`}>
                {(pattern.confidence * 100).toFixed(0)}%
              </div>
              <div className="text-xs text-slate-500">Confidence</div>
            </div>
          </div>

          <div className="grid grid-cols-2 gap-4 mt-4">
            <div>
              <div className="text-xs text-slate-500 mb-1">Type</div>
              <div className={`text-sm font-semibold ${pattern.pattern.type === 'reversal' ? 'text-red-400' : 'text-green-400'}`}>
                {pattern.pattern.type === 'reversal' ? 'Reversal' : 'Continuation'}
              </div>
            </div>
            <div>
              <div className="text-xs text-slate-500 mb-1">Reliability</div>
              <div className="text-sm font-semibold text-cyan-400">
                {(pattern.pattern.reliability * 100).toFixed(0)}%
              </div>
            </div>
            {pattern.targetPrice && (
              <div>
                <div className="text-xs text-slate-500 mb-1">Target Price</div>
                <div className="text-sm font-semibold text-white">${pattern.targetPrice.toFixed(2)}</div>
              </div>
            )}
            <div>
              <div className="text-xs text-slate-500 mb-1">Implications</div>
              <div className={`text-sm font-semibold ${pattern.implications?.includes('Bullish') ? 'text-green-400' : pattern.implications?.includes('Bearish') ? 'text-red-400' : 'text-slate-400'}`}>
                {pattern.implications || 'Neutral'}
              </div>
            </div>
          </div>

          <div className="mt-4 pt-4 border-t border-slate-700/30">
            {!showAIAnalysis ? (
              <button
                onClick={analyzePattern}
                disabled={analyzing}
                className="w-full px-4 py-2 bg-purple-600 hover:bg-purple-700 disabled:bg-slate-600 disabled:cursor-not-allowed text-white rounded-lg font-semibold text-sm flex items-center justify-center gap-2"
              >
                {analyzing ? (
                  <>
                    <div className="inline-block animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
                    <span>AI Analyzing Pattern...</span>
                  </>
                ) : (
                  <>
                    <span>ğŸ¤–</span>
                    <span>Get AI Analysis</span>
                  </>
                )}
              </button>
            ) : aiAnalysis && (
              <div className="space-y-3">
                <div className="flex items-center justify-between">
                  <span className="text-sm font-bold text-purple-400">ğŸ¤– AI Analysis</span>
                  <button onClick={() => setShowAIAnalysis(false)} className="text-xs text-slate-500 hover:text-slate-400">Hide</button>
                </div>
                <div className="bg-slate-800/50 rounded-lg p-3">
                  <div className="text-xs text-slate-500 mb-1">Trading Signal</div>
                  <div className={`text-lg font-bold ${aiAnalysis.signal === 'BUY' ? 'text-green-400' : aiAnalysis.signal === 'SELL' ? 'text-red-400' : 'text-yellow-400'}`}>
                    {aiAnalysis.signal}
                  </div>
                </div>
                <div className="bg-slate-800/50 rounded-lg p-3">
                  <div className="text-xs text-slate-500 mb-2">Recommended Strategy</div>
                  <div className="text-sm text-slate-300">{aiAnalysis.strategy}</div>
                </div>
                <div className="grid grid-cols-2 gap-2">
                  <div className="bg-green-500/10 border border-green-500/20 rounded-lg p-2">
                    <div className="text-xs text-green-400 mb-1">Entry Point</div>
                    <div className="text-sm font-bold text-white">${aiAnalysis.entryPoint?.toFixed(2)}</div>
                  </div>
                  <div className="bg-red-500/10 border border-red-500/20 rounded-lg p-2">
                    <div className="text-xs text-red-400 mb-1">Stop Loss</div>
                    <div className="text-sm font-bold text-white">${aiAnalysis.stopLoss?.toFixed(2)}</div>
                  </div>
                </div>
                <div className="bg-slate-800/50 rounded-lg p-3">
                  <div className="flex items-center justify-between mb-2">
                    <span className="text-xs text-slate-500">Risk Level</span>
                    <span className={`text-sm font-bold ${aiAnalysis.riskLevel === 'Low' ? 'text-green-400' : aiAnalysis.riskLevel === 'Medium' ? 'text-yellow-400' : 'text-red-400'}`}>
                      {aiAnalysis.riskLevel}
                    </span>
                  </div>
                  <div className="text-xs text-slate-400">{aiAnalysis.riskNote}</div>
                </div>
                {aiAnalysis.keyFactors && (
                  <div className="bg-slate-800/50 rounded-lg p-3">
                    <div className="text-xs text-slate-500 mb-2">Key Factors</div>
                    <ul className="space-y-1">
                      {aiAnalysis.keyFactors.map((factor, i) => (
                        <li key={i} className="text-xs text-slate-300 flex items-start gap-2">
                          <span className="text-purple-400">â€¢</span>
                          <span>{factor}</span>
                        </li>
                      ))}
                    </ul>
                  </div>
                )}
                <div className="bg-purple-500/10 border border-purple-500/20 rounded-lg p-3">
                  <div className="text-xs text-slate-400 leading-relaxed">{aiAnalysis.summary}</div>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STOCK MODAL COMPONENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function StockModal({ stock, onClose, watchlist, toggleWatchlist, detailedDataLoading, sectorAverages, portfolio, stocks, setShowWatchlistOnly, openStockModal }) {
      const [activeTab, setActiveTab] = useState('overview');
      const [showAllFactors, setShowAllFactors] = useState(false);
      const [showExplainScore, setShowExplainScore] = useState(false);
      const [insiderData, setInsiderData] = useState(null);
      const [analystEstimates, setAnalystEstimates] = useState(null);
      const [incomeStatement, setIncomeStatement] = useState(null);
      const [newsData, setNewsData] = useState([]);
      const [newsSentiment, setNewsSentiment] = useState(null);
      const [newsLoading, setNewsLoading] = useState(false);
      const [socialSentiment, setSocialSentiment] = useState(null);
      const [socialLoading, setSocialLoading] = useState(false);
      const [historicalData, setHistoricalData] = useState(null);
      const [historicalMeta, setHistoricalMeta] = useState({ symbol: null, timeframe: null });
      const [chartTimeframe, setChartTimeframe] = useState('4hour');
      const [comparisonSymbol, setComparisonSymbol] = useState('');
      const [comparisonData, setComparisonData] = useState(null);
      const [comparisonMeta, setComparisonMeta] = useState({ symbol: null, timeframe: null });
      const [comparisonLoading, setComparisonLoading] = useState(false);
      const [loadingTabData, setLoadingTabData] = useState(false);
      const [technicalData, setTechnicalData] = useState(null);
      const [ratingsData, setRatingsData] = useState(null);
      const [analystRatingsData, setAnalystRatingsData] = useState(null);
      const [error, setError] = useState(null);
      const [deepseekAnalysis, setDeepseekAnalysis] = useState(null);
      const [aiLoading, setAiLoading] = useState(false);
      const [deepseekLoading, setDeepseekLoading] = useState(false);
      const [fundamentalsData, setFundamentalsData] = useState(null);

      // Real-time price tracking
      const [livePrice, setLivePrice] = useState(stock.price);
      const [liveChange, setLiveChange] = useState(stock.change);
      const [liveChangePct, setLiveChangePct] = useState(stock.changePct);
      const [priceHistory, setPriceHistory] = useState([]);
      const [isLiveUpdating, setIsLiveUpdating] = useState(false);

      const isWatchlisted = watchlist && Array.isArray(watchlist) && watchlist.some(s => s && s.toUpperCase() === stock.symbol.toUpperCase());
      const sectorAvg = sectorAverages[stock.sector] || {};

      const explainNow = useMemo(() => explainDeterministicAIScore(stock), [
        stock.symbol,
        stock.pe,
        stock.roe,
        stock.rsi,
        stock.changePct,
        stock.marketCap
      ]);

      // Subscribe to real-time updates for this stock
      useEffect(() => {
        const handleUpdate = (update) => {
          setLivePrice(update.price);
          setLiveChange(update.change);
          setLiveChangePct(update.changesPercentage || (update.change && update.price ? (update.change / update.price * 100) : 0));
          setIsLiveUpdating(true);

          // Add to price history for mini chart
          setPriceHistory(prev => {
            const newHistory = [...prev, { time: Date.now(), price: update.price }];
            // Keep last 50 data points
            return newHistory.slice(-50);
          });

          // Reset live indicator after 1 second
          setTimeout(() => setIsLiveUpdating(false), 1000);
        };

        // Subscribe based on connection status
        if (realtimeData.isConnected) {
          realtimeData.subscribe(stock.symbol, handleUpdate);
        } else {
          smartPoller.startPolling(stock.symbol, handleUpdate);
        }

        return () => {
          realtimeData.unsubscribe(stock.symbol, handleUpdate);
          smartPoller.stopPolling(stock.symbol);
        };
      }, [stock.symbol]);

      const explainThresholds = useMemo(() => aiExplainThresholds(num(stock.aiScore, 0)), [stock.aiScore]);

      const sensitivity = useMemo(() => aiSensitivitySuggestions(stock), [
        stock.symbol,
        stock.pe,
        stock.roe,
        stock.rsi,
        stock.changePct,
        stock.marketCap
      ]);

      const prevSnapshotEntry = useMemo(() => {
        try {
          const raw = localStorage.getItem(Cache.key(stock.symbol, 'stock_prev'));
          if (!raw) return null;
          const parsed = JSON.parse(raw);
          if (!parsed || !parsed.data) return null;
          return parsed;
        } catch {
          return null;
        }
      }, [stock.symbol]);

      const prevAnalysis = useMemo(() => {
        if (!prevSnapshotEntry?.data) return null;
        try {
          return generateAIAnalysis(prevSnapshotEntry.data);
        } catch {
          return null;
        }
      }, [stock.symbol, prevSnapshotEntry?.timestamp]);

      // Lazy load tab data when clicked


      // Track previous stock to detect changes
      const prevStockRef = useRef(null);

      useEffect(() => {
        console.log(`ğŸ” useEffect triggered - activeTab: ${activeTab}, stock: ${stock.symbol}`);

        const loadTabData = async () => {
          // Check if stock changed
          const stockChanged = prevStockRef.current && prevStockRef.current !== stock.symbol;

          console.log(`ğŸ“Œ Stock check: prevStock=${prevStockRef.current}, currentStock=${stock.symbol}, changed=${stockChanged}`);

          // Update ref for next check
          if (!prevStockRef.current) {
            prevStockRef.current = stock.symbol;
            console.log(`ğŸ“ First load - set prevStockRef to ${stock.symbol}`);
          }

          if (stockChanged) {
            console.log(`ğŸ”„ Stock changed to ${stock.symbol} - resetting tab data`);
            // Reset all tab data when stock changes
            setInsiderData(null);
            setAnalystEstimates(null);
            setRatingsData(null);
            setAnalystRatingsData(null);
            setAiAnalysis(null);
            setNewsData([]);
            setNewsSentiment(null);
            setHistoricalData(null);
            setHistoricalMeta({ symbol: null, timeframe: null });
            setChartTimeframe('4hour');
            setComparisonSymbol('');
            setComparisonData(null);
            setComparisonMeta({ symbol: null, timeframe: null });
            setComparisonLoading(false);
            setFundamentalsData(null);
            setActiveTab('overview');
            prevStockRef.current = stock.symbol;
            console.log(`âœ… Reset complete - activeTab now: overview`);
            return; // Exit after reset to let next render handle fetching
          }

          console.log(`ğŸ¯ Checking tabs - activeTab: ${activeTab}`);
          console.log(`   - insiderData: ${insiderData ? 'EXISTS' : 'NULL'}`);
          console.log(`   - analystEstimates: ${analystEstimates ? 'EXISTS' : 'NULL'}`);

          setLoadingTabData(true);
          setError(null);
          try {
            // NEWS & SENTIMENT TAB
            if (activeTab === 'news-sentiment' && newsData.length === 0) {
              console.log(`ğŸ“° Fetching news & sentiment for ${stock.symbol}...`);
              setNewsLoading(true);
              setSocialLoading(true);

              try {
                // Fetch social sentiment in parallel with news
                if (window.socialSentiment) {
                  window.socialSentiment.fetchSocialSentiment(stock.symbol).then(social => {
                    setSocialSentiment(social);
                    setSocialLoading(false);
                  }).catch(err => {
                    console.error('âŒ Social sentiment error:', err);
                    setSocialLoading(false);
                  });
                } else {
                  console.warn('âš ï¸ socialSentiment not yet initialized, retrying...');
                  // Retry after a short delay
                  setTimeout(() => {
                    if (window.socialSentiment) {
                      window.socialSentiment.fetchSocialSentiment(stock.symbol).then(social => {
                        setSocialSentiment(social);
                        setSocialLoading(false);
                      }).catch(err => {
                        console.error('âŒ Social sentiment error:', err);
                        setSocialLoading(false);
                      });
                    } else {
                      console.error('âŒ socialSentiment still not available');
                      setSocialLoading(false);
                    }
                  }, 500);
                }

                // Subscribe to real-time news updates
                const newsCallback = (articles) => {
                  setNewsData(articles);
                  const sentiment = newsManager.getAggregateSentiment(stock.symbol);
                  setNewsSentiment(sentiment);
                  console.log(`âœ… Received ${articles.length} news articles with ${sentiment.label} sentiment`);
                };

                newsManager.subscribe(stock.symbol, newsCallback);

                // Cleanup function will be called when tab changes or modal closes
              } catch (error) {
                console.error(`âŒ Error fetching news for ${stock.symbol}:`, error);
                setNewsData([]);
                setSocialLoading(false);
              } finally {
                setNewsLoading(false);
              }
            }

            if (activeTab === 'analyst-ratings' && !analystRatingsData) {
              console.log(`ğŸ“Š Fetching comprehensive analyst data for ${stock.symbol}...`);

              // Fetch ALL available analyst endpoints
              const [
                ratingsSnap,
                gradesSum,
                gradesHist,
                gradesHistorical,
                gradesConsensus,
                priceTargetSummary,
                priceTargetConsensus
              ] = await Promise.all([
                fetch(`https://financialmodelingprep.com/stable/ratings-snapshot?symbol=${stock.symbol}&apikey=${FMP_API_KEY}`).then(r => r.json()).catch(() => null),
                fetch(`https://financialmodelingprep.com/stable/grades?symbol=${stock.symbol}&apikey=${FMP_API_KEY}`).then(r => r.json()).catch(() => null),
                fetch(`https://financialmodelingprep.com/stable/grades?symbol=${stock.symbol}&limit=20&apikey=${FMP_API_KEY}`).then(r => r.json()).catch(() => []),
                fetch(`https://financialmodelingprep.com/stable/grades-historical?symbol=${stock.symbol}&apikey=${FMP_API_KEY}`).then(r => r.json()).catch(() => []),
                fetch(`https://financialmodelingprep.com/stable/grades-consensus?symbol=${stock.symbol}&apikey=${FMP_API_KEY}`).then(r => r.json()).catch(() => null),
                fetch(`https://financialmodelingprep.com/stable/price-target-summary?symbol=${stock.symbol}&apikey=${FMP_API_KEY}`).then(r => r.json()).catch(() => null),
                fetch(`https://financialmodelingprep.com/stable/price-target-consensus?symbol=${stock.symbol}&apikey=${FMP_API_KEY}`).then(r => r.json()).catch(() => null)
              ]);

              const ratingsSnapshot = Array.isArray(ratingsSnap) ? ratingsSnap[0] : ratingsSnap;
              const gradesSummary = Array.isArray(gradesSum) ? gradesSum[0] : gradesSum;
              // Use /grades endpoint (has gradingCompany field) instead of /grades-historical (consensus data)
              const gradesHistoricalData = Array.isArray(gradesHist) && gradesHist.length > 0 ? gradesHist : (Array.isArray(gradesHistorical) ? gradesHistorical : []);
              const consensusData = Array.isArray(gradesConsensus) ? gradesConsensus[0] : gradesConsensus;
              const priceTargetSummaryData = Array.isArray(priceTargetSummary) ? priceTargetSummary[0] : priceTargetSummary;
              const priceTargetConsensusData = Array.isArray(priceTargetConsensus) ? priceTargetConsensus[0] : priceTargetConsensus;

              console.log(`âœ… Analyst data loaded:`, {
                ratingsSnapshot: ratingsSnapshot ? 'YES' : 'NO',
                gradesSummary: gradesSummary ? 'YES' : 'NO',
                gradesHistorical: gradesHistoricalData?.length || 0,
                gradesConsensus: consensusData ? 'YES' : 'NO',
                priceTargetSummary: priceTargetSummaryData ? 'YES' : 'NO',
                priceTargetConsensus: priceTargetConsensusData ? 'YES' : 'NO'
              });

              // Log first grade entry to see available fields
              if (gradesHistoricalData?.length > 0) {
                console.log(`ğŸ“‹ Sample grade data (first entry):`, gradesHistoricalData[0]);
                console.log(`ğŸ“‹ Available keys:`, Object.keys(gradesHistoricalData[0]));
                console.log(`ğŸ“‹ Full first 3 grades:`, gradesHistoricalData.slice(0, 3));
              }

              setAnalystRatingsData({
                snapshot: ratingsSnapshot,
                consensus: consensusData || gradesSummary,
                recentGrades: gradesHistoricalData || [],
                priceTarget: priceTargetConsensusData || priceTargetSummaryData,
                priceTargetSummary: priceTargetSummaryData,
                priceTargetConsensus: priceTargetConsensusData
              });
            }

            if (activeTab === 'insider' && !insiderData) {
              try {
                console.log(`ğŸ“Š Fetching insider trading data for ${stock.symbol}...`);
                console.log(`ğŸ”‘ Using FMP API Key: ${FMP_API_KEY.substring(0, 10)}...`);

                // Fetch both statistics and latest transactions
                const [statsResponse, latestResponse] = await Promise.all([
                  fetch(`https://financialmodelingprep.com/stable/insider-trading/statistics?symbol=${stock.symbol}&apikey=${FMP_API_KEY}`),
                  fetch(`https://financialmodelingprep.com/stable/insider-trading/latest?symbol=${stock.symbol}&page=0&limit=50&apikey=${FMP_API_KEY}`)
                ]);

                console.log(`ğŸ“¡ Statistics response: ${statsResponse.status}`);
                console.log(`ğŸ“¡ Latest trades response: ${latestResponse.status}`);

                // Check for premium requirement
                if ((statsResponse.status === 403 || statsResponse.status === 402) &&
                  (latestResponse.status === 403 || latestResponse.status === 402)) {
                  console.warn("âš ï¸ Insider trading data requires FMP Premium subscription.");
                  setInsiderData('PREMIUM_REQUIRED');
                  return;
                }

                let statistics = null;
                let latestTrades = [];

                // Process statistics
                if (statsResponse.ok) {
                  const statsData = await statsResponse.json();
                  console.log(`âœ… Statistics data received, length: ${statsData?.length || 0}`);

                  if (Array.isArray(statsData) && statsData.length > 0) {
                    // Calculate totals from recent quarters (last 4 quarters = 1 year)
                    const recentData = statsData.slice(0, 4);
                    const totalBought = recentData.reduce((sum, q) => sum + (q.totalAcquired || 0), 0);
                    const totalSold = recentData.reduce((sum, q) => sum + (q.totalDisposed || 0), 0);
                    const totalAcquiredTx = recentData.reduce((sum, q) => sum + (q.acquiredTransactions || 0), 0);
                    const totalDisposedTx = recentData.reduce((sum, q) => sum + (q.disposedTransactions || 0), 0);

                    statistics = {
                      totalBought,
                      totalSold,
                      totalTransactions: totalAcquiredTx + totalDisposedTx,
                      totalBoughtValue: 0,
                      totalSoldValue: 0
                    };
                    console.log(`ğŸ“Š Statistics: ${totalAcquiredTx + totalDisposedTx} trades, ${totalBought} bought, ${totalSold} sold`);
                  }
                }

                // Process latest individual trades
                if (latestResponse.ok) {
                  const tradesData = await latestResponse.json();
                  console.log(`âœ… Latest trades received, length: ${tradesData?.length || 0}`);

                  if (Array.isArray(tradesData) && tradesData.length > 0) {
                    latestTrades = tradesData;
                  }
                }

                // Set combined data
                if (statistics || latestTrades.length > 0) {
                  setInsiderData({
                    statistics,
                    latestTrades,
                    type: 'combined'
                  });
                } else {
                  console.warn('No insider data available');
                  setInsiderData([]);
                }

              } catch (error) {
                console.error(`âŒ Error fetching insider data for ${stock.symbol}:`, error);
                setInsiderData([]);
              }
            }

            if (activeTab === 'earnings' && !analystEstimates) {
              try {
                console.log(`ğŸ“Š Fetching earnings data for ${stock.symbol}...`);

                // Fetch earnings calendar (historical earnings with estimates and actuals)
                const earningsResp = await fetch(
                  `https://financialmodelingprep.com/stable/earnings?symbol=${stock.symbol}&apikey=${FMP_API_KEY}`
                );

                if (!earningsResp.ok) {
                  console.error('Failed to fetch earnings calendar');
                  setAnalystEstimates({ annual: [], quarterly: [] });
                  return;
                }

                const earningsData = await earningsResp.json();

                console.log(`âœ… Earnings raw data:`, {
                  total: Array.isArray(earningsData) ? earningsData.length : 0,
                  sample: earningsData[0],
                  fields: earningsData[0] ? Object.keys(earningsData[0]) : []
                });

                // Separate into annual and quarterly based on date patterns
                const quarterly = Array.isArray(earningsData) ? earningsData.slice(0, 12) : [];
                const annual = [];

                // Transform the data to match the expected format
                const transformedQuarterly = quarterly.map(item => ({
                  date: item.date,
                  estimatedEpsAvg: item.epsEstimated || 0,
                  eps: item.epsActual || null,
                  estimatedRevenueAvg: item.revenueEstimated || 0,
                  revenue: item.revenueActual || null,
                  numberAnalystEstimatedEps: 1
                }));

                setAnalystEstimates({
                  annual: annual,
                  quarterly: transformedQuarterly
                });

                console.log(`âœ… Transformed earnings data:`, {
                  quarterly: transformedQuarterly.length,
                  firstItem: transformedQuarterly[0]
                });
              } catch (error) {
                console.error(`âŒ Error fetching earnings data for ${stock.symbol}:`, error);
                setAnalystEstimates({ annual: [], quarterly: [] });
              }
            }

            if (activeTab === 'fundamentals' && !fundamentalsData) {
              try {
                console.log(`ğŸ“Š Fetching fundamentals data for ${stock.symbol}...`);

                // Fetch ratios and growth data in parallel
                const [ratiosRes, growthRes] = await Promise.all([
                  fetch(`https://financialmodelingprep.com/stable/ratios?symbol=${stock.symbol}&limit=1&apikey=${FMP_API_KEY}`),
                  fetch(`https://financialmodelingprep.com/stable/financial-growth?symbol=${stock.symbol}&limit=5&apikey=${FMP_API_KEY}`)
                ]);

                const ratiosData = ratiosRes.ok ? await ratiosRes.json() : null;
                const growthData = growthRes.ok ? await growthRes.json() : null;

                const ratios = ratiosData && ratiosData.length > 0 ? ratiosData[0] : null;
                const growth = growthData && growthData.length > 0 ? growthData[0] : null;

                // Extract growth metrics
                const revenueGrowthRaw = growth?.revenueGrowth || growth?.revenuegrowth || growth?.revenueGrowthYoY;
                const netIncomeGrowthRaw = growth?.netIncomeGrowth || growth?.netincomegrowth || growth?.netIncomeGrowthYoY;
                const epsGrowthRaw = growth?.epsGrowth || growth?.epsgrowth || growth?.epsGrowthYoY || growth?.epsgrowthYoY;

                const revenueGrowthPct = revenueGrowthRaw !== null && revenueGrowthRaw !== undefined ? (revenueGrowthRaw * 100) : null;
                const netIncomeGrowthPct = netIncomeGrowthRaw !== null && netIncomeGrowthRaw !== undefined ? (netIncomeGrowthRaw * 100) : null;
                const epsGrowthPct = epsGrowthRaw !== null && epsGrowthRaw !== undefined ? (epsGrowthRaw * 100) : null;

                setFundamentalsData({
                  ratios: ratios || {},
                  growth: growth || {},
                  revenueGrowth: revenueGrowthPct,
                  netIncomeGrowth: netIncomeGrowthPct,
                  epsGrowth: epsGrowthPct,
                  priceToBook: ratios?.priceToBookRatio || ratios?.priceToBook,
                  priceToSales: ratios?.priceToSalesRatio || ratios?.priceToSales,
                  evToEbitda: ratios?.evToEbitda || ratios?.enterpriseValueMultiple,
                  roa: ratios?.returnOnAssets || ratios?.roa,
                  roic: ratios?.returnOnInvestedCapital || ratios?.roic,
                  operatingMargin: ratios?.operatingProfitMargin || ratios?.operatingMargin,
                  quickRatio: ratios?.quickRatio
                });

                console.log(`âœ… Fundamentals data loaded for ${stock.symbol}`);
              } catch (error) {
                console.error(`âŒ Error fetching fundamentals data for ${stock.symbol}:`, error);
                setFundamentalsData({});
              }
            }

            if (activeTab === 'financials' && !incomeStatement) {
              try {
                const response = await fetch(`https://financialmodelingprep.com/stable/income-statement?symbol=${stock.symbol}&apikey=${FMP_API_KEY}`);
                if (!response.ok) {
                  console.error('Failed to fetch financials:', response.status);
                  setIncomeStatement([]);
                  return;
                }
                setIncomeStatement(await response.json());
              } catch (error) {
                console.error(`âŒ Error fetching financials for ${stock.symbol}:`, error);
                setIncomeStatement([]);
              }
            }

            if (activeTab === 'charts') {
              try {
                console.log('ğŸ“Š Charts tab activated, checking historical data...');
                const needsPrimary = (!historicalData) || (historicalMeta.symbol !== stock.symbol) || (historicalMeta.timeframe !== chartTimeframe);
                console.log('needsPrimary:', needsPrimary, { historicalData: !!historicalData, metaSymbol: historicalMeta.symbol, stockSymbol: stock.symbol, metaTimeframe: historicalMeta.timeframe, chartTimeframe });

                if (needsPrimary) {
                  console.log(`Fetching historical chart data for ${stock.symbol} (${chartTimeframe})...`);
                  const response = await fetch(`https://financialmodelingprep.com/stable/historical-chart/${chartTimeframe}?symbol=${stock.symbol}&apikey=${FMP_API_KEY}`);
                  console.log('Historical chart response status:', response.status);

                  if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Historical chart fetch failed:', response.status, errorText);
                    setHistoricalData([]);
                    setHistoricalMeta({ symbol: stock.symbol, timeframe: chartTimeframe });
                    return;
                  }

                  const data = await response.json();
                  console.log('Historical chart data received:', data.length, 'candles');
                  const normalized = Array.isArray(data) ? data.slice(0, 400).reverse() : [];
                  console.log('Normalized data:', normalized.length, 'candles');
                  setHistoricalData(normalized);
                  setHistoricalMeta({ symbol: stock.symbol, timeframe: chartTimeframe });
                  console.log('âœ… Historical data set successfully');
                }
              } catch (chartError) {
                console.error('âŒ Error loading charts:', chartError);
                setHistoricalData([]);
              }
            }

            const cmp = (comparisonSymbol || '').trim().toUpperCase();
            const needsCompare = cmp && ((comparisonMeta.symbol !== cmp) || (comparisonMeta.timeframe !== chartTimeframe));
            if (!cmp) {
              if (comparisonData) setComparisonData(null);
              if (comparisonMeta.symbol) setComparisonMeta({ symbol: null, timeframe: null });
            } else if (needsCompare) {
              setComparisonLoading(true);
              try {
                const resp = await fetch(`https://financialmodelingprep.com/stable/historical-chart/${chartTimeframe}?symbol=${cmp}&apikey=${FMP_API_KEY}`);
                if (!resp.ok) throw new Error('Failed to fetch comparison data');
                const d = await resp.json();
                setComparisonData(Array.isArray(d) ? d.slice(0, 400).reverse() : []);
                setComparisonMeta({ symbol: cmp, timeframe: chartTimeframe });
              } catch (e) {
                console.warn('Comparison fetch failed:', e?.message || e);
                setComparisonData(null);
                setComparisonMeta({ symbol: null, timeframe: null });
              } finally {
                setComparisonLoading(false);
              }
            }

            if (activeTab === 'technicals' && !technicalData) {
              const [sma50, sma200, ema20, rsi, stdDev, adx, ratingsSnap, ratingsHist] = await Promise.all([
                fetch(`https://financialmodelingprep.com/stable/technical-indicators/sma?symbol=${stock.symbol}&periodLength=50&timeframe=1day&apikey=${FMP_API_KEY}`).then(r => r.json()).catch(() => []),
                fetch(`https://financialmodelingprep.com/stable/technical-indicators/sma?symbol=${stock.symbol}&periodLength=200&timeframe=1day&apikey=${FMP_API_KEY}`).then(r => r.json()).catch(() => []),
                fetch(`https://financialmodelingprep.com/stable/technical-indicators/ema?symbol=${stock.symbol}&periodLength=20&timeframe=1day&apikey=${FMP_API_KEY}`).then(r => r.json()).catch(() => []),
                fetch(`https://financialmodelingprep.com/stable/technical-indicators/rsi?symbol=${stock.symbol}&periodLength=14&timeframe=1day&apikey=${FMP_API_KEY}`).then(r => r.json()).catch(() => []),
                fetch(`https://financialmodelingprep.com/stable/technical-indicators/standarddeviation?symbol=${stock.symbol}&periodLength=20&timeframe=1day&apikey=${FMP_API_KEY}`).then(r => r.json()).catch(() => []),
                fetch(`https://financialmodelingprep.com/stable/technical-indicators/adx?symbol=${stock.symbol}&periodLength=14&timeframe=1day&apikey=${FMP_API_KEY}`).then(r => r.json()).catch(() => []),
                fetch(`https://financialmodelingprep.com/stable/ratings-snapshot?symbol=${stock.symbol}&apikey=${FMP_API_KEY}`).then(r => r.json()).catch(() => null),
                fetch(`https://financialmodelingprep.com/stable/ratings-historical?symbol=${stock.symbol}&apikey=${FMP_API_KEY}`).then(r => r.json()).catch(() => [])
              ]);

              setTechnicalData({
                sma50: sma50[0]?.sma,
                sma200: sma200[0]?.sma,
                ema20: ema20[0]?.ema,
                rsi: rsi[0]?.rsi,
                stdDev: stdDev[0]?.standardDeviation,
                adx: adx[0]?.adx,
              });

              // Handle ratings data properly
              const snapshotData = Array.isArray(ratingsSnap) ? ratingsSnap[0] : ratingsSnap;

              console.log(`ğŸ“Š Ratings data for ${stock.symbol}:`, {
                snapshot: snapshotData ? 'LOADED' : 'MISSING',
                ratingScore: snapshotData?.ratingScore || 'N/A',
                recommendation: snapshotData?.ratingRecommendation || 'N/A'
              });

              setRatingsData({
                snapshot: snapshotData,
                history: ratingsHist || []
              });
            }

            if (activeTab === 'ai-predictions' && !aiAnalysis) {
              console.log(`ğŸ¤– AI PREDICTIONS TAB - Starting analysis for ${stock.symbol}`);
              console.log('ğŸ” Current aiAnalysis state:', aiAnalysis);
              console.log('ğŸ” Current aiLoading state:', aiLoading);
              setLoadingTabData(false); // AI tab has its own loading state
              setAiLoading(true);
              try {
                console.log('ğŸ“¡ Calling aiAnalyzer.analyzeStock...');
                const analysis = await aiAnalyzer.analyzeStock(stock);
                console.log('âœ… AI Analysis received:', analysis);
                console.log('âœ… Analysis has recommendations?', !!analysis?.recommendation);
                console.log('âœ… Analysis has predictions?', !!analysis?.predictions);
                setAiAnalysis(analysis);
                console.log('âœ… setAiAnalysis() called successfully');
              } catch (err) {
                console.error('âŒ AI Analysis error:', err);
                // Set fallback analysis on error
                console.log('ğŸ”„ Using fallback analysis...');
                const fallback = aiAnalyzer.getFallbackAnalysis(stock);
                console.log('ğŸ”„ Fallback data:', fallback);
                setAiAnalysis(fallback);
              } finally {
                setAiLoading(false);
                console.log('âœ… AI loading state set to false');
              }
            }
          } catch (err) {
            console.error(`Error loading ${activeTab} data:`, err);
            setError(err.message);
          }
          setLoadingTabData(false);
        };

        if (['insider', 'earnings', 'financials', 'charts', 'patterns', 'technicals', 'analyst-ratings', 'ai-predictions', 'news-sentiment', 'sentiment-leaderboard'].includes(activeTab)) {
          loadTabData();
        }

        // Portfolio Analysis
        if (activeTab === 'portfolio' && !portfolioOptimization) {
          runPortfolioOptimization();
        }

        // Similar Stocks
        if (activeTab === 'similar' && selectedStock && !similarStocks) {
          findSimilarStocks();
        }

        // Heatmap (prepare data)
        if (activeTab === 'heatmap' && !heatmapData && stocks.length > 0) {
          setHeatmapData(stocks);
        }
      }, [activeTab, stock.symbol, chartTimeframe, comparisonSymbol]);

      // Cleanup news subscriptions when modal closes
      useEffect(() => {
        return () => {
          if (stock?.symbol) {
            console.log(`ğŸ§¹ Cleaning up news subscription for ${stock.symbol}`);
            newsManager.stopPolling(stock.symbol);
          }
        };
      }, [stock?.symbol]);

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div id="stock-modal-content" className="glass-elevated rounded-2xl max-w-6xl w-full mx-auto my-8 animate-slide-up max-h-[90vh] overflow-hidden flex flex-col" onClick={(e) => e.stopPropagation()}>
            {/* Header */}
            <div className="flex items-start justify-between p-6 border-b border-slate-700/30 flex-shrink-0">
              <div>
                <div className="flex items-center gap-4 mb-2">
                  <h2 className="text-3xl font-bold text-white">{stock.symbol}</h2>
                  <DataFreshnessIndicator
                    timestamp={stock.fetchedAt || stock.timestamp}
                    type="stock"
                  />
                  <span className="chip bg-slate-700 text-slate-300">{stock.sector || 'Unknown'}</span>
                  <span className="chip bg-slate-700 text-slate-300">{stock.industry || 'Unknown'}</span>
                  {stock.index && <span className="chip bg-cyan-600/20 text-cyan-400 border border-cyan-500/30">{stock.index}</span>}
                </div>
                <div className="flex items-center gap-4 text-sm">
                  <span className="text-slate-400">{stock.companyName || stock.name || 'â€”'}</span>
                </div>
              </div>
              <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>

            {/* Tabs */}
            <div className="flex gap-2 px-6 pt-4 border-b border-slate-700/30 overflow-x-auto flex-shrink-0">
              {['overview', 'simplified', 'ai-analysis', 'news-sentiment', 'sentiment-leaderboard', 'fundamentals', 'charts', 'patterns', 'technicals', 'analyst-ratings', 'insider', 'earnings', 'financials', 'watchlist'].map(tab => (
                <button key={tab} onClick={(e) => { e.stopPropagation(); setActiveTab(tab); }} className={`tab-btn ${activeTab === tab ? 'active' : ''}`}>
                  {tab === 'simplified' ? 'ğŸ’¡ Simplified' :
                    tab === 'ai-analysis' ? 'ğŸ¤– AI Analysis' :
                      tab === 'news-sentiment' ? 'ğŸ“° News & Sentiment' :
                        tab === 'sentiment-leaderboard' ? 'ğŸ“Š Social Leaderboard' :
                          tab === 'patterns' ? 'ğŸ“ˆ Chart Patterns' :
                            tab === 'insider' ? 'ğŸ” Insider Â· Advanced' :
                              tab === 'analyst-ratings' ? 'â­ Analyst Ratings' :
                                tab === 'earnings' ? 'ğŸ“ˆ Earnings' :
                                  tab === 'financials' ? 'ğŸ’° Financials Â· Advanced' :
                                    tab === 'charts' ? 'ğŸ“ˆ Charts Â· Advanced' :
                                      tab === 'watchlist' ? 'â­ Watchlist' :
                                        tab.charAt(0).toUpperCase() + tab.slice(1)}
                </button>
              ))}
            </div>

            {/* Tab Content */}
            <div className="p-6 overflow-y-auto flex-1" onClick={(e) => e.stopPropagation()}>
              {error && (
                <div className="mb-4 p-4 bg-red-500/10 border border-red-500/20 rounded-lg">
                  <div className="flex items-center gap-2 text-red-400">
                    <i className="fas fa-exclamation-triangle"></i>
                    <span className="font-semibold">Error loading data:</span>
                  </div>
                  <p className="text-sm text-slate-300 mt-1">{error}</p>
                  <button
                    onClick={() => setError(null)}
                    className="mt-2 text-xs text-red-400 hover:text-red-300"
                  >
                    Dismiss
                  </button>
                </div>
              )}

              {loadingTabData ? (
                <div className="text-center py-12">
                  <div className="animate-pulse text-cyan-400 text-4xl mb-4">
                    <i className="fas fa-spinner animate-spin"></i>
                  </div>
                  <div className="text-slate-400">Loading {activeTab} data...</div>
                </div>
              ) : activeTab === 'overview' ? (
                <div className="space-y-6">
                  {/* Price & Actions */}
                  <div className="grid grid-cols-4 gap-4">
                    <div className="glass-card p-5 rounded-xl relative">
                      <div className="text-xs text-slate-500 mb-1 flex items-center gap-2">
                        <span>Current Price</span>
                        {isLiveUpdating && (
                          <span className="flex items-center gap-1 text-green-400 animate-pulse">
                            <div className="w-1.5 h-1.5 bg-green-400 rounded-full"></div>
                            LIVE
                          </span>
                        )}
                      </div>
                      <div className={`text-3xl font-bold text-white transition-all ${isLiveUpdating ? 'scale-105' : ''}`}>
                        ${livePrice?.toFixed(2) || stock.price?.toFixed(2) || 'â€”'}
                      </div>
                      <div className={`text-sm font-semibold mt-1 ${getSentimentColor(liveChangePct || stock.changePct)}`}>
                        {formatPercent(liveChangePct || stock.changePct, 2)}
                      </div>

                      {/* Mini price chart */}
                      {priceHistory.length > 5 && (
                        <div className="mt-2 h-8 flex items-end gap-0.5">
                          {priceHistory.slice(-20).map((point, i) => {
                            const min = Math.min(...priceHistory.slice(-20).map(p => p.price));
                            const max = Math.max(...priceHistory.slice(-20).map(p => p.price));
                            const range = max - min;
                            const height = range > 0 ? ((point.price - min) / range) * 100 : 50;
                            const color = i > 0 && point.price >= priceHistory[priceHistory.length - 20 + i - 1]?.price
                              ? 'bg-green-500'
                              : 'bg-red-500';

                            return (
                              <div
                                key={i}
                                className={`flex-1 ${color} opacity-50 rounded-t`}
                                style={{ height: `${height}%`, minHeight: '2px' }}
                              ></div>
                            );
                          })}
                        </div>
                      )}
                    </div>
                    <div className="glass-card p-5 rounded-xl">
                      <div className="text-xs text-slate-500 mb-1">Market Cap</div>
                      <div className="text-2xl font-bold text-white">{formatNumber(stock.marketCap)}</div>
                    </div>
                    <div className="glass-card p-5 rounded-xl">
                      <div className="text-xs text-slate-500 mb-1 flex items-center gap-1">
                        ğŸ˜´ Sleep-Well Score
                        <span className="text-slate-600 cursor-help" title="How comfortable you can sleep owning this stock - based on volatility, debt, and technical signals">?</span>
                      </div>
                      <div className={`text-3xl font-bold ${calcSleepWellScore(stock) >= 80 ? 'text-green-400' :
                          calcSleepWellScore(stock) >= 60 ? 'text-yellow-400' :
                            'text-red-400'
                        }`}>
                        {calcSleepWellScore(stock)}/100
                      </div>
                      <div className="text-xs text-slate-500 mt-1">
                        {calcSleepWellScore(stock) >= 80 ? 'Rest easy' :
                          calcSleepWellScore(stock) >= 60 ? 'Fair volatility' :
                            'Higher risk'}
                      </div>
                    </div>
                    <div className="glass-card p-5 rounded-xl">
                      <div className="text-xs text-slate-500 mb-1 flex items-center gap-1">
                        ğŸ“Š Stock Grade
                        <span className="text-slate-600 cursor-help" title="Overall grade based on valuation, growth, financial health, and profitability">?</span>
                      </div>
                      <div className={`text-3xl font-bold ${calculateStockGrade(stock).letterGrade === 'A' ? 'text-green-400' :
                          calculateStockGrade(stock).letterGrade === 'B' ? 'text-blue-400' :
                            calculateStockGrade(stock).letterGrade === 'C' ? 'text-yellow-400' :
                              calculateStockGrade(stock).letterGrade === 'D' ? 'text-orange-400' :
                                'text-red-400'
                        }`}>
                        {calculateStockGrade(stock).letterGrade}
                      </div>
                      <div className="text-xs text-slate-500 mt-1">
                        {calculateStockGrade(stock).percentage}% score
                      </div>
                    </div>
                    <div className="glass-card p-5 rounded-xl flex items-center justify-center">
                      <button onClick={() => toggleWatchlist(stock.symbol)} className={`px-6 py-3 rounded-lg font-semibold text-sm transition ${isWatchlisted ? 'bg-cyan-500/20 text-cyan-400 border border-cyan-500/30' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}`}>
                        {isWatchlisted ? 'â˜… Watchlisted' : 'â˜† Add to Watchlist'}
                      </button>
                    </div>
                  </div>

                  {/* ML Price Prediction */}
                  {stock.mlPrediction && stock.mlPrediction.predPct != null && (
                    <div className="glass-card p-6 rounded-xl border border-purple-500/20">
                      <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center gap-2">
                          <i className="fas fa-robot text-purple-400 text-xl"></i>
                          <h3 className="text-lg font-bold text-white">ML 30-Day Forecast</h3>
                          <span className="chip bg-purple-500/20 text-purple-400 text-xs">
                            <i className="fas fa-brain mr-1"></i>
                            TensorFlow.js
                          </span>
                        </div>
                      </div>

                      <div className="grid grid-cols-3 gap-4">
                        <div className="glass-card p-4 rounded-lg text-center">
                          <div className="text-xs text-slate-500 mb-2">Predicted Change</div>
                          <div className={`text-3xl font-bold ${stock.mlPrediction.predPct > 0 ? 'text-green-400' :
                              stock.mlPrediction.predPct < 0 ? 'text-red-400' :
                                'text-slate-400'
                            }`}>
                            {formatMLPrediction(stock.mlPrediction.predPct)}
                          </div>
                          {stock.mlPrediction.predictedPrice && (
                            <div className="text-xs text-slate-500 mt-2">
                              Target: ${stock.mlPrediction.predictedPrice}
                            </div>
                          )}
                        </div>

                        <div className="glass-card p-4 rounded-lg text-center">
                          <div className="text-xs text-slate-500 mb-2">Confidence</div>
                          <div className="text-3xl font-bold text-white">
                            {stock.mlPrediction.conf}%
                          </div>
                          <div className="text-xs text-slate-500 mt-2">
                            {stock.mlPrediction.conf >= 70 ? 'High' : stock.mlPrediction.conf >= 50 ? 'Medium' : 'Low'}
                          </div>
                        </div>

                        <div className="glass-card p-4 rounded-lg text-center">
                          <div className="text-xs text-slate-500 mb-2">Trend Signal</div>
                          <div className="text-2xl font-bold">
                            {stock.mlPrediction.trend === 'bullish' ? 'ğŸ”¼' :
                              stock.mlPrediction.trend === 'bearish' ? 'ğŸ”½' : 'â¡ï¸'}
                          </div>
                          <div className={`text-sm font-semibold mt-2 ${stock.mlPrediction.trend === 'bullish' ? 'text-green-400' :
                              stock.mlPrediction.trend === 'bearish' ? 'text-red-400' :
                                'text-slate-400'
                            }`}>
                            {stock.mlPrediction.trend.charAt(0).toUpperCase() + stock.mlPrediction.trend.slice(1)}
                          </div>
                        </div>
                      </div>

                      {stock.mlPrediction.interpretation && (
                        <div className="mt-3 p-3 bg-gradient-to-r from-purple-900/30 to-blue-900/30 border border-purple-700/50 rounded-lg">
                          <div className="flex items-start gap-2">
                            <i className="fas fa-chart-line text-purple-400 text-sm mt-0.5"></i>
                            <div className="flex-1">
                              <div className="text-xs font-semibold text-purple-300 mb-1">Model Interpretation</div>
                              <div className="text-xs text-slate-300 leading-relaxed">
                                {stock.mlPrediction.interpretation}
                              </div>
                            </div>
                          </div>
                        </div>
                      )}

                      <div className="mt-4 p-3 bg-slate-800/40 border border-slate-700/50 rounded-lg">
                        <div className="flex items-start gap-2">
                          <i className="fas fa-info-circle text-purple-400 text-sm mt-0.5"></i>
                          <div className="flex-1">
                            <div className="text-xs font-semibold text-purple-300 mb-1">How it works</div>
                            <div className="text-xs text-slate-400 leading-relaxed">
                              This prediction uses TensorFlow.js to analyze the last 60 days of price history with linear regression.
                              It forecasts short-term price movement based on recent trends. Remember: ML predictions are estimates,
                              not guarantees. Always combine with fundamental analysis.
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Ultimate Analysis Engine */}
                  {(() => {
                    const ultimateScore = ultimateEngine.calculateUltimateScore(stock);
                    const patterns = ultimateEngine.detectPatterns(stock);
                    const tradingPlan = ultimateEngine.generateTradingPlan(stock, ultimateScore);
                    const insights = ultimateEngine.generateAIInsights(stock, ultimateScore, patterns, tradingPlan);

                    return (
                      <div className="glass-card p-6 rounded-xl border border-indigo-500/20 bg-gradient-to-br from-indigo-500/5 to-purple-500/5">
                        <div className="flex items-center justify-between mb-4">
                          <div className="flex items-center gap-2">
                            <i className="fas fa-brain text-indigo-400 text-xl"></i>
                            <h3 className="text-lg font-bold text-white">Ultimate Analysis</h3>
                            <span className="chip bg-indigo-500/20 text-indigo-400 text-xs">
                              <i className="fas fa-star mr-1"></i>
                              15-Factor Scoring
                            </span>
                          </div>
                          <span className={`px-4 py-2 rounded-lg font-bold text-lg ${tradingPlan.signal === 'STRONG BUY' ? 'bg-emerald-500 text-white' :
                              tradingPlan.signal === 'BUY' ? 'bg-green-500 text-white' :
                                tradingPlan.signal === 'SELL' ? 'bg-red-500 text-white' :
                                  'bg-amber-500 text-white'
                            }`}>
                            {tradingPlan.signal}
                          </span>
                        </div>

                        {/* Score Display */}
                        <div className="grid grid-cols-4 gap-4 mb-4">
                          <div className="col-span-1 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-xl p-6 text-center">
                            <div className="text-sm text-indigo-200 mb-2">Ultimate Score</div>
                            <div className="text-5xl font-bold text-white mb-1">{ultimateScore.score}</div>
                            <div className="text-xs text-indigo-200">out of 100</div>
                            <div className="mt-3 text-xs text-white bg-white/20 rounded px-2 py-1">
                              {ultimateScore.confidence} Confidence
                            </div>
                          </div>

                          <div className="col-span-3 space-y-2">
                            <div className="grid grid-cols-2 gap-2">
                              {Object.entries(ultimateScore.factors).slice(0, 8).map(([factor, points]) => (
                                <div key={factor} className="glass-card p-3 rounded-lg flex items-center justify-between">
                                  <span className="text-sm text-slate-300 capitalize">{factor.replace(/_/g, ' ')}</span>
                                  <span className="text-sm font-bold text-indigo-400">{points} pts</span>
                                </div>
                              ))}
                            </div>
                          </div>
                        </div>

                        {/* AI Insights Summary */}
                        <div className="bg-slate-900/50 rounded-xl p-4 mb-4 border border-indigo-500/20">
                          <div className="text-sm text-slate-300 leading-relaxed mb-3">
                            {insights.summary}
                          </div>

                          {insights.strengths.length > 0 && (
                            <div className="mb-3">
                              <div className="text-xs font-semibold text-green-400 mb-2 flex items-center gap-2">
                                <i className="fas fa-check-circle"></i>
                                Strengths
                              </div>
                              <div className="space-y-1">
                                {insights.strengths.map((strength, idx) => (
                                  <div key={idx} className="text-xs text-slate-400 flex items-start gap-2">
                                    <span className="text-green-400">â€¢</span>
                                    <span>{strength}</span>
                                  </div>
                                ))}
                              </div>
                            </div>
                          )}

                          {insights.risks.length > 0 && (
                            <div className="mb-3">
                              <div className="text-xs font-semibold text-red-400 mb-2 flex items-center gap-2">
                                <i className="fas fa-exclamation-triangle"></i>
                                Risks
                              </div>
                              <div className="space-y-1">
                                {insights.risks.map((risk, idx) => (
                                  <div key={idx} className="text-xs text-slate-400 flex items-start gap-2">
                                    <span className="text-red-400">â€¢</span>
                                    <span>{risk}</span>
                                  </div>
                                ))}
                              </div>
                            </div>
                          )}

                          {insights.opportunities.length > 0 && (
                            <div className="mb-3">
                              <div className="text-xs font-semibold text-blue-400 mb-2 flex items-center gap-2">
                                <i className="fas fa-lightbulb"></i>
                                Opportunities
                              </div>
                              <div className="space-y-1">
                                {insights.opportunities.map((opp, idx) => (
                                  <div key={idx} className="text-xs text-slate-400 flex items-start gap-2">
                                    <span className="text-blue-400">â€¢</span>
                                    <span>{opp}</span>
                                  </div>
                                ))}
                              </div>
                            </div>
                          )}
                        </div>

                        {/* Trading Plan */}
                        <div className="bg-gradient-to-r from-indigo-900/30 to-purple-900/30 rounded-xl p-4 border border-indigo-500/30">
                          <div className="flex items-center gap-2 mb-3">
                            <i className="fas fa-chart-line text-indigo-400"></i>
                            <h4 className="text-sm font-bold text-white">Trading Plan</h4>
                          </div>

                          <div className="grid grid-cols-4 gap-3 mb-3">
                            <div>
                              <div className="text-xs text-slate-500 mb-1">Entry Price</div>
                              <div className="text-lg font-bold text-white">${tradingPlan.entry.toFixed(2)}</div>
                            </div>
                            <div>
                              <div className="text-xs text-slate-500 mb-1">Target Price</div>
                              <div className="text-lg font-bold text-green-400">${tradingPlan.target.toFixed(2)}</div>
                              <div className="text-xs text-green-300">+{((tradingPlan.target - tradingPlan.entry) / tradingPlan.entry * 100).toFixed(1)}%</div>
                            </div>
                            <div>
                              <div className="text-xs text-slate-500 mb-1">Stop Loss</div>
                              <div className="text-lg font-bold text-red-400">${tradingPlan.stopLoss.toFixed(2)}</div>
                              <div className="text-xs text-red-300">-{((tradingPlan.entry - tradingPlan.stopLoss) / tradingPlan.entry * 100).toFixed(1)}%</div>
                            </div>
                            <div>
                              <div className="text-xs text-slate-500 mb-1">R:R Ratio</div>
                              <div className="text-lg font-bold text-indigo-400">{tradingPlan.riskRewardRatio}:1</div>
                            </div>
                          </div>

                          <div className="grid grid-cols-2 gap-3 mb-3">
                            <div className="bg-slate-900/50 rounded p-2">
                              <div className="text-xs text-slate-500">Position Size</div>
                              <div className="text-sm font-bold text-white">{tradingPlan.positionSize}</div>
                            </div>
                            <div className="bg-slate-900/50 rounded p-2">
                              <div className="text-xs text-slate-500">Time Horizon</div>
                              <div className="text-sm font-bold text-white">{tradingPlan.timeframe}</div>
                            </div>
                          </div>

                          {tradingPlan.reasoning.length > 0 && (
                            <div className="bg-slate-900/50 rounded p-3">
                              <div className="text-xs font-semibold text-indigo-300 mb-2">Analysis Reasoning:</div>
                              <div className="space-y-1">
                                {tradingPlan.reasoning.map((reason, idx) => (
                                  <div key={idx} className="text-xs text-slate-400 flex items-start gap-2">
                                    <span className="text-indigo-400">â†’</span>
                                    <span>{reason}</span>
                                  </div>
                                ))}
                              </div>
                            </div>
                          )}

                          <div className="mt-3 p-3 bg-indigo-500/10 border border-indigo-500/30 rounded">
                            <div className="text-xs font-semibold text-indigo-300 mb-1">
                              <i className="fas fa-star mr-1"></i>
                              Recommendation
                            </div>
                            <div className="text-xs text-slate-300 leading-relaxed">
                              {insights.recommendation}
                            </div>
                          </div>
                        </div>

                        {/* Detected Patterns */}
                        {patterns.length > 0 && (
                          <div className="mt-4 bg-slate-900/50 rounded-xl p-4 border border-slate-700/50">
                            <div className="flex items-center gap-2 mb-3">
                              <i className="fas fa-shapes text-purple-400"></i>
                              <h4 className="text-sm font-bold text-white">Detected Patterns</h4>
                            </div>
                            <div className="grid grid-cols-2 gap-2">
                              {patterns.map((pattern, idx) => (
                                <div key={idx} className={`p-3 rounded-lg border ${pattern.type === 'bullish' ? 'bg-green-500/5 border-green-500/30' : 'bg-red-500/5 border-red-500/30'
                                  }`}>
                                  <div className="flex items-center justify-between mb-1">
                                    <span className={`text-sm font-semibold ${pattern.type === 'bullish' ? 'text-green-400' : 'text-red-400'
                                      }`}>
                                      {pattern.name}
                                    </span>
                                    <span className="text-xs text-slate-500">
                                      {(pattern.confidence * 100).toFixed(0)}% conf.
                                    </span>
                                  </div>
                                  <div className="text-xs text-slate-400">{pattern.description}</div>
                                </div>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
                    );
                  })()}

                  {/* AI Verdict */}
                  {stock.verdict && (
                    <div className={`p-6 rounded-xl ${stock.verdict === 'STRONG BUY' || stock.verdict === 'BUY' ? 'verdict-bullish' : stock.verdict === 'SELL' || stock.verdict === 'REDUCE' ? 'verdict-bearish' : 'verdict-neutral'}`}>
                      <div className="flex items-center justify-between mb-3">
                        <div className="flex items-center gap-3">
                          <span className="text-2xl font-bold text-white">{stock.verdict}</span>
                          <span className="badge bg-slate-800/50 text-slate-300">Score: {stock.aiScore || 0}/100</span>
                          <span className="badge bg-slate-800/50 text-slate-300">Confidence: {stock.confidence || 0}%</span>
                        </div>
                      </div>
                      <div className="text-sm text-slate-300 leading-relaxed mb-4">{stock.execSummary || 'AI analysis unavailable'}</div>

                      {/* Subscores */}
                      {stock.subscores && (
                        <div className="grid grid-cols-3 gap-3 mb-4">
                          <div className="glass-card p-3 rounded-lg">
                            <div className="text-xs text-slate-500 mb-1">Fundamentals</div>
                            <div className="text-lg font-bold text-white">{Math.round(stock.subscores.fundamental)}/100</div>
                          </div>
                          <div className="glass-card p-3 rounded-lg">
                            <div className="text-xs text-slate-500 mb-1">Technicals</div>
                            <div className="text-lg font-bold text-white">{Math.round(stock.subscores.technical)}/100</div>
                          </div>
                          <div className="glass-card p-3 rounded-lg">
                            <div className="text-xs text-slate-500 mb-1">Risk Level</div>
                            <div className="text-lg font-bold text-white">{Math.round(stock.subscores.risk)}/100</div>
                          </div>
                        </div>
                      )}

                      {/* Explainable AI (why + changes + sensitivity) */}
                      <div className="mb-4">
                        <button
                          onClick={() => setShowExplainScore(v => !v)}
                          className="px-3 py-1.5 rounded-lg text-xs font-semibold bg-slate-800/60 hover:bg-slate-700/60 border border-slate-700/60 text-slate-200"
                        >
                          {showExplainScore ? 'Hide explanation' : 'Explain this rating'}
                        </button>
                      </div>

                      {showExplainScore && (
                        <div className="space-y-4 mb-4">
                          <div className="glass-card p-4 rounded-xl">
                            <div className="flex items-center justify-between mb-2">
                              <div className="text-xs font-bold text-slate-300 uppercase">How the score is computed</div>
                              <div className="text-xs text-slate-400">Weights: 55% Fundamentals Â· 35% Technicals Â· 10% Risk</div>
                            </div>
                            <div className="text-xs text-slate-300 leading-relaxed">
                              Deterministic rules adjust the subscores, then the final score is computed as{' '}
                              <span className="font-mono">0.55Ã—Fundamentals + 0.35Ã—Technicals + 0.10Ã—(100âˆ’Risk)</span>.
                            </div>
                          </div>

                          <div className="glass-card p-4 rounded-xl">
                            <div className="flex items-center justify-between mb-3">
                              <div className="text-xs font-bold text-slate-300 uppercase">Top drivers (impact on score)</div>
                              <div className="text-xs text-slate-400">
                                Current: {explainNow.score}/100
                                {explainThresholds?.nextUpScore != null ? ` Â· Next upgrade: ${explainThresholds.nextUpScore} (+${explainThresholds.toNextUp})` : ''}
                              </div>
                            </div>
                            <div className="space-y-2">
                              {(explainNow.topImpacts || []).length === 0 ? (
                                <div className="text-xs text-slate-500">No rule-level drivers available.</div>
                              ) : (explainNow.topImpacts || []).map((d, i) => (
                                <div key={i} className="flex items-start justify-between gap-3 text-xs">
                                  <div className="flex-1">
                                    <div className="font-semibold text-slate-200">{d.label}</div>
                                    <div className="text-slate-400 mt-0.5">{d.detail}</div>
                                  </div>
                                  <div className={`font-mono font-bold ${d.impact >= 0 ? 'text-green-300' : 'text-red-300'}`}>
                                    {d.impact >= 0 ? '+' : ''}{d.impact.toFixed(1)}
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>

                          <div className="glass-card p-4 rounded-xl">
                            <div className="text-xs font-bold text-slate-300 uppercase mb-2">What changed since last snapshot</div>
                            {!prevAnalysis ? (
                              <div className="text-xs text-slate-500">No previous snapshot found yet (refresh once to start tracking changes).</div>
                            ) : (
                              <div className="space-y-2 text-xs">
                                <div className="text-slate-400">
                                  Previous saved: {prevSnapshotEntry?.timestamp ? `${Math.max(1, Math.round((Date.now() - prevSnapshotEntry.timestamp) / 60000))} min ago` : 'â€”'}
                                </div>
                                <div className="flex items-center justify-between">
                                  <div className="text-slate-300">AI Score</div>
                                  <div className="font-mono font-bold text-white">
                                    {num(prevAnalysis.aiScore, 0)} â†’ {num(stock.aiScore, 0)}
                                    <span className={`ml-2 ${num(stock.aiScore, 0) - num(prevAnalysis.aiScore, 0) >= 0 ? 'text-green-300' : 'text-red-300'}`}>
                                      ({num(stock.aiScore, 0) - num(prevAnalysis.aiScore, 0) >= 0 ? '+' : ''}{num(stock.aiScore, 0) - num(prevAnalysis.aiScore, 0)})
                                    </span>
                                  </div>
                                </div>
                                <div className="grid grid-cols-3 gap-2">
                                  <div className="bg-slate-800/40 border border-slate-700/40 rounded-lg p-2">
                                    <div className="text-slate-500">Fundamentals</div>
                                    <div className="font-mono text-slate-200">{Math.round(num(prevAnalysis.subscores?.fundamental, 0))} â†’ {Math.round(num(stock.subscores?.fundamental, 0))}</div>
                                  </div>
                                  <div className="bg-slate-800/40 border border-slate-700/40 rounded-lg p-2">
                                    <div className="text-slate-500">Technicals</div>
                                    <div className="font-mono text-slate-200">{Math.round(num(prevAnalysis.subscores?.technical, 0))} â†’ {Math.round(num(stock.subscores?.technical, 0))}</div>
                                  </div>
                                  <div className="bg-slate-800/40 border border-slate-700/40 rounded-lg p-2">
                                    <div className="text-slate-500">Risk</div>
                                    <div className="font-mono text-slate-200">{Math.round(num(prevAnalysis.subscores?.risk, 0))} â†’ {Math.round(num(stock.subscores?.risk, 0))}</div>
                                  </div>
                                </div>
                              </div>
                            )}
                          </div>

                          <div className="glass-card p-4 rounded-xl">
                            <div className="text-xs font-bold text-slate-300 uppercase mb-2">Sensitivity (what would move the rating)</div>
                            {(sensitivity || []).length === 0 ? (
                              <div className="text-xs text-slate-500">No high-impact single-factor sensitivities detected.</div>
                            ) : (
                              <div className="space-y-2">
                                {(sensitivity || []).map((s, i) => (
                                  <div key={i} className="flex items-start justify-between gap-3 text-xs">
                                    <div className="flex-1">
                                      <div className="font-semibold text-slate-200">{s.title}</div>
                                      <div className="text-slate-400 mt-0.5">{s.note}</div>
                                    </div>
                                    <div className={`font-mono font-bold ${s.delta >= 0 ? 'text-green-300' : 'text-red-300'}`}>
                                      {s.delta >= 0 ? '+' : ''}{s.delta} â†’ {s.newScore}
                                    </div>
                                  </div>
                                ))}
                              </div>
                            )}
                            <div className="mt-3 text-xs text-slate-500">
                              Sensitivities change one input at a time to the nearest model threshold (not a forecast).
                            </div>
                          </div>
                        </div>
                      )}

                      {/* Reassurance (emotional safety) */}
                      {stock.reassurance && (
                        <div className="mb-4 p-3 bg-slate-800/40 border border-slate-700/50 rounded-lg text-xs text-slate-300">
                          <span className="font-semibold text-slate-200">Note:</span> {stock.reassurance}
                        </div>
                      )}

                      {/* Score Drivers */}
                      {stock.topDrivers && (
                        <div className="grid grid-cols-2 gap-4 mb-4">
                          <div className="glass-card p-4 rounded-xl">
                            <div className="text-xs font-bold text-green-400 mb-2 uppercase">What&apos;s helping</div>
                            <div className="space-y-2">
                              {(stock.topDrivers.positive || []).length === 0 ? (
                                <div className="text-xs text-slate-500">No strong positive drivers detected.</div>
                              ) : (stock.topDrivers.positive || []).map((d, i) => (
                                <div key={i} className="text-xs">
                                  <div className="font-semibold text-green-300">{d.factor}</div>
                                  <div className="text-slate-400 mt-0.5">{d.detail}</div>
                                </div>
                              ))}
                            </div>
                          </div>
                          <div className="glass-card p-4 rounded-xl">
                            <div className="text-xs font-bold text-red-400 mb-2 uppercase">What&apos;s hurting</div>
                            <div className="space-y-2">
                              {(stock.topDrivers.negative || []).length === 0 ? (
                                <div className="text-xs text-slate-500">No strong negative drivers detected.</div>
                              ) : (stock.topDrivers.negative || []).map((d, i) => (
                                <div key={i} className="text-xs">
                                  <div className="font-semibold text-red-300">{d.factor}</div>
                                  <div className="text-slate-400 mt-0.5">{d.detail}</div>
                                </div>
                              ))}
                            </div>
                          </div>
                        </div>
                      )}

                      {/* AI Takeaway (interpretive closure) */}
                      {stock.takeaway && (
                        <div className="mb-4 p-4 bg-cyan-500/10 border border-cyan-500/20 rounded-xl">
                          <div className="text-xs font-bold text-cyan-300 uppercase mb-2">AI Takeaway</div>
                          <div className="text-sm text-slate-200 leading-relaxed">{stock.takeaway}</div>
                        </div>
                      )}

                      {/* Bull/Bear Factors */}
                      {(stock.bullFactors || stock.bearFactors) && (
                        <div className="grid grid-cols-2 gap-4">
                          {/* Bullish Factors */}
                          <div>
                            <div className="text-xs font-bold text-green-400 mb-2 uppercase">Bullish Factors</div>
                            <div className="space-y-2">
                              {(showAllFactors ? (stock.bullFactors || []) : (stock.bullFactors || []).slice(0, 3)).map((f, i) => (
                                <div key={i} className="text-xs bg-green-500/10 border border-green-500/20 rounded-lg p-2">
                                  <div className="font-semibold text-green-300">{f.factor}</div>
                                  <div className="text-slate-400 mt-1">{f.detail}</div>
                                </div>
                              ))}
                            </div>
                          </div>

                          {/* Bearish Factors */}
                          <div>
                            <div className="text-xs font-bold text-red-400 mb-2 uppercase">Bearish Factors</div>
                            <div className="space-y-2">
                              {(showAllFactors ? (stock.bearFactors || []) : (stock.bearFactors || []).slice(0, 3)).map((f, i) => (
                                <div key={i} className="text-xs bg-red-500/10 border border-red-500/20 rounded-lg p-2">
                                  <div className="font-semibold text-red-300">{f.factor}</div>
                                  <div className="text-slate-400 mt-1">{f.detail}</div>
                                </div>
                              ))}
                            </div>
                          </div>
                        </div>
                      )}

                      {((stock.bullFactors || []).length > 3 || (stock.bearFactors || []).length > 3) && (
                        <div className="mt-3 flex justify-center">
                          <button
                            onClick={() => setShowAllFactors(v => !v)}
                            className="px-3 py-1.5 rounded-lg text-xs font-semibold bg-slate-800/60 hover:bg-slate-700/60 border border-slate-700/60 text-slate-200"
                          >
                            {showAllFactors ? 'Show fewer factors' : 'Show all factors'}
                          </button>
                        </div>
                      )}
                    </div>
                  )}

                  {/* Thematic Context - REMOVED */}

                  {/* Watchlist Guidance */}
                  {stock.watchlistGuidance && (
                    <div className="glass-card p-5 rounded-xl">
                      <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">{stock.watchlistGuidance.headline || 'What to watch next'}</h4>
                      <div className="grid grid-cols-3 gap-3">
                        {(stock.watchlistGuidance.items || []).map((it, idx) => (
                          <div key={idx} className="bg-slate-800/40 border border-slate-700/40 rounded-lg p-3">
                            <div className="text-xs text-slate-500 mb-1">{it.label}</div>
                            <div className="text-xs text-slate-200 leading-relaxed">{it.value}</div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* Export Actions */}
                  <div className="glass-card p-5 rounded-xl">
                    <div className="flex items-center justify-between">
                      <div>
                        <h4 className="text-sm font-bold text-white mb-1">Export Analysis</h4>
                        <p className="text-xs text-slate-400">Download this stock analysis as a professional PDF tear sheet</p>
                      </div>
                      <button
                        onClick={() => exportStockTearSheet(stock)}
                        className="px-6 py-3 bg-gradient-to-r from-red-600 to-red-500 hover:from-red-500 hover:to-red-400 text-white rounded-lg font-bold flex items-center gap-2 shadow-lg shadow-red-500/20 transition-all"
                      >
                        <i className="fas fa-file-pdf text-lg"></i>
                        <span>Download PDF</span>
                      </button>
                    </div>
                  </div>

                  {/* Company Information */}
                  {(stock.description || stock.ceo || stock.website) && (
                    <div className="glass-card p-5 rounded-xl">
                      <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Company Info</h4>
                      {stock.description && (
                        <div className="mb-4">
                          <div className="text-xs text-slate-500 mb-1">Description</div>
                          <div className="text-sm text-slate-300 leading-relaxed">{stock.description}</div>
                        </div>
                      )}
                      <div className="grid grid-cols-2 gap-4 text-sm">
                        {stock.ceo && (
                          <div>
                            <div className="text-xs text-slate-500 mb-1">CEO</div>
                            <div className="text-white">{stock.ceo}</div>
                          </div>
                        )}
                        {stock.website && (
                          <div>
                            <div className="text-xs text-slate-500 mb-1">Website</div>
                            <a href={stock.website.startsWith('http') ? stock.website : `https://${stock.website}`} target="_blank" rel="noopener noreferrer" className="text-cyan-400 hover:underline">
                              {stock.website.replace(/^https?:\/\//, '')}
                            </a>
                          </div>
                        )}
                      </div>
                    </div>
                  )}
                </div>
              ) : activeTab === 'ai-analysis' ? (
                <div className="space-y-6">
                  {/* Header */}
                  <div className="glass-card p-6 rounded-xl border border-blue-500/20">
                    <div className="flex items-center justify-between mb-4">
                      <div className="flex items-center gap-3">
                        <i className="fas fa-robot text-blue-400 text-2xl"></i>
                        <div>
                          <h3 className="text-xl font-bold text-white">AI Stock Analysis</h3>
                          <p className="text-sm text-slate-400">Professional analysis powered by DeepSeek AI</p>
                        </div>
                      </div>
                      <button
                        onClick={async () => {
                          setAiLoading(true);
                          setDeepseekLoading(true);

                          try {
                            const analysis = await getDeepSeekAnalysis(stock);
                            setDeepseekAnalysis(analysis);
                          } catch (error) {
                            setDeepseekAnalysis(`Error: ${error.message}`);
                          } finally {
                            setDeepseekLoading(false);
                            setAiLoading(false);
                          }
                        }}
                        disabled={aiLoading}
                        className="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg font-semibold transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                      >
                        {aiLoading ? (
                          <>
                            <i className="fas fa-spinner animate-spin"></i>
                            Analyzing...
                          </>
                        ) : (
                          <>
                            <i className="fas fa-brain"></i>
                            {deepseekAnalysis ? 'Refresh Analysis' : 'Generate AI Analysis'}
                          </>
                        )}
                      </button>
                    </div>

                    {/* Info */}
                    <div className="flex items-center gap-3 pt-4 border-t border-slate-700/30">
                      <i className="fas fa-info-circle text-blue-400"></i>
                      <span className="text-sm text-slate-400">Get comprehensive analysis from <strong className="text-blue-400">DeepSeek AI</strong></span>
                    </div>
                  </div>

                  {/* AI Analysis Content */}
                  {aiLoading && !deepseekAnalysis ? (
                    <div className="glass-card p-12 rounded-xl text-center">
                      <i className="fas fa-robot text-blue-400 text-5xl mb-4 animate-pulse"></i>
                      <div className="text-xl font-bold text-white mb-2">Analyzing {stock.symbol}...</div>
                      <div className="text-slate-400">DeepSeek AI is processing comprehensive stock data</div>
                    </div>
                  ) : deepseekAnalysis ? (
                    <div className="max-w-4xl mx-auto">
                      {/* DeepSeek Analysis */}
                      <div className="glass-card p-8 rounded-xl border-2 border-blue-500/30">
                        <div className="flex items-center gap-2 mb-6">
                          <span className="px-4 py-2 rounded-full font-semibold text-sm bg-blue-500/20 text-blue-400">
                            <i className="fas fa-rocket mr-2"></i>
                            DeepSeek AI Analysis
                          </span>
                          {deepseekLoading && (
                            <i className="fas fa-spinner animate-spin text-blue-400 ml-2"></i>
                          )}
                        </div>
                        <div className="prose prose-invert prose-slate max-w-none">
                          <div
                            className="text-slate-200 leading-relaxed whitespace-pre-wrap"
                            style={{
                              fontFamily: 'system-ui, -apple-system, sans-serif',
                              fontSize: '0.95rem',
                              lineHeight: '1.7'
                            }}
                            dangerouslySetInnerHTML={{
                              __html: deepseekAnalysis
                                .replace(/^# (.*?)$/gm, '<h1 class="text-2xl font-bold text-white mt-6 mb-3">$1</h1>')
                                .replace(/^## (.*?)$/gm, '<h2 class="text-xl font-bold text-white mt-5 mb-2">$1</h2>')
                                .replace(/^### (.*?)$/gm, '<h3 class="text-lg font-semibold text-white mt-4 mb-2">$1</h3>')
                                .replace(/^\* (.*?)$/gm, '<li class="ml-4 mb-1">â€¢ $1</li>')
                                .replace(/^\d+\. (.*?)$/gm, '<li class="ml-4 mb-1">$1</li>')
                                .replace(/\*\*(.*?)\*\*/g, '<strong class="text-white font-semibold">$1</strong>')
                                .replace(/\n\n/g, '<br/><br/>')
                            }}
                          />
                        </div>
                      </div>
                    </div>
                  ) : (
                    <div className="glass-card p-12 rounded-xl text-center border-2 border-dashed border-slate-700">
                      <i className="fas fa-magic text-blue-400 text-5xl mb-4 opacity-50"></i>
                      <div className="text-xl font-bold text-white mb-2">Ready for AI Analysis</div>
                      <div className="text-slate-400 mb-4">Click "Generate AI Analysis" to get insights from DeepSeek AI</div>
                      <div className="text-sm text-slate-500">
                        DeepSeek will analyze {stock.symbol}'s fundamentals, technicals, and market position
                      </div>
                    </div>
                  )}
                </div>
              ) : activeTab === 'news-sentiment' ? (
                <div className="space-y-6">
                  {/* Sentiment Overview Grid */}
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    {/* News Sentiment Card */}
                    {newsSentiment && (
                      <div className={`glass-card p-6 rounded-xl border-2 ${newsSentiment.label === 'bullish' ? 'border-green-500/30 bg-green-500/5' :
                          newsSentiment.label === 'bearish' ? 'border-red-500/30 bg-red-500/5' :
                            'border-slate-500/30 bg-slate-500/5'
                        }`}>
                        <div className="flex items-center justify-between mb-4">
                          <div>
                            <h3 className="text-xl font-bold text-white mb-1">ğŸ“° News Sentiment</h3>
                            <p className="text-sm text-slate-400">Based on {newsSentiment.count} articles</p>
                          </div>
                          <div className="text-right">
                            <div className={`text-4xl font-bold ${newsSentiment.label === 'bullish' ? 'text-green-400' :
                                newsSentiment.label === 'bearish' ? 'text-red-400' :
                                  'text-slate-400'
                              }`}>
                              {newsSentiment.label === 'bullish' ? 'ğŸ“ˆ' : newsSentiment.label === 'bearish' ? 'ğŸ“‰' : 'â¡ï¸'}
                            </div>
                            <div className={`text-xl font-bold mt-2 ${newsSentiment.label === 'bullish' ? 'text-green-400' :
                                newsSentiment.label === 'bearish' ? 'text-red-400' :
                                  'text-slate-400'
                              }`}>
                              {newsSentiment.label.toUpperCase()}
                            </div>
                          </div>
                        </div>

                        <div className="grid grid-cols-3 gap-3">
                          <div className="text-center p-2 bg-green-500/10 rounded-lg">
                            <div className="text-xl font-bold text-green-400">{newsSentiment.bullishCount}</div>
                            <div className="text-xs text-slate-400 mt-1">Bullish</div>
                          </div>
                          <div className="text-center p-2 bg-slate-700/30 rounded-lg">
                            <div className="text-xl font-bold text-slate-400">{newsSentiment.neutralCount}</div>
                            <div className="text-xs text-slate-400 mt-1">Neutral</div>
                          </div>
                          <div className="text-center p-2 bg-red-500/10 rounded-lg">
                            <div className="text-xl font-bold text-red-400">{newsSentiment.bearishCount}</div>
                            <div className="text-xs text-slate-400 mt-1">Bearish</div>
                          </div>
                        </div>

                        <div className="mt-3 p-2 bg-slate-800/50 rounded-lg text-center">
                          <span className="text-xs text-slate-400">Score: </span>
                          <span className={`font-bold text-sm ${newsSentiment.score > 0 ? 'text-green-400' :
                              newsSentiment.score < 0 ? 'text-red-400' :
                                'text-slate-400'
                            }`}>
                            {newsSentiment.score > 0 ? '+' : ''}{newsSentiment.score}/100
                          </span>
                        </div>
                      </div>
                    )}

                    {/* Social Sentiment Card */}
                    {socialLoading ? (
                      <div className="glass-card p-6 rounded-xl border-2 border-slate-500/30">
                        <div className="text-center">
                          <i className="fas fa-spinner animate-spin text-cyan-400 text-3xl mb-3"></i>
                          <p className="text-slate-400">Loading social sentiment...</p>
                        </div>
                      </div>
                    ) : socialSentiment && socialSentiment.totalMessages > 0 ? (
                      <div className={`glass-card p-6 rounded-xl border-2 ${socialSentiment.overallSentiment === 'bullish' ? 'border-green-500/30 bg-green-500/5' :
                          socialSentiment.overallSentiment === 'bearish' ? 'border-red-500/30 bg-red-500/5' :
                            'border-slate-500/30 bg-slate-500/5'
                        }`}>
                        <div className="flex items-center justify-between mb-4">
                          <div>
                            <h3 className="text-xl font-bold text-white mb-1">
                              ğŸ’¬ Social Sentiment
                              {socialSentiment.trending && (
                                <span className="ml-2 text-xs bg-orange-500/20 text-orange-400 px-2 py-1 rounded">ğŸ”¥ TRENDING</span>
                              )}
                            </h3>
                            <p className="text-sm text-slate-400">
                              StockTwits: {socialSentiment.stockTwitsCount || 0} |
                              Reddit: {socialSentiment.redditCount || 0} posts
                            </p>
                          </div>
                          <div className="text-right">
                            <div className={`text-4xl font-bold ${socialSentiment.overallSentiment === 'bullish' ? 'text-green-400' :
                                socialSentiment.overallSentiment === 'bearish' ? 'text-red-400' :
                                  'text-slate-400'
                              }`}>
                              {socialSentiment.overallSentiment === 'bullish' ? 'ğŸš€' : socialSentiment.overallSentiment === 'bearish' ? 'ğŸ»' : 'ğŸ˜'}
                            </div>
                            <div className={`text-xl font-bold mt-2 ${socialSentiment.overallSentiment === 'bullish' ? 'text-green-400' :
                                socialSentiment.overallSentiment === 'bearish' ? 'text-red-400' :
                                  'text-slate-400'
                              }`}>
                              {socialSentiment.overallSentiment.toUpperCase()}
                            </div>
                          </div>
                        </div>

                        <div className="grid grid-cols-3 gap-3">
                          <div className="text-center p-2 bg-green-500/10 rounded-lg">
                            <div className="text-xl font-bold text-green-400">{socialSentiment.bullishPercent}%</div>
                            <div className="text-xs text-slate-400 mt-1">Bullish</div>
                          </div>
                          <div className="text-center p-2 bg-slate-700/30 rounded-lg">
                            <div className="text-xl font-bold text-slate-400">{socialSentiment.neutralPercent}%</div>
                            <div className="text-xs text-slate-400 mt-1">Neutral</div>
                          </div>
                          <div className="text-center p-2 bg-red-500/10 rounded-lg">
                            <div className="text-xl font-bold text-red-400">{socialSentiment.bearishPercent}%</div>
                            <div className="text-xs text-slate-400 mt-1">Bearish</div>
                          </div>
                        </div>

                        <div className="mt-3 p-2 bg-slate-800/50 rounded-lg text-center">
                          <span className="text-xs text-slate-400">Combined Score: </span>
                          <span className={`font-bold text-sm ${socialSentiment.sentimentScore > 0 ? 'text-green-400' :
                              socialSentiment.sentimentScore < 0 ? 'text-red-400' :
                                'text-slate-400'
                            }`}>
                            {socialSentiment.sentimentScore > 0 ? '+' : ''}{socialSentiment.sentimentScore}%
                          </span>
                        </div>

                        {/* Reddit Posts Section */}
                        {socialSentiment.redditPosts && socialSentiment.redditPosts.length > 0 && (
                          <div className="mt-4 pt-4 border-t border-slate-700/50">
                            <h4 className="text-sm font-bold text-white mb-3 flex items-center gap-2">
                              <span>ğŸ¤– Top Reddit Discussions</span>
                            </h4>
                            <div className="space-y-2">
                              {socialSentiment.redditPosts.slice(0, 3).map((post, idx) => (
                                <div key={idx} className="bg-slate-800/50 rounded-lg p-3 hover:bg-slate-800/70 transition cursor-pointer"
                                  onClick={() => window.open(post.url, '_blank')}>
                                  <div className="flex items-start justify-between gap-2 mb-1">
                                    <div className="flex-1 min-w-0">
                                      <div className="text-xs font-semibold text-white truncate">{post.title}</div>
                                      <div className="text-xs text-slate-400 mt-1">
                                        r/{post.subreddit} â€¢ u/{post.author} â€¢ â¬†ï¸ {post.score} â€¢ ğŸ’¬ {post.comments}
                                      </div>
                                    </div>
                                    <div className={`chip text-xs flex-shrink-0 ${post.sentiment === 'bullish' ? 'bg-green-500/20 text-green-400' :
                                        post.sentiment === 'bearish' ? 'bg-red-500/20 text-red-400' :
                                          'bg-slate-500/20 text-slate-400'
                                      }`}>
                                      {post.sentiment === 'bullish' ? 'ğŸ“ˆ' : post.sentiment === 'bearish' ? 'ğŸ“‰' : 'â¡ï¸'}
                                    </div>
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
                    ) : (
                      <div className="glass-card p-6 rounded-xl border-2 border-slate-500/30">
                        <div className="text-center">
                          <div className="text-4xl mb-3">ğŸ’¬</div>
                          <p className="text-slate-400">No social sentiment data available</p>
                        </div>
                      </div>
                    )}
                  </div>

                  {/* Aggregate Sentiment Overview */}
                  {newsSentiment && (
                    <div className={`glass-card p-6 rounded-xl border-2 ${newsSentiment.label === 'bullish' ? 'border-green-500/30 bg-green-500/5' :
                        newsSentiment.label === 'bearish' ? 'border-red-500/30 bg-red-500/5' :
                          'border-slate-500/30 bg-slate-500/5'
                      }`} style={{ display: 'none' }}>
                      <div className="flex items-center justify-between mb-4">
                        <div>
                          <h3 className="text-xl font-bold text-white mb-1">Market Sentiment</h3>
                          <p className="text-sm text-slate-400">Based on {newsSentiment.count} recent articles</p>
                        </div>
                        <div className="text-right">
                          <div className={`text-5xl font-bold ${newsSentiment.label === 'bullish' ? 'text-green-400' :
                              newsSentiment.label === 'bearish' ? 'text-red-400' :
                                'text-slate-400'
                            }`}>
                            {newsSentiment.label === 'bullish' ? 'ğŸ“ˆ' : newsSentiment.label === 'bearish' ? 'ğŸ“‰' : 'â¡ï¸'}
                          </div>
                          <div className={`text-2xl font-bold mt-2 ${newsSentiment.label === 'bullish' ? 'text-green-400' :
                              newsSentiment.label === 'bearish' ? 'text-red-400' :
                                'text-slate-400'
                            }`}>
                            {newsSentiment.label.toUpperCase()}
                          </div>
                        </div>
                      </div>

                      <div className="grid grid-cols-3 gap-4">
                        <div className="text-center p-3 bg-green-500/10 rounded-lg">
                          <div className="text-2xl font-bold text-green-400">{newsSentiment.bullishCount}</div>
                          <div className="text-xs text-slate-400 mt-1">Bullish Articles</div>
                        </div>
                        <div className="text-center p-3 bg-slate-700/30 rounded-lg">
                          <div className="text-2xl font-bold text-slate-400">{newsSentiment.neutralCount}</div>
                          <div className="text-xs text-slate-400 mt-1">Neutral Articles</div>
                        </div>
                        <div className="text-center p-3 bg-red-500/10 rounded-lg">
                          <div className="text-2xl font-bold text-red-400">{newsSentiment.bearishCount}</div>
                          <div className="text-xs text-slate-400 mt-1">Bearish Articles</div>
                        </div>
                      </div>

                      <div className="mt-4 p-3 bg-slate-800/50 rounded-lg">
                        <div className="text-xs text-slate-400">Sentiment Score:
                          <span className={`font-bold ml-2 ${newsSentiment.score > 0 ? 'text-green-400' :
                              newsSentiment.score < 0 ? 'text-red-400' :
                                'text-slate-400'
                            }`}>
                            {newsSentiment.score > 0 ? '+' : ''}{newsSentiment.score}/100
                          </span>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* News Feed */}
                  <div>
                    <div className="flex items-center justify-between mb-4">
                      <h3 className="text-xl font-bold text-white">ğŸ“° News & Sentiment</h3>
                      <div className="flex items-center gap-3">
                        {newsLoading && (
                          <div className="text-sm text-cyan-400">
                            <i className="fas fa-spinner animate-spin mr-2"></i>
                            Loading news...
                          </div>
                        )}
                        {newsData.length > 0 && (
                          <DataFreshnessIndicator
                            timestamp={newsData[0]?.timestamp}
                            type="news"
                          />
                        )}
                      </div>
                    </div>

                    {newsData.length === 0 && !newsLoading ? (
                      <div className="glass-card p-8 rounded-xl text-center">
                        <div className="text-4xl mb-3">ğŸ“°</div>
                        <div className="text-slate-400">No recent news available</div>
                      </div>
                    ) : (
                      <div className="space-y-4">
                        {newsData.map((article, index) => (
                          <div key={index} className="glass-card p-4 rounded-xl hover:border-cyan-500/30 transition cursor-pointer"
                            onClick={() => window.open(article.url, '_blank')}>
                            <div className="flex gap-4">
                              {article.image && (
                                <img src={article.image} alt=""
                                  className="w-24 h-24 object-cover rounded-lg flex-shrink-0"
                                  onError={(e) => e.target.style.display = 'none'} />
                              )}
                              <div className="flex-1 min-w-0">
                                <div className="flex items-start justify-between gap-3 mb-2">
                                  <h4 className="font-semibold text-white leading-tight hover:text-cyan-400 transition">
                                    {article.title}
                                  </h4>
                                  <div className={`chip flex-shrink-0 ${article.sentiment.label === 'bullish' ? 'bg-green-500/20 text-green-400 border-green-500/30' :
                                      article.sentiment.label === 'bearish' ? 'bg-red-500/20 text-red-400 border-red-500/30' :
                                        'bg-slate-500/20 text-slate-400 border-slate-500/30'
                                    }`}>
                                    {article.sentiment.label === 'bullish' ? 'ğŸ“ˆ Bullish' :
                                      article.sentiment.label === 'bearish' ? 'ğŸ“‰ Bearish' :
                                        'â¡ï¸ Neutral'}
                                  </div>
                                </div>

                                {article.description && (
                                  <p className="text-sm text-slate-400 mb-2 line-clamp-2">
                                    {article.description}
                                  </p>
                                )}

                                <div className="flex items-center gap-3 text-xs text-slate-500">
                                  <span className="font-medium text-cyan-400">{article.source}</span>
                                  <span>â€¢</span>
                                  <span>{formatDateSafe(article.publishedAt)}</span>
                                  <span>{(() => {
                                    const t = new Date(article.publishedAt).getTime();
                                    return Number.isFinite(t)
                                      ? new Date(t).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                                      : 'â€”';
                                  })()}</span>
                                  {article.sentiment.confidence > 0 && (
                                    <>
                                      <span>â€¢</span>
                                      <span className="text-slate-400">
                                        Confidence: {article.sentiment.confidence}%
                                      </span>
                                    </>
                                  )}
                                </div>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>

                  {/* Sentiment Explanation */}
                  <div className="glass-card p-4 rounded-xl bg-slate-800/50">
                    <div className="flex items-start gap-2">
                      <i className="fas fa-info-circle text-cyan-400 text-sm mt-0.5"></i>
                      <div className="flex-1">
                        <div className="text-xs font-semibold text-cyan-300 mb-1">About Sentiment Analysis</div>
                        <div className="text-xs text-slate-400 leading-relaxed">
                          News sentiment is analyzed using natural language processing to identify bullish, bearish, or neutral tones.
                          This helps gauge market perception and potential price movements. Sentiment updates automatically every 5 minutes.
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              ) : activeTab === 'simplified' ? (
                <div>
                  {/* Header */}
                  <div className="glass-card p-6 mb-6 rounded-xl border border-cyan-500/20">
                    <div className="flex items-center gap-3 mb-3">
                      <i className="fas fa-lightbulb text-cyan-400 text-2xl"></i>
                      <h3 className="text-xl font-bold text-white">Simplified Analysis</h3>
                    </div>
                    <div className="text-sm text-slate-400 leading-relaxed">
                      We've translated complex financial metrics into plain English so you can understand what really matters.
                    </div>
                  </div>

                  {/* Valuation Gauge */}
                  <div className="glass-card p-6 mb-6 rounded-xl">
                    <h4 className="text-lg font-bold text-white mb-4 text-center flex items-center justify-center gap-2">
                      <i className="fas fa-gauge"></i>
                      Overall Valuation
                    </h4>
                    {(() => {
                      const score = calculateValuationScore(stock);
                      const valuation = getValuationLabel(score);
                      return (
                        <div>
                          <div className="flex items-center justify-center gap-3 mb-4">
                            <span className="text-4xl">{valuation.emoji}</span>
                            <div>
                              <div className="text-3xl font-bold" style={{ color: valuation.color }}>
                                {valuation.label}
                              </div>
                              <div className="text-sm text-slate-400">
                                Valuation Score: {score}/100
                              </div>
                            </div>
                          </div>
                          <div className="relative h-24 mb-4">
                            <div className="absolute w-full h-3 top-10 rounded-full" style={{ background: 'linear-gradient(to right, #22c55e 0%, #eab308 50%, #ef4444 100%)' }}></div>
                            <div className="absolute w-1 h-10 bg-white shadow-lg top-4 transition-all duration-500" style={{ left: `${score}%`, transform: 'translateX(-50%)' }}>
                              <div className="absolute -top-2 left-1/2 -translate-x-1/2 w-0 h-0 border-l-8 border-r-8 border-t-8 border-transparent border-t-white"></div>
                            </div>
                            <div className="absolute w-full top-16 flex justify-between text-xs font-bold">
                              <span className="text-green-400">Undervalued</span>
                              <span className="text-yellow-400">Fair</span>
                              <span className="text-red-400">Overvalued</span>
                            </div>
                          </div>
                          <div className="text-xs text-slate-500 text-center">
                            Based on P/E ratio, price/book, free cash flow, and growth rate
                          </div>
                        </div>
                      );
                    })()}
                  </div>

                  {/* Key Metrics */}
                  <div className="glass-card p-6 mb-6 rounded-xl">
                    <h4 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                      <i className="fas fa-traffic-light"></i>
                      Quick Health Check
                    </h4>
                    <div className="space-y-4">
                      {/* P/E Ratio */}
                      {stock.pe && (() => {
                        const color = getTrafficLight('pe', stock.pe);
                        const summary = getPlainEnglishSummary('pe', stock.pe);
                        const dotColor = color === 'green' ? '#22c55e' : color === 'yellow' ? '#eab308' : '#ef4444';
                        return (
                          <div className="p-4 bg-slate-800/50 rounded-lg">
                            <div className="flex justify-between items-center mb-3">
                              <div>
                                <div className="text-xs text-slate-500 mb-1">Price vs Earnings</div>
                                <div className="text-2xl font-bold text-white font-mono">{stock.pe.toFixed(1)}x</div>
                              </div>
                              <div className="flex items-center gap-2 px-3 py-2 rounded-lg" style={{
                                background: color === 'green' ? 'rgba(34,197,94,0.15)' : color === 'yellow' ? 'rgba(234,179,8,0.15)' : 'rgba(239,68,68,0.15)',
                                border: `1px solid ${color === 'green' ? 'rgba(34,197,94,0.3)' : color === 'yellow' ? 'rgba(234,179,8,0.3)' : 'rgba(239,68,68,0.3)'}`,
                                color: dotColor
                              }}>
                                <div className="w-2 h-2 rounded-full" style={{ background: dotColor }}></div>
                                <span className="text-xs font-bold">{color === 'green' ? 'Good' : color === 'yellow' ? 'OK' : 'Concern'}</span>
                              </div>
                            </div>
                            <div className="text-sm font-semibold text-white mb-1">{summary.text}</div>
                            <div className="text-xs text-slate-400 leading-relaxed">{summary.detail}</div>
                          </div>
                        );
                      })()}

                      {/* Revenue Growth */}
                      {stock.revenueGrowth != null && (() => {
                        const color = getTrafficLight('revenueGrowth', stock.revenueGrowth);
                        const summary = getPlainEnglishSummary('revenueGrowth', stock.revenueGrowth);
                        const dotColor = color === 'green' ? '#22c55e' : color === 'yellow' ? '#eab308' : '#ef4444';
                        return (
                          <div className="p-4 bg-slate-800/50 rounded-lg">
                            <div className="flex justify-between items-center mb-3">
                              <div>
                                <div className="text-xs text-slate-500 mb-1">Revenue Growth</div>
                                <div className="text-2xl font-bold text-white font-mono">
                                  {stock.revenueGrowth > 0 ? '+' : ''}{stock.revenueGrowth.toFixed(1)}%
                                </div>
                              </div>
                              <div className="flex items-center gap-2 px-3 py-2 rounded-lg" style={{
                                background: color === 'green' ? 'rgba(34,197,94,0.15)' : color === 'yellow' ? 'rgba(234,179,8,0.15)' : 'rgba(239,68,68,0.15)',
                                border: `1px solid ${color === 'green' ? 'rgba(34,197,94,0.3)' : color === 'yellow' ? 'rgba(234,179,8,0.3)' : 'rgba(239,68,68,0.3)'}`,
                                color: dotColor
                              }}>
                                <div className="w-2 h-2 rounded-full" style={{ background: dotColor }}></div>
                                <span className="text-xs font-bold">{color === 'green' ? 'Good' : color === 'yellow' ? 'OK' : 'Concern'}</span>
                              </div>
                            </div>
                            <div className="text-sm font-semibold text-white mb-1">{summary.text}</div>
                            <div className="text-xs text-slate-400 leading-relaxed">{summary.detail}</div>
                          </div>
                        );
                      })()}

                      {/* Debt Level */}
                      {stock.debtToEquity != null && (() => {
                        const color = getTrafficLight('debtToEquity', stock.debtToEquity);
                        const summary = getPlainEnglishSummary('debtToEquity', stock.debtToEquity);
                        const dotColor = color === 'green' ? '#22c55e' : color === 'yellow' ? '#eab308' : '#ef4444';
                        return (
                          <div className="p-4 bg-slate-800/50 rounded-lg">
                            <div className="flex justify-between items-center mb-3">
                              <div>
                                <div className="text-xs text-slate-500 mb-1">Debt Level</div>
                                <div className="text-2xl font-bold text-white font-mono">{stock.debtToEquity.toFixed(2)}</div>
                              </div>
                              <div className="flex items-center gap-2 px-3 py-2 rounded-lg" style={{
                                background: color === 'green' ? 'rgba(34,197,94,0.15)' : color === 'yellow' ? 'rgba(234,179,8,0.15)' : 'rgba(239,68,68,0.15)',
                                border: `1px solid ${color === 'green' ? 'rgba(34,197,94,0.3)' : color === 'yellow' ? 'rgba(234,179,8,0.3)' : 'rgba(239,68,68,0.3)'}`,
                                color: dotColor
                              }}>
                                <div className="w-2 h-2 rounded-full" style={{ background: dotColor }}></div>
                                <span className="text-xs font-bold">{color === 'green' ? 'Good' : color === 'yellow' ? 'OK' : 'Concern'}</span>
                              </div>
                            </div>
                            <div className="text-sm font-semibold text-white mb-1">{summary.text}</div>
                            <div className="text-xs text-slate-400 leading-relaxed">{summary.detail}</div>
                          </div>
                        );
                      })()}

                      {/* ROE */}
                      {stock.roe != null && (() => {
                        const color = getTrafficLight('roe', stock.roe);
                        const summary = getPlainEnglishSummary('roe', stock.roe);
                        const dotColor = color === 'green' ? '#22c55e' : color === 'yellow' ? '#eab308' : '#ef4444';
                        return (
                          <div className="p-4 bg-slate-800/50 rounded-lg">
                            <div className="flex justify-between items-center mb-3">
                              <div>
                                <div className="text-xs text-slate-500 mb-1">Return on Equity</div>
                                <div className="text-2xl font-bold text-white font-mono">{stock.roe.toFixed(1)}%</div>
                              </div>
                              <div className="flex items-center gap-2 px-3 py-2 rounded-lg" style={{
                                background: color === 'green' ? 'rgba(34,197,94,0.15)' : color === 'yellow' ? 'rgba(234,179,8,0.15)' : 'rgba(239,68,68,0.15)',
                                border: `1px solid ${color === 'green' ? 'rgba(34,197,94,0.3)' : color === 'yellow' ? 'rgba(234,179,8,0.3)' : 'rgba(239,68,68,0.3)'}`,
                                color: dotColor
                              }}>
                                <div className="w-2 h-2 rounded-full" style={{ background: dotColor }}></div>
                                <span className="text-xs font-bold">{color === 'green' ? 'Good' : color === 'yellow' ? 'OK' : 'Concern'}</span>
                              </div>
                            </div>
                            <div className="text-sm font-semibold text-white mb-1">{summary.text}</div>
                            <div className="text-xs text-slate-400 leading-relaxed">{summary.detail}</div>
                          </div>
                        );
                      })()}
                    </div>
                  </div>

                  {/* Disclaimer */}
                  <div className="p-4 bg-yellow-500/5 border border-yellow-500/20 rounded-lg">
                    <div className="flex items-start gap-2 text-sm">
                      <i className="fas fa-info-circle text-yellow-400 mt-0.5"></i>
                      <div className="text-slate-400 leading-relaxed">
                        <strong className="text-yellow-400">Remember:</strong> These simplified metrics are a starting point.
                        Always review the full financials and do your own research before investing.
                      </div>
                    </div>
                  </div>
                </div>
              ) : activeTab === 'fundamentals' ? (
                <ErrorBoundary>
                  {loadingTabData && !fundamentalsData ? (
                    <div className="text-center py-12">
                      <i className="fas fa-spinner animate-spin text-4xl text-cyan-400 mb-4"></i>
                      <p className="text-slate-400">Loading fundamentals data...</p>
                    </div>
                  ) : (
                    <FundamentalsTab stock={{ ...stock, ...fundamentalsData }} />
                  )}
                </ErrorBoundary>
              ) : activeTab === 'technicals' ? (
                <div className="space-y-6">
                  {/* Quick Technical Read */}
                  <div className="p-4 bg-slate-800/40 border border-slate-700/50 rounded-xl text-sm text-slate-200">
                    <span className="font-semibold text-slate-100">Quick read:</span>{" "}
                    {(() => {
                      const rsi = Number.isFinite(stock.rsi) ? stock.rsi : (technicalData?.rsi ?? 50);
                      const sma50 = technicalData?.sma50;
                      const sma200 = technicalData?.sma200;
                      const above50 = sma50 ? (stock.price > sma50) : null;
                      const above200 = sma200 ? (stock.price > sma200) : null;
                      const rsiMsg = rsi > 72 ? "Momentum looks stretched (overbought)." : (rsi < 35 ? "Momentum looks washed out (oversold)." : "Momentum looks neutral.");
                      const trendMsg = (above50 == null || above200 == null) ? "Trend signals are limited." :
                        (above50 && above200 ? "Trend looks constructive (above key averages)." :
                          (!above50 && !above200 ? "Trend looks weak (below key averages)." :
                            "Trend is mixed (one average above, one below)."));
                      return `${trendMsg} ${rsiMsg}`;
                    })()}
                  </div>

                  {/* Technical Summary Cards */}
                  <div className="grid grid-cols-4 gap-4">
                    {/* RSI */}
                    <div className="glass-card p-4 rounded-xl">
                      <div className="text-xs text-slate-500 mb-2">RSI (14)</div>
                      <div className={`text-2xl font-bold ${(technicalData?.rsi || stock.rsi) < 30 ? 'text-green-400' :
                          (technicalData?.rsi || stock.rsi) > 70 ? 'text-red-400' :
                            'text-cyan-400'
                        }`}>
                        {(technicalData?.rsi || stock.rsi)?.toFixed(0) || 'â€”'}
                      </div>
                      <div className="text-xs text-slate-500 mt-1">
                        {(technicalData?.rsi || stock.rsi) < 30 ? 'ğŸŸ¢ Oversold' :
                          (technicalData?.rsi || stock.rsi) > 70 ? 'ğŸ”´ Overbought' :
                            'ğŸŸ¡ Neutral'}
                      </div>
                    </div>

                    {/* ADX (Trend Strength) */}
                    <div className="glass-card p-4 rounded-xl">
                      <div className="text-xs text-slate-500 mb-2">ADX (14)</div>
                      <div className={`text-2xl font-bold ${technicalData?.adx > 25 ? 'text-green-400' :
                          technicalData?.adx > 20 ? 'text-yellow-400' :
                            'text-slate-400'
                        }`}>
                        {technicalData?.adx?.toFixed(0) || 'â€”'}
                      </div>
                      <div className="text-xs text-slate-500 mt-1">
                        {technicalData?.adx > 25 ? 'ğŸ’ª Strong Trend' :
                          technicalData?.adx > 20 ? 'ğŸ“Š Moderate' :
                            'ğŸ˜´ Weak Trend'}
                      </div>
                    </div>

                    {/* Volatility */}
                    <div className="glass-card p-4 rounded-xl">
                      <div className="text-xs text-slate-500 mb-2">Volatility (20d)</div>
                      <div className={`text-2xl font-bold ${technicalData?.stdDev > 5 ? 'text-red-400' :
                          technicalData?.stdDev > 2 ? 'text-yellow-400' :
                            'text-green-400'
                        }`}>
                        {technicalData?.stdDev?.toFixed(2) || 'â€”'}
                      </div>
                      <div className="text-xs text-slate-500 mt-1">
                        {technicalData?.stdDev > 5 ? 'âš ï¸ High' :
                          technicalData?.stdDev > 2 ? 'âš¡ Medium' :
                            'âœ… Low'}
                      </div>
                    </div>

                    {/* Price Change */}
                    <div className="glass-card p-4 rounded-xl">
                      <div className="text-xs text-slate-500 mb-2">Today's Change</div>
                      <div className={`text-2xl font-bold ${getSentimentColor(stock.changePct)}`}>
                        {formatPercent(stock.changePct, 2)}
                      </div>
                      <div className="text-xs text-slate-500 mt-1">
                        ${stock.change?.toFixed(2) || 'â€”'}
                      </div>
                    </div>
                  </div>

                  {/* Moving Averages Analysis */}
                  <div>
                    <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Moving Averages</h4>
                    <div className="glass-card p-5 rounded-xl">
                      <div className="space-y-4">
                        {/* Price vs MAs */}
                        <div className="grid grid-cols-4 gap-4">
                          <div className="text-center">
                            <div className="text-xs text-slate-500 mb-1">Current Price</div>
                            <div className="text-xl font-bold text-white">${stock.price?.toFixed(2)}</div>
                          </div>
                          <div className="text-center">
                            <div className="text-xs text-slate-500 mb-1">EMA (20)</div>
                            <div className={`text-xl font-bold ${technicalData?.ema20 && stock.price > technicalData.ema20 ? 'text-green-400' : 'text-red-400'
                              }`}>
                              ${technicalData?.ema20?.toFixed(2) || 'â€”'}
                            </div>
                            <div className="text-xs mt-1">
                              {technicalData?.ema20 && stock.price > technicalData.ema20 ?
                                <span className="text-green-400">â†‘ Above</span> :
                                <span className="text-red-400">â†“ Below</span>
                              }
                            </div>
                          </div>
                          <div className="text-center">
                            <div className="text-xs text-slate-500 mb-1">SMA (50)</div>
                            <div className={`text-xl font-bold ${technicalData?.sma50 && stock.price > technicalData.sma50 ? 'text-green-400' : 'text-red-400'
                              }`}>
                              ${technicalData?.sma50?.toFixed(2) || 'â€”'}
                            </div>
                            <div className="text-xs mt-1">
                              {technicalData?.sma50 && stock.price > technicalData.sma50 ?
                                <span className="text-green-400">â†‘ Above</span> :
                                <span className="text-red-400">â†“ Below</span>
                              }
                            </div>
                          </div>
                          <div className="text-center">
                            <div className="text-xs text-slate-500 mb-1">SMA (200)</div>
                            <div className={`text-xl font-bold ${technicalData?.sma200 && stock.price > technicalData.sma200 ? 'text-green-400' : 'text-red-400'
                              }`}>
                              ${technicalData?.sma200?.toFixed(2) || 'â€”'}
                            </div>
                            <div className="text-xs mt-1">
                              {technicalData?.sma200 && stock.price > technicalData.sma200 ?
                                <span className="text-green-400">â†‘ Above</span> :
                                <span className="text-red-400">â†“ Below</span>
                              }
                            </div>
                          </div>
                        </div>

                        {/* Golden/Death Cross Indicator */}
                        {technicalData?.sma50 && technicalData?.sma200 && (
                          <div className="pt-4 border-t border-slate-700/30">
                            <div className={`p-3 rounded-lg ${technicalData.sma50 > technicalData.sma200 ?
                                'bg-green-500/10 border border-green-500/30' :
                                'bg-red-500/10 border border-red-500/30'
                              }`}>
                              <div className="flex items-center justify-between">
                                <div>
                                  <div className={`text-sm font-bold ${technicalData.sma50 > technicalData.sma200 ? 'text-green-400' : 'text-red-400'
                                    }`}>
                                    {technicalData.sma50 > technicalData.sma200 ?
                                      'âœ¨ Golden Cross Pattern' :
                                      'ğŸ’€ Death Cross Pattern'
                                    }
                                  </div>
                                  <div className="text-xs text-slate-400 mt-1">
                                    {technicalData.sma50 > technicalData.sma200 ?
                                      'SMA(50) above SMA(200) - Bullish long-term trend' :
                                      'SMA(50) below SMA(200) - Bearish long-term trend'
                                    }
                                  </div>
                                </div>
                                <div className={`text-3xl ${technicalData.sma50 > technicalData.sma200 ? 'text-green-400' : 'text-red-400'
                                  }`}>
                                  {technicalData.sma50 > technicalData.sma200 ? 'ğŸ“ˆ' : 'ğŸ“‰'}
                                </div>
                              </div>
                            </div>
                          </div>
                        )}
                      </div>
                    </div>
                  </div>

                  {/* Price Levels & Support/Resistance */}
                  <div className="grid grid-cols-2 gap-4">
                    {/* 52-Week Range */}
                    <div>
                      <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">52-Week Range</h4>
                      <div className="glass-card p-5 rounded-xl">
                        <div className="space-y-3">
                          <div className="flex justify-between items-center">
                            <span className="text-xs text-slate-400">High</span>
                            <span className="font-mono text-green-400 font-bold text-lg">${stock.yearHigh?.toFixed(2) || 'â€”'}</span>
                          </div>

                          <div className="relative h-3 bg-slate-700 rounded-full overflow-hidden">
                            <div className="absolute h-full w-full bg-gradient-to-r from-red-500/30 via-yellow-500/30 to-green-500/30"></div>
                            {stock.yearLow && stock.yearHigh && stock.price && (
                              <div
                                className="absolute w-1.5 h-full bg-cyan-400 border-2 border-white shadow-lg"
                                style={{
                                  left: `${((stock.price - stock.yearLow) / (stock.yearHigh - stock.yearLow)) * 100}%`
                                }}
                              ></div>
                            )}
                          </div>

                          <div className="flex justify-between items-center">
                            <span className="text-xs text-slate-400">Low</span>
                            <span className="font-mono text-red-400 font-bold text-lg">${stock.yearLow?.toFixed(2) || 'â€”'}</span>
                          </div>

                          <div className="pt-3 border-t border-slate-700/30 text-center">
                            <div className="text-xs text-slate-500 mb-1">Current Position</div>
                            <div className="text-cyan-400 font-bold text-xl">${stock.price?.toFixed(2)}</div>
                            {stock.yearLow && stock.yearHigh && stock.price && (
                              <div className="text-xs text-slate-500 mt-1">
                                {(((stock.price - stock.yearLow) / (stock.yearHigh - stock.yearLow)) * 100).toFixed(0)}% from low to high
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* Today's Range */}
                    <div>
                      <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Today's Range</h4>
                      <div className="glass-card p-5 rounded-xl">
                        <div className="space-y-3">
                          <div className="flex justify-between items-center">
                            <span className="text-xs text-slate-400">Day High</span>
                            <span className="font-mono text-white font-bold text-lg">${stock.dayHigh?.toFixed(2) || stock.price?.toFixed(2) || 'â€”'}</span>
                          </div>

                          <div className="relative h-3 bg-slate-700 rounded-full overflow-hidden">
                            <div className="absolute h-full w-full bg-cyan-500/20"></div>
                            {stock.dayLow && stock.dayHigh && stock.price && (
                              <div
                                className="absolute w-1.5 h-full bg-cyan-400 shadow-lg"
                                style={{
                                  left: `${((stock.price - stock.dayLow) / (stock.dayHigh - stock.dayLow)) * 100}%`
                                }}
                              ></div>
                            )}
                          </div>

                          <div className="flex justify-between items-center">
                            <span className="text-xs text-slate-400">Day Low</span>
                            <span className="font-mono text-white font-bold text-lg">${stock.dayLow?.toFixed(2) || stock.price?.toFixed(2) || 'â€”'}</span>
                          </div>

                          <div className="pt-3 border-t border-slate-700/30">
                            <div className="grid grid-cols-2 gap-3 text-center">
                              <div>
                                <div className="text-xs text-slate-500">Open</div>
                                <div className="text-white font-semibold">${stock.open?.toFixed(2) || 'â€”'}</div>
                              </div>
                              <div>
                                <div className="text-xs text-slate-500">Previous Close</div>
                                <div className="text-white font-semibold">${stock.previousClose?.toFixed(2) || 'â€”'}</div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Momentum & Volume */}
                  <div className="grid grid-cols-2 gap-4">
                    {/* Momentum Indicators */}
                    <div>
                      <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Momentum Analysis</h4>
                      <div className="glass-card p-4 rounded-xl space-y-3">
                        {/* RSI with visual bar */}
                        <div>
                          <div className="flex justify-between items-center mb-2">
                            <span className="text-xs text-slate-400">RSI (14)</span>
                            <span className={`font-mono text-sm font-bold ${(technicalData?.rsi || stock.rsi) < 30 ? 'text-green-400' :
                                (technicalData?.rsi || stock.rsi) > 70 ? 'text-red-400' :
                                  'text-cyan-400'
                              }`}>
                              {(technicalData?.rsi || stock.rsi)?.toFixed(0) || 'â€”'}
                            </span>
                          </div>
                          <div className="relative h-2 bg-slate-700 rounded-full overflow-hidden">
                            <div className="absolute h-full w-[30%] bg-green-500/20"></div>
                            <div className="absolute h-full w-[40%] left-[30%] bg-slate-600/30"></div>
                            <div className="absolute h-full w-[30%] left-[70%] bg-red-500/20"></div>
                            {(technicalData?.rsi || stock.rsi) && (
                              <div
                                className="absolute w-1 h-full bg-white shadow-lg"
                                style={{ left: `${(technicalData?.rsi || stock.rsi)}%` }}
                              ></div>
                            )}
                          </div>
                          <div className="flex justify-between text-[10px] text-slate-500 mt-1">
                            <span>Oversold</span>
                            <span>Neutral</span>
                            <span>Overbought</span>
                          </div>
                        </div>

                        {/* ADX Trend Strength */}
                        {technicalData?.adx && (
                          <div className="pt-3 border-t border-slate-700/30">
                            <div className="flex justify-between items-center">
                              <span className="text-xs text-slate-400">ADX Trend Strength</span>
                              <span className={`font-mono text-sm font-bold ${technicalData.adx > 25 ? 'text-green-400' :
                                  technicalData.adx > 20 ? 'text-yellow-400' :
                                    'text-slate-400'
                                }`}>
                                {technicalData.adx.toFixed(0)}
                              </span>
                            </div>
                            <div className="mt-2 h-2 bg-slate-700 rounded-full overflow-hidden">
                              <div
                                className={`h-full rounded-full ${technicalData.adx > 25 ? 'bg-green-500' :
                                    technicalData.adx > 20 ? 'bg-yellow-500' :
                                      'bg-slate-500'
                                  }`}
                                style={{ width: `${Math.min(100, (technicalData.adx / 50) * 100)}%` }}
                              ></div>
                            </div>
                            <div className="text-xs text-slate-500 mt-1">
                              {technicalData.adx > 25 ? 'Strong directional movement' :
                                technicalData.adx > 20 ? 'Moderate trend forming' :
                                  'Weak trend, ranging market'}
                            </div>
                          </div>
                        )}

                        {/* Price Momentum */}
                        <div className="pt-3 border-t border-slate-700/30">
                          <div className="flex justify-between items-center">
                            <span className="text-xs text-slate-400">Price Momentum</span>
                            <span className={`font-mono text-sm font-bold ${getSentimentColor(stock.changePct)}`}>
                              {formatPercent(stock.changePct, 2)}
                            </span>
                          </div>
                        </div>

                        {/* Volatility */}
                        {technicalData?.stdDev && (
                          <div className="pt-3 border-t border-slate-700/30">
                            <div className="flex justify-between items-center">
                              <span className="text-xs text-slate-400">Volatility (Ïƒ)</span>
                              <span className={`text-sm font-bold ${technicalData.stdDev > 5 ? 'text-red-400' :
                                  technicalData.stdDev > 2 ? 'text-yellow-400' :
                                    'text-green-400'
                                }`}>
                                {technicalData.stdDev.toFixed(2)}
                              </span>
                            </div>
                          </div>
                        )}
                      </div>
                    </div>

                    {/* Volume Analysis */}
                    <div>
                      <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Volume</h4>
                      <div className="glass-card p-5 rounded-xl">
                        <div className="text-center">
                          <div className="text-xs text-slate-500 mb-2">Average Volume Traded</div>
                          <div className="text-3xl font-bold text-white font-mono">
                            {formatNumber(stock.avgVolume || 0, 0)}
                          </div>
                          <div className="text-xs text-slate-400 mt-2">shares per day</div>
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Ratings & Consensus (if available) */}



                </div>
              ) : activeTab === 'analyst-ratings' && analystRatingsData ? (
                <div className="space-y-6">
                  <h3 className="text-xl font-bold text-white">Comprehensive Analyst Ratings</h3>

                  {/* Overall Rating from Ratings Snapshot */}
                  {analystRatingsData.snapshot && (
                    <div>
                      <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">FMP Overall Rating</h4>
                      <div className="glass-card p-6 rounded-xl">
                        {/* Main Rating & Overall Score */}
                        <div className="grid grid-cols-3 gap-6 mb-6 pb-6 border-b border-slate-700/30">
                          <div className="text-center">
                            <div className="text-xs text-slate-500 mb-2">Rating</div>
                            <div className={`text-6xl font-bold mb-2 ${analystRatingsData.snapshot.rating?.startsWith('A') ? 'text-green-400' :
                                analystRatingsData.snapshot.rating?.startsWith('B') ? 'text-blue-400' :
                                  analystRatingsData.snapshot.rating?.startsWith('C') ? 'text-yellow-400' :
                                    analystRatingsData.snapshot.rating?.startsWith('D') ? 'text-orange-400' :
                                      'text-red-400'
                              }`}>
                              {analystRatingsData.snapshot.rating || 'N/A'}
                            </div>
                            <div className="text-sm text-slate-400">
                              {analystRatingsData.snapshot.ratingRecommendation || 'N/A'}
                            </div>
                          </div>
                          <div className="text-center">
                            <div className="text-xs text-slate-500 mb-2">Overall Score</div>
                            <div className="text-5xl font-bold text-cyan-400">
                              {analystRatingsData.snapshot.ratingScore?.toFixed(1) || analystRatingsData.snapshot.overallScore || 'â€”'}
                            </div>
                            <div className="text-xs text-slate-400 mt-1">out of 5.0</div>
                          </div>
                          <div className="text-center">
                            <div className="text-xs text-slate-500 mb-2">Price Target (Last Quarter)</div>
                            <div className="text-3xl font-bold text-purple-400">
                              ${(analystRatingsData.priceTargetSummary?.lastQuarterAvgPriceTarget ||
                                analystRatingsData.priceTargetConsensus?.targetConsensus ||
                                analystRatingsData.priceTarget?.lastQuarterAvgPriceTarget)?.toFixed(2) || 'â€”'}
                            </div>
                            <div className="text-xs text-slate-400 mt-1">
                              {(analystRatingsData.priceTargetSummary?.lastQuarterCount ||
                                analystRatingsData.priceTarget?.lastQuarterCount) ?
                                `${analystRatingsData.priceTargetSummary?.lastQuarterCount || analystRatingsData.priceTarget?.lastQuarterCount} analysts` :
                                'Consensus'}
                            </div>
                            {stock.price && (analystRatingsData.priceTargetSummary?.lastQuarterAvgPriceTarget || analystRatingsData.priceTarget?.lastQuarterAvgPriceTarget) && (
                              <div className={`text-sm font-bold mt-1 ${((analystRatingsData.priceTargetSummary?.lastQuarterAvgPriceTarget || analystRatingsData.priceTarget?.lastQuarterAvgPriceTarget) / stock.price - 1) * 100 > 0
                                  ? 'text-green-400' : 'text-red-400'
                                }`}>
                                {(((analystRatingsData.priceTargetSummary?.lastQuarterAvgPriceTarget || analystRatingsData.priceTarget?.lastQuarterAvgPriceTarget) / stock.price - 1) * 100).toFixed(1)}% upside
                              </div>
                            )}
                          </div>
                        </div>

                        {/* Enhanced Price Target Timeline */}
                        {(analystRatingsData.priceTargetSummary || analystRatingsData.priceTarget) && (
                          <div className="mt-6 pt-6 border-t border-slate-700/30">
                            <h5 className="text-xs font-bold text-slate-400 mb-3 uppercase tracking-wide">Price Target Timeline</h5>
                            <div className="grid grid-cols-4 gap-4">
                              {(analystRatingsData.priceTargetSummary?.lastMonthAvgPriceTarget || analystRatingsData.priceTarget?.lastMonthAvgPriceTarget) && (
                                <div className="glass-card p-4 rounded-lg text-center">
                                  <div className="text-xs text-slate-500 mb-2">Last Month</div>
                                  <div className="text-2xl font-bold text-green-400">
                                    ${(analystRatingsData.priceTargetSummary?.lastMonthAvgPriceTarget || analystRatingsData.priceTarget?.lastMonthAvgPriceTarget).toFixed(2)}
                                  </div>
                                  <div className="text-xs text-slate-400 mt-1">
                                    {analystRatingsData.priceTargetSummary?.lastMonthCount || analystRatingsData.priceTarget?.lastMonthCount || 0} analysts
                                  </div>
                                </div>
                              )}
                              {(analystRatingsData.priceTargetSummary?.lastQuarterAvgPriceTarget || analystRatingsData.priceTarget?.lastQuarterAvgPriceTarget) && (
                                <div className="glass-card p-4 rounded-lg text-center">
                                  <div className="text-xs text-slate-500 mb-2">Last Quarter</div>
                                  <div className="text-2xl font-bold text-cyan-400">
                                    ${(analystRatingsData.priceTargetSummary?.lastQuarterAvgPriceTarget || analystRatingsData.priceTarget?.lastQuarterAvgPriceTarget).toFixed(2)}
                                  </div>
                                  <div className="text-xs text-slate-400 mt-1">
                                    {analystRatingsData.priceTargetSummary?.lastQuarterCount || analystRatingsData.priceTarget?.lastQuarterCount || 0} analysts
                                  </div>
                                </div>
                              )}
                              {(analystRatingsData.priceTargetSummary?.lastYearAvgPriceTarget || analystRatingsData.priceTarget?.lastYearAvgPriceTarget) && (
                                <div className="glass-card p-4 rounded-lg text-center">
                                  <div className="text-xs text-slate-500 mb-2">Last Year</div>
                                  <div className="text-2xl font-bold text-blue-400">
                                    ${(analystRatingsData.priceTargetSummary?.lastYearAvgPriceTarget || analystRatingsData.priceTarget?.lastYearAvgPriceTarget).toFixed(2)}
                                  </div>
                                  <div className="text-xs text-slate-400 mt-1">
                                    {analystRatingsData.priceTargetSummary?.lastYearCount || analystRatingsData.priceTarget?.lastYearCount || 0} analysts
                                  </div>
                                </div>
                              )}
                              {(analystRatingsData.priceTargetSummary?.allTimeAvgPriceTarget || analystRatingsData.priceTarget?.allTimeAvgPriceTarget) && (
                                <div className="glass-card p-4 rounded-lg text-center">
                                  <div className="text-xs text-slate-500 mb-2">All Time</div>
                                  <div className="text-2xl font-bold text-purple-400">
                                    ${(analystRatingsData.priceTargetSummary?.allTimeAvgPriceTarget || analystRatingsData.priceTarget?.allTimeAvgPriceTarget).toFixed(2)}
                                  </div>
                                  <div className="text-xs text-slate-400 mt-1">
                                    {analystRatingsData.priceTargetSummary?.allTimeCount || analystRatingsData.priceTarget?.allTimeCount || 0} analysts
                                  </div>
                                </div>
                              )}
                            </div>

                            {/* Price Target Trend */}
                            {(analystRatingsData.priceTargetSummary?.lastMonthAvgPriceTarget &&
                              analystRatingsData.priceTargetSummary?.lastQuarterAvgPriceTarget &&
                              analystRatingsData.priceTargetSummary?.lastYearAvgPriceTarget) && (
                                <div className="mt-4 text-center text-sm">
                                  <span className="text-slate-400">Trend: </span>
                                  {analystRatingsData.priceTargetSummary.lastMonthAvgPriceTarget > analystRatingsData.priceTargetSummary.lastQuarterAvgPriceTarget ? (
                                    <span className="text-green-400 font-bold">ğŸ“ˆ Increasing (Recent upgrades)</span>
                                  ) : analystRatingsData.priceTargetSummary.lastMonthAvgPriceTarget < analystRatingsData.priceTargetSummary.lastQuarterAvgPriceTarget ? (
                                    <span className="text-red-400 font-bold">ğŸ“‰ Decreasing (Recent downgrades)</span>
                                  ) : (
                                    <span className="text-yellow-400 font-bold">â¡ï¸ Stable</span>
                                  )}
                                </div>
                              )}
                          </div>
                        )}

                        {/* Consensus Data */}
                        {(analystRatingsData.priceTargetConsensus) && (
                          <div className="mt-6 pt-6 border-t border-slate-700/30">
                            <h5 className="text-xs font-bold text-slate-400 mb-3 uppercase tracking-wide">Consensus Range</h5>
                            <div className="grid grid-cols-3 gap-4 text-center">
                              {analystRatingsData.priceTargetConsensus.targetLow && (
                                <div className="glass-card p-3 rounded-lg">
                                  <div className="text-xs text-slate-500 mb-1">Low</div>
                                  <div className="text-xl font-bold text-red-400">
                                    ${analystRatingsData.priceTargetConsensus.targetLow.toFixed(2)}
                                  </div>
                                </div>
                              )}
                              {analystRatingsData.priceTargetConsensus.targetMedian && (
                                <div className="glass-card p-3 rounded-lg">
                                  <div className="text-xs text-slate-500 mb-1">Median</div>
                                  <div className="text-xl font-bold text-cyan-400">
                                    ${analystRatingsData.priceTargetConsensus.targetMedian.toFixed(2)}
                                  </div>
                                </div>
                              )}
                              {analystRatingsData.priceTargetConsensus.targetHigh && (
                                <div className="glass-card p-3 rounded-lg">
                                  <div className="text-xs text-slate-500 mb-1">High</div>
                                  <div className="text-xl font-bold text-green-400">
                                    ${analystRatingsData.priceTargetConsensus.targetHigh.toFixed(2)}
                                  </div>
                                </div>
                              )}
                            </div>
                          </div>
                        )}
                      </div>
                    </div>
                  )}

                  {/* Price Target Details - Standalone Section */}
                  {(analystRatingsData.priceTargetSummary || analystRatingsData.priceTargetConsensus) && (
                    <div>
                      <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Analyst Price Targets</h4>
                      <div className="glass-card p-6 rounded-xl">
                        {/* Price Target Timeline */}
                        {analystRatingsData.priceTargetSummary && (
                          <div>
                            <h5 className="text-xs font-bold text-slate-400 mb-3 uppercase tracking-wide">Price Target Timeline</h5>
                            <div className="grid grid-cols-4 gap-4">
                              {analystRatingsData.priceTargetSummary.lastMonthAvgPriceTarget && (
                                <div className="glass-card p-4 rounded-lg text-center">
                                  <div className="text-xs text-slate-500 mb-2">Last Month</div>
                                  <div className="text-2xl font-bold text-green-400">
                                    ${analystRatingsData.priceTargetSummary.lastMonthAvgPriceTarget.toFixed(2)}
                                  </div>
                                  <div className="text-xs text-slate-400 mt-1">
                                    {analystRatingsData.priceTargetSummary.lastMonthCount || 0} analysts
                                  </div>
                                  {stock.price && (
                                    <div className={`text-xs font-bold mt-1 ${(analystRatingsData.priceTargetSummary.lastMonthAvgPriceTarget / stock.price - 1) * 100 > 0
                                        ? 'text-green-400' : 'text-red-400'
                                      }`}>
                                      {((analystRatingsData.priceTargetSummary.lastMonthAvgPriceTarget / stock.price - 1) * 100).toFixed(1)}%
                                    </div>
                                  )}
                                </div>
                              )}
                              {analystRatingsData.priceTargetSummary.lastQuarterAvgPriceTarget && (
                                <div className="glass-card p-4 rounded-lg text-center">
                                  <div className="text-xs text-slate-500 mb-2">Last Quarter</div>
                                  <div className="text-2xl font-bold text-cyan-400">
                                    ${analystRatingsData.priceTargetSummary.lastQuarterAvgPriceTarget.toFixed(2)}
                                  </div>
                                  <div className="text-xs text-slate-400 mt-1">
                                    {analystRatingsData.priceTargetSummary.lastQuarterCount || 0} analysts
                                  </div>
                                  {stock.price && (
                                    <div className={`text-xs font-bold mt-1 ${(analystRatingsData.priceTargetSummary.lastQuarterAvgPriceTarget / stock.price - 1) * 100 > 0
                                        ? 'text-green-400' : 'text-red-400'
                                      }`}>
                                      {((analystRatingsData.priceTargetSummary.lastQuarterAvgPriceTarget / stock.price - 1) * 100).toFixed(1)}%
                                    </div>
                                  )}
                                </div>
                              )}
                              {analystRatingsData.priceTargetSummary.lastYearAvgPriceTarget && (
                                <div className="glass-card p-4 rounded-lg text-center">
                                  <div className="text-xs text-slate-500 mb-2">Last Year</div>
                                  <div className="text-2xl font-bold text-blue-400">
                                    ${analystRatingsData.priceTargetSummary.lastYearAvgPriceTarget.toFixed(2)}
                                  </div>
                                  <div className="text-xs text-slate-400 mt-1">
                                    {analystRatingsData.priceTargetSummary.lastYearCount || 0} analysts
                                  </div>
                                  {stock.price && (
                                    <div className={`text-xs font-bold mt-1 ${(analystRatingsData.priceTargetSummary.lastYearAvgPriceTarget / stock.price - 1) * 100 > 0
                                        ? 'text-green-400' : 'text-red-400'
                                      }`}>
                                      {((analystRatingsData.priceTargetSummary.lastYearAvgPriceTarget / stock.price - 1) * 100).toFixed(1)}%
                                    </div>
                                  )}
                                </div>
                              )}
                              {analystRatingsData.priceTargetSummary.allTimeAvgPriceTarget && (
                                <div className="glass-card p-4 rounded-lg text-center">
                                  <div className="text-xs text-slate-500 mb-2">All Time</div>
                                  <div className="text-2xl font-bold text-purple-400">
                                    ${analystRatingsData.priceTargetSummary.allTimeAvgPriceTarget.toFixed(2)}
                                  </div>
                                  <div className="text-xs text-slate-400 mt-1">
                                    {analystRatingsData.priceTargetSummary.allTimeCount || 0} analysts
                                  </div>
                                  {stock.price && (
                                    <div className={`text-xs font-bold mt-1 ${(analystRatingsData.priceTargetSummary.allTimeAvgPriceTarget / stock.price - 1) * 100 > 0
                                        ? 'text-green-400' : 'text-red-400'
                                      }`}>
                                      {((analystRatingsData.priceTargetSummary.allTimeAvgPriceTarget / stock.price - 1) * 100).toFixed(1)}%
                                    </div>
                                  )}
                                </div>
                              )}
                            </div>

                            {/* Price Target Trend */}
                            {(analystRatingsData.priceTargetSummary.lastMonthAvgPriceTarget &&
                              analystRatingsData.priceTargetSummary.lastQuarterAvgPriceTarget &&
                              analystRatingsData.priceTargetSummary.lastYearAvgPriceTarget) && (
                                <div className="mt-4 text-center text-sm">
                                  <span className="text-slate-400">Trend: </span>
                                  {analystRatingsData.priceTargetSummary.lastMonthAvgPriceTarget > analystRatingsData.priceTargetSummary.lastQuarterAvgPriceTarget ? (
                                    <span className="text-green-400 font-bold">ğŸ“ˆ Increasing (Recent upgrades)</span>
                                  ) : analystRatingsData.priceTargetSummary.lastMonthAvgPriceTarget < analystRatingsData.priceTargetSummary.lastQuarterAvgPriceTarget ? (
                                    <span className="text-red-400 font-bold">ğŸ“‰ Decreasing (Recent downgrades)</span>
                                  ) : (
                                    <span className="text-yellow-400 font-bold">â¡ï¸ Stable</span>
                                  )}
                                </div>
                              )}
                          </div>
                        )}

                        {/* Consensus Range */}
                        {analystRatingsData.priceTargetConsensus && (
                          <div className={analystRatingsData.priceTargetSummary ? "mt-6 pt-6 border-t border-slate-700/30" : ""}>
                            <h5 className="text-xs font-bold text-slate-400 mb-3 uppercase tracking-wide">Consensus Range</h5>
                            <div className="grid grid-cols-3 gap-4 text-center">
                              {analystRatingsData.priceTargetConsensus.targetLow && (
                                <div className="glass-card p-3 rounded-lg">
                                  <div className="text-xs text-slate-500 mb-1">Low</div>
                                  <div className="text-xl font-bold text-red-400">
                                    ${analystRatingsData.priceTargetConsensus.targetLow.toFixed(2)}
                                  </div>
                                </div>
                              )}
                              {analystRatingsData.priceTargetConsensus.targetMedian && (
                                <div className="glass-card p-3 rounded-lg">
                                  <div className="text-xs text-slate-500 mb-1">Median</div>
                                  <div className="text-xl font-bold text-cyan-400">
                                    ${analystRatingsData.priceTargetConsensus.targetMedian.toFixed(2)}
                                  </div>
                                </div>
                              )}
                              {analystRatingsData.priceTargetConsensus.targetHigh && (
                                <div className="glass-card p-3 rounded-lg">
                                  <div className="text-xs text-slate-500 mb-1">High</div>
                                  <div className="text-xl font-bold text-green-400">
                                    ${analystRatingsData.priceTargetConsensus.targetHigh.toFixed(2)}
                                  </div>
                                </div>
                              )}
                            </div>
                          </div>
                        )}
                      </div>
                    </div>
                  )}

                  {/* Component Scores (Only if snapshot exists) */}
                  {analystRatingsData.snapshot && (
                    <div>
                      <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Component Scores</h4>
                      <div className="glass-card p-6 rounded-xl">
                        <div className="grid grid-cols-6 gap-4">
                          <div className="text-center glass-card p-3 rounded-lg">
                            <div className="text-xs text-slate-500 mb-1">DCF</div>
                            <div className="text-2xl font-bold text-cyan-400">
                              {analystRatingsData.snapshot.discountedCashFlowScore || 'â€”'}
                            </div>
                          </div>
                          <div className="text-center glass-card p-3 rounded-lg">
                            <div className="text-xs text-slate-500 mb-1">ROE</div>
                            <div className="text-2xl font-bold text-green-400">
                              {analystRatingsData.snapshot.returnOnEquityScore || 'â€”'}
                            </div>
                          </div>
                          <div className="text-center glass-card p-3 rounded-lg">
                            <div className="text-xs text-slate-500 mb-1">ROA</div>
                            <div className="text-2xl font-bold text-blue-400">
                              {analystRatingsData.snapshot.returnOnAssetsScore || 'â€”'}
                            </div>
                          </div>
                          <div className="text-center glass-card p-3 rounded-lg">
                            <div className="text-xs text-slate-500 mb-1">D/E</div>
                            <div className="text-2xl font-bold text-purple-400">
                              {analystRatingsData.snapshot.debtToEquityScore || 'â€”'}
                            </div>
                          </div>
                          <div className="text-center glass-card p-3 rounded-lg">
                            <div className="text-xs text-slate-500 mb-1">P/E</div>
                            <div className="text-2xl font-bold text-yellow-400">
                              {analystRatingsData.snapshot.priceToEarningsScore || 'â€”'}
                            </div>
                          </div>
                          <div className="text-center glass-card p-3 rounded-lg">
                            <div className="text-xs text-slate-500 mb-1">P/B</div>
                            <div className="text-2xl font-bold text-orange-400">
                              {analystRatingsData.snapshot.priceToBookScore || 'â€”'}
                            </div>
                          </div>
                        </div>

                        {/* Score Legend */}
                        <div className="mt-4 pt-4 border-t border-slate-700/30 text-center text-xs text-slate-500">
                          Component Scores: DCF (Discounted Cash Flow) â€¢ ROE (Return on Equity) â€¢ ROA (Return on Assets) â€¢ D/E (Debt to Equity) â€¢ P/E (Price to Earnings) â€¢ P/B (Price to Book)
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Analyst Consensus from Grades Summary */}
                  {analystRatingsData.consensus && (
                    <div>
                      <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Analyst Consensus</h4>
                      <div className="glass-card p-6 rounded-xl">
                        <div className="grid grid-cols-2 gap-6">
                          {/* Consensus Breakdown */}
                          <div>
                            <div className="text-center mb-4">
                              <div className="text-xs text-slate-500 mb-2">Consensus</div>
                              <div className={`text-4xl font-bold ${analystRatingsData.consensus.consensus === 'Strong Buy' || analystRatingsData.consensus.consensus === 'Buy' ? 'text-green-400' :
                                  analystRatingsData.consensus.consensus === 'Hold' ? 'text-yellow-400' :
                                    'text-red-400'
                                }`}>
                                {analystRatingsData.consensus.consensus || 'N/A'}
                              </div>
                            </div>

                            <div className="grid grid-cols-3 gap-3 text-center text-xs">
                              <div className="glass-card p-3 rounded-lg">
                                <div className="text-green-400 font-bold text-2xl">
                                  {(analystRatingsData.consensus.strongBuy || 0) + (analystRatingsData.consensus.buy || 0)}
                                </div>
                                <div className="text-slate-500 mt-1">Buy</div>
                              </div>
                              <div className="glass-card p-3 rounded-lg">
                                <div className="text-yellow-400 font-bold text-2xl">
                                  {analystRatingsData.consensus.hold || 0}
                                </div>
                                <div className="text-slate-500 mt-1">Hold</div>
                              </div>
                              <div className="glass-card p-3 rounded-lg">
                                <div className="text-red-400 font-bold text-2xl">
                                  {(analystRatingsData.consensus.sell || 0) + (analystRatingsData.consensus.strongSell || 0)}
                                </div>
                                <div className="text-slate-500 mt-1">Sell</div>
                              </div>
                            </div>
                          </div>

                          {/* Detailed Breakdown */}
                          <div className="space-y-3">
                            <div className="flex justify-between items-center">
                              <span className="text-sm text-slate-400">Strong Buy</span>
                              <span className="text-green-400 font-bold">{analystRatingsData.consensus.strongBuy || 0}</span>
                            </div>
                            <div className="flex justify-between items-center">
                              <span className="text-sm text-slate-400">Buy</span>
                              <span className="text-green-300 font-bold">{analystRatingsData.consensus.buy || 0}</span>
                            </div>
                            <div className="flex justify-between items-center">
                              <span className="text-sm text-slate-400">Hold</span>
                              <span className="text-yellow-400 font-bold">{analystRatingsData.consensus.hold || 0}</span>
                            </div>
                            <div className="flex justify-between items-center">
                              <span className="text-sm text-slate-400">Sell</span>
                              <span className="text-red-300 font-bold">{analystRatingsData.consensus.sell || 0}</span>
                            </div>
                            <div className="flex justify-between items-center">
                              <span className="text-sm text-slate-400">Strong Sell</span>
                              <span className="text-red-400 font-bold">{analystRatingsData.consensus.strongSell || 0}</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Price Target Details */}
                  {analystRatingsData.priceTarget && (
                    <div>
                      <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Price Target Details</h4>
                      <div className="glass-card p-6 rounded-xl">
                        <div className="grid grid-cols-3 gap-6">
                          <div className="text-center">
                            <div className="text-xs text-slate-500 mb-2">Last Month Average</div>
                            <div className="text-2xl font-bold text-blue-400">
                              ${analystRatingsData.priceTarget.lastMonthAvgPriceTarget?.toFixed(2) || 'â€”'}
                            </div>
                            <div className="text-xs text-slate-400 mt-1">
                              {analystRatingsData.priceTarget.lastMonthCount || 0} analysts
                            </div>
                          </div>
                          <div className="text-center">
                            <div className="text-xs text-slate-500 mb-2">Last Quarter Average</div>
                            <div className="text-2xl font-bold text-cyan-400">
                              ${analystRatingsData.priceTarget.lastQuarterAvgPriceTarget?.toFixed(2) || 'â€”'}
                            </div>
                            <div className="text-xs text-slate-400 mt-1">
                              {analystRatingsData.priceTarget.lastQuarterCount || 0} analysts
                            </div>
                          </div>
                          <div className="text-center">
                            <div className="text-xs text-slate-500 mb-2">Last Year Average</div>
                            <div className="text-2xl font-bold text-purple-400">
                              ${analystRatingsData.priceTarget.lastYearAvgPriceTarget?.toFixed(2) || 'â€”'}
                            </div>
                            <div className="text-xs text-slate-400 mt-1">
                              {analystRatingsData.priceTarget.lastYearCount || 0} analysts
                            </div>
                          </div>
                        </div>

                        {/* Upside Calculation */}
                        <div className="mt-6 pt-6 border-t border-slate-700/30">
                          <div className="text-center">
                            <div className="text-sm text-slate-400 mb-2">
                              Current Price: <span className="text-white font-semibold">${stock.price?.toFixed(2)}</span>
                            </div>
                            <div className="text-xs text-slate-500">
                              Potential Upside:
                              <span className={`ml-2 text-lg font-bold ${stock.upside > 0 ? 'text-green-400' : 'text-red-400'
                                }`}>
                                {stock.upside?.toFixed(1) || ((analystRatingsData.priceTarget.lastQuarterAvgPriceTarget - stock.price) / stock.price * 100).toFixed(1)}%
                              </span>
                              {stock.upside > 0 ? ' ğŸ“ˆ' : ' ğŸ“‰'}
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* Recent Analyst Grade Changes */}
                  {analystRatingsData.recentGrades && analystRatingsData.recentGrades.length > 0 && (
                    <div>
                      <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Recent Analyst Activity</h4>
                      <div className="space-y-2">
                        {analystRatingsData.recentGrades.slice(0, 10).map((grade, i) => (
                          <div key={i} className="glass-card p-4 rounded-xl">
                            <div className="flex items-start justify-between">
                              <div className="flex-1">
                                <div className="flex items-center gap-3 mb-2">
                                  <span className="font-semibold text-white">
                                    {grade.gradingCompany || grade.firm || grade.analystFirm || grade.analystName || grade.company || 'Unknown Analyst'}
                                  </span>
                                  <span className={`chip text-xs px-3 py-1 rounded-full ${grade.newGrade?.toLowerCase().includes('buy') || grade.newGrade?.toLowerCase().includes('outperform') ||
                                      grade.newGrade?.toLowerCase().includes('overweight') ?
                                      'bg-green-500/20 text-green-400 border border-green-500/30' :
                                      grade.newGrade?.toLowerCase().includes('sell') || grade.newGrade?.toLowerCase().includes('underperform') ||
                                        grade.newGrade?.toLowerCase().includes('underweight') ?
                                        'bg-red-500/20 text-red-400 border border-red-500/30' :
                                        'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30'
                                    }`}>
                                    {grade.newGrade || grade.grade || 'N/A'}
                                  </span>
                                  {grade.previousGrade && grade.previousGrade !== grade.newGrade && (
                                    <span className="text-xs text-slate-500">
                                      from {grade.previousGrade}
                                    </span>
                                  )}
                                </div>
                                <div className="text-sm text-slate-400">
                                  {grade.action === 'up' || grade.action === 'upgrade' ? 'ğŸ“ˆ Upgrade' :
                                    grade.action === 'down' || grade.action === 'downgrade' ? 'ğŸ“‰ Downgrade' :
                                      grade.action === 'init' || grade.action === 'initiated' ? 'ğŸ†• Initiated' :
                                        grade.action === 'main' || grade.action === 'maintained' ? 'ğŸ”„ Maintained' :
                                          'ğŸ”„ ' + (grade.action || 'Update')}
                                </div>
                              </div>
                              <div className="text-xs text-slate-500 text-right">
                                {grade.date || grade.publishedDate ? new Date(grade.date || grade.publishedDate).toLocaleDateString() : 'N/A'}
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* If no data at all */}
                  {!analystRatingsData.snapshot && !analystRatingsData.consensus &&
                    !analystRatingsData.priceTarget && (!analystRatingsData.recentGrades || analystRatingsData.recentGrades.length === 0) && (
                      <div className="glass-card p-8 rounded-xl text-center">
                        <div className="text-slate-400 text-lg mb-2">ğŸ“Š No Analyst Data Available</div>
                        <div className="text-slate-500 text-sm">
                          Analyst ratings data is not available for this stock.
                        </div>
                      </div>
                    )}
                </div>
              ) : activeTab === 'insider' && insiderData !== null && insiderData !== undefined ? (
                <div className="space-y-4">
                  <h3 className="text-lg font-bold text-white">Insider Trading Activity</h3>
                  {insiderData === 'PREMIUM_REQUIRED' ? (
                    <div className="glass-card p-8 rounded-xl text-center">
                      <div className="text-6xl mb-4">ğŸ”’</div>
                      <div className="text-xl font-bold text-white mb-2">Premium Feature</div>
                      <div className="text-slate-400 mb-4">
                        Insider trading data requires a paid Financial Modeling Prep subscription.
                      </div>
                      <div className="text-sm text-slate-500">
                        Available endpoints: Stock quotes, fundamentals, technical indicators
                      </div>
                    </div>
                  ) : insiderData?.type === 'combined' ? (
                    <div className="space-y-4">
                      {/* Statistics Summary */}
                      {insiderData.statistics && (
                        <div className="glass-card p-6 rounded-xl">
                          <h4 className="text-sm font-bold text-slate-400 mb-4">Last 4 Quarters Summary</h4>
                          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div className="text-center">
                              <div className="text-xs text-slate-500 mb-2">Total Trades</div>
                              <div className="text-3xl font-bold text-cyan-400">
                                {insiderData.statistics.totalTransactions || 0}
                              </div>
                            </div>
                            <div className="text-center">
                              <div className="text-xs text-slate-500 mb-2">Shares Purchased</div>
                              <div className="text-3xl font-bold text-green-400">
                                {formatNumber(insiderData.statistics.totalBought || 0, 0)}
                              </div>
                            </div>
                            <div className="text-center">
                              <div className="text-xs text-slate-500 mb-2">Shares Sold</div>
                              <div className="text-3xl font-bold text-red-400">
                                {formatNumber(insiderData.statistics.totalSold || 0, 0)}
                              </div>
                            </div>
                            <div className="text-center">
                              <div className="text-xs text-slate-500 mb-2">Net Position</div>
                              <div className={`text-3xl font-bold ${(insiderData.statistics.totalBought - insiderData.statistics.totalSold) > 0 ? 'text-green-400' : 'text-red-400'
                                }`}>
                                {insiderData.statistics.totalBought - insiderData.statistics.totalSold > 0 ? '+' : ''}
                                {formatNumber((insiderData.statistics.totalBought - insiderData.statistics.totalSold) || 0, 0)}
                              </div>
                            </div>
                          </div>

                          <div className="mt-4 pt-4 border-t border-slate-700">
                            <div className="flex justify-between items-center">
                              <span className="text-sm text-slate-400">Buy/Sell Ratio</span>
                              <span className="text-white font-bold">
                                {insiderData.statistics.totalSold > 0
                                  ? (insiderData.statistics.totalBought / insiderData.statistics.totalSold).toFixed(2)
                                  : 'N/A'}
                              </span>
                            </div>
                          </div>
                        </div>
                      )}

                      {/* Latest Individual Transactions */}
                      {insiderData.latestTrades && insiderData.latestTrades.length > 0 && (
                        <>
                          <div className="flex items-center justify-between">
                            <h4 className="text-sm font-bold text-slate-400">Latest Transactions</h4>
                            <span className="text-xs text-slate-500">
                              Showing {insiderData.latestTrades.length} recent {insiderData.latestTrades.length === 1 ? 'trade' : 'trades'}
                            </span>
                          </div>

                          <div className="space-y-2 max-h-[500px] overflow-y-auto">
                            {insiderData.latestTrades.map((trade, i) => (
                              <div key={i} className="glass-card p-4 rounded-xl hover:bg-slate-800/50 transition-all">
                                <div className="flex items-start justify-between">
                                  <div className="flex-1">
                                    <div className="flex items-center gap-2 mb-1">
                                      <span className="font-semibold text-white">{trade.reportingName || 'Unknown'}</span>
                                      <span className={`chip text-xs px-2 py-1 rounded ${trade.acquisitionOrDisposition === 'A'
                                          ? 'bg-green-500/20 text-green-400 border border-green-500/30'
                                          : 'bg-red-500/20 text-red-400 border border-red-500/30'
                                        }`}>
                                        {trade.acquisitionOrDisposition === 'A' ? 'ğŸ“ˆ Buy' : 'ğŸ“‰ Sell'}
                                      </span>
                                      <span className="text-xs text-slate-500 border border-slate-700 px-2 py-1 rounded">
                                        {trade.transactionType || 'N/A'}
                                      </span>
                                    </div>
                                    <div className="text-xs text-slate-400 mb-2">{trade.typeOfOwner || 'N/A'}</div>
                                    <div className="text-sm text-slate-300 flex items-center gap-3">
                                      <span className="font-mono">
                                        {formatNumber(trade.securitiesTransacted || 0, 0)} shares
                                      </span>
                                      {trade.price > 0 && (
                                        <>
                                          <span className="text-slate-600">@</span>
                                          <span className="font-mono">${(trade.price || 0).toFixed(2)}</span>
                                          <span className="text-slate-600">â€¢</span>
                                          <span className="text-slate-500">
                                            Total: {formatNumber((trade.securitiesTransacted || 0) * (trade.price || 0))}
                                          </span>
                                        </>
                                      )}
                                    </div>
                                    <div className="text-xs text-slate-500 mt-1">
                                      Holdings after: {formatNumber(trade.securitiesOwned || 0, 0)} shares
                                    </div>
                                  </div>
                                  <div className="text-xs text-slate-500 text-right">
                                    <div>{trade.filingDate ? new Date(trade.filingDate).toLocaleDateString() : 'N/A'}</div>
                                    {trade.transactionDate && trade.transactionDate !== trade.filingDate && (
                                      <div className="text-slate-600 text-xs">Trade: {new Date(trade.transactionDate).toLocaleDateString()}</div>
                                    )}
                                  </div>
                                </div>
                              </div>
                            ))}
                          </div>

                          <div className="text-sm text-slate-500 bg-slate-800/50 p-3 rounded-lg text-center">
                            ğŸ’¡ Insider buying can signal confidence, while selling may be routine diversification.
                            Look for unusual patterns or clusters of activity.
                          </div>
                        </>
                      )}

                      {/* No trades but have statistics */}
                      {(!insiderData.latestTrades || insiderData.latestTrades.length === 0) && insiderData.statistics && (
                        <div className="glass-card p-6 rounded-xl text-center">
                          <div className="text-slate-400">No recent individual transactions available</div>
                        </div>
                      )}
                    </div>
                  ) : insiderData?.type === 'statistics' && insiderData?.statistics ? (
                    <div className="space-y-4">
                      <div className="glass-card p-6 rounded-xl">
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                          <div className="text-center">
                            <div className="text-xs text-slate-500 mb-2">Total Trades</div>
                            <div className="text-3xl font-bold text-cyan-400">
                              {insiderData.statistics.totalTransactions || 0}
                            </div>
                          </div>
                          <div className="text-center">
                            <div className="text-xs text-slate-500 mb-2">Purchases</div>
                            <div className="text-3xl font-bold text-green-400">
                              {insiderData.statistics.totalBought || 0}
                            </div>
                            <div className="text-xs text-slate-400 mt-1">
                              ${((insiderData.statistics.totalBoughtValue || 0) / 1000000).toFixed(1)}M
                            </div>
                          </div>
                          <div className="text-center">
                            <div className="text-xs text-slate-500 mb-2">Sales</div>
                            <div className="text-3xl font-bold text-red-400">
                              {insiderData.statistics.totalSold || 0}
                            </div>
                            <div className="text-xs text-slate-400 mt-1">
                              ${((insiderData.statistics.totalSoldValue || 0) / 1000000).toFixed(1)}M
                            </div>
                          </div>
                          <div className="text-center">
                            <div className="text-xs text-slate-500 mb-2">Net Position</div>
                            <div className={`text-3xl font-bold ${(insiderData.statistics.totalBought - insiderData.statistics.totalSold) > 0 ? 'text-green-400' : 'text-red-400'
                              }`}>
                              {insiderData.statistics.totalBought - insiderData.statistics.totalSold > 0 ? '+' : ''}
                              {insiderData.statistics.totalBought - insiderData.statistics.totalSold}
                            </div>
                            <div className="text-xs text-slate-400 mt-1">
                              ${(((insiderData.statistics.totalBoughtValue || 0) - (insiderData.statistics.totalSoldValue || 0)) / 1000000).toFixed(1)}M
                            </div>
                          </div>
                        </div>
                      </div>

                      <div className="glass-card p-6 rounded-xl">
                        <div className="text-sm font-bold text-slate-400 mb-4">Insider Sentiment</div>
                        <div className="space-y-4">
                          <div>
                            <div className="flex justify-between text-sm mb-2">
                              <span className="text-slate-400">Buy/Sell Ratio</span>
                              <span className="text-white font-bold">
                                {insiderData.statistics.totalSold > 0
                                  ? (insiderData.statistics.totalBought / insiderData.statistics.totalSold).toFixed(2)
                                  : 'N/A'}
                              </span>
                            </div>
                            <div className="flex justify-between text-sm">
                              <span className="text-slate-400">Period</span>
                              <span className="text-white font-bold">Last 6 Months</span>
                            </div>
                          </div>

                          <div className="text-sm text-slate-500 bg-slate-800/50 p-3 rounded-lg">
                            ğŸ’¡ Insider buying can signal confidence, while selling may be routine diversification.
                            Look for unusual patterns or clusters of activity.
                          </div>
                        </div>
                      </div>
                    </div>
                  ) : Array.isArray(insiderData) && insiderData.length === 0 ? (
                    <div className="glass-card p-8 rounded-xl text-center">
                      <div className="text-6xl mb-4">ğŸ“Š</div>
                      <div className="text-xl font-bold text-white mb-2">No Insider Trades Found</div>
                      <div className="text-slate-400 mb-4">
                        No insider trading activity found for {stock.symbol}.
                      </div>
                      <div className="text-sm text-slate-500">
                        This stock may have very low insider activity.
                      </div>
                    </div>
                  ) : (
                    <>
                      {/* Show date range if we have data */}
                      {Array.isArray(insiderData) && insiderData.length > 0 && (
                        <div className="glass-card p-3 rounded-lg mb-4 text-center">
                          <div className="text-sm text-slate-400">
                            Showing {insiderData.length} insider {insiderData.length === 1 ? 'trade' : 'trades'}
                            {insiderData[0]?.filingDate && insiderData[insiderData.length - 1]?.filingDate && (
                              <span className="ml-2">
                                ({new Date(insiderData[insiderData.length - 1].filingDate).toLocaleDateString()} - {new Date(insiderData[0].filingDate).toLocaleDateString()})
                              </span>
                            )}
                          </div>
                        </div>
                      )}
                      <div className="space-y-2 max-h-[600px] overflow-y-auto">
                        {(insiderData || []).map((trade, i) => (
                          <div key={i} className="glass-card p-4 rounded-xl">
                            <div className="flex items-start justify-between">
                              <div className="flex-1">
                                <div className="flex items-center gap-2 mb-1">
                                  <span className="font-semibold text-white">{trade.reportingName || 'Unknown'}</span>
                                  <span className={`chip text-xs ${trade.transactionType?.toLowerCase().includes('purchase') || trade.transactionType?.toLowerCase().includes('buy') ? 'bg-green-500/20 text-green-400 border border-green-500/30' : 'bg-red-500/20 text-red-400 border border-red-500/30'}`}>
                                    {trade.transactionType || 'N/A'}
                                  </span>
                                </div>
                                <div className="text-xs text-slate-400">{trade.typeOfOwner || 'N/A'}</div>
                                <div className="text-sm text-slate-300 mt-2">
                                  <span className="font-mono">{formatNumber(trade.securitiesTransacted || 0, 0)} shares</span> @
                                  <span className="font-mono ml-1">${(trade.price || 0).toFixed(2)}</span>
                                  <span className="ml-2 text-slate-500">Total: {formatNumber((trade.securitiesTransacted || 0) * (trade.price || 0))}</span>
                                </div>
                              </div>
                              <div className="text-xs text-slate-500 text-right">
                                {trade.filingDate ? new Date(trade.filingDate).toLocaleDateString() : 'N/A'}
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </>
                  )}
                </div>
              ) : activeTab === 'earnings' && analystEstimates ? (
                <div className="space-y-6">
                  <h3 className="text-xl font-bold text-white">Earnings Performance vs Estimates</h3>

                  {/* Check if earnings data is available */}
                  {(!analystEstimates.quarterly || analystEstimates.quarterly.length === 0) ? (
                    <div className="glass-card p-8 rounded-xl text-center">
                      <div className="text-6xl mb-4">ğŸ“Š</div>
                      <div className="text-xl font-bold text-white mb-2">Earnings Data Not Available</div>
                      <div className="text-slate-400 mb-4">
                        Historical earnings data may require a premium Financial Modeling Prep subscription or may not be available for this stock.
                      </div>
                      <div className="text-sm text-slate-500">
                        Try viewing the Fundamentals or Financial tabs for other company data.
                      </div>
                    </div>
                  ) : (
                    <>
                      {/* Quarterly Earnings */}
                      {analystEstimates?.quarterly && analystEstimates.quarterly.length > 0 && (
                        <div>
                          <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Quarterly Earnings</h4>
                          <div className="space-y-3">
                            {(analystEstimates?.quarterly || []).slice(0, 8).map((est, i) => {
                              const epsEstimate = est.estimatedEpsAvg || 0;
                              const epsActual = est.eps || null;
                              const hasBeat = epsActual !== null;
                              const beat = hasBeat ? epsActual > epsEstimate : null;
                              const surprise = hasBeat ? ((epsActual - epsEstimate) / Math.abs(epsEstimate)) * 100 : null;

                              const revenueEstimate = est.estimatedRevenueAvg || 0;
                              const revenueActual = est.revenue || null;
                              const hasRevenueBeat = revenueActual !== null;
                              const revenueBeat = hasRevenueBeat ? revenueActual > revenueEstimate : null;
                              const revenueSurprise = hasRevenueBeat ? ((revenueActual - revenueEstimate) / revenueEstimate) * 100 : null;

                              return (
                                <div key={i} className="glass-card p-5 rounded-xl">
                                  <div className="flex items-center justify-between mb-4">
                                    <div>
                                      <div className="text-lg font-bold text-white">{est.date || 'N/A'}</div>
                                      <div className="text-xs text-slate-500">{est.numberAnalystEstimatedEps || 0} analysts</div>
                                    </div>
                                    {hasBeat && (
                                      <div className={`px-4 py-2 rounded-lg font-bold text-lg ${beat ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'
                                        }`}>
                                        {beat ? 'âœ“ BEAT' : 'âœ— MISS'}
                                      </div>
                                    )}
                                  </div>

                                  {/* EPS Row */}
                                  <div className="grid grid-cols-2 gap-4 mb-3">
                                    <div className="glass-card p-3 rounded-lg">
                                      <div className="text-xs text-slate-500 mb-1">EPS Estimate</div>
                                      <div className="text-xl font-bold text-cyan-400">${epsEstimate.toFixed(2)}</div>
                                    </div>
                                    <div className="glass-card p-3 rounded-lg">
                                      <div className="text-xs text-slate-500 mb-1">EPS Actual</div>
                                      <div className={`text-xl font-bold ${hasBeat ? (beat ? 'text-green-400' : 'text-red-400') : 'text-slate-400'
                                        }`}>
                                        {hasBeat ? `$${epsActual.toFixed(2)}` : 'â€”'}
                                      </div>
                                    </div>
                                  </div>

                                  {/* Revenue Row */}
                                  <div className="grid grid-cols-2 gap-4 mb-3">
                                    <div className="glass-card p-3 rounded-lg">
                                      <div className="text-xs text-slate-500 mb-1">Revenue Estimate</div>
                                      <div className="text-sm font-bold text-purple-400">{formatNumber(revenueEstimate)}</div>
                                    </div>
                                    <div className="glass-card p-3 rounded-lg">
                                      <div className="text-xs text-slate-500 mb-1">Revenue Actual</div>
                                      <div className={`text-sm font-bold ${hasRevenueBeat ? (revenueBeat ? 'text-green-400' : 'text-red-400') : 'text-slate-400'
                                        }`}>
                                        {hasRevenueBeat ? formatNumber(revenueActual) : 'â€”'}
                                      </div>
                                    </div>
                                  </div>

                                  {/* Surprise Percentage */}
                                  {hasBeat && surprise !== null && (
                                    <div className="pt-3 border-t border-slate-700/30">
                                      <div className="flex items-center justify-between">
                                        <span className="text-xs text-slate-400">EPS Surprise</span>
                                        <span className={`text-sm font-bold ${surprise > 0 ? 'text-green-400' : 'text-red-400'
                                          }`}>
                                          {surprise > 0 ? '+' : ''}{surprise.toFixed(1)}%
                                        </span>
                                      </div>
                                      {hasRevenueBeat && revenueSurprise !== null && (
                                        <div className="flex items-center justify-between mt-1">
                                          <span className="text-xs text-slate-400">Revenue Surprise</span>
                                          <span className={`text-sm font-bold ${revenueSurprise > 0 ? 'text-green-400' : 'text-red-400'
                                            }`}>
                                            {revenueSurprise > 0 ? '+' : ''}{revenueSurprise.toFixed(1)}%
                                          </span>
                                        </div>
                                      )}
                                    </div>
                                  )}

                                  {!hasBeat && (
                                    <div className="pt-3 border-t border-slate-700/30 text-center text-sm text-slate-500">
                                      Earnings not yet reported
                                    </div>
                                  )}
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      )}

                      {/* Annual Earnings */}
                      {analystEstimates?.annual && analystEstimates.annual.length > 0 && (
                        <div>
                          <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Annual Earnings Estimates</h4>
                          <div className="glass-card p-4 rounded-xl overflow-x-auto">
                            <table className="w-full text-sm">
                              <thead>
                                <tr className="text-slate-500 text-xs border-b border-slate-700/30">
                                  <th className="text-left pb-3 px-2">Year</th>
                                  <th className="text-right pb-3 px-2">Est. Revenue</th>
                                  <th className="text-right pb-3 px-2">Est. EPS</th>
                                  <th className="text-right pb-3 px-2">Est. EBITDA</th>
                                  <th className="text-right pb-3 px-2">Analysts</th>
                                </tr>
                              </thead>
                              <tbody>
                                {(analystEstimates?.annual || []).slice(0, 4).map((est, i) => (
                                  <tr key={i} className="border-b border-slate-700/20">
                                    <td className="py-3 px-2 text-cyan-300 font-semibold">{est.date || 'N/A'}</td>
                                    <td className="py-3 px-2 text-right font-mono">{formatNumber(est.estimatedRevenueAvg || 0)}</td>
                                    <td className="py-3 px-2 text-right font-mono text-green-400">${(est.estimatedEpsAvg || 0).toFixed(2)}</td>
                                    <td className="py-3 px-2 text-right font-mono">{formatNumber(est.estimatedEbitdaAvg || 0)}</td>
                                    <td className="py-3 px-2 text-right text-slate-400">{est.numberAnalystEstimatedRevenue || 0}</td>
                                  </tr>
                                ))}
                              </tbody>
                            </table>
                          </div>
                        </div>
                      )}

                      {/* Summary Stats */}
                      {analystEstimates?.quarterly && analystEstimates.quarterly.length > 0 && (
                        <div>
                          <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Performance Summary</h4>
                          <div className="glass-card p-6 rounded-xl">
                            <div className="grid grid-cols-3 gap-6">
                              <div className="text-center">
                                <div className="text-xs text-slate-500 mb-2">Total Quarters</div>
                                <div className="text-3xl font-bold text-white">
                                  {(analystEstimates?.quarterly || []).filter(q => q.eps !== null).length}
                                </div>
                              </div>
                              <div className="text-center">
                                <div className="text-xs text-slate-500 mb-2">Earnings Beats</div>
                                <div className="text-3xl font-bold text-green-400">
                                  {(analystEstimates?.quarterly || []).filter(q => q.eps !== null && q.eps > (q.estimatedEpsAvg || 0)).length}
                                </div>
                              </div>
                              <div className="text-center">
                                <div className="text-xs text-slate-500 mb-2">Earnings Misses</div>
                                <div className="text-3xl font-bold text-red-400">
                                  {(analystEstimates?.quarterly || []).filter(q => q.eps !== null && q.eps <= (q.estimatedEpsAvg || 0)).length}
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>
                      )}
                    </>
                  )}
                </div>
              ) : activeTab === 'financials' && incomeStatement ? (
                <div className="space-y-4">
                  <h3 className="text-lg font-bold text-white">Income Statement (Last 5 Years)</h3>
                  <div className="glass-card p-4 rounded-xl overflow-x-auto">
                    <table className="w-full text-sm">
                      <thead>
                        <tr className="text-slate-500 text-xs border-b border-slate-700/30">
                          <th className="text-left pb-3">Period</th>
                          <th className="text-right pb-3">Revenue</th>
                          <th className="text-right pb-3">Gross Profit</th>
                          <th className="text-right pb-3">Operating Income</th>
                          <th className="text-right pb-3">Net Income</th>
                          <th className="text-right pb-3">EPS</th>
                        </tr>
                      </thead>
                      <tbody>
                        {incomeStatement.slice(0, 5).map((stmt, i) => (
                          <tr key={i} className="border-b border-slate-700/20">
                            <td className="py-3 text-cyan-300 font-semibold">{stmt.calendarYear || stmt.date || 'N/A'}</td>
                            <td className="py-3 text-right font-mono">{formatNumber(stmt.revenue || 0)}</td>
                            <td className="py-3 text-right font-mono">{formatNumber(stmt.grossProfit || 0)}</td>
                            <td className="py-3 text-right font-mono">{formatNumber(stmt.operatingIncome || 0)}</td>
                            <td className="py-3 text-right font-mono">{formatNumber(stmt.netIncome || 0)}</td>
                            <td className="py-3 text-right font-mono">${(stmt.eps || 0).toFixed(2)}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              ) : activeTab === 'charts' && historicalData ? (
                <div className="space-y-4">
                  <div className="flex items-center justify-between mb-4">
                    <h3 className="text-lg font-bold text-white">Advanced Charts (TradingView Lightweight Charts)</h3>
                    {(() => {
                      const normalizedCandles = historicalData.map(c => ({
                        close: c.close || c,
                        high: c.high || c.close || c,
                        low: c.low || c.close || c,
                        open: c.open || c.close || c
                      }));
                      const patterns = window.patternEngine?.detectPatterns(normalizedCandles) || [];
                      if (patterns.length > 0) {
                        return (
                          <div className="flex items-center gap-2">
                            <span className="text-xs text-slate-400">
                              {patterns.length} pattern{patterns.length !== 1 ? 's' : ''} detected
                            </span>
                            <button
                              onClick={(e) => { e.stopPropagation(); setActiveTab('patterns'); }}
                              className="px-3 py-1 bg-cyan-600 hover:bg-cyan-500 text-white rounded text-sm font-medium"
                            >
                              View Patterns
                            </button>
                          </div>
                        );
                      }
                      return null;
                    })()}
                  </div>
                  <AdvancedChartPanel
                    symbol={stock.symbol}
                    candles={historicalData}
                    timeframe={chartTimeframe}
                    onTimeframe={(tf) => {
                      setChartTimeframe(tf);
                      setHistoricalData(null);
                    }}
                    comparisonSymbol={comparisonSymbol}
                    onComparisonSymbol={(s) => {
                      setComparisonSymbol(s);
                      if (!s) {
                        setComparisonData(null);
                        setComparisonMeta({ symbol: null, timeframe: null });
                      }
                    }}
                    comparisonCandles={comparisonData}
                    comparisonLoading={comparisonLoading}
                  />
                </div>
              ) : activeTab === 'ai-predictions' ? (
                <div className="space-y-6">
                  <div className="flex items-center justify-between">
                    <h3 className="text-xl font-bold text-white flex items-center gap-2">
                      <span>ğŸ¤–</span>
                      AI-Powered Stock Analysis
                    </h3>
                    <button
                      onClick={async () => {
                        console.log('ğŸ”„ Manual refresh clicked');
                        setAiAnalysis(null);
                        setAiLoading(true);
                        try {
                          const analysis = await aiAnalyzer.analyzeStock(stock);
                          setAiAnalysis(analysis);
                        } catch (err) {
                          console.error('âŒ Refresh error:', err);
                          setAiAnalysis(aiAnalyzer.getFallbackAnalysis(stock));
                        } finally {
                          setAiLoading(false);
                        }
                      }}
                      className="px-3 py-1 bg-purple-600 hover:bg-purple-700 text-white text-sm rounded-lg transition-colors"
                    >
                      ğŸ”„ Refresh Analysis
                    </button>
                  </div>

                  {(() => {
                    console.log('ğŸ¨ RENDER CHECK - aiLoading:', aiLoading, 'aiAnalysis:', !!aiAnalysis);
                    return null;
                  })()}

                  {aiLoading ? (
                    <div className="glass-card p-12 rounded-xl text-center">
                      <div className="inline-block animate-spin rounded-full h-12 w-12 border-4 border-purple-500 border-t-transparent mb-4"></div>
                      <div className="text-white font-semibold">Claude AI is analyzing {stock.symbol}...</div>
                      <div className="text-slate-400 text-sm mt-2">Considering fundamentals, technicals, and market sentiment</div>
                    </div>
                  ) : !aiAnalysis ? (
                    <div className="glass-card p-8 rounded-xl text-center">
                      <div className="text-6xl mb-4">ğŸ¤–</div>
                      <div className="text-xl font-bold text-white mb-2">Loading AI Analysis...</div>
                      <div className="text-slate-400 mb-4">Preparing stock analysis for {stock.symbol}</div>
                      <button
                        onClick={async () => {
                          console.log('ğŸ”„ Trigger analysis from empty state');
                          setAiLoading(true);
                          try {
                            const analysis = await aiAnalyzer.analyzeStock(stock);
                            setAiAnalysis(analysis);
                          } catch (err) {
                            console.error('âŒ Analysis error:', err);
                            setAiAnalysis(aiAnalyzer.getFallbackAnalysis(stock));
                          } finally {
                            setAiLoading(false);
                          }
                        }}
                        className="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold"
                      >
                        Generate AI Analysis
                      </button>
                    </div>
                  ) : (
                    <>
                      {/* FALLBACK MODE NOTICE */}
                      {aiAnalysis.aiModel === 'fallback' && (
                        <div className="glass-card p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30 mb-6">
                          <div className="flex items-center gap-3">
                            <span className="text-2xl">âš ï¸</span>
                            <div className="flex-1">
                              <div className="text-yellow-400 font-bold text-sm mb-1">Limited Analysis Mode</div>
                              <div className="text-slate-300 text-xs">
                                Claude AI is temporarily unavailable. Showing basic rule-based analysis.
                                Click "Refresh Analysis" to try again.
                              </div>
                            </div>
                          </div>
                        </div>
                      )}

                      {/* OVERALL RECOMMENDATION */}
                      <div className="glass-card p-6 rounded-xl">
                        <div className="grid grid-cols-3 gap-6">
                          <div className="text-center">
                            <div className="text-xs text-slate-500 mb-2">AI Recommendation</div>
                            <div className={`text-5xl font-bold mb-2 ${aiAnalysis.recommendation === 'BUY' ? 'text-green-400' :
                                aiAnalysis.recommendation === 'SELL' ? 'text-red-400' :
                                  'text-yellow-400'
                              }`}>
                              {aiAnalysis.recommendation}
                            </div>
                            <div className="flex items-center justify-center gap-1 mt-2">
                              {[...Array(10)].map((_, i) => (
                                <div
                                  key={i}
                                  className={`w-2 h-6 rounded ${i < aiAnalysis.recommendationStrength
                                      ? aiAnalysis.recommendation === 'BUY' ? 'bg-green-500' :
                                        aiAnalysis.recommendation === 'SELL' ? 'bg-red-500' :
                                          'bg-yellow-500'
                                      : 'bg-slate-700'
                                    }`}
                                />
                              ))}
                            </div>
                            <div className="text-xs text-slate-400 mt-2">
                              Strength: {aiAnalysis.recommendationStrength}/10
                            </div>
                          </div>

                          <div className="text-center">
                            <div className="text-xs text-slate-500 mb-2">AI Price Target</div>
                            <div className="text-4xl font-bold text-purple-400">
                              ${aiAnalysis.targetPrice?.toFixed(2)}
                            </div>
                            <div className={`text-lg font-bold mt-2 ${aiAnalysis.targetPrice > aiAnalysis.currentPrice ? 'text-green-400' : 'text-red-400'
                              }`}>
                              {((aiAnalysis.targetPrice / aiAnalysis.currentPrice - 1) * 100).toFixed(1)}% upside
                            </div>
                          </div>

                          <div className="text-center">
                            <div className="text-xs text-slate-500 mb-2">Suggested Stop Loss</div>
                            <div className="text-4xl font-bold text-red-400">
                              ${aiAnalysis.stopLoss?.toFixed(2)}
                            </div>
                            <div className="text-sm text-slate-400 mt-2">
                              {((1 - aiAnalysis.stopLoss / aiAnalysis.currentPrice) * 100).toFixed(1)}% downside protection
                            </div>
                          </div>
                        </div>
                      </div>

                      {/* PRICE PREDICTIONS */}
                      <div>
                        <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Price Predictions</h4>
                        <div className="grid grid-cols-3 gap-4">
                          <div className="glass-card p-5 rounded-xl">
                            <div className="flex items-center justify-between mb-3">
                              <div className="text-xs text-slate-500">1-Day Forecast</div>
                              <div className="text-xs text-cyan-400 font-semibold">
                                {aiAnalysis.predictions.oneDay.confidence}% confidence
                              </div>
                            </div>
                            <div className="text-3xl font-bold text-white mb-2">
                              ${aiAnalysis.predictions.oneDay.price?.toFixed(2)}
                            </div>
                            <div className={`text-lg font-bold ${aiAnalysis.predictions.oneDay.change >= 0 ? 'text-green-400' : 'text-red-400'
                              }`}>
                              {aiAnalysis.predictions.oneDay.change >= 0 ? '+' : ''}{aiAnalysis.predictions.oneDay.change?.toFixed(2)}%
                            </div>
                            <div className="mt-3 h-2 bg-slate-700 rounded-full overflow-hidden">
                              <div
                                className="h-full bg-cyan-500"
                                style={{ width: `${aiAnalysis.predictions.oneDay.confidence}%` }}
                              />
                            </div>
                          </div>

                          <div className="glass-card p-5 rounded-xl">
                            <div className="flex items-center justify-between mb-3">
                              <div className="text-xs text-slate-500">7-Day Forecast</div>
                              <div className="text-xs text-blue-400 font-semibold">
                                {aiAnalysis.predictions.sevenDay.confidence}% confidence
                              </div>
                            </div>
                            <div className="text-3xl font-bold text-white mb-2">
                              ${aiAnalysis.predictions.sevenDay.price?.toFixed(2)}
                            </div>
                            <div className={`text-lg font-bold ${aiAnalysis.predictions.sevenDay.change >= 0 ? 'text-green-400' : 'text-red-400'
                              }`}>
                              {aiAnalysis.predictions.sevenDay.change >= 0 ? '+' : ''}{aiAnalysis.predictions.sevenDay.change?.toFixed(2)}%
                            </div>
                            <div className="mt-3 h-2 bg-slate-700 rounded-full overflow-hidden">
                              <div
                                className="h-full bg-blue-500"
                                style={{ width: `${aiAnalysis.predictions.sevenDay.confidence}%` }}
                              />
                            </div>
                          </div>

                          <div className="glass-card p-5 rounded-xl">
                            <div className="flex items-center justify-between mb-3">
                              <div className="text-xs text-slate-500">30-Day Forecast</div>
                              <div className="text-xs text-purple-400 font-semibold">
                                {aiAnalysis.predictions.thirtyDay.confidence}% confidence
                              </div>
                            </div>
                            <div className="text-3xl font-bold text-white mb-2">
                              ${aiAnalysis.predictions.thirtyDay.price?.toFixed(2)}
                            </div>
                            <div className={`text-lg font-bold ${aiAnalysis.predictions.thirtyDay.change >= 0 ? 'text-green-400' : 'text-red-400'
                              }`}>
                              {aiAnalysis.predictions.thirtyDay.change >= 0 ? '+' : ''}{aiAnalysis.predictions.thirtyDay.change?.toFixed(2)}%
                            </div>
                            <div className="mt-3 h-2 bg-slate-700 rounded-full overflow-hidden">
                              <div
                                className="h-full bg-purple-500"
                                style={{ width: `${aiAnalysis.predictions.thirtyDay.confidence}%` }}
                              />
                            </div>
                          </div>
                        </div>
                      </div>

                      {/* AI SCORES */}
                      <div>
                        <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">AI Analysis Scores</h4>
                        <div className="glass-card p-6 rounded-xl">
                          <div className="grid grid-cols-3 gap-6">
                            <div>
                              <div className="flex items-center justify-between mb-2">
                                <span className="text-sm text-slate-400">Technical Analysis</span>
                                <span className="text-lg font-bold text-cyan-400">{aiAnalysis.technicalScore}/100</span>
                              </div>
                              <div className="h-3 bg-slate-700 rounded-full overflow-hidden">
                                <div
                                  className={`h-full ${aiAnalysis.technicalScore >= 70 ? 'bg-green-500' :
                                      aiAnalysis.technicalScore >= 40 ? 'bg-yellow-500' :
                                        'bg-red-500'
                                    }`}
                                  style={{ width: `${aiAnalysis.technicalScore}%` }}
                                />
                              </div>
                            </div>

                            <div>
                              <div className="flex items-center justify-between mb-2">
                                <span className="text-sm text-slate-400">Fundamental Strength</span>
                                <span className="text-lg font-bold text-blue-400">{aiAnalysis.fundamentalScore}/100</span>
                              </div>
                              <div className="h-3 bg-slate-700 rounded-full overflow-hidden">
                                <div
                                  className={`h-full ${aiAnalysis.fundamentalScore >= 70 ? 'bg-green-500' :
                                      aiAnalysis.fundamentalScore >= 40 ? 'bg-yellow-500' :
                                        'bg-red-500'
                                    }`}
                                  style={{ width: `${aiAnalysis.fundamentalScore}%` }}
                                />
                              </div>
                            </div>

                            <div>
                              <div className="flex items-center justify-between mb-2">
                                <span className="text-sm text-slate-400">Market Sentiment</span>
                                <span className="text-lg font-bold text-purple-400">{aiAnalysis.sentimentScore}/100</span>
                              </div>
                              <div className="h-3 bg-slate-700 rounded-full overflow-hidden">
                                <div
                                  className={`h-full ${aiAnalysis.sentimentScore >= 70 ? 'bg-green-500' :
                                      aiAnalysis.sentimentScore >= 40 ? 'bg-yellow-500' :
                                        'bg-red-500'
                                    }`}
                                  style={{ width: `${aiAnalysis.sentimentScore}%` }}
                                />
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      {/* KEY INSIGHTS */}
                      <div>
                        <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Key Insights</h4>
                        <div className="space-y-2">
                          {aiAnalysis.keyInsights?.map((insight, i) => (
                            <div key={i} className="glass-card p-4 rounded-lg flex items-start gap-3">
                              <span className="text-2xl">ğŸ’¡</span>
                              <span className="text-slate-300 flex-1">{insight}</span>
                            </div>
                          ))}
                        </div>
                      </div>

                      {/* OPPORTUNITIES & RISKS */}
                      <div className="grid grid-cols-2 gap-4">
                        <div>
                          <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide flex items-center gap-2">
                            <span>ğŸ“ˆ</span> Opportunities
                          </h4>
                          <div className="space-y-2">
                            {aiAnalysis.opportunities?.map((opp, i) => (
                              <div key={i} className="glass-card p-4 rounded-lg bg-green-500/10 border border-green-500/20">
                                <div className="text-green-400 text-sm">{opp}</div>
                              </div>
                            ))}
                          </div>
                        </div>

                        <div>
                          <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide flex items-center gap-2">
                            <span>âš ï¸</span> Risks
                          </h4>
                          <div className="space-y-2">
                            {aiAnalysis.risks?.map((risk, i) => (
                              <div key={i} className="glass-card p-4 rounded-lg bg-red-500/10 border border-red-500/20">
                                <div className="text-red-400 text-sm">{risk}</div>
                              </div>
                            ))}
                          </div>
                        </div>
                      </div>

                      {/* AI SUMMARY */}
                      <div className="glass-card p-6 rounded-xl bg-purple-500/10 border border-purple-500/20">
                        <div className="flex items-start gap-4">
                          <div className="text-4xl">ğŸ¤–</div>
                          <div className="flex-1">
                            <div className="text-sm font-bold text-purple-400 mb-2">AI Summary</div>
                            <div className="text-slate-300 leading-relaxed">{aiAnalysis.summary}</div>
                            <div className="mt-4 pt-4 border-t border-slate-700/30 flex items-center justify-between text-xs text-slate-500">
                              <span>Powered by {aiAnalysis.aiModel || 'Claude Sonnet 4'}</span>
                              <span>Generated: {new Date(aiAnalysis.timestamp).toLocaleString()}</span>
                            </div>
                          </div>
                        </div>
                      </div>

                      {/* DISCLAIMER */}
                      <div className="glass-card p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/20 text-center">
                        <div className="text-yellow-400 text-sm font-semibold mb-1">âš ï¸ AI Prediction Disclaimer</div>
                        <div className="text-slate-400 text-xs">
                          AI predictions are educational estimates and should not be considered financial advice.
                          Past performance does not guarantee future results. Always conduct your own research and
                          consult with a financial advisor before making investment decisions.
                        </div>
                      </div>
                    </>
                  )}
                </div>
              ) : activeTab === 'portfolio' ? (
                <div className="space-y-6">
                  <h3 className="text-xl font-bold text-white">ğŸ“Š Portfolio Optimization</h3>

                  {portfolio.length < 2 ? (
                    <div className="glass-card p-8 text-center">
                      <i className="fas fa-chart-pie text-4xl text-purple-400 mb-4"></i>
                      <div className="text-lg font-semibold text-white mb-2">Add stocks to analyze your portfolio</div>
                      <div className="text-slate-400 text-sm">You need at least 2 stocks in your portfolio to run optimization</div>
                    </div>
                  ) : !portfolioOptimization ? (
                    <div className="glass-card p-8 text-center">
                      <i className="fas fa-spinner fa-spin text-4xl text-purple-400 mb-4"></i>
                      <div className="text-slate-400">Running portfolio optimization...</div>
                    </div>
                  ) : (
                    <>
                      <div className="grid grid-cols-2 gap-6">
                        <div className="glass-card p-5 rounded-xl">
                          <div className="flex items-center gap-2 mb-3">
                            <div className="w-3 h-3 rounded-full bg-green-500"></div>
                            <h4 className="text-sm font-bold text-white uppercase tracking-wide">Max Sharpe Ratio</h4>
                          </div>
                          <div className="grid grid-cols-2 gap-3 text-sm mb-4">
                            <div className="text-slate-400">Return</div>
                            <div className="text-right font-semibold text-green-400">
                              {(portfolioOptimization.maxSharpePortfolio.return * 100).toFixed(1)}%
                            </div>
                            <div className="text-slate-400">Risk</div>
                            <div className="text-right font-semibold text-white">
                              {(portfolioOptimization.maxSharpePortfolio.volatility * 100).toFixed(1)}%
                            </div>
                            <div className="text-slate-400">Sharpe</div>
                            <div className="text-right font-semibold text-cyan-400">
                              {portfolioOptimization.maxSharpePortfolio.sharpeRatio.toFixed(2)}
                            </div>
                          </div>
                          <div className="text-xs text-slate-500 mb-2">Allocation:</div>
                          <div className="space-y-2">
                            {portfolioOptimization.maxSharpePortfolio.weights
                              .sort((a, b) => b.weight - a.weight)
                              .map((pos, i) => (
                                <div key={i} className="flex justify-between p-2 bg-slate-800/40 rounded">
                                  <span className="font-semibold text-cyan-300">{pos.symbol}</span>
                                  <span className="text-white font-mono">{pos.weight.toFixed(1)}%</span>
                                </div>
                              ))}
                          </div>
                        </div>

                        <div className="glass-card p-5 rounded-xl">
                          <div className="flex items-center gap-2 mb-3">
                            <div className="w-3 h-3 rounded-full bg-red-500"></div>
                            <h4 className="text-sm font-bold text-white uppercase tracking-wide">Min Risk</h4>
                          </div>
                          <div className="grid grid-cols-2 gap-3 text-sm mb-4">
                            <div className="text-slate-400">Return</div>
                            <div className="text-right font-semibold text-yellow-400">
                              {(portfolioOptimization.minVolatilityPortfolio.return * 100).toFixed(1)}%
                            </div>
                            <div className="text-slate-400">Risk</div>
                            <div className="text-right font-semibold text-white">
                              {(portfolioOptimization.minVolatilityPortfolio.volatility * 100).toFixed(1)}%
                            </div>
                            <div className="text-slate-400">Sharpe</div>
                            <div className="text-right font-semibold text-cyan-400">
                              {portfolioOptimization.minVolatilityPortfolio.sharpeRatio.toFixed(2)}
                            </div>
                          </div>
                          <div className="text-xs text-slate-500 mb-2">Allocation:</div>
                          <div className="space-y-2">
                            {portfolioOptimization.minVolatilityPortfolio.weights
                              .sort((a, b) => b.weight - a.weight)
                              .map((pos, i) => (
                                <div key={i} className="flex justify-between p-2 bg-slate-800/40 rounded">
                                  <span className="font-semibold text-cyan-300">{pos.symbol}</span>
                                  <span className="text-white font-mono">{pos.weight.toFixed(1)}%</span>
                                </div>
                              ))}
                          </div>
                        </div>
                      </div>

                      <div className="glass-card p-5 rounded-xl">
                        <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Individual Metrics</h4>
                        <div className="space-y-2">
                          {portfolioOptimization.individualMetrics.map((asset, i) => (
                            <div key={i} className="flex items-center justify-between p-3 bg-slate-800/40 rounded-lg">
                              <div className="font-semibold text-cyan-300">{asset.symbol}</div>
                              <div className="flex gap-4 text-sm">
                                <div>
                                  <span className="text-slate-500">Return: </span>
                                  <span className="text-green-400">{(asset.expectedReturn * 100).toFixed(1)}%</span>
                                </div>
                                <div>
                                  <span className="text-slate-500">Risk: </span>
                                  <span className="text-white">{(asset.volatility * 100).toFixed(1)}%</span>
                                </div>
                                <div>
                                  <span className="text-slate-500">Sharpe: </span>
                                  <span className="text-cyan-400">{asset.sharpeRatio.toFixed(2)}</span>
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>

                      <div className="text-xs text-slate-500 text-center">
                        <i className="fas fa-info-circle mr-1"></i>
                        Portfolio optimization based on Modern Portfolio Theory. Sharpe Ratio measures risk-adjusted returns.
                      </div>
                    </>
                  )}
                </div>
              ) : activeTab === 'similar' ? (
                <div className="space-y-6">
                  <h3 className="text-xl font-bold text-white">ğŸ¯ Stocks Similar to {selectedStock?.symbol}</h3>

                  {!similarStocks || similarStocks.length === 0 ? (
                    <div className="glass-card p-8 text-center">
                      <i className="fas fa-search text-4xl text-cyan-400 mb-4"></i>
                      <div className="text-slate-400">Finding similar stocks...</div>
                    </div>
                  ) : (
                    <div className="glass-card p-5 rounded-xl">
                      <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Top Matches</h4>
                      <div className="space-y-3">
                        {similarStocks.map((stock, i) => (
                          <div key={i} className="flex items-center justify-between p-3 bg-slate-800/40 rounded-lg hover:bg-slate-800/60 transition-colors cursor-pointer"
                            onClick={() => {
                              const fullStock = stocks.find(s => s.symbol === stock.symbol);
                              if (fullStock) setSelectedStock(fullStock);
                            }}>
                            <div className="flex items-center gap-4">
                              <div className="relative">
                                <div className="w-12 h-12 rounded-lg bg-gradient-to-br from-cyan-500 to-purple-500 flex items-center justify-center">
                                  <span className="font-bold text-white">{stock.symbol.substring(0, 3)}</span>
                                </div>
                                <div className="absolute -bottom-1 -right-1 w-6 h-6 bg-slate-800 rounded-full border-2 border-slate-900 flex items-center justify-center">
                                  <span className="text-xs font-bold text-white">{i + 1}</span>
                                </div>
                              </div>
                              <div>
                                <div className="font-semibold text-cyan-300">{stock.symbol}</div>
                                <div className="text-xs text-slate-400">{stock.companyName}</div>
                                <div className="text-xs text-slate-500">{stock.sector}</div>
                              </div>
                            </div>

                            <div className="flex items-center gap-6">
                              <div className="text-center">
                                <div className="text-xs text-slate-500 mb-1">Similarity</div>
                                <div className={`text-lg font-bold ${stock.similarity > 80 ? 'text-green-400' :
                                    stock.similarity > 60 ? 'text-yellow-400' : 'text-red-400'
                                  }`}>
                                  {stock.similarity.toFixed(1)}%
                                </div>
                              </div>
                              <div className="text-xs">
                                <div><span className="text-slate-500">P/E:</span> <span className="text-white">{stock.pe?.toFixed(1) || 'N/A'}</span></div>
                                <div><span className="text-slate-500">ROE:</span> <span className="text-white">{stock.roe?.toFixed(1) || 'N/A'}%</span></div>
                                <div><span className="text-slate-500">Score:</span> <span className="text-cyan-400">{stock.aiScore || 'N/A'}</span></div>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                      <div className="mt-4 text-xs text-slate-500 text-center">
                        <i className="fas fa-info-circle mr-1"></i>
                        Similarity based on sector, financial metrics, and market cap
                      </div>
                    </div>
                  )}
                </div>
              ) : activeTab === 'heatmap' ? (
                <div className="animate-fade-in">
                  <APIStatusBanner realtimeData={realtimeData} />
                  <RealtimeHeatmap
                    stocks={stocks}
                    onStockClick={(stock) => {
                      setSelectedStock(stock);
                      openStockModal(stock);
                    }}
                  />
                </div>
              ) : activeTab === 'sentiment-leaderboard' ? (
                <div className="space-y-6">
                  <SocialSentimentLeaderboard onStockClick={openStockModal} />
                </div>
              ) : activeTab === 'patterns' ? (
                <div className="space-y-6">
                  {historicalData && historicalData.length > 0 ? (
                    <>
                      <h3 className="text-xl font-bold text-white mb-4">ğŸ“ˆ Chart Pattern Recognition</h3>
                      {(() => {
                        // Normalize candles for pattern detection
                        const normalizedCandles = historicalData.map(c => ({
                          close: c.close || c,
                          high: c.high || c.close || c,
                          low: c.low || c.close || c,
                          open: c.open || c.close || c
                        }));

                        const patterns = window.patternEngine?.detectPatterns(normalizedCandles) || [];

                        if (patterns.length === 0) {
                          return (
                            <div className="glass-card p-8 rounded-xl text-center">
                              <i className="fas fa-chart-line text-4xl text-slate-500 mb-4"></i>
                              <p className="text-slate-400">No chart patterns detected</p>
                              <p className="text-xs text-slate-500 mt-2">Patterns require at least 20 candles of historical data</p>
                            </div>
                          );
                        }

                        return (
                          <div className="space-y-4">
                            {patterns.map((pattern, idx) => (
                              <PatternCard key={idx} pattern={pattern} stock={stock} historicalData={historicalData} />
                            ))}
                          </div>
                        );
                      })()}
                    </>
                  ) : (
                    <div className="glass-card p-8 rounded-xl text-center">
                      <i className="fas fa-chart-line text-4xl text-slate-500 mb-4"></i>
                      <p className="text-slate-400">Load chart data to detect patterns</p>
                      <p className="text-xs text-slate-500 mt-2">Switch to the Charts tab and load historical data first</p>
                    </div>
                  )}
                </div>
              ) : activeTab === 'watchlist' ? (
                <WatchlistTab
                  watchlist={watchlist}
                  stocks={stocks}
                  onRemoveFromWatchlist={toggleWatchlist}
                  onStockClick={openStockModal}
                  setShowWatchlistOnly={setShowWatchlistOnly}
                />
              ) : (
                <div className="text-center py-12 text-slate-400">
                  {activeTab === 'insider' || activeTab === 'earnings' || activeTab === 'financials' || activeTab === 'charts' || activeTab === 'ai-predictions' ?
                    'No data available for this stock' :
                    'Select a tab to view data'}
                </div>
              )}
            </div>

            {/* Footer */}
            <div className="flex justify-end gap-3 p-6 border-t border-slate-700/30 flex-shrink-0">
              <button onClick={onClose} className="px-6 py-2.5 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold text-sm">Close</button>
            </div>
          </div>
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PORTFOLIO MODAL COMPONENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PORTFOLIO TRACKER MODAL (USING NEW PORTFOLIOMANAGER)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function PortfolioModal({ onClose, stocks }) {
      const [activeTab, setActiveTab] = useState('holdings');
      const [newPosition, setNewPosition] = useState({ symbol: '', quantity: '', buyPrice: '', buyDate: '' });
      const [editingId, setEditingId] = useState(null);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      const [refreshKey, setRefreshKey] = useState(0);

      // Get portfolio metrics using PortfolioManager
      const metrics = window.portfolioManager ?
        window.portfolioManager.calculatePortfolioMetrics(stocks) :
        { holdings: [], totalValue: 0, totalCost: 0, totalGainLoss: 0, totalGainLossPercent: 0 };

      // Health Check Logic
      const calculateHealth = () => {
        if (metrics.holdings.length === 0) return null;

        let weightedBeta = 0;
        const sectorWeights = {};

        metrics.holdings.forEach(h => {
          const stock = stocks.find(s => s.symbol === h.symbol);
          const weight = metrics.totalValue > 0 ? (h.currentValue / metrics.totalValue) : 0;
          const beta = stock?.beta || 1.0;

          weightedBeta += beta * weight;

          const sector = stock?.sector || 'Unknown';
          sectorWeights[sector] = (sectorWeights[sector] || 0) + weight;
        });

        const maxSector = Object.entries(sectorWeights).sort((a, b) => b[1] - a[1])[0];

        const insights = [];
        if (weightedBeta > 1.3) insights.push({ type: 'warning', text: 'High Portfolio Volatility (Beta > 1.3). Consider adding defensive stocks.' });
        if (weightedBeta < 0.8) insights.push({ type: 'info', text: 'Low Portfolio Volatility (Beta < 0.8). Good for capital preservation.' });
        if (maxSector && maxSector[1] > 0.30) insights.push({ type: 'warning', text: `High concentration in ${maxSector[0]} (${(maxSector[1] * 100).toFixed(0)}%). Diversify!` });
        if (metrics.holdings.length < 5) insights.push({ type: 'warning', text: 'Portfolio is under-diversified (< 5 stocks).' });

        return { weightedBeta, maxSector, insights };
      };

      const health = calculateHealth();

      const addPosition = async () => {
        const { symbol, quantity, buyPrice, buyDate } = newPosition;

        if (!symbol || !quantity || !buyPrice) {
          setError('Please fill Symbol, Quantity, and Buy Price fields');
          return;
        }

        const symbolUpper = symbol.toUpperCase();
        const quantityNum = parseFloat(quantity);
        const priceNum = parseFloat(buyPrice);

        if (quantityNum <= 0 || priceNum <= 0) {
          setError('Quantity and buy price must be positive numbers');
          return;
        }

        setLoading(true);
        setError(null);

        try {
          // Add to PortfolioManager
          window.portfolioManager.addHolding(
            symbolUpper,
            quantityNum,
            priceNum,
            buyDate || new Date().toISOString().split('T')[0]
          );

          setNewPosition({ symbol: '', quantity: '', buyPrice: '', buyDate: '' });
          setRefreshKey(k => k + 1); // Force refresh
          setError(null);
        } catch (err) {
          setError(err.message);
        } finally {
          setLoading(false);
        }
      };

      const removePosition = (id) => {
        window.portfolioManager.removeHolding(id);
        setRefreshKey(k => k + 1); // Force refresh
      };

      const exportPortfolioCSV = () => {
        const csvContent = window.portfolioManager.exportToCSV();
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `portfolio-${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      };

      // Get top and worst performers
      const topPerformers = window.portfolioManager.getTopPerformers(metrics, 3);
      const worstPerformers = window.portfolioManager.getWorstPerformers(metrics, 3);

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="glass-elevated rounded-2xl max-w-6xl w-full mx-auto my-8 animate-slide-up max-h-[90vh] overflow-hidden flex flex-col" onClick={(e) => e.stopPropagation()}>
            {/* Header */}
            <div className="flex items-start justify-between p-6 border-b border-slate-700/30 flex-shrink-0">
              <div>
                <h2 className="text-3xl font-bold text-white mb-1">ğŸ“Š Portfolio Tracker</h2>
                <div className="text-sm text-slate-400">Track your investments with real-time P&L calculations</div>
              </div>
              <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>

            {/* Tabs */}
            <div className="flex gap-2 px-6 pt-4 border-b border-slate-700/30">
              <button
                onClick={() => setActiveTab('holdings')}
                className={`px-4 py-2 text-sm font-semibold border-b-2 transition-colors ${activeTab === 'holdings' ? 'border-cyan-400 text-cyan-400' : 'border-transparent text-slate-400 hover:text-slate-200'}`}
              >
                Holdings & Performance
              </button>
              <button
                onClick={() => setActiveTab('health')}
                className={`px-4 py-2 text-sm font-semibold border-b-2 transition-colors ${activeTab === 'health' ? 'border-cyan-400 text-cyan-400' : 'border-transparent text-slate-400 hover:text-slate-200'}`}
              >
                â¤ï¸ Health Check
              </button>
            </div>

            {activeTab === 'holdings' ? (
              <>
                {/* Portfolio Summary Cards */}
                <div className="p-6 border-b border-slate-700/30">
                  <div className="grid grid-cols-4 gap-4">
                    <div className="glass-card p-5 rounded-xl">
                      <div className="text-xs text-slate-500 mb-1 uppercase tracking-wide">Total Value</div>
                      <div className="text-3xl font-bold text-white">
                        ${metrics.totalValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                      </div>
                    </div>
                    <div className="glass-card p-5 rounded-xl">
                      <div className="text-xs text-slate-500 mb-1 uppercase tracking-wide">Total Cost</div>
                      <div className="text-2xl font-bold text-slate-300">
                        ${metrics.totalCost.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                      </div>
                    </div>
                    <div className="glass-card p-5 rounded-xl">
                      <div className="text-xs text-slate-500 mb-1 uppercase tracking-wide">Total Gain/Loss</div>
                      <div className={`text-3xl font-bold ${metrics.totalGainLoss >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                        {metrics.totalGainLoss >= 0 ? '+' : ''}${metrics.totalGainLoss.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                      </div>
                      <div className={`text-sm mt-1 font-semibold ${metrics.totalGainLossPercent >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                        {metrics.totalGainLossPercent >= 0 ? '+' : ''}{metrics.totalGainLossPercent.toFixed(2)}%
                      </div>
                    </div>
                    <div className="glass-card p-5 rounded-xl">
                      <div className="text-xs text-slate-500 mb-1 uppercase tracking-wide">Positions</div>
                      <div className="text-3xl font-bold text-white">{metrics.holdings.length}</div>
                      <div className="text-xs text-slate-500 mt-1">
                        {topPerformers.length > 0 && `Top: ${topPerformers[0].symbol} +${topPerformers[0].gainLossPercent.toFixed(1)}%`}
                      </div>
                    </div>
                  </div>
                </div>

                {/* Add Position Form */}
                <div className="p-6 border-b border-slate-700/30">
                  <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                    <i className="fas fa-plus-circle text-cyan-400"></i>
                    Add New Position
                  </h3>
                  {error && (
                    <div className="mb-4 p-3 bg-red-500/10 border border-red-500/20 rounded-lg flex items-center gap-2">
                      <i className="fas fa-exclamation-triangle text-red-400"></i>
                      <div className="text-red-400 text-sm">{error}</div>
                    </div>
                  )}
                  <div className="grid grid-cols-5 gap-4">
                    <div>
                      <label className="text-xs text-slate-500 mb-1 block uppercase tracking-wide">Symbol *</label>
                      <input
                        type="text"
                        id="position-symbol"
                        name="position-symbol"
                        value={newPosition.symbol}
                        onChange={(e) => setNewPosition({ ...newPosition, symbol: e.target.value.toUpperCase() })}
                        className="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded text-white focus:outline-none focus:border-cyan-500 font-mono"
                        placeholder="AAPL"
                      />
                    </div>
                    <div>
                      <label className="text-xs text-slate-500 mb-1 block uppercase tracking-wide">Quantity *</label>
                      <input
                        type="number"
                        id="position-quantity"
                        name="position-quantity"
                        value={newPosition.quantity}
                        onChange={(e) => setNewPosition({ ...newPosition, quantity: e.target.value })}
                        className="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded text-white focus:outline-none focus:border-cyan-500"
                        placeholder="10"
                        step="0.01"
                      />
                    </div>
                    <div>
                      <label className="text-xs text-slate-500 mb-1 block uppercase tracking-wide">Buy Price ($) *</label>
                      <input
                        type="number"
                        id="position-buy-price"
                        name="position-buy-price"
                        value={newPosition.buyPrice}
                        onChange={(e) => setNewPosition({ ...newPosition, buyPrice: e.target.value })}
                        className="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded text-white focus:outline-none focus:border-cyan-500"
                        placeholder="150.00"
                        step="0.01"
                      />
                    </div>
                    <div>
                      <label className="text-xs text-slate-500 mb-1 block uppercase tracking-wide">Buy Date</label>
                      <input
                        type="date"
                        id="position-buy-date"
                        name="position-buy-date"
                        value={newPosition.buyDate}
                        onChange={(e) => setNewPosition({ ...newPosition, buyDate: e.target.value })}
                        className="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded text-white focus:outline-none focus:border-cyan-500"
                      />
                    </div>
                    <div className="flex items-end">
                      <button
                        onClick={addPosition}
                        disabled={loading}
                        className="w-full px-4 py-2 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 disabled:from-slate-700 disabled:to-slate-700 text-white rounded-lg font-semibold flex items-center justify-center gap-2 transition"
                      >
                        {loading ? (
                          <>
                            <i className="fas fa-spinner animate-spin"></i>
                            Adding...
                          </>
                        ) : (
                          <>
                            <i className="fas fa-plus"></i>
                            Add
                          </>
                        )}
                      </button>
                    </div>
                  </div>
                </div>

                {/* Positions Table */}
                <div className="p-6 overflow-y-auto flex-1">
                  <div className="flex justify-between items-center mb-4">
                    <h3 className="text-lg font-bold text-white flex items-center gap-2">
                      <i className="fas fa-list text-cyan-400"></i>
                      Your Holdings
                    </h3>
                    <button
                      onClick={exportPortfolioCSV}
                      disabled={metrics.holdings.length === 0}
                      className="px-4 py-2 bg-slate-700 hover:bg-slate-600 disabled:bg-slate-800 disabled:cursor-not-allowed text-white rounded-lg font-semibold text-sm flex items-center gap-2 transition"
                    >
                      <i className="fas fa-file-export"></i>
                      Export CSV
                    </button>
                  </div>

                  {metrics.holdings.length === 0 ? (
                    <div className="text-center py-16 text-slate-400">
                      <i className="fas fa-chart-line text-6xl mb-4 text-slate-700"></i>
                      <div className="text-xl font-semibold mb-2">No positions in your portfolio yet</div>
                      <div className="text-sm">Add your first position above to start tracking your investments</div>
                    </div>
                  ) : (
                    <div className="space-y-4">
                      {/* Performance Highlights */}
                      {(topPerformers.length > 0 || worstPerformers.length > 0) && (
                        <div className="grid grid-cols-2 gap-4 mb-6">
                          {topPerformers.length > 0 && (
                            <div className="glass-card p-4 rounded-xl border border-green-500/20">
                              <div className="text-xs text-slate-500 mb-2 uppercase tracking-wide flex items-center gap-2">
                                <i className="fas fa-trophy text-green-400"></i>
                                Top Performers
                              </div>
                              {topPerformers.map((holding, idx) => (
                                <div key={holding.id} className="flex justify-between items-center mb-1">
                                  <span className="text-sm font-mono text-cyan-300">{holding.symbol}</span>
                                  <span className="text-sm font-semibold text-green-400">
                                    +{holding.gainLossPercent.toFixed(2)}%
                                  </span>
                                </div>
                              ))}
                            </div>
                          )}
                          {worstPerformers.length > 0 && (
                            <div className="glass-card p-4 rounded-xl border border-red-500/20">
                              <div className="text-xs text-slate-500 mb-2 uppercase tracking-wide flex items-center gap-2">
                                <i className="fas fa-arrow-down text-red-400"></i>
                                Needs Attention
                              </div>
                              {worstPerformers.map((holding, idx) => (
                                <div key={holding.id} className="flex justify-between items-center mb-1">
                                  <span className="text-sm font-mono text-cyan-300">{holding.symbol}</span>
                                  <span className="text-sm font-semibold text-red-400">
                                    {holding.gainLossPercent.toFixed(2)}%
                                  </span>
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                      )}

                      {/* Portfolio Allocation Charts */}
                      <div className="grid grid-cols-2 gap-4 mb-6">
                        {/* Allocation by Value Pie Chart */}
                        <div className="glass-card p-5 rounded-xl">
                          <h4 className="text-sm font-bold text-slate-400 mb-4 uppercase tracking-wide flex items-center gap-2">
                            <i className="fas fa-chart-pie text-cyan-400"></i>
                            Allocation by Value
                          </h4>
                          <div className="flex items-center justify-center mb-4">
                            <div className="relative w-48 h-48">
                              {/* SVG Donut Chart */}
                              <svg viewBox="0 0 100 100" className="transform -rotate-90">
                                {(() => {
                                  let cumulativePercent = 0;
                                  const colors = ['#06b6d4', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444', '#ec4899', '#6366f1', '#14b8a6'];
                                  return metrics.holdings.map((holding, idx) => {
                                    const percent = (holding.currentValue / metrics.totalValue) * 100;
                                    const strokeDasharray = `${percent} ${100 - percent}`;
                                    const strokeDashoffset = -cumulativePercent;
                                    cumulativePercent += percent;
                                    return (
                                      <circle
                                        key={holding.id}
                                        cx="50"
                                        cy="50"
                                        r="15.915"
                                        fill="transparent"
                                        stroke={colors[idx % colors.length]}
                                        strokeWidth="12"
                                        strokeDasharray={strokeDasharray}
                                        strokeDashoffset={strokeDashoffset}
                                        style={{ transition: 'all 0.3s ease' }}
                                      />
                                    );
                                  });
                                })()}
                              </svg>
                              {/* Center Text */}
                              <div className="absolute inset-0 flex flex-col items-center justify-center">
                                <div className="text-xs text-slate-500">Total</div>
                                <div className="text-lg font-bold text-white">
                                  ${(metrics.totalValue / 1000).toFixed(1)}K
                                </div>
                              </div>
                            </div>
                          </div>
                          {/* Legend */}
                          <div className="space-y-1">
                            {metrics.holdings
                              .sort((a, b) => b.currentValue - a.currentValue)
                              .slice(0, 5)
                              .map((holding, idx) => {
                                const colors = ['#06b6d4', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444'];
                                const percent = (holding.currentValue / metrics.totalValue) * 100;
                                return (
                                  <div key={holding.id} className="flex items-center justify-between text-xs">
                                    <div className="flex items-center gap-2">
                                      <div
                                        className="w-3 h-3 rounded-full"
                                        style={{ backgroundColor: colors[idx % colors.length] }}
                                      ></div>
                                      <span className="font-mono text-slate-300">{holding.symbol}</span>
                                    </div>
                                    <span className="font-semibold text-white">{percent.toFixed(1)}%</span>
                                  </div>
                                );
                              })}
                            {metrics.holdings.length > 5 && (
                              <div className="text-xs text-slate-500 pt-1">
                                +{metrics.holdings.length - 5} more
                              </div>
                            )}
                          </div>
                        </div>

                        {/* Allocation by Sector */}
                        <div className="glass-card p-5 rounded-xl">
                          <h4 className="text-sm font-bold text-slate-400 mb-4 uppercase tracking-wide flex items-center gap-2">
                            <i className="fas fa-layer-group text-purple-400"></i>
                            Allocation by Sector
                          </h4>
                          {(() => {
                            // Group holdings by sector
                            const sectorAllocation = {};
                            metrics.holdings.forEach(holding => {
                              const stock = stocks.find(s => s.symbol === holding.symbol);
                              const sector = stock?.sector || 'Unknown';
                              if (!sectorAllocation[sector]) {
                                sectorAllocation[sector] = 0;
                              }
                              sectorAllocation[sector] += holding.currentValue;
                            });

                            const sectors = Object.entries(sectorAllocation)
                              .map(([sector, value]) => ({
                                sector,
                                value,
                                percent: (value / metrics.totalValue) * 100
                              }))
                              .sort((a, b) => b.value - a.value);

                            return (
                              <div className="space-y-3">
                                {sectors.map((item, idx) => (
                                  <div key={item.sector}>
                                    <div className="flex items-center justify-between text-xs mb-1">
                                      <span className="font-semibold text-slate-300">{item.sector}</span>
                                      <span className="text-white font-mono">{item.percent.toFixed(1)}%</span>
                                    </div>
                                    <div className="w-full bg-slate-700/50 rounded-full h-2 overflow-hidden">
                                      <div
                                        className="h-full rounded-full transition-all duration-500"
                                        style={{
                                          width: `${item.percent}%`,
                                          background: `linear-gradient(90deg, ${idx === 0 ? '#06b6d4, #3b82f6' :
                                              idx === 1 ? '#8b5cf6, #a855f7' :
                                                idx === 2 ? '#10b981, #34d399' :
                                                  idx === 3 ? '#f59e0b, #fbbf24' :
                                                    '#ef4444, #f87171'
                                            })`
                                        }}
                                      />
                                    </div>
                                  </div>
                                ))}
                                {sectors.length === 0 && (
                                  <div className="text-center py-8 text-slate-500 text-sm">
                                    Sector data not available
                                  </div>
                                )}
                              </div>
                            );
                          })()}
                        </div>
                      </div>

                      {/* Performance Over Time Bar Chart */}
                      <div className="glass-card p-5 rounded-xl mb-6">
                        <h4 className="text-sm font-bold text-slate-400 mb-4 uppercase tracking-wide flex items-center gap-2">
                          <i className="fas fa-chart-bar text-green-400"></i>
                          Gain/Loss Distribution
                        </h4>
                        <div className="space-y-3">
                          {metrics.holdings
                            .sort((a, b) => b.gainLossPercent - a.gainLossPercent)
                            .map(holding => {
                              const maxPercent = Math.max(...metrics.holdings.map(h => Math.abs(h.gainLossPercent)));
                              const barWidth = Math.min((Math.abs(holding.gainLossPercent) / maxPercent) * 100, 100);
                              const isPositive = holding.gainLossPercent >= 0;

                              return (
                                <div key={holding.id} className="flex items-center gap-3">
                                  <div className="w-16 text-right">
                                    <span className="font-mono text-xs text-cyan-300 font-semibold">
                                      {holding.symbol}
                                    </span>
                                  </div>
                                  <div className="flex-1 flex items-center">
                                    <div className="relative w-full h-8 bg-slate-700/30 rounded">
                                      <div
                                        className={`absolute top-0 left-1/2 h-full rounded transition-all duration-500 ${isPositive ? 'bg-gradient-to-r from-green-500/80 to-green-400' : 'bg-gradient-to-l from-red-500/80 to-red-400'
                                          }`}
                                        style={{
                                          width: `${barWidth / 2}%`,
                                          [isPositive ? 'left' : 'right']: '50%',
                                          transform: isPositive ? 'none' : 'scaleX(-1)'
                                        }}
                                      ></div>
                                      <div className="absolute inset-0 flex items-center justify-center">
                                        <span className={`text-xs font-bold font-mono ${Math.abs(holding.gainLossPercent) > 5 ? 'text-white' :
                                            isPositive ? 'text-green-400' : 'text-red-400'
                                          }`}>
                                          {isPositive ? '+' : ''}{holding.gainLossPercent.toFixed(2)}%
                                        </span>
                                      </div>
                                    </div>
                                  </div>
                                  <div className="w-24 text-right">
                                    <span className={`text-xs font-mono font-bold ${isPositive ? 'text-green-400' : 'text-red-400'}`}>
                                      {isPositive ? '+' : ''}${holding.gainLoss.toFixed(2)}
                                    </span>
                                  </div>
                                </div>
                              );
                            })}
                        </div>
                      </div>

                      {/* Holdings Table */}
                      <div className="glass rounded-xl overflow-hidden">
                        <table className="w-full text-sm">
                          <thead>
                            <tr className="bg-slate-800/50 text-slate-400 text-xs uppercase tracking-wide">
                              <th className="text-left p-4">Symbol</th>
                              <th className="text-right p-4">Qty</th>
                              <th className="text-right p-4">Buy Price</th>
                              <th className="text-right p-4">Current</th>
                              <th className="text-right p-4">Cost Basis</th>
                              <th className="text-right p-4">Current Value</th>
                              <th className="text-right p-4">Gain/Loss ($)</th>
                              <th className="text-right p-4">Gain/Loss (%)</th>
                              <th className="text-right p-4">Day Change</th>
                              <th className="text-center p-4">Actions</th>
                            </tr>
                          </thead>
                          <tbody>
                            {metrics.holdings.map((holding, index) => (
                              <tr key={holding.id} className="border-t border-slate-700/20 hover:bg-slate-800/30 transition">
                                <td className="p-4">
                                  <div className="font-semibold text-cyan-300 font-mono">{holding.symbol}</div>
                                  <div className="text-xs text-slate-500">{holding.buyDate}</div>
                                </td>
                                <td className="p-4 text-right font-mono text-white">{holding.quantity}</td>
                                <td className="p-4 text-right font-mono text-slate-300">
                                  ${holding.buyPrice.toFixed(2)}
                                </td>
                                <td className="p-4 text-right font-mono text-white font-semibold">
                                  ${holding.currentPrice?.toFixed(2) || 'â€”'}
                                </td>
                                <td className="p-4 text-right font-mono text-slate-300">
                                  ${holding.costBasis?.toFixed(2) || 'â€”'}
                                </td>
                                <td className="p-4 text-right font-mono text-white font-semibold">
                                  ${holding.currentValue?.toFixed(2) || 'â€”'}
                                </td>
                                <td className="p-4 text-right">
                                  <span className={`font-mono font-bold ${holding.gainLoss >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                    {holding.gainLoss >= 0 ? '+' : ''}${holding.gainLoss?.toFixed(2) || 'â€”'}
                                  </span>
                                </td>
                                <td className="p-4 text-right">
                                  <span className={`px-2 py-1 rounded font-mono font-bold text-sm ${holding.gainLossPercent >= 10 ? 'bg-green-500/20 text-green-400' :
                                      holding.gainLossPercent >= 0 ? 'bg-green-500/10 text-green-400' :
                                        holding.gainLossPercent <= -10 ? 'bg-red-500/20 text-red-400' :
                                          'bg-red-500/10 text-red-400'
                                    }`}>
                                    {holding.gainLossPercent >= 0 ? '+' : ''}{holding.gainLossPercent?.toFixed(2) || 'â€”'}%
                                  </span>
                                </td>
                                <td className="p-4 text-right">
                                  <span className={`font-mono text-sm ${holding.dayChange >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                    {holding.dayChange >= 0 ? '+' : ''}{holding.dayChange?.toFixed(2) || '0.00'}%
                                  </span>
                                </td>
                                <td className="p-4 text-center">
                                  <button
                                    onClick={() => removePosition(holding.id)}
                                    className="px-3 py-1 bg-red-600/20 hover:bg-red-600 text-red-400 hover:text-white rounded text-xs transition font-semibold"
                                    title="Remove position"
                                  >
                                    <i className="fas fa-trash"></i>
                                  </button>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                          <tfoot>
                            <tr className="bg-slate-800/70 font-bold border-t-2 border-slate-600">
                              <td colSpan="4" className="p-4 text-right text-slate-300 uppercase tracking-wide">
                                Portfolio Total:
                              </td>
                              <td className="p-4 text-right font-mono text-white">
                                ${metrics.totalCost.toFixed(2)}
                              </td>
                              <td className="p-4 text-right font-mono text-white text-lg">
                                ${metrics.totalValue.toFixed(2)}
                              </td>
                              <td className="p-4 text-right">
                                <span className={`font-mono text-lg ${metrics.totalGainLoss >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                  {metrics.totalGainLoss >= 0 ? '+' : ''}${metrics.totalGainLoss.toFixed(2)}
                                </span>
                              </td>
                              <td className="p-4 text-right">
                                <span className={`px-3 py-1 rounded font-mono text-lg ${metrics.totalGainLossPercent >= 0 ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}`}>
                                  {metrics.totalGainLossPercent >= 0 ? '+' : ''}{metrics.totalGainLossPercent.toFixed(2)}%
                                </span>
                              </td>
                              <td colSpan="2"></td>
                            </tr>
                          </tfoot>
                        </table>
                      </div>
                    </div>
                  )}
                </div>

              </>
            ) : (
              <div className="p-6 overflow-y-auto flex-1 space-y-6">
                {/* Health Check Content */}
                {!health ? (
                  <div className="text-center py-12 text-slate-400">
                    <i className="fas fa-heartbeat text-6xl mb-4 text-slate-700"></i>
                    <div className="text-xl font-semibold mb-2">No Data for Health Check</div>
                    <div className="text-sm">Add positions to your portfolio to see health metrics.</div>
                  </div>
                ) : (
                  <>
                    {/* Top Level Metrics */}
                    <div className="grid grid-cols-3 gap-4">
                      <div className="glass-card p-5 rounded-xl">
                        <div className="text-xs text-slate-500 mb-1 uppercase tracking-wide">Portfolio Beta</div>
                        <div className={`text-3xl font-bold ${health.weightedBeta > 1.2 ? 'text-red-400' : health.weightedBeta < 0.8 ? 'text-blue-400' : 'text-green-400'}`}>
                          {health.weightedBeta.toFixed(2)}
                        </div>
                        <div className="text-xs text-slate-500 mt-1">
                          {health.weightedBeta > 1.2 ? 'High Volatility' : health.weightedBeta < 0.8 ? 'Low Volatility' : 'Moderate Volatility'}
                        </div>
                      </div>
                      <div className="glass-card p-5 rounded-xl">
                        <div className="text-xs text-slate-500 mb-1 uppercase tracking-wide">Top Sector</div>
                        <div className="text-2xl font-bold text-white truncate">
                          {health.maxSector ? health.maxSector[0] : 'â€”'}
                        </div>
                        <div className="text-xs text-slate-500 mt-1">
                          {health.maxSector ? `${(health.maxSector[1] * 100).toFixed(1)}% Allocation` : 'â€”'}
                        </div>
                      </div>
                      <div className="glass-card p-5 rounded-xl">
                        <div className="text-xs text-slate-500 mb-1 uppercase tracking-wide">Diversification Score</div>
                        <div className="text-3xl font-bold text-cyan-400">
                          {Math.min(100, Math.max(0, 100 - (health.maxSector ? health.maxSector[1] * 100 : 0))).toFixed(0)}/100
                        </div>
                        <div className="text-xs text-slate-500 mt-1">
                          Based on concentration
                        </div>
                      </div>
                    </div>

                    {/* AI Insights */}
                    <div className="glass-card p-6 rounded-xl border border-cyan-500/20">
                      <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <i className="fas fa-robot text-cyan-400"></i>
                        AI Portfolio Insights
                      </h3>
                      <div className="space-y-3">
                        {health.insights.length === 0 ? (
                          <div className="text-slate-400 text-sm">
                            <i className="fas fa-check-circle text-green-400 mr-2"></i>
                            Your portfolio looks healthy! No critical warnings.
                          </div>
                        ) : (
                          health.insights.map((insight, idx) => (
                            <div key={idx} className={`p-3 rounded-lg flex items-start gap-3 ${insight.type === 'warning' ? 'bg-red-500/10 border border-red-500/20' : 'bg-blue-500/10 border border-blue-500/20'
                              }`}>
                              <i className={`fas ${insight.type === 'warning' ? 'fa-exclamation-triangle text-red-400' : 'fa-info-circle text-blue-400'} mt-1`}></i>
                              <div className="text-sm text-slate-200">{insight.text}</div>
                            </div>
                          ))
                        )}
                      </div>
                    </div>

                    {/* Risk Analysis */}
                    <div className="glass-card p-6 rounded-xl">
                      <h3 className="text-lg font-bold text-white mb-4">Risk Analysis</h3>
                      <div className="space-y-4">
                        <div>
                          <div className="flex justify-between text-sm mb-1">
                            <span className="text-slate-400">Market Correlation (Beta)</span>
                            <span className="text-white font-bold">{health.weightedBeta.toFixed(2)}</span>
                          </div>
                          <div className="w-full bg-slate-700 rounded-full h-2">
                            <div
                              className={`h-full rounded-full ${health.weightedBeta > 1 ? 'bg-red-400' : 'bg-green-400'}`}
                              style={{ width: `${Math.min(100, health.weightedBeta * 50)}%` }}
                            ></div>
                          </div>
                          <div className="flex justify-between text-xs text-slate-500 mt-1">
                            <span>Low Risk</span>
                            <span>Market Risk (1.0)</span>
                            <span>High Risk</span>
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* Market Crash Simulator */}
                    {metrics.holdings.length > 0 && (
                      <div className="glass-card p-6 rounded-xl border border-purple-500/20">
                        <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                          <i className="fas fa-chart-line text-purple-400"></i>
                          Market Crash Simulator
                        </h3>
                        <MarketCrashSimulator holdings={metrics.holdings} totalValue={metrics.totalValue} />
                      </div>
                    )}
                  </>
                )}
              </div>
            )}

            {/* Footer */}
            <div className="flex justify-between items-center gap-3 p-6 border-t border-slate-700/30 flex-shrink-0">
              <div className="text-xs text-slate-500">
                <i className="fas fa-info-circle mr-1"></i>
                Portfolio data is stored locally in your browser
              </div>
              <button onClick={onClose} className="px-6 py-2.5 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold text-sm transition">
                Close
              </button>
            </div>
          </div>
        </div>
      );
    }


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // GOAL PLANNER, REBALANCING, TAX, AND ADVANCED ANALYTICS - REMOVED
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // HEATMAP MODAL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function HeatmapModal({ onClose, stocks }) {
      const [timeframe, setTimeframe] = useState('1D'); // 1D, 1W, 1M, YTD

      // Group stocks by sector
      const sectors = useMemo(() => {
        const groups = {};
        stocks.forEach(stock => {
          const sector = stock.sector || 'Unknown';
          if (!groups[sector]) groups[sector] = [];
          groups[sector].push(stock);
        });

        // Calculate sector metrics
        return Object.entries(groups).map(([name, items]) => {
          const totalMarketCap = items.reduce((sum, s) => sum + (s.marketCap || 0), 0);
          const avgChange = items.reduce((sum, s) => sum + (s.changePct || 0), 0) / items.length;

          // Sort items by market cap within sector
          items.sort((a, b) => (b.marketCap || 0) - (a.marketCap || 0));

          return {
            name,
            items,
            totalMarketCap,
            avgChange,
            weight: items.length // simplified weight for now
          };
        }).sort((a, b) => b.totalMarketCap - a.totalMarketCap);
      }, [stocks]);

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="glass-elevated rounded-2xl max-w-7xl w-full mx-auto my-8 animate-slide-up max-h-[90vh] overflow-hidden flex flex-col" onClick={(e) => e.stopPropagation()}>
            {/* Header */}
            <div className="flex items-center justify-between p-6 border-b border-slate-700/30 flex-shrink-0">
              <div>
                <h2 className="text-2xl font-bold text-white mb-1">ğŸ—ºï¸ Sector Rotation Heatmap</h2>
                <p className="text-sm text-slate-400">
                  Visualizing {stocks.length} stocks across {sectors.length} sectors
                </p>
              </div>
              <div className="flex items-center gap-3">
                <div className="bg-slate-800 rounded-lg p-1 flex text-xs font-semibold">
                  {['1D'].map(t => (
                    <button
                      key={t}
                      onClick={() => setTimeframe(t)}
                      className={`px-3 py-1.5 rounded-md transition ${timeframe === t ? 'bg-slate-600 text-white shadow' : 'text-slate-400 hover:text-slate-200'}`}
                    >
                      {t}
                    </button>
                  ))}
                </div>
                <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl leading-none">&times;</button>
              </div>
            </div>

            {/* Heatmap Content */}
            <div className="p-6 overflow-y-auto flex-1 bg-slate-900/50">
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                {sectors.map(sector => (
                  <div key={sector.name} className="glass-card flex flex-col overflow-hidden h-[300px]">
                    {/* Sector Header */}
                    <div className="p-3 border-b border-slate-700/30 flex justify-between items-center bg-slate-800/40">
                      <span className="font-bold text-sm text-slate-200 truncate" title={sector.name}>{sector.name}</span>
                      <span className={`text-xs font-bold px-2 py-0.5 rounded ${sector.avgChange >= 0 ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}`}>
                        {sector.avgChange > 0 ? '+' : ''}{sector.avgChange.toFixed(2)}%
                      </span>
                    </div>

                    {/* Stock Grid (Treemap-ish) */}
                    <div className="flex-1 p-2 flex flex-wrap content-start gap-1 overflow-y-auto">
                      {sector.items.map(stock => {
                        // Size based on relative market cap within sector (simplified)
                        // We'll use a simple grid for now, but color is key
                        const change = stock.changePct || 0;
                        const colorClass = change >= 3 ? 'bg-green-500' :
                          change >= 1 ? 'bg-green-600' :
                            change >= 0 ? 'bg-green-700' :
                              change <= -3 ? 'bg-red-500' :
                                change <= -1 ? 'bg-red-600' :
                                  'bg-red-700';

                        // Dynamic sizing based on market cap rank in sector
                        const isLarge = stock.marketCap > sector.totalMarketCap * 0.2;

                        return (
                          <div
                            key={stock.symbol}
                            className={`${colorClass} ${isLarge ? 'w-full h-16' : 'flex-1 min-w-[60px] h-12'} rounded p-2 flex flex-col justify-center items-center cursor-pointer hover:brightness-110 transition relative group overflow-hidden`}
                            onClick={() => window.open(`https://financialmodelingprep.com/financial-summary/${stock.symbol}`, '_blank')}
                            title={`${stock.companyName}: ${change.toFixed(2)}%`}
                          >
                            <span className="font-bold text-white text-xs shadow-black drop-shadow-md">{stock.symbol}</span>
                            <span className="text-[10px] text-white/90 font-semibold drop-shadow-md">
                              {change > 0 ? '+' : ''}{change.toFixed(1)}%
                            </span>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                ))}
              </div>
            </div>

            {/* Legend */}
            <div className="p-4 border-t border-slate-700/30 bg-slate-800/30 flex justify-center gap-6 text-xs">
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 bg-red-600 rounded"></div>
                <span className="text-slate-400">-1% to -3%</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 bg-red-500 rounded"></div>
                <span className="text-slate-400">&lt; -3%</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 bg-green-700 rounded"></div>
                <span className="text-slate-400">0% to +1%</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 bg-green-600 rounded"></div>
                <span className="text-slate-400">+1% to +3%</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 bg-green-500 rounded"></div>
                <span className="text-slate-400">&gt; +3%</span>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PORTFOLIO ALLOCATION MODAL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // GoalPlannerModal, RebalancingDashboard, TaxOptimizationCenter, and AdvancedPortfolioAnalytics components removed

    function PortfolioAllocationModal({ onClose, stocks, watchlist }) {
      const portfolioData = computePortfolioAllocation(stocks, watchlist);

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="glass-elevated rounded-2xl max-w-4xl w-full mx-auto my-8 animate-slide-up max-h-[90vh] overflow-hidden flex flex-col" onClick={(e) => e.stopPropagation()}>
            {/* Header */}
            <div className="flex items-center justify-between p-6 border-b border-slate-700/30 flex-shrink-0">
              <div>
                <h2 className="text-2xl font-bold text-white mb-1">Portfolio Allocation</h2>
                <p className="text-sm text-slate-400">
                  {portfolioData.isEmpty
                    ? 'Add stocks to your watchlist to see allocation breakdown'
                    : `${portfolioData.totalStocks} stocks across ${portfolioData.sectorCount} sectors`
                  }
                </p>
              </div>
              <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>

            {/* Content */}
            <div className="p-6 overflow-y-auto flex-1">
              {portfolioData.isEmpty ? (
                <div className="text-center py-12">
                  <div className="text-6xl mb-4">ğŸ“Š</div>
                  <h3 className="text-xl font-bold text-white mb-2">No Stocks in Watchlist</h3>
                  <p className="text-slate-400 mb-6">
                    Add stocks to your watchlist to see your portfolio allocation breakdown by sector.
                  </p>
                  <button
                    onClick={onClose}
                    className="px-6 py-3 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg font-semibold transition"
                  >
                    Browse Stocks
                  </button>
                </div>
              ) : (
                <div className="space-y-6">
                  {/* Sector Allocation Bars */}
                  <div>
                    <h3 className="text-sm font-bold text-slate-400 mb-4 uppercase tracking-wide">
                      Sector Allocation
                    </h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                      {Object.entries(portfolioData.sectorWeights)
                        .sort((a, b) => b[1] - a[1])
                        .map(([sector, weight]) => (
                          <div key={sector} className="glass-card p-4 rounded-xl">
                            <div className="flex items-center justify-between mb-2">
                              <span className="font-semibold text-white">{sector}</span>
                              <span className="text-cyan-400 font-mono font-bold">{weight.toFixed(1)}%</span>
                            </div>
                            <div className="w-full bg-slate-700/50 rounded-full h-3 overflow-hidden">
                              <div
                                className={`h-full rounded-full bg-gradient-to-r ${getSectorColor(sector)} transition-all duration-500`}
                                style={{ width: `${weight}%` }}
                              />
                            </div>
                            <div className="text-xs text-slate-500 mt-1">
                              {portfolioData.stocks.filter(s => s.sector === sector).length} stock{portfolioData.stocks.filter(s => s.sector === sector).length !== 1 ? 's' : ''}
                            </div>
                          </div>
                        ))}
                    </div>
                  </div>

                  {/* Diversification Insights */}
                  <div className="glass-card p-5 rounded-xl">
                    <h3 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">
                      Diversification Analysis
                    </h3>
                    <div className="grid grid-cols-3 gap-4">
                      <div>
                        <div className="text-xs text-slate-500 mb-1">Total Stocks</div>
                        <div className="text-2xl font-bold text-white">{portfolioData.totalStocks}</div>
                      </div>
                      <div>
                        <div className="text-xs text-slate-500 mb-1">Sectors</div>
                        <div className="text-2xl font-bold text-white">{portfolioData.sectorCount}</div>
                      </div>
                      <div>
                        <div className="text-xs text-slate-500 mb-1">Avg per Stock</div>
                        <div className="text-2xl font-bold text-white">{(100 / portfolioData.totalStocks).toFixed(1)}%</div>
                      </div>
                    </div>

                    {/* Risk Assessment */}
                    {(() => {
                      const maxWeight = Math.max(...Object.values(portfolioData.sectorWeights));
                      const isConcentrated = maxWeight > 50;
                      const isDiversified = portfolioData.sectorCount >= 3 && maxWeight < 40;

                      return (
                        <div className={`mt-4 p-3 rounded-lg ${isConcentrated ? 'bg-yellow-500/10 border border-yellow-500/20' : isDiversified ? 'bg-green-500/10 border border-green-500/20' : 'bg-slate-700/30 border border-slate-600/30'}`}>
                          <div className="flex items-start gap-2">
                            <span className="text-lg">
                              {isConcentrated ? 'âš ï¸' : isDiversified ? 'âœ…' : 'â„¹ï¸'}
                            </span>
                            <div className="flex-1">
                              <div className={`text-xs font-bold uppercase mb-1 ${isConcentrated ? 'text-yellow-400' : isDiversified ? 'text-green-400' : 'text-slate-400'}`}>
                                {isConcentrated ? 'Concentration Risk' : isDiversified ? 'Well Diversified' : 'Moderate Diversification'}
                              </div>
                              <div className="text-xs text-slate-300 leading-relaxed">
                                {isConcentrated
                                  ? `Over ${maxWeight.toFixed(0)}% allocated to one sector. Consider diversifying to reduce risk.`
                                  : isDiversified
                                    ? `Good sector diversification with no single sector exceeding ${maxWeight.toFixed(0)}%.`
                                    : `Consider adding stocks from other sectors to improve diversification.`
                                }
                              </div>
                            </div>
                          </div>
                        </div>
                      );
                    })()}
                  </div>

                  {/* Stock Holdings Table */}
                  <div>
                    <h3 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">
                      Holdings Breakdown
                    </h3>
                    <div className="glass-card rounded-xl overflow-hidden">
                      <table className="w-full text-sm">
                        <thead>
                          <tr className="bg-slate-800/50 text-slate-400 text-xs">
                            <th className="text-left p-3">Symbol</th>
                            <th className="text-left p-3">Name</th>
                            <th className="text-left p-3">Sector</th>
                            <th className="text-right p-3">Weight</th>
                            <th className="text-right p-3">Price</th>
                            <th className="text-center p-3">AI Score</th>
                          </tr>
                        </thead>
                        <tbody>
                          {portfolioData.stocks
                            .sort((a, b) => b.weight - a.weight)
                            .map(stock => (
                              <tr key={stock.symbol} className="border-t border-slate-700/20 hover:bg-slate-700/20 transition">
                                <td className="p-3 font-semibold text-cyan-300">{stock.symbol}</td>
                                <td className="p-3 text-slate-300">{stock.name}</td>
                                <td className="p-3">
                                  <span className="chip bg-slate-700/50 text-slate-300 text-xs">
                                    {stock.sector}
                                  </span>
                                </td>
                                <td className="p-3 text-right font-mono text-white font-semibold">
                                  {stock.weight.toFixed(1)}%
                                </td>
                                <td className="p-3 text-right font-mono text-white">
                                  ${stock.price?.toFixed(2) || 'â€”'}
                                </td>
                                <td className="p-3 text-center">
                                  <span className={`chip ${stock.aiScore >= 80 ? 'bg-green-500/20 text-green-400' :
                                      stock.aiScore >= 65 ? 'bg-cyan-500/20 text-cyan-400' :
                                        stock.aiScore >= 45 ? 'bg-yellow-500/20 text-yellow-400' :
                                          'bg-red-500/20 text-red-400'
                                    }`}>
                                    {stock.aiScore || 'â€”'}
                                  </span>
                                </td>
                              </tr>
                            ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              )}
            </div>

            {/* Footer */}
            <div className="p-6 border-t border-slate-700/30 flex justify-between items-center flex-shrink-0">
              <div className="text-xs text-slate-500">
                Equal-weight allocation assumed. Actual portfolio allocation may vary.
              </div>
              <button
                onClick={onClose}
                className="px-6 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold transition"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ALERTS MODAL COMPONENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function AlertsModal({ onClose, alerts, setAlerts, stocks }) {
      const [newAlert, setNewAlert] = useState({
        symbol: '',
        condition: 'price_above',
        value: '',
        frequency: 'once',
        email: ''
      });
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);

      const conditionOptions = [
        { value: 'price_above', label: 'Price Above' },
        { value: 'price_below', label: 'Price Below' },
        { value: 'price_change_up', label: 'Price Up %' },
        { value: 'price_change_down', label: 'Price Down %' },
        { value: 'rsi_above', label: 'RSI Above' },
        { value: 'rsi_below', label: 'RSI Below' },
        { value: 'pe_above', label: 'P/E Above' },
        { value: 'pe_below', label: 'P/E Below' },
      ];

      const frequencyOptions = [
        { value: 'once', label: 'Once' },
        { value: 'daily', label: 'Daily' },
        { value: 'weekly', label: 'Weekly' },
      ];

      const addAlert = () => {
        const { symbol, condition, value, frequency, email } = newAlert;

        if (!symbol || !value) {
          setError('Please fill all required fields');
          return;
        }

        const symbolUpper = symbol.toUpperCase();
        const valueNum = parseFloat(value);

        if (isNaN(valueNum)) {
          setError('Value must be a number');
          return;
        }

        // Check if email is valid for email alerts
        if (email && !/\S+@\S+\.\S+/.test(email)) {
          setError('Please enter a valid email address');
          return;
        }

        const alertObj = {
          id: Date.now().toString(),
          symbol: symbolUpper,
          condition,
          value: valueNum,
          frequency,
          email: email || null,
          created: new Date().toISOString(),
          lastTriggered: null,
          active: true
        };

        const updated = [...alerts, alertObj];
        setAlerts(updated);
        localStorage.setItem('alerts', JSON.stringify(updated));

        setNewAlert({
          symbol: '',
          condition: 'price_above',
          value: '',
          frequency: 'once',
          email: ''
        });
        setError(null);
      };

      const toggleAlert = (id) => {
        const updated = alerts.map(alert =>
          alert.id === id ? { ...alert, active: !alert.active } : alert
        );
        setAlerts(updated);
        localStorage.setItem('alerts', JSON.stringify(updated));
      };

      const removeAlert = (id) => {
        const updated = alerts.filter(alert => alert.id !== id);
        setAlerts(updated);
        localStorage.setItem('alerts', JSON.stringify(updated));
      };

      const testAlert = (alert) => {
        const stock = stocks.find(s => s.symbol === alert.symbol);
        if (!stock) {
          alert(`Stock ${alert.symbol} not found in current data`);
          return;
        }

        let triggered = false;
        let message = '';

        switch (alert.condition) {
          case 'price_above':
            triggered = stock.price > alert.value;
            message = `${alert.symbol} price $${stock.price.toFixed(2)} is ${triggered ? 'above' : 'below'} $${alert.value}`;
            break;
          case 'price_below':
            triggered = stock.price < alert.value;
            message = `${alert.symbol} price $${stock.price.toFixed(2)} is ${triggered ? 'below' : 'above'} $${alert.value}`;
            break;
          case 'price_change_up':
            triggered = stock.changePct > alert.value;
            message = `${alert.symbol} change ${stock.changePct.toFixed(2)}% is ${triggered ? 'above' : 'below'} ${alert.value}%`;
            break;
          case 'price_change_down':
            triggered = stock.changePct < -alert.value;
            message = `${alert.symbol} change ${stock.changePct.toFixed(2)}% is ${triggered ? 'below' : 'above'} -${alert.value}%`;
            break;
          case 'rsi_above':
            triggered = stock.rsi > alert.value;
            message = `${alert.symbol} RSI ${stock.rsi?.toFixed(0) || 'N/A'} is ${triggered ? 'above' : 'below'} ${alert.value}`;
            break;
          case 'rsi_below':
            triggered = stock.rsi < alert.value;
            message = `${alert.symbol} RSI ${stock.rsi?.toFixed(0) || 'N/A'} is ${triggered ? 'below' : 'above'} ${alert.value}`;
            break;
          case 'pe_above':
            triggered = stock.pe > alert.value;
            message = `${alert.symbol} P/E ${stock.pe?.toFixed(1) || 'N/A'} is ${triggered ? 'above' : 'below'} ${alert.value}`;
            break;
          case 'pe_below':
            triggered = stock.pe < alert.value;
            message = `${alert.symbol} P/E ${stock.pe?.toFixed(1) || 'N/A'} is ${triggered ? 'below' : 'above'} ${alert.value}`;
            break;
        }

        if (triggered) {
          alert(`âœ… Alert would trigger: ${message}`);
        } else {
          alert(`âŒ Alert would not trigger: ${message}`);
        }
      };

      const exportAlertsCSV = () => {
        const data = alerts.map(a => ({
          Symbol: a.symbol,
          Condition: conditionOptions.find(c => c.value === a.condition)?.label || a.condition,
          Value: a.value,
          Frequency: frequencyOptions.find(f => f.value === a.frequency)?.label || a.frequency,
          Email: a.email || 'No email',
          Active: a.active ? 'Yes' : 'No',
          Created: new Date(a.created).toLocaleDateString(),
          'Last Triggered': a.lastTriggered ? new Date(a.lastTriggered).toLocaleDateString() : 'Never'
        }));

        exportToCSV(data, 'alerts.csv');
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="glass-elevated rounded-2xl max-w-4xl w-full mx-auto my-8 animate-slide-up max-h-[90vh] overflow-hidden flex flex-col" onClick={(e) => e.stopPropagation()}>
            {/* Header */}
            <div className="flex items-start justify-between p-6 border-b border-slate-700/30 flex-shrink-0">
              <div>
                <h2 className="text-3xl font-bold text-white">Alerts & Notifications</h2>
                <div className="text-sm text-slate-400 mt-2">Set up price and metric alerts</div>
              </div>
              <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>

            {/* Add Alert Form */}
            <div className="p-6 border-b border-slate-700/30">
              <h3 className="text-lg font-bold text-white mb-4">Create New Alert</h3>
              {error && (
                <div className="mb-4 p-3 bg-red-500/10 border border-red-500/20 rounded-lg">
                  <div className="text-red-400 text-sm">{error}</div>
                </div>
              )}
              <div className="grid grid-cols-5 gap-4">
                <div>
                  <label className="text-xs text-slate-500 mb-1 block">Symbol</label>
                  <input
                    type="text"
                    id="alert-symbol"
                    name="alert-symbol"
                    value={newAlert.symbol}
                    onChange={(e) => setNewAlert({ ...newAlert, symbol: e.target.value })}
                    className="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded text-white focus:outline-none focus:border-cyan-500"
                    placeholder="AAPL"
                  />
                </div>
                <div>
                  <label className="text-xs text-slate-500 mb-1 block">Condition</label>
                  <select
                    value={newAlert.condition}
                    onChange={(e) => setNewAlert({ ...newAlert, condition: e.target.value })}
                    className="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded text-white focus:outline-none focus:border-cyan-500"
                  >
                    {conditionOptions.map(opt => (
                      <option key={opt.value} value={opt.value}>{opt.label}</option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="text-xs text-slate-500 mb-1 block">Value</label>
                  <input
                    type="number"
                    id="alert-value"
                    name="alert-value"
                    value={newAlert.value}
                    onChange={(e) => setNewAlert({ ...newAlert, value: e.target.value })}
                    className="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded text-white focus:outline-none focus:border-cyan-500"
                    placeholder="100"
                    step="0.01"
                  />
                </div>
                <div>
                  <label className="text-xs text-slate-500 mb-1 block">Frequency</label>
                  <select
                    value={newAlert.frequency}
                    onChange={(e) => setNewAlert({ ...newAlert, frequency: e.target.value })}
                    className="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded text-white focus:outline-none focus:border-cyan-500"
                  >
                    {frequencyOptions.map(opt => (
                      <option key={opt.value} value={opt.value}>{opt.label}</option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="text-xs text-slate-500 mb-1 block">Email (optional)</label>
                  <input
                    type="email"
                    id="alert-email"
                    name="alert-email"
                    value={newAlert.email}
                    onChange={(e) => setNewAlert({ ...newAlert, email: e.target.value })}
                    className="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded text-white focus:outline-none focus:border-cyan-500"
                    placeholder="you@example.com"
                  />
                </div>
              </div>
              <div className="mt-4">
                <button
                  onClick={addAlert}
                  className="px-6 py-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg font-semibold"
                >
                  Add Alert
                </button>
              </div>
            </div>

            {/* Alerts List */}
            <div className="p-6 overflow-y-auto flex-1">
              <div className="flex justify-between items-center mb-4">
                <h3 className="text-lg font-bold text-white">Active Alerts ({alerts.filter(a => a.active).length})</h3>
                <button
                  onClick={exportAlertsCSV}
                  className="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold text-sm flex items-center gap-2"
                >
                  <i className="fas fa-file-export"></i>
                  Export CSV
                </button>
              </div>

              {alerts.length === 0 ? (
                <div className="text-center py-12 text-slate-400">
                  <i className="fas fa-bell-slash text-4xl mb-4"></i>
                  <div>No alerts set up yet</div>
                  <div className="text-sm mt-2">Create your first alert above</div>
                </div>
              ) : (
                <div className="space-y-3">
                  {alerts.map((alert, index) => (
                    <div key={alert.id} className="glass-card p-4 rounded-xl">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-4">
                          <div className={`w-3 h-3 rounded-full ${alert.active ? 'bg-green-500' : 'bg-slate-600'}`}></div>
                          <div>
                            <div className="flex items-center gap-2">
                              <span className="font-semibold text-cyan-300">{alert.symbol}</span>
                              <span className="text-xs text-slate-500">
                                {conditionOptions.find(c => c.value === alert.condition)?.label || alert.condition}: {alert.value}
                              </span>
                            </div>
                            <div className="text-xs text-slate-500 mt-1">
                              {frequencyOptions.find(f => f.value === alert.frequency)?.label || alert.frequency} â€¢
                              {alert.email ? ` Email: ${alert.email}` : ' Browser notification only'} â€¢
                              Created: {new Date(alert.created).toLocaleDateString()}
                            </div>
                          </div>
                        </div>
                        <div className="flex gap-2">
                          <button
                            onClick={() => testAlert(alert)}
                            className="px-3 py-1 bg-slate-700 hover:bg-slate-600 text-white rounded text-xs"
                            title="Test alert with current data"
                          >
                            Test
                          </button>
                          <button
                            onClick={() => toggleAlert(alert.id)}
                            className={`px-3 py-1 rounded text-xs ${alert.active ? 'bg-yellow-600 hover:bg-yellow-500' : 'bg-green-600 hover:bg-green-500'} text-white`}
                          >
                            {alert.active ? 'Disable' : 'Enable'}
                          </button>
                          <button
                            onClick={() => removeAlert(alert.id)}
                            className="px-3 py-1 bg-red-600 hover:bg-red-500 text-white rounded text-xs"
                          >
                            Remove
                          </button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>

            {/* Footer */}
            <div className="flex justify-between items-center p-6 border-t border-slate-700/30 flex-shrink-0">
              <div className="text-xs text-slate-500">
                Note: Email alerts require a backend service. Browser alerts will work immediately.
              </div>
              <div className="flex gap-3">
                <button onClick={onClose} className="px-6 py-2.5 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold text-sm">Close</button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // COMPARATIVE ANALYSIS COMPONENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function ComparativeAnalysisModal({ onClose, stocks, selectedSymbols }) {
      const [selectedStocks, setSelectedStocks] = useState(selectedSymbols || []);
      const [comparisonData, setComparisonData] = useState([]);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);

      useEffect(() => {
        if (selectedStocks.length > 0) {
          loadComparisonData();
        }
      }, [selectedStocks]);

      const loadComparisonData = () => {
        setLoading(true);
        setError(null);

        try {
          const data = selectedStocks.map(symbol => {
            const stock = stocks.find(s => s.symbol === symbol);
            if (!stock) return null;

            return {
              symbol: stock.symbol,
              companyName: stock.companyName,
              sector: stock.sector,
              price: stock.price,
              changePct: stock.changePct,
              marketCap: stock.marketCap,
              pe: stock.pe,
              roe: stock.roe,
              revenueGrowth: stock.revenueGrowth,
              grossMargin: stock.grossMargin,
              rsi: stock.rsi,
              aiScore: stock.aiScore,
              verdict: stock.verdict,
              confidence: stock.confidence
            };
          }).filter(Boolean);

          setComparisonData(data);
        } catch (err) {
          setError(err.message);
        } finally {
          setLoading(false);
        }
      };

      const addStockToComparison = (symbol) => {
        if (!selectedStocks.includes(symbol) && selectedStocks.length < 5) {
          setSelectedStocks([...selectedStocks, symbol]);
        }
      };

      const removeStockFromComparison = (symbol) => {
        setSelectedStocks(selectedStocks.filter(s => s !== symbol));
      };

      const exportComparisonCSV = () => {
        const data = comparisonData.map(stock => ({
          Symbol: stock.symbol,
          Company: stock.companyName,
          Sector: stock.sector,
          Price: stock.price,
          'Change %': stock.changePct,
          'Market Cap': stock.marketCap,
          'P/E Ratio': stock.pe,
          'ROE %': stock.roe,
          'Revenue Growth %': stock.revenueGrowth,
          'Gross Margin %': stock.grossMargin,
          RSI: stock.rsi,
          'AI Score': stock.aiScore,
          Verdict: stock.verdict,
          'Confidence %': stock.confidence
        }));

        exportToCSV(data, 'comparison.csv');
      };

      const getBestValue = (metric, higherIsBetter = true) => {
        if (comparisonData.length === 0) return null;

        return comparisonData.reduce((best, current) => {
          const currentVal = current[metric];
          const bestVal = best[metric];

          if (currentVal == null || isNaN(currentVal)) return best;
          if (bestVal == null || isNaN(bestVal)) return current;

          return higherIsBetter ?
            (currentVal > bestVal ? current : best) :
            (currentVal < bestVal ? current : best);
        });
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div id="stock-modal-content" className="glass-elevated rounded-2xl max-w-6xl w-full mx-auto my-8 animate-slide-up max-h-[90vh] overflow-hidden flex flex-col" onClick={(e) => e.stopPropagation()}>
            {/* Header */}
            <div className="flex items-start justify-between p-6 border-b border-slate-700/30 flex-shrink-0">
              <div>
                <h2 className="text-3xl font-bold text-white">Comparative Analysis</h2>
                <div className="text-sm text-slate-400 mt-2">Compare up to 5 stocks side by side</div>
              </div>
              <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>

            {/* Stock Selection */}
            <div className="p-6 border-b border-slate-700/30">
              <div className="flex justify-between items-center mb-4">
                <h3 className="text-lg font-bold text-white">Select Stocks to Compare</h3>
                <div className="text-sm text-slate-400">
                  {selectedStocks.length}/5 stocks selected
                </div>
              </div>

              <div className="flex flex-wrap gap-2 mb-4">
                {selectedStocks.map(symbol => (
                  <div key={symbol} className="flex items-center gap-2 px-3 py-2 bg-cyan-600/20 border border-cyan-500/30 rounded-lg">
                    <span className="text-cyan-300 font-semibold">{symbol}</span>
                    <button
                      onClick={() => removeStockFromComparison(symbol)}
                      className="text-cyan-400 hover:text-cyan-300 text-sm"
                    >
                      âœ•
                    </button>
                  </div>
                ))}
              </div>

              <div className="grid grid-cols-5 gap-2">
                {stocks
                  .filter(stock => !selectedStocks.includes(stock.symbol))
                  .slice(0, 15)
                  .map(stock => (
                    <button
                      key={stock.symbol}
                      onClick={() => addStockToComparison(stock.symbol)}
                      disabled={selectedStocks.length >= 5}
                      className={`px-3 py-2 rounded-lg text-sm font-semibold transition ${selectedStocks.length >= 5
                          ? 'bg-slate-800/50 text-slate-500 cursor-not-allowed'
                          : 'bg-slate-700 hover:bg-slate-600 text-white'
                        }`}
                    >
                      {stock.symbol}
                    </button>
                  ))}
              </div>
            </div>

            {/* Comparison Results */}
            <div className="p-6 overflow-y-auto flex-1">
              {loading ? (
                <div className="text-center py-12">
                  <i className="fas fa-spinner animate-spin text-4xl text-cyan-400 mb-4"></i>
                  <div className="text-slate-400">Loading comparison data...</div>
                </div>
              ) : error ? (
                <div className="text-center py-12">
                  <div className="text-red-400 mb-4">Error: {error}</div>
                  <button
                    onClick={loadComparisonData}
                    className="px-4 py-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg"
                  >
                    Retry
                  </button>
                </div>
              ) : comparisonData.length === 0 ? (
                <div className="text-center py-12 text-slate-400">
                  <i className="fas fa-balance-scale text-4xl mb-4"></i>
                  <div>Select stocks to compare from the list above</div>
                </div>
              ) : (
                <>
                  {/* Best Values Summary */}
                  <div className="mb-6">
                    <h3 className="text-lg font-bold text-white mb-4">Best Values</h3>
                    <div className="grid grid-cols-4 gap-4">
                      <div className="glass-card p-4 rounded-xl">
                        <div className="text-xs text-slate-500 mb-1">Best Value (P/E)</div>
                        <div className="text-lg font-bold text-cyan-300">
                          {getBestValue('pe', false)?.symbol || 'â€”'}
                        </div>
                        <div className="text-sm text-slate-400">
                          {getBestValue('pe', false)?.pe?.toFixed(1) || 'â€”'} P/E
                        </div>
                      </div>
                      <div className="glass-card p-4 rounded-xl">
                        <div className="text-xs text-slate-500 mb-1">Best Quality (ROE)</div>
                        <div className="text-lg font-bold text-cyan-300">
                          {getBestValue('roe', true)?.symbol || 'â€”'}
                        </div>
                        <div className="text-sm text-slate-400">
                          {getBestValue('roe', true)?.roe?.toFixed(1) || 'â€”'}%
                        </div>
                      </div>
                      <div className="glass-card p-4 rounded-xl">
                        <div className="text-xs text-slate-500 mb-1">Best Growth</div>
                        <div className="text-lg font-bold text-cyan-300">
                          {getBestValue('revenueGrowth', true)?.symbol || 'â€”'}
                        </div>
                        <div className="text-sm text-slate-400">
                          {getBestValue('revenueGrowth', true)?.revenueGrowth?.toFixed(1) || 'â€”'}%
                        </div>
                      </div>
                      <div className="glass-card p-4 rounded-xl">
                        <div className="text-xs text-slate-500 mb-1">Best AI Score</div>
                        <div className="text-lg font-bold text-cyan-300">
                          {getBestValue('aiScore', true)?.symbol || 'â€”'}
                        </div>
                        <div className="text-sm text-slate-400">
                          {getBestValue('aiScore', true)?.aiScore || 'â€”'}/100
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Comparison Table */}
                  <div className="glass rounded-xl overflow-hidden">
                    <div className="overflow-x-auto">
                      <table className="w-full text-sm">
                        <thead>
                          <tr className="bg-slate-800/50 text-slate-400">
                            <th className="text-left p-4">Metric</th>
                            {comparisonData.map(stock => (
                              <th key={stock.symbol} className="text-center p-4">
                                <div className="font-semibold text-cyan-300">{stock.symbol}</div>
                                <div className="text-xs text-slate-500">{stock.companyName}</div>
                              </th>
                            ))}
                          </tr>
                        </thead>
                        <tbody>
                          {[
                            { label: 'Price', key: 'price', format: (v) => `$${v?.toFixed(2) || 'â€”'}` },
                            { label: 'Change %', key: 'changePct', format: (v) => formatPercent(v) },
                            { label: 'Market Cap', key: 'marketCap', format: (v) => formatNumber(v) },
                            { label: 'P/E Ratio', key: 'pe', format: (v) => v?.toFixed(1) || 'â€”' },
                            { label: 'ROE %', key: 'roe', format: (v) => v?.toFixed(1) + '%' || 'â€”' },
                            { label: 'Revenue Growth %', key: 'revenueGrowth', format: (v) => v?.toFixed(1) + '%' || 'â€”' },
                            { label: 'Gross Margin %', key: 'grossMargin', format: (v) => v?.toFixed(1) + '%' || 'â€”' },
                            { label: 'RSI', key: 'rsi', format: (v) => v?.toFixed(0) || 'â€”' },
                            { label: 'AI Score', key: 'aiScore', format: (v) => v?.toFixed(0) + '/100' || 'â€”' },
                            { label: 'Verdict', key: 'verdict', format: (v) => v || 'â€”' },
                            { label: 'Confidence %', key: 'confidence', format: (v) => v?.toFixed(0) + '%' || 'â€”' },
                          ].map((row, rowIndex) => (
                            <tr key={row.key} className="border-t border-slate-700/20">
                              <td className="p-4 text-slate-400 font-medium">{row.label}</td>
                              {comparisonData.map((stock, colIndex) => {
                                const value = stock[row.key];
                                let cellClass = 'text-center p-4 font-mono';

                                // Add color coding for some metrics
                                if (row.key === 'changePct') {
                                  cellClass += ` ${getSentimentColor(value)}`;
                                } else if (row.key === 'rsi') {
                                  if (value < 30) cellClass += ' text-green-400';
                                  else if (value > 70) cellClass += ' text-red-400';
                                  else cellClass += ' text-white';
                                } else if (row.key === 'aiScore') {
                                  if (value >= 70) cellClass += ' text-green-400';
                                  else if (value >= 55) cellClass += ' text-yellow-400';
                                  else cellClass += ' text-red-400';
                                } else {
                                  cellClass += ' text-white';
                                }

                                return (
                                  <td key={`${row.key}-${colIndex}`} className={cellClass}>
                                    {row.format(value)}
                                  </td>
                                );
                              })}
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>

                  {/* Sector Distribution */}
                  <div className="mt-6">
                    <h3 className="text-lg font-bold text-white mb-4">Sector Distribution</h3>
                    <div className="grid grid-cols-3 gap-4">
                      {Array.from(new Set(comparisonData.map(s => s.sector))).map(sector => {
                        const sectorStocks = comparisonData.filter(s => s.sector === sector);
                        const avgPE = sectorStocks.reduce((sum, s) => sum + (s.pe || 0), 0) / sectorStocks.length;
                        const avgROE = sectorStocks.reduce((sum, s) => sum + (s.roe || 0), 0) / sectorStocks.length;

                        return (
                          <div key={sector} className="glass-card p-4 rounded-xl">
                            <div className="text-sm font-semibold text-white mb-2">{sector}</div>
                            <div className="text-xs text-slate-500 mb-1">Stocks: {sectorStocks.length}</div>
                            <div className="text-xs text-slate-400">Avg P/E: {avgPE.toFixed(1)}</div>
                            <div className="text-xs text-slate-400">Avg ROE: {avgROE.toFixed(1)}%</div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                </>
              )}
            </div>

            {/* Footer */}
            <div className="flex justify-between items-center p-6 border-t border-slate-700/30 flex-shrink-0">
              <div className="text-sm text-slate-400">
                {comparisonData.length} stocks compared
              </div>
              <div className="flex gap-3">
                <button
                  onClick={exportComparisonCSV}
                  className="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold text-sm flex items-center gap-2"
                >
                  <i className="fas fa-file-export"></i>
                  Export CSV
                </button>
                <button onClick={onClose} className="px-6 py-2.5 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold text-sm">Close</button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // REBALANCING, TAX, AND ADVANCED ANALYTICS - REMOVED
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // RebalancingDashboard, TaxOptimizationCenter, and AdvancedPortfolioAnalytics components removed

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SMART ALERTS & NOTIFICATIONS SYSTEM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Alert Manager - Store and manage all alerts
    class AlertManager {
      constructor() {
        this.alerts = this.loadAlerts();
        this.subscribers = [];
      }

      loadAlerts() {
        try {
          const stored = localStorage.getItem('re_alerts');
          return stored ? JSON.parse(stored) : [];
        } catch (e) {
          return [];
        }
      }

      saveAlerts() {
        try {
          localStorage.setItem('re_alerts', JSON.stringify(this.alerts));
        } catch (e) {
          console.error('Failed to save alerts:', e);
        }
      }

      addAlert(alert) {
        const newAlert = {
          id: Date.now().toString(),
          timestamp: new Date().toISOString(),
          read: false,
          ...alert
        };
        this.alerts.unshift(newAlert);
        if (this.alerts.length > 100) {
          this.alerts = this.alerts.slice(0, 100); // Keep last 100 alerts
        }
        this.saveAlerts();
        return newAlert;
      }

      removeAlert(id) {
        this.alerts = this.alerts.filter(a => a.id !== id);
        this.saveAlerts();
      }

      markAsRead(alertId) {
        const alert = this.alerts.find(a => a.id === alertId);
        if (alert) {
          alert.read = true;
          this.saveAlerts();
        }
      }

      markAllAsRead() {
        this.alerts.forEach(a => a.read = true);
        this.saveAlerts();
      }

      getUnreadCount() {
        return this.alerts.filter(a => !a.read).length;
      }

      subscribe(callback) {
        this.subscribers.push(callback);
        return () => {
          this.subscribers = this.subscribers.filter(cb => cb !== callback);
        };
      }

      notifySubscribers() {
        this.subscribers.forEach(cb => cb(this.alerts));
      }
    }

    // Initialize global alert manager
    if (!window.alertManager) {
      window.alertManager = new AlertManager();
    }

    // Monitor portfolio for alerts
    const checkPortfolioAlerts = (portfolio, prevPrices = {}) => {
      if (!portfolio || portfolio.length === 0) return;

      portfolio.forEach(position => {
        const currentPrice = position.currentPrice;
        const prevPrice = prevPrices[position.symbol];

        if (prevPrice && currentPrice) {
          const changePercent = ((currentPrice - prevPrice) / prevPrice) * 100;

          // Alert on significant price movements (>5%)
          if (Math.abs(changePercent) >= 5) {
            window.alertManager.addAlert({
              type: 'price',
              symbol: position.symbol,
              title: `${position.symbol} ${changePercent > 0 ? 'Up' : 'Down'} ${Math.abs(changePercent).toFixed(1)}%`,
              message: `Price moved from $${prevPrice.toFixed(2)} to $${currentPrice.toFixed(2)}`,
              priority: Math.abs(changePercent) >= 10 ? 'high' : 'medium',
              data: { price: currentPrice, change: changePercent }
            });
          }

          // Alert on reaching profit/loss thresholds
          const costBasis = position.costBasis || position.currentPrice;
          const gainPercent = ((currentPrice - costBasis) / costBasis) * 100;

          if (gainPercent >= 20 && !prevPrices[`alerted_gain_${position.symbol}`]) {
            window.alertManager.addAlert({
              type: 'profit',
              symbol: position.symbol,
              title: `${position.symbol} Up 20%+ from Cost Basis`,
              message: `Consider taking profits. Current gain: ${gainPercent.toFixed(1)}%`,
              priority: 'medium',
              data: { gain: gainPercent }
            });
            prevPrices[`alerted_gain_${position.symbol}`] = true;
          }

          if (gainPercent <= -15 && !prevPrices[`alerted_loss_${position.symbol}`]) {
            window.alertManager.addAlert({
              type: 'loss',
              symbol: position.symbol,
              title: `${position.symbol} Down 15%+ from Cost Basis`,
              message: `Consider tax-loss harvesting or reassessing position. Current loss: ${Math.abs(gainPercent).toFixed(1)}%`,
              priority: 'high',
              data: { loss: Math.abs(gainPercent) }
            });
            prevPrices[`alerted_loss_${position.symbol}`] = true;
          }
        }
      });
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FINANCIAL CALCULATOR UTILITIES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Helper function for "What if I waited?" calculator
    async function getPriceOnDate(symbol, date) {
      try {
        const response = await fetch(
          `https://financialmodelingprep.com/api/v3/historical-price-full/${symbol}?from=${date}&to=${date}&apikey=${FMP_API_KEY}`
        );
        const data = await response.json();
        return data?.historical?.[0]?.close || null;
      } catch (error) {
        console.error('Error fetching historical price:', error);
        return null;
      }
    }

    // Helper function for DCA simulation
    async function getHistoricalDataForDCA(symbol, months = 12) {
      try {
        const endDate = new Date();
        const startDate = new Date();
        startDate.setMonth(startDate.getMonth() - months);

        const response = await fetch(
          `https://financialmodelingprep.com/api/v3/historical-price-full/${symbol}?from=${startDate.toISOString().split('T')[0]}&to=${endDate.toISOString().split('T')[0]}&apikey=${FMP_API_KEY}`
        );
        const data = await response.json();
        return data?.historical || [];
      } catch (error) {
        console.error('Error fetching historical data:', error);
        return [];
      }
    }

    // Savings rate calculator
    function calculateSavingsRate(income, expenses, investments = 0) {
      const savings = income - expenses;
      const totalSavings = savings + investments;
      return (totalSavings / income) * 100;
    }

    // Financial independence calculator
    function calculateFIProgress(currentAssets, annualExpenses) {
      const fiTarget = annualExpenses * 25; // 4% rule
      const progress = (currentAssets / fiTarget) * 100;
      const yearsToFI = currentAssets > 0 ? Math.log(fiTarget / currentAssets) / Math.log(1.07) : Infinity; // 7% assumed return

      return {
        progress: Math.min(100, Math.max(0, progress)),
        yearsToFI: Math.max(0, yearsToFI),
        fiTarget,
        monthlySavingsNeeded: yearsToFI < Infinity ? (fiTarget - currentAssets) / (yearsToFI * 12) : 0
      };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UX ENHANCEMENT UTILITIES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Filter persistence manager
    class FilterManager {
      constructor() {
        this.STORAGE_KEY = 'retailedge_filters';
      }

      saveFilters(filters) {
        try {
          localStorage.setItem(this.STORAGE_KEY, JSON.stringify(filters));
        } catch (e) {
          console.warn('Failed to save filters:', e);
        }
      }

      loadFilters() {
        try {
          const saved = localStorage.getItem(this.STORAGE_KEY);
          return saved ? JSON.parse(saved) : null;
        } catch (e) {
          console.warn('Failed to load filters:', e);
          return null;
        }
      }

      clearFilters() {
        localStorage.removeItem(this.STORAGE_KEY);
      }
    }

    // Export manager for CSV/JSON
    const ExportManager = {
      exportToCSV(stocks, filename = 'stocks.csv') {
        const headers = ['Symbol', 'Name', 'Price', 'Change%', 'P/E', 'ROE%', 'Market Cap', 'Sector'];
        const csvRows = [
          headers.join(','),
          ...stocks.map(stock => [
            stock.symbol,
            `"${stock.companyName?.replace(/"/g, '""') || stock.name || ''}"`,
            stock.price || stock.currentPrice || 0,
            stock.changePct || 0,
            stock.pe || 0,
            stock.roe || 0,
            stock.marketCap || 0,
            stock.sector || ''
          ].join(','))
        ];

        const csv = csvRows.join('\\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      },

      exportToJSON(stocks, filename = 'stocks.json') {
        const data = {
          exportDate: new Date().toISOString(),
          count: stocks.length,
          stocks: stocks
        };

        const json = JSON.stringify(data, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      }
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SYMBOL CLEANING UTILITY
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Remove exchange suffixes from stock symbols
    function cleanSymbol(symbol) {
      if (!symbol || typeof symbol !== 'string') return symbol;

      // Remove common exchange suffixes
      // Examples: AAPL.O -> AAPL, MSFT.K -> MSFT, GOOGL.US -> GOOGL
      return symbol
        .toUpperCase()
        .replace(/\.(O|K|US|NS|PK|F|DE|TO|L|HK|T|SS|SZ|AX|NZ|MI|PA|AS|BR|MC|SW|CO|ST|HE|OL|LS|IC|V|WA|PR|MX|BA|SA|SN|CA|CN|JK|BK|KL|TW|KS|KQ|BO|NE)$/i, '')
        .trim();
    }

    // Watchlist groups manager
    class WatchlistManager {
      constructor() {
        this.STORAGE_KEY = 'retailedge_watchlist_groups';
        this.groups = this.loadGroups();
      }

      loadGroups() {
        try {
          const saved = localStorage.getItem(this.STORAGE_KEY);
          return saved ? JSON.parse(saved) : {
            'My Watchlist': [],
            'Tech Stocks': [],
            'Dividend Stocks': [],
            'Growth Stocks': []
          };
        } catch (e) {
          console.warn('Failed to load watchlist groups:', e);
          return {};
        }
      }

      saveGroups() {
        try {
          localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.groups));
        } catch (e) {
          console.warn('Failed to save watchlist groups:', e);
        }
      }

      addGroup(name, symbols = []) {
        this.groups[name] = symbols;
        this.saveGroups();
      }

      removeGroup(name) {
        delete this.groups[name];
        this.saveGroups();
      }

      addToGroup(groupName, symbol) {
        if (!this.groups[groupName]) {
          this.groups[groupName] = [];
        }
        if (!this.groups[groupName].includes(symbol)) {
          this.groups[groupName].push(symbol);
          this.saveGroups();
        }
      }

      removeFromGroup(groupName, symbol) {
        if (this.groups[groupName]) {
          this.groups[groupName] = this.groups[groupName].filter(s => s !== symbol);
          this.saveGroups();
        }
      }

      getGroupsForSymbol(symbol) {
        return Object.entries(this.groups)
          .filter(([_, symbols]) => symbols.includes(symbol))
          .map(([name]) => name);
      }

      getAllGroups() {
        return this.groups;
      }

      // Import watchlist from various formats
      importFromText(text, groupName = 'Imported Watchlist') {
        try {
          // Common header words to skip
          const headerWords = new Set([
            'SYMBOL', 'NAME', 'LAST', 'OPEN', 'HIGH', 'LOW', 'CHG', 'VOL', 'VOLUME',
            'TIME', 'DATE', 'CLOSE', 'CHANGE', 'PRICE', 'CHANGE%', 'CHG.', 'VOL.',
            'BUY', 'SELL', 'HOLD', 'RSI', 'MACD', 'EPS', 'REVENUE', 'DAILY', 'HOURLY',
            'YTD', 'BETA', 'NEUTRAL', 'INC.', 'MONGODB', 'REVENUE', 'EARNINGS', 'PE',
            'MARKET', 'CAP', 'SECTOR', 'INDUSTRY', 'DIVIDEND', 'YIELD'
          ]);

          // Clean and split the text by common delimiters
          const symbols = text
            .replace(/[,;\s\n\r\t]+/g, ',') // Replace delimiters with comma
            .split(',')
            .map(s => cleanSymbol(s.trim())) // Clean exchange suffixes
            .filter(s => s &&
              s.length > 0 &&
              s.length <= 10 &&
              /^[A-Z]+$/.test(s) &&
              !headerWords.has(s)); // Validate symbols and filter headers

          if (symbols.length === 0) {
            throw new Error('No valid symbols found');
          }

          this.addGroup(groupName, symbols);
          return { success: true, count: symbols.length, symbols };
        } catch (error) {
          return { success: false, error: error.message };
        }
      }

      // Import from CSV file
      async importFromCSV(file, groupName = 'CSV Import') {
        try {
          const text = await file.text();
          const lines = text.split('\n').filter(l => l.trim()); // Remove empty lines
          const symbols = [];

          // Common CSV header words to skip
          const headerWords = new Set([
            'SYMBOL', 'NAME', 'LAST', 'OPEN', 'HIGH', 'LOW', 'CHG', 'VOL', 'VOLUME',
            'TIME', 'DATE', 'CLOSE', 'CHANGE', 'PRICE', 'CHANGE%', 'CHG.', 'VOL.',
            'BUY', 'SELL', 'HOLD', 'RSI', 'MACD', 'EPS', 'REVENUE', 'DAILY', 'HOURLY',
            'YTD', 'BETA', 'NEUTRAL', 'INC.', 'MONGODB', 'REVENUE', 'EARNINGS', 'PE',
            'MARKET', 'CAP', 'SECTOR', 'INDUSTRY', 'DIVIDEND', 'YIELD'
          ]);

          // Skip first line if it looks like headers
          let startIndex = 0;
          if (lines.length > 0) {
            const firstLine = lines[0].toUpperCase();
            const firstParts = firstLine.split(',').map(p => p.trim().replace(/"/g, ''));
            // If first line contains common header words, skip it
            if (firstParts.some(part => headerWords.has(part))) {
              startIndex = 1;
            }
          }

          // Try to detect symbol column
          for (let i = startIndex; i < lines.length; i++) {
            const line = lines[i];
            const parts = line.split(',').map(p => p.trim().replace(/"/g, ''));
            // Look for valid stock symbols (1-10 chars, letters only after cleaning)
            for (const part of parts) {
              const cleaned = cleanSymbol(part);
              // Validate: 1-10 chars, letters only, not a header word
              if (cleaned &&
                cleaned.length > 0 &&
                cleaned.length <= 10 &&
                /^[A-Z]+$/.test(cleaned) &&
                !headerWords.has(cleaned)) {
                if (!symbols.includes(cleaned)) {
                  symbols.push(cleaned);
                }
              }
            }
          }

          if (symbols.length === 0) {
            throw new Error('No valid symbols found in CSV');
          }

          this.addGroup(groupName, symbols);
          return { success: true, count: symbols.length, symbols };
        } catch (error) {
          return { success: false, error: error.message };
        }
      }

      // Import from JSON file
      async importFromJSON(file, groupName = 'JSON Import') {
        try {
          const text = await file.text();
          const data = JSON.parse(text);

          let symbols = [];

          // Handle different JSON structures
          if (Array.isArray(data)) {
            // Array of symbols or objects with symbol property
            symbols = data
              .map(item => typeof item === 'string' ? item : item.symbol || item.Symbol)
              .filter(s => s)
              .map(s => cleanSymbol(s.trim()));
          } else if (data.symbols && Array.isArray(data.symbols)) {
            symbols = data.symbols.map(s => cleanSymbol(s.trim()));
          } else if (data.watchlist && Array.isArray(data.watchlist)) {
            symbols = data.watchlist.map(s => cleanSymbol(s.trim()));
          }

          if (symbols.length === 0) {
            throw new Error('No valid symbols found in JSON');
          }

          this.addGroup(groupName, symbols);
          return { success: true, count: symbols.length, symbols };
        } catch (error) {
          return { success: false, error: error.message };
        }
      }

      // Export watchlist to various formats
      exportToText(groupName) {
        const symbols = this.groups[groupName] || [];
        return symbols.join('\n');
      }

      exportToCSV(groupName) {
        const symbols = this.groups[groupName] || [];
        return 'Symbol\n' + symbols.join('\n');
      }

      exportToJSON(groupName) {
        const symbols = this.groups[groupName] || [];
        return JSON.stringify({
          name: groupName,
          exportDate: new Date().toISOString(),
          count: symbols.length,
          symbols: symbols
        }, null, 2);
      }
    }

    // Data quality validator
    class DataValidator {
      static validateStock(stock) {
        const warnings = [];

        if (!stock.symbol) warnings.push('Missing symbol');
        if (stock.price <= 0) warnings.push('Invalid price');
        if (Math.abs(stock.changePct) > 100) warnings.push('Suspicious price change');
        if (stock.pe && stock.pe > 1000) warnings.push('Extreme P/E ratio');
        if (stock.roe && Math.abs(stock.roe) > 1000) warnings.push('Extreme ROE');

        return {
          isValid: warnings.length === 0,
          warnings,
          score: this.calculateDataQualityScore(stock)
        };
      }

      static calculateDataQualityScore(stock) {
        let score = 0;
        const fields = [
          'symbol', 'price', 'changePct', 'marketCap', 'pe', 'roe',
          'revenueGrowth', 'grossMargin', 'debtToEquity', 'rsi'
        ];

        fields.forEach(field => {
          if (stock[field] !== undefined && stock[field] !== null) {
            score += 10;
          }
        });

        return Math.min(100, score);
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // KEYBOARD SHORTCUTS SYSTEM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    class KeyboardShortcuts {
      constructor() {
        this.shortcuts = new Map();
        this.enabled = true;
      }

      init() {
        document.addEventListener('keydown', this.handleKeyDown.bind(this));
        console.log('âŒ¨ï¸ Keyboard shortcuts enabled');
      }

      register(shortcut, callback, description) {
        this.shortcuts.set(shortcut, { callback, description });
      }

      handleKeyDown(e) {
        if (!this.enabled || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
          return;
        }

        const key = e.key.toLowerCase();
        const ctrl = e.ctrlKey || e.metaKey;
        const shift = e.shiftKey;
        const alt = e.altKey;

        let shortcut = '';
        if (ctrl) shortcut += 'ctrl+';
        if (shift) shortcut += 'shift+';
        if (alt) shortcut += 'alt+';
        shortcut += key;

        const handler = this.shortcuts.get(shortcut);
        if (handler) {
          e.preventDefault();
          handler.callback();
        }
      }

      getHelp() {
        return Array.from(this.shortcuts.entries()).map(([key, { description }]) => ({ key, description }));
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ENHANCED TOOLTIP COMPONENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function EnhancedTooltip({ content, children, position = 'top', width = 280, delay = 300 }) {
      const [visible, setVisible] = useState(false);
      const [coords, setCoords] = useState({ x: 0, y: 0 });
      const timeoutRef = useRef(null);
      const tooltipRef = useRef(null);

      const showTooltip = (e) => {
        const rect = e.currentTarget.getBoundingClientRect();
        setCoords({
          x: rect.left + rect.width / 2,
          y: rect.top
        });

        clearTimeout(timeoutRef.current);
        timeoutRef.current = setTimeout(() => setVisible(true), delay);
      };

      const hideTooltip = () => {
        clearTimeout(timeoutRef.current);
        setVisible(false);
      };

      useEffect(() => {
        return () => clearTimeout(timeoutRef.current);
      }, []);

      // Position tooltip
      useEffect(() => {
        if (visible && tooltipRef.current) {
          const tooltip = tooltipRef.current;
          let left = coords.x - width / 2;
          let top = coords.y - tooltip.offsetHeight - 10;

          // Keep within viewport
          if (left < 10) left = 10;
          if (left + width > window.innerWidth - 10) {
            left = window.innerWidth - width - 10;
          }
          if (top < 10) {
            top = coords.y + 30; // Show below instead
          }

          tooltip.style.left = `${left}px`;
          tooltip.style.top = `${top}px`;
        }
      }, [visible, coords, width]);

      return React.createElement('div', {
        className: 'relative inline-block',
        onMouseEnter: showTooltip,
        onMouseLeave: hideTooltip,
        onFocus: showTooltip,
        onBlur: hideTooltip
      },
        children,
        visible && React.createElement('div', {
          ref: tooltipRef,
          className: 'fixed z-[9999] glass-card p-3 rounded-lg border border-slate-700 shadow-xl animate-fade-in',
          style: { width: `${width}px` }
        },
          React.createElement('div', {
            className: 'text-xs text-slate-200 leading-relaxed'
          }, content),
          React.createElement('div', {
            className: 'absolute bottom-0 left-1/2 transform -translate-x-1/2 translate-y-1/2 rotate-45 w-3 h-3 bg-slate-800 border-r border-b border-slate-700'
          })
        )
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DATA QUALITY INDICATOR
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function DataQualityIndicator({ stock }) {
      if (!stock || !stock.symbol) return null;

      const validation = DataValidator.validateStock(stock);
      const score = validation.score;

      const getColor = (score) => {
        if (score >= 80) return 'text-green-400 bg-green-400';
        if (score >= 60) return 'text-yellow-400 bg-yellow-400';
        return 'text-red-400 bg-red-400';
      };

      const colors = getColor(score);

      return (
        <div className="flex items-center gap-2">
          <div className="text-xs text-slate-500">Data Quality:</div>
          <div className={`text-xs font-bold ${colors.split(' ')[0]}`}>
            {score}%
          </div>
          <div className="w-16 bg-slate-700 rounded-full h-1.5 overflow-hidden">
            <div
              className={`h-full ${colors.split(' ')[1]}`}
              style={{ width: `${score}%` }}
            ></div>
          </div>
        </div>
      );
    }

    // Initialize global managers
    if (!window.filterManager) {
      window.filterManager = new FilterManager();
    }
    if (!window.watchlistManager) {
      window.watchlistManager = new WatchlistManager();
    }
    if (!window.keyboardShortcuts) {
      window.keyboardShortcuts = new KeyboardShortcuts();
      window.keyboardShortcuts.init();
    }

    // Watchlist Import/Export Component
    function WatchlistImporter({ onClose, onImportSuccess }) {
      const [importMethod, setImportMethod] = useState('text'); // text, csv, json
      const [textInput, setTextInput] = useState('');
      const [groupName, setGroupName] = useState('Imported Watchlist');
      const [loading, setLoading] = useState(false);
      const [result, setResult] = useState(null);
      const fileInputRef = useRef(null);

      const handleTextImport = async () => {
        setLoading(true);
        setResult(null);

        const importResult = window.watchlistManager.importFromText(textInput, groupName);
        setResult(importResult);
        setLoading(false);

        if (importResult.success && onImportSuccess) {
          setTimeout(() => {
            onImportSuccess(importResult);
            onClose();
          }, 1500);
        }
      };

      const handleFileImport = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        setLoading(true);
        setResult(null);

        let importResult;
        if (importMethod === 'csv') {
          importResult = await window.watchlistManager.importFromCSV(file, groupName);
        } else if (importMethod === 'json') {
          importResult = await window.watchlistManager.importFromJSON(file, groupName);
        }

        setResult(importResult);
        setLoading(false);

        if (importResult.success && onImportSuccess) {
          setTimeout(() => {
            onImportSuccess(importResult);
            onClose();
          }, 1500);
        }
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="glass-elevated rounded-2xl max-w-2xl w-full mx-auto my-8 animate-slide-up" onClick={(e) => e.stopPropagation()}>
            <div className="flex items-center justify-between p-6 border-b border-slate-700/30">
              <div>
                <h2 className="text-2xl font-bold text-white mb-1 flex items-center gap-2">
                  <i className="fas fa-file-import text-cyan-400"></i>
                  Import Watchlist
                </h2>
                <p className="text-sm text-slate-400">Add stocks from text, CSV, or JSON file</p>
              </div>
              <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>

            <div className="p-6 space-y-6">
              {/* Import Method Selection */}
              <div>
                <label className="text-sm text-slate-400 mb-2 block">Import Method</label>
                <div className="flex gap-2">
                  {[
                    { id: 'text', label: 'Paste Text', icon: 'fa-keyboard' },
                    { id: 'csv', label: 'CSV File', icon: 'fa-file-csv' },
                    { id: 'json', label: 'JSON File', icon: 'fa-file-code' }
                  ].map(method => (
                    <button
                      key={method.id}
                      onClick={() => setImportMethod(method.id)}
                      className={`flex-1 py-3 px-4 rounded-lg font-semibold text-sm transition flex items-center justify-center gap-2 ${importMethod === method.id
                          ? 'bg-cyan-500/20 border-2 border-cyan-500/50 text-cyan-300'
                          : 'bg-slate-800/50 border-2 border-slate-700/50 text-slate-400 hover:bg-slate-700/50'
                        }`}
                    >
                      <i className={`fas ${method.icon}`}></i>
                      {method.label}
                    </button>
                  ))}
                </div>
              </div>

              {/* Group Name Input */}
              <div>
                <label className="text-sm text-slate-400 mb-2 block">Watchlist Group Name</label>
                <input
                  type="text"
                  value={groupName}
                  onChange={(e) => setGroupName(e.target.value)}
                  className="w-full px-4 py-2.5 bg-slate-900/50 border border-slate-700/50 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:border-cyan-500/50"
                  placeholder="Enter group name..."
                />
              </div>

              {/* Text Input Method */}
              {importMethod === 'text' && (
                <div>
                  <label className="text-sm text-slate-400 mb-2 block">
                    Paste Stock Symbols (comma, space, or newline separated)
                  </label>
                  <textarea
                    value={textInput}
                    onChange={(e) => setTextInput(e.target.value)}
                    className="w-full h-40 px-4 py-3 bg-slate-900/50 border border-slate-700/50 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:border-cyan-500/50 font-mono text-sm"
                    placeholder="AAPL, MSFT, GOOGL&#10;TSLA NVDA AMD&#10;META AMZN"
                  />
                  <div className="text-xs text-slate-500 mt-2">
                    <i className="fas fa-info-circle"></i> Supports: AAPL, MSFT GOOGL or AAPL\nMSFT\nGOOGL formats
                  </div>
                </div>
              )}

              {/* File Input Methods */}
              {(importMethod === 'csv' || importMethod === 'json') && (
                <div>
                  <label className="text-sm text-slate-400 mb-2 block">
                    Select {importMethod.toUpperCase()} File
                  </label>
                  <input
                    ref={fileInputRef}
                    type="file"
                    accept={importMethod === 'csv' ? '.csv' : '.json'}
                    onChange={handleFileImport}
                    className="hidden"
                  />
                  <button
                    onClick={() => fileInputRef.current?.click()}
                    className="w-full py-12 border-2 border-dashed border-slate-700/50 rounded-lg hover:border-cyan-500/50 hover:bg-slate-800/30 transition flex flex-col items-center justify-center gap-3 text-slate-400 hover:text-cyan-400"
                  >
                    <i className={`fas fa-cloud-upload-alt text-4xl`}></i>
                    <div className="font-semibold">Click to upload {importMethod.toUpperCase()} file</div>
                    <div className="text-xs text-slate-500">or drag and drop</div>
                  </button>
                </div>
              )}

              {/* Result Message */}
              {result && (
                <div className={`p-4 rounded-lg border ${result.success
                    ? 'bg-green-500/10 border-green-500/30 text-green-400'
                    : 'bg-red-500/10 border-red-500/30 text-red-400'
                  }`}>
                  <div className="flex items-center gap-2 font-semibold mb-1">
                    <i className={`fas ${result.success ? 'fa-check-circle' : 'fa-exclamation-circle'}`}></i>
                    {result.success ? 'Import Successful!' : 'Import Failed'}
                  </div>
                  <div className="text-sm">
                    {result.success
                      ? `Imported ${result.count} symbol${result.count !== 1 ? 's' : ''} to "${groupName}"`
                      : result.error}
                  </div>
                  {result.success && result.symbols && (
                    <div className="mt-2 text-xs opacity-75">
                      {result.symbols.slice(0, 10).join(', ')}
                      {result.symbols.length > 10 && ` ... +${result.symbols.length - 10} more`}
                    </div>
                  )}
                </div>
              )}
            </div>

            {/* Footer */}
            <div className="flex justify-between items-center p-6 border-t border-slate-700/30">
              <button
                onClick={onClose}
                className="px-6 py-2.5 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold text-sm transition"
              >
                Cancel
              </button>
              {importMethod === 'text' && (
                <button
                  onClick={handleTextImport}
                  disabled={loading || !textInput.trim()}
                  className={`px-6 py-2.5 rounded-lg font-semibold text-sm transition flex items-center gap-2 ${loading || !textInput.trim()
                      ? 'bg-slate-700/50 text-slate-500 cursor-not-allowed'
                      : 'bg-cyan-600 hover:bg-cyan-500 text-white'
                    }`}
                >
                  {loading ? (
                    <>
                      <i className="fas fa-spinner animate-spin"></i>
                      Importing...
                    </>
                  ) : (
                    <>
                      <i className="fas fa-file-import"></i>
                      Import Watchlist
                    </>
                  )}
                </button>
              )}
            </div>
          </div>
        </div>
      );
    }

    // Notification Bell Component
    function NotificationBell({ onClose }) {
      const [alerts, setAlerts] = useState(window.alertManager.alerts);

      useEffect(() => {
        const unsubscribe = window.alertManager.subscribe(setAlerts);
        return unsubscribe;
      }, []);

      const unreadCount = window.alertManager.getUnreadCount();

      const getPriorityColor = (priority) => {
        switch (priority) {
          case 'high': return '#ef4444';
          case 'medium': return '#f59e0b';
          case 'low': return '#06b6d4';
          default: return '#64748b';
        }
      };

      const getAlertIcon = (type) => {
        switch (type) {
          case 'price': return 'fa-chart-line';
          case 'earnings': return 'fa-calendar-alt';
          case 'dividend': return 'fa-money-bill-wave';
          case 'news': return 'fa-newspaper';
          case 'analyst': return 'fa-user-tie';
          default: return 'fa-bell';
        }
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="glass-elevated rounded-2xl max-w-2xl w-full mx-auto my-8 animate-slide-up max-h-[90vh] overflow-hidden flex flex-col" onClick={(e) => e.stopPropagation()}>
            <div className="flex items-center justify-between p-6 border-b border-slate-700/30 flex-shrink-0">
              <div>
                <h2 className="text-2xl font-bold text-white mb-1 flex items-center gap-2">
                  <i className="fas fa-bell text-cyan-400"></i>
                  Notifications
                  {unreadCount > 0 && (
                    <span className="px-3 py-1 bg-red-500 text-white text-xs font-bold rounded-full">
                      {unreadCount}
                    </span>
                  )}
                </h2>
                <p className="text-sm text-slate-400">Stay updated with important portfolio alerts</p>
              </div>
              <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>

            <div className="flex items-center justify-between px-6 py-3 border-b border-slate-700/30 bg-slate-800/30">
              <div className="text-sm text-slate-400">
                {alerts.length} notification{alerts.length !== 1 ? 's' : ''}
              </div>
              <div className="flex gap-2">
                {unreadCount > 0 && (
                  <button
                    onClick={() => window.alertManager.markAllAsRead()}
                    className="px-3 py-1.5 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg text-xs font-semibold transition"
                  >
                    Mark All Read
                  </button>
                )}
                {alerts.length > 0 && (
                  <button
                    onClick={() => {
                      if (confirm('Clear all notifications?')) {
                        window.alertManager.clearAll();
                      }
                    }}
                    className="px-3 py-1.5 bg-red-600 hover:bg-red-500 text-white rounded-lg text-xs font-semibold transition"
                  >
                    Clear All
                  </button>
                )}
              </div>
            </div>

            <div className="overflow-y-auto flex-1 p-4">
              {alerts.length === 0 ? (
                <div className="text-center py-20">
                  <i className="far fa-bell text-6xl text-slate-700 mb-4"></i>
                  <div className="text-lg font-semibold text-white mb-2">No Notifications</div>
                  <div className="text-sm text-slate-400">You're all caught up!</div>
                </div>
              ) : (
                <div className="space-y-2">
                  {alerts.map(alert => (
                    <div
                      key={alert.id}
                      className={`p-4 rounded-lg border cursor-pointer transition ${alert.read
                          ? 'bg-slate-800/30 border-slate-700/50'
                          : 'bg-cyan-500/10 border-cyan-500/30'
                        }`}
                      onClick={() => window.alertManager.markAsRead(alert.id)}
                    >
                      <div className="flex items-start gap-3">
                        <div
                          className="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0"
                          style={{ background: `${getPriorityColor(alert.priority)}20` }}
                        >
                          <i
                            className={`fas ${getAlertIcon(alert.type)}`}
                            style={{ color: getPriorityColor(alert.priority) }}
                          ></i>
                        </div>
                        <div className="flex-1 min-w-0">
                          <div className="flex items-start justify-between gap-2 mb-1">
                            <div className="text-white font-bold">{alert.title}</div>
                            {!alert.read && (
                              <div className="w-2 h-2 bg-cyan-400 rounded-full flex-shrink-0 mt-2"></div>
                            )}
                          </div>
                          <div className="text-sm text-slate-300 mb-2">{alert.message}</div>
                          <div className="flex items-center justify-between">
                            <div className="text-xs text-slate-500">
                              {new Date(alert.timestamp).toLocaleString()}
                            </div>
                            {alert.symbol && (
                              <div className="px-2 py-0.5 bg-slate-700 text-white text-xs font-bold rounded">
                                {alert.symbol}
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>

            <div className="flex justify-end items-center p-4 border-t border-slate-700/30 flex-shrink-0">
              <button onClick={onClose} className="px-6 py-2.5 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold text-sm transition">
                Close
              </button>
            </div>
          </div>
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // REAL-TIME PRICE TICKER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function LivePriceTicker({ stocks, watchlist, isConnected }) {
      const [tickerStocks, setTickerStocks] = useState([]);
      const [currentIndex, setCurrentIndex] = useState(0);

      useEffect(() => {
        const watchlistStocks = stocks.filter(s => watchlist && Array.isArray(watchlist) && watchlist.some(w => w && w.toUpperCase() === s.symbol.toUpperCase()));
        setTickerStocks(watchlistStocks);
      }, [stocks, watchlist]);

      useEffect(() => {
        if (tickerStocks.length === 0) return;

        const interval = setInterval(() => {
          setCurrentIndex(prev => (prev + 1) % tickerStocks.length);
        }, 3000);

        return () => clearInterval(interval);
      }, [tickerStocks.length]);

      if (tickerStocks.length === 0) return null;

      const visibleStocks = tickerStocks.slice(0, 5);

      return (
        <div className="bg-slate-900/50 border-b border-slate-700/30 py-2 overflow-hidden">
          <div className="max-w-7xl mx-auto px-4">
            <div className="flex items-center gap-6 overflow-x-auto">
              <div className="flex items-center gap-2 flex-shrink-0">
                <div className={`w-2 h-2 rounded-full ${isConnected ? 'bg-green-500 animate-pulse' : 'bg-yellow-500'}`}></div>
                <span className="text-xs text-slate-400 font-semibold uppercase tracking-wide">
                  {isConnected ? 'Live' : 'Delayed'}
                </span>
              </div>

              {visibleStocks.map(stock => {
                const changePct = stock.changePct || stock.changesPercentage || 0;
                const isPositive = changePct >= 0;

                return (
                  <div key={stock.symbol} className="flex items-center gap-3 flex-shrink-0 animate-fade-in">
                    <span className="text-white font-bold text-sm">{stock.symbol}</span>
                    <span className="text-white text-sm">
                      ${stock.price?.toFixed(2) || 'â€”'}
                    </span>
                    <span className={`text-sm font-semibold ${isPositive ? 'text-green-400' : 'text-red-400'}`}>
                      {isPositive ? 'â–²' : 'â–¼'} {Math.abs(changePct).toFixed(2)}%
                    </span>
                  </div>
                );
              })}

              {tickerStocks.length > 5 && (
                <span className="text-slate-500 text-xs">
                  +{tickerStocks.length - 5} more
                </span>
              )}
            </div>
          </div>
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // LIVE HEATMAP COMPONENTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Live indicator component
    function LiveIndicator({ active }) {
      return (
        <div className={`flex items-center gap-1 px-2 py-1 rounded-full text-xs font-semibold ${active ? 'bg-green-500/20 text-green-400' : 'bg-slate-700 text-slate-400'
          }`}>
          <div className={`w-1.5 h-1.5 rounded-full ${active ? 'bg-green-400 animate-pulse' : 'bg-slate-500'}`}></div>
          {active ? 'LIVE' : 'DELAYED'}
        </div>
      );
    }

    // API Status Banner component
    function APIStatusBanner({ realtimeData }) {
      const { connected } = realtimeData.getStatus();

      return (
        <div className={`flex items-center gap-2 px-3 py-2 rounded-lg text-xs ${connected
            ? 'bg-green-500/10 border border-green-500/30 text-green-400'
            : 'bg-yellow-500/10 border border-yellow-500/30 text-yellow-400'
          } mb-4`}>
          <i className={`fas ${connected ? 'fa-check-circle' : 'fa-exclamation-triangle'}`}></i>
          <span>
            {connected
              ? `Real-time updates active (${realtimeData.getStatus().subscribedSymbols.length} symbols)`
              : 'Using 5-second polling (Finnhub WebSocket unavailable)'}
          </span>
        </div>
      );
    }

    // Live Heatmap component
    function RealtimeHeatmap({ stocks, onStockClick }) {
      const [heatmapData, setHeatmapData] = useState([]);
      const [lastManualRefresh, setLastManualRefresh] = useState(Date.now());
      const [isRefreshing, setIsRefreshing] = useState(false);

      const REFRESH_INTERVAL = 3600000; // 60 minutes

      // Initialize heatmap data
      useEffect(() => {
        const initialData = stocks.map(stock => ({
          symbol: stock.symbol,
          name: stock.name || stock.symbol,
          price: stock.price,
          changePct: stock.changePct,
          volume: stock.volume,
          marketCap: stock.marketCap,
          sector: stock.sector || 'Other',
          lastUpdate: Date.now(),
          isStale: false
        }));
        setHeatmapData(initialData);
      }, [stocks]);

      // Process update (called by poller)
      const processUpdate = (stockData) => {
        const { symbol, price, changesPercentage, volume } = stockData;

        setHeatmapData(prev => {
          const idx = prev.findIndex(s => s.symbol === symbol);
          if (idx === -1) return prev;

          const updated = [...prev];
          const stock = { ...updated[idx] };

          if (price) stock.price = price;
          if (changesPercentage !== undefined) stock.changePct = changesPercentage;
          if (volume) stock.volume = volume;

          stock.lastUpdate = Date.now();
          stock.isStale = false;

          updated[idx] = stock;
          return updated;
        });
      };

      // Subscribe with 60-minute frequency
      useEffect(() => {
        if (!stocks.length) return;

        const isBrowser = typeof window !== 'undefined';

        stocks.forEach(stock => {
          if (isBrowser && typeof smartPoller !== 'undefined') {
            // Use 60-minute frequency in browsers
            smartPoller.startPolling(stock.symbol, processUpdate, REFRESH_INTERVAL);
          } else if (typeof realtimeData !== 'undefined') {
            // Non-browser: use default WebSocket
            realtimeData.subscribe(stock.symbol, processUpdate);
          }
        });

        return () => {
          stocks.forEach(stock => {
            if (isBrowser && typeof smartPoller !== 'undefined') {
              smartPoller.stopPolling(stock.symbol);
            } else if (typeof realtimeData !== 'undefined') {
              realtimeData.unsubscribe(stock.symbol, processUpdate);
            }
          });
        };
      }, [stocks]);

      // Check for stale data (older than 65 minutes)
      useEffect(() => {
        const interval = setInterval(() => {
          const staleThreshold = Date.now() - (65 * 60 * 1000);
          setHeatmapData(prev => prev.map(stock => ({
            ...stock,
            isStale: stock.lastUpdate < staleThreshold
          })));
        }, 60000); // Check every minute

        return () => clearInterval(interval);
      }, []);

      // Manual refresh function
      const handleManualRefresh = async () => {
        if (typeof smartFetch === 'undefined') {
          console.error('smartFetch is not available');
          return;
        }

        setIsRefreshing(true);
        setLastManualRefresh(Date.now());

        // Force refresh all stocks
        const refreshPromises = stocks.map(stock =>
          smartFetch('quote', stock.symbol)
            .then(result => {
              if (result?.data?.[0]) {
                processUpdate({
                  symbol: stock.symbol,
                  price: result.data[0].price,
                  changesPercentage: result.data[0].changesPercentage,
                  volume: result.data[0].volume
                });
              }
            })
            .catch(err => console.warn(`Refresh failed for ${stock.symbol}:`, err))
        );

        await Promise.allSettled(refreshPromises);
        setIsRefreshing(false);
      };

      // Get color based on performance
      const getHeatColor = (changePct) => {
        if (changePct > 5) return 'bg-green-600';
        if (changePct > 2) return 'bg-green-500';
        if (changePct > 0) return 'bg-green-400';
        if (changePct > -2) return 'bg-yellow-500';
        if (changePct > -5) return 'bg-orange-500';
        return 'bg-red-600';
      };

      // Get size based on market cap
      const getSizeClass = (marketCap) => {
        if (!marketCap) return 'w-24 h-16';
        if (marketCap > 100e9) return 'w-32 h-20';
        if (marketCap > 10e9) return 'w-28 h-18';
        if (marketCap > 2e9) return 'w-24 h-16';
        return 'w-20 h-14';
      };

      return (
        <div className="glass-card p-6 rounded-xl mb-6 border border-slate-700/50">
          {/* Header */}
          <div className="flex items-center justify-between mb-4">
            <div className="flex items-center gap-2">
              <h3 className="text-xl font-bold text-white flex items-center gap-2">
                <i className="fas fa-fire text-orange-400"></i>
                Market Heatmap
              </h3>
              <span className={`text-xs px-2 py-1 rounded-full ${(typeof realtimeData !== 'undefined' && realtimeData?.isConnected) ? 'bg-green-500/20 text-green-300' : 'bg-orange-500/20 text-orange-300'
                }`}>
                {(typeof realtimeData !== 'undefined' && realtimeData?.isConnected) ? 'Live' : '60-min Updates'}
              </span>
            </div>

            <div className="flex items-center gap-3">
              <DataFreshnessIndicator timestamp={lastManualRefresh} type="heatmap" />

              {/* Manual Refresh Button */}
              <button
                onClick={handleManualRefresh}
                disabled={isRefreshing}
                className="px-3 py-1.5 bg-slate-700 hover:bg-slate-600 disabled:opacity-50 text-white rounded-lg text-sm flex items-center gap-2"
              >
                {isRefreshing ? (
                  <><i className="fas fa-spinner animate-spin"></i> Refreshing...</>
                ) : (
                  <><i className="fas fa-sync"></i> Refresh Now</>
                )}
              </button>
            </div>
          </div>

          {/* Heatmap Grid */}
          <div className="grid grid-cols-6 md:grid-cols-8 lg:grid-cols-10 xl:grid-cols-12 gap-2 max-h-96 overflow-y-auto p-2">
            {heatmapData.map(stock => (
              <div
                key={stock.symbol}
                onClick={() => onStockClick(stock)}
                className={`${getHeatColor(stock.changePct)} ${getSizeClass(stock.marketCap)} 
                  rounded-lg p-2 cursor-pointer transition transform hover:scale-105 
                  flex flex-col justify-between relative group border border-transparent hover:border-white/20`}
              >
                {/* Real-time update indicator (hidden after 5 min) */}
                {!stock.isStale && (
                  <div className="absolute top-1 right-1 w-2 h-2 bg-green-400 rounded-full"></div>
                )}

                {/* Stale indicator */}
                {stock.isStale && (
                  <div className="absolute top-1 right-1 w-2 h-2 bg-yellow-400 rounded-full" title="Data may be stale"></div>
                )}

                <div>
                  <div className="text-white font-bold text-xs">{stock.symbol}</div>
                  <div className="text-white/90 text-xs font-mono">${stock.price?.toFixed(2)}</div>
                </div>

                <div>
                  <div className={`text-xs font-bold ${stock.changePct > 0 ? 'text-white' : 'text-red-100'}`}>
                    {stock.changePct > 0 ? '+' : ''}{stock.changePct?.toFixed(1)}%
                  </div>
                  {stock.volume && (
                    <div className="text-white/70 text-[10px]">
                      {formatNumber(stock.volume)}
                    </div>
                  )}
                </div>
              </div>
            ))}
          </div>

          {/* Footer Info */}
          <div className="mt-4 flex items-center justify-between text-xs text-slate-400">
            <div>
              <span className="mr-4">Click stock for details</span>
              <span>Updates every 60 minutes during market hours</span>
            </div>
            <div>Last refresh: {new Date(lastManualRefresh).toLocaleTimeString()}</div>
          </div>
        </div>
      );
    }

    // Keep LiveHeatmap as alias for backward compatibility
    const LiveHeatmap = RealtimeHeatmap;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TOURNAMENT LOGS TAB COMPONENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function TournamentLogsTab() {
      const [trades, setTrades] = useState([]);
      const [teams, setTeams] = useState([]);
      const [portfolioHistory, setPortfolioHistory] = useState([]);
      const [isLoading, setIsLoading] = useState(false);
      const [tournamentRunning, setTournamentRunning] = useState(false);
      const [lastUpdate, setLastUpdate] = useState(null);
      const [marketStatus, setMarketStatus] = useState({ open: false, message: '' });
      const [dataSource, setDataSource] = useState('');
      const [watchlistCount, setWatchlistCount] = useState(0);
      const [selectedTeam, setSelectedTeam] = useState(null);
      const chartContainerRef = useRef(null);
      const chartRef = useRef(null);
      const seriesRef = useRef({});

      const loadTournamentLogs = async () => {
        setIsLoading(true);
        try {
          const response = await fetch(`${API_BASE_URL}/api/tournament/results`);
          if (response.ok) {
            const data = await response.json();
            setTrades(data.trades || []);
            setTeams(data.teams || []);
            setPortfolioHistory(data.portfolioHistory || []);
            setTournamentRunning(data.status === 'running');
            setMarketStatus({ open: data.marketOpen, message: data.marketMessage });
            setDataSource(data.dataSource || 'Unknown');
            setWatchlistCount(data.watchlistCount || 0);
            setLastUpdate(new Date());
          }

          // Also check current status
          const statusResponse = await fetch(`${API_BASE_URL}/api/tournament/status/current`);
          if (statusResponse.ok) {
            const statusData = await statusResponse.json();
            setTournamentRunning(statusData.status === 'running');
          }
        } catch (err) {
          console.error('Error loading tournament logs:', err);
        } finally {
          setIsLoading(false);
        }
      };

      useEffect(() => {
        loadTournamentLogs();
        // Refresh every 30 seconds for more real-time updates
        const interval = setInterval(loadTournamentLogs, 30000);
        return () => clearInterval(interval);
      }, []);

      // Team colors for the chart
      const teamColors = {
        'Claude (Sonnet)': '#22c55e',    // Green
        'Kimi': '#ef4444',               // Red
        'DeepSeek V3': '#3b82f6',        // Blue
        'Gemini Pro': '#f59e0b'          // Yellow/Orange
      };

      // Initialize and update chart
      useEffect(() => {
        if (!chartContainerRef.current || !window.LightweightCharts || portfolioHistory.length < 2) return;

        // Clean up existing chart
        if (chartRef.current) {
          chartRef.current.remove();
          chartRef.current = null;
          seriesRef.current = {};
        }

        // Create new chart
        const chart = window.LightweightCharts.createChart(chartContainerRef.current, {
          width: chartContainerRef.current.clientWidth,
          height: 300,
          layout: {
            background: { type: 'solid', color: 'transparent' },
            textColor: '#9ca3af'
          },
          grid: {
            vertLines: { color: 'rgba(255, 255, 255, 0.05)' },
            horzLines: { color: 'rgba(255, 255, 255, 0.05)' }
          },
          crosshair: {
            mode: window.LightweightCharts.CrosshairMode.Normal
          },
          rightPriceScale: {
            borderColor: 'rgba(255, 255, 255, 0.1)',
            scaleMargins: { top: 0.1, bottom: 0.1 }
          },
          timeScale: {
            borderColor: 'rgba(255, 255, 255, 0.1)',
            timeVisible: true
          }
        });

        chartRef.current = chart;

        // Get unique team names from history
        const teamNames = portfolioHistory.length > 0
          ? portfolioHistory[0].teams.map(t => t.name)
          : [];

        // Create a line series for each team
        teamNames.forEach(teamName => {
          const series = chart.addLineSeries({
            color: teamColors[teamName] || '#888888',
            lineWidth: 2,
            title: teamName,
            priceFormat: {
              type: 'custom',
              formatter: (price) => '$' + price.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 })
            }
          });

          // Prepare data for this team
          const data = portfolioHistory.map((point, idx) => {
            const teamData = point.teams.find(t => t.name === teamName);
            return {
              time: idx, // Use index as time for simplicity
              value: teamData ? teamData.portfolioValue : 50000
            };
          });

          series.setData(data);
          seriesRef.current[teamName] = series;
        });

        // Fit content
        chart.timeScale().fitContent();

        // Handle resize
        const handleResize = () => {
          if (chartContainerRef.current && chartRef.current) {
            chartRef.current.applyOptions({ width: chartContainerRef.current.clientWidth });
          }
        };
        window.addEventListener('resize', handleResize);

        return () => {
          window.removeEventListener('resize', handleResize);
          if (chartRef.current) {
            chartRef.current.remove();
            chartRef.current = null;
          }
        };
      }, [portfolioHistory]);

      // Calculate team-specific stats
      const getTeamStats = (teamName) => {
        const teamTrades = trades.filter(t => t.team === teamName);
        const buys = teamTrades.filter(t => t.action === 'BUY');
        const sells = teamTrades.filter(t => t.action === 'SELL');
        const totalBuyValue = buys.reduce((sum, t) => sum + (t.price * t.shares), 0);
        const totalSellValue = sells.reduce((sum, t) => sum + (t.price * t.shares), 0);

        // Get unique symbols traded
        const symbolsTraded = [...new Set(teamTrades.map(t => t.symbol))];

        return {
          totalTrades: teamTrades.length,
          buyCount: buys.length,
          sellCount: sells.length,
          totalBuyValue,
          totalSellValue,
          symbolsTraded,
          recentTrades: teamTrades.slice(0, 10)
        };
      };

      return (
        <div className="space-y-6 animate-slide-up">
          {/* Header */}
          <div className="glass-card p-6 rounded-xl border border-purple-500/30">
            <div className="flex items-center justify-between mb-4">
              <div>
                <h3 className="text-xl font-bold text-white flex items-center gap-2">
                  <i className="fas fa-robot text-purple-400"></i>
                  AI Trading Tournament
                  {tournamentRunning && (
                    <span className="ml-2 px-2 py-1 bg-green-500/20 text-green-400 text-xs rounded-full flex items-center gap-1">
                      <span className="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span>
                      LIVE
                    </span>
                  )}
                </h3>
                <p className="text-slate-400 text-sm mt-1">
                  AI teams trade autonomously during US market hours (9:30 AM - 4:00 PM ET)
                </p>
                <div className="flex items-center gap-4 mt-2 text-xs">
                  <span className={`px-2 py-1 rounded ${marketStatus.open ? 'bg-green-500/20 text-green-400' : 'bg-orange-500/20 text-orange-400'}`}>
                    <i className={`fas ${marketStatus.open ? 'fa-door-open' : 'fa-door-closed'} mr-1`}></i>
                    {marketStatus.message || 'Loading...'}
                  </span>
                  {dataSource && (
                    <span className="px-2 py-1 rounded bg-cyan-500/20 text-cyan-400">
                      <i className="fas fa-database mr-1"></i>
                      {dataSource}
                    </span>
                  )}
                  {watchlistCount > 0 && (
                    <span className="px-2 py-1 rounded bg-purple-500/20 text-purple-400">
                      <i className="fas fa-list mr-1"></i>
                      {watchlistCount} Stocks
                    </span>
                  )}
                </div>
              </div>

              <button
                onClick={loadTournamentLogs}
                disabled={isLoading}
                className="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold text-sm flex items-center gap-2 transition disabled:opacity-50"
              >
                <i className={`fas fa-sync-alt ${isLoading ? 'animate-spin' : ''}`}></i>
                Refresh
              </button>
            </div>

            {lastUpdate && (
              <p className="text-slate-500 text-xs mb-4">
                Last updated: {lastUpdate.toLocaleTimeString()} | Auto-refresh every 30s
              </p>
            )}

            {/* Team Stats Cards */}
            {teams.length > 0 && (
              <div className="mb-6">
                <h4 className="text-lg font-semibold text-white mb-3 flex items-center gap-2">
                  <i className="fas fa-trophy text-yellow-400"></i>
                  Team Standings
                </h4>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                  {teams.sort((a, b) => b.portfolioValue - a.portfolioValue).map((team, idx) => {
                    const stats = getTeamStats(team.name);
                    const totalPnL = (team.realizedPnL || 0) + (team.unrealizedPnL || 0);
                    const pnlPercent = ((totalPnL / 50000) * 100).toFixed(2);
                    const isPositive = totalPnL >= 0;
                    const holdingsCount = team.holdings?.length || Object.keys(team.holdings || {}).length || 0;

                    return (
                      <div
                        key={team.id}
                        onClick={() => setSelectedTeam(selectedTeam === team.name ? null : team.name)}
                        className={`p-4 rounded-xl border cursor-pointer transition-all hover:scale-[1.02] ${
                          selectedTeam === team.name
                            ? 'border-purple-500 bg-purple-500/10'
                            : 'border-slate-700 bg-slate-800/50 hover:border-slate-600'
                        }`}
                      >
                        {/* Rank Badge */}
                        <div className="flex items-center justify-between mb-3">
                          <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm ${
                            idx === 0 ? 'bg-yellow-500/20 text-yellow-400' :
                            idx === 1 ? 'bg-slate-400/20 text-slate-300' :
                            idx === 2 ? 'bg-orange-600/20 text-orange-400' :
                            'bg-slate-700 text-slate-400'
                          }`}>
                            #{idx + 1}
                          </div>
                          <span className="text-xs text-slate-500">{team.strategy}</span>
                        </div>

                        {/* Team Name */}
                        <h5 className="font-bold text-white mb-1">{team.name}</h5>
                        <p className="text-xs text-slate-500 mb-3">{team.model}</p>

                        {/* Portfolio Value */}
                        <div className="mb-3">
                          <p className="text-2xl font-bold text-white">
                            ${team.portfolioValue?.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                          </p>
                          <p className={`text-sm font-semibold ${isPositive ? 'text-green-400' : 'text-red-400'}`}>
                            {isPositive ? '+' : ''}{pnlPercent}% ({isPositive ? '+' : ''}${totalPnL.toFixed(2)})
                          </p>
                        </div>

                        {/* P/L Breakdown */}
                        <div className="grid grid-cols-2 gap-2 text-xs mb-2">
                          <div className="bg-slate-900/50 p-2 rounded">
                            <p className="text-slate-500">Cash</p>
                            <p className="text-cyan-400 font-semibold">${(team.cash || 50000).toLocaleString(undefined, {maximumFractionDigits: 0})}</p>
                          </div>
                          <div className="bg-slate-900/50 p-2 rounded">
                            <p className="text-slate-500">Invested</p>
                            <p className="text-amber-400 font-semibold">${(team.invested || 0).toLocaleString(undefined, {maximumFractionDigits: 0})}</p>
                          </div>
                          <div className="bg-slate-900/50 p-2 rounded">
                            <p className="text-slate-500">Realized P/L</p>
                            <p className={`font-semibold ${(team.realizedPnL || 0) >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                              {(team.realizedPnL || 0) >= 0 ? '+' : ''}${(team.realizedPnL || 0).toFixed(2)}
                            </p>
                          </div>
                          <div className="bg-slate-900/50 p-2 rounded">
                            <p className="text-slate-500">Unrealized P/L</p>
                            <p className={`font-semibold ${(team.unrealizedPnL || 0) >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                              {(team.unrealizedPnL || 0) >= 0 ? '+' : ''}${(team.unrealizedPnL || 0).toFixed(2)}
                            </p>
                          </div>
                        </div>

                        {/* Quick Stats */}
                        <div className="grid grid-cols-2 gap-2 text-xs">
                          <div className="bg-slate-900/50 p-2 rounded">
                            <p className="text-slate-500">Trades</p>
                            <p className="text-white font-semibold">{team.totalTrades || 0}</p>
                          </div>
                          <div className="bg-slate-900/50 p-2 rounded">
                            <p className="text-slate-500">Holdings</p>
                            <p className="text-amber-400 font-semibold">{holdingsCount}</p>
                          </div>
                        </div>

                        {/* Expand indicator */}
                        <div className="mt-3 text-center">
                          <i className={`fas fa-chevron-${selectedTeam === team.name ? 'up' : 'down'} text-slate-500 text-xs`}></i>
                          <span className="text-slate-500 text-xs ml-1">View Holdings</span>
                        </div>
                      </div>
                    );
                  })}
                </div>

                {/* Selected Team Details */}
                {selectedTeam && (
                  <div className="mt-4 p-4 rounded-xl border border-purple-500/30 bg-purple-500/5">
                    <h5 className="text-lg font-bold text-white mb-3 flex items-center gap-2">
                      <i className="fas fa-chart-bar text-purple-400"></i>
                      {selectedTeam} - Live P/L Tracker
                    </h5>
                    {(() => {
                      const teamData = teams.find(t => t.name === selectedTeam);
                      const stats = getTeamStats(selectedTeam);
                      const holdings = teamData?.holdings || [];
                      const tradeHistory = teamData?.tradeHistory || [];

                      return (
                        <div className="space-y-4">
                          {/* Portfolio Summary */}
                          <div className="grid grid-cols-2 md:grid-cols-5 gap-3">
                            <div className="bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                              <p className="text-slate-500 text-xs mb-1">Portfolio Value</p>
                              <p className="text-white font-bold text-lg">
                                ${(teamData?.portfolioValue || 50000).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                              </p>
                            </div>
                            <div className="bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                              <p className="text-slate-500 text-xs mb-1">Cash Available</p>
                              <p className="text-cyan-400 font-bold text-lg">
                                ${(teamData?.cash || 50000).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                              </p>
                            </div>
                            <div className="bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                              <p className="text-slate-500 text-xs mb-1">Invested</p>
                              <p className="text-amber-400 font-bold text-lg">
                                ${(teamData?.invested || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                              </p>
                            </div>
                            <div className="bg-slate-800/50 p-3 rounded-lg border border-green-500/30">
                              <p className="text-slate-500 text-xs mb-1">Realized P/L</p>
                              <p className={`font-bold text-lg ${(teamData?.realizedPnL || 0) >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                {(teamData?.realizedPnL || 0) >= 0 ? '+' : ''}${(teamData?.realizedPnL || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                              </p>
                            </div>
                            <div className="bg-slate-800/50 p-3 rounded-lg border border-blue-500/30">
                              <p className="text-slate-500 text-xs mb-1">Unrealized P/L</p>
                              <p className={`font-bold text-lg ${(teamData?.unrealizedPnL || 0) >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                {(teamData?.unrealizedPnL || 0) >= 0 ? '+' : ''}${(teamData?.unrealizedPnL || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                              </p>
                            </div>
                          </div>

                          {/* Total P/L Banner */}
                          <div className={`p-3 rounded-lg ${(teamData?.totalPnL || 0) >= 0 ? 'bg-green-500/10 border border-green-500/30' : 'bg-red-500/10 border border-red-500/30'}`}>
                            <div className="flex items-center justify-between">
                              <span className="text-slate-400 font-medium">Total Profit/Loss</span>
                              <span className={`text-2xl font-bold ${(teamData?.totalPnL || 0) >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                {(teamData?.totalPnL || 0) >= 0 ? '+' : ''}${(teamData?.totalPnL || 0).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                <span className="text-sm ml-2">
                                  ({(((teamData?.totalPnL || 0) / 50000) * 100).toFixed(2)}%)
                                </span>
                              </span>
                            </div>
                          </div>

                          {/* Current Holdings Table */}
                          <div>
                            <p className="text-slate-400 text-sm mb-2 flex items-center gap-2">
                              <i className="fas fa-briefcase text-amber-400"></i>
                              Current Holdings ({holdings.length} positions)
                            </p>
                            {holdings.length > 0 ? (
                              <div className="overflow-x-auto">
                                <table className="w-full text-sm">
                                  <thead>
                                    <tr className="text-slate-500 border-b border-slate-700">
                                      <th className="text-left p-2">Symbol</th>
                                      <th className="text-right p-2">Shares</th>
                                      <th className="text-right p-2">Avg Cost</th>
                                      <th className="text-right p-2">Current</th>
                                      <th className="text-right p-2">Market Value</th>
                                      <th className="text-right p-2">P/L</th>
                                      <th className="text-right p-2">P/L %</th>
                                    </tr>
                                  </thead>
                                  <tbody>
                                    {holdings.map((holding, i) => (
                                      <tr key={holding.symbol} className={`border-b border-slate-800 ${i % 2 === 0 ? 'bg-slate-800/30' : ''}`}>
                                        <td className="p-2">
                                          <span className="text-cyan-400 font-mono font-bold">{holding.symbol}</span>
                                        </td>
                                        <td className="text-right p-2 text-white">{holding.shares}</td>
                                        <td className="text-right p-2 text-slate-400">${holding.avgCost?.toFixed(2)}</td>
                                        <td className="text-right p-2 text-white">${holding.currentPrice?.toFixed(2)}</td>
                                        <td className="text-right p-2 text-amber-400 font-semibold">
                                          ${holding.marketValue?.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                        </td>
                                        <td className={`text-right p-2 font-semibold ${(holding.unrealizedPnL || 0) >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                          {(holding.unrealizedPnL || 0) >= 0 ? '+' : ''}${holding.unrealizedPnL?.toFixed(2)}
                                        </td>
                                        <td className={`text-right p-2 font-semibold ${(holding.pnlPercent || 0) >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                          {(holding.pnlPercent || 0) >= 0 ? '+' : ''}{holding.pnlPercent?.toFixed(2)}%
                                        </td>
                                      </tr>
                                    ))}
                                  </tbody>
                                </table>
                              </div>
                            ) : (
                              <div className="text-center py-4 text-slate-500 bg-slate-800/30 rounded-lg">
                                <i className="fas fa-inbox text-2xl mb-2"></i>
                                <p>No current holdings</p>
                              </div>
                            )}
                          </div>

                          {/* Trade History Table */}
                          <div>
                            <p className="text-slate-400 text-sm mb-2 flex items-center gap-2">
                              <i className="fas fa-history text-purple-400"></i>
                              Trade History (Last 20 trades)
                            </p>
                            {tradeHistory.length > 0 ? (
                              <div className="overflow-x-auto max-h-64 overflow-y-auto">
                                <table className="w-full text-sm">
                                  <thead className="sticky top-0 bg-slate-900">
                                    <tr className="text-slate-500 border-b border-slate-700">
                                      <th className="text-left p-2">Time</th>
                                      <th className="text-left p-2">Action</th>
                                      <th className="text-left p-2">Symbol</th>
                                      <th className="text-right p-2">Shares</th>
                                      <th className="text-right p-2">Price</th>
                                      <th className="text-right p-2">Value</th>
                                      <th className="text-right p-2">P/L</th>
                                    </tr>
                                  </thead>
                                  <tbody>
                                    {tradeHistory.map((trade, i) => (
                                      <tr key={i} className={`border-b border-slate-800 ${trade.action === 'BUY' ? 'bg-green-500/5' : 'bg-red-500/5'}`}>
                                        <td className="p-2 text-slate-500 text-xs">{trade.time}</td>
                                        <td className="p-2">
                                          <span className={`px-2 py-0.5 rounded text-xs font-bold ${
                                            trade.action === 'BUY' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'
                                          }`}>
                                            {trade.action}
                                          </span>
                                        </td>
                                        <td className="p-2 text-cyan-400 font-mono">{trade.symbol}</td>
                                        <td className="text-right p-2 text-white">{trade.shares}</td>
                                        <td className="text-right p-2 text-slate-400">${trade.price?.toFixed(2)}</td>
                                        <td className="text-right p-2 text-white">${trade.value?.toFixed(2)}</td>
                                        <td className={`text-right p-2 font-semibold ${
                                          trade.action === 'SELL'
                                            ? ((trade.realizedPnL || 0) >= 0 ? 'text-green-400' : 'text-red-400')
                                            : 'text-slate-500'
                                        }`}>
                                          {trade.action === 'SELL'
                                            ? `${(trade.realizedPnL || 0) >= 0 ? '+' : ''}$${(trade.realizedPnL || 0).toFixed(2)}`
                                            : '-'
                                          }
                                        </td>
                                      </tr>
                                    ))}
                                  </tbody>
                                </table>
                              </div>
                            ) : (
                              <div className="text-center py-4 text-slate-500 bg-slate-800/30 rounded-lg">
                                <i className="fas fa-clock text-2xl mb-2"></i>
                                <p>No trades yet</p>
                              </div>
                            )}
                          </div>

                          {/* Volume Stats */}
                          <div className="grid grid-cols-2 md:grid-cols-4 gap-3 pt-2 border-t border-slate-700">
                            <div className="bg-slate-800/50 p-2 rounded-lg">
                              <p className="text-slate-500 text-xs mb-1">Buy Volume</p>
                              <p className="text-green-400 font-bold">
                                ${stats.totalBuyValue.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}
                              </p>
                            </div>
                            <div className="bg-slate-800/50 p-2 rounded-lg">
                              <p className="text-slate-500 text-xs mb-1">Sell Volume</p>
                              <p className="text-red-400 font-bold">
                                ${stats.totalSellValue.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0})}
                              </p>
                            </div>
                            <div className="bg-slate-800/50 p-2 rounded-lg">
                              <p className="text-slate-500 text-xs mb-1">Total Trades</p>
                              <p className="text-white font-bold">{teamData?.totalTrades || 0}</p>
                            </div>
                            <div className="bg-slate-800/50 p-2 rounded-lg">
                              <p className="text-slate-500 text-xs mb-1">Unique Symbols</p>
                              <p className="text-cyan-400 font-bold">{stats.symbolsTraded.length}</p>
                            </div>
                          </div>

                          {/* Performance Metrics */}
                          {teamData?.metrics && (
                            <div className="pt-4 border-t border-slate-700">
                              <p className="text-slate-400 text-sm mb-3 flex items-center gap-2">
                                <i className="fas fa-chart-line text-green-400"></i>
                                Performance Metrics
                              </p>
                              <div className="grid grid-cols-2 md:grid-cols-5 gap-3">
                                <div className="bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                                  <p className="text-slate-500 text-xs mb-1">Win Rate</p>
                                  <p className={`text-lg font-bold ${(teamData.metrics.winRate || 0) >= 50 ? 'text-green-400' : 'text-amber-400'}`}>
                                    {(teamData.metrics.winRate || 0).toFixed(1)}%
                                  </p>
                                </div>
                                <div className="bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                                  <p className="text-slate-500 text-xs mb-1">Profit Factor</p>
                                  <p className={`text-lg font-bold ${(teamData.metrics.profitFactor || 0) >= 1.5 ? 'text-green-400' : (teamData.metrics.profitFactor || 0) >= 1 ? 'text-amber-400' : 'text-red-400'}`}>
                                    {(teamData.metrics.profitFactor || 0).toFixed(2)}
                                  </p>
                                </div>
                                <div className="bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                                  <p className="text-slate-500 text-xs mb-1">Max Drawdown</p>
                                  <p className="text-red-400 text-lg font-bold">
                                    -{(teamData.metrics.maxDrawdown || 0).toFixed(2)}%
                                  </p>
                                </div>
                                <div className="bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                                  <p className="text-slate-500 text-xs mb-1">Avg Gain</p>
                                  <p className="text-green-400 text-lg font-bold">
                                    +${(teamData.metrics.avgGain || 0).toFixed(2)}
                                  </p>
                                </div>
                                <div className="bg-slate-800/50 p-3 rounded-lg border border-slate-700">
                                  <p className="text-slate-500 text-xs mb-1">Avg Loss</p>
                                  <p className="text-red-400 text-lg font-bold">
                                    -${(teamData.metrics.avgLoss || 0).toFixed(2)}
                                  </p>
                                </div>
                              </div>
                              {/* Best/Worst Trade */}
                              <div className="grid grid-cols-2 gap-3 mt-3">
                                {teamData.metrics.bestTrade && (
                                  <div className="bg-green-500/10 p-3 rounded-lg border border-green-500/30">
                                    <p className="text-slate-400 text-xs mb-1">Best Trade</p>
                                    <p className="text-green-400 font-bold">
                                      {teamData.metrics.bestTrade.symbol}: +${teamData.metrics.bestTrade.pnl?.toFixed(2)}
                                    </p>
                                  </div>
                                )}
                                {teamData.metrics.worstTrade && (
                                  <div className="bg-red-500/10 p-3 rounded-lg border border-red-500/30">
                                    <p className="text-slate-400 text-xs mb-1">Worst Trade</p>
                                    <p className="text-red-400 font-bold">
                                      {teamData.metrics.worstTrade.symbol}: ${teamData.metrics.worstTrade.pnl?.toFixed(2)}
                                    </p>
                                  </div>
                                )}
                              </div>
                            </div>
                          )}

                          {/* Sector Allocation */}
                          {teamData?.sectorAllocation && teamData.sectorAllocation.sectors?.length > 0 && (
                            <div className="pt-4 border-t border-slate-700">
                              <p className="text-slate-400 text-sm mb-3 flex items-center gap-2">
                                <i className="fas fa-chart-pie text-purple-400"></i>
                                Sector Allocation
                              </p>
                              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {/* Sector Bars */}
                                <div className="space-y-2">
                                  {teamData.sectorAllocation.sectors.slice(0, 6).map((sector, idx) => {
                                    const colors = ['bg-cyan-500', 'bg-purple-500', 'bg-green-500', 'bg-amber-500', 'bg-red-500', 'bg-blue-500'];
                                    return (
                                      <div key={sector.sector} className="flex items-center gap-2">
                                        <div className="w-24 text-xs text-slate-400 truncate">{sector.sector}</div>
                                        <div className="flex-1 bg-slate-800 rounded-full h-4 overflow-hidden">
                                          <div
                                            className={`h-full ${colors[idx % colors.length]} rounded-full transition-all duration-500`}
                                            style={{width: `${Math.min(sector.percentage, 100)}%`}}
                                          ></div>
                                        </div>
                                        <div className="w-16 text-right text-xs text-white font-semibold">
                                          {sector.percentage.toFixed(1)}%
                                        </div>
                                      </div>
                                    );
                                  })}
                                </div>
                                {/* Cash vs Invested */}
                                <div className="flex flex-col justify-center">
                                  <div className="bg-slate-800/50 p-4 rounded-lg border border-slate-700">
                                    <div className="flex justify-between mb-2">
                                      <span className="text-slate-400 text-sm">Cash</span>
                                      <span className="text-cyan-400 font-bold">{teamData.sectorAllocation.cashPercentage?.toFixed(1)}%</span>
                                    </div>
                                    <div className="bg-slate-700 rounded-full h-3 overflow-hidden">
                                      <div
                                        className="h-full bg-gradient-to-r from-cyan-500 to-purple-500 rounded-full"
                                        style={{width: `${100 - (teamData.sectorAllocation.cashPercentage || 0)}%`}}
                                      ></div>
                                    </div>
                                    <div className="flex justify-between mt-2">
                                      <span className="text-slate-400 text-sm">Invested</span>
                                      <span className="text-purple-400 font-bold">{(100 - (teamData.sectorAllocation.cashPercentage || 0)).toFixed(1)}%</span>
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          )}
                        </div>
                      );
                    })()}
                  </div>
                )}
              </div>
            )}

            {/* Portfolio Performance Chart */}
            {portfolioHistory.length >= 2 && (
              <div className="mb-6">
                <h4 className="text-lg font-semibold text-white mb-3 flex items-center gap-2">
                  <i className="fas fa-chart-line text-cyan-400"></i>
                  Portfolio Performance
                  <span className="text-xs text-slate-500 font-normal ml-2">Real-time tracking</span>
                </h4>
                <div className="bg-slate-800/50 rounded-xl p-4 border border-slate-700">
                  {/* Chart Legend */}
                  <div className="flex flex-wrap gap-4 mb-4">
                    <div className="flex items-center gap-2">
                      <div className="w-3 h-3 rounded-full bg-green-500"></div>
                      <span className="text-sm text-slate-400">Claude (Sonnet)</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <div className="w-3 h-3 rounded-full bg-red-500"></div>
                      <span className="text-sm text-slate-400">Kimi</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <div className="w-3 h-3 rounded-full bg-blue-500"></div>
                      <span className="text-sm text-slate-400">DeepSeek V3</span>
                    </div>
                    <div className="flex items-center gap-2">
                      <div className="w-3 h-3 rounded-full bg-amber-500"></div>
                      <span className="text-sm text-slate-400">Gemini Pro</span>
                    </div>
                  </div>
                  {/* Chart Container */}
                  <div ref={chartContainerRef} className="w-full h-[300px]"></div>
                  <p className="text-xs text-slate-500 mt-2 text-center">
                    Starting Capital: $50,000 | {portfolioHistory.length} data points
                  </p>
                </div>
              </div>
            )}

            {/* Trade Cards with AI Reasoning */}
            <h4 className="text-lg font-semibold text-white mb-3 flex items-center gap-2">
              <i className="fas fa-exchange-alt text-purple-400"></i>
              Trade Activity Log
            </h4>
            <div className="space-y-4 max-h-[600px] overflow-y-auto">
              {isLoading && trades.length === 0 ? (
                <div className="text-center py-12">
                  <i className="fas fa-spinner animate-spin text-3xl text-purple-400 mb-3"></i>
                  <p className="text-slate-400">Loading trade activity...</p>
                </div>
              ) : trades.length === 0 ? (
                <div className="text-center py-12">
                  <i className="fas fa-chart-line text-5xl text-slate-700 mb-4"></i>
                  <h4 className="text-lg font-semibold text-white mb-2">No Trades Yet</h4>
                  <p className="text-slate-500 max-w-md mx-auto">
                    The AI tournament runs automatically during US market hours.
                    Check back when the market is open to see live trading activity.
                  </p>
                  <div className="mt-4 p-3 bg-slate-800/50 rounded-lg inline-block">
                    <p className="text-slate-400 text-sm">
                      <i className="fas fa-clock mr-2"></i>
                      Market Hours: Mon-Fri, 9:30 AM - 4:00 PM ET
                    </p>
                  </div>
                </div>
              ) : (
                trades.slice(0, 50).map((trade, idx) => (
                  <div
                    key={idx}
                    className={`p-4 rounded-lg border ${
                      trade.action === 'BUY'
                        ? 'bg-green-500/5 border-green-500/30'
                        : 'bg-red-500/5 border-red-500/30'
                    }`}
                  >
                    <div className="flex items-start justify-between mb-3">
                      <div className="flex items-center gap-3">
                        <div className={`w-10 h-10 rounded-full flex items-center justify-center ${
                          trade.action === 'BUY' ? 'bg-green-500/20' : 'bg-red-500/20'
                        }`}>
                          <i className={`fas ${trade.action === 'BUY' ? 'fa-arrow-up text-green-400' : 'fa-arrow-down text-red-400'}`}></i>
                        </div>
                        <div>
                          <div className="flex items-center gap-2">
                            <span className="font-bold text-white">{trade.team}</span>
                            <span className={`px-2 py-0.5 rounded text-xs font-semibold ${
                              trade.action === 'BUY' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'
                            }`}>
                              {trade.action}
                            </span>
                          </div>
                          <p className="text-slate-400 text-sm">
                            {trade.shares} shares of <span className="text-cyan-400 font-semibold">{trade.symbol}</span> @ ${trade.price?.toFixed(2)}
                          </p>
                        </div>
                      </div>
                      <div className="text-right">
                        <p className="text-slate-500 text-xs">{trade.time || trade.timestamp}</p>
                        <p className="text-white font-semibold">${(trade.price * trade.shares).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                      </div>
                    </div>

                    {/* AI Reasoning */}
                    {trade.reasoning && (
                      <div className="mt-3 p-3 bg-slate-800/50 rounded-lg border-l-2 border-purple-500">
                        <div className="flex items-start gap-2">
                          <i className="fas fa-brain text-purple-400 mt-0.5"></i>
                          <div>
                            <p className="text-xs text-purple-400 font-semibold mb-1">AI Analysis</p>
                            <p className="text-slate-300 text-sm">{trade.reasoning}</p>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                ))
              )}
            </div>
          </div>
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AdvancedPortfolioAnalytics component removed - helper functions (calculatePortfolioBeta, calculatePortfolioVolatility, calculateSharpeRatio) also removed

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MAIN APP
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function App() {
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // STATE
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const [stocks, setStocks] = useState([]);
      const [isDarkMode, setIsDarkMode] = useState(() => {
        const saved = localStorage.getItem('darkMode');
        return saved !== null ? saved === 'true' : true;
      });

      // Toggle dark/light mode
      const toggleTheme = () => {
        const newMode = !isDarkMode;
        setIsDarkMode(newMode);
        localStorage.setItem('darkMode', newMode);
        document.body.classList.toggle('light-mode', !newMode);
      };

      // Apply theme on mount
      useEffect(() => {
        if (!isDarkMode) {
          document.body.classList.add('light-mode');
        } else {
          document.body.classList.remove('light-mode');
        }
      }, [isDarkMode]);
      const [loading, setLoading] = useState(true);
      const [loadingProgress, setLoadingProgress] = useState({ current: 0, total: 0 });
      
      // DEBUG: Track loading state changes
      useEffect(() => {
        console.log('ğŸ”„ LOADING STATE CHANGED:', loading);
      }, [loading]);
      const [displayLimit, setDisplayLimit] = useState(50); // Start with 50 stocks for instant display
      const [search, setSearch] = useState('');
      const [debouncedSearch, setDebouncedSearch] = useState(''); // Debounced search for filtering
      const [selectedSector, setSelectedSector] = useState('');
      const [selectedPreset, setSelectedPreset] = useState('');
      const [sortBy, setSortBy] = useState({ key: 'marketCap', dir: 'desc' });
      const [visibleColumns, setVisibleColumns] = useState(DEFAULT_VISIBLE);
      const [selectedStock, setSelectedStock] = useState(null);
      
      // OPTIMIZATION: Debounce search input to prevent re-filtering on every keystroke
      useEffect(() => {
        const timer = setTimeout(() => {
          setDebouncedSearch(search);
        }, 300); // 300ms debounce
        
        return () => clearTimeout(timer);
      }, [search]);


      // Portfolio Analysis
      const [portfolioOptimization, setPortfolioOptimization] = useState(null);
      const [portfolioMetrics, setPortfolioMetrics] = useState(null);

      // Heatmap  
      const [heatmapData, setHeatmapData] = useState([]);
      const [heatmapSubscriptions, setHeatmapSubscriptions] = useState(new Set());

      // Subscribe to real-time updates for heatmap symbols
      useEffect(() => {
        if (!stocks || stocks.length === 0) return;

        // Get unique symbols from current view
        const symbols = stocks.map(s => s.symbol).slice(0, 50); // Limit to top 50 for performance

        // Subscribe to each symbol
        symbols.forEach(symbol => {
          if (heatmapSubscriptions.has(symbol)) return;

          const handleUpdate = (update) => {
            setHeatmapData(prev => {
              const index = prev.findIndex(s => s.symbol === update.symbol);
              if (index === -1) return prev;

              const newData = [...prev];
              newData[index] = {
                ...newData[index],
                price: update.price,
                changePct: update.changesPercentage || (update.change / update.price * 100),
                volume: update.volume,
                lastUpdate: Date.now()
              };
              return newData;
            });
          };

          // Subscribe based on connection type
          if (realtimeData.isConnected) {
            realtimeData.subscribe(symbol, handleUpdate);
          } else {
            smartPoller.startPolling(symbol, handleUpdate);
          }

          setHeatmapSubscriptions(prev => new Set(prev).add(symbol));
        });

        return () => {
          // Cleanup on unmount
          heatmapSubscriptions.forEach(symbol => {
            realtimeData.unsubscribe(symbol, () => { });
            smartPoller.stopPolling(symbol);
          });
        };
      }, [stocks, realtimeData.isConnected]);

      // Similar Stocks
      const [similarStocks, setSimilarStocks] = useState(null);

      // Incremental Loading for Screener
      const [partialResults, setPartialResults] = useState([]);
      const [completedSymbols, setCompletedSymbols] = useState(new Set());
      const [isIncrementalLoading, setIsIncrementalLoading] = useState(false);
      const [apiProgress, setApiProgress] = useState({ current: 0, total: 0 });
      const [showStuckWarning, setShowStuckWarning] = useState(false);

      // Watchlist cleanup function - removes invalid symbols (column headers, etc.)
      const cleanWatchlist = (symbols) => {
        const headerWords = new Set([
          'SYMBOL', 'NAME', 'LAST', 'OPEN', 'HIGH', 'LOW', 'CHG', 'VOL', 'VOLUME',
          'TIME', 'DATE', 'CLOSE', 'CHANGE', 'PRICE', 'CHANGE%', 'CHG.', 'VOL.',
          'BUY', 'SELL', 'HOLD', 'RSI', 'MACD', 'EPS', 'REVENUE', 'DAILY', 'HOURLY',
          'YTD', 'BETA', 'NEUTRAL', 'INC.', 'MONGODB', 'EARNINGS', 'PE',
          'MARKET', 'CAP', 'SECTOR', 'INDUSTRY', 'DIVIDEND', 'YIELD', 'IEX'
        ]);

        return symbols
          .map(s => cleanSymbol(String(s).trim()))
          .filter(s =>
            s &&
            s.length > 0 &&
            s.length <= 10 &&
            /^[A-Z]+$/.test(s) &&
            !headerWords.has(s)
          );
      };

      const [watchlist, setWatchlist] = useState(() => {
        const saved = JSON.parse(localStorage.getItem('watchlist') || '[]');
        const cleaned = cleanWatchlist(saved);
        if (cleaned.length !== saved.length) {
          console.log(`ğŸ§¹ Cleaned watchlist: removed ${saved.length - cleaned.length} invalid symbols`);
          localStorage.setItem('watchlist', JSON.stringify(cleaned));
        }
        return cleaned;
      });
      const [showWatchlistOnly, setShowWatchlistOnly] = useState(false);
      // selectedThematic state - REMOVED


      // Find Similar Stocks
      const findSimilarStocks = () => {
        if (!selectedStock || stocks.length < 2) {
          setSimilarStocks([]);
          return;
        }

        const similarities = stocks
          .filter(s => s.symbol !== selectedStock.symbol)
          .map(stock => {
            let score = 0;
            let factors = 0;

            // Sector match
            if (stock.sector === selectedStock.sector) score += 30;
            factors++;

            // PE similarity
            if (selectedStock.pe && stock.pe) {
              const peDiff = Math.abs(selectedStock.pe - stock.pe);
              score += Math.max(0, 20 - peDiff);
              factors++;
            }

            // ROE similarity
            if (selectedStock.roe && stock.roe) {
              const roeDiff = Math.abs(selectedStock.roe - stock.roe);
              score += Math.max(0, 20 - roeDiff / 5);
              factors++;
            }

            // Market Cap similarity
            if (selectedStock.marketCap && stock.marketCap) {
              const ratio = selectedStock.marketCap / stock.marketCap;
              if (ratio >= 0.5 && ratio <= 2) score += 15;
              factors++;
            }

            const similarity = (score / (factors * 20)) * 100;

            return {
              symbol: stock.symbol,
              companyName: stock.companyName,
              sector: stock.sector,
              similarity: similarity,
              pe: stock.pe,
              roe: stock.roe,
              aiScore: stock.aiScore
            };
          })
          .sort((a, b) => b.similarity - a.similarity)
          .slice(0, 10);

        setSimilarStocks(similarities);
      };

      // Run Portfolio Optimization
      const runPortfolioOptimization = async () => {
        setLoadingTabData(true);
        try {
          if (portfolio.length < 2) {
            setPortfolioOptimization(null);
            return;
          }

          const positions = portfolio.map(pos => {
            const stock = stocks.find(s => s.symbol === pos.symbol);
            return {
              symbol: pos.symbol,
              expectedReturn: (stock?.aiScore || 50) / 1000 + 0.05,
              volatility: (100 - (stock?.confidence || 50)) / 100
            };
          });

          const optimization = MLModels.optimizePortfolio(positions);
          setPortfolioOptimization(optimization);
        } catch (err) {
          console.error('Portfolio error:', err);
          setPortfolioOptimization(null);
        } finally {
          setLoadingTabData(false);
        }
      };
      const [showHeatmap, setShowHeatmap] = useState(false);
      const [showSettings, setShowSettings] = useState(false);
      const [showAlerts, setShowAlerts] = useState(false);
      const [showPortfolio, setShowPortfolio] = useState(false);
      const [showPortfolioAllocation, setShowPortfolioAllocation] = useState(false);
      const [showStockManager, setShowStockManager] = useState(false);
      const [showComparison, setShowComparison] = useState(false);
      const [showEducation, setShowEducation] = useState(false);
      const [showNotifications, setShowNotifications] = useState(false);
      const [showWatchlistImporter, setShowWatchlistImporter] = useState(false);
      const [showAITournament, setShowAITournament] = useState(false);
      const [notificationCount, setNotificationCount] = useState(0);
      const [tournamentRunning, setTournamentRunning] = useState(false);

      // Check tournament status on mount and periodically
      // This is for the tournament indicator in the main UI
      // IMPORTANT: This only checks status - it does NOT stop the tournament
      useEffect(() => {
        const checkTournamentStatus = async () => {
          try {
            const response = await fetch(`${API_BASE_URL}/api/tournament/status/current`);
            if (response.ok) {
              const data = await response.json();
              const isRunning = data.status === 'running';
              setTournamentRunning(isRunning);

              // Log status for debugging (only if status changed)
              if (isRunning && !tournamentRunning) {
                console.log('ğŸ“‹ Tournament detected running - showing indicator');
              }
            }
          } catch (error) {
            // If we can't check status, don't assume tournament stopped
            // Just don't show the indicator
            console.log('Could not check tournament status:', error);
            // Only set to false if we're sure it's not running
            // Don't interfere with tournament state
          }
        };

        // Check immediately
        checkTournamentStatus();

        // Check every 30 seconds to update indicator
        const interval = setInterval(checkTournamentStatus, 30000);
        return () => clearInterval(interval);
      }, [tournamentRunning]); // Include tournamentRunning to detect changes

      // Main Page Tabs - STATE
      const [activeMainTab, setActiveMainTab] = useState('screener'); // 'screener', 'tournament', 'portfolio'

      // Subscribe to alert updates
      useEffect(() => {
        const updateCount = () => {
          setNotificationCount(window.alertManager.getUnreadCount());
        };
        updateCount();
        const unsubscribe = window.alertManager.subscribe(updateCount);
        return unsubscribe;
      }, []);

      // Initialize keyboard shortcuts
      useEffect(() => {
        if (!window.keyboardShortcuts) return;

        // Register useful shortcuts
        window.keyboardShortcuts.register('/', () => {
          document.querySelector('input[type="text"]')?.focus();
        }, 'Focus search input');

        window.keyboardShortcuts.register('ctrl+r', () => {
          manualRefresh();
        }, 'Refresh stock data');

        window.keyboardShortcuts.register('ctrl+i', () => {
          setShowWatchlistImporter(true);
        }, 'Open import dialog');

        window.keyboardShortcuts.register('ctrl+p', () => {
          setShowPortfolio(true);
        }, 'Open portfolio');

        window.keyboardShortcuts.register('ctrl+h', () => {
          const shortcuts = window.keyboardShortcuts.getHelp();
          alert('âŒ¨ï¸ KEYBOARD SHORTCUTS:\n\n' + shortcuts.map(s => `${s.key.padEnd(15)} ${s.description}`).join('\n'));
        }, 'Show this help');

        window.keyboardShortcuts.register('esc', () => {
          // Close any open modals
          setShowPortfolio(false);
          setShowAlerts(false);
          setShowSettings(false);
          setShowEducation(false);
          setShowStockManager(false);
          setShowWatchlistImporter(false);
        }, 'Close modals');

        console.log('âŒ¨ï¸ Keyboard shortcuts registered');
      }, []);

      const [comparisonSymbols, setComparisonSymbols] = useState([]);
      const [isWebSocketConnected, setIsWebSocketConnected] = useState(false);
      const [curatedStocks, setCuratedStocks] = useState(() => {
        const saved = localStorage.getItem('curatedStocks');
        // EXPANDED default list with 949+ major US stocks (S&P 500, NASDAQ 100, and popular stocks)
        const defaultList = ["AAPL", "MSFT", "GOOGL", "GOOG", "AMZN", "NVDA", "TSLA", "META", "BRK.B", "UNH", "XOM", "JNJ", "JPM", "V", "PG", "MA", "HD", "CVX", "LLY", "ABBV", "MRK", "AVGO", "COST", "PEP", "KO", "ADBE", "TMO", "WMT", "MCD", "CSCO", "ACN", "ABT", "CRM", "NFLX", "DHR", "LIN", "NKE", "VZ", "CMCSA", "TXN", "DIS", "PM", "NEE", "BMY", "ORCL", "AMD", "INTC", "QCOM", "RTX", "UPS", "T", "HON", "UNP", "BA", "SPGI", "COP", "SBUX", "LOW", "INTU", "AMGN", "GE", "DE", "CAT", "PLD", "ISRG", "MS", "BLK", "GS", "AXP", "NOW", "AMAT", "TJX", "ELV", "ADI", "SYK", "BKNG", "MDLZ", "LMT", "VRTX", "GILD", "CI", "ADP", "REGN", "ZTS", "PGR", "CVS", "MMC", "TGT", "SLB", "LRCX", "CB", "ETN", "C", "MO", "SO", "BDX", "DUK", "SCHW", "BSX", "PNC", "PYPL", "EQIX", "FISV", "ITW", "MMM", "FCX", "AON", "CL", "APD", "USB", "CME", "ICE", "GM", "WM", "F", "NOC", "MCO", "NSC", "PSX", "CCI", "MPC", "SHW", "MCK", "EMR", "ROP", "EOG", "KLAC", "HCA", "ECL", "MSI", "GD", "PSA", "APH", "PH", "ADSK", "SNPS", "SRE", "AJG", "ATVI", "TEL", "TFC", "AIG", "COF", "MAR", "AFL", "TT", "MET", "NXPI", "FIS", "PCAR", "CARR", "TRV", "SYY", "ALL", "AEP", "AZO", "PAYX", "PRU", "ORLY", "FTNT", "HUM", "DHI", "D", "DD", "KMB", "MNST", "RSG", "CMG", "IDXX", "WELL", "GPN", "CTVA", "O", "MSCI", "ROST", "MCHP", "SPG", "EA", "JCI", "EW", "IQV", "CTAS", "KMI", "KDP", "BIIB", "ROK", "WMB", "A", "XEL", "PPG", "CTSH", "WBD", "CPRT", "BK", "OTIS", "ODFL", "FAST", "HSY", "AMT", "CHTR", "DVN", "CMI", "EXC", "VRSK", "YUM", "GIS", "DLR", "STZ", "CBRE", "EXR", "DOW", "AMP", "DXCM", "AWK", "ILMN", "GLW", "KEYS", "STE", "MTD", "EBAY", "ANSS", "IFF", "LHX", "KHC", "LH", "ACGL", "LYB", "VMC", "ADM", "WY", "ED", "PCG", "FTV", "LVS", "TROW", "CDNS", "DTE", "RMD", "HPQ", "WST", "TSCO", "ALGN", "MTB", "VICI", "EFX", "WAB", "WTW", "AEE", "IT", "CNC", "ETR", "FRC", "GWW", "AVB", "ALB", "DAL", "APTV", "BAX", "PFG", "SBAC", "EQR", "CSGP", "ES", "TDY", "PPL", "STT", "HPE", "DOV", "DLTR", "WEC", "FITB", "DFS", "EIX", "TSN", "TYL", "SIVB", "FE", "ZBH", "TDG", "HBAN", "MPWR", "PWR", "MLM", "RF", "NTRS", "IEX", "CLX", "ARE", "HAL", "HOLX", "EQT", "CZR", "INVH", "LUV", "CFG", "OMC", "URI", "XYL", "DPZ", "K", "VTR", "FLT", "CAH", "TTWO", "EXPE", "BALL", "FDS", "SYF", "BBY", "COO", "NVR", "DRI", "MKC", "WAT", "ZBRA", "WDC", "PKI", "J", "CNP", "IP", "NTAP", "KIM", "AES", "LKQ", "CINF", "CE", "POOL", "EXPD", "LNT", "TER", "SWK", "JBHT", "AMCR", "APA", "PTC", "JKHY", "BXP", "HRL", "NDAQ", "EPAM", "BF.B", "UDR", "TRMB", "KMX", "TAP", "SWKS", "CPT", "MAA", "AOS", "HST", "PNW", "AIZ", "LYV", "MOS", "CHRW", "MGM", "ULTA", "AKAM", "TECH", "GL", "ALLE", "HSIC", "SNA", "FFIV", "GNRC", "LW", "RE", "EMN", "CTLT", "REG", "PAYC", "AAL", "SEE", "HII", "CMA", "BRO", "CPB", "IPG", "NI", "CRL", "PEAK", "BBWI", "WYNN", "WHR", "NCLH", "ALK", "IVZ", "HAS", "RL", "ZION", "BEN", "PNR", "MKTX", "BWA", "VNO", "NWS", "NWSA", "LUMN", "FOX", "FOXA", "DXC", "DISH", "UBER", "LYFT", "ABNB", "COIN", "SHOP", "SQ", "ROKU", "SNAP", "PINS", "TWLO", "ZM", "DOCU", "DDOG", "SNOW", "NET", "CRWD", "ZS", "OKTA", "PANW", "MDB", "TEAM", "WDAY", "VEEV", "DKNG", "RBLX", "U", "PATH", "RIVN", "LCID", "PLTR", "SOFI", "HOOD", "AFRM", "UPST", "PTON", "BYND", "PLUG", "ENPH", "SEDG", "FSLR", "RUN", "SPWR", "MAXN", "BE", "BLNK", "CHPT", "QS", "LAZR", "VLDR", "LIDR", "OUST", "MVIS", "INVZ", "SPCE", "ASTR", "RDW", "PL", "ASTS", "SATS", "LUNR", "MNTS", "IRDM", "GSAT", "AST", "GILT", "VORB", "ACHR", "JOBY", "LILM", "EVTL", "BIRD", "WKHS", "GOEV", "RIDE", "FSR", "LEV", "ARVL", "PTRA", "HYLN", "NKLA", "GP", "HYZN", "XL", "FUV", "SOLO", "AYRO", "ELMS", "GEV", "MULN", "WKSP", "FFIE", "PSNY", "AMC", "GME", "BB", "BBBY", "NOK", "SNDL", "NAKD", "EXPR", "KOSS", "CLOV", "WISH", "CLNE", "RKT", "UWMC", "SENS", "OCGN", "PROG", "ATER", "BBIG", "SPRT", "GREE", "IRNT", "OPAD", "SDC", "ABML", "ALPP", "OZSC", "AITX", "TSNP", "TLSS", "BBRW", "VPER", "SRMX", "INKW", "IDGC", "FOMO", "BOTY", "POTN", "MINE", "SIRC", "IGEX", "NIO", "XPEV", "LI", "BYDDY", "BABA", "JD", "PDD", "BIDU", "TCEHY", "NTES", "TME", "IQ", "BILI", "VIPS", "ATHM", "ZTO", "YMM", "HTHT", "DIDI", "EDU", "TAL", "GOTU", "RLX", "YY", "MOMO", "HUYA", "DOYU", "TIGR", "FUTU", "UP", "LX", "QTT", "DUO", "MOGU", "TUYA", "API", "LAIX", "BEST", "YJ", "CANG", "PETZ", "MOXC", "QH", "LMNR", "LITB", "AIHS", "TANH", "CBAT", "KNDI", "POLA", "IDEX", "WIMI", "MRIN", "CARV", "EAST", "JAGX", "SXTC", "CJJD", "DOGZ", "GLG", "REED", "SGMD", "TSM", "ASML", "MU", "MRVL", "MCHP", "ON", "QRVO", "STM", "GFS", "ENTG", "CRUS", "COHU", "AOSL", "MTSI", "FORM", "UCTT", "PLAB", "ACLS", "INDI", "ICHR", "NVMI", "ONTO", "ACMR", "CAMT", "POWI", "MKSI", "AEIS", "RMBS", "AMBA", "ALGM", "LSCC", "DIOD", "WOLF", "SLAB", "SMTC", "VECO", "TRMR", "AAOI", "REFR", "IPGP", "LITE", "OESX", "EMKR", "VIAV", "INFN", "OCLR", "FNSR", "AAON", "ATKR", "BDC", "BELFB", "CTS", "TAIT", "TTMI", "SANM", "ENS", "TRS", "VSEC", "MWA", "BC", "TILE", "HXL", "SHLS", "DBD", "PRLB", "DDD", "SSYS", "NNDM", "XONE", "VJET", "MTLS", "LOGI", "CRSR", "IRBT", "WBX", "SEIC", "SSNC", "BR", "GDDY", "LDOS", "SAIC", "CACI", "KTOS", "AVAV", "TDY", "FROG", "SPLK", "ZI", "COUP", "ESTC", "BILL", "S", "CFLT", "GTLB", "IOT", "APPN", "SUMO", "EVBG", "PD", "AI", "NCNO", "FIVN", "BRZE", "DT", "SNOW", "DDOG", "NET", "CRWD", "ZS", "OKTA", "PANW", "TENB", "VRNS", "QLYS", "RPD", "SAIL", "RSKD", "FSLY", "CLOUDFLARE", "PING", "NEWR", "ESTC", "SPLK", "WORK", "TWLO", "BAND", "BOX", "DBX", "DOCN", "LINODE", "MDB", "SNOW", "ELASTIC"];
        let stocks = saved ? JSON.parse(saved) : defaultList;
        
        // AUTO-RESTORE: If saved list is suspiciously small (<100), restore from default
        if (stocks.length < 100) {
          console.warn(`âš ï¸ Only ${stocks.length} stocks in localStorage - restoring full list of ${defaultList.length} stocks`);
          stocks = defaultList;
          localStorage.setItem('curatedStocks', JSON.stringify(defaultList));
        }
        
        // FIX: Validate that symbols are actual ticker symbols, not company names
        // Ticker symbols are typically 1-5 characters (with exceptions like BRK.B)
        const invalidSymbols = stocks.filter(s => {
          const cleaned = String(s).toUpperCase().trim();
          // Check if it looks like a company name (>8 chars without dots)
          return cleaned.length > 8 && !cleaned.includes('.');
        });
        
        if (invalidSymbols.length > 10) {
          console.error(`ğŸš¨ Found ${invalidSymbols.length} invalid symbols (company names instead of tickers)`);
          console.error('Sample invalid:', invalidSymbols.slice(0, 5));
          console.warn('âš ï¸ Restoring default ticker list...');
          stocks = defaultList;
          localStorage.setItem('curatedStocks', JSON.stringify(defaultList));
        }
        
        // Remove duplicates and normalize (uppercase, trim)
        const uniqueStocks = [...new Set(stocks.map(s => String(s).toUpperCase().trim()).filter(s => s))];
        
        // Save cleaned version back to localStorage if it changed (debounced)
        if (uniqueStocks.length !== stocks.length) {
          DebouncedStorage.setItem('curatedStocks', JSON.stringify(uniqueStocks), 2000);
        }
        
        console.log(`ğŸ“Š Loaded ${uniqueStocks.length} stocks for screening`);
        return uniqueStocks;
      });
      const [newStockSymbol, setNewStockSymbol] = useState('');
      const [toasts, setToasts] = useState([]);
      const [portfolio, setPortfolio] = useState(() => JSON.parse(localStorage.getItem('portfolio') || '[]'));
      const [alerts, setAlerts] = useState(() => JSON.parse(localStorage.getItem('alerts') || '[]'));
      const [goals, setGoals] = useState(() => {
        const saved = localStorage.getItem('re_financial_goals');
        return saved ? JSON.parse(saved) : [];
      });
      const [portfolioRecs, setPortfolioRecs] = useState([]);
      const [detailedDataLoading, setDetailedDataLoading] = useState(false);
      const [lastUpdateTime, setLastUpdateTime] = useState(null);
      const [nextUpdateTime, setNextUpdateTime] = useState(null);
      const [errors, setErrors] = useState([]);

      // Monitor portfolio for price alerts
      useEffect(() => {
        if (!portfolio || portfolio.length === 0) return;

        const prevPrices = {};

        // Initialize previous prices
        portfolio.forEach(pos => {
          prevPrices[pos.symbol] = pos.currentPrice;
        });

        // Check every 5 minutes during market hours
        const interval = setInterval(() => {
          const now = new Date();
          const hours = now.getHours();
          const day = now.getDay();

          // Only check during market hours (9:30 AM - 4 PM ET, Mon-Fri)
          if (day === 0 || day === 6 || hours < 9 || hours >= 16) return;

          checkPortfolioAlerts(portfolio, prevPrices);

          // Update previous prices
          portfolio.forEach(pos => {
            prevPrices[pos.symbol] = pos.currentPrice;
          });
        }, 60 * 60 * 1000); // 60 minutes (minimum update interval)

        return () => clearInterval(interval);
      }, [portfolio]);

      // Filter State
      const [filters, setFilters] = useState({
        pe_min: '', pe_max: '',
        roe_min: '', roe_max: '',
        marketCap_min: '', marketCap_max: '',
        changePct_min: '', changePct_max: '',
        rsi_min: '', rsi_max: '',
      });

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // FIREBASE AUTH (Optional - graceful fallback to guest mode)
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      const [firebaseUser, setFirebaseUser] = useState(null);
      const [authLoading, setAuthLoading] = useState(true);

      // Firebase auth listener
      useEffect(() => {
        if (window.firebaseUtils) {
          const { auth, onAuthStateChanged } = window.firebaseUtils;
          const unsubscribe = onAuthStateChanged(auth, (user) => {
            setFirebaseUser(user);
            setAuthLoading(false);
            if (user) {
              console.log('âœ… User signed in:', user.email);
              loadUserDataFromFirebase(user.uid);
            }
          });
          return () => unsubscribe();
        } else {
          setAuthLoading(false);
        }
      }, []);

      const signInWithGoogle = async () => {
        if (!window.firebaseUtils) {
          alert('Firebase not configured. Running in guest mode.');
          return;
        }
        const { auth, provider, signInWithPopup } = window.firebaseUtils;
        try {
          await signInWithPopup(auth, provider);
        } catch (error) {
          console.error('Auth error:', error);
          alert('Sign-in failed. Continue in guest mode.');
        }
      };

      const signOutUser = async () => {
        if (window.firebaseUtils?.auth) {
          await window.firebaseUtils.auth.signOut();
        }
        setFirebaseUser(null);
        console.log('âœ… User signed out');
      };

      // Auto-clean watchlist on mount
      useEffect(() => {
        const cleaned = cleanWatchlist(watchlist);
        if (cleaned.length !== watchlist.length) {
          console.log(`ğŸ§¹ Auto-cleaning watchlist: removing ${watchlist.length - cleaned.length} invalid symbols (${watchlist.filter(s => !cleaned.includes(s)).join(', ')})`);
          setWatchlist(cleaned);
          localStorage.setItem('watchlist', JSON.stringify(cleaned));
        }
      }, []); // Run once on mount

      const loadUserDataFromFirebase = async (uid) => {
        if (!window.firebaseUtils?.db) return;
        try {
          const { db, doc, getDoc } = window.firebaseUtils;
          const userDoc = await getDoc(doc(db, 'users', uid));
          if (userDoc.exists()) {
            const data = userDoc.data();
            if (data.watchlist) {
              const cleaned = cleanWatchlist(data.watchlist);
              setWatchlist(cleaned);
              if (cleaned.length !== data.watchlist.length) {
                console.log(`ğŸ§¹ Cleaned watchlist from Firebase: removed ${data.watchlist.length - cleaned.length} invalid symbols`);
              }
              console.log('âœ… Loaded watchlist from Firebase');
            }
            if (data.portfolio) {
              setPortfolio(data.portfolio);
              console.log('âœ… Loaded portfolio from Firebase');
            }
          }
        } catch (error) {
          console.warn('Failed to load user data:', error);
        }
      };

      const saveUserDataToFirebase = async (uid) => {
        if (!window.firebaseUtils?.db) return;
        try {
          const { db, doc, setDoc } = window.firebaseUtils;
          const data = {
            watchlist,
            portfolio,
            lastUpdated: new Date().toISOString()
          };
          await setDoc(doc(db, 'users', uid), data, { merge: true });
          console.log('âœ… Saved to Firebase');
        } catch (error) {
          console.warn('Failed to save user data:', error);
        }
      };

      // Auto-save to Firebase when watchlist/portfolio changes
      useEffect(() => {
        if (firebaseUser) {
          saveUserDataToFirebase(firebaseUser.uid);
        }
      }, [watchlist, portfolio, firebaseUser]);

      // Check and unlock badges
      useEffect(() => {
        const newBadges = checkAndUnlockBadges(portfolio, watchlist, goals, {});
        if (newBadges.length > 0) {
          newBadges.forEach(badgeId => {
            const badge = BADGES[badgeId];
            if (badge) {
              addToast(`ğŸ† Badge Unlocked: ${badge.title}!`, 'success');
            }
          });
        }
      }, [portfolio, watchlist, goals]);

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // WATCHLIST SHARING
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      // Load shared watchlist from URL on mount
      useEffect(() => {
        const urlParams = new URLSearchParams(window.location.search);
        const shared = urlParams.get('watchlist');
        if (shared) {
          const symbols = shared.split(',').map(s => cleanSymbol(s.trim()));
          const cleaned = cleanWatchlist(symbols);
          setWatchlist(cleaned);
          if (cleaned.length !== symbols.length) {
            console.log(`ğŸ§¹ Cleaned shared watchlist: removed ${symbols.length - cleaned.length} invalid symbols`);
          }
          addToast('ğŸ“‹ Imported shared watchlist', 'success');
          console.log('âœ… Loaded shared watchlist:', cleaned);
        }
      }, []);

      // Track stock views for analyst badge
      const openStockModal = (stock) => {
        setSelectedStock(stock);

        // Track this view
        const viewedStocks = JSON.parse(localStorage.getItem('viewedStocks') || '[]');
        if (!viewedStocks.includes(stock.symbol)) {
          viewedStocks.push(stock.symbol);
          localStorage.setItem('viewedStocks', JSON.stringify(viewedStocks));
        }
      };

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // DATA FETCHING WITH ERROR HANDLING
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      useEffect(() => {
        // Initial fetch
        fetchStocks();

        // Set up hourly refresh (60 minutes = 3,600,000 milliseconds)
        const refreshInterval = setInterval(() => {
          console.log('â° Hourly auto-refresh triggered');
          fetchStocks();
        }, 60 * 60 * 1000); // 1 hour

        // Cleanup on unmount
        return () => clearInterval(refreshInterval);
      }, []); // Only run once on mount

      // Update next refresh time whenever stocks are fetched
      useEffect(() => {
        if (lastUpdateTime) {
          const nextUpdate = new Date(lastUpdateTime.getTime() + 60 * 60 * 1000);
          setNextUpdateTime(nextUpdate);
        }
      }, [lastUpdateTime]);

      const addError = (message, details = '') => {
        const id = Date.now().toString();
        setErrors(prev => [...prev, { id, message, details, timestamp: new Date() }]);

        // Auto-remove error after 10 seconds
        setTimeout(() => {
          setErrors(prev => prev.filter(e => e.id !== id));
        }, 10000);
      };

      const fetchSingleStockData = async (symbol) => {
        // Clean symbol to remove exchange suffixes (.O, .K, etc.)
        symbol = cleanSymbol(symbol);

        // CHECK CACHE FIRST - Dramatically speeds up loading!
        const cached = Cache.get(symbol, 'stock');
        if (cached) {
          console.log(`âš¡ Using cached data for ${symbol}`);
          return cached;
        }

        try {
          console.log(`ğŸ“¡ Fetching comprehensive data for ${symbol}... (Paid FMP API)`);

          // SEQUENTIAL API CALLS - FMP paid version doesn't allow batch calling
          // Increased delay for paid plan to avoid rate limits (200ms between requests)
          const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

          // Helper function to fetch with rate limit handling
          const fetchFMPWithRetry = async (url, retries = 3) => {
            for (let i = 0; i < retries; i++) {
              const response = await fetch(url);

              if (response.status === 429) {
                // Rate limited - wait longer (5s base, exponential backoff)
                const retryAfter = response.headers.get('Retry-After');
                const waitTime = retryAfter ? parseInt(retryAfter) * 1000 : (i + 1) * 5000;
                console.warn(`â³ FMP rate limited. Waiting ${waitTime / 1000}s before retry ${i + 1}/${retries}...`);
                await delay(waitTime);
                continue;
              }

              if (!response.ok && response.status !== 404) {
                // 404 is acceptable (endpoint might not exist), but other errors should retry
                if (i < retries - 1) {
                  await delay(2000 * (i + 1));
                  continue;
                }
              }

              return response;
            }
            return null;
          };

          const quoteRes = await fetchFMPWithRetry(`https://financialmodelingprep.com/stable/quote?symbol=${symbol}&apikey=${FMP_API_KEY}`);

          // Check for API errors
          if (!quoteRes || !quoteRes.ok) {
            const status = quoteRes?.status || 'No response';
            const statusText = quoteRes?.statusText || 'Network error or timeout';
            console.warn(`âš ï¸ Quote API failed for ${symbol}: ${status} (${statusText})`);

            if (quoteRes?.status === 429) {
              throw new Error(`Rate limited by FMP API. Please wait and try again.`);
            }

            // For invalid symbols or network errors, throw a clear error that will be caught and skipped
            if (!quoteRes) {
              throw new Error(`Stock data not available for ${symbol} (no response from API - may be invalid symbol or network issue)`);
            }

            throw new Error(`Stock data not available for ${symbol} (status ${status})`);
          }

          const quoteData = await quoteRes.json();
          await delay(500); // Increased to 500ms to avoid rate limits

          const metricsRes = await fetchFMPWithRetry(`https://financialmodelingprep.com/stable/key-metrics-ttm?symbol=${symbol}&apikey=${FMP_API_KEY}`);
          const metricsData = metricsRes?.ok ? await metricsRes.json() : null;
          await delay(500);

          const scoresRes = await fetchFMPWithRetry(`https://financialmodelingprep.com/stable/financial-scores?symbol=${symbol}&apikey=${FMP_API_KEY}`);
          const scoresData = scoresRes?.ok ? await scoresRes.json() : null;
          await delay(500);

          const ratingsRes = await fetchFMPWithRetry(`https://financialmodelingprep.com/stable/ratings-snapshot?symbol=${symbol}&apikey=${FMP_API_KEY}`);
          const ratingsData = ratingsRes?.ok ? await ratingsRes.json() : null;
          await delay(500);

          const targetRes = await fetchFMPWithRetry(`https://financialmodelingprep.com/stable/price-target-consensus?symbol=${symbol}&apikey=${FMP_API_KEY}`);
          const targetData = targetRes?.ok ? await targetRes.json() : null;
          await delay(500);

          const profileRes = await fetchFMPWithRetry(`https://financialmodelingprep.com/stable/profile?symbol=${symbol}&apikey=${FMP_API_KEY}`);
          const profileData = profileRes?.ok ? await profileRes.json() : null;
          await delay(500);

          const gradesRes = await fetchFMPWithRetry(`https://financialmodelingprep.com/stable/grades?symbol=${symbol}&limit=10&apikey=${FMP_API_KEY}`);
          const grades = gradesRes?.ok ? await gradesRes.json() : [];
          await delay(500);

          const ratiosRes = await fetchFMPWithRetry(`https://financialmodelingprep.com/stable/ratios?symbol=${symbol}&limit=1&apikey=${FMP_API_KEY}`);
          const ratiosData = ratiosRes?.ok ? await ratiosRes.json() : null;
          await delay(500);

          const growthRes = await fetchFMPWithRetry(`https://financialmodelingprep.com/stable/financial-growth?symbol=${symbol}&limit=5&apikey=${FMP_API_KEY}`);
          const growthData = growthRes?.ok ? await growthRes.json() : null;

          if (!quoteData || quoteData.length === 0) {
            throw new Error('Stock not found - empty response');
          }

          const quote = quoteData[0];
          const quoteFetchedAt = Date.now();
          const metrics = metricsData && metricsData.length > 0 ? metricsData[0] : null;
          const scores = scoresData && scoresData.length > 0 ? scoresData[0] : null;
          const ratings = ratingsData && ratingsData.length > 0 ? ratingsData[0] : null;
          const target = targetData && targetData.length > 0 ? targetData[0] : null;
          const profile = profileData && profileData.length > 0 ? profileData[0] : null;
          const ratios = ratiosData && ratiosData.length > 0 ? ratiosData[0] : null;

          const toFiniteNumberOrNull = (v) => {
            if (v === '' || v === undefined || v === null) return null;
            const n = Number(v);
            return Number.isFinite(n) ? n : null;
          };

          const pickFirstField = (obj, keys) => {
            for (const key of keys) {
              const n = toFiniteNumberOrNull(obj?.[key]);
              if (n !== null) return n;
            }
            return null;
          };

          const pickGrowthRecord = (arr) => {
            if (!Array.isArray(arr) || arr.length === 0) return null;
            const keys = {
              revenue: ['revenueGrowth', 'revenuegrowth', 'revenueGrowthYoY'],
              income: ['netIncomeGrowth', 'netincomegrowth', 'netIncomeGrowthYoY'],
              eps: ['epsGrowth', 'epsgrowth', 'epsGrowthYoY', 'epsgrowthYoY']
            };
            return (
              arr.find(g => (
                pickFirstField(g, keys.revenue) !== null ||
                pickFirstField(g, keys.income) !== null ||
                pickFirstField(g, keys.eps) !== null
              )) || arr[0]
            );
          };

          const growth = pickGrowthRecord(growthData);
          const revenueGrowthRaw = pickFirstField(growth, ['revenueGrowth', 'revenuegrowth', 'revenueGrowthYoY']);
          const netIncomeGrowthRaw = pickFirstField(growth, ['netIncomeGrowth', 'netincomegrowth', 'netIncomeGrowthYoY']);
          const epsGrowthRaw = pickFirstField(growth, ['epsGrowth', 'epsgrowth', 'epsGrowthYoY', 'epsgrowthYoY']);

          const revenueGrowthPct = revenueGrowthRaw !== null ? (revenueGrowthRaw * 100) : null;
          const netIncomeGrowthPct = netIncomeGrowthRaw !== null ? (netIncomeGrowthRaw * 100) : null;
          const epsGrowthPct = epsGrowthRaw !== null ? (epsGrowthRaw * 100) : null;
          await delay(50);

          // Earnings
          const earningsRes = await fetch(`https://financialmodelingprep.com/api/v3/historical/earning_calendar/${symbol}?apikey=${FMP_API_KEY}`);
          const earnings = earningsRes.ok ? await earningsRes.json() : [];
          await delay(50);

          // Stock Peers
          const peersRes = await fetch(`https://financialmodelingprep.com/api/v4/stock_peers?symbol=${symbol}&apikey=${FMP_API_KEY}`);
          const peersData = peersRes.ok ? await peersRes.json() : null;
          const peers = peersData && peersData.length > 0 ? peersData[0]?.peersList : [];
          await delay(50);

          // Latest News (stock-specific)
          let news = [];
          try {
            // Prefer the unified news manager (more sources; already filtered to last 30 days)
            if (window.newsManager && typeof window.newsManager.fetchNews === 'function') {
              const nmArticles = await window.newsManager.fetchNews(symbol, 10);
              news = (nmArticles || []).map(a => ({
                title: a.title,
                url: a.url,
                site: a.source || a.site || 'News',
                publishedDate: a.publishedAt || a.publishedDate || a.date,
                image: a.image
              }));
            } else {
              const newsRes = await fetch(`https://financialmodelingprep.com/api/v3/stock_news?tickers=${symbol}&limit=20&apikey=${FMP_API_KEY}`);
              if (newsRes.ok) {
                let articles = await newsRes.json();

                // Filter to ensure news mentions the stock
                const companyName = profile?.companyName?.toLowerCase() || '';
                news = articles.filter(article => {
                  if (!article.title) return false;
                  const text = (article.title + ' ' + (article.text || '')).toLowerCase();
                  const sym = symbol.toLowerCase();
                  // Check if article mentions symbol or company name
                  return text.includes(sym) || (companyName && text.includes(companyName));
                });

                // Keep only last 30 days
                const cutoff = Date.now() - (30 * 24 * 60 * 60 * 1000);
                news = (news || []).filter(a => {
                  const dt = new Date(a.publishedDate || a.date || 0).getTime();
                  return Number.isFinite(dt) && dt >= cutoff;
                });

                // If no relevant news found, take recent general results
                if (news.length === 0 && articles.length > 0) {
                  console.warn(`No recent filtered news (30d) for ${symbol}, using general recent results`);
                  news = (articles || []).filter(a => {
                    const dt = new Date(a.publishedDate || a.date || 0).getTime();
                    return Number.isFinite(dt) && dt >= cutoff;
                  }).slice(0, 10);
                } else {
                  // Prioritize analyst/rating/price-target updates within the relevant set
                  if (window.newsManager && typeof window.newsManager.getAnalystUpdateScore === 'function') {
                    news.sort((a, b) => {
                      const scoreB = window.newsManager.getAnalystUpdateScore(
                        { title: b.title, description: b.text || b.content || '' },
                        symbol
                      );
                      const scoreA = window.newsManager.getAnalystUpdateScore(
                        { title: a.title, description: a.text || a.content || '' },
                        symbol
                      );
                      if (scoreB !== scoreA) return scoreB - scoreA;
                      return new Date(b.publishedDate || b.date || 0) - new Date(a.publishedDate || a.date || 0);
                    });
                  }

                  news = news.slice(0, 10);
                }
              }
            }
          } catch (err) {
            console.warn(`News fetch failed for ${symbol}:`, err);
            news = [];
          }

          console.log(`âœ… ${symbol}: Fetched 12 endpoints (${news.length} news articles)`);

          // DEBUG: Log price data to verify API values
          console.log(`   ğŸ“Š Price Data for ${symbol}:`);
          console.log(`      Current: $${quote.price}`);
          console.log(`      Day High: $${quote.dayHigh || 'MISSING'}`);
          console.log(`      Day Low: $${quote.dayLow || 'MISSING'}`);
          console.log(`      Year High: $${quote.yearHigh || 'MISSING'}`);
          console.log(`      Year Low: $${quote.yearLow || 'MISSING'}`);
          console.log(`      Open: $${quote.open || 'MISSING'}`);
          console.log(`      Prev Close: $${quote.previousClose || 'MISSING'}`);
          console.log(`      Avg Volume: ${profile?.averageVolume || 'MISSING'}`);

          // Build comprehensive stock object
          const stockData = {
            symbol: quote.symbol,
            companyName: profile?.companyName || quote.name || symbol,
            sector: profile?.sector || quote.sector || 'Unknown',
            industry: profile?.industry || quote.industry || 'Unknown',
            description: profile?.description || '',
            website: profile?.website || '',
            ceo: profile?.ceo || '',

            // Data freshness
            quoteFetchedAt,
            fetchedAt: Date.now(),

            // Price Data
            price: quote.price,
            change: quote.change || 0,
            changePct: quote.changesPercentage || 0,
            volume: quote.volume,
            avgVolume: profile?.averageVolume || 0,
            marketCap: quote.marketCap,
            beta: profile?.beta || 1.0,

            // Daily Range
            dayHigh: quote.dayHigh || 0,
            dayLow: quote.dayLow || 0,
            open: quote.open || 0,
            previousClose: quote.previousClose || 0,

            // 52-Week Range
            yearHigh: quote.yearHigh || 0,
            yearLow: quote.yearLow || 0,

            // Valuation Metrics
            pe: metrics?.earningsYieldTTM ? (1 / metrics.earningsYieldTTM) : (quote.pe || 0),
            priceToBook: ratios?.priceToBookRatio || 0,
            priceToSales: ratios?.priceToSalesRatio || 0,
            enterpriseValue: metrics?.enterpriseValueTTM || 0,
            evToEbitda: metrics?.evToEBITDATTM || 0,

            // Profitability
            roe: metrics?.returnOnEquityTTM ? (metrics.returnOnEquityTTM * 100) : 0,
            roa: metrics?.returnOnAssetsTTM ? (metrics.returnOnAssetsTTM * 100) : 0,
            roic: metrics?.returnOnInvestedCapitalTTM ? (metrics.returnOnInvestedCapitalTTM * 100) : 0,
            grossMargin: ratios?.grossProfitMargin ? (ratios.grossProfitMargin * 100) : 0,
            operatingMargin: ratios?.operatingProfitMargin ? (ratios.operatingProfitMargin * 100) : 0,
            netMargin: ratios?.netProfitMargin ? (ratios.netProfitMargin * 100) : 0,

            // Financial Health
            currentRatio: metrics?.currentRatioTTM || ratios?.currentRatio || 0,
            quickRatio: metrics?.quickRatioTTM || ratios?.quickRatio || 0,
            debtToEquity: ratios?.debtEquityRatio || metrics?.netDebtToEBITDATTM || 0,
            debtToAssets: ratios?.debtRatio || 0,
            cashRatio: ratios?.cashRatio || 0,

            // Growth Metrics
            revenueGrowth: revenueGrowthPct,
            netIncomeGrowth: netIncomeGrowthPct,
            epsGrowth: epsGrowthPct,

            // Quality Scores
            piotroskiScore: scores?.piotroskiScore || 0,
            altmanZScore: scores?.altmanZScore || 0,

            // Analyst Data
            analystRating: ratings?.rating || 'N/A',
            overallScore: ratings?.overallScore || 0,
            priceTarget: target?.lastQuarterAvgPriceTarget || 0,
            priceTargetLow: target?.lastMonthAvgPriceTarget || 0,
            priceTargetAvg: target?.lastQuarterAvgPriceTarget || 0,
            analystCount: target?.lastQuarterCount || 0,
            upside: target?.lastQuarterAvgPriceTarget && quote.price
              ? ((target.lastQuarterAvgPriceTarget - quote.price) / quote.price * 100)
              : 0,

            // Latest Analyst Grade
            latestGrade: grades && grades.length > 0 ? grades[0] : null,
            analystGradeHistory: grades.slice(0, 10),

            // Earnings
            lastEarnings: earnings && earnings.length > 0 ? earnings[0] : null,
            earningsHistory: earnings.slice(0, 4),

            // Peers
            peers: peers || [],

            // News
            latestNews: news.slice(0, 10),

            // Additional
            exchange: quote.exchange,
            index: 'Search Result',
            rsi: 50,
            sparkline: Array.from({ length: 20 }, () => quote.price * (0.98 + Math.random() * 0.04))
          };

          // Preserve previous snapshot for explainability diffs
          try {
            const currentKey = Cache.key(symbol, 'stock');
            const prevKey = Cache.key(symbol, 'stock_prev');
            const existing = localStorage.getItem(currentKey);
            if (existing) localStorage.setItem(prevKey, existing);
          } catch (e) {
            // ignore localStorage issues
          }

          // CACHE THE DATA for faster subsequent loads
          Cache.set(symbol, stockData, 'stock');

          return stockData;
        } catch (error) {
          console.error(`Error fetching ${symbol}:`, error);
          throw error;
        }
      };

      const addToCurated = () => {
        const symbol = newStockSymbol.trim().toUpperCase();
        if (!symbol) return;
        if (curatedStocks.includes(symbol)) {
          addError('Stock already in list', `${symbol} is already in your curated list`);
          return;
        }
        // Remove duplicates when adding
        const updated = [...new Set([...curatedStocks, symbol])];
        setCuratedStocks(updated);
        BatchedLocalStorage.set('curatedStocks', updated);
        setNewStockSymbol('');
        fetchStocks(); // Reload with new stock
      };

      const removeFromCurated = (symbol) => {
        const updated = curatedStocks.filter(s => s !== symbol);
        setCuratedStocks(updated);
        BatchedLocalStorage.set('curatedStocks', updated);
        fetchStocks(); // Reload without removed stock
      };

      // FIX: Simple RSI calculator from price change percentage
      const calculateSimpleRSI = (quote) => {
        try {
          const change = quote.changesPercentage || quote.changePct || 0;
          const price = quote.price || quote.c || 0;
          
          if (!price || price <= 0) return 50; // Neutral default
          
          // Simple RSI approximation based on daily change
          // Strong positive = RSI > 70, strong negative = RSI < 30
          if (change > 8) return 75;  // Very overbought
          if (change > 5) return 68;  // Overbought
          if (change > 2) return 58;  // Slightly bullish
          if (change > 0) return 52;  // Neutral bullish
          if (change > -2) return 48; // Neutral bearish
          if (change > -5) return 42; // Slightly bearish
          if (change > -8) return 32; // Oversold
          return 25; // Very oversold
        } catch {
          return 50;
        }
      };

      const fetchStocks = async () => {
        // Use a ref-like check to prevent overlapping fetches
        if (window.isFetchingStocks) {
          console.log('â³ Fetch already in progress, skipping...');
          return;
        }
        window.isFetchingStocks = true;

        setErrors([]);
        const startTime = new Date();
        
        // FIX: Declare at function scope so they're accessible in finally block
        let uniqueCuratedStocks = [];
        let allStocks = [];
        let completedCount = 0;
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ULTRA-FAST STARTUP: Check localStorage first (sync), then IndexedDB
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let hasCachedData = false;
        
        // Step 1: Try FAST localStorage session restore (optimized for large datasets!)
        try {
          const sessionKey = 're_fast_session_v1';
          const sessionData = localStorage.getItem(sessionKey);
          if (sessionData) {
            // OPTIMIZATION: Parse JSON in idle time to avoid blocking main thread
            const parseStart = performance.now();
            const parsed = JSON.parse(sessionData);
            const parseTime = performance.now() - parseStart;
            
            if (parseTime > 50) {
              console.warn(`âš ï¸ Session parse took ${parseTime.toFixed(0)}ms - consider compression`);
            }
            
            const { stocks: cachedStocks, timestamp } = parsed;
            const age = Date.now() - timestamp;
            
            // Use session if less than 4 hours old
            if (age < 4 * 60 * 60 * 1000 && cachedStocks && cachedStocks.length > 50) {
              console.log(`âš¡ INSTANT: Restored ${cachedStocks.length} stocks from session (${Math.round(age/60000)}min old, parsed in ${parseTime.toFixed(0)}ms)`);
              
              // OPTIMIZATION: Defer sort to avoid blocking
              requestIdleCallback(() => {
                const sorted = [...cachedStocks].sort((a, b) => (b.marketCap || 0) - (a.marketCap || 0));
                setStocks(sorted);
              }, { timeout: 100 });
              
              // Show unsorted immediately
              setStocks(cachedStocks);
              setLoading(false);
              hasCachedData = true;
            }
          }
        } catch (e) {
          console.warn('Session restore failed:', e);
        }
        
        // Step 2: If no session, try IndexedDB (async but still fast)
        if (!hasCachedData) {
          try {
            const instantCached = await window.PrefetchManager?.loadAllFromCache();
            if (instantCached && instantCached.length > 50) {
              console.log(`âš¡ INSTANT: Loaded ${instantCached.length} stocks from IndexedDB`);
              setStocks(instantCached.sort((a, b) => (b.marketCap || 0) - (a.marketCap || 0)));
              setLoading(false);
              hasCachedData = true;
            }
          } catch (e) {
            console.warn('IndexedDB load failed:', e);
          }
        }
        
        // Step 3: Show placeholders if no cache (users see something immediately)
        if (!hasCachedData) {
          console.log(`ğŸ¯ No cache - showing ${curatedStocks.length} placeholders...`);
          const placeholders = PlaceholderManager.createPlaceholders(curatedStocks);
          setStocks(placeholders);
          setLoading(false);
        }
        
        setLoadingProgress({ current: 0, total: curatedStocks.length || 0 });

        // Track if we should force completion
        let forceComplete = false;
        let allStocksCollected = [];
        let finalCompletedCount = 0;
        let stocksDisplayed = false;
        let progressCheckInterval = null;

        // Add a global timeout to force completion after 3 minutes
        const globalTimeout = setTimeout(() => {
          console.warn('â±ï¸ Global timeout reached (3 minutes), forcing completion with available stocks...');
          forceComplete = true;
        }, 180000); // 3 minutes

        try {
          console.log('ğŸ”„ Loading', curatedStocks.length, 'stocks...');

          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // FAST BATCH QUOTE LOADER - Fetches 100 stocks per API call!
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          const fetchBatchQuotesOnly = async (symbols) => {
            const results = [];
            const BATCH_SIZE = 100; // FMP supports up to 100 symbols per call
            
            for (let i = 0; i < symbols.length; i += BATCH_SIZE) {
              const batch = symbols.slice(i, i + BATCH_SIZE);
              const batchNum = Math.floor(i / BATCH_SIZE) + 1;
              const totalBatches = Math.ceil(symbols.length / BATCH_SIZE);
              
              console.log(`ğŸš€ Batch quote ${batchNum}/${totalBatches}: Fetching ${batch.length} stocks in ONE call...`);
              
              try {
                const url = `https://financialmodelingprep.com/api/v3/quote/${batch.join(',')}?apikey=${FMP_API_KEY}`;
                const response = await fetch(url);
                
                if (response.status === 429) {
                  console.warn('â³ Rate limited on batch quote, waiting 10s...');
                  await new Promise(r => setTimeout(r, 10000));
                  i -= BATCH_SIZE; // Retry this batch
                  continue;
                }
                
                if (response.ok) {
                  const data = await response.json();
                  if (Array.isArray(data)) {
                    results.push(...data);
                    console.log(`âœ… Got ${data.length} quotes in batch ${batchNum}`);
                  }
                }
                
                // Small delay between batches to avoid rate limits
                if (i + BATCH_SIZE < symbols.length) {
                  await new Promise(r => setTimeout(r, 1000));
                }
              } catch (error) {
                console.warn(`Batch ${batchNum} failed:`, error);
              }
            }
            
            return results;
          };

          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // OPTIMIZED: Batch cache check instead of sequential loop
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          // Remove duplicates from curatedStocks before processing
          uniqueCuratedStocks = [...new Set(curatedStocks.map(s => String(s).toUpperCase().trim()).filter(s => s))];

          // SINGLE BATCH OPERATION instead of 951 individual calls!
          const batchStart = performance.now();
          const { cached: cachedStocks, uncached: uncachedSymbols } = Cache.getBatch(uniqueCuratedStocks, 'stock');
          const batchTime = performance.now() - batchStart;
          
          if (batchTime > 100) {
            console.warn(`âš ï¸ Batch cache check took ${batchTime.toFixed(0)}ms for ${uniqueCuratedStocks.length} symbols`);
          }

          // Update curatedStocks if duplicates were found
          if (uniqueCuratedStocks.length !== curatedStocks.length) {
            console.log(`ğŸ§¹ Removed ${curatedStocks.length - uniqueCuratedStocks.length} duplicate symbols from curated list`);
            setCuratedStocks(uniqueCuratedStocks);
            debouncedLocalStorage.setItemImmediate('curatedStocks', JSON.stringify(uniqueCuratedStocks));
          }

          console.log(`âš¡ Found ${cachedStocks.length} cached stocks, ${uncachedSymbols.length} need fetching`);
          
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          // STREAMING BATCH LOADER - Display stocks AS THEY LOAD (instant UI!)
          // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          if (uncachedSymbols.length > 0) {
            console.log('ğŸš€ STREAMING batch loader for', uncachedSymbols.length, 'stocks...');
            
            const BATCH_SIZE = 20; // Backend processes individually - keep batches small
            const loadedSymbols = new Set();
            let displayedCount = 0;
            
            // OPTIMIZATION: Accumulate all batches, then ONE final update
            const allBatchStocks = [];
            
            // Process each batch and display immediately
            for (let i = 0; i < uncachedSymbols.length; i += BATCH_SIZE) {
              const batch = uncachedSymbols.slice(i, i + BATCH_SIZE);
              const batchNum = Math.floor(i / BATCH_SIZE) + 1;
              const totalBatches = Math.ceil(uncachedSymbols.length / BATCH_SIZE);
              
              console.log(`ğŸš€ Batch ${batchNum}/${totalBatches}: Loading ${batch.length} stocks...`);
              
              try {
                // Use secure backend proxy for batch quotes
                const response = await fetch(`${window.API_BASE_URL}/api/quotes/batch`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ symbols: batch })
                });
                
                if (response.status === 429) {
                  console.warn('â³ Rate limited, waiting 5s...');
                  await new Promise(r => setTimeout(r, 5000));
                  i -= BATCH_SIZE; // Retry this batch
                  continue;
                }
                
                if (!response.ok) {
                  const errorText = await response.text();
                  console.error(`âŒ Batch ${batchNum} failed with ${response.status}:`, errorText.substring(0, 200));
                  continue;
                }
                
                const data = await response.json();
                
                if (!Array.isArray(data)) {
                  console.error(`âŒ Batch ${batchNum} returned non-array:`, typeof data, data);
                  continue;
                }
                
                if (data.length === 0) {
                  console.warn(`âš ï¸ Batch ${batchNum} returned empty array for ${batch.length} symbols`);
                  continue;
                }
                
                console.log(`âœ… Batch ${batchNum} received ${data.length} stocks`);
                
                const batchStocks = [];
                
                // OPTIMIZATION: Batch AI computation using requestIdleCallback
                const pendingAI = [];
                
                data.forEach(quote => {
                      if (!quote || !quote.symbol) return;
                      
                      // FIX: Check if we have cached data with full fields for screeners
                      const cachedFull = Cache.get(quote.symbol, 'stock');
                      
                      const stockData = {
                        symbol: quote.symbol,
                        name: quote.name || quote.symbol,
                        companyName: quote.name || quote.symbol, // FIX: Add companyName for filtering
                        sector: cachedFull?.sector || 'Unknown', // FIX: Add sector for filtering
                        industry: cachedFull?.industry || 'Unknown',
                        price: quote.price,
                        changePct: quote.changesPercentage,
                        change: quote.change,
                        volume: quote.volume,
                        avgVolume: quote.avgVolume,
                        marketCap: quote.marketCap,
                        pe: quote.pe,
                        eps: quote.eps,
                        // FIX: Use cached data if available for screener fields
                        roe: cachedFull?.roe || quote.roe || 0,
                        revenueGrowth: cachedFull?.revenueGrowth || 0,
                        debtToEquity: cachedFull?.debtToEquity || 0,
                        beta: cachedFull?.beta || quote.beta || 1.0,
                        // FIX: Calculate RSI from price data instead of hardcoding to 50
                        rsi: cachedFull?.rsi || calculateSimpleRSI(quote),
                        high52: quote.yearHigh,
                        low52: quote.yearLow,
                        dayHigh: quote.dayHigh,
                        dayLow: quote.dayLow,
                        open: quote.open,
                        previousClose: quote.previousClose,
                        exchange: quote.exchange,
                        index: 'Curated',
                        _batchLoaded: true,
                        _needsEnrichment: !cachedFull // Mark for background enrichment if no cache
                      };
                      
                      // Add AI analysis inline (cached, so fast!)
                      const ai = generateAIAnalysis(stockData);
                      Object.assign(stockData, ai);
                      
                      // Cache for future use (async, non-blocking)
                      requestIdleCallback(() => {
                        Cache.set(quote.symbol, stockData, 'stock');
                      });
                      
                      cachedStocks.push({ symbol: quote.symbol, data: stockData });
                      loadedSymbols.add(quote.symbol.toUpperCase());
                      batchStocks.push(stockData);
                      
                      // FIX: Also populate allStocks for final processing
                      allStocks.push(stockData);
                      completedCount++;
                    });
                    
                    // Accumulate for batch display
                    allBatchStocks.push(...batchStocks);
                    displayedCount += batchStocks.length;
                    
                    // OPTIMIZATION: Update UI every 2 batches (200 stocks) for smoother experience
                    const shouldUpdate = (batchNum % 2 === 0) || (i + BATCH_SIZE >= uncachedSymbols.length);
                    
                    if (shouldUpdate && allBatchStocks.length > 0) {
                      // ONE update with all accumulated stocks (no intermediate sorts!)
                      setStocks(prev => {
                        const existing = new Set(prev.map(s => s.symbol?.toUpperCase()));
                        const newStocks = allBatchStocks.filter(s => !existing.has(s.symbol?.toUpperCase()));
                        // DEFER SORTING - just merge for now
                        return [...prev, ...newStocks];
                      });
                      
                      allBatchStocks.length = 0; // Clear accumulator
                      
                      setLoading(false); // Show UI after first update!
                      setLoadingProgress({ current: displayedCount, total: uncachedSymbols.length });
                      console.log(`âœ… Batch ${batchNum}: ${batchStocks.length} stocks DISPLAYED! Total visible: ${displayedCount}`);
                    }
                
                // OPTIMIZATION: Reduced delay between batches (50ms instead of 150ms!)
                if (i + BATCH_SIZE < uncachedSymbols.length) {
                  await new Promise(r => setTimeout(r, 50));
                }
              } catch (error) {
                console.error(`âŒ Batch ${batchNum} exception:`, error.message, error.stack);
              }
            }
            
            // Clear uncachedSymbols - batch loading complete
            uncachedSymbols.length = 0;
            console.log(`âœ… Streaming complete! ${displayedCount} stocks loaded`);
            
            // FIX: Background enrichment for stocks missing screener fields - TEMPORARILY DISABLED
            // This was causing crashes - will re-enable after debugging
            console.log('â„¹ï¸ Background enrichment temporarily disabled for stability');
            
            // OPTIMIZATION: Sort ONCE at the end using requestIdleCallback to avoid blocking
            requestIdleCallback(() => {
              setStocks(prev => {
                const sorted = [...prev].sort((a, b) => (b.marketCap || 0) - (a.marketCap || 0));
                console.log('ğŸ“Š Final sort complete');
                return sorted;
              });
            }, { timeout: 100 });
            
            // Save session ASYNCHRONOUSLY (don't block UI)
            if (window.SessionPersistence && cachedStocks.length > 0) {
              setTimeout(() => {
                try {
                  SessionPersistence.saveSession(cachedStocks.map(s => s.data), {}, []);
                  console.log('ğŸ’¾ Session saved in background');
                } catch (err) {
                  console.warn('Session save failed (non-critical):', err.message);
                }
              }, 5000); // Save after 5 seconds, don't block
            }
          }

          // OPTIMIZATION: Batched stock updates instead of incremental
          let pendingStockUpdates = [];
          let updateTimer = null;
          
          const flushStockUpdates = () => {
            if (pendingStockUpdates.length === 0) return;
            
            const toUpdate = [...pendingStockUpdates];
            pendingStockUpdates = [];
            
            setStocks(prevStocks => {
              // Build a map for O(1) lookups
              const stockMap = new Map(prevStocks.map(s => [s.symbol?.toUpperCase()?.trim(), s]));
              
              // Add/update all pending stocks
              toUpdate.forEach(newStock => {
                const symbolUpper = newStock.symbol?.toUpperCase()?.trim();
                if (symbolUpper) {
                  stockMap.set(symbolUpper, newStock);
                }
              });
              
              // Convert back to array (DEFER SORT - will sort once at end)
              return Array.from(stockMap.values());
            });
            
            if (pendingStockUpdates.length >= 10) {
              setLoading(false);
            }
          };
          
          // Helper function to batch stock updates
          const updateStocksIncrementally = (newStock) => {
            if (!newStock || !newStock.symbol) return;
            
            pendingStockUpdates.push(newStock);
            
            // Batch updates every 100ms
            if (updateTimer) clearTimeout(updateTimer);
            updateTimer = setTimeout(flushStockUpdates, 100);
          };

          // Process cached stocks INSTANTLY!
          if (cachedStocks.length > 0) {
            console.log(`ğŸš€ Displaying ${cachedStocks.length} cached stocks instantly...`);
            
            const processedStocks = [];
            let needsAI = 0;
            
            cachedStocks.forEach(({ symbol, data: stockData }) => {
              try {
                stockData.index = 'Curated';
                
                // ONLY compute AI if missing (avoid re-computation!)
                if (!stockData.aiScore && !stockData.verdict) {
                  needsAI++;
                  if (processedStocks.length < 50) {
                    // Compute for first 50 visible stocks
                    const ai = generateAIAnalysis(stockData);
                    Object.assign(stockData, ai);
                  } else {
                    // Mark for lazy loading
                    stockData._needsAI = true;
                  }
                }
                
                const stockWithData = {
                  ...stockData,
                  mlPrediction: stockData.mlPrediction || { predPct: null, conf: null, trend: null }
                };
                
                processedStocks.push(stockWithData);
                
                // FIX: Also populate allStocks and increment completedCount
                allStocks.push(stockWithData);
                completedCount++;
              } catch (err) {
                processedStocks.push(stockData);
                allStocks.push(stockData);
                completedCount++;
              }
            });

            console.log(`âš¡ ${needsAI} stocks need AI analysis (computing first 50 instantly, rest on-demand)`);

            // ONE batch update - instant UI!
            processedStocks.sort((a, b) => (b.marketCap || 0) - (a.marketCap || 0));
            setStocks(processedStocks);
            setLoading(false);
            setLoadingProgress({ current: processedStocks.length, total: uniqueCuratedStocks.length });
            console.log(`âœ… ${processedStocks.length} stocks displayed instantly!`);
            console.log('ğŸ“Š Sample of loaded stocks:', processedStocks.slice(0, 3).map(s => ({
              symbol: s.symbol,
              name: s.name,
              companyName: s.companyName,
              price: s.price,
              sector: s.sector
            })));
            
            // OPTIMIZATION: Compute AI for remaining cached stocks in background using chunked idle processing
            if (needsAI > 50) {
              setTimeout(() => {
                const remaining = processedStocks.filter(s => s._needsAI);
                console.log(`ğŸ”„ Computing AI for ${remaining.length} stocks in background...`);
                
                // Process in chunks of 20 using requestIdleCallback
                const CHUNK_SIZE = 20;
                let currentIndex = 0;
                
                const processChunk = (deadline) => {
                  // Process while we have time or until we hit chunk size
                  let processed = 0;
                  while (currentIndex < remaining.length && processed < CHUNK_SIZE && deadline.timeRemaining() > 0) {
                    const stock = remaining[currentIndex];
                    if (stock._needsAI) {
                      const ai = generateAIAnalysis(stock);
                      Object.assign(stock, ai);
                      delete stock._needsAI;
                      // Cache asynchronously
                      requestIdleCallback(() => Cache.set(stock.symbol, stock, 'stock'));
                    }
                    currentIndex++;
                    processed++;
                  }
                  
                  // Schedule next chunk if more remain
                  if (currentIndex < remaining.length) {
                    requestIdleCallback(processChunk, { timeout: 50 });
                  } else {
                    console.log(`âœ… Background AI complete for ${remaining.length} stocks`);
                  }
                };
                
                requestIdleCallback(processChunk, { timeout: 50 });
              }, 2000);
            }
            
            // OPTIMIZATION: ML predictions in background (batch updates instead of individual)
            setTimeout(() => {
              const top20 = processedStocks.slice(0, 20);
              const mlPromises = top20.map(stock => 
                computeMLPrediction(stock.symbol)
                  .then(ml => ({ symbol: stock.symbol, ml }))
                  .catch(() => ({ symbol: stock.symbol, ml: { predPct: null, conf: null, trend: null } }))
              );
              
              // Wait for all predictions, then ONE state update
              Promise.allSettled(mlPromises).then(results => {
                const mlMap = new Map();
                results.forEach(result => {
                  if (result.status === 'fulfilled' && result.value) {
                    mlMap.set(result.value.symbol, result.value.ml);
                  }
                });
                
                // Single batched update
                if (mlMap.size > 0) {
                  setStocks(prev => prev.map(s => 
                    mlMap.has(s.symbol) ? { ...s, mlPrediction: mlMap.get(s.symbol) } : s
                  ));
                  console.log(`âœ… ML predictions complete for ${mlMap.size} stocks`);
                }
              });
            }, 5000);
          }

          // SKIP slow individual fetch completely - streaming batch already got everything
          uncachedSymbols.length = 0;
          
          if (uncachedSymbols.length > 0) {
            // Helper function to add timeout to promises
            const withTimeout = (promise, timeoutMs, symbol) => {
              let timeoutId;
              const timeoutPromise = new Promise((_, reject) => {
                timeoutId = setTimeout(() => {
                  reject(new Error(`Timeout after ${timeoutMs}ms`));
                }, timeoutMs);
              });

              return Promise.race([
                promise.finally(() => {
                  if (timeoutId) clearTimeout(timeoutId);
                }),
                timeoutPromise
              ]).catch(err => {
                if (timeoutId) clearTimeout(timeoutId);
                if (err.message.includes('Timeout')) {
                  console.warn(`â±ï¸ ${symbol} timed out after ${timeoutMs}ms, skipping...`);
                }
                throw err;
              });
            };

            // Helper function to fetch a single stock (lazy promise creation)
            const fetchStock = async (symbol, index) => {
              console.log(`ğŸ“¡ [${index + 1}/${uncachedSymbols.length}] Fetching ${symbol}...`);

              try {
                // Wrap fetchSingleStockData with timeout (30 seconds)
                const stockData = await withTimeout(
                  fetchSingleStockData(symbol),
                  30000,
                  symbol
                );
                stockData.index = 'Curated';

                const ai = generateAIAnalysis(stockData);

                let mlPrediction = { predPct: null, conf: null, trend: null };
                try {
                  // Wrap ML prediction with shorter timeout (10 seconds)
                  mlPrediction = await withTimeout(
                    computeMLPrediction(symbol),
                    10000,
                    symbol
                  );
                } catch (e) {
                  console.warn(`ML prediction failed for ${symbol}:`, e.message || e);
                }

                const stockWithAnalysis = {
                  ...stockData,
                  ...ai,
                  aiScore: ai.aiScore,
                  mlPrediction,
                  subscores: ai.subscores ? { ...ai.subscores } : null,
                  topDrivers: ai.topDrivers ? {
                    positive: ai.topDrivers.positive ? [...ai.topDrivers.positive] : [],
                    negative: ai.topDrivers.negative ? [...ai.topDrivers.negative] : []
                  } : null,
                  bullFactors: ai.bullFactors ? [...ai.bullFactors] : [],
                  bearFactors: ai.bearFactors ? [...ai.bearFactors] : [],
                  latestNews: stockData.latestNews ? [...stockData.latestNews] : [],
                  peers: stockData.peers ? [...stockData.peers] : [],
                  earningsHistory: stockData.earningsHistory ? [...stockData.earningsHistory] : [],
                  analystGradeHistory: stockData.analystGradeHistory ? [...stockData.analystGradeHistory] : [],
                };
                allStocks.push(stockWithAnalysis);

                // Display stock immediately as it's loaded
                updateStocksIncrementally(stockWithAnalysis);

                completedCount++;
                setLoadingProgress({ current: completedCount, total: uniqueCuratedStocks.length });

                console.log(`âœ… ${symbol}: $${stockData.price} | P/E: ${stockData.pe.toFixed(1)} | ROE: ${stockData.roe.toFixed(1)}% | Rating: ${stockData.analystRating}`);

                return { success: true, symbol };
              } catch (err) {
                // Log error but don't spam console for expected failures (invalid symbols)
                const isExpectedFailure = err.message?.includes('not available') ||
                  err.message?.includes('No response') ||
                  err.message?.includes('invalid symbol');

                if (isExpectedFailure) {
                  console.warn(`âš ï¸ ${symbol}: ${err.message}`);
                } else {
                  console.error(`âŒ ${symbol} failed:`, err);
                }

                // Only add to error list if it's not an expected failure
                if (!isExpectedFailure) {
                  addError(`Failed to fetch ${symbol}`, err.message);
                }

                completedCount++;
                setLoadingProgress({ current: completedCount, total: uniqueCuratedStocks.length });
                return { success: false, symbol, error: err.message };
              }
            };

            // Execute uncached stocks in optimized batches (lazy promise creation)
            const BATCH_SIZE = 5;
            const BATCH_DELAY = 500;
            const MAX_BATCH_TIME = 60000; // Maximum 60 seconds per batch

            for (let i = 0; i < uncachedSymbols.length; i += BATCH_SIZE) {
              const batchSymbols = uncachedSymbols.slice(i, i + BATCH_SIZE);
              const batchNum = Math.floor(i / BATCH_SIZE) + 1;
              const totalBatches = Math.ceil(uncachedSymbols.length / BATCH_SIZE);

              console.log(`âš¡ Processing batch ${batchNum}/${totalBatches} (${batchSymbols.length} stocks)...`);

              // Create promises lazily for this batch only
              const batchPromises = batchSymbols.map((symbol, batchIdx) =>
                fetchStock(symbol, i + batchIdx + 1)
              );

              try {
                // Check if we should force completion
                if (forceComplete) {
                  console.warn(`â±ï¸ Force completion triggered, skipping remaining batches`);
                  // Mark all remaining items as completed
                  for (let j = 0; j < batchSymbols.length && completedCount < uniqueCuratedStocks.length; j++) {
                    completedCount++;
                    setLoadingProgress({ current: completedCount, total: uniqueCuratedStocks.length });
                  }
                  break; // Exit the batch loop
                }

                // Wait for all promises in batch to settle, with overall timeout that actually forces completion
                const batchPromise = Promise.allSettled(batchPromises);

                // Create a timeout promise that resolves after MAX_BATCH_TIME
                const timeoutPromise = new Promise((resolve) => {
                  setTimeout(() => {
                    console.warn(`â±ï¸ Batch ${batchNum} exceeded maximum time (${MAX_BATCH_TIME}ms), forcing completion...`);
                    resolve('timeout');
                  }, MAX_BATCH_TIME);
                });

                // Race between batch completion and timeout
                const raceResult = await Promise.race([batchPromise, timeoutPromise]);

                let results;
                if (raceResult === 'timeout') {
                  // Timeout occurred - mark all pending items as failed and continue
                  console.warn(`âš ï¸ Batch ${batchNum} timed out, marking remaining items as failed`);
                  results = batchPromises.map((promise, idx) => {
                    return {
                      status: 'rejected',
                      reason: new Error('Batch timeout'),
                      symbol: batchSymbols[idx]
                    };
                  });
                  // Update progress for all items in timed-out batch
                  for (let j = 0; j < batchSymbols.length && completedCount < uniqueCuratedStocks.length; j++) {
                    completedCount++;
                    setLoadingProgress({ current: completedCount, total: uniqueCuratedStocks.length });
                  }
                } else {
                  // Batch completed normally
                  results = raceResult;
                }

                // Process results
                if (Array.isArray(results)) {
                  results.forEach((result, idx) => {
                    const symbol = batchSymbols[idx];
                    if (result.status === 'rejected') {
                      console.warn(`âš ï¸ ${symbol} failed:`, result.reason?.message || result.reason);
                      // Ensure progress is updated (if not already updated)
                      if (completedCount < uniqueCuratedStocks.length) {
                        completedCount++;
                        setLoadingProgress({ current: completedCount, total: uniqueCuratedStocks.length });
                      }
                    } else if (result.value && !result.value.success) {
                      // Already handled in fetchStock, but ensure progress
                      if (completedCount < uniqueCuratedStocks.length) {
                        completedCount++;
                        setLoadingProgress({ current: completedCount, total: uniqueCuratedStocks.length });
                      }
                    }
                  });
                }
              } catch (batchError) {
                console.error(`âŒ Batch ${batchNum} error:`, batchError);
                // Update progress for all items in this batch to prevent getting stuck
                for (let j = 0; j < batchSymbols.length && completedCount < uniqueCuratedStocks.length; j++) {
                  completedCount++;
                  setLoadingProgress({ current: completedCount, total: uniqueCuratedStocks.length });
                }
              }

              if (i + BATCH_SIZE < uncachedSymbols.length) {
                await new Promise(r => setTimeout(r, BATCH_DELAY));
              }
            }
          }

          // Store final values
          allStocksCollected = allStocks;
          finalCompletedCount = completedCount;

          console.log('âœ… Total loaded:', allStocks.length, 'of', curatedStocks.length, 'stocks with full data');
          console.log('ğŸ“Š Progress: completedCount =', completedCount, ', curatedStocks.length =', curatedStocks.length);

          // OPTIMIZATION: Use Map for O(1) deduplication instead of Set + filter
          const uniqueStocksMap = new Map();
          allStocks.forEach(stock => {
            const symbol = stock.symbol?.toUpperCase()?.trim();
            if (symbol && !uniqueStocksMap.has(symbol)) {
              uniqueStocksMap.set(symbol, stock);
            }
          });
          const uniqueStocks = Array.from(uniqueStocksMap.values());

          if (uniqueStocks.length !== allStocks.length) {
            console.log(`ğŸ§¹ Removed ${allStocks.length - uniqueStocks.length} duplicate stocks`);
          }

          // Final check: ensure progress matches actual completion
          const remaining = uniqueCuratedStocks.length - completedCount;
          if (remaining > 0) {
            console.warn(`âš ï¸ ${remaining} stocks not completed, but proceeding with ${uniqueStocks.length} loaded stocks`);
            // Update progress to show all as "processed" (even if failed)
            setLoadingProgress({ current: uniqueCuratedStocks.length, total: uniqueCuratedStocks.length });
          }

          // OPTIMIZATION: Defer final sort to avoid blocking main thread
          if (uniqueStocks.length > 0) {
            // Stop loading spinner immediately
            setLoading(false);
            console.log('âœ… Loading stopped - stocks are now visible');
            
            // Sort in idle time using requestIdleCallback
            requestIdleCallback(() => {
              uniqueStocks.sort((a, b) => (b.marketCap || 0) - (a.marketCap || 0));
              setStocks(uniqueStocks); // Final sync to ensure all stocks are properly sorted
              setLastUpdateTime(startTime);
              console.log('âœ… Final sync: Stocks set:', uniqueStocks.length, 'unique stocks displayed');
              console.log('ğŸ“Š Sample stocks:', uniqueStocks.slice(0, 5).map(s => s.symbol).join(', '));
            }, { timeout: 500 });

            if (uniqueStocks.length < uniqueCuratedStocks.length) {
              const missing = uniqueCuratedStocks.length - uniqueStocks.length;
              console.warn(`âš ï¸ Only ${uniqueStocks.length} of ${uniqueCuratedStocks.length} stocks loaded (${missing} failed or timed out)`);
            }
          } else {
            console.warn('âš ï¸ No stocks loaded, but completedCount =', completedCount);
            console.warn('âš ï¸ allStocks array length:', allStocks.length);
            // If we processed stocks but none were added, there might be an issue
            if (completedCount >= uniqueCuratedStocks.length * 0.9) {
              // If we processed 90%+, something went wrong with data collection
              console.error('âŒ Most stocks processed but none added to allStocks array');
              console.error('âŒ This suggests stocks are being fetched but not added to allStocks');
            }
            addError('No stocks loaded', 'Check your API key and curated stocks list');
            setStocks([]);
          }

          console.log('âœ… COMPLETE! Loading will be set to false in finally block');

        } catch (err) {
          console.error('âŒ Error:', err);
          addError('Failed to fetch stocks', err.message);

          // Even on error, try to display whatever stocks we collected
          if (allStocksCollected && allStocksCollected.length > 0) {
            const seenSymbols = new Set();
            const uniqueStocks = allStocksCollected.filter(stock => {
              const symbol = (stock.symbol || '').toUpperCase().trim();
              if (!symbol || seenSymbols.has(symbol)) return false;
              seenSymbols.add(symbol);
              return true;
            });
            if (uniqueStocks.length > 0) {
              uniqueStocks.sort((a, b) => (b.marketCap || 0) - (a.marketCap || 0));
              setStocks(uniqueStocks);
              console.log('âœ… Displayed', uniqueStocks.length, 'stocks despite error');
            }
          } else {
            setStocks([]);
          }
        } finally {
          window.isFetchingStocks = false;
          clearTimeout(globalTimeout);
          if (progressCheckInterval) clearInterval(progressCheckInterval);

          // Force loader off and progress to 100%
          setLoading(false);
          setLoadingProgress({ current: uniqueCuratedStocks.length, total: uniqueCuratedStocks.length });

          // Final Sync: If the UI is empty but we have stocks collected, display them now
          setStocks(currentStocks => {
            if (currentStocks.length === 0 && allStocks.length > 0) {
              const seen = new Set();
              const unique = allStocks.filter(s => {
                const sym = (s.symbol || '').toUpperCase();
                if (!sym || seen.has(sym)) return false;
                seen.add(sym);
                return true;
              });
              unique.sort((a, b) => (b.marketCap || 0) - (a.marketCap || 0));
              return unique;
            }
            return currentStocks;
          });

          console.log('ğŸ”„ Loading complete - stocks should be visible');
        }
      };

      const manualRefresh = () => {
        console.log('ğŸ”„ Manual refresh triggered');
        fetchStocks();
      };

      // Helper function for incremental loading logs
      const addLog = (message, type = 'info') => {
        console.log(`[${type.toUpperCase()}] ${message}`);
      };

      // Incremental Loading Screener Function
      const fetchScreenerResults = async () => {
        setIsIncrementalLoading(true);
        setLoading(true);
        setShowStuckWarning(false);
        setErrors([]);

        const startTime = Date.now();
        const allSymbols = DEMO_STOCKS.map(stock => stock.symbol).slice(0, 300);
        const batchSize = 3;
        const total = allSymbols.length;

        // Reset partial results
        setPartialResults([]);
        setCompletedSymbols(new Set());
        setApiProgress({ current: 0, total });

        addLog(`ğŸ”„ Starting incremental load of ${total} stocks...`, 'info');

        // Process batches with immediate UI updates
        for (let i = 0; i < total; i += batchSize) {
          const batch = allSymbols.slice(i, i + batchSize);
          const batchResults = [];

          // Fetch batch in parallel
          await Promise.all(
            batch.map(async (symbol) => {
              try {
                // Add delay to avoid rate limits
                await new Promise(r => setTimeout(r, Math.random() * 800));

                const data = await fetchSingleStockData(symbol);
                if (data) {
                  const ai = generateAIAnalysis(data);
                  let mlPrediction = { predPct: null, conf: null, trend: null };
                  try {
                    mlPrediction = await computeMLPrediction(symbol);
                  } catch (e) {
                    console.warn(`ML prediction failed for ${symbol}:`, e);
                  }

                  const stockWithAnalysis = {
                    ...data,
                    ...ai,
                    aiScore: ai.aiScore,
                    mlPrediction,
                    index: 'Screener'
                  };

                  batchResults.push(stockWithAnalysis);
                  setCompletedSymbols(prev => new Set(prev).add(symbol));
                }
              } catch (error) {
                console.warn(`âš ï¸ Skipped ${symbol}: ${error.message}`);
              } finally {
                setApiProgress(prev => ({
                  current: Math.min(prev.current + 1, total),
                  total
                }));
              }
            })
          );

          // Immediately update UI with batch results
          if (batchResults.length > 0) {
            setPartialResults(prev => {
              const updated = [...prev];
              batchResults.forEach(newStock => {
                // Replace if exists, otherwise add
                const idx = updated.findIndex(s => s.symbol === newStock.symbol);
                if (idx >= 0) {
                  updated[idx] = newStock;
                } else {
                  updated.push(newStock);
                }
              });
              // Sort by market cap
              updated.sort((a, b) => (b.marketCap || 0) - (a.marketCap || 0));
              return updated;
            });

            // Also update main stocks state for compatibility
            setStocks(prev => {
              const updated = [...prev];
              batchResults.forEach(newStock => {
                const idx = updated.findIndex(s => s.symbol === newStock.symbol);
                if (idx >= 0) {
                  updated[idx] = newStock;
                } else {
                  updated.push(newStock);
                }
              });
              updated.sort((a, b) => (b.marketCap || 0) - (a.marketCap || 0));
              return updated;
            });

            addLog(`âœ… Batch ${Math.ceil(i / batchSize) + 1}: ${batchResults.length} stocks loaded`, 'success');
          }

          // Check for timeout (5 minutes)
          if (Date.now() - startTime > 300000) {
            addLog('â° Loading timeout reached - showing partial results', 'warning');
            setShowStuckWarning(true);
            break;
          }

          // Force a small delay between batches
          if (i + batchSize < total) {
            await new Promise(resolve => setTimeout(resolve, 500));
          }
        }

        // Final cleanup
        setIsIncrementalLoading(false);
        setLoading(false);
        setApiProgress({ current: 0, total: 0 });

        addLog(`âœ… Loading complete: ${partialResults.length} stocks displayed`, 'success');
      };

      // Reset function for user control
      const resetAndLoad = () => {
        setPartialResults([]);
        setCompletedSymbols(new Set());
        fetchScreenerResults();
      };

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // FILTERING & SORTING
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      const filtered = useMemo(() => {
        // DEBUG: Check if stocks array exists and has items
        console.log('ğŸ” FILTERING DEBUG:', {
          stocksCount: stocks.length,
          search: debouncedSearch,
          sector: selectedSector,
          preset: selectedPreset,
          watchlistOnly: showWatchlistOnly,
          sampleStock: stocks[0]
        });
        
        // OPTIMIZATION: Single-pass filter instead of multiple chained filters
        // This is 5-10Ã— faster for large datasets
        
        // Precompute filter conditions
        const searchLower = debouncedSearch ? debouncedSearch.toLowerCase() : null;
        const watchlistSet = showWatchlistOnly && watchlist ? new Set(watchlist.map(w => w?.toUpperCase()).filter(Boolean)) : null;
        const preset = selectedPreset ? PRESET_SCREENS[selectedPreset] : null;
        
        // Precompile filter functions for preset and manual filters
        const presetChecks = [];
        if (preset) {
          Object.entries(preset.filters).forEach(([key, val]) => {
            if (key.endsWith('_min')) {
              const field = key.replace('_min', '');
              presetChecks.push(s => {
                const fieldValue = s[field];
                // FIX: More lenient - treat 0 as valid, only exclude null/undefined
                // Also consider stocks with missing data if being enriched
                if (fieldValue === null || fieldValue === undefined) {
                  return s._needsEnrichment === true; // Allow if enrichment pending
                }
                return fieldValue >= val;
              });
            } else if (key.endsWith('_max')) {
              const field = key.replace('_max', '');
              presetChecks.push(s => {
                const fieldValue = s[field];
                // FIX: More lenient - treat 0 as valid, only exclude null/undefined
                if (fieldValue === null || fieldValue === undefined) {
                  return s._needsEnrichment === true; // Allow if enrichment pending
                }
                return fieldValue <= val;
              });
            }
          });
        }
        
        const manualChecks = [];
        Object.entries(filters).forEach(([key, val]) => {
          if (val === '') return;
          const numVal = parseFloat(val);
          if (isNaN(numVal)) return;

          if (key.endsWith('_min')) {
            const field = key.replace('_min', '');
            manualChecks.push(s => (s[field] || 0) >= numVal);
          } else if (key.endsWith('_max')) {
            const field = key.replace('_max', '');
            manualChecks.push(s => (s[field] || 0) <= numVal);
          }
        });
        
        // Single-pass filter - check ALL conditions at once
        const result = stocks.filter(s => {
          // Watchlist check
          if (watchlistSet && !watchlistSet.has(s.symbol?.toUpperCase())) return false;
          
          // Search check
          if (searchLower && !(
            s.symbol.toLowerCase().includes(searchLower) ||
            (s.companyName || '').toLowerCase().includes(searchLower)
          )) return false;
          
          // Sector check
          if (selectedSector && s.sector !== selectedSector) return false;
          
          // Preset checks
          if (presetChecks.length > 0 && !presetChecks.every(check => check(s))) return false;
          
          // Manual checks
          if (manualChecks.length > 0 && !manualChecks.every(check => check(s))) return false;
          
          return true;
        });

        // Sort in place (faster than creating new array)
        result.sort((a, b) => {
          const aVal = a[sortBy.key] || 0;
          const bVal = b[sortBy.key] || 0;
          return sortBy.dir === 'asc' ? aVal - bVal : bVal - aVal;
        });

        // DEBUG: Log filtering results
        if (stocks.length > 0 && result.length === 0) {
          console.warn('âš ï¸ FILTERING ISSUE: All stocks filtered out!');
          console.log('Total stocks:', stocks.length);
          console.log('Search:', debouncedSearch);
          console.log('Sector:', selectedSector);
          console.log('Preset:', selectedPreset);
          console.log('Preset checks:', presetChecks.length);
          console.log('Sample stock:', stocks[0]);
          console.log('Watchlist only:', showWatchlistOnly);
        }
        
        if (result.length > 0 && result.length < stocks.length) {
          console.log(`âœ… Filtered: ${result.length} of ${stocks.length} stocks match criteria`);
        }
        
        return result;
      }, [stocks, debouncedSearch, selectedSector, selectedPreset, filters, sortBy, showWatchlistOnly, watchlist]);

      const sectorAverages = useMemo(() => {
        const byS = {};
        stocks.forEach(s => {
          if (!s.sector) return;
          if (!byS[s.sector]) byS[s.sector] = { pe: [], roe: [] };
          if (s.pe) byS[s.sector].pe.push(s.pe);
          if (s.roe) byS[s.sector].roe.push(s.roe);
        });
        Object.keys(byS).forEach(sec => {
          byS[sec] = {
            pe: byS[sec].pe.reduce((a, b) => a + b, 0) / (byS[sec].pe.length || 1),
            roe: byS[sec].roe.reduce((a, b) => a + b, 0) / (byS[sec].roe.length || 1),
          };
        });
        return byS;
      }, [stocks]);

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // ACTIONS
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      const toggleWatchlist = (symbol) => {
        setWatchlist(prev => {
          // Validate symbol before adding
          const cleaned = cleanSymbol(symbol);
          const headerWords = new Set(['SYMBOL', 'NAME', 'LAST', 'OPEN', 'HIGH', 'LOW', 'CHG', 'VOL', 'VOLUME', 'TIME', 'DATE', 'CLOSE', 'CHANGE', 'PRICE', 'CHANGE%', 'CHG.', 'VOL.', 'BUY', 'SELL', 'HOLD', 'RSI', 'MACD', 'EPS', 'REVENUE', 'DAILY', 'HOURLY', 'YTD', 'BETA', 'NEUTRAL', 'INC.', 'MONGODB', 'EARNINGS', 'PE', 'MARKET', 'CAP', 'SECTOR', 'INDUSTRY', 'DIVIDEND', 'YIELD', 'IEX']);
          if (!cleaned || cleaned.length === 0 || cleaned.length > 10 || !/^[A-Z]+$/.test(cleaned) || headerWords.has(cleaned)) {
            console.warn(`âš ï¸ Invalid symbol ignored: ${symbol}`);
            return prev;
          }

          // Check if symbol is already in watchlist (case-insensitive comparison)
          const isInWatchlist = prev.some(s => s.toUpperCase() === cleaned.toUpperCase());
          const updated = isInWatchlist
            ? prev.filter(s => s.toUpperCase() !== cleaned.toUpperCase())
            : [...prev, cleaned];

          console.log(`ğŸ“‹ Watchlist ${isInWatchlist ? 'removed' : 'added'}: ${cleaned}. Current watchlist:`, updated);
          localStorage.setItem('watchlist', JSON.stringify(updated));
          return updated;
        });
      };

      const applyPreset = (presetId) => {
        setSelectedPreset(presetId);
        const preset = PRESET_SCREENS[presetId];
        if (preset) {
          setFilters(prev => ({ ...prev, ...preset.filters }));
        }
      };

      const clearFilters = () => {
        setFilters({
          pe_min: '', pe_max: '',
          roe_min: '', roe_max: '',
          marketCap_min: '', marketCap_max: '',
          changePct_min: '', changePct_max: '',
          rsi_min: '', rsi_max: '',
        });
        setSelectedPreset('');
        setSelectedSector('');
      };

      const dismissToast = (id) => {
        setToasts(prev => prev.filter(t => t.id !== id));
      };

      const dismissError = (id) => {
        setErrors(prev => prev.filter(e => e.id !== id));
      };

      const computePortfolioRecs = () => {
        const watchlistedStocks = stocks.filter(s => watchlist && Array.isArray(watchlist) && watchlist.some(w => w && w.toUpperCase() === s.symbol.toUpperCase()));
        if (!watchlistedStocks.length) return [];

        const recs = watchlistedStocks.map(s => ({
          symbol: s.symbol,
          sector: s.sector,
          edgeScore: (s.aiScore || 50) / 100, // Use unified aiScore (0-100)
          riskScore: (s.subscores?.risk || 50) / 100, // Use risk subscore
        }));

        const totalEdge = recs.reduce((sum, r) => sum + r.edgeScore, 0) || 1;
        recs.forEach(r => {
          r.suggestedWeight = (r.edgeScore / totalEdge) * 100;
        });

        return recs.sort((a, b) => b.suggestedWeight - a.suggestedWeight);
      };

      useEffect(() => {
        if (showPortfolio) {
          setPortfolioRecs(computePortfolioRecs());
        }
      }, [showPortfolio]);

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // REAL-TIME DATA CONNECTION MANAGEMENT
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      useEffect(() => {
        // Listen to WebSocket connection status
        const handleConnectionChange = (connected) => {
          console.log(`ğŸ“¡ WebSocket connection status: ${connected ? 'CONNECTED' : 'DISCONNECTED'}`);
          setIsWebSocketConnected(connected);
        };

        realtimeData.onConnectionChange(handleConnectionChange);

        // Attempt WebSocket connection (falls back to smart polling if it fails)
        realtimeData.connect();

        // Set initial connection status
        setIsWebSocketConnected(realtimeData.isConnected);

        // Cleanup on unmount
        return () => {
          console.log('ğŸ§¹ Cleaning up real-time data subscriptions...');
          realtimeData.disconnect();
          smartPoller.stopAll();
        };
      }, []);

      // Subscribe to real-time updates for watchlist stocks
      useEffect(() => {
        if (watchlist.length === 0) return;

        const updateCallbacks = new Map();

        watchlist.forEach(symbol => {
          const callback = (update) => {
            // Update the stock in the stocks array
            setStocks(prevStocks => {
              const index = prevStocks.findIndex(s => s.symbol === symbol);
              if (index !== -1) {
                const updated = [...prevStocks];
                updated[index] = {
                  ...updated[index],
                  price: update.price,
                  change: update.change,
                  changePct: update.changesPercentage || (update.change && update.price ? (update.change / update.price * 100) : 0),
                  volume: update.volume,
                  quoteFetchedAt: update.quoteFetchedAt
                };
                return updated;
              }
              return prevStocks;
            });
          };

          updateCallbacks.set(symbol, callback);

          // Subscribe to WebSocket updates
          if (isWebSocketConnected) {
            realtimeData.subscribe(symbol, callback);
          } else {
            // Fallback to smart polling if WebSocket not available
            smartPoller.startPolling(symbol, callback);
          }
        });

        // Cleanup subscriptions when watchlist changes
        return () => {
          watchlist.forEach(symbol => {
            const callback = updateCallbacks.get(symbol);
            if (callback) {
              realtimeData.unsubscribe(symbol, callback);
              smartPoller.stopPolling(symbol);
            }
          });
        };
      }, [watchlist, isWebSocketConnected]);

      // Subscribe to real-time updates for heatmap symbols
      useEffect(() => {
        if (!stocks || stocks.length === 0) return;
        if (!realtimeData || !smartPoller) return;

        // Get unique symbols from current view
        const symbols = stocks.map(s => s.symbol).slice(0, 50); // Limit to top 50 for performance
        const subscriptions = new Set();

        // Subscribe to each symbol
        symbols.forEach(symbol => {
          if (heatmapSubscriptions.has(symbol)) return;

          const handleUpdate = (update) => {
            setHeatmapData(prev => {
              const index = prev.findIndex(s => s.symbol === update.symbol);
              if (index === -1) return prev;

              const newData = [...prev];
              newData[index] = {
                ...newData[index],
                price: update.price,
                changePct: update.changesPercentage || (update.change && update.price ? (update.change / update.price * 100) : 0),
                volume: update.volume,
                lastUpdate: Date.now()
              };
              return newData;
            });
          };

          // Subscribe based on connection type
          if (realtimeData.isConnected) {
            realtimeData.subscribe(symbol, handleUpdate);
          } else {
            smartPoller.startPolling(symbol, handleUpdate);
          }

          subscriptions.add(symbol);
          setHeatmapSubscriptions(prev => new Set(prev).add(symbol));
        });

        return () => {
          // Cleanup on unmount
          subscriptions.forEach(symbol => {
            if (realtimeData) realtimeData.unsubscribe(symbol, () => { });
            if (smartPoller) smartPoller.stopPolling(symbol);
          });
        };
      }, [stocks, isWebSocketConnected]);

      const exportTableCSV = () => {
        const data = filtered.map(stock => {
          const row = {};
          ALL_COLUMNS.forEach(col => {
            if (visibleColumns.includes(col.key)) {
              row[col.label] = stock[col.key] || 'â€”';
            }
          });
          return row;
        });

        exportToCSV(data, 'stocks.csv');
      };

      const openComparison = (symbols = []) => {
        setComparisonSymbols(symbols);
        setShowComparison(true);
      };

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // RENDER
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      const connectionLabel = isWebSocketConnected ? 'LIVE' : (lastUpdateTime ? 'POLLING' : 'CONNECTING');
      const showOfflineStyle = !isWebSocketConnected && !lastUpdateTime;
      const connectionTitle = isWebSocketConnected
        ? 'Real-time updates via Finnhub WebSocket'
        : (lastUpdateTime ? 'Updates running via smart polling' : 'Initializing data connection...');

      return (
        <>
          {/* Tournament Status Indicator */}
          {tournamentRunning && (
            <div className="tournament-live-indicator">
              <div className="live-dot"></div>
              <span className="text-green-400 text-sm font-semibold">TOURNAMENT RUNNING</span>
              <button
                onClick={() => setShowAITournament(true)}
                className="ml-2 px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-500"
              >
                View
              </button>
            </div>
          )}

          <div className="min-h-screen p-6">
            {/* Error Display */}
            {errors.length > 0 && (
              <div className="mb-6 space-y-2">
                {errors.map(error => (
                  <div key={error.id} className="glass p-4 rounded-xl border border-red-500/20 bg-red-500/10">
                    <div className="flex items-start justify-between">
                      <div className="flex-1">
                        <div className="flex items-center gap-2 text-red-400 font-semibold">
                          <i className="fas fa-exclamation-triangle"></i>
                          <span>{error.message}</span>
                        </div>
                        {error.details && (
                          <div className="text-sm text-slate-300 mt-1">{error.details}</div>
                        )}
                        <div className="text-xs text-slate-500 mt-2">
                          {new Date(error.timestamp).toLocaleTimeString()}
                        </div>
                      </div>
                      <button
                        onClick={() => dismissError(error.id)}
                        className="text-slate-400 hover:text-white ml-4"
                      >
                        âœ•
                      </button>
                    </div>
                  </div>
                ))}
              </div>
            )}

            {/* Live Price Ticker */}
            {watchlist.length > 0 && (
              <LivePriceTicker stocks={stocks} watchlist={watchlist} isConnected={isWebSocketConnected} />
            )}

            {/* Header */}
            <header className="glass rounded-2xl p-6 mb-6 animate-slide-up">
              <div className="flex items-center justify-between mb-3">
                <div>
                  <h1 className="text-3xl font-bold text-white mb-1">
                    RetailEdge Pro <span className="text-xs text-slate-500 font-normal ml-2">v2.0</span>
                  </h1>
                  <p className="text-sm text-slate-400">Portfolio Tracking â€¢ Alerts â€¢ Sector-Aware AI</p>
                </div>
                <div className="flex items-center gap-3">
                  {/* Firebase Auth Button */}
                  {!authLoading && (
                    <div className="flex items-center gap-2">
                      {firebaseUser ? (
                        <>
                          <span className="text-xs text-slate-400">
                            <i className="fas fa-user-circle mr-1"></i>
                            {firebaseUser.email}
                          </span>
                          <button
                            onClick={signOutUser}
                            className="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm flex items-center gap-2 transition"
                            title="Sign out"
                          >
                            <i className="fas fa-sign-out-alt"></i>
                            Sign Out
                          </button>
                        </>
                      ) : (
                        <button
                          onClick={signInWithGoogle}
                          className="px-3 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-sm flex items-center gap-2 transition"
                          title="Sign in with Google to sync across devices"
                        >
                          <i className="fab fa-google"></i>
                          Sign In
                        </button>
                      )}
                    </div>
                  )}
                </div>
              </div>

              {/* Status indicators row */}
              <div className="flex items-center gap-3 flex-wrap mb-4 text-xs">
                {/* Real-Time Connection Status */}
                <div className={`live-indicator ${showOfflineStyle ? 'offline' : ''}`} title={connectionTitle}>
                  <div className="live-dot"></div>
                  <span>{connectionLabel}</span>
                </div>

                {lastUpdateTime && (
                  <>
                    <span className="text-slate-600">â€¢</span>
                    <div className="flex items-center gap-2">
                      <span className="text-slate-500">
                        Updated: {lastUpdateTime.toLocaleTimeString()}
                      </span>
                    </div>
                    {nextUpdateTime && (
                      <>
                        <span className="text-slate-600">â€¢</span>
                        <span className="text-slate-500">
                          Next: {nextUpdateTime.toLocaleTimeString()}
                        </span>
                      </>
                    )}
                    <span className="text-slate-600">â€¢</span>
                    <span className="text-emerald-400" title={`${Cache.stats().count} stocks cached, ${Cache.stats().sizeKB}KB used. ${Cache.isMarketOpen() ? 'Market is OPEN - cache expires faster' : 'Market CLOSED - using 24hr cache'}`}>
                      <i className="fas fa-database mr-1"></i>
                      {Cache.stats().count} cached
                    </span>
                    {Cache.isMarketOpen() && (
                      <>
                        <span className="text-slate-600">â€¢</span>
                        <span className="text-green-400">
                          <i className="fas fa-circle text-xs mr-1 animate-pulse"></i>
                          Market Open
                        </span>
                      </>
                    )}

                    {/* Data Delay Badge */}
                    <span className="text-slate-600">â€¢</span>
                    <DelayBadge />
                  </>
                )}
              </div>

              <div className="flex items-center gap-3 flex-wrap">
                <button
                  onClick={manualRefresh}
                  disabled={loading}
                  className="px-4 py-2 bg-slate-700 hover:bg-slate-600 disabled:bg-slate-800 disabled:cursor-not-allowed text-white rounded-lg font-semibold text-sm flex items-center gap-2 transition"
                  title="Refresh stock data now"
                >
                  {loading ? (
                    <>
                      <i className="fas fa-spinner animate-spin"></i>
                      Refreshing...
                    </>
                  ) : (
                    <>
                      <i className="fas fa-sync-alt"></i>
                      Refresh
                    </>
                  )}
                </button>
                <button
                  onClick={() => {
                    Cache.clear();
                    manualRefresh();
                  }}
                  disabled={loading}
                  className="px-4 py-2 bg-orange-600 hover:bg-orange-500 disabled:bg-orange-800 disabled:cursor-not-allowed text-white rounded-lg font-semibold text-sm flex items-center gap-2 transition"
                  title={`Clear cache (${Cache.stats().count} items, ${Cache.stats().sizeKB}KB)`}
                >
                  <i className="fas fa-trash"></i>
                  Clear Cache
                </button>
                <button
                  onClick={() => setShowWatchlistOnly(prev => !prev)}
                  className={`px-4 py-2 ${showWatchlistOnly ? 'bg-emerald-600 hover:bg-emerald-500' : 'bg-slate-700 hover:bg-slate-600'} text-white rounded-lg font-semibold text-sm flex items-center gap-2 transition`}
                  title="Toggle watchlist-only view"
                >
                  <i className={`fas fa-${showWatchlistOnly ? 'check-circle' : 'star'}`}></i>
                  Watchlist ({watchlist.length})
                </button>
                <button onClick={() => setShowComparison([])} className="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg font-semibold text-sm flex items-center gap-2">
                  <i className="fas fa-balance-scale"></i>
                  Compare
                </button>
                <button onClick={() => setShowHeatmap(true)} className="px-4 py-2 bg-pink-600 hover:bg-pink-500 text-white rounded-lg font-semibold text-sm flex items-center gap-2">
                  <i className="fas fa-th"></i>
                  Heatmap
                </button>
                <button onClick={() => setShowStockManager(true)} className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg font-semibold text-sm flex items-center gap-2">
                  <i className="fas fa-edit"></i>
                  Stocks ({curatedStocks.length})
                </button>
                <button onClick={() => setShowWatchlistImporter(true)} className="px-4 py-2 bg-teal-600 hover:bg-teal-500 text-white rounded-lg font-semibold text-sm flex items-center gap-2" title="Import watchlist from text, CSV, or JSON">
                  <i className="fas fa-file-import"></i>
                  Import
                </button>
                <button onClick={() => setShowAlerts(true)} className="px-4 py-2 bg-yellow-600 hover:bg-yellow-500 text-white rounded-lg font-semibold text-sm flex items-center gap-2">
                  <i className="fas fa-bell"></i>
                  Alerts ({alerts.filter(a => a.active).length})
                </button>
                <button onClick={() => setShowPortfolio(true)} className="px-4 py-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg font-semibold text-sm flex items-center gap-2">
                  <i className="fas fa-chart-line"></i>
                  Portfolio ({window.portfolioManager?.holdings?.length || 0})
                </button>
                <button onClick={() => setShowPortfolioAllocation(true)} className="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-semibold text-sm flex items-center gap-2">
                  <i className="fas fa-chart-pie"></i>
                  Allocation ({watchlist.length})
                </button>
                <button onClick={() => setShowEducation(true)} className="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg font-semibold text-sm flex items-center gap-2">
                  <i className="fas fa-graduation-cap"></i>
                  Learn
                </button>
                <button onClick={() => setShowAITournament(true)} className="px-4 py-2 bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-500 hover:to-orange-500 text-white rounded-lg font-semibold text-sm flex items-center gap-2">
                  <i className="fas fa-trophy"></i>
                  AI Tournament
                </button>
                <button
                  onClick={() => setShowNotifications(true)}
                  className="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold text-sm relative"
                >
                  <i className="fas fa-bell"></i>
                  {notificationCount > 0 && (
                    <span className="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full min-w-[20px] text-center">
                      {notificationCount}
                    </span>
                  )}
                </button>
                <button onClick={() => setShowSettings(true)} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold text-sm">
                  <i className="fas fa-cog"></i>
                </button>
                <button
                  onClick={() => {
                    const shortcuts = window.keyboardShortcuts?.getHelp() || [];
                    const helpText = shortcuts.length > 0
                      ? 'âŒ¨ï¸ KEYBOARD SHORTCUTS:\n\n' + shortcuts.map(s => `${s.key.padEnd(15)} ${s.description}`).join('\n')
                      : 'No shortcuts registered yet';
                    alert(helpText);
                  }}
                  className="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold text-sm flex items-center gap-2"
                  title="Keyboard shortcuts"
                >
                  <i className="fas fa-keyboard"></i>
                </button>
              </div>
            </header>

            {/* ===== MAIN PAGE TABS - NEW ===== */}
            <div className="mb-6">
              <div className="flex items-center gap-2 border-b border-slate-700">
                <button
                  onClick={() => setActiveMainTab('screener')}
                  className={`px-4 py-3 font-semibold transition flex items-center gap-2 ${activeMainTab === 'screener'
                      ? 'text-cyan-400 border-b-2 border-cyan-400'
                      : 'text-slate-400 hover:text-white'
                    }`}
                >
                  <i className="fas fa-chart-line"></i>
                  Stock Screener
                </button>

                <button
                  onClick={() => setActiveMainTab('tournament')}
                  className={`px-4 py-3 font-semibold transition flex items-center gap-2 ${activeMainTab === 'tournament'
                      ? 'text-purple-400 border-b-2 border-purple-400'
                      : 'text-slate-400 hover:text-white'
                    }`}
                >
                  <i className="fas fa-scroll"></i>
                  Tournament Logs
                </button>

                <button
                  onClick={() => setActiveMainTab('portfolio')}
                  className={`px-4 py-3 font-semibold transition flex items-center gap-2 ${activeMainTab === 'portfolio'
                      ? 'text-emerald-400 border-b-2 border-emerald-400'
                      : 'text-slate-400 hover:text-white'
                    }`}
                >
                  <i className="fas fa-briefcase"></i>
                  Portfolio
                </button>
              </div>
            </div>

            {/* ===== TAB CONTENT - CONDITIONAL RENDERING ===== */}

            {/* SCREENER TAB */}
            {activeMainTab === 'screener' && (
              <>
                {/* Controls */}
                <div className="glass rounded-2xl p-6 mb-6 space-y-4 animate-slide-up">
                  {/* Search & Quick Filters */}
                  <div className="flex gap-3">
                    {/* Watchlist View Toggle */}
                    <button
                      onClick={() => setShowWatchlistOnly(!showWatchlistOnly)}
                      className={`px-4 py-2.5 rounded-lg font-semibold text-sm flex items-center gap-2 transition ${showWatchlistOnly
                          ? 'bg-gradient-to-r from-yellow-600 to-orange-600 text-white'
                          : 'bg-slate-700 hover:bg-slate-600 text-white'
                        }`}
                      title={showWatchlistOnly ? `Showing ${watchlist.length} watchlist stocks` : 'Show watchlist only'}
                    >
                      <i className="fas fa-star"></i>
                      {showWatchlistOnly ? `Watchlist (${watchlist.length})` : 'All Stocks'}
                    </button>

                    <div className="flex-1 relative">
                      <input
                        type="text"
                        id="stock-search"
                        name="stock-search"
                        value={search}
                        onChange={(e) => setSearch(e.target.value)}
                        onKeyDown={async (e) => {
                          if (e.key === 'Enter' && search.trim()) {
                            e.preventDefault();
                            let symbol = search.trim().toUpperCase();

                            // Common company name to ticker mappings
                            const nameToTicker = {
                              'NVIDIA': 'NVDA', 'APPLE': 'AAPL', 'MICROSOFT': 'MSFT',
                              'AMAZON': 'AMZN', 'GOOGLE': 'GOOGL', 'TESLA': 'TSLA',
                              'META': 'META', 'FACEBOOK': 'META', 'NETFLIX': 'NFLX',
                              'GAMESTOP': 'GME', 'COINBASE': 'COIN', 'PALANTIR': 'PLTR',
                              'WALMART': 'WMT', 'DISNEY': 'DIS', 'MCDONALDS': 'MCD',
                              'STARBUCKS': 'SBUX', 'INTEL': 'INTC', 'AMD': 'AMD',
                              'BOEING': 'BA', 'FORD': 'F', 'GM': 'GM', 'GENERAL MOTORS': 'GM'
                            };

                            // Convert company name to ticker if found
                            if (nameToTicker[symbol]) {
                              symbol = nameToTicker[symbol];
                              console.log(`ğŸ“ Converted "${search.trim()}" to ${symbol}`);
                            }

                            // Check if stock already exists
                            const exists = stocks.find(s => s.symbol === symbol);
                            if (exists) {
                              console.log('âœ… Stock already loaded:', symbol);
                              setSearch('');
                              return;
                            }

                            try {
                              console.log('ğŸ” Fetching comprehensive data for:', symbol);

                              const stockData = await fetchSingleStockData(symbol);
                              const ai = generateAIAnalysis(stockData);
                              let mlPrediction = { predPct: null, conf: null, trend: null };
                              try {
                                mlPrediction = await computeMLPrediction(symbol);
                              } catch (e) {
                                console.warn(`ML prediction failed for ${symbol}:`, e);
                              }
                              // Create fresh analysis object to avoid reference sharing
                              const finalStock = {
                                ...stockData,
                                ...ai,
                                aiScore: ai.aiScore,
                                mlPrediction,
                                // Deep copy AI analysis
                                subscores: ai.subscores ? { ...ai.subscores } : null,
                                topDrivers: ai.topDrivers ? {
                                  positive: [...(ai.topDrivers.positive || [])],
                                  negative: [...(ai.topDrivers.negative || [])]
                                } : null,
                                bullFactors: [...(ai.bullFactors || [])],
                                bearFactors: [...(ai.bearFactors || [])],
                                // Deep copy stockData arrays
                                latestNews: stockData.latestNews ? [...stockData.latestNews] : [],
                                peers: stockData.peers ? [...stockData.peers] : [],
                                earningsHistory: stockData.earningsHistory ? [...stockData.earningsHistory] : [],
                                analystGradeHistory: stockData.analystGradeHistory ? [...stockData.analystGradeHistory] : [],
                              };

                              // Remove duplicates when adding stock
                              setStocks(prev => {
                                const symbolUpper = symbol.toUpperCase().trim();
                                // Check if stock already exists
                                const exists = prev.some(s => (s.symbol || '').toUpperCase().trim() === symbolUpper);
                                if (exists) {
                                  console.log(`âš ï¸ Stock ${symbol} already exists, replacing...`);
                                  // Replace existing stock with new data
                                  return prev.map(s =>
                                    (s.symbol || '').toUpperCase().trim() === symbolUpper ? finalStock : s
                                  );
                                }
                                return [finalStock, ...prev];
                              });
                              setSearch('');

                              // Auto-add to curated list (remove duplicates)
                              if (!curatedStocks.includes(symbol)) {
                                const updated = [...new Set([...curatedStocks, symbol])]; // Remove duplicates
                                setCuratedStocks(updated);
                                debouncedLocalStorage.setItem('curatedStocks', JSON.stringify(updated), 500);
                                console.log('ğŸ’¾ Added to curated list:', symbol);
                              }

                              console.log('âœ… Added:', symbol, '-', finalStock.companyName);

                            } catch (err) {
                              console.error('Search error:', err);
                              addError(`Failed to fetch ${symbol}`, err.message || 'Stock not found.');
                            }
                          }
                        }}
                        placeholder="Type ticker or company name & press Enter (e.g., NVDA or Nvidia)..."
                        className="w-full px-4 py-2.5 bg-slate-800/50 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:border-cyan-500"
                      />
                      <div className="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-slate-500 pointer-events-none">
                        â†µ Enter
                      </div>
                    </div>

                    <select value={selectedSector} onChange={(e) => setSelectedSector(e.target.value)} className="px-4 py-2.5 bg-slate-800/50 border border-slate-700 rounded-lg text-white focus:outline-none focus:border-cyan-500">
                      <option value="">All Sectors</option>
                      {SECTORS.map(s => <option key={s} value={s}>{s}</option>)}
                    </select>

                    <button onClick={clearFilters} className="px-4 py-2.5 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold text-sm">Clear</button>
                  </div>

                  {/* Presets */}
                  <div className="grid grid-cols-5 gap-3">
                    {Object.entries(PRESET_SCREENS).map(([key, preset]) => (
                      <div key={key} onClick={() => applyPreset(key)} className={`preset-card ${selectedPreset === key ? 'active' : ''}`}>
                        <div className="font-semibold text-white text-sm">{preset.name}</div>
                        <div className="text-xs text-slate-400 mt-1">Click to apply</div>
                      </div>
                    ))}
                  </div>

                  {/* Manual Filters */}
                  <details className="text-sm">
                    <summary className="cursor-pointer text-slate-400 hover:text-white">Advanced Filters</summary>
                    <div className="grid grid-cols-4 gap-4 mt-3">
                      {[
                        { label: 'P/E', min: 'pe_min', max: 'pe_max' },
                        { label: 'ROE %', min: 'roe_min', max: 'roe_max' },
                        { label: 'Market Cap', min: 'marketCap_min', max: 'marketCap_max' },
                        { label: 'Change %', min: 'changePct_min', max: 'changePct_max' },
                        { label: 'RSI', min: 'rsi_min', max: 'rsi_max' },
                      ].map(f => (
                        <div key={f.label}>
                          <label className="text-xs text-slate-500 mb-1 block">{f.label}</label>
                          <div className="flex gap-2">
                            <input type="number" id={`filter-min-${f.key}`} name={`filter-min-${f.key}`} value={filters[f.min]} onChange={(e) => setFilters(prev => ({ ...prev, [f.min]: e.target.value }))} placeholder="Min" className="w-1/2 px-2 py-1.5 bg-slate-800/50 border border-slate-700 rounded text-white text-xs focus:outline-none focus:border-cyan-500" />
                            <input type="number" id={`filter-max-${f.key}`} name={`filter-max-${f.key}`} value={filters[f.max]} onChange={(e) => setFilters(prev => ({ ...prev, [f.max]: e.target.value }))} placeholder="Max" className="w-1/2 px-2 py-1.5 bg-slate-800/50 border border-slate-700 rounded text-white text-xs focus:outline-none focus:border-cyan-500" />
                          </div>
                        </div>
                      ))}
                    </div>
                  </details>
                </div>

                {/* Thematic Portfolios Section - REMOVED */}

                {/* Sector Heatmap (Collapsible) */}
                {showHeatmap && (
                  <div className="glass rounded-2xl p-6 mb-6 animate-slide-up">
                    <div className="flex items-center justify-between mb-4">
                      <h3 className="text-lg font-bold text-white flex items-center gap-2">
                        <i className="fas fa-th text-pink-400"></i>
                        Sector Rotation Heatmap
                      </h3>
                      <button onClick={() => setShowHeatmap(false)} className="text-slate-400 hover:text-white">
                        <i className="fas fa-times"></i>
                      </button>
                    </div>

                    {(() => {
                      // Use filtered stocks (respects watchlist filter)
                      const displayStocks = filtered || stocks;

                      if (!displayStocks || displayStocks.length === 0) {
                        return (
                          <div className="text-center py-8">
                            <i className="fas fa-exclamation-circle text-4xl text-slate-500 mb-3"></i>
                            <p className="text-slate-400">No stock data available for heatmap</p>
                            <p className="text-slate-500 text-sm mt-2">Try refreshing the data or adjusting filters</p>
                          </div>
                        );
                      }

                      // Group stocks by sector
                      const sectorGroups = {};
                      displayStocks.forEach(stock => {
                        const sector = stock.sector || 'Unknown';
                        if (!sectorGroups[sector]) sectorGroups[sector] = [];
                        sectorGroups[sector].push(stock);
                      });

                      // Calculate sector performance
                      const sectorPerf = Object.entries(sectorGroups).map(([sector, items]) => {
                        const avgChange = items.reduce((sum, s) => sum + parseFloat(s.changePct || 0), 0) / items.length;
                        return { sector, items, avgChange };
                      }).sort((a, b) => b.avgChange - a.avgChange);

                      return (
                        <div className="space-y-4">
                          <div className="text-center mb-4">
                            <p className="text-slate-400 text-sm">
                              Showing {displayStocks.length} stocks across {sectorPerf.length} sectors
                            </p>
                          </div>
                          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                            {sectorPerf.map(({ sector, items, avgChange }) => (
                              <div key={sector} className="bg-slate-800/50 rounded-xl p-3 border border-slate-700/50">
                                <div className="flex justify-between items-center mb-2 pb-2 border-b border-slate-700/30">
                                  <span className="font-bold text-slate-200 text-sm truncate" title={sector}>{sector}</span>
                                  <span className={`text-xs font-bold px-2 py-0.5 rounded ${avgChange >= 0 ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}`}>
                                    {avgChange > 0 ? '+' : ''}{avgChange.toFixed(2)}%
                                  </span>
                                </div>
                                <div className="grid grid-cols-3 gap-1">
                                  {items.sort((a, b) => Math.abs(parseFloat(b.changePct || 0)) - Math.abs(parseFloat(a.changePct || 0))).slice(0, 9).map(stock => {
                                    const pct = parseFloat(stock.changePct || 0);
                                    return (
                                      <div
                                        key={stock.symbol}
                                        onClick={() => {
                                          setSelectedStock(stock);
                                          setShowHeatmap(false);
                                        }}
                                        className={`aspect-square rounded flex flex-col items-center justify-center cursor-pointer hover:opacity-80 hover:scale-105 transition-all p-1 ${pct >= 3 ? 'bg-green-500' :
                                            pct >= 1 ? 'bg-green-600/80' :
                                              pct >= 0 ? 'bg-green-800/60' :
                                                pct >= -1 ? 'bg-red-800/60' :
                                                  pct >= -3 ? 'bg-red-600/80' :
                                                    'bg-red-500'
                                          }`}
                                        title={`${stock.symbol}: ${pct.toFixed(2)}%`}
                                      >
                                        <span className="text-[10px] font-bold text-white leading-none">{stock.symbol}</span>
                                        <span className="text-[9px] text-white/90 leading-none mt-0.5">
                                          {Math.abs(pct).toFixed(1)}%
                                        </span>
                                      </div>
                                    );
                                  })}
                                </div>
                                {items.length > 9 && (
                                  <div className="text-[10px] text-slate-500 text-center mt-2">
                                    + {items.length - 9} more
                                  </div>
                                )}
                              </div>
                            ))}
                          </div>
                          <div className="flex justify-center gap-4 text-xs text-slate-400">
                            <div className="flex items-center gap-2">
                              <div className="w-3 h-3 bg-green-500 rounded"></div> &gt; +3%
                            </div>
                            <div className="flex items-center gap-2">
                              <div className="w-3 h-3 bg-green-600/80 rounded"></div> +1% to +3%
                            </div>
                            <div className="flex items-center gap-2">
                              <div className="w-3 h-3 bg-green-800/60 rounded"></div> 0% to +1%
                            </div>
                            <div className="flex items-center gap-2">
                              <div className="w-3 h-3 bg-red-800/60 rounded"></div> -1% to 0%
                            </div>
                            <div className="flex items-center gap-2">
                              <div className="w-3 h-3 bg-red-600/80 rounded"></div> -3% to -1%
                            </div>
                            <div className="flex items-center gap-2">
                              <div className="w-3 h-3 bg-red-500 rounded"></div> &lt; -3%
                            </div>
                          </div>
                        </div>
                      );
                    })()}
                  </div>
                )}

                {/* Results */}
                <main className="animate-slide-up">
                  {loading ? (
                    <div className="glass rounded-xl p-12 text-center">
                      <i className="fas fa-spinner animate-spin text-4xl text-cyan-400 mb-4"></i>
                      <p className="text-lg text-slate-300">Loading stocks...</p>
                      <p className="text-sm text-slate-500 mt-2">
                        {loadingProgress.current > 0
                          ? `Loaded ${loadingProgress.current} of ${loadingProgress.total} stocks`
                          : `Fetching data from ${curatedStocks.length} stocks`}
                      </p>
                      {loadingProgress.total > 0 && (
                        <div className="mt-4 w-full max-w-md mx-auto">
                          <div className="w-full bg-slate-700/50 rounded-full h-2 overflow-hidden">
                            <div
                              className="bg-gradient-to-r from-cyan-500 to-blue-500 h-full transition-all duration-300"
                              style={{ width: `${(loadingProgress.current / loadingProgress.total) * 100}%` }}
                            ></div>
                          </div>
                          <div className="text-xs text-slate-400 mt-2">
                            {Math.round((loadingProgress.current / loadingProgress.total) * 100)}% Complete
                          </div>
                        </div>
                      )}
                    </div>
                  ) : (
                    <>
                      {/* Incremental Loading Progress */}
                      {isIncrementalLoading && (
                        <LoadingProgressBar current={completedSymbols.size} total={apiProgress.total} />
                      )}

                      {/* Incremental Loading Status Banner */}
                      {isIncrementalLoading && partialResults.length > 0 && (
                        <div className="mb-4 p-3 bg-cyan-500/10 border border-cyan-500/20 rounded-lg flex items-center justify-between">
                          <div className="flex items-center gap-3">
                            <i className="fas fa-spinner animate-spin text-cyan-400"></i>
                            <div>
                              <span className="text-cyan-300 font-semibold">
                                Loading stocks: {completedSymbols.size} / {apiProgress.total}
                              </span>
                              <div className="text-xs text-slate-400 mt-1">
                                Showing {partialResults.length} loaded stocks...
                              </div>
                            </div>
                          </div>
                          <button
                            onClick={() => {
                              setIsIncrementalLoading(false);
                              setLoading(false);
                              setApiProgress({ current: 0, total: 0 });
                            }}
                            className="text-xs text-slate-400 hover:text-white"
                          >
                            Stop Loading
                          </button>
                        </div>
                      )}

                      {/* Show partial results during incremental loading */}
                      {partialResults.length > 0 && (
                        <div className="glass-card rounded-2xl overflow-hidden">
                          <table className="w-full stock-table">
                            <thead>
                              <tr className="text-left text-xs text-slate-400 uppercase tracking-wide">
                                <th className="p-3">Symbol</th>
                                <th className="p-3">Price</th>
                                <th className="p-3">Change</th>
                                <th className="p-3">Volume</th>
                                <th className="p-3">P/E</th>
                                <th className="p-3">ROE</th>
                                <th className="p-3">Growth</th>
                              </tr>
                            </thead>
                            <tbody>
                              {partialResults.map(stock => (
                                <tr
                                  key={stock.symbol}
                                  className="table-row border-b border-slate-700/30 hover:bg-slate-700/20"
                                  onClick={() => openStockModal(stock)}
                                >
                                  <td className="p-3 font-bold text-white">{stock.symbol}</td>
                                  <td className="p-3 text-white">${stock.price?.toFixed(2)}</td>
                                  <td className={`p-3 font-semibold ${getSentimentColor(stock.changePct)}`}>
                                    {formatPercent(stock.changePct)}
                                  </td>
                                  <td className="p-3 text-slate-300">{formatNumber(stock.volume)}</td>
                                  <td className="p-3 text-slate-300">{stock.pe?.toFixed(1) || 'â€”'}</td>
                                  <td className="p-3 text-slate-300">{stock.roe?.toFixed(1) || 'â€”'}%</td>
                                  <td className="p-3 text-slate-300">{stock.revenueGrowth?.toFixed(1) || 'â€”'}%</td>
                                </tr>
                              ))}
                            </tbody>
                          </table>
                        </div>
                      )}

                      {/* Empty state with Load Stocks button */}
                      {!isIncrementalLoading && partialResults.length === 0 && !loading && (
                        <div className="text-center py-20">
                          <i className="fas fa-chart-line text-6xl text-slate-700 mb-4"></i>
                          <p className="text-slate-400 text-lg">No stocks loaded yet</p>
                          <button
                            onClick={fetchScreenerResults}
                            className="mt-4 px-6 py-3 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg font-semibold"
                          >
                            Load Stocks
                          </button>
                        </div>
                      )}

                      {/* Debug: Show when stocks loaded but filtered is empty */}
                      {stocks.length > 0 && filtered.length === 0 && !loading && !isIncrementalLoading && (
                        <div className="text-center py-20">
                          <i className="fas fa-filter text-6xl text-yellow-500 mb-4"></i>
                          <p className="text-slate-300 text-lg font-semibold mb-2">No stocks match current filters</p>
                          <p className="text-slate-400 text-sm mb-4">{stocks.length} stocks loaded, but all filtered out</p>
                          <button
                            onClick={() => {
                              setSelectedPreset('');
                              setSelectedSector('');
                              setSearch('');
                              setShowWatchlistOnly(false);
                              setFilters({});
                            }}
                            className="px-6 py-3 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg font-semibold"
                          >
                            Clear All Filters
                          </button>
                        </div>
                      )}
                      
                      {/* Main Results Table */}
                      {filtered.length > 0 && !isIncrementalLoading ? (
                        <>
                          <div className="flex justify-between items-center mb-4">
                            <div className="text-sm text-slate-400">
                              Showing {filtered.length} of {stocks.length} stocks
                              {/* DEBUG INFO */}
                              <span className="ml-2 text-xs text-cyan-400">
                                (Display Limit: {displayLimit || 100})
                              </span>
                            </div>
                            <div className="flex gap-3">
                              <button
                                onClick={() => openComparison(filtered.slice(0, 3).map(s => s.symbol))}
                                className="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg font-semibold text-sm flex items-center gap-2"
                              >
                                <i className="fas fa-balance-scale"></i>
                                Compare Top 3
                              </button>
                              <button
                                onClick={exportTableCSV}
                                className="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold text-sm flex items-center gap-2"
                              >
                                <i className="fas fa-file-export"></i>
                                Export CSV
                              </button>
                            </div>
                          </div>
                          <div className="glass rounded-xl overflow-hidden">
                            <div className="overflow-x-auto">
                              <table className="w-full text-sm">
                                <thead>
                                  <tr className="bg-slate-800/50 text-slate-400">
                                    {ALL_COLUMNS.filter(c => visibleColumns.includes(c.key)).map(col => {
                                      const glossaryEntry = FINANCIAL_GLOSSARY[col.key];
                                      const isWatchlistColumn = col.key === 'watchlist';
                                      return (
                                        <th
                                          key={col.key}
                                          onClick={isWatchlistColumn ? undefined : () => setSortBy({ key: col.key, dir: sortBy.key === col.key && sortBy.dir === 'asc' ? 'desc' : 'asc' })}
                                          className={`text-left p-4 ${isWatchlistColumn ? 'cursor-default' : 'cursor-pointer hover:text-white'} transition relative group`}
                                          title={col.tooltip || (isWatchlistColumn ? 'Click star icon in rows to add/remove from watchlist' : '')}
                                        >
                                          <div className="flex items-center gap-2">
                                            {col.label}
                                            {glossaryEntry && (
                                              <div className="relative inline-block">
                                                <i className="fas fa-info-circle text-xs text-slate-500 group-hover:text-cyan-400 transition"></i>
                                                <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-64 p-3 bg-slate-900 border border-cyan-500/30 rounded-lg shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 pointer-events-none">
                                                  <div
                                                    className="text-xs text-slate-200 leading-relaxed text-left"
                                                    dangerouslySetInnerHTML={{ __html: glossaryEntry }}
                                                  />
                                                  <div className="absolute left-1/2 -translate-x-1/2 top-full w-0 h-0 border-l-8 border-l-transparent border-r-8 border-r-transparent border-t-8 border-t-slate-900"></div>
                                                </div>
                                              </div>
                                            )}
                                            {!isWatchlistColumn && sortBy.key === col.key && <span>{sortBy.dir === 'asc' ? 'â†‘' : 'â†“'}</span>}
                                          </div>
                                        </th>
                                      );
                                    })}
                                  </tr>
                                </thead>
                                <tbody>
                                  {filtered.slice(0, displayLimit || 100).map((stock, idx) => (
                                    <tr 
                                      key={stock.symbol} 
                                      className={`table-row border-t border-slate-700/20 ${stock._isPlaceholder ? 'animate-pulse' : ''}`}
                                      onClick={() => !stock._isPlaceholder && openStockModal(stock)}
                                      ref={el => {
                                        // Viewport loading: load detailed data when row becomes visible
                                        if (el && stock._isPlaceholder && window.ViewportLoader) {
                                          window.ViewportLoader.observe(el, stock.symbol, (symbol) => {
                                            // This stock is now visible - it will be loaded by batch quotes
                                            console.log(`ğŸ‘€ ${symbol} is visible`);
                                          });
                                        }
                                      }}
                                    >
                                      {visibleColumns.includes('watchlist') && (
                                        <td className="p-4" onClick={(e) => e.stopPropagation()}>
                                          <button
                                            onClick={(e) => {
                                              e.stopPropagation();
                                              toggleWatchlist(stock.symbol);
                                            }}
                                            className={`px-3 py-1.5 rounded-lg text-sm font-semibold transition-all transform hover:scale-110 ${watchlist && Array.isArray(watchlist) && watchlist.some(w => w && w.toUpperCase() === stock.symbol.toUpperCase())
                                                ? 'bg-yellow-500/20 text-yellow-400 hover:bg-yellow-500/30 border border-yellow-500/30'
                                                : 'bg-slate-700/50 text-slate-400 hover:bg-slate-600 hover:text-slate-300 border border-slate-600/30'
                                              }`}
                                            title={watchlist && Array.isArray(watchlist) && watchlist.some(w => w && w.toUpperCase() === stock.symbol.toUpperCase()) ? 'Remove from watchlist' : 'Add to watchlist'}
                                          >
                                            <i className={`fas fa-star${watchlist && Array.isArray(watchlist) && watchlist.some(w => w && w.toUpperCase() === stock.symbol.toUpperCase()) ? '' : '-o'}`}></i>
                                          </button>
                                        </td>
                                      )}
                                      {visibleColumns.includes('symbol') && (
                                        <td className="p-4">
                                          <div className="font-semibold text-cyan-300">{stock.symbol}</div>
                                          <div className="text-xs text-slate-500">{stock.companyName}</div>
                                          <div className="mt-1 flex items-center gap-2">
                                            <span
                                              className="text-[11px] text-slate-500"
                                              title={(stock.quoteFetchedAt || stock.fetchedAt) ? `Updated: ${new Date(stock.quoteFetchedAt || stock.fetchedAt).toLocaleString()}` : 'Updated: â€”'}
                                            >
                                              Updated {(stock.quoteFetchedAt || stock.fetchedAt) ? formatTimeAgo(stock.quoteFetchedAt || stock.fetchedAt) : 'â€”'}
                                            </span>
                                            {isStaleTimestamp(stock.quoteFetchedAt || stock.fetchedAt, 'quote') && (
                                              <span className="text-[10px] font-semibold px-2 py-0.5 rounded-full bg-red-500/15 text-red-300 border border-red-500/20">
                                                STALE
                                              </span>
                                            )}
                                          </div>
                                        </td>
                                      )}
                                      {visibleColumns.includes('smartInsight') && (
                                        <td className="p-4">
                                          {(() => {
                                            const insight = getSmartInsight(stock);
                                            return (
                                              <div className="flex items-center gap-2">
                                                <span className="text-lg">{insight.icon}</span>
                                                <span className={`text-xs font-medium ${insight.color} bg-slate-800/50 px-2 py-1 rounded-full border border-slate-700/50`}>
                                                  {insight.text}
                                                </span>
                                              </div>
                                            );
                                          })()}
                                        </td>
                                      )}
                                      {visibleColumns.includes('price') && (
                                        <td className="p-4 font-mono text-white">${stock.price?.toFixed(2) || 'â€”'}</td>
                                      )}
                                      {visibleColumns.includes('changePct') && (
                                        <td className="p-4">
                                          <span className={`font-mono font-semibold ${getSentimentColor(stock.changePct)}`}>
                                            {formatPercent(stock.changePct, 2)}
                                          </span>
                                        </td>
                                      )}
                                      {visibleColumns.includes('sparkline') && (
                                        <td className="p-4">
                                          {stock.sparkline && stock.sparkline.length > 0 ? (
                                            <div className="sparkline">
                                              {stock.sparkline.slice(-10).map((val, i) => {
                                                const max = Math.max(...stock.sparkline.slice(-10));
                                                const min = Math.min(...stock.sparkline.slice(-10));
                                                const range = max - min || 1;
                                                const height = ((val - min) / range) * 28;
                                                const isGreen = i === 0 ? true : val >= stock.sparkline.slice(-10)[i - 1];
                                                return <div key={i} className="sparkline-bar" style={{ height: `${height}px`, background: isGreen ? '#22c55e' : '#ef4444' }}></div>;
                                              })}
                                            </div>
                                          ) : (
                                            <span className="text-slate-500">â€”</span>
                                          )}
                                        </td>
                                      )}
                                      {visibleColumns.includes('pe') && (
                                        <td className="p-4 font-mono text-white">{stock.pe?.toFixed(2) || 'â€”'}</td>
                                      )}
                                      {visibleColumns.includes('roe') && (
                                        <td className="p-4 font-mono text-white">{stock.roe?.toFixed(2) || 'â€”'}%</td>
                                      )}
                                      {visibleColumns.includes('roa') && (
                                        <td className="p-4 font-mono text-white">{stock.roa?.toFixed(2) || 'â€”'}%</td>
                                      )}
                                      {visibleColumns.includes('roic') && (
                                        <td className="p-4 font-mono text-white">{stock.roic?.toFixed(2) || 'â€”'}%</td>
                                      )}
                                      {visibleColumns.includes('grossMargin') && (
                                        <td className="p-4 font-mono text-white">{stock.grossMargin?.toFixed(2) || 'â€”'}%</td>
                                      )}
                                      {visibleColumns.includes('operatingMargin') && (
                                        <td className="p-4 font-mono text-white">{stock.operatingMargin?.toFixed(2) || 'â€”'}%</td>
                                      )}
                                      {visibleColumns.includes('netMargin') && (
                                        <td className="p-4 font-mono text-white">{stock.netMargin?.toFixed(2) || 'â€”'}%</td>
                                      )}
                                      {visibleColumns.includes('revenueGrowth') && (
                                        <td className="p-4">
                                          <span className={`font-mono font-semibold ${stock.revenueGrowth > 0 ? 'text-green-400' : 'text-red-400'}`}>
                                            {stock.revenueGrowth > 0 ? '+' : ''}{stock.revenueGrowth?.toFixed(1) || 'â€”'}%
                                          </span>
                                        </td>
                                      )}
                                      {visibleColumns.includes('netIncomeGrowth') && (
                                        <td className="p-4">
                                          <span className={`font-mono font-semibold ${stock.netIncomeGrowth > 0 ? 'text-green-400' : 'text-red-400'}`}>
                                            {stock.netIncomeGrowth > 0 ? '+' : ''}{stock.netIncomeGrowth?.toFixed(1) || 'â€”'}%
                                          </span>
                                        </td>
                                      )}
                                      {visibleColumns.includes('epsGrowth') && (
                                        <td className="p-4">
                                          <span className={`font-mono font-semibold ${stock.epsGrowth > 0 ? 'text-green-400' : 'text-red-400'}`}>
                                            {stock.epsGrowth > 0 ? '+' : ''}{stock.epsGrowth?.toFixed(1) || 'â€”'}%
                                          </span>
                                        </td>
                                      )}
                                      {visibleColumns.includes('priceToBook') && (
                                        <td className="p-4 font-mono text-white">{stock.priceToBook?.toFixed(2) || 'â€”'}</td>
                                      )}
                                      {visibleColumns.includes('priceToSales') && (
                                        <td className="p-4 font-mono text-white">{stock.priceToSales?.toFixed(2) || 'â€”'}</td>
                                      )}
                                      {visibleColumns.includes('evToEbitda') && (
                                        <td className="p-4 font-mono text-white">{stock.evToEbitda?.toFixed(2) || 'â€”'}</td>
                                      )}
                                      {visibleColumns.includes('quickRatio') && (
                                        <td className="p-4 font-mono text-white">{stock.quickRatio?.toFixed(2) || 'â€”'}</td>
                                      )}
                                      {visibleColumns.includes('debtToAssets') && (
                                        <td className="p-4 font-mono text-white">{stock.debtToAssets?.toFixed(2) || 'â€”'}</td>
                                      )}
                                      {visibleColumns.includes('cashRatio') && (
                                        <td className="p-4 font-mono text-white">{stock.cashRatio?.toFixed(2) || 'â€”'}</td>
                                      )}
                                      {visibleColumns.includes('volume') && (
                                        <td className="p-4 font-mono text-slate-300">{formatNumber(stock.volume)}</td>
                                      )}
                                      {visibleColumns.includes('analystCount') && (
                                        <td className="p-4 font-mono text-cyan-300">{stock.analystCount || 'â€”'}</td>
                                      )}
                                      {visibleColumns.includes('rsi') && (
                                        <td className="p-4">
                                          <span className={`font-mono ${stock.rsi < 30 ? 'text-green-400' : stock.rsi > 70 ? 'text-red-400' : 'text-slate-300'}`}>
                                            {stock.rsi?.toFixed(0) || 'â€”'}
                                          </span>
                                        </td>
                                      )}
                                      {visibleColumns.includes('analystRating') && (
                                        <td className="p-4">
                                          <span className={`chip text-xs ${stock.analystRating?.startsWith('A') ? 'bg-green-500/20 text-green-400' :
                                              stock.analystRating?.startsWith('B') ? 'bg-blue-500/20 text-blue-400' :
                                                stock.analystRating?.startsWith('C') ? 'bg-yellow-500/20 text-yellow-400' :
                                                  'bg-red-500/20 text-red-400'
                                            }`}>
                                            {stock.analystRating || 'â€”'}
                                          </span>
                                        </td>
                                      )}
                                      {visibleColumns.includes('priceTargetAvg') && (
                                        <td className="p-4 font-mono text-cyan-300">${stock.priceTargetAvg?.toFixed(2) || 'â€”'}</td>
                                      )}
                                      {visibleColumns.includes('piotroskiScore') && (
                                        <td className="p-4">
                                          <span className={`font-mono font-semibold ${stock.piotroskiScore >= 7 ? 'text-green-400' :
                                              stock.piotroskiScore >= 4 ? 'text-yellow-400' :
                                                'text-red-400'
                                            }`}>
                                            {stock.piotroskiScore || 'â€”'}/9
                                          </span>
                                        </td>
                                      )}
                                      {visibleColumns.includes('altmanZScore') && (
                                        <td className="p-4">
                                          <span className={`font-mono ${stock.altmanZScore > 3 ? 'text-green-400' :
                                              stock.altmanZScore > 1.8 ? 'text-yellow-400' :
                                                'text-red-400'
                                            }`}>
                                            {stock.altmanZScore?.toFixed(1) || 'â€”'}
                                          </span>
                                        </td>
                                      )}
                                      {visibleColumns.includes('debtToEquity') && (
                                        <td className="p-4 font-mono text-white">{stock.debtToEquity?.toFixed(2) || 'â€”'}</td>
                                      )}
                                      {visibleColumns.includes('currentRatio') && (
                                        <td className="p-4 font-mono text-white">{stock.currentRatio?.toFixed(2) || 'â€”'}</td>
                                      )}
                                      {visibleColumns.includes('index') && (
                                        <td className="p-4">
                                          <span className="chip bg-cyan-600/20 text-cyan-400 text-xs">
                                            {stock.index || 'â€”'}
                                          </span>
                                        </td>
                                      )}
                                      {visibleColumns.includes('mlPrediction') && (
                                        <td className="p-4">
                                          {stock.mlPrediction && stock.mlPrediction.predPct != null ? (
                                            <div className="flex flex-col">
                                              <span className={`font-mono font-semibold ${stock.mlPrediction.predPct > 0 ? 'text-green-400' :
                                                  stock.mlPrediction.predPct < 0 ? 'text-red-400' :
                                                    'text-slate-400'
                                                }`}>
                                                {formatMLPrediction(stock.mlPrediction.predPct)}
                                              </span>
                                              <span className="text-xs text-slate-500 mt-0.5">
                                                Conf: {stock.mlPrediction.conf}%
                                              </span>
                                            </div>
                                          ) : (
                                            <span className="text-slate-600 font-mono">â€”</span>
                                          )}
                                        </td>
                                      )}
                                      {visibleColumns.includes('verdict') && (
                                        <td className="p-4">
                                          <span className={`chip ${stock.verdict === 'STRONG BUY' || stock.verdict === 'BUY' ? 'bg-green-500/20 text-green-400' :
                                              stock.verdict === 'SELL' || stock.verdict === 'REDUCE' ? 'bg-red-500/20 text-red-400' :
                                                'bg-yellow-500/20 text-yellow-400'
                                            }`}>
                                            {stock.verdict}
                                          </span>
                                        </td>
                                      )}
                                    </tr>
                                  ))}
                                </tbody>
                              </table>
                            </div>
                          </div>
                        </>
                      ) : !isIncrementalLoading && partialResults.length === 0 && filtered.length === 0 ? (
                        <div className="glass rounded-xl p-12 text-center">
                          <i className="fas fa-search text-4xl mb-4 text-slate-500"></i>
                          <p className="text-lg text-slate-300">No stocks match your criteria</p>
                          <p className="text-sm text-slate-500 mt-2">Try adjusting your filters</p>
                        </div>
                      ) : null}
                    </>
                  )}
                </main>
              </>
            )}

            {/* TOURNAMENT LOGS TAB */}
            {activeMainTab === 'tournament' && (
              <TournamentLogsTab />
            )}

            {/* PORTFOLIO TAB */}
            {activeMainTab === 'portfolio' && (
              <div className="animate-slide-up">
                {showPortfolio ? (
                  <PortfolioModal
                    onClose={() => setShowPortfolio(false)}
                    stocks={stocks}
                  />
                ) : (
                  <div className="glass rounded-xl p-12 text-center">
                    <i className="fas fa-briefcase text-4xl text-emerald-400 mb-4"></i>
                    <h3 className="text-xl font-bold text-white mb-2">Portfolio Management</h3>
                    <p className="text-slate-400 mb-4">Click the Portfolio button in the header to manage your holdings</p>
                    <button
                      onClick={() => setShowPortfolio(true)}
                      className="px-6 py-3 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-semibold flex items-center gap-2 mx-auto"
                    >
                      <i className="fas fa-chart-line"></i>
                      Open Portfolio
                    </button>
                  </div>
                )}
              </div>
            )}

            {/* Toast Stack */}
            <div className="fixed bottom-4 right-4 z-[999] space-y-2">
              {toasts.map(t => (
                <div key={t.id} className="glass-elevated rounded-xl p-4 border border-cyan-500/20 w-[320px]">
                  <div className="flex items-start justify-between gap-3">
                    <div>
                      <div className="text-sm font-semibold text-white">{t.symbol}</div>
                      <div className="text-xs text-slate-300 mt-0.5">{t.message}</div>
                      <div className="text-xs text-slate-500 mt-2">{new Date(t.timestamp).toLocaleTimeString()}</div>
                    </div>
                    <button onClick={() => dismissToast(t.id)} className="text-slate-400 hover:text-white">âœ•</button>
                  </div>
                </div>
              ))}
            </div>

            {/* Portfolio Modal */}
            {showPortfolio && (
              <PortfolioModal
                onClose={() => setShowPortfolio(false)}
                stocks={stocks}
              />
            )}

            {/* Portfolio Allocation Modal */}
            {showPortfolioAllocation && (
              <PortfolioAllocationModal
                onClose={() => setShowPortfolioAllocation(false)}
                stocks={stocks}
                watchlist={watchlist}
              />
            )}

            {/* AI Tournament Modal */}
            {showAITournament && (
              <AITournamentModal
                onClose={() => setShowAITournament(false)}
                watchlist={stocks.map(s => s.symbol).filter(Boolean)}
                stocks={stocks}
              />
            )}


            {/* Alerts Modal */}
            {showAlerts && (
              <AlertsModal
                onClose={() => setShowAlerts(false)}
                alerts={alerts}
                setAlerts={setAlerts}
                stocks={stocks}
              />
            )}

            {/* Comparative Analysis Modal */}
            {showComparison && (
              <ComparativeAnalysisModal
                onClose={() => setShowComparison(false)}
                stocks={stocks}
                selectedSymbols={comparisonSymbols}
              />
            )}

            {/* Stock Manager Modal */}
            {showStockManager && (
              <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50" onClick={() => setShowStockManager(false)}>
                <div className="glass-elevated rounded-2xl p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
                  <h2 className="text-2xl font-bold text-white mb-4">
                    <i className="fas fa-edit mr-2"></i>
                    Manage Your Stock List
                  </h2>

                  {/* Add New Stock */}
                  <div className="mb-6 p-4 bg-slate-800/50 rounded-lg">
                    <h3 className="text-lg font-semibold text-white mb-3">Add New Stock</h3>
                    <div className="flex gap-3">
                      <input
                        type="text"
                        id="new-stock-symbol"
                        name="new-stock-symbol"
                        value={newStockSymbol}
                        onChange={(e) => setNewStockSymbol(e.target.value)}
                        onKeyDown={(e) => e.key === 'Enter' && addToCurated()}
                        placeholder="Enter ticker symbol (e.g., AAPL)"
                        className="flex-1 px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:border-cyan-500"
                      />
                      <button
                        onClick={addToCurated}
                        className="px-6 py-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg font-semibold"
                      >
                        Add
                      </button>
                    </div>
                  </div>

                  {/* Current Stock List */}
                  <div>
                    <h3 className="text-lg font-semibold text-white mb-3">Your Stocks ({curatedStocks.length})</h3>
                    <div className="grid grid-cols-2 gap-2">
                      {curatedStocks.map(symbol => (
                        <div key={symbol} className="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg">
                          <span className="text-cyan-300 font-mono font-semibold">{symbol}</span>
                          <button
                            onClick={() => removeFromCurated(symbol)}
                            className="px-3 py-1 bg-red-600 hover:bg-red-500 text-white rounded text-sm"
                          >
                            Remove
                          </button>
                        </div>
                      ))}
                    </div>
                  </div>

                  {/* Close Button */}
                  <div className="mt-6 flex justify-end">
                    <button
                      onClick={() => setShowStockManager(false)}
                      className="px-6 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold"
                    >
                      Close
                    </button>
                  </div>
                </div>
              </div>
            )}

            {/* Settings Modal */}
            {showSettings && (
              <div className="fixed inset-0 bg-black/90 backdrop-blur-sm z-[998] flex items-center justify-center p-4" onClick={() => setShowSettings(false)}>
                <div className="glass-elevated rounded-2xl p-6 max-w-2xl w-full" onClick={(e) => e.stopPropagation()}>
                  <div className="flex items-center justify-between mb-4">
                    <h3 className="text-lg font-bold text-white">Column Settings</h3>
                    <button onClick={() => setShowSettings(false)} className="text-slate-400 hover:text-white">âœ•</button>
                  </div>
                  <div className="space-y-3">
                    {ALL_COLUMNS.map(col => (
                      <label key={col.key} className={`column-toggle ${visibleColumns.includes(col.key) ? 'active' : ''}`}>
                        <input type="checkbox" id={`column-${col.key}`} name={`column-${col.key}`} checked={visibleColumns.includes(col.key)} onChange={(e) => {
                          setVisibleColumns(prev => e.target.checked ? [...prev, col.key] : prev.filter(k => k !== col.key));
                        }} className="w-4 h-4" />
                        <span className="text-sm text-white">{col.label}</span>
                        <span className="text-xs text-slate-500 ml-auto">{col.category}</span>
                      </label>
                    ))}
                  </div>
                  <div className="flex justify-end mt-4">
                    <button onClick={() => setShowSettings(false)} className="px-4 py-2 bg-slate-800 hover:bg-slate-700 border border-slate-700 text-slate-300 rounded-lg text-sm">Close</button>
                  </div>
                </div>
              </div>
            )}

            {/* Watchlist Importer Modal */}
            {showWatchlistImporter && (
              <WatchlistImporter
                onClose={() => setShowWatchlistImporter(false)}
                onImportSuccess={(result) => {
                  console.log(`Imported ${result.count} symbols to group "${result.group}"`);

                  // Add imported symbols to curatedStocks so they appear on main screen
                  const newSymbols = result.symbols || [];
                  setCuratedStocks(prev => {
                    const updated = [...new Set([...prev, ...newSymbols])]; // Remove duplicates
                    debouncedLocalStorage.setItem('curatedStocks', JSON.stringify(updated), 500);
                    return updated;
                  });

                  // Also add to watchlist for favoriting
                  setWatchlist(prev => {
                    const updated = [...new Set([...prev, ...newSymbols])]; // Remove duplicates
                    localStorage.setItem('watchlist', JSON.stringify(updated));
                    return updated;
                  });

                  setShowWatchlistImporter(false);

                  // Show success message
                  alert(`âœ… Successfully imported ${result.count} symbols!\n\nSymbols added to:\nâ€¢ Main stocks list (will be fetched)\nâ€¢ Watchlist (starred)\n\nRefreshing data...`);

                  // Trigger data refresh
                  setTimeout(() => {
                    manualRefresh();
                  }, 500);
                }}
              />
            )}

            {/* Education Center Modal */}
            {showEducation && (
              <ErrorBoundary>
                <EducationCenterModal onClose={() => setShowEducation(false)} />
              </ErrorBoundary>
            )}

            {/* Goals, Rebalance, Tax, and Advanced Analytics - REMOVED */}

            {/* Thematic Portfolio Detail Modal - REMOVED */}

            {/* Notifications */}
            {showNotifications && (
              <ErrorBoundary>
                <NotificationBell
                  onClose={() => setShowNotifications(false)}
                />
              </ErrorBoundary>
            )}

            {/* Stock Modal */}
            {selectedStock && (
              <ErrorBoundary key={selectedStock.symbol}>
                <StockModal
                  key={selectedStock.symbol}
                  stock={selectedStock}
                  onClose={() => setSelectedStock(null)}
                  watchlist={watchlist}
                  toggleWatchlist={toggleWatchlist}
                  detailedDataLoading={detailedDataLoading}
                  sectorAverages={sectorAverages}
                  portfolio={portfolio}
                  stocks={stocks}
                  setShowWatchlistOnly={setShowWatchlistOnly}
                  openStockModal={openStockModal}
                />
              </ErrorBoundary>
            )}

            {/* Footer */}
            <Footer />
          </div>
        </>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AI COST DASHBOARD - Monitor Tournament AI Spending
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function initializeAICostDashboard() {
      // Create dashboard element
      const dashboard = document.createElement('div');
      dashboard.id = 'ai-cost-dashboard';
      dashboard.style.cssText = `
        position: fixed;
        bottom: 80px;
        right: 20px;
        z-index: 9999;
        background: rgba(15, 23, 42, 0.95);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(34, 211, 238, 0.3);
        border-radius: 12px;
        padding: 16px;
        min-width: 320px;
        max-width: 400px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        font-family: 'Segoe UI', system-ui, sans-serif;
      `;
      
      dashboard.innerHTML = `
        <div style="display: flex; justify-between; align-items: center; margin-bottom: 12px;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <i class="fas fa-brain" style="color: #22d3ee;"></i>
            <span style="font-weight: 600; color: #22d3ee; font-size: 14px;">AI Tournament Costs</span>
          </div>
          <button id="toggle-cost-dashboard" style="background: none; border: none; color: #94a3b8; cursor: pointer; font-size: 12px;">
            <i class="fas fa-chevron-down"></i>
          </button>
        </div>
        
        <div id="cost-dashboard-content">
          <!-- Daily Budget -->
          <div style="margin-bottom: 12px;">
            <div style="display: flex; justify-between; font-size: 11px; margin-bottom: 4px;">
              <span style="color: #94a3b8;">Daily:</span>
              <span id="daily-cost" style="color: #22d3ee; font-weight: 600;">$0.00 / $1.00</span>
            </div>
            <div style="width: 100%; background: rgba(51, 65, 85, 0.5); border-radius: 9999px; height: 6px; overflow: hidden;">
              <div id="daily-progress" style="background: linear-gradient(90deg, #22d3ee, #06b6d4); height: 100%; width: 0%; transition: width 0.5s;"></div>
            </div>
            <div style="font-size: 10px; color: #64748b; margin-top: 4px;">
              <span id="daily-remaining">$1.00</span> remaining today
            </div>
          </div>
          
          <!-- Monthly Budget -->
          <div style="margin-bottom: 12px;">
            <div style="display: flex; justify-between; font-size: 11px; margin-bottom: 4px;">
              <span style="color: #94a3b8;">Monthly:</span>
              <span id="monthly-cost" style="color: #22d3ee; font-weight: 600;">$0.00 / $10</span>
            </div>
            <div style="width: 100%; background: rgba(51, 65, 85, 0.5); border-radius: 9999px; height: 6px; overflow: hidden;">
              <div id="monthly-progress" style="background: linear-gradient(90deg, #22d3ee, #06b6d4); height: 100%; width: 0%; transition: width 0.5s;"></div>
            </div>
            <div style="font-size: 10px; color: #64748b; margin-top: 4px;">
              <span id="monthly-remaining">$10.00</span> remaining this month
            </div>
          </div>
          
          <!-- Team Spending -->
          <div style="background: rgba(30, 41, 59, 0.5); border-radius: 8px; padding: 10px; margin-bottom: 12px;">
            <div style="font-size: 11px; color: #94a3b8; margin-bottom: 8px; font-weight: 600;">Team Spending:</div>
            <div id="team-costs" style="font-size: 10px; color: #e2e8f0; line-height: 1.6;">
              Loading...
            </div>
          </div>
          
          <!-- Stats -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 10px;">
            <div>
              <div style="color: #64748b;">Total Requests:</div>
              <div id="total-requests" style="color: #e2e8f0; font-weight: 600;">0</div>
            </div>
            <div>
              <div style="color: #64748b;">Status:</div>
              <div id="budget-status" style="color: #10b981; font-weight: 600;">âœ“ Active</div>
            </div>
          </div>
        </div>
        
        <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(51, 65, 85, 0.5); font-size: 10px; color: #64748b; display: flex; align-items: center; gap: 4px;">
          <i class="fas fa-info-circle"></i>
          <span>Updates every 30s</span>
        </div>
      `;
      
      document.body.appendChild(dashboard);
      
      // Toggle visibility
      let isExpanded = true;
      const toggleBtn = document.getElementById('toggle-cost-dashboard');
      const content = document.getElementById('cost-dashboard-content');
      
      if (toggleBtn) {
        toggleBtn.addEventListener('click', () => {
          isExpanded = !isExpanded;
          content.style.display = isExpanded ? 'block' : 'none';
          toggleBtn.querySelector('i').className = isExpanded ? 'fas fa-chevron-down' : 'fas fa-chevron-up';
        });
      }
      
      // Update function
      let failedAttempts = 0;
      const MAX_FAILED_ATTEMPTS = 3;
      
      async function updateCostDashboard() {
        try {
          const response = await fetch(`${window.API_BASE_URL}/api/ai/costs`);
          
          // If endpoint doesn't exist or returns HTML, silently fail
          if (!response.ok || !response.headers.get('content-type')?.includes('application/json')) {
            failedAttempts++;
            if (failedAttempts >= MAX_FAILED_ATTEMPTS) {
              // Hide dashboard after multiple failures
              const dashboard = document.getElementById('ai-cost-dashboard');
              if (dashboard) dashboard.style.display = 'none';
              console.log('â„¹ï¸ AI Cost Dashboard hidden (backend endpoint not available)');
            }
            return;
          }
          
          const data = await response.json();
          failedAttempts = 0; // Reset on success
          
          // Daily
          const dailyPercent = Math.min(100, (data.today / data.dailyBudget) * 100);
          document.getElementById('daily-cost').textContent = `$${data.today.toFixed(4)} / $${data.dailyBudget.toFixed(2)}`;
          document.getElementById('daily-progress').style.width = `${dailyPercent}%`;
          document.getElementById('daily-remaining').textContent = `$${data.remainingDaily.toFixed(4)}`;
          
          // Color code based on usage
          const dailyProgressBar = document.getElementById('daily-progress');
          if (dailyPercent > 90) {
            dailyProgressBar.style.background = 'linear-gradient(90deg, #ef4444, #dc2626)';
          } else if (dailyPercent > 70) {
            dailyProgressBar.style.background = 'linear-gradient(90deg, #f59e0b, #d97706)';
          } else {
            dailyProgressBar.style.background = 'linear-gradient(90deg, #22d3ee, #06b6d4)';
          }
          
          // Monthly
          const monthlyPercent = Math.min(100, (data.monthly / data.monthlyBudget) * 100);
          document.getElementById('monthly-cost').textContent = `$${data.monthly.toFixed(2)} / $${data.monthlyBudget}`;
          document.getElementById('monthly-progress').style.width = `${monthlyPercent}%`;
          document.getElementById('monthly-remaining').textContent = `$${data.remainingMonthly.toFixed(2)}`;
          
          // Team costs
          const teamCostsDiv = document.getElementById('team-costs');
          let teamHtml = '';
          Object.entries(data.byTeam || {}).forEach(([team, stats]) => {
            const teamPercent = stats.requests > 0 ? ((stats.cost / data.monthly) * 100).toFixed(0) : 0;
            teamHtml += `
              <div style="display: flex; justify-between; margin-bottom: 4px;">
                <span style="color: #94a3b8;">${team}:</span>
                <span style="color: #e2e8f0; font-weight: 600;">$${stats.cost.toFixed(4)} (${stats.requests})</span>
              </div>
            `;
          });
          teamCostsDiv.innerHTML = teamHtml || '<div style="color: #64748b; text-align: center;">No spending yet</div>';
          
          // Stats
          document.getElementById('total-requests').textContent = data.totalRequests || 0;
          
          // Status
          const statusDiv = document.getElementById('budget-status');
          if (data.budgetExceeded) {
            statusDiv.textContent = 'â›” Budget Exceeded';
            statusDiv.style.color = '#ef4444';
          } else if (dailyPercent > 80) {
            statusDiv.textContent = 'âš ï¸ High Usage';
            statusDiv.style.color = '#f59e0b';
          } else {
            statusDiv.textContent = 'âœ“ Active';
            statusDiv.style.color = '#10b981';
          }
          
        } catch (error) {
          failedAttempts++;
          if (failedAttempts >= MAX_FAILED_ATTEMPTS) {
            const dashboard = document.getElementById('ai-cost-dashboard');
            if (dashboard) dashboard.style.display = 'none';
            console.log('â„¹ï¸ AI Cost Dashboard hidden (backend endpoint not available)');
          }
          // Silently fail - don't spam console
        }
      }
      
      // Initial update
      setTimeout(updateCostDashboard, 2000);
      
      // FIX: Store interval ID and pause when tab hidden
      const intervalId = setInterval(() => {
        // Only update if tab is visible
        if (!document.hidden) {
          updateCostDashboard();
        }
      }, 30000);
      
      // Track interval for cleanup
      if (window.ACTIVE_INTERVALS) {
        window.ACTIVE_INTERVALS.add(intervalId);
      }
      
      // Cleanup on page unload
      window.addEventListener('beforeunload', () => {
        clearInterval(intervalId);
        if (window.ACTIVE_INTERVALS) {
          window.ACTIVE_INTERVALS.delete(intervalId);
        }
      });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // APP RENDER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Wait for DOM to be ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initApp);
    } else {
      initApp();
    }

    function initApp() {
      try {
        const rootElement = document.getElementById('root');
        if (!rootElement) {
          console.error('âŒ Root element not found!');
          return;
        }

        if (!ReactDOM || !ReactDOM.createRoot) {
          console.error('âŒ ReactDOM.createRoot not available. React 18 required.');
          return;
        }

        // âš¡ INSTANT STARTUP: Preload cache to memory BEFORE React renders
        const defaultSymbols = typeof DEMO_STOCKS !== 'undefined'
          ? DEMO_STOCKS.map(s => s.symbol)
          : ['AAPL', 'MSFT', 'GOOGL', 'NVDA', 'AMZN', 'TSLA', 'META', 'JPM', 'V', 'UNH'];
        Cache.preloadToMemory(defaultSymbols);

        ReactDOM.createRoot(rootElement).render(
          <ErrorBoundary>
            <App />
          </ErrorBoundary>
        );

        console.log('âœ… Application initialized successfully');

        // Initialize AI Cost Dashboard
        initializeAICostDashboard();
      } catch (error) {
        console.error('âŒ Failed to initialize application:', error);
        document.getElementById('root').innerHTML = `
          <div style="padding: 20px; color: white; text-align: center;">
            <h2>Application Error</h2>
            <p>${error.message}</p>
            <p>Please check the browser console for details.</p>
          </div>
        `;
      }
    }
  </script>
</body>

</html> 
