<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RetailEdge Pro | AI Stock Screener & Portfolio Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Tier 3 Libraries: ML & PDF Export -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.17.0/dist/tf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="#manifest-placeholder">
  <script type="application/json" id="manifest-placeholder">
  {
    "name": "RetailEdge Pro",
    "short_name": "RetailEdge",
    "start_url": "/",
    "display": "standalone",
    "background_color": "#020617",
    "theme_color": "#06b6d4",
    "icons": [
      { "src": "icon-192.png", "sizes": "192x192", "type": "image/png" },
      { "src": "icon-512.png", "sizes": "512x512", "type": "image/png" }
    ]
  }
  </script>
  
  <style>
    /* Theme Variables */
    :root {
      --bg-main: linear-gradient(135deg, #020617 0%, #0f172a 50%, #020617 100%);
      --bg-solid: #0f172a;
      --card-bg: rgba(30, 41, 59, 0.7);
      --card-border: rgba(100, 116, 139, 0.15);
      --text-main: #e2e8f0;
      --text-secondary: #94a3b8;
      --accent-primary: #06b6d4;
      --accent-secondary: #8b5cf6;
    }
    
    .light-mode {
      --bg-main: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 50%, #f1f5f9 100%);
      --bg-solid: #f8fafc;
      --card-bg: rgba(255, 255, 255, 0.9);
      --card-border: rgba(148, 163, 184, 0.25);
      --text-main: #1e293b;
      --text-secondary: #64748b;
      --accent-primary: #0891b2;
      --accent-secondary: #7c3aed;
    }
    
    /* Skeleton Loading Animation */
    @keyframes shimmer {
      0% { background-position: -1000px 0; }
      100% { background-position: 1000px 0; }
    }
    
    .skeleton {
      background: linear-gradient(90deg, #1e293b 25%, #334155 50%, #1e293b 75%);
      background-size: 1000px 100%;
      animation: shimmer 2s infinite linear;
      border-radius: 8px;
    }
    
    .light-mode .skeleton {
      background: linear-gradient(90deg, #e2e8f0 25%, #cbd5e1 50%, #e2e8f0 75%);
      background-size: 1000px 100%;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { 
      background: var(--bg-main);
      min-height: 100vh; 
      font-family: 'Inter', sans-serif;
      color: #e2e8f0;
    }
    .font-mono { font-family: 'JetBrains Mono', monospace; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #0f172a; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: #64748b; }
    
    /* Glassmorphism */
    .glass { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(16px); border: 1px solid rgba(100, 116, 139, 0.2); }
    .glass-card { background: linear-gradient(135deg, rgba(30, 41, 59, 0.7) 0%, rgba(15, 23, 42, 0.9) 100%); backdrop-filter: blur(12px); border: 1px solid rgba(100, 116, 139, 0.15); transition: all 0.3s ease; }
    .glass-card:hover { border-color: rgba(6, 182, 212, 0.4); transform: translateY(-2px); box-shadow: 0 12px 40px rgba(6, 182, 212, 0.1); }
    .glass-elevated { background: rgba(30, 41, 59, 0.85); backdrop-filter: blur(20px); border: 1px solid rgba(100, 116, 139, 0.25); box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5); }
    
    /* Animations */
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    @keyframes glow { 0%, 100% { box-shadow: 0 0 5px rgba(6,182,212,0.3); } 50% { box-shadow: 0 0 20px rgba(6,182,212,0.6); } }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .animate-slide-up { animation: slideUp 0.4s ease-out; }
    .animate-fade-in { animation: fadeIn 0.3s ease; }
    .animate-pulse { animation: pulse 2s infinite; }
    .animate-glow { animation: glow 2s ease-in-out infinite; }
    .animate-spin { animation: spin 1s linear infinite; }
    
    /* Table */
    .table-row { transition: all 0.15s ease; border-left: 3px solid transparent; }
    .table-row:hover { background: rgba(6, 182, 212, 0.06); cursor: pointer; border-left-color: rgba(6, 182, 212, 0.3); }
    .table-row.selected { background: rgba(6, 182, 212, 0.1); border-left-color: #06b6d4; }
    
    /* Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.9); backdrop-filter: blur(8px); z-index: 1000; overflow-y: auto; }
    
    /* Tabs */
    .tab-btn { padding: 12px 20px; font-size: 13px; font-weight: 600; border-bottom: 2px solid transparent; color: #64748b; transition: all 0.2s; }
    .tab-btn:hover { background: rgba(255,255,255,0.03); color: #94a3b8; }
    .tab-btn.active { border-color: #06b6d4; color: #06b6d4; }
    
    /* Chips & Badges */
    .chip { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; border-radius: 9999px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.025em; }
    .badge { display: inline-flex; align-items: center; gap: 4px; padding: 2px 8px; border-radius: 6px; font-size: 10px; font-weight: 700; }
    
    /* Sparkline */
    .sparkline { display: flex; align-items: flex-end; gap: 1px; height: 28px; }
    .sparkline-bar { width: 3px; border-radius: 1px; transition: height 0.3s; }
    
    /* Health & Progress Bars */
    .health-bar { height: 6px; border-radius: 3px; background: #1e293b; overflow: hidden; }
    .health-fill { height: 100%; border-radius: 3px; transition: width 0.5s ease; }
    
    /* Range Inputs */
    input[type=range] { -webkit-appearance: none; background: transparent; width: 100%; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #06b6d4; cursor: pointer; margin-top: -6px; box-shadow: 0 2px 6px rgba(6,182,212,0.4); }
    input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #334155; border-radius: 2px; }
    
    /* Theme Pills */
    .theme-pill { padding: 8px 16px; border-radius: 24px; font-size: 13px; font-weight: 500; transition: all 0.2s; cursor: pointer; border: 1px solid transparent; }
    .theme-pill:hover { background: rgba(255,255,255,0.05); border-color: rgba(100,116,139,0.3); }
    .theme-pill.active { background: linear-gradient(135deg, rgba(6,182,212,0.2), rgba(139,92,246,0.2)); border-color: rgba(6,182,212,0.4); color: #06b6d4; }
    
    /* Tooltips */
    .tooltip { position: relative; }
    .tooltip-content { position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%) translateY(-8px); background: #1e293b; border: 1px solid #334155; border-radius: 8px; padding: 12px 16px; width: 280px; font-size: 12px; line-height: 1.6; opacity: 0; visibility: hidden; transition: all 0.2s; z-index: 100; box-shadow: 0 10px 30px rgba(0,0,0,0.4); pointer-events: none; }
    .tooltip:hover .tooltip-content { opacity: 1; visibility: visible; }
    
    /* Verdict Styles */
    .verdict-bullish { background: linear-gradient(135deg, rgba(34,197,94,0.1) 0%, rgba(34,197,94,0.02) 100%); border: 1px solid rgba(34,197,94,0.3); }
    .verdict-bearish { background: linear-gradient(135deg, rgba(239,68,68,0.1) 0%, rgba(239,68,68,0.02) 100%); border: 1px solid rgba(239,68,68,0.3); }
    .verdict-neutral { background: linear-gradient(135deg, rgba(234,179,8,0.1) 0%, rgba(234,179,8,0.02) 100%); border: 1px solid rgba(234,179,8,0.3); }
    
    /* Live Indicator */
    .live-dot { width: 8px; height: 8px; background: #22c55e; border-radius: 50%; animation: glow 2s ease-in-out infinite; }
    .live-indicator { 
      display: inline-flex; 
      align-items: center; 
      gap: 4px; 
      padding: 2px 8px; 
      border-radius: 12px; 
      background: rgba(34, 197, 94, 0.1); 
      border: 1px solid rgba(34, 197, 94, 0.3);
      font-size: 10px;
      font-weight: 600;
      color: #22c55e;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .live-indicator.offline { 
      background: rgba(148, 163, 184, 0.1); 
      border-color: rgba(148, 163, 184, 0.3);
      color: #94a3b8;
    }
    .live-indicator.offline .live-dot { 
      background: #94a3b8; 
      animation: none;
    }
    
    /* Preset Screen Cards */
    .preset-card { background: rgba(30,41,59,0.5); border: 1px solid rgba(100,116,139,0.2); border-radius: 10px; padding: 12px; cursor: pointer; transition: all 0.2s; }
    .preset-card:hover { border-color: #06b6d4; background: rgba(6,182,212,0.05); }
    .preset-card.active { border-color: #06b6d4; background: rgba(6,182,212,0.1); }
    
    /* Column Selector */
    .column-toggle { display: flex; align-items: center; gap: 8px; padding: 6px 10px; border-radius: 6px; cursor: pointer; transition: all 0.15s; }
    .column-toggle:hover { background: rgba(255,255,255,0.05); }
    .column-toggle.active { background: rgba(6,182,212,0.15); }
    
    /* P&L Colors */
    .pnl-positive { color: #22c55e; }
    .pnl-negative { color: #ef4444; }
    .pnl-neutral { color: #94a3b8; }
  
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       MOBILE RESPONSIVE STYLES - PHASE 1 ENHANCED
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    @media (max-width: 768px) {
      /* Hide desktop table, show mobile cards */
      .stock-table-container {
        display: none;
      }
      
      .mobile-stock-cards {
        display: block !important;
      }
      
      /* Stock cards for mobile */
      .stock-card {
        background: rgba(30, 41, 59, 0.8);
        border: 1px solid rgba(100, 116, 139, 0.2);
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        cursor: pointer;
        transition: all 0.2s;
      }
      
      .stock-card:hover {
        background: rgba(30, 41, 59, 0.95);
        border-color: rgba(6, 182, 212, 0.5);
        transform: translateY(-2px);
      }
      
      .stock-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        padding-bottom: 12px;
        border-bottom: 1px solid rgba(100, 116, 139, 0.2);
      }
      
      .stock-card-symbol {
        font-size: 20px;
        font-weight: 700;
        color: #06b6d4;
      }
      
      .stock-card-price {
        font-size: 18px;
        font-weight: 700;
        color: #fff;
      }
      
      .stock-card-change {
        font-size: 14px;
        font-weight: 600;
      }
      
      .stock-card-metrics {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin-top: 12px;
      }
      
      .stock-card-metric {
        font-size: 12px;
      }
      
      .stock-card-metric-label {
        color: #94a3b8;
        font-size: 11px;
        margin-bottom: 4px;
      }
      
      .stock-card-metric-value {
        color: #fff;
        font-weight: 600;
        font-size: 14px;
      }
      
      .stock-card-verdict {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid rgba(100, 116, 139, 0.2);
        text-align: center;
      }
      
      /* Larger tap targets */
      button, .tab-btn, a.button {
        min-height: 44px;
        padding: 12px 16px;
        font-size: 14px;
      }
      
      /* Full screen modals on mobile */
      .modal-overlay {
        padding: 0;
      }
      
      .modal-content {
        width: 100vw;
        height: 100vh;
        max-height: 100vh;
        max-width: 100vw;
        border-radius: 0;
        margin: 0;
      }
      
      .modal-header {
        position: sticky;
        top: 0;
        z-index: 10;
        background: rgba(15, 23, 42, 0.98);
        backdrop-filter: blur(20px);
      }
      
      .modal-body {
        padding: 16px;
        padding-bottom: 80px; /* Space for bottom nav */
      }
      
      /* Bottom navigation for mobile */
      .mobile-bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(15, 23, 42, 0.98);
        backdrop-filter: blur(20px);
        border-top: 1px solid rgba(100, 116, 139, 0.2);
        padding: 8px;
        display: flex;
        justify-content: space-around;
        z-index: 1000;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
      }
      
      .mobile-nav-btn {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 11px;
        color: #94a3b8;
        background: transparent;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
      }
      
      .mobile-nav-btn.active {
        background: rgba(6, 182, 212, 0.15);
        color: #06b6d4;
      }
      
      .mobile-nav-icon {
        font-size: 20px;
      }
      
      /* Export buttons stack on mobile */
      .export-buttons {
        flex-direction: column;
        gap: 8px;
      }
      
      .export-buttons button {
        width: 100%;
      }
      
      /* Filters take full width */
      .filters-container {
        flex-direction: column;
      }
      
      .filter-group {
        width: 100%;
      }
    }
    
    /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
       GOAL PLANNER SPECIFIC STYLES
       â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
    
    .glass-goal-card {
      background: linear-gradient(135deg, rgba(30, 41, 59, 0.7) 0%, rgba(15, 23, 42, 0.9) 100%);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(100, 116, 139, 0.15);
      border-radius: 16px;
      transition: all 0.3s ease;
    }

    .glass-goal-card:hover {
      border-color: rgba(6, 182, 212, 0.4);
      transform: translateY(-2px);
      box-shadow: 0 12px 40px rgba(6, 182, 212, 0.1);
    }

    .goal-progress-ring {
      transform: rotate(-90deg);
      transform-origin: 50% 50%;
    }

    .goal-milestone {
      position: relative;
    }

    .goal-milestone::before {
      content: '';
      position: absolute;
      left: 50%;
      top: 100%;
      width: 1px;
      height: 20px;
      background: linear-gradient(to bottom, rgba(6, 182, 212, 0.5), transparent);
    }

    .goal-input-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .goal-results-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
    }

    .goal-action-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    /* Animation for goal completion */
    @keyframes goalComplete {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    .goal-complete-animation {
      animation: goalComplete 0.5s ease-in-out;
    }

    /* Tooltip styles for goal explanations */
    .goal-tooltip {
      position: relative;
      display: inline-block;
      cursor: help;
    }

    .goal-tooltip .tooltip-content {
      visibility: hidden;
      position: absolute;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 8px;
      padding: 12px;
      width: 300px;
      font-size: 12px;
      line-height: 1.5;
      z-index: 100;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }

    .goal-tooltip:hover .tooltip-content {
      visibility: visible;
    }

    /* Print styles for goal PDF export */
    @media print {
      .goal-planner-print {
        background: white !important;
        color: black !important;
      }
      
      .goal-planner-print .glass-card {
        background: #f8fafc !important;
        border: 1px solid #e2e8f0 !important;
        color: #1e293b !important;
      }
      
      .no-print {
        display: none !important;
      }
    }
    
    @media (min-width: 769px) {
      .mobile-stock-cards {
        display: none;
      }
      
      .mobile-bottom-nav {
        display: none;
      }
    }

  </style>
</head>
<body>
  <div id="root"></div>
  
  <!-- Firebase Authentication (Optional) -->
  <script type="module">
    // Firebase config - replace with your own or leave as demo mode
    try {
      const { initializeApp } = await import("https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js");
      const { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js");
      const { getFirestore, doc, setDoc, getDoc } = await import("https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js");

      const firebaseConfig = {
        apiKey: "DEMO_MODE",
        authDomain: "demo.firebaseapp.com",
        projectId: "demo-project"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      const provider = new GoogleAuthProvider();

      window.firebaseUtils = { auth, db, provider, signInWithPopup, onAuthStateChanged, doc, setDoc, getDoc };
      console.log('âœ… Firebase initialized (demo mode)');
    } catch (error) {
      console.log('â„¹ï¸ Firebase not configured - running in guest mode');
      window.firebaseUtils = null;
    }
  </script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Technical Analysis System -->
  <script src="technical-analysis-engine.js"></script>
  <script src="technical-analysis-ui.js"></script>
  <script src="technical-analysis-integration.js"></script>
  
  <script type="text/babel">
    const { useState, useEffect, useMemo, useCallback, useRef } = React;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CLOUD STORE HOOK - Real-time Firebase sync with localStorage fallback
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function useCloudStore(key, defaultValue) {
      const [data, setData] = useState(() => {
        // Try localStorage first
        try {
          const stored = localStorage.getItem(`re_${key}`);
          return stored ? JSON.parse(stored) : defaultValue;
        } catch {
          return defaultValue;
        }
      });

      // Listen to Firebase if authenticated
      useEffect(() => {
        if (!window.firebaseUtils?.db) return;
        
        const { db, doc, onSnapshot } = window.firebaseUtils;
        const user = window.firebaseUtils.auth?.currentUser;
        if (!user) return;

        try {
          const docRef = doc(db, 'users', user.uid, 'app', key);
          const unsubscribe = onSnapshot(docRef, (snapshot) => {
            if (snapshot.exists()) {
              const cloudData = snapshot.data()?.value;
              if (cloudData !== undefined) {
                setData(cloudData);
                localStorage.setItem(`re_${key}`, JSON.stringify(cloudData));
              }
            }
          });
          return unsubscribe;
        } catch (error) {
          console.warn('Cloud sync unavailable:', error);
        }
      }, [key]);

      const save = useCallback(async (value) => {
        setData(value);
        
        // Save to localStorage
        try {
          localStorage.setItem(`re_${key}`, JSON.stringify(value));
        } catch (error) {
          console.warn('Failed to save to localStorage:', error);
        }

        // Save to Firebase if available
        if (window.firebaseUtils?.db) {
          const user = window.firebaseUtils.auth?.currentUser;
          if (user) {
            try {
              const { db, doc, setDoc } = window.firebaseUtils;
              await setDoc(doc(db, 'users', user.uid, 'app', key), { 
                value,
                updatedAt: new Date().toISOString()
              });
              console.log(`â˜ï¸ Synced ${key} to cloud`);
            } catch (error) {
              console.warn('Failed to sync to cloud:', error);
            }
          }
        }
      }, [key]);

      return [data, save];
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PREMIUM TIER HOOK - Check user subscription status
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function usePremium() {
      const [tier, setTier] = useState('free');
      
      useEffect(() => {
        // Check UserManager for subscription tier
        if (typeof UserManager !== 'undefined' && UserManager.getCurrentUser) {
          const user = UserManager.getCurrentUser();
          const subscription = user?.subscription || 'free';
          setTier(subscription);
        }
        
        // Also check SubscriptionManager if available
        if (typeof SubscriptionManager !== 'undefined' && SubscriptionManager.getCurrentTier) {
          const currentTier = SubscriptionManager.getCurrentTier();
          setTier(currentTier);
        }
      }, []);

      return { 
        isPremium: tier === 'premium' || tier === 'pro',
        isPro: tier === 'pro',
        tier 
      };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SKELETON LOADING COMPONENTS (V2.0)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const SkeletonCard = () => (
      <div className="glass-card p-4 rounded-xl animate-pulse">
        <div className="flex items-center justify-between mb-4">
          <div className="skeleton h-6 w-16 rounded"></div>
          <div className="skeleton h-4 w-12 rounded"></div>
        </div>
        <div className="skeleton h-8 w-24 rounded mb-2"></div>
        <div className="skeleton h-4 w-full rounded mb-2"></div>
        <div className="skeleton h-4 w-3/4 rounded"></div>
      </div>
    );
    
    const SkeletonRow = () => (
      <tr className="border-b border-slate-700/30 animate-pulse">
        <td className="p-3"><div className="skeleton h-4 w-16 rounded"></div></td>
        <td className="p-3"><div className="skeleton h-4 w-32 rounded"></div></td>
        <td className="p-3"><div className="skeleton h-6 w-20 rounded"></div></td>
        <td className="p-3"><div className="skeleton h-4 w-24 rounded"></div></td>
        <td className="p-3"><div className="skeleton h-4 w-16 rounded"></div></td>
        <td className="p-3"><div className="skeleton h-4 w-20 rounded"></div></td>
        <td className="p-3"><div className="skeleton h-4 w-24 rounded"></div></td>
        <td className="p-3"><div className="skeleton h-8 w-16 rounded"></div></td>
      </tr>
    );
    

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CONFIGURATION & CONSTANTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // API KEYS - PHASE 1 ENHANCED (Multi-source fallback)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MULTI-API CONFIGURATION WITH SMART FALLBACK
    // 9 APIs = 130,000+ monthly calls = Near-unlimited data access!
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const API_KEYS = {
      FMP: 'h43nCTpMeyiIiNquebaqktc7ChUHMxIz',              // 250/day - Primary
      FINNHUB: 'd4fitqpr01qufc4upqn0d4fitqpr01qufc4upqng',   // 60/min, unlimited - Best backup!
      EOD_HISTORICAL: '691f22aa1a8e90.63897142',            // 100,000/month - Huge limit!
      TWELVE_DATA: '437c3794992642e29385a1ef00c9925f',       // 800/day
      INTRINIO: 'OjBmYmVhY2IyZTA3MTM2OWM4YjcwMWQwYzRlODk2NTBj', // 10,000/month
      TIINGO: '404d2953727ee5736d7b2e0671596633d730a1dc',   // 20,000/month
      ALPHA_VANTAGE: 'KUR4BDPE2H6NJMHO',                     // 25/day - sentiment only
      NEWS_API: '81a0be9978ed47c5a3d154aa0bc2feae',          // 100/day
      MARKETAUX: 'Eo8lyvncd3gFJVlVbTuZpKq2PQA3LeX2F1scj2XA', // 100/day
      DEEPSEEK: 'sk-d9a6e65b55e243389a2a5bdf40840e72',       // AI analysis
      CLAUDE: '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' // Claude AI
    };
    
    // API Base URL - Auto-detect environment
    const API_BASE_URL = (() => {
      // Check if running on localhost
      if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
        return 'http://localhost:3002';
      }
      // Production - use same origin (Render will handle this)
      return window.location.origin;
    })();
    
    console.log('ğŸŒ API Base URL:', API_BASE_URL);
    
    // Track API usage and health
    const API_STATS = {
      FMP: { calls: 0, failures: 0, lastSuccess: null },
      FINNHUB: { calls: 0, failures: 0, lastSuccess: null },
      EOD_HISTORICAL: { calls: 0, failures: 0, lastSuccess: null },
      TWELVE_DATA: { calls: 0, failures: 0, lastSuccess: null },
      INTRINIO: { calls: 0, failures: 0, lastSuccess: null },
      TIINGO: { calls: 0, failures: 0, lastSuccess: null }
    };

    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    function parseRetryAfterMs(headerValue) {
      if (!headerValue) return null;
      const trimmed = String(headerValue).trim();
      if (!trimmed) return null;
      // Retry-After can be seconds or an HTTP date
      const seconds = Number(trimmed);
      if (Number.isFinite(seconds)) return Math.max(0, seconds * 1000);

      const dateMs = Date.parse(trimmed);
      if (!Number.isFinite(dateMs)) return null;
      return Math.max(0, dateMs - Date.now());
    }

    function defaultShouldRetry({ response, error }) {
      if (error) {
        // Network errors, timeouts
        if (error.name === 'TimeoutError') return true;
        if (error.name === 'AbortError') return false;
        return true;
      }

      if (!response) return true;
      if (response.status === 429) return true;
      if (response.status === 408) return true;
      if (response.status >= 500 && response.status <= 599) return true;
      return false;
    }

    async function fetchWithRetry(url, options = {}) {
      const {
        timeoutMs = 12000,
        retries = 2,
        retryDelayMs = 600,
        maxRetryDelayMs = 8000,
        jitterRatio = 0.25,
        shouldRetry = defaultShouldRetry,
        signal: upstreamSignal,
        ...fetchOptions
      } = options;

      const totalAttempts = Math.max(1, Number(retries) + 1);
      let lastError = null;
      let lastResponse = null;

      for (let attempt = 0; attempt < totalAttempts; attempt++) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
          try {
            controller.abort(new DOMException('Request timed out', 'TimeoutError'));
          } catch {
            controller.abort();
          }
        }, timeoutMs);

        let upstreamAbortHandler = null;
        if (upstreamSignal) {
          upstreamAbortHandler = () => {
            try {
              controller.abort(upstreamSignal.reason || new DOMException('Request aborted', 'AbortError'));
            } catch {
              controller.abort();
            }
          };
          if (upstreamSignal.aborted) {
            upstreamAbortHandler();
          } else {
            upstreamSignal.addEventListener('abort', upstreamAbortHandler, { once: true });
          }
        }

        try {
          const response = await fetch(url, { ...fetchOptions, signal: controller.signal });
          lastResponse = response;
          lastError = null;

          const retryAfterMs = response.status === 429
            ? parseRetryAfterMs(response.headers?.get?.('Retry-After'))
            : null;

          const canRetry = attempt < totalAttempts - 1;
          if (canRetry && shouldRetry({ response })) {
            const base = Math.min(maxRetryDelayMs, retryDelayMs * Math.pow(2, attempt));
            const jitter = base * jitterRatio * (Math.random() * 2 - 1);
            const waitMs = Math.max(0, Math.min(maxRetryDelayMs, (retryAfterMs ?? base) + jitter));
            console.warn(`â³ Retry ${attempt + 1}/${totalAttempts - 1} after ${Math.round(waitMs)}ms: ${String(url).slice(0, 120)}`);
            await sleep(waitMs);
            continue;
          }

          return response;
        } catch (error) {
          lastError = error;
          lastResponse = null;

          // If caller explicitly aborted, do not retry
          if (upstreamSignal?.aborted) throw error;

          const canRetry = attempt < totalAttempts - 1;
          if (canRetry && shouldRetry({ error })) {
            const base = Math.min(maxRetryDelayMs, retryDelayMs * Math.pow(2, attempt));
            const jitter = base * jitterRatio * (Math.random() * 2 - 1);
            const waitMs = Math.max(0, Math.min(maxRetryDelayMs, base + jitter));
            console.warn(`â³ Retry ${attempt + 1}/${totalAttempts - 1} after ${Math.round(waitMs)}ms (error: ${error?.name || 'Error'}): ${String(url).slice(0, 120)}`);
            await sleep(waitMs);
            continue;
          }

          throw error;
        } finally {
          clearTimeout(timeoutId);
          if (upstreamSignal && upstreamAbortHandler) {
            upstreamSignal.removeEventListener('abort', upstreamAbortHandler);
          }
        }
      }

      if (lastResponse) return lastResponse;
      throw lastError || new Error('Request failed');
    }

    function formatTimeAgo(timestampMs) {
      if (!timestampMs || !Number.isFinite(timestampMs)) return 'â€”';
      const deltaMs = Date.now() - timestampMs;
      if (deltaMs < 0) return 'just now';
      const seconds = Math.floor(deltaMs / 1000);
      if (seconds < 10) return 'just now';
      if (seconds < 60) return `${seconds}s ago`;
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m ago`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours}h ago`;
      const days = Math.floor(hours / 24);
      return `${days}d ago`;
    }

    function isStaleTimestamp(timestampMs, kind = 'quote') {
      if (!timestampMs || !Number.isFinite(timestampMs)) return false;
      const cacheDuration = (() => {
        try {
          if (Cache?.getCacheDuration) {
            return kind === 'quote' ? Cache.getCacheDuration('QUOTE_DATA') : Cache.getCacheDuration('STOCK_DATA');
          }
        } catch {
          // ignore
        }
        // Fallback behavior if Cache isn't available
        return kind === 'quote' ? (Cache?.isMarketOpen?.() ? (5 * 60 * 1000) : (24 * 60 * 60 * 1000))
          : (Cache?.isMarketOpen?.() ? (60 * 60 * 1000) : (24 * 60 * 60 * 1000));
      })();

      return (Date.now() - timestampMs) > cacheDuration;
    }
    
    // Smart fetch with automatic fallback
    async function smartFetch(endpoint, symbol, options = {}) {
      const strategies = [
        // Strategy 1: FMP PAID (primary - only use this, backup APIs are broken)
        {
          name: 'FMP',
          url: `https://financialmodelingprep.com/stable/${endpoint}?symbol=${symbol}&apikey=${API_KEYS.FMP}`,
          transform: (data) => data
        }
        
        // BACKUP APIS DISABLED - FINNHUB returns 401, EOD has CORS errors
        // Only using paid FMP with proper rate limiting
      ];
      
      // Try each strategy in order
      for (const strategy of strategies) {
        if (!strategy.url) continue; // Skip if URL not supported for this endpoint
        
        try {
          API_STATS[strategy.name].calls++;
          
          console.log(`ğŸ”„ Trying ${strategy.name} for ${endpoint}...`);
          
          const response = await fetchWithRetry(strategy.url, {
            timeoutMs: options.timeoutMs ?? 12000,
            retries: options.retries ?? 2
          });
          
          if (response.status === 429) {
            console.warn(`â³ ${strategy.name} rate limited, trying next...`);
            API_STATS[strategy.name].failures++;
            continue;
          }
          
          if (!response.ok) {
            console.warn(`âŒ ${strategy.name} failed (${response.status}), trying next...`);
            API_STATS[strategy.name].failures++;
            continue;
          }
          
          const data = await response.json();
          const transformed = strategy.transform(data);
          
          API_STATS[strategy.name].lastSuccess = new Date();
          console.log(`âœ… ${strategy.name} succeeded for ${endpoint}!`);
          
          return { data: transformed, source: strategy.name };
          
        } catch (error) {
          console.error(`âŒ ${strategy.name} error:`, error.message);
          API_STATS[strategy.name].failures++;
          continue;
        }
      }
      
      // All strategies failed
      throw new Error(`All API sources failed for ${endpoint}`);
    }
    
    // Legacy support - use FMP as default
    const FMP_API_KEY = API_KEYS.FMP;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DEEPSEEK AI ANALYSIS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function getDeepSeekAnalysis(stock) {
      try {
        // Validate API key
        if (!API_KEYS.DEEPSEEK || API_KEYS.DEEPSEEK === '') {
          throw new Error('DeepSeek API key is missing. Please configure your API key.');
        }
        console.log('DeepSeek API key found:', API_KEYS.DEEPSEEK.substring(0, 10) + '...');
        
        const stockData = {
          symbol: stock.symbol,
          name: stock.name,
          price: stock.price,
          change: stock.change,
          changePct: stock.changePct,
          volume: stock.volume,
          marketCap: stock.marketCap,
          pe: stock.pe,
          eps: stock.eps,
          beta: stock.beta,
          dividend: stock.dividend,
          divYield: stock.divYield,
          fiftyTwoWkHigh: stock.fiftyTwoWkHigh,
          fiftyTwoWkLow: stock.fiftyTwoWkLow,
          avgVolume: stock.avgVolume,
          sector: stock.sector,
          industry: stock.industry,
          roe: stock.roe,
          roa: stock.roa,
          debtToEquity: stock.debtToEquity,
          currentRatio: stock.currentRatio,
          quickRatio: stock.quickRatio,
          revenueGrowth: stock.revenueGrowth,
          earningsGrowth: stock.earningsGrowth,
          priceToBook: stock.priceToBook,
          priceToSales: stock.priceToSales,
          analystRating: stock.analystRating,
          priceTarget: stock.priceTarget
        };

        const prompt = `You are a professional stock analyst. Analyze the following stock data and provide a comprehensive investment analysis including:
1. Overall Assessment (bullish/neutral/bearish)
2. Key Strengths (3-4 points)
3. Key Risks (3-4 points)
4. Valuation Analysis
5. Technical Outlook
6. Investment Recommendation (Buy/Hold/Sell with reasoning)

Stock Data:
${JSON.stringify(stockData, null, 2)}

Please provide a clear, structured analysis in markdown format.`;

        const response = await fetch('https://api.deepseek.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${API_KEYS.DEEPSEEK}`
          },
          body: JSON.stringify({
            model: 'deepseek-chat',
            messages: [
              {
                role: 'system',
                content: 'You are a professional stock market analyst with expertise in fundamental and technical analysis.'
              },
              {
                role: 'user',
                content: prompt
              }
            ],
            temperature: 0.7,
            max_tokens: 2000
          })
        });

        if (!response.ok) {
          const error = await response.text();
          throw new Error(`DeepSeek API error: ${response.status} - ${error}`);
        }

        const data = await response.json();
        return data.choices[0].message.content;
        
      } catch (error) {
        console.error('DeepSeek AI analysis error:', error);
        throw error;
      }
    }

    async function getClaudeAnalysis(stock) {
      try {
        // Validate API key
        if (!API_KEYS.CLAUDE || API_KEYS.CLAUDE === '') {
          throw new Error('Claude API key is missing. Please configure your API key.');
        }
        console.log('Claude API key found:', API_KEYS.CLAUDE.substring(0, 15) + '...');
        
        const stockData = {
          symbol: stock.symbol,
          name: stock.name,
          price: stock.price,
          change: stock.change,
          changePct: stock.changePct,
          volume: stock.volume,
          marketCap: stock.marketCap,
          pe: stock.pe,
          eps: stock.eps,
          beta: stock.beta,
          dividend: stock.dividend,
          divYield: stock.divYield,
          fiftyTwoWkHigh: stock.fiftyTwoWkHigh,
          fiftyTwoWkLow: stock.fiftyTwoWkLow,
          avgVolume: stock.avgVolume,
          sector: stock.sector,
          industry: stock.industry,
          roe: stock.roe,
          roa: stock.roa,
          debtToEquity: stock.debtToEquity,
          currentRatio: stock.currentRatio,
          quickRatio: stock.quickRatio,
          revenueGrowth: stock.revenueGrowth,
          earningsGrowth: stock.earningsGrowth,
          priceToBook: stock.priceToBook,
          priceToSales: stock.priceToSales,
          analystRating: stock.analystRating,
          priceTarget: stock.priceTarget
        };

        const prompt = `You are a professional stock analyst. Analyze the following stock data and provide a comprehensive investment analysis including:
1. Overall Assessment (bullish/neutral/bearish)
2. Key Strengths (3-4 points)
3. Key Risks (3-4 points)
4. Valuation Analysis
5. Technical Outlook
6. Investment Recommendation (Buy/Hold/Sell with reasoning)

Stock Data:
${JSON.stringify(stockData, null, 2)}

Please provide a clear, structured analysis in markdown format.`;

        const response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': API_KEYS.CLAUDE,
            'anthropic-version': '2023-06-01'
          },
          body: JSON.stringify({
            model: 'claude-3-5-sonnet-20241022',
            max_tokens: 2000,
            messages: [
              {
                role: 'user',
                content: prompt
              }
            ]
          })
        });

        if (!response.ok) {
          const error = await response.text();
          throw new Error(`Claude API error: ${response.status} - ${error}`);
        }

        const data = await response.json();
        return data.content[0].text;
        
      } catch (error) {
        console.error('Claude AI analysis error:', error);
        throw error;
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ADVANCED CHARTING UTILITIES (Lightweight Charts)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function parseFmpCandleTime(dateStr) {
      if (dateStr == null) return null;

      // Some endpoints return epoch seconds/ms
      if (typeof dateStr === 'number' && Number.isFinite(dateStr)) {
        const ms = dateStr > 2e12 ? dateStr : (dateStr > 2e10 ? dateStr : dateStr * 1000);
        return Math.floor(ms / 1000);
      }

      const s = String(dateStr).trim();
      if (!s) return null;

      // FMP frequently returns "YYYY-MM-DD HH:mm:ss" (non-ISO).
      // Normalize to ISO for consistent parsing.
      const isoish = s.includes(' ') && !s.includes('T')
        ? s.replace(' ', 'T')
        : s;

      // If there's a time component but no timezone, treat as UTC.
      const needsZ = /T\d{2}:\d{2}/.test(isoish) && !/[zZ]|[+-]\d{2}:?\d{2}$/.test(isoish);
      const candidate = needsZ ? `${isoish}Z` : isoish;

      const ms = Date.parse(candidate);
      if (!Number.isFinite(ms)) return null;
      return Math.floor(ms / 1000);
    }

    function normalizeFmpCandles(raw) {
      if (!Array.isArray(raw)) return [];
      return raw
        .map(c => {
          const time = parseFmpCandleTime(c.date);
          if (!time) return null;
          return {
            time,
            open: Number(c.open),
            high: Number(c.high),
            low: Number(c.low),
            close: Number(c.close),
            volume: Number(c.volume || c.vol || 0)
          };
        })
        .filter(Boolean)
        .sort((a, b) => a.time - b.time);
    }

    function sma(values, period) {
      const out = new Array(values.length).fill(null);
      if (!period || period < 2) return out;
      let sum = 0;
      for (let i = 0; i < values.length; i++) {
        sum += values[i];
        if (i >= period) sum -= values[i - period];
        if (i >= period - 1) out[i] = sum / period;
      }
      return out;
    }

    function ema(values, period) {
      const out = new Array(values.length).fill(null);
      if (!period || period < 2 || values.length === 0) return out;
      const k = 2 / (period + 1);
      let prev = values[0];
      out[0] = prev;
      for (let i = 1; i < values.length; i++) {
        const next = values[i] * k + prev * (1 - k);
        out[i] = next;
        prev = next;
      }
      return out;
    }

    function stddev(values, period, smaArr) {
      const out = new Array(values.length).fill(null);
      if (!period || period < 2) return out;
      for (let i = period - 1; i < values.length; i++) {
        const mean = smaArr[i];
        if (mean == null) continue;
        let variance = 0;
        for (let j = i - period + 1; j <= i; j++) {
          const d = values[j] - mean;
          variance += d * d;
        }
        out[i] = Math.sqrt(variance / period);
      }
      return out;
    }

    function computeBollinger(closes, period = 20, mult = 2) {
      const mid = sma(closes, period);
      const sd = stddev(closes, period, mid);
      const upper = mid.map((m, i) => (m == null || sd[i] == null) ? null : m + mult * sd[i]);
      const lower = mid.map((m, i) => (m == null || sd[i] == null) ? null : m - mult * sd[i]);
      return { mid, upper, lower };
    }

    function computeRSI(closes, period = 14) {
      const out = new Array(closes.length).fill(null);
      if (closes.length < period + 1) return out;
      let gain = 0;
      let loss = 0;
      for (let i = 1; i <= period; i++) {
        const diff = closes[i] - closes[i - 1];
        if (diff >= 0) gain += diff;
        else loss -= diff;
      }
      let avgGain = gain / period;
      let avgLoss = loss / period;
      out[period] = avgLoss === 0 ? 100 : 100 - (100 / (1 + (avgGain / avgLoss)));

      for (let i = period + 1; i < closes.length; i++) {
        const diff = closes[i] - closes[i - 1];
        const g = diff > 0 ? diff : 0;
        const l = diff < 0 ? -diff : 0;
        avgGain = (avgGain * (period - 1) + g) / period;
        avgLoss = (avgLoss * (period - 1) + l) / period;
        out[i] = avgLoss === 0 ? 100 : 100 - (100 / (1 + (avgGain / avgLoss)));
      }
      return out;
    }

    function computeMACD(closes, fast = 12, slow = 26, signal = 9) {
      const fastEma = ema(closes, fast);
      const slowEma = ema(closes, slow);
      const macd = closes.map((_, i) => (fastEma[i] == null || slowEma[i] == null) ? null : (fastEma[i] - slowEma[i]));

      const macdForEma = macd.map(v => v == null ? 0 : v);
      const signalLine = ema(macdForEma, signal).map((v, i) => (i < slow - 1 ? null : v));
      const hist = macd.map((v, i) => (v == null || signalLine[i] == null) ? null : (v - signalLine[i]));
      return { macd, signal: signalLine, hist };
    }

    function computeVolumeProfile(candles, bins = 24) {
      if (!Array.isArray(candles) || candles.length === 0) return [];
      let min = Infinity;
      let max = -Infinity;
      for (const c of candles) {
        min = Math.min(min, c.low);
        max = Math.max(max, c.high);
      }
      if (!Number.isFinite(min) || !Number.isFinite(max) || min === max) return [];

      const binSize = (max - min) / bins;
      const acc = new Array(bins).fill(0);
      for (const c of candles) {
        const tp = (c.high + c.low + c.close) / 3;
        const idx = Math.min(bins - 1, Math.max(0, Math.floor((tp - min) / binSize)));
        acc[idx] += Number(c.volume || 0);
      }

      const maxVol = Math.max(...acc, 1);
      return acc.map((v, i) => {
        const lo = min + i * binSize;
        const hi = lo + binSize;
        return { lo, hi, volume: v, pct: (v / maxVol) * 100 };
      }).reverse();
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SMART CACHING SYSTEM - Speeds up loading by 10x!
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const CACHE_CONFIG = {
      // Cache duration in milliseconds
      STOCK_DATA: 60 * 60 * 1000,      // 1 hour for stock data
      QUOTE_DATA: 5 * 60 * 1000,        // 5 minutes for quotes (prices change frequently)
      MARKET_CLOSED: 24 * 60 * 60 * 1000, // 24 hours when market is closed
      MAX_CACHE_SIZE: 100,               // Maximum number of stocks to cache
      CACHE_VERSION: 'v2'                // Increment to invalidate all caches
    };
    
    const Cache = {
      // Check if market is currently open (9:30 AM - 4:00 PM ET, Mon-Fri)
      isMarketOpen() {
        const now = new Date();
        const et = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
        const day = et.getDay();
        const hour = et.getHours();
        const minute = et.getMinutes();
        
        // Weekend
        if (day === 0 || day === 6) return false;
        
        // Before market open (9:30 AM)
        if (hour < 9 || (hour === 9 && minute < 30)) return false;
        
        // After market close (4:00 PM)
        if (hour >= 16) return false;
        
        return true;
      },
      
      // Get appropriate cache duration based on market status
      getCacheDuration(type = 'STOCK_DATA') {
        if (this.isMarketOpen()) {
          return type === 'QUOTE_DATA' ? CACHE_CONFIG.QUOTE_DATA : CACHE_CONFIG.STOCK_DATA;
        }
        return CACHE_CONFIG.MARKET_CLOSED;
      },
      
      // Generate cache key
      key(symbol, type = 'stock') {
        return `${CACHE_CONFIG.CACHE_VERSION}_${type}_${symbol.toUpperCase()}`;
      },
      
      // Get cached data
      get(symbol, type = 'stock') {
        try {
          const key = this.key(symbol, type);
          const cached = localStorage.getItem(key);
          
          if (!cached) return null;
          
          const { data, timestamp } = JSON.parse(cached);
          const age = Date.now() - timestamp;
          const maxAge = this.getCacheDuration(type === 'quote' ? 'QUOTE_DATA' : 'STOCK_DATA');
          
          // Check if cache is still valid
          if (age < maxAge) {
            console.log(`âœ… Cache HIT for ${symbol} (${Math.round(age / 1000 / 60)}min old)`);
            return data;
          }
          
          // Cache expired
          console.log(`â° Cache EXPIRED for ${symbol} (${Math.round(age / 1000 / 60)}min old)`);
          localStorage.removeItem(key);
          return null;
        } catch (error) {
          console.warn(`Cache read error for ${symbol}:`, error);
          return null;
        }
      },
      
      // Set cached data
      set(symbol, data, type = 'stock') {
        try {
          const key = this.key(symbol, type);
          const cacheData = {
            data,
            timestamp: Date.now()
          };
          
          localStorage.setItem(key, JSON.stringify(cacheData));
          console.log(`ğŸ’¾ Cached ${symbol} (${type})`);
          
          // Clean up old caches if storage is getting full
          this.cleanup();
        } catch (error) {
          if (error.name === 'QuotaExceededError') {
            console.warn('Cache storage full, cleaning up...');
            this.clearOldest();
          } else {
            console.warn(`Cache write error for ${symbol}:`, error);
          }
        }
      },
      
      // Remove specific cache
      remove(symbol, type = 'stock') {
        try {
          const key = this.key(symbol, type);
          localStorage.removeItem(key);
        } catch (error) {
          console.warn(`Cache remove error for ${symbol}:`, error);
        }
      },
      
      // Clear all caches
      clear() {
        try {
          const keys = Object.keys(localStorage);
          const cacheKeys = keys.filter(k => k.startsWith(CACHE_CONFIG.CACHE_VERSION));
          cacheKeys.forEach(key => localStorage.removeItem(key));
          console.log(`ğŸ§¹ Cleared ${cacheKeys.length} cached items`);
        } catch (error) {
          console.warn('Cache clear error:', error);
        }
      },
      
      // Remove oldest caches to free up space
      clearOldest() {
        try {
          const keys = Object.keys(localStorage);
          const cacheKeys = keys.filter(k => k.startsWith(CACHE_CONFIG.CACHE_VERSION));
          
          // Get timestamps and sort by age
          const cacheItems = cacheKeys.map(key => {
            try {
              const { timestamp } = JSON.parse(localStorage.getItem(key));
              return { key, timestamp };
            } catch {
              return { key, timestamp: 0 };
            }
          }).sort((a, b) => a.timestamp - b.timestamp);
          
          // Remove oldest 20%
          const toRemove = Math.ceil(cacheItems.length * 0.2);
          cacheItems.slice(0, toRemove).forEach(item => {
            localStorage.removeItem(item.key);
          });
          
          console.log(`ğŸ§¹ Removed ${toRemove} oldest cache items`);
        } catch (error) {
          console.warn('Cache cleanup error:', error);
        }
      },
      
      // Smart cleanup - remove expired items
      cleanup() {
        try {
          const keys = Object.keys(localStorage);
          const cacheKeys = keys.filter(k => k.startsWith(CACHE_CONFIG.CACHE_VERSION));
          
          if (cacheKeys.length <= CACHE_CONFIG.MAX_CACHE_SIZE) return;
          
          let removed = 0;
          cacheKeys.forEach(key => {
            try {
              const { timestamp } = JSON.parse(localStorage.getItem(key));
              const age = Date.now() - timestamp;
              
              // Remove if older than 24 hours
              if (age > 24 * 60 * 60 * 1000) {
                localStorage.removeItem(key);
                removed++;
              }
            } catch {
              localStorage.removeItem(key);
              removed++;
            }
          });
          
          if (removed > 0) {
            console.log(`ğŸ§¹ Cleanup removed ${removed} expired items`);
          }
        } catch (error) {
          console.warn('Cache cleanup error:', error);
        }
      },
      
      // Get cache statistics
      stats() {
        const keys = Object.keys(localStorage);
        const cacheKeys = keys.filter(k => k.startsWith(CACHE_CONFIG.CACHE_VERSION));
        
        let totalSize = 0;
        cacheKeys.forEach(key => {
          totalSize += localStorage.getItem(key).length;
        });
        
        return {
          count: cacheKeys.length,
          sizeKB: Math.round(totalSize / 1024),
          marketOpen: this.isMarketOpen()
        };
      }
    };
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SECTOR-AWARE AI SCORING CONFIGURATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const SECTOR_METRICS = {
      'Technology': {
        pe_base: 28,
        pe_acceptable: 35,
        roe_target: 20,
        roe_excellent: 30,
        growth_target: 15,
        growth_excellent: 25,
        margin_target: 25
      },
      'Financial Services': {
        pe_base: 12,
        pe_acceptable: 15,
        roe_target: 12,
        roe_excellent: 18,
        growth_target: 5,
        growth_excellent: 10,
        margin_target: 30
      },
      'Healthcare': {
        pe_base: 22,
        pe_acceptable: 28,
        roe_target: 15,
        roe_excellent: 25,
        growth_target: 10,
        growth_excellent: 18,
        margin_target: 20
      },
      'Consumer Cyclical': {
        pe_base: 20,
        pe_acceptable: 25,
        roe_target: 15,
        roe_excellent: 22,
        growth_target: 8,
        growth_excellent: 15,
        margin_target: 15
      },
      'Consumer Defensive': {
        pe_base: 18,
        pe_acceptable: 22,
        roe_target: 18,
        roe_excellent: 25,
        growth_target: 5,
        growth_excellent: 10,
        margin_target: 12
      },
      'Energy': {
        pe_base: 15,
        pe_acceptable: 20,
        roe_target: 12,
        roe_excellent: 20,
        growth_target: 5,
        growth_excellent: 12,
        margin_target: 10
      },
      'Industrials': {
        pe_base: 18,
        pe_acceptable: 23,
        roe_target: 14,
        roe_excellent: 20,
        growth_target: 7,
        growth_excellent: 12,
        margin_target: 12
      },
      'Communication Services': {
        pe_base: 25,
        pe_acceptable: 30,
        roe_target: 18,
        roe_excellent: 25,
        growth_target: 12,
        growth_excellent: 20,
        margin_target: 20
      },
      'Default': {
        pe_base: 20,
        pe_acceptable: 25,
        roe_target: 15,
        roe_excellent: 22,
        growth_target: 10,
        growth_excellent: 18,
        margin_target: 15
      }
    };
    
    // Get sector benchmarks with fallback
    function getSectorBenchmarks(sector) {
      return SECTOR_METRICS[sector] || SECTOR_METRICS['Default'];
    }

    

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PHASE 1: COMMERCIAL FEATURES - USER ACCOUNT SYSTEM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const UserManager = {
      isLoggedIn() {
        return localStorage.getItem('re_user_id') !== null;
      },

      getCurrentUser() {
        const userId = localStorage.getItem('re_user_id');
        if (!userId) return null;
        
        try {
          return JSON.parse(localStorage.getItem(`re_user_${userId}`));
        } catch {
          return null;
        }
      },

      register(email, password, name) {
        return new Promise((resolve, reject) => {
          try {
            if (!email || !password || !name) {
              reject('All fields are required');
              return;
            }

            const existingUsers = this.getAllUsers();
            if (existingUsers.find(u => u.email === email)) {
              reject('Email already registered');
              return;
            }

            const userId = 'user_' + Date.now() + Math.random().toString(36).substr(2, 9);
            const user = {
              id: userId,
              email,
              name,
              createdAt: new Date().toISOString(),
              lastLogin: new Date().toISOString(),
              preferences: {
                theme: 'dark',
                defaultView: 'beginner',
                notifications: true,
                riskTolerance: 'moderate'
              },
              investmentProfile: {
                experience: 'beginner',
                goals: [],
                timeHorizon: 'medium'
              },
              subscription: {
                tier: 'free',
                expiresAt: null,
                features: ['basic_screening', 'watchlist', 'portfolio_tracking']
              }
            };

            localStorage.setItem('re_user_id', userId);
            localStorage.setItem(`re_user_${userId}`, JSON.stringify(user));
            this.initializeUserData(userId);

            resolve(user);
          } catch (error) {
            reject('Registration failed');
          }
        });
      },

      login(email, password) {
        return new Promise((resolve, reject) => {
          try {
            const users = this.getAllUsers();
            const user = users.find(u => u.email === email);
            
            if (!user) {
              reject('User not found');
              return;
            }

            if (!password) {
              reject('Password required');
              return;
            }

            user.lastLogin = new Date().toISOString();
            localStorage.setItem(`re_user_${user.id}`, JSON.stringify(user));
            localStorage.setItem('re_user_id', user.id);

            resolve(user);
          } catch (error) {
            reject('Login failed');
          }
        });
      },

      logout() {
        localStorage.removeItem('re_user_id');
      },

      updatePreferences(preferences) {
        const user = this.getCurrentUser();
        if (!user) return null;
        user.preferences = { ...user.preferences, ...preferences };
        localStorage.setItem(`re_user_${user.id}`, JSON.stringify(user));
        return user;
      },

      updateInvestmentProfile(profile) {
        const user = this.getCurrentUser();
        if (!user) return null;
        user.investmentProfile = { ...user.investmentProfile, ...profile };
        localStorage.setItem(`re_user_${user.id}`, JSON.stringify(user));
        return user;
      },

      getAllUsers() {
        const users = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.startsWith('re_user_') && !key.endsWith('_data')) {
            try {
              users.push(JSON.parse(localStorage.getItem(key)));
            } catch {}
          }
        }
        return users;
      },

      initializeUserData(userId) {
        const userData = {
          watchlist: [],
          portfolio: [],
          savedScreens: [],
          alerts: [],
          learningProgress: {
            completedLessons: [],
            currentStreak: 0,
            totalPoints: 0
          }
        };
        localStorage.setItem(`re_user_${userId}_data`, JSON.stringify(userData));
      },

      getUserData() {
        const user = this.getCurrentUser();
        if (!user) return null;

        try {
          const data = localStorage.getItem(`re_user_${user.id}_data`);
          if (!data) {
            this.initializeUserData(user.id);
            return JSON.parse(localStorage.getItem(`re_user_${user.id}_data`));
          }
          return JSON.parse(data);
        } catch {
          this.initializeUserData(user.id);
          return JSON.parse(localStorage.getItem(`re_user_${user.id}_data`));
        }
      },

      updateUserData(data) {
        const user = this.getCurrentUser();
        if (!user) return null;
        const currentData = this.getUserData();
        const newData = { ...currentData, ...data };
        localStorage.setItem(`re_user_${user.id}_data`, JSON.stringify(newData));
        return newData;
      }
    };


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PHASE 1: SUBSCRIPTION SYSTEM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const SubscriptionManager = {
      TIERS: {
        free: {
          name: 'Free',
          price: 0,
          limits: {
            stocksPerScreen: 20,
            watchlistItems: 10,
            portfolioItems: 5,
            alerts: 3,
            apiCallsPerDay: 100
          },
          features: [
            'Basic stock screening',
            'Watchlist (10 stocks)',
            'Portfolio tracking (5 stocks)',
            'Price alerts (3)',
            'Community access'
          ]
        },
        premium: {
          name: 'Premium',
          price: 9.99,
          limits: {
            stocksPerScreen: 100,
            watchlistItems: 50,
            portfolioItems: 25,
            alerts: 25,
            apiCallsPerDay: 1000
          },
          features: [
            'Advanced stock screening',
            'Unlimited watchlist',
            'Portfolio tracking (25 stocks)',
            'Price alerts (25)',
            'Real-time data',
            'Advanced analytics',
            'Priority support'
          ]
        },
        pro: {
          name: 'Pro',
          price: 19.99,
          limits: {
            stocksPerScreen: 500,
            watchlistItems: 200,
            portfolioItems: 100,
            alerts: 100,
            apiCallsPerDay: 10000
          },
          features: [
            'Everything in Premium',
            'API access',
            'Custom screening criteria',
            'Portfolio optimization',
            'Tax loss harvesting',
            'Dedicated support'
          ]
        }
      },

      getCurrentSubscription() {
        const user = UserManager.getCurrentUser();
        if (!user) return this.TIERS.free;
        const tier = user.subscription?.tier || 'free';
        return { ...this.TIERS[tier], tier };
      },

      hasFeature(feature) {
        const subscription = this.getCurrentSubscription();
        return subscription.features.includes(feature);
      },

      checkLimit(limitType, currentCount) {
        const subscription = this.getCurrentSubscription();
        const limit = subscription.limits[limitType];
        return currentCount < limit;
      },

      upgrade(tier) {
        return new Promise((resolve, reject) => {
          const user = UserManager.getCurrentUser();
          if (!user) {
            reject('User not logged in');
            return;
          }

          if (!this.TIERS[tier]) {
            reject('Invalid tier');
            return;
          }

          user.subscription = {
            tier: tier,
            expiresAt: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
            features: this.TIERS[tier].features
          };

          localStorage.setItem(`re_user_${user.id}`, JSON.stringify(user));
          resolve(user.subscription);
        });
      }
    };


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PHASE 1: BEGINNER MODE SYSTEM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const BeginnerMode = {
      SIMPLIFIED_METRICS: [
        { key: 'price', label: 'Price', explanation: 'Current stock price' },
        { key: 'changePct', label: 'Today\'s Change', explanation: 'Price change today' },
        { key: 'pe', label: 'P/E Ratio', explanation: 'Price Ã· Earnings. Lower may be better value' },
        { key: 'roe', label: 'ROE', explanation: 'Return on Equity. Higher is better' },
        { key: 'aiScore', label: 'AI Score', explanation: 'Overall rating from our analysis' }
      ],

      EXPLANATIONS: {
        pe: "Think of P/E like a price tag for earnings. A P/E of 20 means you're paying $20 for each $1 of company earnings.",
        roe: "ROE measures how efficiently a company uses your money. 15%+ is excellent.",
        debtToEquity: "This shows how much debt a company has compared to its value. Lower is safer.",
        rsi: "RSI measures if a stock is overbought (above 70) or oversold (below 30).",
        marketCap: "Market Cap is the total value of all the company's shares. Larger companies are usually more stable.",
        volume: "Volume shows how many shares were traded. Higher volume means more interest in the stock.",
        changePct: "This shows how much the stock price moved today. Green (positive) is up, red (negative) is down."
      },

      shouldShowBeginnerMode() {
        const user = UserManager.getCurrentUser();
        if (!user) return true;
        return user.preferences?.defaultView === 'beginner' || 
               user.investmentProfile?.experience === 'beginner';
      },

      getSimplifiedView(stock) {
        return this.SIMPLIFIED_METRICS.map(metric => ({
          ...metric,
          value: stock[metric.key],
          formattedValue: this.formatValue(stock[metric.key], metric.key)
        }));
      },

      formatValue(value, key) {
        if (value == null || isNaN(value)) return 'â€”';
        
        switch(key) {
          case 'price': return `$${value.toFixed(2)}`;
          case 'changePct': return `${value > 0 ? '+' : ''}${value.toFixed(2)}%`;
          case 'pe': return value.toFixed(1);
          case 'roe': return `${value.toFixed(1)}%`;
          case 'aiScore': return `${Math.round(value)}/100`;
          default: return value.toString();
        }
      },

      getExplanation(key) {
        return this.EXPLANATIONS[key] || 'No explanation available.';
      }
    };


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FINANCIAL GLOSSARY - Tooltips for key metrics
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const FINANCIAL_GLOSSARY = {
      'P/E': '<strong>Price-to-Earnings Ratio</strong><br>Shows how much investors pay for $1 of earnings.<br><em>Lower = potentially better value</em>',
      'ROE': '<strong>Return on Equity</strong><br>Measures how efficiently a company uses shareholder money.<br><em>15%+ is excellent</em>',
      'Market Cap': '<strong>Market Capitalization</strong><br>Total value of all company shares.<br><em>Large cap: $10B+, Mid: $2-10B, Small: <$2B</em>',
      'Revenue Growth': '<strong>Revenue Growth Rate</strong><br>Year-over-year sales increase.<br><em>10%+ is strong growth</em>',
      'Net Margin': '<strong>Net Profit Margin</strong><br>What % of revenue becomes profit.<br><em>20%+ is excellent</em>',
      'Debt/Equity': '<strong>Debt-to-Equity Ratio</strong><br>Company debt vs shareholder equity.<br><em>Lower = less financial risk</em>',
      'RSI': '<strong>Relative Strength Index</strong><br>Momentum indicator (0-100).<br><em>>70 = overbought, <30 = oversold</em>',
      'AI Score': '<strong>AI Composite Score</strong><br>Combines fundamentals, technicals & risk.<br><em>80+ = Strong Buy, 60-80 = Buy, 40-60 = Hold</em>',
      'Confidence': '<strong>AI Confidence Level</strong><br>How certain the AI is about its rating.<br><em>Higher = more reliable signal</em>',
      'Current Ratio': '<strong>Current Ratio</strong><br>Can the company pay short-term debts?<br><em>1.5+ = healthy liquidity</em>',
      'Gross Margin': '<strong>Gross Profit Margin</strong><br>Revenue minus cost of goods sold.<br><em>40%+ is strong</em>',
      'Dividend Yield': '<strong>Dividend Yield</strong><br>Annual dividend as % of stock price.<br><em>3-6% is attractive for income</em>'
    };


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DEMO MODE - Sample Stock Data
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const DEMO_STOCKS = [
      {
        symbol: 'AAPL', name: 'Apple Inc.', price: 182.45, changePct: 2.34,
        pe: 28.5, roe: 147.2, revenueGrowth: 16.3, grossMargin: 44.1,
        netMargin: 25.3, debtToEquity: 1.8, currentRatio: 1.0,
        marketCap: 2.85e12, volume: 52431000, rsi: 58,
        sector: 'Technology', index: 'S&P500'
      },
      {
        symbol: 'MSFT', name: 'Microsoft Corporation', price: 378.91, changePct: 1.87,
        pe: 34.2, roe: 38.4, revenueGrowth: 13.1, grossMargin: 69.8,
        netMargin: 34.1, debtToEquity: 0.4, currentRatio: 1.8,
        marketCap: 2.81e12, volume: 23456000, rsi: 62,
        sector: 'Technology', index: 'S&P500'
      },
      {
        symbol: 'GOOGL', name: 'Alphabet Inc.', price: 141.23, changePct: 1.45,
        pe: 24.8, roe: 25.1, revenueGrowth: 11.2, grossMargin: 56.9,
        netMargin: 23.7, debtToEquity: 0.1, currentRatio: 2.6,
        marketCap: 1.78e12, volume: 28901000, rsi: 54,
        sector: 'Technology', index: 'S&P500'
      },
      {
        symbol: 'NVDA', name: 'NVIDIA Corporation', price: 495.22, changePct: 3.12,
        pe: 72.1, roe: 74.3, revenueGrowth: 126.0, grossMargin: 72.4,
        netMargin: 48.9, debtToEquity: 0.3, currentRatio: 4.1,
        marketCap: 1.22e12, volume: 45678000, rsi: 68,
        sector: 'Technology', index: 'NASDAQ100'
      },
      {
        symbol: 'AMZN', name: 'Amazon.com Inc.', price: 151.94, changePct: 0.89,
        pe: 58.3, roe: 16.8, revenueGrowth: 10.8, grossMargin: 48.1,
        netMargin: 5.7, debtToEquity: 0.7, currentRatio: 1.0,
        marketCap: 1.57e12, volume: 39012000, rsi: 51,
        sector: 'Consumer', index: 'S&P500'
      },
      {
        symbol: 'TSLA', name: 'Tesla Inc.', price: 238.72, changePct: -1.23,
        pe: 62.4, roe: 22.4, revenueGrowth: 18.8, grossMargin: 18.2,
        netMargin: 14.5, debtToEquity: 0.1, currentRatio: 1.7,
        marketCap: 758e9, volume: 98234000, rsi: 45,
        sector: 'Consumer', index: 'NASDAQ100'
      },
      {
        symbol: 'META', name: 'Meta Platforms Inc.', price: 352.89, changePct: 2.67,
        pe: 26.1, roe: 30.2, revenueGrowth: 23.4, grossMargin: 81.5,
        netMargin: 29.1, debtToEquity: 0.0, currentRatio: 2.9,
        marketCap: 895e9, volume: 15678000, rsi: 65,
        sector: 'Technology', index: 'S&P500'
      },
      {
        symbol: 'BRK.B', name: 'Berkshire Hathaway', price: 383.45, changePct: 0.34,
        pe: 8.9, roe: 14.2, revenueGrowth: 8.1, grossMargin: 22.3,
        netMargin: 16.8, debtToEquity: 0.3, currentRatio: 1.4,
        marketCap: 878e9, volume: 3421000, rsi: 52,
        sector: 'Financials', index: 'S&P500'
      },
      {
        symbol: 'JPM', name: 'JPMorgan Chase', price: 155.67, changePct: 1.12,
        pe: 11.3, roe: 15.8, revenueGrowth: 9.4, grossMargin: 35.2,
        netMargin: 28.9, debtToEquity: 1.2, currentRatio: 1.1,
        marketCap: 456e9, volume: 8234000, rsi: 56,
        sector: 'Financials', index: 'S&P500'
      },
      {
        symbol: 'V', name: 'Visa Inc.', price: 267.43, changePct: 0.78,
        pe: 30.2, roe: 41.5, revenueGrowth: 11.3, grossMargin: 98.2,
        netMargin: 52.4, debtToEquity: 0.6, currentRatio: 1.4,
        marketCap: 548e9, volume: 5123000, rsi: 59,
        sector: 'Financials', index: 'S&P500'
      },
      {
        symbol: 'UNH', name: 'UnitedHealth Group', price: 524.89, changePct: 0.56,
        pe: 24.7, roe: 25.3, revenueGrowth: 14.2, grossMargin: 27.8,
        netMargin: 6.1, debtToEquity: 0.6, currentRatio: 0.8,
        marketCap: 489e9, volume: 2345000, rsi: 53,
        sector: 'Healthcare', index: 'S&P500'
      },
      {
        symbol: 'JNJ', name: 'Johnson & Johnson', price: 157.23, changePct: -0.23,
        pe: 15.8, roe: 22.1, revenueGrowth: 5.3, grossMargin: 68.4,
        netMargin: 16.7, debtToEquity: 0.5, currentRatio: 1.2,
        marketCap: 378e9, volume: 6789000, rsi: 48,
        sector: 'Healthcare', index: 'S&P500'
      },
      {
        symbol: 'XOM', name: 'Exxon Mobil', price: 103.45, changePct: -0.89,
        pe: 9.2, roe: 17.4, revenueGrowth: -2.1, grossMargin: 35.6,
        netMargin: 10.2, debtToEquity: 0.2, currentRatio: 1.3,
        marketCap: 421e9, volume: 18234000, rsi: 42,
        sector: 'Energy', index: 'S&P500'
      },
      {
        symbol: 'WMT', name: 'Walmart Inc.', price: 162.34, changePct: 0.45,
        pe: 28.4, roe: 18.9, revenueGrowth: 5.9, grossMargin: 24.8,
        netMargin: 2.4, debtToEquity: 0.7, currentRatio: 0.8,
        marketCap: 441e9, volume: 7123000, rsi: 55,
        sector: 'Consumer', index: 'S&P500'
      },
      {
        symbol: 'PG', name: 'Procter & Gamble', price: 152.89, changePct: 0.34,
        pe: 25.3, roe: 28.4, revenueGrowth: 4.2, grossMargin: 49.8,
        netMargin: 16.1, debtToEquity: 0.5, currentRatio: 0.6,
        marketCap: 362e9, volume: 5678000, rsi: 51,
        sector: 'Consumer', index: 'S&P500'
      },
      {
        symbol: 'HD', name: 'Home Depot', price: 342.56, changePct: 1.23,
        pe: 22.1, roe: 1247.3, revenueGrowth: 6.4, grossMargin: 33.6,
        netMargin: 10.9, debtToEquity: -8.2, currentRatio: 1.1,
        marketCap: 348e9, volume: 3456000, rsi: 58,
        sector: 'Consumer', index: 'S&P500'
      },
      {
        symbol: 'MA', name: 'Mastercard Inc.', price: 437.89, changePct: 0.89,
        pe: 35.6, roe: 148.2, revenueGrowth: 13.1, grossMargin: 100.0,
        netMargin: 45.3, debtToEquity: 2.1, currentRatio: 1.3,
        marketCap: 412e9, volume: 2891000, rsi: 60,
        sector: 'Financials', index: 'S&P500'
      },
      {
        symbol: 'DIS', name: 'Walt Disney Co.', price: 92.34, changePct: -0.56,
        pe: 42.1, roe: 3.2, revenueGrowth: -0.8, grossMargin: 34.2,
        netMargin: 2.9, debtToEquity: 0.5, currentRatio: 1.0,
        marketCap: 168e9, volume: 9234000, rsi: 44,
        sector: 'Consumer', index: 'S&P500'
      },
      {
        symbol: 'NFLX', name: 'Netflix Inc.', price: 447.12, changePct: 2.34,
        pe: 41.3, roe: 28.9, revenueGrowth: 9.2, grossMargin: 42.8,
        netMargin: 16.0, debtToEquity: 1.1, currentRatio: 1.2,
        marketCap: 192e9, volume: 4567000, rsi: 63,
        sector: 'Technology', index: 'NASDAQ100'
      },
      {
        symbol: 'COST', name: 'Costco Wholesale', price: 672.45, changePct: 0.67,
        pe: 47.2, roe: 29.4, revenueGrowth: 6.7, grossMargin: 11.0,
        netMargin: 2.6, debtToEquity: 0.4, currentRatio: 1.0,
        marketCap: 298e9, volume: 1789000, rsi: 57,
        sector: 'Consumer', index: 'S&P500'
      }
    ];

    
    // Process demo stocks with enhanced analysis
    const processedDemoStocks = DEMO_STOCKS.map(stock => {
      const analysis = computeEnhancedAnalysis(stock);
      return { ...stock, ...analysis };
    });


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // EDUCATION CENTER - Investing 101 & Learning Modules
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const EDUCATION_CENTER = {
      tutorials: [
        {
          id: 'what-is-stock',
          title: 'What is a Stock?',
          category: 'basics',
          duration: '5 min',
          icon: 'ğŸ“ˆ',
          content: {
            intro: 'A stock represents ownership in a company. When you buy a share, you own a small piece of that business.',
            keyPoints: [
              'Stocks give you partial ownership of a company',
              'Share prices go up and down based on company performance and investor sentiment',
              'You can make money through price appreciation or dividends',
              'Stocks are traded on exchanges like NYSE and NASDAQ'
            ],
            example: 'If Apple has 16 billion shares and you own 100 shares, you own 0.00000625% of Apple.',
            nextSteps: ['Learn about P/E Ratio', 'Understanding Market Cap', 'How to Read Stock Charts']
          }
        },
        {
          id: 'pe-ratio-explained',
          title: 'Understanding P/E Ratio',
          category: 'metrics',
          duration: '7 min',
          icon: 'ğŸ”¢',
          content: {
            intro: 'The Price-to-Earnings (P/E) ratio is one of the most important valuation metrics for stocks.',
            keyPoints: [
              'P/E = Stock Price Ã· Earnings Per Share',
              'Shows how much investors pay for each $1 of company earnings',
              'Lower P/E might indicate undervaluation',
              'Compare P/E ratios within the same industry',
              'Tech stocks typically have higher P/E ratios than utilities'
            ],
            example: 'If a stock costs $100 and earns $5 per share, its P/E is 20. You\'re paying $20 for every $1 of earnings.',
            whyItMatters: 'P/E helps you determine if a stock is overpriced or a good value compared to its earnings power.',
            practicalTip: 'A P/E under 15 is often considered undervalued, 15-25 is fair, and over 25 might be overvalued (but growth stocks are exceptions).',
            nextSteps: ['Learn ROE', 'Explore Debt-to-Equity', 'Master Market Cap']
          }
        },
        {
          id: 'roe-explained',
          title: 'Return on Equity (ROE)',
          category: 'metrics',
          duration: '6 min',
          icon: 'ğŸ’°',
          content: {
            intro: 'ROE measures how efficiently a company uses shareholder money to generate profits.',
            keyPoints: [
              'ROE = Net Income Ã· Shareholder Equity',
              'Shows profit generated from shareholder investments',
              '15%+ ROE is considered strong',
              '20%+ ROE is excellent',
              'Compare ROE within the same industry'
            ],
            example: 'If a company has $1 million equity and makes $200,000 profit, ROE is 20%. For every $1 invested, they generate $0.20 profit.',
            whyItMatters: 'ROE tells you if management is good at growing the business with your money.',
            practicalTip: 'Look for companies with consistently high ROE over several yearsâ€”it shows sustainable competitive advantage.',
            nextSteps: ['Understand ROIC', 'Learn Profit Margins', 'Study Buffett Strategy']
          }
        },
        {
          id: 'market-cap-sizes',
          title: 'Market Cap: Small, Mid, Large',
          category: 'basics',
          duration: '5 min',
          icon: 'ğŸ¢',
          content: {
            intro: 'Market capitalization (market cap) is the total value of all a company\'s shares.',
            keyPoints: [
              'Market Cap = Share Price Ã— Total Shares Outstanding',
              'Large Cap: $10 billion+ (stable, lower risk)',
              'Mid Cap: $2-10 billion (growth + stability)',
              'Small Cap: Under $2 billion (higher growth, higher risk)',
              'Mega Cap: $200 billion+ (Apple, Microsoft, etc.)'
            ],
            example: 'Apple with 16B shares at $180 = $2.88 trillion market cap (mega cap)',
            whyItMatters: 'Market cap indicates company size, risk level, and growth potential.',
            practicalTip: 'Beginners should focus on large caps for stability. Once comfortable, add mid and small caps for growth.',
            nextSteps: ['Portfolio Diversification', 'Risk Management', 'Asset Allocation']
          }
        },
        {
          id: 'reading-charts',
          title: 'How to Read Stock Charts',
          category: 'technical',
          duration: '10 min',
          icon: 'ğŸ“Š',
          content: {
            intro: 'Stock charts visualize price movements over time, helping you spot trends and patterns.',
            keyPoints: [
              'Candlesticks show Open, High, Low, Close prices',
              'Green/white candles = price went up, Red/black = down',
              'Support levels: price tends to bounce back up',
              'Resistance levels: price struggles to break through',
              'Volume bars show trading activity'
            ],
            example: 'If you see multiple bounces at $150, that\'s a support level. If price keeps hitting $175 but can\'t break through, that\'s resistance.',
            whyItMatters: 'Charts help you time your entry and exit points for better returns.',
            practicalTip: 'Start with simple trend lines. Uptrend = series of higher lows. Downtrend = series of lower highs.',
            nextSteps: ['RSI Indicator', 'Moving Averages', 'MACD Strategy']
          }
        },
        {
          id: 'rsi-indicator',
          title: 'RSI: Overbought or Oversold?',
          category: 'technical',
          duration: '8 min',
          icon: 'ğŸ“‰',
          content: {
            intro: 'The Relative Strength Index (RSI) measures momentum to identify overbought or oversold conditions.',
            keyPoints: [
              'RSI ranges from 0 to 100',
              'Above 70 = overbought (potential pullback coming)',
              'Below 30 = oversold (potential bounce coming)',
              'Best used with other indicators, not alone',
              '14-period RSI is the standard'
            ],
            example: 'If RSI hits 80, the stock may have risen too fast and could drop soon. If RSI is 25, it may have fallen too much and could bounce.',
            whyItMatters: 'RSI helps you avoid buying at peaks and identifies potential buying opportunities at dips.',
            practicalTip: 'Don\'t sell just because RSI is highâ€”strong trends can stay "overbought" for weeks. Use with trend analysis.',
            nextSteps: ['MACD Divergence', 'Bollinger Bands', 'Combine Indicators']
          }
        },
        {
          id: 'diversification',
          title: 'Portfolio Diversification 101',
          category: 'strategy',
          duration: '8 min',
          icon: 'ğŸ¯',
          content: {
            intro: 'Diversification means spreading your money across different investments to reduce risk.',
            keyPoints: [
              'Don\'t put all your eggs in one basket',
              'Diversify across sectors (tech, healthcare, finance, etc.)',
              'Mix large, mid, and small cap stocks',
              'Include different asset classes (stocks, bonds, real estate)',
              'International diversification reduces country-specific risk'
            ],
            example: 'Instead of putting $10,000 in one tech stock, spread it across 10 stocks in 5 different sectors.',
            whyItMatters: 'If one stock or sector crashes, you don\'t lose everything. Diversification smooths out returns.',
            practicalTip: 'Start with 8-15 stocks across different sectors. Too few = too risky. Too many = hard to track.',
            nextSteps: ['Asset Allocation', 'Sector Rotation', 'Rebalancing Strategy']
          }
        },
        {
          id: 'dollar-cost-averaging',
          title: 'Dollar-Cost Averaging Strategy',
          category: 'strategy',
          duration: '6 min',
          icon: 'ğŸ’µ',
          content: {
            intro: 'Dollar-cost averaging (DCA) means investing a fixed amount regularly, regardless of price.',
            keyPoints: [
              'Invest the same amount weekly/monthly',
              'Buy more shares when prices are low',
              'Buy fewer shares when prices are high',
              'Reduces impact of market volatility',
              'Removes emotion from investing decisions'
            ],
            example: 'Invest $500/month. When stock is $50, you buy 10 shares. When it drops to $25, you buy 20 shares. Your average cost is lower.',
            whyItMatters: 'DCA prevents you from investing everything at the peak and helps build wealth steadily.',
            practicalTip: 'Set up automatic monthly investments so you stick with it through market ups and downs.',
            nextSteps: ['Index Fund Investing', 'Long-term Wealth Building', 'Compound Growth']
          }
        }
      ],

      caseStudies: [
        {
          id: 'buffett-coca-cola',
          title: 'Warren Buffett & Coca-Cola',
          investor: 'Warren Buffett',
          year: '1988',
          icon: 'ğŸ¥¤',
          summary: 'How Buffett turned $1 billion into $25 billion by buying a simple, understandable business.',
          story: 'In 1988, Warren Buffett bought $1 billion worth of Coca-Cola stock when the market undervalued it during a temporary setback. He recognized Coke\'s powerful brand, global reach, and consistent earnings.',
          keyLessons: [
            'Invest in businesses you understand',
            'Look for strong brands with pricing power',
            'Buy quality companies when they\'re temporarily down',
            'Hold for the long term (35+ years and counting)',
            'Focus on business fundamentals, not market noise'
          ],
          metrics: {
            initialInvestment: '$1 billion',
            currentValue: '$25+ billion',
            annualReturn: '~10% per year',
            holdingPeriod: '35+ years'
          },
          takeaway: 'Simple businesses with strong competitive advantages can generate massive wealth if you\'re patient.'
        },
        {
          id: 'lynch-fidelity',
          title: 'Peter Lynch\'s 10-Baggers',
          investor: 'Peter Lynch',
          year: '1977-1990',
          icon: 'ğŸ¯',
          summary: 'How a retail investor mindset helped Lynch beat the market by finding everyday winners.',
          story: 'Peter Lynch ran Fidelity Magellan Fund and achieved 29% annual returns by investing in companies he encountered in daily lifeâ€”Dunkin\' Donuts, Hanes, Home Depot. He called these "10-baggers" (stocks that returned 10x).',
          keyLessons: [
            'Look for investment ideas in your daily life',
            'Do your homeworkâ€”understand what the company does',
            'Small companies can become big winners',
            'Visit stores, talk to customers, read annual reports',
            'You don\'t need Wall Street connections to find great stocks'
          ],
          metrics: {
            annualReturn: '29.2%',
            period: '13 years',
            $10kGrowth: '$280,000',
            famousWins: 'Taco Bell, Home Depot, Chrysler'
          },
          takeaway: 'Retail investors have an edgeâ€”you can discover great companies before Wall Street does.'
        },
        {
          id: 'oneil-canslim',
          title: 'William O\'Neil\'s CANSLIM',
          investor: 'William O\'Neil',
          year: '1960s+',
          icon: 'ğŸš€',
          summary: 'A systematic approach to finding growth stocks before they skyrocket.',
          story: 'William O\'Neil studied the best-performing stocks from 1953-1993 and found patterns. He created CANSLIMâ€”a checklist for identifying winning stocks. His system helped countless retail investors.',
          keyLessons: [
            'C: Current quarterly earnings up 25%+',
            'A: Annual earnings growth consistent',
            'N: New products, management, or highs',
            'S: Supply & Demandâ€”low float stocks move more',
            'L: Leader in industry, not laggard',
            'I: Institutional sponsorship present',
            'M: Market direction is upward'
          ],
          metrics: {
            avgWinner: '+100-300%',
            timeframe: '3-12 months',
            successRate: '~33% (1 in 3 big winners)',
            strategy: 'Growth stocks with momentum'
          },
          takeaway: 'Follow a proven system. Cut losses quickly at -7%, let winners run.'
        },
        {
          id: 'reit-income',
          title: 'Building Income with REITs',
          investor: 'Retail Investor Case',
          year: '2010-2025',
          icon: 'ğŸ˜ï¸',
          summary: 'How a teacher built $500/month passive income with real estate stocks.',
          story: 'A school teacher invested $50,000 into diversified REITs (Real Estate Investment Trusts) yielding 5-8% dividends. After 15 years, between dividends and growth, her portfolio generates $500+/month in passive income.',
          keyLessons: [
            'REITs must pay 90% of income as dividends',
            'Diversify across property types (retail, office, residential)',
            'Reinvest dividends in early years for compound growth',
            'REITs provide real estate exposure without property management',
            'Focus on quality REITs with strong balance sheets'
          ],
          metrics: {
            initialInvestment: '$50,000',
            monthlyIncome: '$500+',
            totalValue: '$125,000',
            averageYield: '6%',
            period: '15 years'
          },
          takeaway: 'Dividend-paying stocks can create reliable passive income streams over time.'
        }
      ],

      getProgress(userId) {
        const key = `re_education_progress_${userId || 'guest'}`;
        const stored = localStorage.getItem(key);
        return stored ? JSON.parse(stored) : { completed: [], inProgress: [] };
      },

      markComplete(userId, tutorialId) {
        const progress = this.getProgress(userId);
        if (!progress.completed.includes(tutorialId)) {
          progress.completed.push(tutorialId);
          progress.inProgress = progress.inProgress.filter(id => id !== tutorialId);
          localStorage.setItem(`re_education_progress_${userId || 'guest'}`, JSON.stringify(progress));
        }
      },

      markInProgress(userId, tutorialId) {
        const progress = this.getProgress(userId);
        if (!progress.completed.includes(tutorialId) && !progress.inProgress.includes(tutorialId)) {
          progress.inProgress.push(tutorialId);
          localStorage.setItem(`re_education_progress_${userId || 'guest'}`, JSON.stringify(progress));
        }
      },

      getCompletionRate(userId) {
        const progress = this.getProgress(userId);
        return Math.round((progress.completed.length / this.tutorials.length) * 100);
      },

      getTutorialsByCategory(category) {
        return this.tutorials.filter(t => t.category === category);
      },

      getNextTutorial(userId) {
        const progress = this.getProgress(userId);
        return this.tutorials.find(t => 
          !progress.completed.includes(t.id) && 
          !progress.inProgress.includes(t.id)
        );
      }
    };

    
    // Demo mode state
    let isDemoMode = false;

    // INVESTMENT STYLES
    const INVESTMENT_STYLES = {
      growth: { name: 'Growth', emoji: 'ğŸš€', description: 'High growth tech & innovation', 
                symbols: ['NVDA','SMCI','ARM','SNOW','TTD','UBER','SQ','SHOP','NET','DDOG'] },
      value: { name: 'Value', emoji: 'ğŸ’°', description: 'Undervalued stable businesses',
               symbols: ['BRK.B','JNJ','MMM','VZ','T','KO','PG','WMT','CVX','XOM'] },
      momentum: { name: 'Momentum', emoji: 'âš¡', description: 'Strong price trends',
                  symbols: ['TSLA','META','AMD','MU','COIN','MARA','PLTR','HOOD'] },
      quality: { name: 'Quality', emoji: 'â­', description: 'Excellent businesses',
                 symbols: ['MSFT','AAPL','GOOGL','COST','HD','ADBE','INTU','MA','V'] },
      dividend: { name: 'Dividend', emoji: 'ğŸ’µ', description: 'Reliable income',
                  symbols: ['VZ','T','KO','PG','MMM','JNJ','XOM','CVX','MO','ABBV'] }
    };


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ENHANCED AI ANALYSIS - Tier 1 Features
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function computeEnhancedAnalysis(stock) {
      // Calculate subscores
      const fundamentalScore = calculateFundamentalScore(stock);
      const technicalScore = calculateTechnicalScore(stock);
      const riskScore = calculateRiskScore(stock);
      
      const aiScore = Math.round((fundamentalScore * 0.5) + (technicalScore * 0.3) + (riskScore * 0.2));
      const verdict = getVerdict(aiScore);
      const confidence = calculateConfidence(stock);
      
      // Generate factor analysis (Bulls vs Bears)
      const factors = generateFactorAnalysis(stock);
      
      // Generate AI takeaway
      const takeaway = generateTakeaway(stock, verdict, factors);
      
      // Generate watchlist guidance
      const watchlistGuidance = generateWatchlistGuidance(stock, factors);
      
      return {
        aiScore,
        verdict,
        confidence,
        subscores: {
          fundamental: Math.round(fundamentalScore),
          technical: Math.round(technicalScore),
          risk: Math.round(riskScore)
        },
        topDrivers: {
          positive: factors.bullish,
          negative: factors.bearish
        },
        takeaway,
        watchlistGuidance,
        reassurance: "Remember: this is a data-driven assessment. Always do your own research and consider your risk tolerance before investing."
      };
    }
    
    function calculateFundamentalScore(stock) {
      let score = 50;
      
      // Get sector-specific benchmarks
      const benchmarks = getSectorBenchmarks(stock.sector);
      
      // === SECTOR-AWARE ROE SCORING ===
      if (stock.roe !== undefined && stock.roe !== null) {
        if (stock.roe > benchmarks.roe_excellent) {
          score += 15; // Exceptional profitability
        } else if (stock.roe > benchmarks.roe_target) {
          score += 10; // Strong profitability
        } else if (stock.roe > benchmarks.roe_target * 0.5) {
          score += 5; // Acceptable
        } else if (stock.roe < 0) {
          score -= 15; // Unprofitable
        } else {
          score -= 5; // Below sector standards
        }
      }
      
      // === SECTOR-AWARE P/E SCORING ===
      if (stock.pe > 0) {
        if (stock.pe < benchmarks.pe_base * 0.7) {
          score += 15; // Significantly undervalued
        } else if (stock.pe < benchmarks.pe_base) {
          score += 10; // Undervalued
        } else if (stock.pe < benchmarks.pe_acceptable) {
          score += 5; // Fairly valued
        } else if (stock.pe < benchmarks.pe_acceptable * 1.3) {
          score -= 5; // Slightly overvalued
        } else {
          score -= 10; // Significantly overvalued
        }
      }
      
      // === SECTOR-AWARE GROWTH SCORING ===
      if (stock.revenueGrowth !== undefined && stock.revenueGrowth !== null) {
        if (stock.revenueGrowth > benchmarks.growth_excellent) {
          score += 15; // Exceptional growth
        } else if (stock.revenueGrowth > benchmarks.growth_target) {
          score += 10; // Strong growth
        } else if (stock.revenueGrowth > benchmarks.growth_target * 0.5) {
          score += 5; // Moderate growth
        } else if (stock.revenueGrowth < -10) {
          score -= 15; // Significant decline
        } else if (stock.revenueGrowth < 0) {
          score -= 10; // Declining
        }
      }
      
      // === SECTOR-AWARE MARGIN SCORING ===
      if (stock.grossMargin !== undefined && stock.grossMargin !== null) {
        if (stock.grossMargin > benchmarks.margin_target * 1.5) {
          score += 12; // Exceptional margins
        } else if (stock.grossMargin > benchmarks.margin_target) {
          score += 8; // Strong margins
        } else if (stock.grossMargin > benchmarks.margin_target * 0.7) {
          score += 4; // Acceptable margins
        }
      }
      
      // Net margin bonus
      if (stock.netMargin !== undefined && stock.netMargin !== null) {
        if (stock.netMargin > 20) score += 5;
        else if (stock.netMargin < 0) score -= 5;
      }
      
      return Math.max(0, Math.min(100, score));
    }
    
    function calculateTechnicalScore(stock) {
      let score = 50;
      
      // RSI
      if (stock.rsi >= 30 && stock.rsi <= 70) score += 15;
      else if (stock.rsi > 70) score -= 10;
      else if (stock.rsi < 30) score += 5; // oversold can be opportunity
      
      // Price momentum
      if (stock.changePct > 5) score += 10;
      else if (stock.changePct > 0) score += 5;
      else if (stock.changePct < -5) score -= 10;
      
      return Math.max(0, Math.min(100, score));
    }
    
    function calculateRiskScore(stock) {
      let score = 50;
      
      // Debt/Equity
      if (stock.debtToEquity < 0.5) score += 20;
      else if (stock.debtToEquity < 1) score += 10;
      else if (stock.debtToEquity > 2) score -= 20;
      
      // Current ratio
      if (stock.currentRatio > 2) score += 15;
      else if (stock.currentRatio > 1.5) score += 10;
      else if (stock.currentRatio < 1) score -= 15;
      
      return Math.max(0, Math.min(100, score));
    }
    
    function getVerdict(score) {
      if (score >= 80) return "STRONG BUY";
      if (score >= 65) return "BUY";
      if (score >= 45) return "HOLD";
      if (score >= 30) return "REDUCE";
      return "SELL";
    }
    
    function calculateConfidence(stock) {
      let confidence = 50;
      
      // More data points = higher confidence
      const hasData = [
        stock.pe, stock.roe, stock.revenueGrowth, 
        stock.grossMargin, stock.debtToEquity, 
        stock.currentRatio, stock.rsi
      ].filter(v => v != null && !isNaN(v)).length;
      
      confidence += (hasData * 5);
      
      return Math.min(95, Math.max(30, confidence));
    }
    
    function generateFactorAnalysis(stock) {
      const bullish = [];
      const bearish = [];
      
      // ROE analysis
      if (stock.roe > 20) {
        bullish.push({
          factor: "Exceptional ROE",
          detail: `${stock.roe?.toFixed(1)}% ROE indicates strong profitability and efficient capital use`
        });
      } else if (stock.roe > 15) {
        bullish.push({
          factor: "Strong ROE",
          detail: `${stock.roe?.toFixed(1)}% ROE shows solid return on equity`
        });
      } else if (stock.roe < 10) {
        bearish.push({
          factor: "Low ROE",
          detail: `${stock.roe?.toFixed(1)}% ROE is below industry standards`
        });
      }
      
      // Growth analysis
      if (stock.revenueGrowth > 20) {
        bullish.push({
          factor: "High Growth",
          detail: `Revenue growing at ${stock.revenueGrowth?.toFixed(1)}% YoY shows strong demand`
        });
      } else if (stock.revenueGrowth < 0) {
        bearish.push({
          factor: "Revenue Decline",
          detail: `Revenue down ${Math.abs(stock.revenueGrowth)?.toFixed(1)}% YoY raises concerns`
        });
      }
      
      // Valuation analysis
      if (stock.pe > 0 && stock.pe < 15) {
        bullish.push({
          factor: "Attractive Valuation",
          detail: `P/E of ${stock.pe?.toFixed(1)} suggests stock may be undervalued`
        });
      } else if (stock.pe > 30) {
        bearish.push({
          factor: "High Valuation",
          detail: `P/E of ${stock.pe?.toFixed(1)} indicates premium pricing vs sector average`
        });
      }
      
      // Debt analysis
      if (stock.debtToEquity < 0.5) {
        bullish.push({
          factor: "Low Debt",
          detail: `Debt/Equity of ${stock.debtToEquity?.toFixed(2)} shows conservative balance sheet`
        });
      } else if (stock.debtToEquity > 1.5) {
        bearish.push({
          factor: "High Leverage",
          detail: `Debt/Equity of ${stock.debtToEquity?.toFixed(2)} indicates elevated financial risk`
        });
      }
      
      // Momentum analysis
      if (stock.changePct > 5) {
        bullish.push({
          factor: "Strong Momentum",
          detail: `Price up ${stock.changePct?.toFixed(1)}% shows positive market sentiment`
        });
      } else if (stock.changePct < -5) {
        bearish.push({
          factor: "Negative Momentum",
          detail: `Price down ${Math.abs(stock.changePct)?.toFixed(1)}% indicates selling pressure`
        });
      }
      
      // RSI analysis
      if (stock.rsi < 30) {
        bullish.push({
          factor: "Oversold Condition",
          detail: `RSI of ${stock.rsi?.toFixed(0)} suggests potential buying opportunity`
        });
      } else if (stock.rsi > 70) {
        bearish.push({
          factor: "Overbought",
          detail: `RSI of ${stock.rsi?.toFixed(0)} warns of potential pullback`
        });
      }
      
      // Ensure we always have at least some factors
      if (bullish.length === 0) {
        bullish.push({
          factor: "Stable Metrics",
          detail: "Core financials appear stable with no major red flags"
        });
      }
      if (bearish.length === 0) {
        bearish.push({
          factor: "Market Volatility",
          detail: "General market conditions warrant monitoring"
        });
      }
      
      return { bullish: bullish.slice(0, 3), bearish: bearish.slice(0, 3) };
    }
    
    function generateTakeaway(stock, verdict, factors) {
      const symbol = stock.symbol;
      
      if (verdict === "STRONG BUY" || verdict === "BUY") {
        return `Overall, ${symbol} presents a compelling opportunity. The combination of ${factors.bullish[0]?.factor.toLowerCase() || 'strong fundamentals'} and positive momentum suggests this could be a solid addition to a growth-focused portfolio. While ${factors.bearish[0]?.factor.toLowerCase() || 'some risks exist'}, the bullish factors currently outweigh concerns.`;
      } else if (verdict === "HOLD") {
        return `${symbol} shows mixed signals. While ${factors.bullish[0]?.factor.toLowerCase() || 'some positives exist'}, concerns around ${factors.bearish[0]?.factor.toLowerCase() || 'valuation'} suggest a wait-and-see approach. Consider this a watchlist candidate while monitoring for better entry points or improving fundamentals.`;
      } else {
        return `${symbol} faces headwinds that warrant caution. Key concerns include ${factors.bearish[0]?.factor.toLowerCase() || 'valuation pressure'} and ${factors.bearish[1]?.factor.toLowerCase() || 'weakening fundamentals'}. Unless you have strong conviction in a turnaround thesis, consider reducing exposure or avoiding new positions at current levels.`;
      }
    }
    
    function generateWatchlistGuidance(stock, factors) {
      const topBearish = factors.bearish[0]?.factor || "earnings surprises";
      const keyMetric = stock.roe > stock.revenueGrowth ? "ROE and profit margins" : "revenue growth and market share";
      
      return {
        headline: "What to Watch Next",
        items: [
          {
            label: "Next check-in",
            value: "Review after the next earnings cycle (typically quarterly)"
          },
          {
            label: "Key metric to monitor",
            value: keyMetric
          },
          {
            label: "Main risk to watch",
            value: topBearish
          }
        ]
      };
    }


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TIER 2: PORTFOLIO SECTOR ALLOCATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function computePortfolioAllocation(stocks, watchlist) {
      if (!watchlist || watchlist.length === 0) {
        return { stocks: [], sectorWeights: {}, isEmpty: true };
      }
      
      const watchlistedStocks = stocks.filter(s => watchlist.includes(s.symbol));
      
      if (watchlistedStocks.length === 0) {
        return { stocks: [], sectorWeights: {}, isEmpty: true };
      }
      
      // Equal weight allocation
      const weight = 100 / watchlistedStocks.length;
      
      const allocation = watchlistedStocks.map(s => ({
        symbol: s.symbol,
        name: s.name || s.symbol,
        sector: s.sector || 'Other',
        weight: weight,
        price: s.price,
        aiScore: s.aiScore,
        verdict: s.verdict
      }));
      
      // Calculate sector weights
      const sectorWeights = {};
      allocation.forEach(a => {
        sectorWeights[a.sector] = (sectorWeights[a.sector] || 0) + a.weight;
      });
      
      return {
        stocks: allocation,
        sectorWeights,
        isEmpty: false,
        totalStocks: watchlistedStocks.length,
        sectorCount: Object.keys(sectorWeights).length
      };
    }
    
    function getSectorColor(sector) {
      const colors = {
        'Technology': 'from-cyan-500 to-blue-500',
        'Healthcare': 'from-green-500 to-emerald-500',
        'Financials': 'from-yellow-500 to-orange-500',
        'Consumer': 'from-purple-500 to-pink-500',
        'Energy': 'from-red-500 to-orange-500',
        'Industrials': 'from-gray-500 to-slate-500',
        'Materials': 'from-amber-500 to-yellow-500',
        'Utilities': 'from-blue-500 to-cyan-500',
        'Real Estate': 'from-indigo-500 to-purple-500',
        'Communication': 'from-pink-500 to-rose-500',
        'Other': 'from-slate-500 to-gray-500'
      };
      return colors[sector] || colors['Other'];
    }


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ML MODELS: Advanced Analytics
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const MLModels = {
      optimizePortfolio(positions, riskFreeRate = 0.02) {
        try {
          if (!positions || positions.length === 0) throw new Error('No positions provided');
          const n = positions.length;
          const returns = positions.map(pos => pos.expectedReturn || 0.08);
          const volatilities = positions.map(pos => pos.volatility || 0.15);
          const correlation = 0.3; // Simplified correlation assumption
          
          // Build covariance matrix
          const covarianceMatrix = Array(n).fill().map((_, i) =>
            Array(n).fill().map((_, j) => {
              if (i === j) return Math.pow(volatilities[i], 2);
              return correlation * volatilities[i] * volatilities[j];
            })
          );
          
          // Monte Carlo simulation - generate 1000 random portfolios
          const portfolios = [];
          const numPortfolios = 1000;
          
          for (let p = 0; p < numPortfolios; p++) {
            // Generate random weights
            let weights = Array.from({ length: n }, () => Math.random());
            const sum = weights.reduce((a, b) => a + b, 0);
            weights = weights.map(w => w / sum); // Normalize to sum to 1
            
            // Calculate portfolio return
            const portfolioReturn = weights.reduce((sum, w, i) => sum + w * returns[i], 0);
            
            // Calculate portfolio variance
            let portfolioVariance = 0;
            for (let i = 0; i < n; i++) {
              for (let j = 0; j < n; j++) {
                portfolioVariance += weights[i] * weights[j] * covarianceMatrix[i][j];
              }
            }
            const portfolioVolatility = Math.sqrt(portfolioVariance);
            
            // Calculate Sharpe Ratio
            const sharpeRatio = (portfolioReturn - riskFreeRate) / portfolioVolatility;
            
            portfolios.push({ 
              weights, 
              return: portfolioReturn, 
              volatility: portfolioVolatility, 
              sharpeRatio 
            });
          }
          
          // Find optimal portfolios
          const maxSharpe = portfolios.reduce((best, current) => 
            current.sharpeRatio > best.sharpeRatio ? current : best
          );
          const minVolatility = portfolios.reduce((best, current) => 
            current.volatility < best.volatility ? current : best
          );
          
          // Get efficient frontier (subset of portfolios)
          const efficientFrontier = [...portfolios]
            .sort((a, b) => a.volatility - b.volatility)
            .filter((p, i) => i % 10 === 0)
            .slice(0, 20);
          
          return {
            maxSharpePortfolio: {
              ...maxSharpe,
              weights: maxSharpe.weights.map((w, i) => ({
                symbol: positions[i].symbol,
                weight: w * 100,
                contribution: w * returns[i]
              }))
            },
            minVolatilityPortfolio: {
              ...minVolatility,
              weights: minVolatility.weights.map((w, i) => ({
                symbol: positions[i].symbol,
                weight: w * 100,
                contribution: w * returns[i]
              }))
            },
            efficientFrontier,
            individualMetrics: positions.map((pos, i) => ({
              symbol: pos.symbol,
              expectedReturn: returns[i],
              volatility: volatilities[i],
              sharpeRatio: (returns[i] - riskFreeRate) / volatilities[i]
            }))
          };
        } catch (error) {
          console.error('Portfolio optimization error:', error);
          throw error;
        }
      }
    };
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // RETAIL INVESTOR FEATURES: SLEEP-WELL SCORE & CRASH SIMULATOR
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Calculate "Sleep-Well" score - measures portfolio comfort/volatility risk
    function calcSleepWellScore(stock) {
      const vol = stock.beta ? Math.abs((stock.beta - 1) * 30) : 25; // Estimate volatility from beta
      const maxDD = stock.changePct ? Math.abs(Math.min(0, stock.changePct)) * 3 : 30; // Rough drawdown estimate
      const de = stock.debtToEquity || 0.5;
      const rsi = stock.rsi || 50;

      let score = 100;
      
      // Volatility penalty
      if (vol > 35) score -= 20;
      else if (vol > 25) score -= 10;
      
      // Drawdown penalty
      if (maxDD > 40) score -= 25;
      else if (maxDD > 25) score -= 15;
      
      // Debt penalty
      if (de > 1) score -= 20;
      else if (de > 0.5) score -= 10;
      
      // RSI extremes penalty
      if (rsi > 70 || rsi < 30) score -= 10;
      
      return Math.max(0, Math.round(score));
    }

    // Market crash scenarios
    const CRASH_SCENARIOS = {
      '2008 Financial Crisis': { drop: -57, weeks: 78, name: '2008' },
      '2020 COVID Crash': { drop: -34, weeks: 5, name: '2020' },
      '2000 Dot-com Bust': { drop: -49, weeks: 63, name: '2000' },
      '1987 Black Monday': { drop: -34, weeks: 1, name: '1987' },
    };

    function simulateMarketCrash(portfolioHoldings, scenarioKey) {
      const scenario = CRASH_SCENARIOS[scenarioKey];
      if (!scenario) return null;
      
      const totalValue = portfolioHoldings.reduce((sum, h) => sum + h.currentValue, 0);
      const lossUsd = totalValue * Math.abs(scenario.drop) / 100;
      const lossPct = Math.abs(scenario.drop);
      const perWeek = lossUsd / scenario.weeks;
      const finalValue = totalValue - lossUsd;
      
      return {
        scenarioName: scenarioKey,
        totalValue,
        lossUsd,
        lossPct,
        weeks: scenario.weeks,
        perWeek,
        finalValue,
        percentRemaining: 100 - lossPct
      };
    }
    
    // TIER 3: ML PRICE PREDICTION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function computeMLPrediction(symbol) {
      try {
        console.log(`ğŸ¤– Computing ML prediction for ${symbol}...`);
        
        // Fetch 60 days of historical data using stable endpoint
        const url = `https://financialmodelingprep.com/stable/historical-price-eod/full?symbol=${symbol}&apikey=${FMP_API_KEY}`;
        const resp = await fetchWithRetry(url, { timeoutMs: 20000, retries: 1 });
        
        if (!resp.ok) {
          // 403 means premium endpoint not accessible - silently skip ML predictions
          if (resp.status === 403) {
            console.log(`âš ï¸ ML predictions require FMP premium subscription (skipping for ${symbol})`);
          } else {
            console.warn(`ML prediction fetch failed for ${symbol} - Status: ${resp.status}`);
          }
          return { predPct: null, conf: null, trend: null };
        }
        
        const data = await resp.json();
        
        // Stable endpoint returns array directly
        const historical = Array.isArray(data) ? data.slice(0, 60) : [];
        
        console.log(`   ğŸ“Š Got ${historical.length} historical data points for ${symbol}`);
        if (historical.length > 0) {
          console.log(`   ğŸ“… Sample data point:`, historical[0]);
        }
        
        if (historical.length < 60) {
          console.warn(`Insufficient historical data for ${symbol} (need 60 days, got ${historical.length})`);
          return { predPct: null, conf: null, trend: null };
        }
        
        // Get last 60 days of closing prices (reverse to chronological order)
        const prices = historical.slice(0, 60).reverse().map(d => d.close);
        console.log(`   ğŸ’° Extracted prices for ${symbol}: [${prices.slice(0, 5).join(', ')}...]`);
        console.log(`   ğŸ“ Current price: ${prices[prices.length - 1]}`);
        const current = prices[prices.length - 1];
        
        // Create simple linear regression model using TensorFlow.js
        console.log(`   ğŸ§  Creating tensors for ${symbol}...`);
        // Create 2D tensors for training (reshape to [60, 1])
        const xs = tf.tensor2d(Array.from({length: 60}, (_, i) => [i]));
        const ys = tf.tensor2d(prices.map(p => [p]));
        
        const model = tf.sequential();
        model.add(tf.layers.dense({units: 1, inputShape: [1]}));
        model.compile({
          optimizer: tf.train.adam(0.1),
          loss: 'meanSquaredError'
        });
        
        console.log(`   ğŸ“ Training model for ${symbol}...`);
        // Train the model (100 epochs with Adam optimizer)
        const history = await model.fit(xs, ys, {
          epochs: 100,
          verbose: 0,
          shuffle: false
        });
        
        console.log(`   âœ“ Training complete, final loss: ${history.history.loss[history.history.loss.length - 1]}`);
        
        // Predict the next day (day 60)
        console.log(`   ğŸ”® Predicting for ${symbol}...`);
        const prediction = model.predict(tf.tensor2d([[60]]));
        const predictedPrice = prediction.dataSync()[0];
        console.log(`   ğŸ’ Predicted price: ${predictedPrice}, Current: ${current}`);
        
        // Calculate percentage change
        const predPct = ((predictedPrice - current) / current) * 100;
        console.log(`   ğŸ“ˆ Percentage change: ${predPct}%`);
        
        // Estimate confidence (heuristic: smaller predictions = higher confidence)
        // Confidence decreases as prediction magnitude increases
        const rawConf = 100 - Math.abs(predPct) * 1.5;
        const conf = Math.round(Math.max(10, Math.min(90, rawConf)));
        
        // Determine trend
        const trend = predPct > 2 ? 'bullish' : predPct < -2 ? 'bearish' : 'neutral';
        
        // Generate interpretation
        let interpretation = '';
        const absPct = Math.abs(predPct);
        
        if (predPct > 10) {
          interpretation = `Strong upward trend predicted. Model suggests ${absPct.toFixed(1)}% potential gain based on recent price momentum.`;
        } else if (predPct > 5) {
          interpretation = `Moderate bullish signal. Technical analysis indicates ${absPct.toFixed(1)}% upside potential.`;
        } else if (predPct > 2) {
          interpretation = `Slight positive movement expected. Model forecasts ${absPct.toFixed(1)}% modest gain.`;
        } else if (predPct > -2) {
          interpretation = `Neutral forecast. Price expected to remain relatively stable with minimal movement (${Math.abs(predPct).toFixed(1)}%).`;
        } else if (predPct > -5) {
          interpretation = `Slight bearish trend. Model suggests ${absPct.toFixed(1)}% potential decline.`;
        } else if (predPct > -10) {
          interpretation = `Moderate downward pressure. Technical indicators point to ${absPct.toFixed(1)}% downside risk.`;
        } else {
          interpretation = `Strong bearish signal. Model predicts ${absPct.toFixed(1)}% potential loss based on recent trends.`;
        }
        
        // Add confidence context
        if (conf > 70) {
          interpretation += ` High confidence (${conf}%).`;
        } else if (conf > 50) {
          interpretation += ` Moderate confidence (${conf}%).`;
        } else {
          interpretation += ` Low confidence (${conf}%) - use caution.`;
        }
        
        // Cleanup tensors to prevent memory leaks
        xs.dispose();
        ys.dispose();
        prediction.dispose();
        
        console.log(`âœ“ ML prediction for ${symbol}: ${predPct.toFixed(1)}% (conf: ${conf}%)`);
        
        return {
          predPct: parseFloat(predPct.toFixed(1)),
          conf,
          trend,
          predictedPrice: parseFloat(predictedPrice.toFixed(2)),
          interpretation
        };
        
      } catch (error) {
        console.error(`ML prediction error for ${symbol}:`, error);
        return { predPct: null, conf: null, trend: null };
      }
    
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ENHANCED ML PREDICTION (V2.0) - Uses RSI, Volume, and Price History
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function computeAdvancedMLPrediction(priceHistory, currentRsi, currentVolume) {
      try {
        if (!priceHistory || priceHistory.length < 20) {
          console.warn('âš ï¸  Insufficient price history for advanced ML');
          return null;
        }
        
        const prices = priceHistory.map(d => d.close);
        const volumes = priceHistory.map(d => d.volume || currentVolume);
        const rsiValues = priceHistory.map((d, i) => currentRsi + (Math.random() - 0.5) * 10); // Simulated RSI history
        
        // Prepare training data: [price, rsi, volume] -> next_price
        const features = [];
        const labels = [];
        
        for (let i = 0; i < prices.length - 1; i++) {
          features.push([
            prices[i],
            rsiValues[i],
            volumes[i] / 1000000  // Normalize volume
          ]);
          labels.push(prices[i + 1]);
        }
        
        // Create tensors
        const xs = tf.tensor2d(features);
        const ys = tf.tensor2d(labels, [labels.length, 1]);
        
        // Build enhanced model
        const model = tf.sequential();
        model.add(tf.layers.dense({
          units: 16,
          activation: 'relu',
          inputShape: [3]
        }));
        model.add(tf.layers.dropout({ rate: 0.2 }));
        model.add(tf.layers.dense({
          units: 8,
          activation: 'relu'
        }));
        model.add(tf.layers.dense({
          units: 1
        }));
        
        // Compile model
        model.compile({
          optimizer: tf.train.adam(0.01),
          loss: 'meanSquaredError',
          metrics: ['mae']
        });
        
        // Train model
        await model.fit(xs, ys, {
          epochs: 50,
          verbose: 0,
          shuffle: true,
          validationSplit: 0.1
        });
        
        // Make prediction for next price
        const lastInput = tf.tensor2d([[
          prices[prices.length - 1],
          currentRsi,
          currentVolume / 1000000
        ]]);
        
        const prediction = model.predict(lastInput);
        const predictedPrice = prediction.dataSync()[0];
        
        // Calculate confidence based on recent volatility
        const recentPrices = prices.slice(-10);
        const volatility = calculateVolatility(recentPrices);
        const confidence = Math.max(0, Math.min(100, 100 - (volatility * 2)));
        
        // Cleanup tensors
        xs.dispose();
        ys.dispose();
        lastInput.dispose();
        prediction.dispose();
        model.dispose();
        
        console.log(`âœ… Advanced ML prediction: $${predictedPrice.toFixed(2)} (confidence: ${confidence.toFixed(0)}%)`);
        
        return {
          predictedPrice: predictedPrice,
          confidence: confidence,
          method: 'enhanced_ml'
        };
        
      } catch (error) {
        console.error('âŒ Advanced ML prediction error:', error);
        return null;
      }
    }
    
    // Helper: Calculate volatility
    function calculateVolatility(prices) {
      if (prices.length < 2) return 0;
      const returns = [];
      for (let i = 1; i < prices.length; i++) {
        returns.push((prices[i] - prices[i-1]) / prices[i-1]);
      }
      const mean = returns.reduce((a, b) => a + b, 0) / returns.length;
      const variance = returns.reduce((sum, r) => sum + Math.pow(r - mean, 2), 0) / returns.length;
      return Math.sqrt(variance) * 100;
    }
}
    
    function formatMLPrediction(pred) {
      if (pred == null || isNaN(pred)) return 'â€”';
      const sign = pred > 0 ? '+' : '';
      return `${sign}${pred.toFixed(1)}%`;
    }


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // TIER 3: PDF EXPORT / TEAR SHEET
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    async function exportStockTearSheet(stock) {
      try {
        console.log(`ğŸ“„ Generating PDF tear sheet for ${stock.symbol}...`);
        
        // Get the modal content element
        const element = document.getElementById('stock-modal-content');
        if (!element) {
          console.error('Stock modal content not found');
          return;
        }
        
        // Show loading indicator
        const originalContent = element.innerHTML;
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'fixed inset-0 bg-black/50 flex items-center justify-center z-50';
        loadingDiv.innerHTML = '<div class="text-white text-lg"><i class="fas fa-spinner animate-spin mr-2"></i>Generating PDF...</div>';
        element.appendChild(loadingDiv);
        
        // Wait a moment for rendering
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // Capture the modal as a canvas
        const canvas = await html2canvas(element, {
          backgroundColor: '#0f172a',
          scale: 2, // Higher quality
          logging: false,
          useCORS: true
        });
        
        // Remove loading indicator
        element.removeChild(loadingDiv);
        
        // Convert canvas to image
        const imgData = canvas.toDataURL('image/png');
        
        // Create PDF
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        
        // Calculate dimensions to fit A4
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
        
        // Add image to PDF
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        
        // Generate filename with date
        const date = new Date().toISOString().split('T')[0];
        const filename = `${stock.symbol}_TearSheet_${date}.pdf`;
        
        // Download
        pdf.save(filename);
        
        console.log(`âœ“ PDF tear sheet saved: ${filename}`);
        
      } catch (error) {
        console.error('PDF export error:', error);
        alert('Failed to generate PDF. Please try again.');
      }
    }






    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PHASE 1 ENHANCED - Export & Demo Mode Functions
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function exportScreenerResults(stocks) {
      const timestamp = new Date().toISOString().split('T')[0];
      const headers = ['Symbol', 'Name', 'Price', 'Change%', 'P/E', 'ROE%', 'Growth%', 'Score', 'Verdict'];
      const rows = stocks.map(s => [
        s.symbol, s.name, s.price?.toFixed(2), s.changePct?.toFixed(2),
        s.pe?.toFixed(1), s.roe?.toFixed(1), s.revenueGrowth?.toFixed(1),
        s.aiScore, s.verdict
      ]);
      const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `screener_${timestamp}.csv`;
      a.click();
    }
    
    function toggleDemoMode() {
      isDemoMode = !isDemoMode;
      console.log('Demo mode:', isDemoMode ? 'ON' : 'OFF');
      window.location.reload(); // Reload to apply demo data
    }


    const getSmartInsight = (stock) => {
      if (!stock) return null;
      
      // 1. Earnings (High Priority)
      if (stock.lastEarnings && stock.lastEarnings.date) {
        const earningsDate = new Date(stock.lastEarnings.date);
        const today = new Date();
        const diffTime = earningsDate - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays >= 0 && diffDays <= 7) return { text: `Earnings in ${diffDays}d`, color: 'text-yellow-400', icon: 'ğŸ“…' };
        if (diffDays < 0 && diffDays >= -2) return { text: `Earnings just reported`, color: 'text-blue-400', icon: 'ğŸ“¢' };
      }

      // 2. Technical Extremes
      if (stock.rsi < 30) return { text: `RSI Oversold (${stock.rsi.toFixed(0)})`, color: 'text-green-400', icon: 'ğŸ“‰' };
      if (stock.rsi > 75) return { text: `RSI Overbought (${stock.rsi.toFixed(0)})`, color: 'text-red-400', icon: 'ğŸ“ˆ' };
      
      // 3. Momentum
      if (stock.changePct > 5) return { text: `Big Move Up (+${stock.changePct.toFixed(1)}%)`, color: 'text-green-400', icon: 'ğŸš€' };
      if (stock.changePct < -5) return { text: `Big Drop (${stock.changePct.toFixed(1)}%)`, color: 'text-red-400', icon: 'ğŸ©¸' };

      // 4. Analyst Upside
      if (stock.upside > 30) return { text: `Analyst Upside +${stock.upside.toFixed(0)}%`, color: 'text-cyan-400', icon: 'ğŸ¯' };

      // 5. Fundamentals
      if (stock.revenueGrowth > 30) return { text: `High Growth (+${stock.revenueGrowth.toFixed(0)}%)`, color: 'text-purple-400', icon: 'ğŸŒ±' };
      if (stock.pe > 0 && stock.pe < 10) return { text: `Deep Value (P/E ${stock.pe.toFixed(1)})`, color: 'text-emerald-400', icon: 'ğŸ’°' };

      // 6. AI Verdict
      if (stock.verdict === 'STRONG BUY') return { text: 'AI Strong Buy', color: 'text-green-400', icon: 'ğŸ¤–' };
      if (stock.verdict === 'SELL') return { text: 'AI Sell Signal', color: 'text-red-400', icon: 'âš ï¸' };

      return { text: stock.sector || 'Neutral', color: 'text-slate-500', icon: 'ğŸ¢' };
    };

    const ALL_COLUMNS = [
      { key: 'symbol', label: 'Symbol', category: 'core' },
      { key: 'smartInsight', label: 'Smart Insight', category: 'core', tooltip: 'Key reason to watch this stock right now' },
      { key: 'price', label: 'Price', category: 'core' },
      { key: 'changePct', label: 'Change%', category: 'core' },
      { key: 'volume', label: 'Volume', category: 'core' },
      { key: 'sparkline', label: 'Sparkline', category: 'core' },
      
      // Valuation
      { key: 'pe', label: 'P/E', category: 'valuation' },
      { key: 'priceToBook', label: 'P/B', category: 'valuation' },
      { key: 'priceToSales', label: 'P/S', category: 'valuation' },
      { key: 'evToEbitda', label: 'EV/EBITDA', category: 'valuation' },
      
      // Profitability
      { key: 'roe', label: 'ROE%', category: 'profitability' },
      { key: 'roa', label: 'ROA%', category: 'profitability' },
      { key: 'roic', label: 'ROIC%', category: 'profitability' },
      { key: 'grossMargin', label: 'Gross Margin%', category: 'profitability' },
      { key: 'operatingMargin', label: 'Operating Margin%', category: 'profitability' },
      { key: 'netMargin', label: 'Net Margin%', category: 'profitability' },
      
      // Growth
      { key: 'revenueGrowth', label: 'Revenue Growth%', category: 'growth' },
      { key: 'netIncomeGrowth', label: 'Income Growth%', category: 'growth' },
      { key: 'epsGrowth', label: 'EPS Growth%', category: 'growth' },
      
      // Financial Health
      { key: 'currentRatio', label: 'Current Ratio', category: 'financial' },
      { key: 'quickRatio', label: 'Quick Ratio', category: 'financial' },
      { key: 'debtToEquity', label: 'Debt/Equity', category: 'financial' },
      { key: 'debtToAssets', label: 'Debt/Assets', category: 'financial' },
      { key: 'cashRatio', label: 'Cash Ratio', category: 'financial' },
      
      // Quality Scores
      { key: 'piotroskiScore', label: 'Piotroski', category: 'quality' },
      { key: 'altmanZScore', label: 'Altman Z', category: 'quality' },
      
      // Analyst Data
      { key: 'analystRating', label: 'FMP Rating', category: 'analyst' },
      { key: 'priceTargetAvg', label: 'Price Target', category: 'analyst' },
      { key: 'analystCount', label: 'Analyst Count', category: 'analyst' },
      
      { key: 'beta', label: 'Beta', category: 'technical', tooltip: 'Measure of volatility relative to the market. >1 is more volatile, <1 is less volatile.' },
      { key: 'rsi', label: 'RSI', category: 'technical' },
      { key: 'index', label: 'Index', category: 'core' },
      
      // ML & AI
      { key: 'mlPrediction', label: 'ML 30d', category: 'ml', tooltip: 'Machine learning prediction of 30-day price movement based on 60 days of historical data. Positive % = expected gain, Negative % = expected decline.' },
      { key: 'verdict', label: 'Verdict', category: 'core' },
    ];

    const DEFAULT_VISIBLE = ['symbol', 'smartInsight', 'price', 'changePct', 'pe', 'roe', 'analystRating', 'mlPrediction', 'verdict'];

    const PRESET_SCREENS = {
      buffett: {
        name: 'Buffett',
        filters: { pe_min: 0, pe_max: 20, roe_min: 15, marketCap_min: 1e9 }
      },
      magic: {
        name: 'Magic Formula',
        filters: { pe_min: 0, pe_max: 20, roe_min: 20, marketCap_min: 1e9 }
      },
      growth: {
        name: 'Growth',
        filters: { roe_min: 20, rsi_min: 50, marketCap_min: 1e9 }
      },
      momentum: {
        name: 'Momentum',
        filters: { changePct_min: 0, rsi_min: 60 }
      },
      oversold: {
        name: 'Oversold',
        filters: { rsi_min: 0, rsi_max: 30 }
      },
    };

    const THEMES = [
      { id: 'ai', label: 'AI & ML', keywords: ['artificial intelligence', 'ai', 'machine learning', 'llm', 'generative', 'nvidia', 'openai'] },
      { id: 'cloud', label: 'Cloud Computing', keywords: ['cloud computing', 'saas', 'infrastructure', 'data center', 'aws', 'azure'] },
      { id: 'ev', label: 'Electric Vehicles', keywords: ['electric vehicle', 'ev', 'battery', 'charging', 'tesla', 'rivian'] },
      { id: 'fintech', label: 'Fintech', keywords: ['financial technology', 'fintech', 'payment', 'blockchain', 'crypto', 'stripe'] },
      { id: 'cyber', label: 'Cybersecurity', keywords: ['cybersecurity', 'security software', 'threat', 'vulnerability', 'palo alto'] },
      { id: 'biotech', label: 'Biotech', keywords: ['biotech', 'pharmaceutical', 'genomics', 'crispr', 'moderna'] },
      { id: 'renewable', label: 'Renewable Energy', keywords: ['renewable energy', 'solar', 'wind', 'clean energy', 'tesla energy'] },
      { id: 'semiconductor', label: 'Semiconductors', keywords: ['semiconductor', 'chip', 'fab', 'tsmc', 'intel', 'nvidia'] },
    ];

    const SECTORS = [
      'Technology', 'Healthcare', 'Financial Services', 'Consumer Cyclical', 'Industrials',
      'Communication Services', 'Consumer Defensive', 'Energy', 'Real Estate', 'Utilities', 'Basic Materials'
    ];

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UTILITY FUNCTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const formatNumber = (val, decimals = 2) => {
      if (val == null || isNaN(val)) return 'â€”';
      if (Math.abs(val) >= 1e12) return `${(val / 1e12).toFixed(1)}T`;
      if (Math.abs(val) >= 1e9) return `${(val / 1e9).toFixed(1)}B`;
      if (Math.abs(val) >= 1e6) return `${(val / 1e6).toFixed(1)}M`;
      return val.toFixed(decimals);
    };

    const formatPercent = (val, decimals = 1) => {
      if (val == null || isNaN(val)) return 'â€”';
      return `${val > 0 ? '+' : ''}${val.toFixed(decimals)}%`;
    };

    const formatCurrency = (val) => {
      if (val == null || isNaN(val)) return '$â€”';
      return `$${formatNumber(val)}`;
    };

    const formatDateSafe = (value, fallback = 'â€”') => {
      if (!value) return fallback;
      const t = new Date(value).getTime();
      if (!Number.isFinite(t)) return fallback;
      try {
        return new Date(t).toLocaleDateString();
      } catch {
        return fallback;
      }
    };

    const getSentimentColor = (val) => {
      if (val == null || isNaN(val)) return 'text-slate-500';
      if (val > 0) return 'text-green-400';
      if (val < 0) return 'text-red-400';
      return 'text-yellow-400';
    };

    const getHealthColor = (health) => {
      if (health >= 70) return 'bg-green-500';
      if (health >= 40) return 'bg-yellow-500';
      return 'bg-red-500';
    };

    const exportToCSV = (data, filename = 'export.csv') => {
      if (!data || !data.length) return;
      
      const headers = Object.keys(data[0]);
      const csvContent = [
        headers.join(','),
        ...data.map(row => headers.map(header => {
          const cell = row[header];
          if (cell == null) return '';
          // Escape quotes and wrap in quotes if contains comma
          const stringCell = String(cell);
          return stringCell.includes(',') ? `"${stringCell.replace(/"/g, '""')}"` : stringCell;
        }).join(','))
      ].join('\n');
      
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.style.display = 'none';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // REAL-TIME DATA ENGINE (Finnhub WebSocket + Smart Polling)
    // Cost: FREE with existing Finnhub API key!
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    class RealtimeDataManager {
      constructor(apiKey = API_KEYS.FINNHUB) {
        this.apiKey = apiKey;
        this.ws = null;
        this.subscribers = new Map(); // symbol -> [callbacks]
        this.reconnectAttempts = 0;
        this.maxReconnectAttempts = 3; // Reduced from 5
        this.reconnectDelay = 1000;

        this.isConnected = false;
        this.lastPrices = new Map(); // symbol -> last known price
        this.connectionListeners = [];
        this.websocketDisabled = false; // Flag to disable WebSocket permanently if not supported
      }

      connect() {
        // Don't attempt connection if WebSocket is permanently disabled
        if (this.websocketDisabled) {
          console.log('âš ï¸ WebSocket disabled (free tier limitation). Using smart polling instead.');
          return;
        }
        
        if (this.ws?.readyState === WebSocket.OPEN) {
          console.log('âœ… WebSocket already connected');
          return;
        }
        
        // Only log on first attempt to reduce console spam
        if (this.reconnectAttempts === 0) {
          console.log('ğŸ”Œ Connecting to Finnhub WebSocket...');
          console.log(`ğŸ”‘ Using API key: ${this.apiKey.substring(0, 10)}...`);
        }
        
        try {
          this.ws = new WebSocket(`wss://ws.finnhub.io?token=${this.apiKey}`);
          
          this.ws.onopen = () => {
            console.log('âœ… WebSocket connected successfully!');
            this.isConnected = true;
            this.reconnectAttempts = 0;
            this.notifyConnectionChange(true);
            
            // Resubscribe to all symbols
            this.subscribers.forEach((_, symbol) => {
              this.ws.send(JSON.stringify({type: 'subscribe', symbol: symbol}));
              console.log(`ğŸ“¡ Resubscribed to ${symbol}`);
            });
          };
          
          this.ws.onmessage = (event) => {
            try {
              const data = JSON.parse(event.data);
              
              if (data.type === 'trade' && data.data) {
                // Process real-time trades
                data.data.forEach(trade => {
                  const symbol = trade.s;
                  const price = trade.p;
                  const volume = trade.v;
                  const timestamp = trade.t;
                  
                  // Store last price
                  const lastPrice = this.lastPrices.get(symbol);
                  this.lastPrices.set(symbol, price);
                  
                  // Calculate change
                  const change = lastPrice ? ((price - lastPrice) / lastPrice * 100) : 0;
                  
                  // Notify subscribers
                  const callbacks = this.subscribers.get(symbol);
                  if (callbacks) {
                    callbacks.forEach(cb => {
                      try {
                        cb({
                          symbol,
                          price,
                          volume,
                          timestamp,
                          quoteFetchedAt: timestamp,
                          change,
                          source: 'websocket'
                        });
                      } catch (err) {
                        console.error(`Error in callback for ${symbol}:`, err);
                      }
                    });
                  }
                });
              }
            } catch (error) {
              console.error('âŒ Error processing WebSocket message:', error);
            }
          };
          
          this.ws.onerror = (error) => {
            // Suppress error logging on reconnection attempts (just noise)
            if (this.reconnectAttempts === 0) {
              console.log('âš ï¸ WebSocket connection error (checking connectivity...)');
            }
          };
          
          this.ws.onclose = (event) => {
            // Only log meaningful close events
            if (this.reconnectAttempts === 0 && event.code !== 1006) {
              console.log(`ğŸ”Œ WebSocket disconnected (code: ${event.code})`);
            }
            this.isConnected = false;
            this.notifyConnectionChange(false);
            this.reconnect();
          };
        } catch (error) {
          console.error('âŒ Failed to create WebSocket:', error);
          this.reconnect();
        }
      }
      
      reconnect() {
        if (this.reconnectAttempts >= this.maxReconnectAttempts) {
          console.warn('âš ï¸ WebSocket connection failed (likely free tier limitation)');
          console.log('ğŸ“Š Continuing with smart polling for data updates');
          this.websocketDisabled = true; // Permanently disable WebSocket
          this.notifyConnectionChange(false);
          return;
        }
        
        this.reconnectAttempts++;
        const delay = this.reconnectDelay * Math.pow(2, this.reconnectAttempts - 1);
        
        // Only log on first few attempts
        if (this.reconnectAttempts <= 2) {
          console.log(`ğŸ”„ Reconnecting in ${delay}ms... (attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts})`);
        }
        
        setTimeout(() => this.connect(), delay);
      }
      
      subscribe(symbol, callback) {
        if (!this.subscribers.has(symbol)) {
          this.subscribers.set(symbol, []);
          
          // Send subscribe message if connected
          if (this.isConnected && this.ws?.readyState === WebSocket.OPEN) {
            this.ws.send(JSON.stringify({type: 'subscribe', symbol: symbol}));
            console.log(`ğŸ“¡ Subscribed to ${symbol} real-time updates`);
          }
        }
        
        this.subscribers.get(symbol).push(callback);
        console.log(`âœ… Added subscriber for ${symbol} (total: ${this.subscribers.get(symbol).length})`);
      }
      
      unsubscribe(symbol, callback) {
        const callbacks = this.subscribers.get(symbol);
        if (!callbacks) return;
        
        const index = callbacks.indexOf(callback);
        if (index > -1) {
          callbacks.splice(index, 1);
          console.log(`âœ… Removed subscriber for ${symbol} (remaining: ${callbacks.length})`);
        }
        
        // If no more subscribers, unsubscribe from WebSocket
        if (callbacks.length === 0) {
          this.subscribers.delete(symbol);
          if (this.isConnected && this.ws?.readyState === WebSocket.OPEN) {
            this.ws.send(JSON.stringify({type: 'unsubscribe', symbol: symbol}));
            console.log(`ğŸ“¡ Unsubscribed from ${symbol}`);
          }
        }
      }
      
      disconnect() {
        if (this.ws) {
          console.log('ğŸ”Œ Disconnecting WebSocket...');
          this.ws.close();
          this.ws = null;
        }
        this.subscribers.clear();
        this.isConnected = false;
        this.lastPrices.clear();
        this.notifyConnectionChange(false);
      }
      
      onConnectionChange(callback) {
        this.connectionListeners.push(callback);
      }
      
      notifyConnectionChange(connected) {
        this.connectionListeners.forEach(cb => {
          try {
            cb(connected);
          } catch (err) {
            console.error('Error in connection listener:', err);
          }
        });
      }
      
      getStatus() {
        return {
          connected: this.isConnected,
          subscribedSymbols: Array.from(this.subscribers.keys()),
          totalSubscribers: Array.from(this.subscribers.values()).reduce((sum, arr) => sum + arr.length, 0)
        };
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SMART POLLING (Fallback for when WebSocket not available)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    class SmartPoller {
      constructor() {
        this.intervals = new Map(); // symbol -> interval ID
        this.baseUpdateFrequency = 5000; // 5 seconds during market hours
        this.offHoursFrequency = 60000; // 60 seconds when market closed
      }
      
      async pollStock(symbol, callback) {
        // Clean symbol to remove exchange suffixes (.O, .K, etc.)
        symbol = cleanSymbol(symbol);
        
        try {
          console.log(`â±ï¸ Polling ${symbol}...`);
          
          // Use existing smartFetch with fallback
          const result = await smartFetch('quote', symbol);
          
          if (result?.data?.[0]) {
            const data = result.data[0];
            callback({
              symbol,
              price: data.price,
              change: data.change,
              changesPercentage: data.changesPercentage,
              volume: data.volume,
              quoteFetchedAt: Date.now(),
              source: 'polling'
            });
            console.log(`âœ… Polled ${symbol}: $${data.price}`);
          }
        } catch (error) {
          console.error(`âŒ Polling error for ${symbol}:`, error);
        }
      }
      
      startPolling(symbol, callback) {
        if (this.intervals.has(symbol)) {
          console.log(`â±ï¸ Already polling ${symbol}`);
          return;
        }
        
        const frequency = Cache.isMarketOpen() 
          ? this.baseUpdateFrequency 
          : this.offHoursFrequency;
        
        console.log(`â±ï¸ Starting polling for ${symbol} every ${frequency/1000}s`);
        
        // Initial fetch
        this.pollStock(symbol, callback);
        
        // Set interval
        const intervalId = setInterval(() => {
          this.pollStock(symbol, callback);
        }, frequency);
        
        this.intervals.set(symbol, intervalId);
      }
      
      stopPolling(symbol) {
        const intervalId = this.intervals.get(symbol);
        if (intervalId) {
          clearInterval(intervalId);
          this.intervals.delete(symbol);
          console.log(`â±ï¸ Stopped polling ${symbol}`);
        }
      }
      
      stopAll() {
        console.log(`â±ï¸ Stopping all polling (${this.intervals.size} symbols)`);
        this.intervals.forEach(id => clearInterval(id));
        this.intervals.clear();
      }
      
      getPollingSymbols() {
        return Array.from(this.intervals.keys());
      }
    }

    // Initialize global instances
    const realtimeData = new RealtimeDataManager();
    const smartPoller = new SmartPoller();
    
    // WebSocket disabled (free tier limitation) - using smart polling instead
    // Smart polling provides real-time updates without WebSocket connection
    console.log('ğŸ“Š Real-time updates enabled via smart polling');

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SOCIAL SENTIMENT ENGINE (StockTwits + Community Data)
    // Cost: FREE - No API key required!
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    class SocialSentimentManager {
      constructor() {
        this.cache = new Map(); // symbol -> social data
        this.cacheExpiry = 300000; // 5 minutes
      }

      async fetchSocialSentiment(symbol) {
        try {
          console.log(`ğŸ’¬ Fetching social sentiment for ${symbol}...`);
          
          // Check cache
          const cached = this.cache.get(symbol);
          if (cached && (Date.now() - cached.timestamp) < this.cacheExpiry) {
            console.log(`ğŸ’¾ Using cached social sentiment for ${symbol}`);
            return cached.data;
          }

          // Fetch from multiple social sources in parallel
          const [stockTwitsData, redditData] = await Promise.all([
            this.fetchStockTwits(symbol),
            this.fetchRedditSentiment(symbol)
          ]);

          // Combine data from both sources
          const combined = this.combineSocialData(stockTwitsData, redditData, symbol);

          // Cache result
          this.cache.set(symbol, { data: combined, timestamp: Date.now() });

          console.log(`âœ… Combined social sentiment: ${combined.overallSentiment} (StockTwits: ${stockTwitsData.totalMessages} | Reddit: ${redditData.totalPosts} posts)`);
          
          return combined;

        } catch (error) {
          console.error(`âŒ Error fetching social sentiment for ${symbol}:`, error);
          return this.getDefaultSentiment();
        }
      }

      async fetchStockTwits(symbol) {
        try {
          // Use proxy server to avoid CORS
          const response = await fetchWithRetry(`${API_BASE_URL}/api/stocktwits/${symbol}`, { timeoutMs: 12000, retries: 1 });
          
          if (!response.ok) {
            console.log(`âš ï¸ StockTwits API returned ${response.status}`);
            return { totalMessages: 0, bullishCount: 0, bearishCount: 0, neutralCount: 0, messages: [] };
          }

          const data = await response.json();
          
          if (!data.messages || data.messages.length === 0) {
            return { totalMessages: 0, bullishCount: 0, bearishCount: 0, neutralCount: 0, messages: [] };
          }

          const messages = data.messages;
          let bullishCount = 0;
          let bearishCount = 0;
          let neutralCount = 0;

          messages.forEach(msg => {
            if (msg.entities && msg.entities.sentiment) {
              const sentiment = msg.entities.sentiment.basic;
              if (sentiment === 'Bullish') bullishCount++;
              else if (sentiment === 'Bearish') bearishCount++;
              else neutralCount++;
            } else {
              neutralCount++;
            }
          });

          return {
            totalMessages: messages.length,
            bullishCount,
            bearishCount,
            neutralCount,
            messages: messages.slice(0, 5).map(msg => ({
              text: msg.body,
              user: msg.user.username,
              sentiment: msg.entities?.sentiment?.basic || 'Neutral',
              timestamp: msg.created_at,
              likes: msg.likes?.total || 0,
              source: 'StockTwits'
            }))
          };

        } catch (error) {
          console.error(`âŒ StockTwits error:`, error);
          return { totalMessages: 0, bullishCount: 0, bearishCount: 0, neutralCount: 0, messages: [] };
        }
      }

      async fetchRedditSentiment(symbol) {
        try {
          console.log(`ğŸ¤– Fetching Reddit/WSB sentiment for ${symbol}...`);
          
          // Search WallStreetBets for the stock symbol
          const subreddits = ['wallstreetbets', 'stocks', 'investing'];
          const allPosts = [];

          for (const subreddit of subreddits) {
            try {
              // Use proxy server to avoid CORS
              const searchUrl = `${API_BASE_URL}/api/reddit/${subreddit}/search?q=${symbol}`;
              const response = await fetchWithRetry(searchUrl, { timeoutMs: 12000, retries: 1 });

              if (response.ok) {
                const data = await response.json();
                if (data.data && data.data.children) {
                  allPosts.push(...data.data.children.map(child => ({
                    ...child.data,
                    subreddit: subreddit
                  })));
                }
              }
            } catch (err) {
              console.log(`âš ï¸ Error fetching from r/${subreddit}`);
            }
          }

          if (allPosts.length === 0) {
            return { totalPosts: 0, bullishCount: 0, bearishCount: 0, neutralCount: 0, posts: [] };
          }

          // Analyze sentiment using post titles, scores, and content
          let bullishCount = 0;
          let bearishCount = 0;
          let neutralCount = 0;

          const sentimentAnalyzer = new SentimentAnalyzer();

          const analyzedPosts = allPosts.map(post => {
            const text = (post.title + ' ' + (post.selftext || '')).toLowerCase();
            const sentiment = sentimentAnalyzer.analyzeSentiment(text);
            
            // Weight by upvotes (more upvoted = more important)
            const weight = Math.log10(Math.max(post.score, 1) + 1);
            
            if (sentiment.label === 'bullish') {
              bullishCount += weight;
            } else if (sentiment.label === 'bearish') {
              bearishCount += weight;
            } else {
              neutralCount += weight;
            }

            return {
              title: post.title,
              text: post.selftext?.substring(0, 200) || '',
              url: `https://www.reddit.com${post.permalink}`,
              author: post.author,
              score: post.score,
              comments: post.num_comments,
              sentiment: sentiment.label,
              subreddit: post.subreddit,
              timestamp: new Date(post.created_utc * 1000).toISOString()
            };
          });

          // Sort by score (popularity)
          analyzedPosts.sort((a, b) => b.score - a.score);

          return {
            totalPosts: allPosts.length,
            bullishCount: Math.round(bullishCount),
            bearishCount: Math.round(bearishCount),
            neutralCount: Math.round(neutralCount),
            posts: analyzedPosts.slice(0, 5)
          };

        } catch (error) {
          console.error(`âŒ Reddit API error:`, error);
          return { totalPosts: 0, bullishCount: 0, bearishCount: 0, neutralCount: 0, posts: [] };
        }
      }

      combineSocialData(stockTwits, reddit, symbol) {
        const totalMessages = stockTwits.totalMessages + reddit.totalPosts;
        
        if (totalMessages === 0) {
          return this.getDefaultSentiment();
        }

        // Combine counts with weighted average (StockTwits 40%, Reddit 60% - Reddit is more influential)
        const stWeight = 0.4;
        const rdWeight = 0.6;

        const bullishCount = Math.round(
          (stockTwits.bullishCount * stWeight + reddit.bullishCount * rdWeight)
        );
        const bearishCount = Math.round(
          (stockTwits.bearishCount * stWeight + reddit.bearishCount * rdWeight)
        );
        const neutralCount = Math.round(
          (stockTwits.neutralCount * stWeight + reddit.neutralCount * rdWeight)
        );

        const total = bullishCount + bearishCount + neutralCount || 1;
        const bullishPercent = (bullishCount / total * 100);
        const bearishPercent = (bearishCount / total * 100);
        const neutralPercent = (neutralCount / total * 100);

        // Determine overall sentiment
        let overallSentiment = 'neutral';
        let sentimentScore = 0;
        
        if (bullishCount > bearishCount * 1.3) {
          overallSentiment = 'bullish';
          sentimentScore = Math.round(bullishPercent - bearishPercent);
        } else if (bearishCount > bullishCount * 1.3) {
          overallSentiment = 'bearish';
          sentimentScore = -Math.round(bearishPercent - bullishPercent);
        } else {
          overallSentiment = 'neutral';
          sentimentScore = Math.round(bullishPercent - bearishPercent);
        }

        return {
          source: 'StockTwits + Reddit',
          totalMessages,
          stockTwitsCount: stockTwits.totalMessages,
          redditCount: reddit.totalPosts,
          bullishCount,
          bearishCount,
          neutralCount,
          bullishPercent: Math.round(bullishPercent),
          bearishPercent: Math.round(bearishPercent),
          neutralPercent: Math.round(neutralPercent),
          overallSentiment,
          sentimentScore,
          messages: [
            ...stockTwits.messages.slice(0, 3),
            ...reddit.posts.slice(0, 2).map(post => ({
              text: post.title,
              user: post.author,
              sentiment: post.sentiment,
              timestamp: post.timestamp,
              likes: post.score,
              source: 'Reddit',
              url: post.url,
              subreddit: post.subreddit
            }))
          ],
          redditPosts: reddit.posts,
          trending: totalMessages > 30 || reddit.totalPosts > 20,
          timestamp: Date.now()
        };
      }

      getDefaultSentiment() {
        return {
          source: 'N/A',
          totalMessages: 0,
          bullishCount: 0,
          bearishCount: 0,
          neutralCount: 0,
          bullishPercent: 0,
          bearishPercent: 0,
          neutralPercent: 0,
          overallSentiment: 'neutral',
          sentimentScore: 0,
          messages: [],
          trending: false,
          timestamp: Date.now()
        };
      }

      clearCache() {
        this.cache.clear();
      }
    }

    // Initialize social sentiment manager
    const socialSentiment = new SocialSentimentManager();
    window.socialSentiment = socialSentiment;
    console.log('âœ… Social Sentiment Manager initialized');

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // REAL-TIME NEWS & SENTIMENT ANALYSIS ENGINE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    class SentimentAnalyzer {
      constructor() {
        // Sentiment word dictionaries
        this.positiveWords = new Set([
          'bullish', 'surge', 'rally', 'soar', 'gain', 'profit', 'growth', 'beat', 'exceed', 'strong',
          'upgrade', 'buy', 'outperform', 'success', 'positive', 'innovative', 'breakthrough', 'record',
          'boost', 'jump', 'rise', 'upbeat', 'optimistic', 'confident', 'expansion', 'momentum', 'robust',
          'stellar', 'impressive', 'thriving', 'flourish', 'recover', 'rebound', 'accelerate', 'advance'
        ]);
        
        this.negativeWords = new Set([
          'bearish', 'plunge', 'crash', 'fall', 'loss', 'decline', 'miss', 'below', 'weak', 'concern',
          'downgrade', 'sell', 'underperform', 'failure', 'negative', 'risk', 'warning', 'layoff',
          'drop', 'tumble', 'slide', 'pessimistic', 'worried', 'fearful', 'contraction', 'slump', 'fragile',
          'disappointing', 'struggle', 'suffer', 'collapse', 'crisis', 'trouble', 'investigation', 'lawsuit'
        ]);
      }
      
      analyzeSentiment(text) {
        if (!text) return { score: 0, label: 'neutral', confidence: 0 };
        
        const words = text.toLowerCase().split(/\W+/);
        let positiveCount = 0;
        let negativeCount = 0;
        
        words.forEach(word => {
          if (this.positiveWords.has(word)) positiveCount++;
          if (this.negativeWords.has(word)) negativeCount++;
        });
        
        const totalSentimentWords = positiveCount + negativeCount;
        if (totalSentimentWords === 0) {
          return { score: 0, label: 'neutral', confidence: 0 };
        }
        
        // Score from -100 to +100
        const score = ((positiveCount - negativeCount) / totalSentimentWords) * 100;
        
        // Confidence based on number of sentiment words found
        const confidence = Math.min(100, (totalSentimentWords / words.length) * 500);
        
        let label;
        if (score > 20) label = 'bullish';
        else if (score < -20) label = 'bearish';
        else label = 'neutral';
        
        return {
          score: Math.round(score),
          label,
          confidence: Math.round(confidence),
          positiveWords: positiveCount,
          negativeWords: negativeCount
        };
      }
    }

    class RealtimeNewsManager {
      constructor() {
        this.newsCache = new Map(); // symbol -> news array
        this.sentimentAnalyzer = new SentimentAnalyzer();
        this.subscribers = new Map(); // symbol -> [callbacks]
        this.pollIntervals = new Map(); // symbol -> interval ID
        this.updateFrequency = 300000; // 5 minutes
      }

      // Heuristic: boost analyst rating / price-target update headlines.
      // Used to rank the top N articles so the user sees more analyst updates.
      getAnalystUpdateScore(article, symbol) {
        const title = (article?.title || '').toString();
        const description = (article?.description || '').toString();
        const text = `${title} ${description}`.toLowerCase();

        if (!text.trim()) return 0;

        let score = 0;
        const sym = (symbol || '').toLowerCase();
        if (sym && text.includes(sym)) score += 3;

        // Price target / rating language
        if (/(price\s*target|target\s*price|price\s*objective|pt\b|\bpt\s*(raised|cut|increase|decrease)|\btarget\s*(raised|cut)|raises?\s+(its\s+)?price\s*target|lowers?\s+(its\s+)?price\s*target|sets?\s+price\s*target)/i.test(text)) {
          score += 40;
        }
        if (/(upgrade|downgrade|initiates?|initiation|reiterates?|maintains?|resumes?\s+coverage|coverage\s+initiated|raises?|lowers?|cuts?|boosts?)\b/i.test(text)) {
          score += 22;
        }
        if (/(rating|rated|buy|sell|hold|overweight|underweight|outperform|underperform|equal\s*weight|market\s*perform|sector\s*perform|neutral|strong\s*buy|strong\s*sell)\b/i.test(text)) {
          score += 18;
        }
        if (/\banalyst(s)?\b/i.test(text)) score += 12;

        // Often appears in analyst updates
        if (/\b(to|from)\s+\$?\d+(?:\.\d+)?\b/i.test(text)) score += 8;
        if (/\$\d{2,}(?:\.\d+)?\b/.test(text)) score += 4;

        // Major broker names (light signal)
        if (/(goldman|morgan\s*stanley|jp\s*morgan|jpmorgan|barclays|bofa|bank\s*of\s*america|citi|citigroup|deutsche\s*bank|ubs|wells\s*fargo|jefferies|raymond\s*james|piper\s*sandler|baird|susquehanna|wedbush|needham|oppenheimer|bernstein)\b/i.test(text)) {
          score += 6;
        }

        return score;
      }
      
      async fetchNews(symbol, limit = 10) {
        try {
          console.log(`ğŸ“° Fetching news for ${symbol}...`);
          
          // Use multiple news sources for comprehensive coverage
          const newsPromises = [
            // Marketaux - Primary news source with sentiment (increased limit)
            fetch(`https://api.marketaux.com/v1/news/all?symbols=${symbol}&filter_entities=true&language=en&limit=50&api_token=${API_KEYS.MARKETAUX}`)
              .then(r => r.ok ? r.json() : { data: [] })
              .catch(() => ({ data: [] })),
              
            // Finnhub News
            fetch(`https://finnhub.io/api/v1/company-news?symbol=${symbol}&from=${this.getDateDaysAgo(7)}&to=${this.getToday()}&token=${API_KEYS.FINNHUB}`)
              .then(r => r.ok ? r.json() : [])
              .catch(() => []),
              
            // FMP Articles (general market news)
            fetch(`https://financialmodelingprep.com/stable/fmp-articles?page=0&limit=20&apikey=${API_KEYS.FMP}`)
              .then(r => r.ok ? r.json() : [])
              .catch(() => []),
              
            // FMP General Latest News
            fetch(`https://financialmodelingprep.com/stable/news/general-latest?page=0&limit=20&apikey=${API_KEYS.FMP}`)
              .then(r => r.ok ? r.json() : [])
              .catch(() => [])
          ];
          
          const [marketauxResponse, finnhubNews, fmpArticles, fmpGeneralNews] = await Promise.all(newsPromises);
          
          const marketauxNews = marketauxResponse?.data || [];
          
          console.log(`ğŸ“Š News sources: Marketaux=${marketauxNews.length}, Finnhub=${finnhubNews?.length || 0}, FMP Articles=${fmpArticles?.length || 0}, FMP General=${fmpGeneralNews?.length || 0}`);
          
          // Combine and normalize news from all sources
          let allNews = [];
          
          // Process Marketaux news (primary source with built-in sentiment)
          marketauxNews.forEach(item => {
            allNews.push({
              title: item.title,
              description: item.description || item.snippet || '',
              url: item.url,
              source: item.source || 'Marketaux',
              publishedAt: item.published_at,
              image: item.image_url,
              symbol: symbol,
              entities: item.entities || []
            });
          });
          
          // Process FMP Articles (filter by symbol relevance)
          (fmpArticles || []).forEach(item => {
            const text = (item.title + ' ' + (item.text || '')).toLowerCase();
            if (text.includes(symbol.toLowerCase())) {
              allNews.push({
                title: item.title,
                description: item.text || item.content || '',
                url: item.url,
                source: item.site || 'FMP',
                publishedAt: item.publishedDate || item.date,
                image: item.image,
                symbol: symbol
              });
            }
          });
          
          // Process FMP General News (filter by symbol relevance)
          (fmpGeneralNews || []).forEach(item => {
            const text = (item.title + ' ' + (item.text || '')).toLowerCase();
            if (text.includes(symbol.toLowerCase())) {
              allNews.push({
                title: item.title,
                description: item.text || item.content || '',
                url: item.url,
                source: item.site || 'MarketNews',
                publishedAt: item.publishedDate || item.date,
                image: item.image,
                symbol: symbol
              });
            }
          });
          
          // Process Finnhub news
          (finnhubNews || []).forEach(item => {
            allNews.push({
              title: item.headline,
              description: item.summary || '',
              url: item.url,
              source: item.source || 'Finnhub',
              publishedAt: new Date(item.datetime * 1000).toISOString(),
              image: item.image,
              symbol: symbol
            });
          });
          
          // Remove duplicates by URL
          const uniqueNews = allNews.filter((news, index, self) => 
            index === self.findIndex(n => n.url === news.url)
          );

          // Keep only articles from the last 30 days
          const cutoff = Date.now() - (30 * 24 * 60 * 60 * 1000);
          const recentNews = uniqueNews.filter(n => {
            const t = new Date(n.publishedAt).getTime();
            return Number.isFinite(t) && t >= cutoff;
          });

          // Sort by analyst-update relevance first, then recency
          recentNews.sort((a, b) => {
            const scoreB = this.getAnalystUpdateScore(b, symbol);
            const scoreA = this.getAnalystUpdateScore(a, symbol);
            if (scoreB !== scoreA) return scoreB - scoreA;
            return new Date(b.publishedAt) - new Date(a.publishedAt);
          });
          
          // Analyze sentiment for each article
          const newsWithSentiment = recentNews.slice(0, limit).map(article => {
            const sentiment = this.sentimentAnalyzer.analyzeSentiment(
              article.title + ' ' + article.description
            );
            
            return {
              ...article,
              sentiment,
              analystScore: this.getAnalystUpdateScore(article, symbol),
              timestamp: new Date(article.publishedAt).getTime()
            };
          });
          
          console.log(`âœ… Fetched ${newsWithSentiment.length} news articles for ${symbol}`);
          
          // Update cache
          this.newsCache.set(symbol, newsWithSentiment);
          
          // Notify subscribers
          this.notifySubscribers(symbol, newsWithSentiment);
          
          return newsWithSentiment;
          
        } catch (error) {
          console.error(`âŒ Error fetching news for ${symbol}:`, error);
          return [];
        }
      }
      
      getDateDaysAgo(days) {
        const date = new Date();
        date.setDate(date.getDate() - days);
        return date.toISOString().split('T')[0];
      }
      
      getToday() {
        return new Date().toISOString().split('T')[0];
      }
      
      subscribe(symbol, callback) {
        if (!this.subscribers.has(symbol)) {
          this.subscribers.set(symbol, []);
          
          // Start polling for this symbol
          this.startPolling(symbol);
        }
        
        this.subscribers.get(symbol).push(callback);
        
        // Send cached news immediately if available
        const cached = this.newsCache.get(symbol);
        if (cached) {
          callback(cached);
        } else {
          // Fetch initial news
          this.fetchNews(symbol);
        }
        
        console.log(`ğŸ“° Subscribed to news for ${symbol}`);
      }
      
      unsubscribe(symbol, callback) {
        const callbacks = this.subscribers.get(symbol);
        if (!callbacks) return;
        
        const index = callbacks.indexOf(callback);
        if (index > -1) {
          callbacks.splice(index, 1);
        }
        
        // Stop polling if no more subscribers
        if (callbacks.length === 0) {
          this.stopPolling(symbol);
          this.subscribers.delete(symbol);
        }
        
        console.log(`ğŸ“° Unsubscribed from news for ${symbol}`);
      }
      
      startPolling(symbol) {
        if (this.pollIntervals.has(symbol)) return;
        
        const intervalId = setInterval(() => {
          this.fetchNews(symbol);
        }, this.updateFrequency);
        
        this.pollIntervals.set(symbol, intervalId);
        console.log(`ğŸ“° Started news polling for ${symbol} (every ${this.updateFrequency/1000/60} min)`);
      }
      
      stopPolling(symbol) {
        const intervalId = this.pollIntervals.get(symbol);
        if (intervalId) {
          clearInterval(intervalId);
          this.pollIntervals.delete(symbol);
          console.log(`ğŸ“° Stopped news polling for ${symbol}`);
        }
      }
      
      notifySubscribers(symbol, news) {
        const callbacks = this.subscribers.get(symbol);
        if (callbacks) {
          callbacks.forEach(cb => {
            try {
              cb(news);
            } catch (err) {
              console.error(`Error in news callback for ${symbol}:`, err);
            }
          });
        }
      }
      
      getAggregateSentiment(symbol) {
        const news = this.newsCache.get(symbol);
        if (!news || news.length === 0) {
          return { score: 0, label: 'neutral', count: 0 };
        }
        
        const totalScore = news.reduce((sum, article) => sum + article.sentiment.score, 0);
        const avgScore = totalScore / news.length;
        
        let label;
        if (avgScore > 20) label = 'bullish';
        else if (avgScore < -20) label = 'bearish';
        else label = 'neutral';
        
        return {
          score: Math.round(avgScore),
          label,
          count: news.length,
          bullishCount: news.filter(n => n.sentiment.label === 'bullish').length,
          bearishCount: news.filter(n => n.sentiment.label === 'bearish').length,
          neutralCount: news.filter(n => n.sentiment.label === 'neutral').length
        };
      }
      
      stopAll() {
        this.pollIntervals.forEach(id => clearInterval(id));
        this.pollIntervals.clear();
        this.subscribers.clear();
        console.log('ğŸ“° Stopped all news polling');
      }
    }

    // Initialize news manager
    const newsManager = new RealtimeNewsManager();
    window.newsManager = newsManager;
    console.log('âœ… News Manager initialized');

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PORTFOLIO TRACKER & P&L CALCULATOR
    // Cost: FREE - Stores locally in browser
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    class PortfolioManager {
      constructor() {
        this.holdings = this.loadPortfolio();
        this.priceCache = new Map(); // symbol -> current price
      }

      loadPortfolio() {
        try {
          const saved = localStorage.getItem('retailedge_portfolio');
          return saved ? JSON.parse(saved) : [];
        } catch (error) {
          console.error('âŒ Error loading portfolio:', error);
          return [];
        }
      }

      savePortfolio() {
        try {
          localStorage.setItem('retailedge_portfolio', JSON.stringify(this.holdings));
          console.log('ğŸ’¾ Portfolio saved');
        } catch (error) {
          console.error('âŒ Error saving portfolio:', error);
        }
      }

      addHolding(symbol, quantity, buyPrice, buyDate = new Date().toISOString()) {
        const holding = {
          id: Date.now() + Math.random(),
          symbol: symbol.toUpperCase(),
          quantity: parseFloat(quantity),
          buyPrice: parseFloat(buyPrice),
          buyDate: buyDate,
          addedAt: new Date().toISOString()
        };

        this.holdings.push(holding);
        this.savePortfolio();
        console.log(`âœ… Added ${quantity} shares of ${symbol} @ $${buyPrice}`);
        return holding;
      }

      updateHolding(id, updates) {
        const index = this.holdings.findIndex(h => h.id === id);
        if (index !== -1) {
          this.holdings[index] = { ...this.holdings[index], ...updates };
          this.savePortfolio();
          console.log(`âœ… Updated holding ${id}`);
          return this.holdings[index];
        }
        return null;
      }

      removeHolding(id) {
        const index = this.holdings.findIndex(h => h.id === id);
        if (index !== -1) {
          const removed = this.holdings.splice(index, 1)[0];
          this.savePortfolio();
          console.log(`âœ… Removed ${removed.symbol} from portfolio`);
          return removed;
        }
        return null;
      }

      async updatePrices(stocksData) {
        // Update current prices from stock data
        stocksData.forEach(stock => {
          this.priceCache.set(stock.symbol, stock.price);
        });
      }

      calculatePortfolioMetrics(stocksData) {
        if (this.holdings.length === 0) {
          return {
            totalValue: 0,
            totalCost: 0,
            totalGainLoss: 0,
            totalGainLossPercent: 0,
            holdings: []
          };
        }

        // Update prices
        this.updatePrices(stocksData);

        let totalValue = 0;
        let totalCost = 0;

        const holdingsWithMetrics = this.holdings.map(holding => {
          const currentPrice = this.priceCache.get(holding.symbol) || holding.buyPrice;
          const stockData = stocksData.find(s => s.symbol === holding.symbol);
          
          const costBasis = holding.quantity * holding.buyPrice;
          const currentValue = holding.quantity * currentPrice;
          const gainLoss = currentValue - costBasis;
          const gainLossPercent = ((currentPrice - holding.buyPrice) / holding.buyPrice) * 100;

          totalValue += currentValue;
          totalCost += costBasis;

          return {
            ...holding,
            currentPrice,
            costBasis,
            currentValue,
            gainLoss,
            gainLossPercent,
            dayChange: stockData?.changePct || 0,
            dayChangeValue: stockData ? (currentPrice * (stockData.changePct / 100) * holding.quantity) : 0
          };
        });

        const totalGainLoss = totalValue - totalCost;
        const totalGainLossPercent = totalCost > 0 ? (totalGainLoss / totalCost) * 100 : 0;

        return {
          totalValue,
          totalCost,
          totalGainLoss,
          totalGainLossPercent,
          holdings: holdingsWithMetrics,
          holdingsCount: this.holdings.length
        };
      }

      getTopPerformers(metrics, limit = 3) {
        return [...metrics.holdings]
          .sort((a, b) => b.gainLossPercent - a.gainLossPercent)
          .slice(0, limit);
      }

      getWorstPerformers(metrics, limit = 3) {
        return [...metrics.holdings]
          .sort((a, b) => a.gainLossPercent - b.gainLossPercent)
          .slice(0, limit);
      }

      exportToCSV() {
        if (this.holdings.length === 0) return null;
        
        const headers = ['Symbol', 'Quantity', 'Buy Price', 'Buy Date', 'Current Price', 'Current Value', 'Gain/Loss', 'Gain/Loss %'];
        const metrics = this.calculatePortfolioMetrics([]);
        
        const rows = metrics.holdings.map(h => [
          h.symbol,
          h.quantity,
          h.buyPrice.toFixed(2),
          new Date(h.buyDate).toLocaleDateString(),
          h.currentPrice.toFixed(2),
          h.currentValue.toFixed(2),
          h.gainLoss.toFixed(2),
          h.gainLossPercent.toFixed(2) + '%'
        ]);

        return [headers, ...rows].map(row => row.join(',')).join('\n');
      }
    }

    // Initialize portfolio manager
    const portfolioManager = new PortfolioManager();
    window.portfolioManager = portfolioManager;
    console.log('âœ… Portfolio Manager initialized');

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // CLAUDE AI STOCK PREDICTION ENGINE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    class ClaudeStockAnalyzer {
      constructor() {
        this.analysisCache = new Map();
        this.cacheExpiry = 60 * 60 * 1000; // 1 hour
      }

      async analyzeStock(stockData) {
        const cacheKey = `${stockData.symbol}_${Math.floor(Date.now() / this.cacheExpiry)}`;
        
        if (this.analysisCache.has(cacheKey)) {
          console.log(`âœ… Using cached AI analysis for ${stockData.symbol}`);
          return this.analysisCache.get(cacheKey);
        }

        console.log(`ğŸ¤– Requesting AI analysis for ${stockData.symbol}...`);

        try {
          const analysis = await this.callClaudeAPI(stockData);
          this.analysisCache.set(cacheKey, analysis);
          console.log(`âœ… AI analysis complete for ${stockData.symbol}`);
          return analysis;
        } catch (error) {
          console.error('âŒ AI Analysis failed:', error.message || error);
          console.log('ğŸ”„ Falling back to rule-based analysis...');
          const fallback = this.getFallbackAnalysis(stockData);
          // Cache fallback too (but shorter time)
          this.analysisCache.set(cacheKey, fallback);
          return fallback;
        }
      }

      async callClaudeAPI(stockData) {
        const prompt = this.buildAnalysisPrompt(stockData);

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // âš ï¸ IMPORTANT: REPLACE THE API KEY BELOW WITH YOUR OWN KEY
        // Get your key from: https://console.anthropic.com/settings/keys
        // The key below may be invalid or rate-limited
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        console.log('ğŸ“¡ Making API request to Claude via backend...');
        
        // Call local backend server that securely handles Claude API
        const response = await fetchWithRetry(`${API_BASE_URL}/api/claude`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          timeoutMs: 20000,
          retries: 1,
          body: JSON.stringify({
            messages: [{ role: "user", content: prompt }]
          })
        }).catch(err => {
          console.error('âŒ Failed to connect to backend server:', err);
          console.log('ğŸ’¡ Make sure Node.js backend is running on port 3002');
          throw new Error('Backend server not responding. Please ensure the Node.js server is running.');
        });

        console.log(`ğŸ“Š API Response status: ${response.status}`);

        if (!response.ok) {
          const errorText = await response.text().catch(() => 'Unknown error');
          console.error(`âŒ API Error ${response.status}:`, errorText);
          console.error(`âŒ Full error details:`, {
            status: response.status,
            statusText: response.statusText,
            url: response.url,
            errorBody: errorText
          });
          throw new Error(`API Error: ${response.status} - ${errorText}`);
        }

        const data = await response.json();
        console.log('âœ… API response received, parsing...');
        const analysisText = data.content[0].text;
        return this.parseClaudeResponse(analysisText, stockData);
      }

      buildAnalysisPrompt(stock) {
        return `You are an expert stock analyst. Analyze this stock and provide predictions in JSON format.

STOCK DATA:
Symbol: ${stock.symbol}
Company: ${stock.companyName || stock.symbol}
Current Price: $${stock.price}
Change: ${stock.changesPercentage || 0}%

FUNDAMENTALS:
- P/E Ratio: ${stock.pe || 'N/A'}
- EPS: $${stock.eps || 'N/A'}
- Market Cap: ${this.formatNumber(stock.marketCap)}
- ROE: ${stock.roe || 'N/A'}%

TECHNICAL (if available):
- RSI: ${stock.rsi || 'N/A'}
- SMA 50: ${stock.sma50 || 'N/A'}
- SMA 200: ${stock.sma200 || 'N/A'}

ANALYST:
- Rating: ${stock.rating || 'N/A'}
- Price Target: ${stock.priceTarget || 'N/A'}

Provide analysis in this EXACT JSON format (no markdown):
{
  "predictions": {
    "oneDay": {"price": <number>, "change": <percentage>, "confidence": <0-100>},
    "sevenDay": {"price": <number>, "change": <percentage>, "confidence": <0-100>},
    "thirtyDay": {"price": <number>, "change": <percentage>, "confidence": <0-100>}
  },
  "recommendation": "<BUY|HOLD|SELL>",
  "recommendationStrength": <1-10>,
  "targetPrice": <number>,
  "stopLoss": <number>,
  "keyInsights": ["<insight 1>", "<insight 2>", "<insight 3>"],
  "risks": ["<risk 1>", "<risk 2>"],
  "opportunities": ["<opportunity 1>", "<opportunity 2>"],
  "technicalScore": <0-100>,
  "fundamentalScore": <0-100>,
  "sentimentScore": <0-100>,
  "summary": "<2-3 sentence summary>"
}

Be realistic and conservative. Base confidence on data quality.`;
      }

      parseClaudeResponse(text, stockData) {
        try {
          const jsonText = text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
          const analysis = JSON.parse(jsonText);
          analysis.symbol = stockData.symbol;
          analysis.currentPrice = stockData.price;
          analysis.timestamp = Date.now();
          analysis.aiModel = 'claude-sonnet-4';
          return analysis;
        } catch (error) {
          console.error('âŒ Parse error:', error);
          return this.getFallbackAnalysis(stockData);
        }
      }

      getFallbackAnalysis(stock) {
        const price = stock.price || 0;
        const pe = stock.pe || 0;
        const rsi = stock.rsi || 50;
        
        let recommendation = 'HOLD';
        let strength = 5;
        
        if (pe > 0 && pe < 15 && rsi < 30) {
          recommendation = 'BUY';
          strength = 8;
        } else if (pe > 30 && rsi > 70) {
          recommendation = 'SELL';
          strength = 7;
        }

        return {
          predictions: {
            oneDay: { price: price * 1.001, change: 0.1, confidence: 30 },
            sevenDay: { price: price * 1.005, change: 0.5, confidence: 25 },
            thirtyDay: { price: price * 1.02, change: 2.0, confidence: 20 }
          },
          recommendation,
          recommendationStrength: strength,
          targetPrice: price * 1.10,
          stopLoss: price * 0.95,
          keyInsights: ["AI analysis temporarily unavailable", "Using basic technical analysis"],
          risks: ["Limited analysis due to AI unavailability"],
          opportunities: ["Manual analysis recommended"],
          technicalScore: 50,
          fundamentalScore: 50,
          sentimentScore: 50,
          summary: "AI analysis unavailable. Basic metrics suggest neutral stance. Manual review recommended.",
          symbol: stock.symbol,
          currentPrice: price,
          timestamp: Date.now(),
          aiModel: 'fallback'
        };
      }

      formatNumber(num) {
        if (!num) return 'N/A';
        if (num >= 1e12) return (num / 1e12).toFixed(2) + 'T';
        if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
        if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
        return num.toLocaleString();
      }
    }

    const aiAnalyzer = new ClaudeStockAnalyzer();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ERROR BOUNDARY COMPONENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    class ErrorBoundary extends React.Component {
      constructor(props) {
        super(props);
        this.state = { hasError: false, error: null };
      }
      
      static getDerivedStateFromError(error) {
        return { hasError: true, error };
      }
      
      componentDidCatch(error, errorInfo) {
        console.error('ErrorBoundary caught error:', error, errorInfo);
      }
      
      render() {
        if (this.state.hasError) {
          return (
            <div className="min-h-screen flex items-center justify-center p-6">
              <div className="glass-elevated rounded-2xl p-8 max-w-md text-center">
                <div className="text-4xl mb-4 text-red-400">âš ï¸</div>
                <h3 className="text-xl font-bold text-white mb-3">Something went wrong</h3>
                <p className="text-slate-400 mb-6">We encountered an error while loading this component.</p>
                <button 
                  onClick={() => window.location.reload()}
                  className="px-6 py-3 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg font-semibold"
                >
                  Reload Application
                </button>
              </div>
            </div>
          );
        }
        
        return this.props.children;
      }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AI SCORING ENGINE (DETERMINISTIC)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const clamp = (n, min, max) => Math.max(min, Math.min(max, n));
    const num = (v, d = 0) => {
      const x = typeof v === "number" ? v : parseFloat(v);
      return Number.isFinite(x) ? x : d;
    };

    // Compute unified AI score (0-100) from stock fundamentals + technicals
    function computeAIScore(stock) {
      // Extract metrics safely with defaults
      const pe = num(stock.pe, 0);
      const roe = num(stock.roe, 0);
      const rsi = num(stock.rsi, 50);
      const changePct = num(stock.changePct, 0);
      const marketCap = num(stock.marketCap, 0);

      // --- FUNDAMENTALS SUBSCORE (0-100) ---
      let fundamental = 50; // Start neutral

      // P/E: Lower is better (value), but 0 is invalid
      if (pe > 0) {
        if (pe < 15) fundamental += 20;
        else if (pe < 20) fundamental += 12;
        else if (pe < 25) fundamental += 5;
        else if (pe > 40) fundamental -= 15;
        else if (pe > 30) fundamental -= 8;
      }

      // ROE: Higher is better (quality)
      if (roe > 25) fundamental += 20;
      else if (roe > 20) fundamental += 15;
      else if (roe > 15) fundamental += 10;
      else if (roe > 10) fundamental += 5;
      else if (roe < 5) fundamental -= 10;

      // Market Cap: Prefer established companies for stability
      if (marketCap > 10e9) fundamental += 8; // Large cap bonus
      else if (marketCap < 1e9) fundamental -= 5; // Small cap penalty

      fundamental = clamp(fundamental, 0, 100);

      // --- TECHNICALS SUBSCORE (0-100) ---
      let technical = 50; // Start neutral

      // RSI: Sweet spot is 35-65, avoid extremes
      if (rsi >= 35 && rsi <= 65) technical += 15; // Healthy range
      else if (rsi < 30) technical += 10; // Oversold opportunity
      else if (rsi > 70) technical -= 12; // Overbought risk

      // Momentum: Recent price change
      if (changePct > 5) technical += 12; // Strong uptrend
      else if (changePct > 2) technical += 6; // Positive momentum
      else if (changePct < -5) technical -= 10; // Downtrend
      else if (changePct < -2) technical -= 5; // Weak

      technical = clamp(technical, 0, 100);

      // --- RISK SUBSCORE (0-100, higher = more risk) ---
      let risk = 50; // Start neutral

      // High P/E = valuation risk
      if (pe > 40) risk += 15;
      else if (pe > 30) risk += 8;

      // Extreme RSI = volatility risk
      if (rsi > 75 || rsi < 25) risk += 10;

      // Recent sharp decline = momentum risk
      if (changePct < -10) risk += 12;

      risk = clamp(risk, 0, 100);

      // --- COMBINE INTO FINAL SCORE (0-100) ---
      // Weights: Fundamentals 55%, Technicals 35%, Risk penalty 10%
      const rawScore = (0.55 * fundamental) + (0.35 * technical) + (0.10 * (100 - risk));
      const score = clamp(Math.round(rawScore), 0, 100);

      return { 
        score, 
        subscores: { fundamental, technical, risk } 
      };
    }

    // Determine verdict from score
    function verdictFromScore(score) {
      if (score >= 80) return { verdict: "STRONG BUY", stance: "bullish" };
      if (score >= 67) return { verdict: "BUY", stance: "bullish" };
      if (score >= 55) return { verdict: "HOLD", stance: "neutral" };
      if (score >= 45) return { verdict: "REDUCE", stance: "bearish" };
      return { verdict: "SELL", stance: "bearish" };
    }

    // Calculate confidence from score (deterministic)
    function confidenceFromScore(score, subscores) {
      // Base confidence increases with distance from 50 (neutral)
      const base = 40 + Math.abs(score - 50) * 1.1; // Range: 40-95
      
      // Penalty for high risk
      const riskPenalty = (subscores?.risk ?? 50) * 0.15; // 0-15 penalty
      
      const confidence = clamp(Math.round(base - riskPenalty), 35, 92);
      return confidence;
    }

    // Generate complete AI analysis with factors
    function generateAIAnalysis(stock) {
      const { score, subscores } = computeAIScore(stock);
      const { verdict, stance } = verdictFromScore(score);
      const confidence = confidenceFromScore(score, subscores);

      const bullFactors = [];
      const bearFactors = [];

      // Extract metrics
      const pe = num(stock.pe, 0);
      const roe = num(stock.roe, 0);
      const rsi = num(stock.rsi, 50);
      const changePct = num(stock.changePct, 0);
      const price = num(stock.price, 0);

      // Helper: importance ranking for factor sorting
      const importanceRank = { high: 3, medium: 2, low: 1 };

      // BULLISH FACTORS
      if (pe > 0 && pe < 15) {
        bullFactors.push({
          factor: "Attractive Valuation",
          detail: `P/E ratio of ${pe.toFixed(1)} suggests undervaluation vs. market average.`,
          importance: "high",
          category: "fundamental"
        });
      }

      if (roe > 20) {
        bullFactors.push({
          factor: "Superior Capital Efficiency",
          detail: `ROE of ${roe.toFixed(1)}% demonstrates exceptional profitability.`,
          importance: "high",
          category: "fundamental"
        });
      }

      if (rsi < 35) {
        bullFactors.push({
          factor: "Oversold Technical Setup",
          detail: `RSI of ${rsi.toFixed(0)} indicates potential mean reversion opportunity.`,
          importance: "medium",
          category: "technical"
        });
      }

      if (changePct > 5) {
        bullFactors.push({
          factor: "Strong Momentum",
          detail: `Recent price gain of ${changePct.toFixed(1)}% shows buying pressure.`,
          importance: "medium",
          category: "technical"
        });
      }

      if (pe > 0 && pe < 20 && roe > 15) {
        bullFactors.push({
          factor: "Value-Quality Combination",
          detail: `Reasonable valuation (P/E ${pe.toFixed(1)}) paired with strong returns (ROE ${roe.toFixed(1)}%).`,
          importance: "high",
          category: "fundamental"
        });
      }

      // BEARISH FACTORS
      if (pe > 35) {
        bearFactors.push({
          factor: "Premium Valuation Risk",
          detail: `P/E ratio of ${pe.toFixed(1)} leaves little margin for safety.`,
          importance: "high",
          category: "fundamental"
        });
      }

      if (roe < 8 && roe > 0) {
        bearFactors.push({
          factor: "Below-Average Returns",
          detail: `ROE of ${roe.toFixed(1)}% suggests weak capital efficiency.`,
          importance: "medium",
          category: "fundamental"
        });
      }

      if (rsi > 72) {
        bearFactors.push({
          factor: "Overbought Condition",
          detail: `RSI of ${rsi.toFixed(0)} increases probability of near-term pullback.`,
          importance: "medium",
          category: "technical"
        });
      }

      if (changePct < -5) {
        bearFactors.push({
          factor: "Negative Momentum",
          detail: `Recent decline of ${changePct.toFixed(1)}% signals selling pressure.`,
          importance: "medium",
          category: "technical"
        });
      }

      // Ensure at least one factor each
      if (!bullFactors.length) {
        bullFactors.push({
          factor: "No Major Red Flags",
          detail: "Fundamental and technical signals are generally supportive.",
          importance: "low",
          category: "fundamental"
        });
      }

      if (!bearFactors.length) {
        bearFactors.push({
          factor: "Normal Risk Profile",
          detail: "Risks appear within typical range for this asset.",
          importance: "low",
          category: "fundamental"
        });
      }

      // Executive Summary
      const execSummary = `${stock.symbol} scores ${score}/100 with ${verdict} rating (${confidence}% confidence). Fundamentals: ${Math.round(subscores.fundamental)}/100, Technicals: ${Math.round(subscores.technical)}/100, Risk: ${Math.round(subscores.risk)}/100.`;

      // â”€â”€ Score drivers (teaching layer) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const sortedBull = [...bullFactors].sort((a,b) => (importanceRank[b.importance]||0) - (importanceRank[a.importance]||0));
      const sortedBear = [...bearFactors].sort((a,b) => (importanceRank[b.importance]||0) - (importanceRank[a.importance]||0));
      const topDrivers = {
        positive: sortedBull.slice(0, 2),
        negative: sortedBear.slice(0, 2),
      };

      // â”€â”€ Reassurance / emotional safety cue â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      let reassurance = "Nothing here suggests unusual urgency â€” use this as a starting point and sanity-check with your own research.";
      if ((subscores?.risk ?? 50) >= 70) reassurance = "Risk signals look elevated â€” size your exposure carefully and double-check the bear cases before acting.";
      else if (confidence <= 45) reassurance = "Signals are mixed (low alignment) â€” it's normal to place this on a watchlist and wait for clarity.";

      // â”€â”€ AI Takeaway (interpretive closure) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const valuationFlag = pe > 35 ? "valuation looks stretched" : (pe > 0 && pe < 15 ? "valuation looks supportive" : "valuation looks mixed");
      const timingFlag = rsi > 72 ? "short-term timing looks stretched" : (rsi < 35 ? "short-term timing may be favorable" : "timing looks neutral");
      const qualityFlag = roe > 20 ? "business quality looks strong" : (roe > 0 && roe < 8 ? "quality looks weaker than average" : "quality looks mixed");

      let takeaway = "";
      if (verdict === "STRONG BUY" || verdict === "BUY") {
        takeaway = `Overall, the balance of signals leans constructive: ${qualityFlag}, ${valuationFlag}, and ${timingFlag}. This looks more suitable for patient investors than for quick trades.`;
      } else if (verdict === "HOLD") {
        takeaway = `Overall, signals are mixed: ${qualityFlag} with ${valuationFlag} and ${timingFlag}. This is a reasonable watchlist candidate while you wait for a better price, clearer trend, or new fundamentals.`;
      } else {
        takeaway = `Overall, the risk/reward looks less attractive right now: ${qualityFlag} with ${valuationFlag} and ${timingFlag}. Consider treating this as "research further" unless your thesis is very strong.`;
      }

      // â”€â”€ Watchlist guidance (what to monitor next) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const watchMetric = (sortedBear[0]?.category === "technical" || rsi > 70 || rsi < 30) ? "trend/RSI and price action" :
                          (sortedBear[0]?.category === "fundamental" || pe > 30) ? "earnings + valuation (P/E) and margins" :
                          "ROE/margins and revenue growth";
      const lastEarningsDate = stock?.lastEarnings?.date || stock?.lastEarnings?.fiscalDateEnding || null;

      const watchlistGuidance = {
        headline: "What to watch next",
        items: [
          { label: "Next check-in", value: lastEarningsDate ? `Review after the next earnings cycle (last reported: ${lastEarningsDate}).` : "Review after the next earnings cycle." },
          { label: "Key metric", value: watchMetric },
          { label: "Main risk to monitor", value: (sortedBear[0]?.factor ? sortedBear[0].factor : "unexpected earnings / guidance changes") }
        ]
      };

      return {
        verdict,
        confidence,
        stance,
        execSummary,
        bullFactors,
        bearFactors,
        topDrivers,
        reassurance,
        takeaway,
        watchlistGuidance,
        subscores,
        aiScore: score, // Unified 0-100 scale
        health: score, // Health = AI score for consistency
      };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // EXPLAINABLE AI (rule-level contributions + sensitivity)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function explainDeterministicAIScore(stock) {
      const pe = num(stock.pe, 0);
      const roe = num(stock.roe, 0);
      const rsi = num(stock.rsi, 50);
      const changePct = num(stock.changePct, 0);
      const marketCap = num(stock.marketCap, 0);

      const weights = { fundamental: 0.55, technical: 0.35, risk: 0.10 };
      const contributions = [];
      const add = (bucket, label, delta, detail) => {
        if (!delta) return;
        contributions.push({ bucket, label, delta, detail });
      };

      // FUNDAMENTALS
      let fundamental = 50;
      if (pe > 0) {
        if (pe < 15) { fundamental += 20; add('fundamental', 'Attractive P/E', +20, `P/E ${pe.toFixed(1)} < 15`); }
        else if (pe < 20) { fundamental += 12; add('fundamental', 'Reasonable P/E', +12, `P/E ${pe.toFixed(1)} < 20`); }
        else if (pe < 25) { fundamental += 5; add('fundamental', 'Fair P/E', +5, `P/E ${pe.toFixed(1)} < 25`); }
        else if (pe > 40) { fundamental -= 15; add('fundamental', 'Expensive P/E', -15, `P/E ${pe.toFixed(1)} > 40`); }
        else if (pe > 30) { fundamental -= 8; add('fundamental', 'High P/E', -8, `P/E ${pe.toFixed(1)} > 30`); }
      }

      if (roe > 25) { fundamental += 20; add('fundamental', 'Excellent ROE', +20, `ROE ${roe.toFixed(1)}% > 25%`); }
      else if (roe > 20) { fundamental += 15; add('fundamental', 'Strong ROE', +15, `ROE ${roe.toFixed(1)}% > 20%`); }
      else if (roe > 15) { fundamental += 10; add('fundamental', 'Good ROE', +10, `ROE ${roe.toFixed(1)}% > 15%`); }
      else if (roe > 10) { fundamental += 5; add('fundamental', 'Decent ROE', +5, `ROE ${roe.toFixed(1)}% > 10%`); }
      else if (roe < 5) { fundamental -= 10; add('fundamental', 'Weak ROE', -10, `ROE ${roe.toFixed(1)}% < 5%`); }

      if (marketCap > 10e9) { fundamental += 8; add('fundamental', 'Large-cap stability', +8, `Market cap > $10B`); }
      else if (marketCap > 0 && marketCap < 1e9) { fundamental -= 5; add('fundamental', 'Small-cap risk', -5, `Market cap < $1B`); }

      fundamental = clamp(fundamental, 0, 100);

      // TECHNICALS
      let technical = 50;
      if (rsi >= 35 && rsi <= 65) { technical += 15; add('technical', 'Healthy RSI', +15, `RSI ${rsi.toFixed(0)} in 35â€“65`); }
      else if (rsi < 30) { technical += 10; add('technical', 'Oversold setup', +10, `RSI ${rsi.toFixed(0)} < 30`); }
      else if (rsi > 70) { technical -= 12; add('technical', 'Overbought risk', -12, `RSI ${rsi.toFixed(0)} > 70`); }

      if (changePct > 5) { technical += 12; add('technical', 'Strong momentum', +12, `${changePct.toFixed(1)}% daily move > +5%`); }
      else if (changePct > 2) { technical += 6; add('technical', 'Positive momentum', +6, `${changePct.toFixed(1)}% daily move > +2%`); }
      else if (changePct < -5) { technical -= 10; add('technical', 'Downtrend', -10, `${changePct.toFixed(1)}% daily move < -5%`); }
      else if (changePct < -2) { technical -= 5; add('technical', 'Weak tape', -5, `${changePct.toFixed(1)}% daily move < -2%`); }

      technical = clamp(technical, 0, 100);

      // RISK (higher = worse)
      let risk = 50;
      if (pe > 40) { risk += 15; add('risk', 'Valuation risk', +15, `P/E ${pe.toFixed(1)} > 40`); }
      else if (pe > 30) { risk += 8; add('risk', 'Valuation risk', +8, `P/E ${pe.toFixed(1)} > 30`); }

      if (rsi > 75 || rsi < 25) { risk += 10; add('risk', 'Extreme RSI risk', +10, `RSI ${rsi.toFixed(0)} outside 25â€“75`); }
      if (changePct < -10) { risk += 12; add('risk', 'Sharp drawdown risk', +12, `${changePct.toFixed(1)}% daily move < -10%`); }

      risk = clamp(risk, 0, 100);

      const rawScore = (weights.fundamental * fundamental) + (weights.technical * technical) + (weights.risk * (100 - risk));
      const score = clamp(Math.round(rawScore), 0, 100);

      const impacts = contributions.map(c => {
        let impact = 0;
        if (c.bucket === 'fundamental') impact = weights.fundamental * c.delta;
        else if (c.bucket === 'technical') impact = weights.technical * c.delta;
        else if (c.bucket === 'risk') impact = -weights.risk * c.delta;
        return { ...c, impact: Math.round(impact * 10) / 10 };
      }).sort((a, b) => Math.abs(b.impact) - Math.abs(a.impact));

      return {
        score,
        subscores: { fundamental, technical, risk },
        weights,
        impacts,
        topImpacts: impacts.slice(0, 6)
      };
    }

    function aiExplainThresholds(score) {
      const bands = [80, 67, 55, 45, 0];
      const labels = ['STRONG BUY', 'BUY', 'HOLD', 'REDUCE', 'SELL'];
      let idx = labels.length - 1;
      for (let i = 0; i < bands.length; i++) {
        if (score >= bands[i]) { idx = i; break; }
      }
      const current = labels[idx];
      const nextUpScore = idx > 0 ? bands[idx - 1] : null;
      const nextDownScore = idx < labels.length - 1 ? bands[idx + 1] : null;
      return {
        current,
        nextUpScore,
        nextDownScore,
        toNextUp: nextUpScore != null ? Math.max(0, nextUpScore - score) : 0,
        toNextDown: nextDownScore != null ? Math.max(0, score - nextDownScore) : 0,
      };
    }

    function aiSensitivitySuggestions(stock) {
      const base = explainDeterministicAIScore(stock);
      const suggestions = [];

      const addSuggestion = (title, overrides, note) => {
        const alt = explainDeterministicAIScore({ ...stock, ...overrides });
        const delta = alt.score - base.score;
        if (!Number.isFinite(delta) || Math.abs(delta) < 1) return;
        suggestions.push({ title, delta, newScore: alt.score, note });
      };

      const pe = num(stock.pe, 0);
      if (pe > 40) addSuggestion('If valuation cools (P/E < 40)', { pe: 39.9 }, 'Reduces valuation risk penalty and improves the P/E bucket.');
      else if (pe > 30) addSuggestion('If valuation cools (P/E < 30)', { pe: 29.9 }, 'Improves fundamentals and reduces the risk bucket.');
      else if (pe >= 25) addSuggestion('If P/E improves (< 25)', { pe: 24.9 }, 'Moves into a more favorable valuation bucket.');
      else if (pe >= 20) addSuggestion('If P/E improves (< 20)', { pe: 19.9 }, 'Moves into a stronger valuation bucket.');
      else if (pe >= 15) addSuggestion('If P/E improves (< 15)', { pe: 14.9 }, 'Moves into the strongest valuation bucket.');

      const roe = num(stock.roe, 0);
      if (roe < 5) addSuggestion('If ROE reaches 10%', { roe: 10.1 }, 'Crosses the 10% profitability threshold.');
      else if (roe < 10) addSuggestion('If ROE reaches 15%', { roe: 15.1 }, 'Crosses the 15% profitability threshold.');
      else if (roe < 15) addSuggestion('If ROE reaches 20%', { roe: 20.1 }, 'Crosses the 20% profitability threshold.');
      else if (roe < 20) addSuggestion('If ROE reaches 25%', { roe: 25.1 }, 'Crosses the 25% profitability threshold.');

      const rsi = num(stock.rsi, 50);
      if (!(rsi >= 35 && rsi <= 65)) addSuggestion('If RSI returns to 35â€“65', { rsi: 50 }, 'Moves into the â€œhealthy RSIâ€ band used by the model.');
      if (rsi > 75 || rsi < 25) addSuggestion('If RSI normalizes inside 25â€“75', { rsi: clamp(rsi, 25, 75) }, 'Removes the â€œextreme RSIâ€ risk penalty.');

      const changePct = num(stock.changePct, 0);
      if (changePct < -10) addSuggestion('If drawdown eases above -10%', { changePct: -9.9 }, 'Removes the â€œsharp drawdownâ€ risk penalty.');
      if (changePct < 2) addSuggestion('If momentum improves above +2%', { changePct: 2.1 }, 'Moves into the positive momentum bucket.');

      const marketCap = num(stock.marketCap, 0);
      if (marketCap > 0 && marketCap < 1e9) addSuggestion('If market cap re-rates above $1B', { marketCap: 1e9 }, 'Removes the small-cap penalty.');

      return suggestions.sort((a, b) => Math.abs(b.delta) - Math.abs(a.delta)).slice(0, 4);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UI COMPONENTS - Delay Badge, Footer, Paywall
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function DelayBadge() {
      const [open, setOpen] = useState(false);
      return (
        <div className="relative inline-block">
          <button 
            onClick={() => setOpen(p => !p)} 
            className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-yellow-500/10 border border-yellow-500/30 text-yellow-300 text-xs font-semibold uppercase tracking-wide cursor-pointer hover:bg-yellow-500/20 transition"
          >
            <i className="fas fa-clock"></i>
            Delayed 15 min
          </button>
          {open && (
            <div className="absolute right-0 top-full mt-2 glass-card p-4 rounded-lg w-72 text-xs text-slate-300 z-50 shadow-2xl border border-slate-700">
              <div className="flex items-start gap-2 mb-2">
                <i className="fas fa-info-circle text-yellow-400 mt-0.5"></i>
                <div>
                  <div className="font-semibold text-white mb-1">Data Delay Notice</div>
                  <div className="text-slate-400 leading-relaxed">
                    US stock exchanges provide data with a 15-minute delay for free tiers. 
                    Additional sources: Financial Modeling Prep, Finnhub, EOD Historical Data.
                  </div>
                </div>
              </div>
              <div className="mt-3 pt-3 border-t border-slate-700 text-xs text-slate-500">
                Not investment advice. Always consult a licensed financial adviser.
              </div>
              <button 
                onClick={() => setOpen(false)}
                className="mt-2 w-full py-1.5 bg-slate-700 hover:bg-slate-600 text-white rounded text-xs font-medium transition"
              >
                Got it
              </button>
            </div>
          )}
        </div>
      );
    }

    function Footer() {
      return (
        <footer className="mt-8 px-6 py-4 glass rounded-2xl">
          <div className="flex items-center justify-between text-xs text-slate-500">
            <div className="flex items-center gap-4">
              <span>Â© 2026 RetailEdge Pro</span>
              <span className="text-slate-700">â€¢</span>
              <span>Data delayed 15 min</span>
              <span className="text-slate-700">â€¢</span>
              <span>Not investment advice</span>
            </div>
            <div className="flex items-center gap-3">
              <a href="#" className="hover:text-cyan-400 transition">Terms</a>
              <span className="text-slate-700">â€¢</span>
              <a href="#" className="hover:text-cyan-400 transition">Privacy</a>
              <span className="text-slate-700">â€¢</span>
              <a href="#" className="hover:text-cyan-400 transition">Support</a>
            </div>
          </div>
          <div className="mt-2 text-[10px] text-slate-600 text-center">
            Please consult a licensed financial adviser before making investment decisions.
          </div>
        </footer>
      );
    }

    function PaywallCard({ feature, description }) {
      const { tier } = usePremium();
      
      const upgrade = () => {
        // Show upgrade modal or redirect to pricing
        alert(`Upgrade to Premium to unlock ${feature}!\n\nCurrent tier: ${tier}\n\nPremium features:\nâ€¢ Unlimited watchlist\nâ€¢ Advanced analytics\nâ€¢ Real-time alerts\nâ€¢ Portfolio tracking\nâ€¢ And more!`);
        
        // In production, integrate with Stripe:
        // const stripe = window.Stripe(STRIPE_PUBLIC_KEY);
        // stripe.redirectToCheckout({ sessionId: ... });
      };

      return (
        <div className="glass-card p-6 rounded-xl border-2 border-yellow-500/30 bg-gradient-to-br from-yellow-500/5 to-orange-500/5">
          <div className="text-center">
            <div className="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-yellow-500 to-orange-500 rounded-full mb-4">
              <i className="fas fa-crown text-white text-2xl"></i>
            </div>
            <h3 className="text-xl font-bold text-white mb-2">Premium Feature</h3>
            <div className="text-yellow-300 font-semibold mb-2">{feature}</div>
            <p className="text-slate-400 text-sm mb-4 leading-relaxed">
              {description || 'This feature is available for Premium and Pro subscribers.'}
            </p>
            <div className="space-y-2 mb-4">
              <div className="flex items-center gap-2 text-sm text-slate-300">
                <i className="fas fa-check text-emerald-400"></i>
                <span>Unlimited watchlist items</span>
              </div>
              <div className="flex items-center gap-2 text-sm text-slate-300">
                <i className="fas fa-check text-emerald-400"></i>
                <span>Advanced analytics & insights</span>
              </div>
              <div className="flex items-center gap-2 text-sm text-slate-300">
                <i className="fas fa-check text-emerald-400"></i>
                <span>Real-time price alerts</span>
              </div>
            </div>
            <button 
              onClick={upgrade}
              className="w-full py-3 bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-400 hover:to-orange-400 text-white rounded-lg font-bold text-sm transition shadow-lg shadow-yellow-500/20"
            >
              Upgrade to Premium
            </button>
            <div className="mt-3 text-xs text-slate-500">
              Starting at $9.99/month â€¢ Cancel anytime
            </div>
          </div>
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // EDUCATION CENTER MODAL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function EducationCenterModal({ onClose }) {
      const [selectedTab, setSelectedTab] = useState('tutorials');
      const [selectedTutorial, setSelectedTutorial] = useState(null);
      const [selectedCaseStudy, setSelectedCaseStudy] = useState(null);
      const userId = UserManager.getCurrentUser()?.id || 'guest';
      const progress = EDUCATION_CENTER.getProgress(userId);
      const completionRate = EDUCATION_CENTER.getCompletionRate(userId);

      const categories = [
        { id: 'basics', name: 'Basics', icon: 'ğŸ“š' },
        { id: 'metrics', name: 'Metrics', icon: 'ğŸ”¢' },
        { id: 'technical', name: 'Technical', icon: 'ğŸ“Š' },
        { id: 'strategy', name: 'Strategy', icon: 'ğŸ¯' }
      ];

      if (selectedTutorial) {
        return (
          <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div className="glass-card rounded-2xl p-6 w-full max-w-3xl max-h-[90vh] overflow-y-auto">
              <div className="flex items-center justify-between mb-4">
                <button onClick={() => setSelectedTutorial(null)} className="text-cyan-400 hover:text-cyan-300 flex items-center gap-2">
                  <i className="fas fa-arrow-left"></i> Back
                </button>
                <button onClick={onClose} className="text-slate-400 hover:text-white">
                  <i className="fas fa-times text-xl"></i>
                </button>
              </div>

              <div className="mb-6">
                <div className="text-4xl mb-3">{selectedTutorial.icon}</div>
                <h2 className="text-2xl font-bold text-white mb-2">{selectedTutorial.title}</h2>
                <div className="flex items-center gap-3 text-sm text-slate-400">
                  <span><i className="fas fa-clock mr-1"></i>{selectedTutorial.duration}</span>
                  <span>â€¢</span>
                  <span className="px-2 py-1 bg-cyan-500/10 text-cyan-300 rounded">{selectedTutorial.category}</span>
                </div>
              </div>

              <div className="space-y-6">
                <div>
                  <p className="text-slate-300 leading-relaxed">{selectedTutorial.content.intro}</p>
                </div>

                <div>
                  <h3 className="text-lg font-semibold text-white mb-3">Key Points</h3>
                  <ul className="space-y-2">
                    {selectedTutorial.content.keyPoints.map((point, i) => (
                      <li key={i} className="flex items-start gap-3 text-slate-300">
                        <i className="fas fa-check-circle text-emerald-400 mt-1"></i>
                        <span>{point}</span>
                      </li>
                    ))}
                  </ul>
                </div>

                <div className="glass p-4 rounded-lg border border-cyan-500/20">
                  <h4 className="font-semibold text-cyan-300 mb-2">ğŸ’¡ Example</h4>
                  <p className="text-slate-300 text-sm leading-relaxed">{selectedTutorial.content.example}</p>
                </div>

                {selectedTutorial.content.whyItMatters && (
                  <div className="glass p-4 rounded-lg border border-purple-500/20">
                    <h4 className="font-semibold text-purple-300 mb-2">ğŸ¯ Why This Matters</h4>
                    <p className="text-slate-300 text-sm leading-relaxed">{selectedTutorial.content.whyItMatters}</p>
                  </div>
                )}

                {selectedTutorial.content.practicalTip && (
                  <div className="glass p-4 rounded-lg border border-yellow-500/20">
                    <h4 className="font-semibold text-yellow-300 mb-2">âš¡ Practical Tip</h4>
                    <p className="text-slate-300 text-sm leading-relaxed">{selectedTutorial.content.practicalTip}</p>
                  </div>
                )}

                {selectedTutorial.content.nextSteps && (
                  <div>
                    <h4 className="font-semibold text-white mb-2">Next Steps</h4>
                    <div className="flex flex-wrap gap-2">
                      {selectedTutorial.content.nextSteps.map((step, i) => (
                        <span key={i} className="px-3 py-1 bg-slate-700 text-slate-300 rounded-full text-sm">
                          {step}
                        </span>
                      ))}
                    </div>
                  </div>
                )}
              </div>

              <div className="mt-6 flex gap-3">
                <button 
                  onClick={() => {
                    EDUCATION_CENTER.markComplete(userId, selectedTutorial.id);
                    setSelectedTutorial(null);
                  }}
                  className="flex-1 py-3 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-semibold transition"
                >
                  <i className="fas fa-check mr-2"></i>Mark Complete
                </button>
                <button 
                  onClick={() => setSelectedTutorial(null)}
                  className="px-6 py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold transition"
                >
                  Close
                </button>
              </div>
            </div>
          </div>
        );
      }

      if (selectedCaseStudy) {
        return (
          <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
            <div className="glass-card rounded-2xl p-6 w-full max-w-3xl max-h-[90vh] overflow-y-auto">
              <div className="flex items-center justify-between mb-4">
                <button onClick={() => setSelectedCaseStudy(null)} className="text-cyan-400 hover:text-cyan-300 flex items-center gap-2">
                  <i className="fas fa-arrow-left"></i> Back
                </button>
                <button onClick={onClose} className="text-slate-400 hover:text-white">
                  <i className="fas fa-times text-xl"></i>
                </button>
              </div>

              <div className="mb-6">
                <div className="text-5xl mb-3">{selectedCaseStudy.icon}</div>
                <h2 className="text-2xl font-bold text-white mb-2">{selectedCaseStudy.title}</h2>
                <div className="flex items-center gap-3 text-sm text-slate-400 mb-3">
                  <span className="font-semibold">{selectedCaseStudy.investor}</span>
                  <span>â€¢</span>
                  <span>{selectedCaseStudy.year}</span>
                </div>
                <p className="text-cyan-300 font-medium">{selectedCaseStudy.summary}</p>
              </div>

              <div className="space-y-6">
                <div className="glass p-4 rounded-lg border border-slate-700">
                  <h3 className="font-semibold text-white mb-2">ğŸ“– The Story</h3>
                  <p className="text-slate-300 leading-relaxed">{selectedCaseStudy.story}</p>
                </div>

                <div>
                  <h3 className="text-lg font-semibold text-white mb-3">Key Lessons</h3>
                  <ul className="space-y-2">
                    {selectedCaseStudy.keyLessons.map((lesson, i) => (
                      <li key={i} className="flex items-start gap-3 text-slate-300">
                        <span className="text-yellow-400 font-bold">{i + 1}.</span>
                        <span>{lesson}</span>
                      </li>
                    ))}
                  </ul>
                </div>

                <div className="glass p-4 rounded-lg border border-emerald-500/20">
                  <h3 className="font-semibold text-emerald-300 mb-3">ğŸ“Š The Numbers</h3>
                  <div className="grid grid-cols-2 gap-4">
                    {Object.entries(selectedCaseStudy.metrics).map(([key, value]) => (
                      <div key={key}>
                        <div className="text-slate-400 text-xs uppercase tracking-wide mb-1">
                          {key.replace(/([A-Z])/g, ' $1').trim()}
                        </div>
                        <div className="text-white font-semibold">{value}</div>
                      </div>
                    ))}
                  </div>
                </div>

                <div className="glass p-4 rounded-lg border border-purple-500/20 bg-gradient-to-br from-purple-500/5 to-pink-500/5">
                  <h4 className="font-semibold text-purple-300 mb-2">ğŸ’ Key Takeaway</h4>
                  <p className="text-white leading-relaxed">{selectedCaseStudy.takeaway}</p>
                </div>
              </div>

              <button 
                onClick={() => setSelectedCaseStudy(null)}
                className="mt-6 w-full py-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold transition"
              >
                Close
              </button>
            </div>
          </div>
        );
      }

      return (
        <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
          <div className="glass-card rounded-2xl p-6 w-full max-w-5xl max-h-[90vh] overflow-y-auto">
            <div className="flex items-center justify-between mb-6">
              <div>
                <h2 className="text-2xl font-bold text-white mb-1">ğŸ“š Education Center</h2>
                <p className="text-slate-400 text-sm">Learn investing from the ground up</p>
              </div>
              <button onClick={onClose} className="text-slate-400 hover:text-white">
                <i className="fas fa-times text-xl"></i>
              </button>
            </div>

            {/* Progress Bar */}
            <div className="mb-6 glass p-4 rounded-lg">
              <div className="flex items-center justify-between mb-2">
                <span className="text-sm text-slate-400">Your Progress</span>
                <span className="text-sm font-semibold text-cyan-300">{completionRate}%</span>
              </div>
              <div className="w-full h-2 bg-slate-700 rounded-full overflow-hidden">
                <div 
                  className="h-full bg-gradient-to-r from-cyan-500 to-emerald-500 transition-all duration-500"
                  style={{ width: `${completionRate}%` }}
                ></div>
              </div>
              <div className="mt-2 text-xs text-slate-500">
                {progress.completed.length} of {EDUCATION_CENTER.tutorials.length} tutorials completed
              </div>
            </div>

            {/* Tabs */}
            <div className="flex gap-2 mb-6 border-b border-slate-700">
              <button 
                onClick={() => setSelectedTab('tutorials')}
                className={`px-4 py-2 font-semibold transition ${
                  selectedTab === 'tutorials' 
                    ? 'text-cyan-400 border-b-2 border-cyan-400' 
                    : 'text-slate-400 hover:text-white'
                }`}
              >
                <i className="fas fa-book mr-2"></i>Tutorials
              </button>
              <button 
                onClick={() => setSelectedTab('case-studies')}
                className={`px-4 py-2 font-semibold transition ${
                  selectedTab === 'case-studies' 
                    ? 'text-cyan-400 border-b-2 border-cyan-400' 
                    : 'text-slate-400 hover:text-white'
                }`}
              >
                <i className="fas fa-trophy mr-2"></i>Case Studies
              </button>
            </div>

            {/* Tutorials Tab */}
            {selectedTab === 'tutorials' && (
              <div>
                {categories.map(category => {
                  const tutorials = EDUCATION_CENTER.getTutorialsByCategory(category.id);
                  return (
                    <div key={category.id} className="mb-6">
                      <h3 className="text-lg font-semibold text-white mb-3 flex items-center gap-2">
                        <span>{category.icon}</span>
                        <span>{category.name}</span>
                      </h3>
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {tutorials.map(tutorial => {
                          const isCompleted = progress.completed.includes(tutorial.id);
                          const inProgress = progress.inProgress.includes(tutorial.id);
                          return (
                            <div 
                              key={tutorial.id}
                              onClick={() => {
                                if (!isCompleted && !inProgress) {
                                  EDUCATION_CENTER.markInProgress(userId, tutorial.id);
                                }
                                setSelectedTutorial(tutorial);
                              }}
                              className="glass-card p-4 rounded-lg cursor-pointer hover:border-cyan-500/40 transition"
                            >
                              <div className="flex items-start justify-between mb-2">
                                <span className="text-3xl">{tutorial.icon}</span>
                                {isCompleted && (
                                  <span className="px-2 py-1 bg-emerald-500/20 text-emerald-300 rounded text-xs font-semibold">
                                    <i className="fas fa-check mr-1"></i>Done
                                  </span>
                                )}
                                {inProgress && !isCompleted && (
                                  <span className="px-2 py-1 bg-yellow-500/20 text-yellow-300 rounded text-xs font-semibold">
                                    <i className="fas fa-hourglass-half mr-1"></i>In Progress
                                  </span>
                                )}
                              </div>
                              <h4 className="font-semibold text-white mb-1">{tutorial.title}</h4>
                              <p className="text-xs text-slate-400 mb-2">
                                <i className="fas fa-clock mr-1"></i>{tutorial.duration}
                              </p>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  );
                })}
              </div>
            )}

            {/* Case Studies Tab */}
            {selectedTab === 'case-studies' && (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {EDUCATION_CENTER.caseStudies.map(caseStudy => (
                  <div 
                    key={caseStudy.id}
                    onClick={() => setSelectedCaseStudy(caseStudy)}
                    className="glass-card p-5 rounded-lg cursor-pointer hover:border-cyan-500/40 transition"
                  >
                    <div className="text-4xl mb-3">{caseStudy.icon}</div>
                    <h3 className="font-semibold text-white mb-1">{caseStudy.title}</h3>
                    <div className="text-xs text-slate-400 mb-2">
                      {caseStudy.investor} â€¢ {caseStudy.year}
                    </div>
                    <p className="text-sm text-slate-300 leading-relaxed">{caseStudy.summary}</p>
                  </div>
                ))}
              </div>
            )}
          </div>
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // COMPONENTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function AdvancedChartPanel({
      symbol,
      candles,
      timeframe,
      onTimeframe,
      comparisonSymbol,
      onComparisonSymbol,
      comparisonCandles,
      comparisonLoading
    }) {
      const priceRef = useRef(null);
      const rsiRef = useRef(null);
      const macdRef = useRef(null);
      const chartsRef = useRef({ price: null, rsi: null, macd: null });
      const seriesRef = useRef({
        candle: null,
        volume: null,
        bbUpper: null,
        bbMid: null,
        bbLower: null,
        compare: null,
        rsi: null,
        macd: null,
        macdSignal: null,
        macdHist: null,
        drawings: []
      });
      const drawStateRef = useRef({ enabled: false, firstPoint: null });

      const [showBollinger, setShowBollinger] = useState(true);
      const [showRSI, setShowRSI] = useState(true);
      const [showMACD, setShowMACD] = useState(true);
      const [showVolume, setShowVolume] = useState(true);
      const [drawMode, setDrawMode] = useState(false);

      const normalized = useMemo(() => normalizeFmpCandles(candles), [candles]);
      const profile = useMemo(() => computeVolumeProfile(normalized, 24), [normalized]);

      const setDrawEnabled = (enabled) => {
        setDrawMode(enabled);
        drawStateRef.current.enabled = enabled;
        drawStateRef.current.firstPoint = null;
      };

      const clearDrawings = () => {
        const priceChart = chartsRef.current.price;
        if (!priceChart) return;
        for (const s of seriesRef.current.drawings) {
          try { priceChart.removeSeries(s); } catch {}
        }
        seriesRef.current.drawings = [];
        drawStateRef.current.firstPoint = null;
      };

      useEffect(() => {
        if (!window.LightweightCharts) {
          console.warn('âš ï¸ LightweightCharts not available');
          return;
        }
        if (!priceRef.current) return;
        if (!normalized || normalized.length === 0) return;

        // Cleanup previous charts
        try { chartsRef.current.price?.remove(); } catch {}
        try { chartsRef.current.rsi?.remove(); } catch {}
        try { chartsRef.current.macd?.remove(); } catch {}
        chartsRef.current = { price: null, rsi: null, macd: null };
        seriesRef.current.drawings = [];
        drawStateRef.current.firstPoint = null;

        const rootStyles = getComputedStyle(document.documentElement);
        const textSecondary = (rootStyles.getPropertyValue('--text-secondary') || '#94a3b8').trim();

        const common = {
          layout: {
            background: { type: 'solid', color: 'transparent' },
            textColor: textSecondary
          },
          grid: {
            vertLines: { color: 'rgba(148, 163, 184, 0.08)' },
            horzLines: { color: 'rgba(148, 163, 184, 0.08)' }
          },
          timeScale: { borderColor: 'rgba(148, 163, 184, 0.15)' },
          rightPriceScale: { borderColor: 'rgba(148, 163, 184, 0.15)' },
          crosshair: { mode: window.LightweightCharts.CrosshairMode.Normal }
        };

        const priceChart = window.LightweightCharts.createChart(priceRef.current, {
          ...common,
          height: 360,
        });
        chartsRef.current.price = priceChart;

        const candleSeries = priceChart.addCandlestickSeries({
          upColor: '#22c55e',
          downColor: '#ef4444',
          borderUpColor: '#22c55e',
          borderDownColor: '#ef4444',
          wickUpColor: '#22c55e',
          wickDownColor: '#ef4444'
        });
        seriesRef.current.candle = candleSeries;
        candleSeries.setData(normalized);

        const closes = normalized.map(c => c.close);
        const times = normalized.map(c => c.time);

        // Volume
        const volumeSeries = priceChart.addHistogramSeries({
          priceFormat: { type: 'volume' },
          priceScaleId: '',
          scaleMargins: { top: 0.8, bottom: 0 }
        });
        seriesRef.current.volume = volumeSeries;
        if (showVolume) {
          volumeSeries.setData(normalized.map(c => ({
            time: c.time,
            value: c.volume,
            color: c.close >= c.open ? 'rgba(34,197,94,0.45)' : 'rgba(239,68,68,0.45)'
          })));
        } else {
          volumeSeries.setData([]);
        }

        // Bollinger Bands
        const bbUpper = priceChart.addLineSeries({ color: 'rgba(148,163,184,0.55)', lineWidth: 1 });
        const bbMid = priceChart.addLineSeries({ color: 'rgba(6,182,212,0.65)', lineWidth: 1 });
        const bbLower = priceChart.addLineSeries({ color: 'rgba(148,163,184,0.55)', lineWidth: 1 });
        seriesRef.current.bbUpper = bbUpper;
        seriesRef.current.bbMid = bbMid;
        seriesRef.current.bbLower = bbLower;

        if (showBollinger) {
          const bb = computeBollinger(closes, 20, 2);
          bbUpper.setData(times.map((t, i) => bb.upper[i] == null ? null : ({ time: t, value: bb.upper[i] })).filter(Boolean));
          bbMid.setData(times.map((t, i) => bb.mid[i] == null ? null : ({ time: t, value: bb.mid[i] })).filter(Boolean));
          bbLower.setData(times.map((t, i) => bb.lower[i] == null ? null : ({ time: t, value: bb.lower[i] })).filter(Boolean));
        } else {
          bbUpper.setData([]);
          bbMid.setData([]);
          bbLower.setData([]);
        }

        // Comparison overlay (% change)
        if (comparisonCandles && comparisonCandles.length > 0) {
          const cmp = normalizeFmpCandles(comparisonCandles);
          if (cmp.length > 2) {
            const base = cmp[0].close || 1;
            const compareSeries = priceChart.addLineSeries({
              color: 'rgba(139,92,246,0.85)',
              lineWidth: 2,
              priceScaleId: 'compare'
            });
            priceChart.priceScale('compare').applyOptions({
              scaleMargins: { top: 0.1, bottom: 0.1 },
              borderVisible: false
            });
            compareSeries.setData(cmp.map(p => ({ time: p.time, value: ((p.close - base) / base) * 100 })));
            seriesRef.current.compare = compareSeries;
          }
        }

        // RSI chart
        let rsiChart = null;
        if (showRSI && rsiRef.current) {
          rsiChart = window.LightweightCharts.createChart(rsiRef.current, {
            ...common,
            height: 140,
            timeScale: { visible: false },
          });
          chartsRef.current.rsi = rsiChart;
          const rsiSeries = rsiChart.addLineSeries({ color: 'rgba(6,182,212,0.85)', lineWidth: 2 });
          seriesRef.current.rsi = rsiSeries;
          const rsiVals = computeRSI(closes, 14);
          rsiSeries.setData(times.map((t, i) => rsiVals[i] == null ? null : ({ time: t, value: rsiVals[i] })).filter(Boolean));
        }

        // MACD chart
        let macdChart = null;
        if (showMACD && macdRef.current) {
          macdChart = window.LightweightCharts.createChart(macdRef.current, {
            ...common,
            height: 160,
            timeScale: { visible: true },
          });
          chartsRef.current.macd = macdChart;
          const macdLine = macdChart.addLineSeries({ color: 'rgba(6,182,212,0.85)', lineWidth: 2 });
          const signalLine = macdChart.addLineSeries({ color: 'rgba(148,163,184,0.75)', lineWidth: 1 });
          const histSeries = macdChart.addHistogramSeries({ priceFormat: { type: 'price' } });
          seriesRef.current.macd = macdLine;
          seriesRef.current.macdSignal = signalLine;
          seriesRef.current.macdHist = histSeries;

          const macd = computeMACD(closes, 12, 26, 9);
          macdLine.setData(times.map((t, i) => macd.macd[i] == null ? null : ({ time: t, value: macd.macd[i] })).filter(Boolean));
          signalLine.setData(times.map((t, i) => macd.signal[i] == null ? null : ({ time: t, value: macd.signal[i] })).filter(Boolean));
          histSeries.setData(times.map((t, i) => {
            const v = macd.hist[i];
            if (v == null) return null;
            return { time: t, value: v, color: v >= 0 ? 'rgba(34,197,94,0.55)' : 'rgba(239,68,68,0.55)' };
          }).filter(Boolean));
        }

        // Sync visible range across charts
        const syncRange = (source, target) => {
          if (!source || !target) return () => {};
          const handler = (range) => {
            try { target.timeScale().setVisibleRange(range); } catch {}
          };
          source.timeScale().subscribeVisibleTimeRangeChange(handler);
          return () => source.timeScale().unsubscribeVisibleTimeRangeChange(handler);
        };
        const unsub1 = syncRange(priceChart, rsiChart);
        const unsub2 = syncRange(priceChart, macdChart);

        // Drawing tool: trendline (two clicks)
        const clickHandler = (param) => {
          if (!drawStateRef.current.enabled) return;
          if (!param || !param.time) return;
          const seriesData = param.seriesData;
          let price = null;
          try {
            if (seriesData && seriesData.get && seriesRef.current.candle) {
              const p = seriesData.get(seriesRef.current.candle);
              price = p?.close ?? p?.value ?? p?.open ?? null;
            }
          } catch {}
          if (price == null) return;

          if (!drawStateRef.current.firstPoint) {
            drawStateRef.current.firstPoint = { time: param.time, value: price };
            return;
          }
          const p1 = drawStateRef.current.firstPoint;
          const p2 = { time: param.time, value: price };
          drawStateRef.current.firstPoint = null;

          const line = priceChart.addLineSeries({ color: 'rgba(6,182,212,0.75)', lineWidth: 2 });
          line.setData([p1, p2].sort((a, b) => a.time - b.time));
          seriesRef.current.drawings.push(line);
        };
        priceChart.subscribeClick(clickHandler);

        const ro = new ResizeObserver(entries => {
          for (const e of entries) {
            const w = Math.floor(e.contentRect.width);
            try { priceChart.applyOptions({ width: w }); } catch {}
            try { rsiChart?.applyOptions({ width: w }); } catch {}
            try { macdChart?.applyOptions({ width: w }); } catch {}
          }
        });
        ro.observe(priceRef.current);

        return () => {
          try { priceChart.unsubscribeClick(clickHandler); } catch {}
          unsub1();
          unsub2();
          try { ro.disconnect(); } catch {}
          try { priceChart.remove(); } catch {}
          try { rsiChart?.remove(); } catch {}
          try { macdChart?.remove(); } catch {}
        };
      }, [normalized, showBollinger, showRSI, showMACD, showVolume, comparisonCandles]);

      return (
        <div className="space-y-4">
          {!window.LightweightCharts && (
            <div className="glass-card p-4 rounded-xl border border-yellow-500/30 bg-yellow-500/10">
              <div className="text-yellow-300 font-semibold text-sm mb-1">Chart library failed to load</div>
              <div className="text-xs text-slate-300">The Lightweight Charts script didnâ€™t load (network blocked or CDN unavailable). Refresh the page or try a different network.</div>
            </div>
          )}

          {window.LightweightCharts && (!normalized || normalized.length === 0) && (
            <div className="glass-card p-4 rounded-xl border border-slate-700/40">
              <div className="text-slate-200 font-semibold text-sm mb-1">No chart candles available</div>
              <div className="text-xs text-slate-400">This usually means the API returned no candles for the selected timeframe, or the timestamps were not parseable.</div>
            </div>
          )}
          <div className="flex flex-wrap items-center justify-between gap-3">
            <div className="flex items-center gap-2 flex-wrap">
              <div className="text-xs text-slate-500">Timeframe</div>
              {[{ id: '1hour', label: '1H' }, { id: '4hour', label: '4H' }, { id: '1day', label: '1D' }].map(tf => (
                <button
                  key={tf.id}
                  onClick={() => onTimeframe(tf.id)}
                  className={`px-3 py-1 rounded-lg text-xs font-semibold border transition ${timeframe === tf.id ? 'bg-cyan-500/20 text-cyan-300 border-cyan-500/30' : 'bg-slate-800/40 text-slate-300 border-slate-700/30 hover:bg-slate-700/30'}`}
                >
                  {tf.label}
                </button>
              ))}

              <div className="w-px h-6 bg-slate-700/40 mx-1"></div>

              <button
                onClick={() => setShowBollinger(v => !v)}
                className={`px-3 py-1 rounded-lg text-xs font-semibold border transition ${showBollinger ? 'bg-slate-700/40 text-slate-100 border-slate-600/40' : 'bg-slate-800/40 text-slate-400 border-slate-700/30'}`}
              >
                Bollinger
              </button>
              <button
                onClick={() => setShowRSI(v => !v)}
                className={`px-3 py-1 rounded-lg text-xs font-semibold border transition ${showRSI ? 'bg-slate-700/40 text-slate-100 border-slate-600/40' : 'bg-slate-800/40 text-slate-400 border-slate-700/30'}`}
              >
                RSI
              </button>
              <button
                onClick={() => setShowMACD(v => !v)}
                className={`px-3 py-1 rounded-lg text-xs font-semibold border transition ${showMACD ? 'bg-slate-700/40 text-slate-100 border-slate-600/40' : 'bg-slate-800/40 text-slate-400 border-slate-700/30'}`}
              >
                MACD
              </button>
              <button
                onClick={() => setShowVolume(v => !v)}
                className={`px-3 py-1 rounded-lg text-xs font-semibold border transition ${showVolume ? 'bg-slate-700/40 text-slate-100 border-slate-600/40' : 'bg-slate-800/40 text-slate-400 border-slate-700/30'}`}
              >
                Volume
              </button>
            </div>

            <div className="flex items-center gap-2 flex-wrap">
              <div className="text-xs text-slate-500">Compare</div>
              <input
                value={comparisonSymbol}
                onChange={(e) => onComparisonSymbol(e.target.value.toUpperCase().replace(/[^A-Z.]/g, '').slice(0, 10))}
                placeholder="e.g. SPY"
                className="px-3 py-1 rounded-lg text-xs bg-slate-900/40 border border-slate-700/40 text-slate-200 w-28"
              />
              {comparisonLoading && (
                <span className="text-xs text-slate-500">Loadingâ€¦</span>
              )}
              <div className="w-px h-6 bg-slate-700/40 mx-1"></div>
              <button
                onClick={() => setDrawEnabled(!drawMode)}
                className={`px-3 py-1 rounded-lg text-xs font-semibold border transition ${drawMode ? 'bg-cyan-500/20 text-cyan-300 border-cyan-500/30' : 'bg-slate-800/40 text-slate-300 border-slate-700/30 hover:bg-slate-700/30'}`}
              >
                {drawMode ? 'Drawing: ON' : 'Draw Trendline'}
              </button>
              <button
                onClick={clearDrawings}
                className="px-3 py-1 rounded-lg text-xs font-semibold border border-slate-700/30 bg-slate-800/40 text-slate-300 hover:bg-slate-700/30"
              >
                Clear
              </button>
            </div>
          </div>

          <div className="grid grid-cols-1 lg:grid-cols-5 gap-4">
            <div className="lg:col-span-4 space-y-3">
              <div className="glass-card p-4 rounded-xl">
                <div ref={priceRef} style={{ width: '100%' }} />
              </div>
              {showRSI && (
                <div className="glass-card p-4 rounded-xl">
                  <div className="text-xs text-slate-500 mb-2">
                    RSI (14)
                  </div>
                  <div ref={rsiRef} style={{ width: '100%' }} />
                </div>
              )}
              {showMACD && (
                <div className="glass-card p-4 rounded-xl">
                  <div className="text-xs text-slate-500 mb-2">MACD (12, 26, 9)</div>
                  <div ref={macdRef} style={{ width: '100%' }} />
                </div>
              )}
            </div>

            <div className="lg:col-span-1">
              <div className="glass-card p-4 rounded-xl">
                <div className="flex items-center justify-between mb-3">
                  <div>
                    <div className="text-sm font-bold text-white">Volume Profile</div>
                    <div className="text-xs text-slate-500">Approx. by typical price</div>
                  </div>
                </div>
                {profile.length === 0 ? (
                  <div className="text-sm text-slate-500">Not enough data</div>
                ) : (
                  <div className="space-y-1">
                    {profile.slice(0, 18).map((b, idx) => (
                      <div key={idx} className="flex items-center gap-2">
                        <div className="text-[10px] text-slate-500 w-16 font-mono">
                          {b.lo.toFixed(0)}-{b.hi.toFixed(0)}
                        </div>
                        <div className="flex-1 h-2 bg-slate-800/40 rounded overflow-hidden">
                          <div className="h-full bg-slate-500/50" style={{ width: `${Math.max(2, Math.min(100, b.pct))}%` }} />
                        </div>
                      </div>
                    ))}
                  </div>
                )}
                <div className="mt-3 text-[10px] text-slate-500">
                  {comparisonSymbol ? `Compare overlay: ${comparisonSymbol}` : 'Add a comparison symbol to overlay % change.'}
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MARKET CRASH SIMULATOR COMPONENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function MarketCrashSimulator({ holdings, totalValue }) {
      const [selectedScenario, setSelectedScenario] = useState('2008 Financial Crisis');
      const [showDetails, setShowDetails] = useState(false);
      
      const crashResult = simulateMarketCrash(holdings, selectedScenario);
      
      if (!crashResult) return null;
      
      return (
        <div className="space-y-4">
          <div className="flex items-center justify-between mb-3">
            <p className="text-sm text-slate-400">
              See how your portfolio would handle historical market crashes
            </p>
            <select
              value={selectedScenario}
              onChange={(e) => setSelectedScenario(e.target.value)}
              className="px-3 py-1.5 bg-slate-800 border border-slate-700 rounded text-white text-sm focus:outline-none focus:border-purple-500"
            >
              {Object.keys(CRASH_SCENARIOS).map(scenario => (
                <option key={scenario} value={scenario}>{scenario}</option>
              ))}
            </select>
          </div>
          
          <div className="grid grid-cols-3 gap-4">
            <div className="glass-card p-4 rounded-lg text-center">
              <div className="text-xs text-slate-500 mb-2">Portfolio Loss</div>
              <div className="text-2xl font-bold text-red-400">
                ${crashResult.lossUsd.toLocaleString('en-US', { maximumFractionDigits: 0 })}
              </div>
              <div className="text-xs text-slate-500 mt-1">
                -{crashResult.lossPct}%
              </div>
            </div>
            <div className="glass-card p-4 rounded-lg text-center">
              <div className="text-xs text-slate-500 mb-2">Timeline</div>
              <div className="text-2xl font-bold text-white">
                {crashResult.weeks} {crashResult.weeks === 1 ? 'week' : 'weeks'}
              </div>
              <div className="text-xs text-slate-500 mt-1">
                ~${crashResult.perWeek.toLocaleString('en-US', { maximumFractionDigits: 0 })}/week
              </div>
            </div>
            <div className="glass-card p-4 rounded-lg text-center">
              <div className="text-xs text-slate-500 mb-2">Value After Crash</div>
              <div className="text-2xl font-bold text-yellow-400">
                ${crashResult.finalValue.toLocaleString('en-US', { maximumFractionDigits: 0 })}
              </div>
              <div className="text-xs text-slate-500 mt-1">
                {crashResult.percentRemaining.toFixed(0)}% remaining
              </div>
            </div>
          </div>
          
          {/* Visual indicator */}
          <div className="glass-card p-4 rounded-lg">
            <div className="flex justify-between items-center mb-2">
              <span className="text-xs text-slate-400">Portfolio Drawdown</span>
              <span className="text-xs font-bold text-red-400">-{crashResult.lossPct}%</span>
            </div>
            <div className="w-full bg-slate-700 rounded-full h-3">
              <div 
                className="h-full bg-gradient-to-r from-green-500 to-red-500 rounded-full transition-all"
                style={{ width: `${crashResult.percentRemaining}%` }}
              ></div>
            </div>
            <div className="flex justify-between text-xs text-slate-500 mt-1">
              <span>$0</span>
              <span>${totalValue.toLocaleString('en-US', { maximumFractionDigits: 0 })}</span>
            </div>
          </div>
          
          <div className="p-3 bg-slate-800/40 border border-slate-700/50 rounded-lg">
            <div className="flex items-start gap-2">
              <i className="fas fa-info-circle text-blue-400 text-sm mt-0.5"></i>
              <div className="text-xs text-slate-300 leading-relaxed">
                <strong>Historical scenario</strong> â€“ not a prediction. Past crashes help you understand your risk tolerance.
                Would you panic-sell, hold steady, or see it as a buying opportunity?
              </div>
            </div>
          </div>
          
          <button
            onClick={() => setShowDetails(!showDetails)}
            className="text-sm text-purple-400 hover:text-purple-300 font-semibold flex items-center gap-2 transition"
          >
            {showDetails ? 'â–¼' : 'â–¶'} {showDetails ? 'Hide' : 'Show'} Historical Context
          </button>
          
          {showDetails && (
            <div className="glass-card p-4 rounded-lg space-y-2 text-xs text-slate-300">
              <div className="font-semibold text-white mb-2">{selectedScenario} Details:</div>
              {selectedScenario === '2008 Financial Crisis' && (
                <p>The S&P 500 fell 57% from October 2007 to March 2009 during the subprime mortgage crisis. Recovery took 4+ years.</p>
              )}
              {selectedScenario === '2020 COVID Crash' && (
                <p>Markets dropped 34% in just 5 weeks (Feb-Mar 2020) due to pandemic fears. Recovery was V-shaped, taking only 5 months.</p>
              )}
              {selectedScenario === '2000 Dot-com Bust' && (
                <p>The tech-heavy NASDAQ fell 78% from March 2000 to October 2002. Full recovery took 15 years.</p>
              )}
              {selectedScenario === '1987 Black Monday' && (
                <p>Markets crashed 22.6% in a single day (Oct 19, 1987) due to program trading and panic. Recovery took 2 years.</p>
              )}
            </div>
          )}
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // STOCK GRADING SYSTEM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function calculateStockGrade(stock) {
      let score = 0, maxScore = 0;
      const criteria = [];

      // Valuation (25 pts)
      if (stock.pe) {
        maxScore += 10;
        if (stock.pe < 15) { score += 10; criteria.push({ name: 'P/E Ratio', grade: 'A', reason: 'Attractive valuation (P/E < 15)' }); }
        else if (stock.pe < 25) { score += 7; criteria.push({ name: 'P/E Ratio', grade: 'B', reason: 'Fair valuation (P/E 15-25)' }); }
        else if (stock.pe < 35) { score += 4; criteria.push({ name: 'P/E Ratio', grade: 'C', reason: 'Expensive (P/E 25-35)' }); }
        else { score += 2; criteria.push({ name: 'P/E Ratio', grade: 'D', reason: 'Very expensive (P/E >35)' }); }
      }
      if (stock.priceToBook) {
        maxScore += 8;
        if (stock.priceToBook < 1.5) { score += 8; criteria.push({ name: 'P/B Ratio', grade: 'A', reason: 'Trading below book value' }); }
        else if (stock.priceToBook < 3) { score += 6; criteria.push({ name: 'P/B Ratio', grade: 'B', reason: 'Reasonable P/B ratio' }); }
        else { score += 3; criteria.push({ name: 'P/B Ratio', grade: 'C', reason: 'High P/B ratio' }); }
      }

      // Growth (25 pts)
      if (stock.revenueGrowth) {
        maxScore += 10;
        if (stock.revenueGrowth > 20) { score += 10; criteria.push({ name: 'Revenue Growth', grade: 'A', reason: 'Strong growth (>20%)' }); }
        else if (stock.revenueGrowth > 10) { score += 7; criteria.push({ name: 'Revenue Growth', grade: 'B', reason: 'Solid growth (10-20%)' }); }
        else if (stock.revenueGrowth > 0) { score += 4; criteria.push({ name: 'Revenue Growth', grade: 'C', reason: 'Slow growth (0-10%)' }); }
        else { score += 1; criteria.push({ name: 'Revenue Growth', grade: 'F', reason: 'Declining revenue' }); }
      }
      if (stock.epsGrowth) {
        maxScore += 10;
        if (stock.epsGrowth > 20) { score += 10; criteria.push({ name: 'EPS Growth', grade: 'A', reason: 'Excellent earnings (>20%)' }); }
        else if (stock.epsGrowth > 10) { score += 7; criteria.push({ name: 'EPS Growth', grade: 'B', reason: 'Good earnings (10-20%)' }); }
        else if (stock.epsGrowth > 0) { score += 4; criteria.push({ name: 'EPS Growth', grade: 'C', reason: 'Modest growth (0-10%)' }); }
      }
      if (stock.grossMargin) {
        maxScore += 5;
        if (stock.grossMargin > 60) { score += 5; criteria.push({ name: 'Gross Margin', grade: 'A', reason: 'Exceptional margins (>60%)' }); }
        else if (stock.grossMargin > 40) { score += 3; criteria.push({ name: 'Gross Margin', grade: 'B', reason: 'Strong margins (40-60%)' }); }
        else if (stock.grossMargin > 20) { score += 2; criteria.push({ name: 'Gross Margin', grade: 'C', reason: 'Fair margins (20-40%)' }); }
      }

      // Financial Health (25 pts)
      if (stock.debtToEquity !== undefined) {
        maxScore += 10;
        if (stock.debtToEquity < 0.5) { score += 10; criteria.push({ name: 'Debt/Equity', grade: 'A', reason: 'Very low debt (<0.5)' }); }
        else if (stock.debtToEquity < 1.0) { score += 7; criteria.push({ name: 'Debt/Equity', grade: 'B', reason: 'Conservative debt (0.5-1.0)' }); }
        else if (stock.debtToEquity < 2.0) { score += 4; criteria.push({ name: 'Debt/Equity', grade: 'C', reason: 'Moderate debt (1.0-2.0)' }); }
        else { score += 2; criteria.push({ name: 'Debt/Equity', grade: 'D', reason: 'High debt (>2.0)' }); }
      }
      if (stock.currentRatio) {
        maxScore += 8;
        if (stock.currentRatio > 2.0) { score += 8; criteria.push({ name: 'Current Ratio', grade: 'A', reason: 'Strong liquidity (>2.0)' }); }
        else if (stock.currentRatio > 1.5) { score += 6; criteria.push({ name: 'Current Ratio', grade: 'B', reason: 'Adequate liquidity (1.5-2.0)' }); }
        else if (stock.currentRatio > 1.0) { score += 3; criteria.push({ name: 'Current Ratio', grade: 'C', reason: 'Tight liquidity (1.0-1.5)' }); }
      }
      if (stock.piotroskiScore) {
        maxScore += 7;
        if (stock.piotroskiScore >= 7) { score += 7; criteria.push({ name: 'Piotroski Score', grade: 'A', reason: 'Excellent financial health (7-9)' }); }
        else if (stock.piotroskiScore >= 5) { score += 5; criteria.push({ name: 'Piotroski Score', grade: 'B', reason: 'Good health (5-6)' }); }
        else if (stock.piotroskiScore >= 3) { score += 3; criteria.push({ name: 'Piotroski Score', grade: 'C', reason: 'Fair health (3-4)' }); }
        else { score += 1; criteria.push({ name: 'Piotroski Score', grade: 'D', reason: 'Weak health (<3)' }); }
      }

      // Profitability (15 pts)
      if (stock.roe) {
        maxScore += 8;
        if (stock.roe > 20) { score += 8; criteria.push({ name: 'ROE', grade: 'A', reason: 'Excellent return (>20%)' }); }
        else if (stock.roe > 15) { score += 6; criteria.push({ name: 'ROE', grade: 'B', reason: 'Strong return (15-20%)' }); }
        else if (stock.roe > 10) { score += 4; criteria.push({ name: 'ROE', grade: 'C', reason: 'Fair return (10-15%)' }); }
        else { score += 2; criteria.push({ name: 'ROE', grade: 'D', reason: 'Weak return (<10%)' }); }
      }
      if (stock.roic) {
        maxScore += 7;
        if (stock.roic > 15) { score += 7; criteria.push({ name: 'ROIC', grade: 'A', reason: 'Excellent capital efficiency (>15%)' }); }
        else if (stock.roic > 10) { score += 5; criteria.push({ name: 'ROIC', grade: 'B', reason: 'Good efficiency (10-15%)' }); }
        else if (stock.roic > 5) { score += 3; criteria.push({ name: 'ROIC', grade: 'C', reason: 'Fair efficiency (5-10%)' }); }
      }

      // Technical (10 pts)
      if (stock.rsi) {
        maxScore += 5;
        if (stock.rsi >= 40 && stock.rsi <= 60) { score += 5; criteria.push({ name: 'RSI', grade: 'A', reason: 'Neutral momentum' }); }
        else if (stock.rsi < 30) { score += 4; criteria.push({ name: 'RSI', grade: 'B', reason: 'Oversold - potential bounce' }); }
        else if (stock.rsi > 70) { score += 2; criteria.push({ name: 'RSI', grade: 'C', reason: 'Overbought - caution' }); }
      }
      if (stock.beta !== undefined) {
        maxScore += 5;
        if (stock.beta >= 0.8 && stock.beta <= 1.2) { score += 5; criteria.push({ name: 'Beta', grade: 'A', reason: 'Market-like volatility' }); }
        else if (stock.beta < 0.8) { score += 4; criteria.push({ name: 'Beta', grade: 'B', reason: 'Lower volatility' }); }
        else if (stock.beta < 1.5) { score += 3; criteria.push({ name: 'Beta', grade: 'C', reason: 'Moderate volatility' }); }
        else { score += 2; criteria.push({ name: 'Beta', grade: 'D', reason: 'High volatility' }); }
      }

      // Calculate final grade
      const percentage = maxScore > 0 ? (score / maxScore) * 100 : 0;
      let letterGrade = 'F';
      if (percentage >= 90) letterGrade = 'A';
      else if (percentage >= 80) letterGrade = 'B';
      else if (percentage >= 70) letterGrade = 'C';
      else if (percentage >= 60) letterGrade = 'D';

      return { 
        letterGrade, 
        percentage: Math.round(percentage), 
        score,
        maxScore,
        criteria: criteria.sort((a, b) => {
          const order = { 'A': 1, 'B': 2, 'C': 3, 'D': 4, 'F': 5 };
          return order[a.grade] - order[b.grade];
        })
      };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // THEMATIC PORTFOLIOS (PRE-BUILT BASKETS)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const THEMATIC_PORTFOLIOS = {
      'ai-infrastructure': {
        id: 'ai-infrastructure',
        name: 'ğŸ¤– AI Infrastructure',
        description: 'The physical & software backbone of the AI revolution',
        stocks: ['SMCI', 'NVDA', 'ANET', 'VRT', 'ARM', 'AMD', 'AVGO', 'MARA'],
        risk: 'high',
        rationale: 'These companies enable AI through chips, servers, networking, and power. SMCI and NVDA are direct beneficiaries of Blackwell ramp; ANET and VRT provide critical data center infrastructure.',
        category: 'Technology',
        color: 'from-cyan-500 to-blue-500'
      },
      'resilient-consumer': {
        id: 'resilient-consumer',
        name: 'ğŸ›ï¸ Resilient Consumer',
        description: 'Brands that thrive even in economic uncertainty',
        stocks: ['COST', 'ULTA', 'CELH', 'WMT', 'HD', 'MCD', 'SBUX', 'AAPL'],
        risk: 'low',
        rationale: 'These companies have pricing power, loyal customers, and essential or discretionary-but-resilient products. COST and WMT benefit from trade-down; CELH and ULTA from health/wellness trends.',
        category: 'Consumer',
        color: 'from-purple-500 to-pink-500'
      },
      'quality-compounders': {
        id: 'quality-compounders',
        name: 'â­ Quality Compounders',
        description: 'Elite businesses with durable moats and consistent returns',
        stocks: ['MSFT', 'AAPL', 'GOOGL', 'MA', 'V', 'COST', 'HD', 'ADBE'],
        risk: 'low',
        rationale: 'These are some of the world\'s strongest businesses with high ROIC, strong cash flows, and pricing power. They compound shareholder value over decades, not quarters.',
        category: 'Multi-Sector',
        color: 'from-emerald-500 to-teal-500'
      },
      'cybersecurity': {
        id: 'cybersecurity',
        name: 'ğŸ›¡ï¸ Cybersecurity',
        description: 'Protecting the digital world from growing threats',
        stocks: ['CRWD', 'ZS', 'PANW', 'S', 'NET', 'OKTA', 'VRNS'],
        risk: 'medium',
        rationale: 'Cyberattacks are increasing in frequency and sophistication. Cloud-native platforms like CrowdStrike and Zscaler are winning market share with superior architecture.',
        category: 'Technology',
        color: 'from-red-500 to-orange-500'
      },
      'clean-energy': {
        id: 'clean-energy',
        name: 'ğŸŒ± Clean Energy',
        description: 'The future of power generation and storage',
        stocks: ['ENPH', 'SEDG', 'SPWR', 'TSLA', 'PLUG', 'BE', 'NEE'],
        risk: 'high',
        rationale: 'Global decarbonization is accelerating. Solar (ENPH, SEDG), EVs (TSLA), and hydrogen (PLUG) are key beneficiaries of policy tailwinds and falling costs.',
        category: 'Energy',
        color: 'from-green-500 to-emerald-500'
      }
    };

    // === FINANCIAL GLOSSARY FOR "EXPLAIN THIS" ===
    const FINANCIAL_EXPLANATIONS = {
      pe: {
        label: 'P/E Ratio',
        plain: 'Price-to-Earnings: How much you pay for $1 of earnings. <15 = Undervalued, 15-25 = Fair, >25 = Growth priced in.',
        analogy: 'Like paying $25 for a pizza that gives you $1 worth of satisfaction per year.'
      },
      roe: {
        label: 'ROE (Return on Equity)',
        plain: 'Profit generated from shareholder equity. >15% = strong, >20% = excellent.',
        analogy: 'Like getting $1.20 back for every $1 you invest in the business.'
      },
      roic: {
        label: 'ROIC (Return on Invested Capital)',
        plain: 'How efficiently a company uses its capital to generate profits. >15% is strong.',
        analogy: 'Like a vending machine that returns $1.20 for every $1 you put in.'
      },
      evToEbitda: {
        label: 'EV/EBITDA',
        plain: 'Enterprise Value vs. Earnings Before Interest, Taxes, Depreciation & Amortization. <10 = cheap, >15 = expensive.',
        analogy: 'Like comparing the total price of a business to its core operating cash flow.'
      },
      piotroskiScore: {
        label: 'Piotroski Score',
        plain: 'A 9-point checklist for financial health (profitability, leverage, efficiency). 7-9 = strong, <4 = weak.',
        analogy: 'Like a financial health checkup for stocks.'
      },
      debtToEquity: {
        label: 'Debt-to-Equity',
        plain: 'How much debt a company uses relative to shareholder equity. <0.5 = conservative, >1.5 = risky.',
        analogy: 'Like a home: $200K house with $50K down (low risk) vs. $200K with $180K loan (high risk).'
      },
      rsi: {
        label: 'RSI (Relative Strength Index)',
        plain: 'Momentum indicator: <30 = oversold (potential buy), >70 = overbought (potential sell).',
        analogy: "Like a car's speedometer: too fast = risk of crash, too slow = opportunity to accelerate."
      },
      revenueGrowth: {
        label: 'Revenue Growth',
        plain: 'Year-over-year revenue change. >20% = high growth, <0% = decline.',
        analogy: 'Like a store that sold 100 units last year and 125 this year â€” business is expanding.'
      },
      grossMargin: {
        label: 'Gross Margin',
        plain: 'Profit after cost of goods sold. >40% = excellent, 20-40% = good.',
        analogy: 'If you sell a $10 product for $15, your gross margin is 33% â€” $5 profit before other costs.'
      },
      beta: {
        label: 'Beta',
        plain: 'Volatility relative to market. <1 = less volatile, >1 = more volatile than S&P 500.',
        analogy: 'Like comparing a steady sedan (beta 0.8) vs. a sports car (beta 1.5).'
      },
      dividendYield: {
        label: 'Dividend Yield',
        plain: 'Annual dividend as % of stock price. >3% = income stock, 1-3% = balanced.',
        analogy: 'Like earning $3 per year for every $100 invested in the stock.'
      },
      fcfYield: {
        label: 'Free Cash Flow Yield',
        plain: 'Cash generation as % of market value. >8% = excellent, 5-8% = good, 2-5% = fair.',
        analogy: '6% yield = $6 cash per $100 market value. Cash is harder to manipulate than earnings.'
      },
      epsGrowth: {
        label: 'EPS Growth',
        plain: 'Earnings per share growth rate. >20% = excellent, 10-20% = strong, 5-10% = moderate.',
        analogy: '$2 to $2.50 EPS = 25% growth. Indicates growing profitability per share.'
      }
    };

    // Reusable "Explain This" tooltip component
    function ExplainMetric({ metricKey, stock }) {
      const [isOpen, setIsOpen] = useState(false);
      const exp = FINANCIAL_EXPLANATIONS[metricKey];
      
      if (!exp) return null;

      // Generate stock-specific context
      let context = "";
      const value = stock[metricKey];
      
      if (metricKey === 'roe' && value != null) {
        if (value > 30) context = `${stock.symbol}'s ROE is ${value.toFixed(1)}% â€” extremely high, indicating strong profitability.`;
        else if (value > 15) context = `${stock.symbol}'s ROE is ${value.toFixed(1)}% â€” solid profitability.`;
        else context = `${stock.symbol}'s ROE is ${value.toFixed(1)}% â€” below average for its sector.`;
      }
      
      if (metricKey === 'pe' && value != null) {
        if (value < 15) context = `${stock.symbol}'s P/E of ${value.toFixed(1)} suggests it may be undervalued.`;
        else if (value > 30) context = `${stock.symbol}'s P/E of ${value.toFixed(1)} indicates premium pricing or high growth expectations.`;
        else context = `${stock.symbol}'s P/E of ${value.toFixed(1)} is in a reasonable range.`;
      }
      
      if (metricKey === 'rsi' && value != null) {
        if (value < 30) context = `${stock.symbol}'s RSI of ${value.toFixed(0)} suggests potential buying opportunity (oversold).`;
        else if (value > 70) context = `${stock.symbol}'s RSI of ${value.toFixed(0)} warns of potential pullback (overbought).`;
        else context = `${stock.symbol}'s RSI of ${value.toFixed(0)} is in neutral territory.`;
      }

      if (metricKey === 'piotroskiScore' && value != null) {
        if (value >= 7) context = `${stock.symbol}'s Piotroski Score of ${value}/9 indicates strong financial health.`;
        else if (value >= 4) context = `${stock.symbol}'s Piotroski Score of ${value}/9 shows moderate financial health.`;
        else context = `${stock.symbol}'s Piotroski Score of ${value}/9 suggests weak financial health.`;
      }

      return (
        <div className="relative inline-block ml-1">
          <button 
            onClick={() => setIsOpen(!isOpen)}
            className="text-xs text-slate-400 hover:text-cyan-400 font-bold transition"
            aria-label={`Explain ${exp.label}`}
          >
            ?
          </button>
          
          {isOpen && (
            <>
              <div className="fixed inset-0 z-40" onClick={() => setIsOpen(false)}></div>
              <div className="absolute z-50 w-72 p-4 bg-slate-800 border border-cyan-500/30 rounded-lg shadow-2xl text-xs"
                   style={{ top: '100%', left: '0', marginTop: '4px' }}
              >
                <div className="font-semibold text-cyan-300 mb-2 flex items-center justify-between">
                  <span>{exp.label}</span>
                  <button 
                    onClick={() => setIsOpen(false)}
                    className="text-slate-400 hover:text-white"
                  >
                    âœ•
                  </button>
                </div>
                <div className="text-slate-300 mb-3 leading-relaxed">{exp.plain}</div>
                {context && <div className="text-white mb-3 p-2 bg-slate-700/50 rounded border border-slate-600/50 italic">"{context}"</div>}
                <div className="text-slate-400 leading-relaxed">ğŸ’¡ {exp.analogy}</div>
              </div>
            </>
          )}
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SIMPLIFIED ANALYTICS FOR NON-EXPERTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Traffic Light System
    const getTrafficLight = (metric, value) => {
      if (value === null || value === undefined) return 'yellow';
      const rules = {
        pe: { green: v => v < 20, yellow: v => v < 30, red: v => v >= 30 },
        revenueGrowth: { green: v => v > 15, yellow: v => v > 5, red: v => v <= 5 },
        debtToEquity: { green: v => v < 0.5, yellow: v => v < 1.5, red: v => v >= 1.5 },
        roe: { green: v => v > 15, yellow: v => v > 10, red: v => v <= 10 },
        beta: { green: v => v < 1.0, yellow: v => v < 1.5, red: v => v >= 1.5 },
      };
      const rule = rules[metric];
      if (!rule) return 'yellow';
      if (rule.green(value)) return 'green';
      if (rule.yellow(value)) return 'yellow';
      return 'red';
    };
    
    // Plain English Summaries
    const getPlainEnglishSummary = (metric, value) => {
      if (value === null || value === undefined) return { text: 'No data available', detail: '' };
      const summaries = {
        pe: [
          { max: 15, text: 'ğŸ“‰ Bargain price', detail: 'Trading below historical average - potentially undervalued' },
          { max: 25, text: 'âœ… Fair price', detail: 'Reasonable valuation for current earnings' },
          { max: 35, text: 'âš ï¸ Premium price', detail: 'Expensive relative to earnings - needs strong growth to justify' },
          { max: Infinity, text: 'ğŸ”´ Very expensive', detail: 'High valuation - risky if growth slows' }
        ],
        revenueGrowth: [
          { max: 0, text: 'ğŸ“‰ Shrinking', detail: 'Revenue declining - market share loss or industry issues' },
          { max: 5, text: 'ğŸŒ Slow growth', detail: 'Minimal expansion - mature company or tough market' },
          { max: 15, text: 'âœ… Solid growth', detail: 'Healthy expansion rate - gaining market share' },
          { max: Infinity, text: 'ğŸš€ Rapid growth', detail: 'Fast expansion - verify sustainable' }
        ],
        debtToEquity: [
          { max: 0.5, text: 'ğŸ’ª Rock solid', detail: 'Very low debt - financially conservative' },
          { max: 1.0, text: 'âœ… Healthy balance', detail: 'Moderate debt levels - well managed' },
          { max: 2.0, text: 'âš ï¸ Elevated debt', detail: 'Higher debt - monitor closely in downturns' },
          { max: Infinity, text: 'ğŸ”´ High risk', detail: 'Heavy debt burden - vulnerable to rate changes' }
        ],
        roe: [
          { max: 10, text: 'ğŸ“‰ Weak returns', detail: 'Not generating much profit from equity' },
          { max: 15, text: 'â¡ï¸ Average', detail: 'Decent but not exceptional profitability' },
          { max: 20, text: 'âœ… Strong returns', detail: 'Excellent use of shareholder capital' },
          { max: Infinity, text: 'ğŸ† Elite returns', detail: 'Outstanding profitability - competitive advantage' }
        ],
        beta: [
          { max: 0.8, text: 'ğŸ›¡ï¸ Defensive', detail: 'Less volatile than market - safer in downturns' },
          { max: 1.2, text: 'â¡ï¸ Market-like', detail: 'Moves with the market - average risk' },
          { max: 1.8, text: 'âš¡ Volatile', detail: 'More dramatic swings than market' },
          { max: Infinity, text: 'ğŸ¢ Highly volatile', detail: 'Wild price swings - high risk/reward' }
        ]
      };
      const metricSummaries = summaries[metric];
      if (!metricSummaries) return { text: 'â€”', detail: '' };
      for (const summary of metricSummaries) {
        if (value <= summary.max) return summary;
      }
      return { text: 'â€”', detail: '' };
    };
    
    // Calculate Valuation Score
    const calculateValuationScore = (stock) => {
      let score = 50;
      if (stock.pe) {
        if (stock.pe < 15) score += 15;
        else if (stock.pe < 25) score += 5;
        else if (stock.pe > 35) score -= 15;
        else score -= 5;
      }
      if (stock.priceToBook) {
        if (stock.priceToBook < 1.5) score += 10;
        else if (stock.priceToBook < 3) score += 5;
        else score -= 10;
      }
      if (stock.fcfYield) {
        if (stock.fcfYield > 8) score += 10;
        else if (stock.fcfYield > 5) score += 5;
        else if (stock.fcfYield < 2) score -= 5;
      }
      if (stock.revenueGrowth && stock.revenueGrowth > 20) score += 10;
      return Math.max(0, Math.min(100, score));
    };
    
    // Get valuation label
    const getValuationLabel = (score) => {
      if (score < 35) return { label: 'Undervalued', color: '#22c55e', emoji: 'ğŸ’°' };
      if (score < 65) return { label: 'Fair Value', color: '#eab308', emoji: 'âš–ï¸' };
      return { label: 'Overvalued', color: '#ef4444', emoji: 'âš ï¸' };
    };

    function StockModal({ stock, onClose, watchlist, toggleWatchlist, detailedDataLoading, sectorAverages, portfolio, stocks }) {
      const [activeTab, setActiveTab] = useState('overview');
      const [showAllFactors, setShowAllFactors] = useState(false);
      const [showExplainScore, setShowExplainScore] = useState(false);
      const [insiderData, setInsiderData] = useState(null);
      const [analystEstimates, setAnalystEstimates] = useState(null);
      const [incomeStatement, setIncomeStatement] = useState(null);
      const [newsData, setNewsData] = useState([]);
      const [newsSentiment, setNewsSentiment] = useState(null);
      const [newsLoading, setNewsLoading] = useState(false);
      const [socialSentiment, setSocialSentiment] = useState(null);
      const [socialLoading, setSocialLoading] = useState(false);
      const [historicalData, setHistoricalData] = useState(null);
      const [historicalMeta, setHistoricalMeta] = useState({ symbol: null, timeframe: null });
      const [chartTimeframe, setChartTimeframe] = useState('4hour');
      const [comparisonSymbol, setComparisonSymbol] = useState('');
      const [comparisonData, setComparisonData] = useState(null);
      const [comparisonMeta, setComparisonMeta] = useState({ symbol: null, timeframe: null });
      const [comparisonLoading, setComparisonLoading] = useState(false);
      const [loadingTabData, setLoadingTabData] = useState(false);
      const [technicalData, setTechnicalData] = useState(null);
      const [ratingsData, setRatingsData] = useState(null);
      const [analystRatingsData, setAnalystRatingsData] = useState(null);
      const [error, setError] = useState(null);
      const [deepseekAnalysis, setDeepseekAnalysis] = useState(null);
      const [claudeAnalysis, setClaudeAnalysis] = useState(null);
      const [aiLoading, setAiLoading] = useState(false);
      const [deepseekLoading, setDeepseekLoading] = useState(false);
      const [claudeLoading, setClaudeLoading] = useState(false);
      
      // Real-time price tracking
      const [livePrice, setLivePrice] = useState(stock.price);
      const [liveChange, setLiveChange] = useState(stock.change);
      const [liveChangePct, setLiveChangePct] = useState(stock.changePct);
      const [priceHistory, setPriceHistory] = useState([]);
      const [isLiveUpdating, setIsLiveUpdating] = useState(false);
      
      const isWatchlisted = watchlist.includes(stock.symbol);
      const sectorAvg = sectorAverages[stock.sector] || {};

      const explainNow = useMemo(() => explainDeterministicAIScore(stock), [
        stock.symbol,
        stock.pe,
        stock.roe,
        stock.rsi,
        stock.changePct,
        stock.marketCap
      ]);
      
      // Subscribe to real-time updates for this stock
      useEffect(() => {
        const handleUpdate = (update) => {
          setLivePrice(update.price);
          setLiveChange(update.change);
          setLiveChangePct(update.changesPercentage || update.change);
          setIsLiveUpdating(true);
          
          // Add to price history for mini chart
          setPriceHistory(prev => {
            const newHistory = [...prev, { time: Date.now(), price: update.price }];
            // Keep last 50 data points
            return newHistory.slice(-50);
          });
          
          // Reset live indicator after 1 second
          setTimeout(() => setIsLiveUpdating(false), 1000);
        };
        
        // Subscribe based on connection status
        if (realtimeData.isConnected) {
          realtimeData.subscribe(stock.symbol, handleUpdate);
        } else {
          smartPoller.startPolling(stock.symbol, handleUpdate);
        }
        
        return () => {
          realtimeData.unsubscribe(stock.symbol, handleUpdate);
          smartPoller.stopPolling(stock.symbol);
        };
      }, [stock.symbol]);

      const explainThresholds = useMemo(() => aiExplainThresholds(num(stock.aiScore, 0)), [stock.aiScore]);

      const sensitivity = useMemo(() => aiSensitivitySuggestions(stock), [
        stock.symbol,
        stock.pe,
        stock.roe,
        stock.rsi,
        stock.changePct,
        stock.marketCap
      ]);

      const prevSnapshotEntry = useMemo(() => {
        try {
          const raw = localStorage.getItem(Cache.key(stock.symbol, 'stock_prev'));
          if (!raw) return null;
          const parsed = JSON.parse(raw);
          if (!parsed || !parsed.data) return null;
          return parsed;
        } catch {
          return null;
        }
      }, [stock.symbol]);

      const prevAnalysis = useMemo(() => {
        if (!prevSnapshotEntry?.data) return null;
        try {
          return generateAIAnalysis(prevSnapshotEntry.data);
        } catch {
          return null;
        }
      }, [stock.symbol, prevSnapshotEntry?.timestamp]);

      // Lazy load tab data when clicked
      
      
      // Track previous stock to detect changes
      const prevStockRef = useRef(null);

      useEffect(() => {
        console.log(`ğŸ” useEffect triggered - activeTab: ${activeTab}, stock: ${stock.symbol}`);
        
        const loadTabData = async () => {
          // Check if stock changed
          const stockChanged = prevStockRef.current && prevStockRef.current !== stock.symbol;
          
          console.log(`ğŸ“Œ Stock check: prevStock=${prevStockRef.current}, currentStock=${stock.symbol}, changed=${stockChanged}`);
          
          // Update ref for next check
          if (!prevStockRef.current) {
            prevStockRef.current = stock.symbol;
            console.log(`ğŸ“ First load - set prevStockRef to ${stock.symbol}`);
          }
          
          if (stockChanged) {
            console.log(`ğŸ”„ Stock changed to ${stock.symbol} - resetting tab data`);
            // Reset all tab data when stock changes
            setInsiderData(null);
            setAnalystEstimates(null);
            setRatingsData(null);
            setAnalystRatingsData(null);
            setAiAnalysis(null);
            setNewsData([]);
            setNewsSentiment(null);
            setHistoricalData(null);
            setHistoricalMeta({ symbol: null, timeframe: null });
            setChartTimeframe('4hour');
            setComparisonSymbol('');
            setComparisonData(null);
            setComparisonMeta({ symbol: null, timeframe: null });
            setComparisonLoading(false);
            setActiveTab('overview');
            prevStockRef.current = stock.symbol;
            console.log(`âœ… Reset complete - activeTab now: overview`);
            return; // Exit after reset to let next render handle fetching
          }
          
          console.log(`ğŸ¯ Checking tabs - activeTab: ${activeTab}`);
          console.log(`   - insiderData: ${insiderData ? 'EXISTS' : 'NULL'}`);
          console.log(`   - analystEstimates: ${analystEstimates ? 'EXISTS' : 'NULL'}`);
          
          setLoadingTabData(true);
          setError(null);
          try {
            // NEWS & SENTIMENT TAB
            if (activeTab === 'news-sentiment' && newsData.length === 0) {
              console.log(`ğŸ“° Fetching news & sentiment for ${stock.symbol}...`);
              setNewsLoading(true);
              setSocialLoading(true);
              
              try {
                // Fetch social sentiment in parallel with news
                if (window.socialSentiment) {
                  window.socialSentiment.fetchSocialSentiment(stock.symbol).then(social => {
                    setSocialSentiment(social);
                    setSocialLoading(false);
                  }).catch(err => {
                    console.error('âŒ Social sentiment error:', err);
                    setSocialLoading(false);
                  });
                } else {
                  console.warn('âš ï¸ socialSentiment not yet initialized, retrying...');
                  // Retry after a short delay
                  setTimeout(() => {
                    if (window.socialSentiment) {
                      window.socialSentiment.fetchSocialSentiment(stock.symbol).then(social => {
                        setSocialSentiment(social);
                        setSocialLoading(false);
                      }).catch(err => {
                        console.error('âŒ Social sentiment error:', err);
                        setSocialLoading(false);
                      });
                    } else {
                      console.error('âŒ socialSentiment still not available');
                      setSocialLoading(false);
                    }
                  }, 500);
                }

                // Subscribe to real-time news updates
                const newsCallback = (articles) => {
                  setNewsData(articles);
                  const sentiment = newsManager.getAggregateSentiment(stock.symbol);
                  setNewsSentiment(sentiment);
                  console.log(`âœ… Received ${articles.length} news articles with ${sentiment.label} sentiment`);
                };
                
                newsManager.subscribe(stock.symbol, newsCallback);
                
                // Cleanup function will be called when tab changes or modal closes
              } catch (error) {
                console.error(`âŒ Error fetching news for ${stock.symbol}:`, error);
                setNewsData([]);
                setSocialLoading(false);
              } finally {
                setNewsLoading(false);
              }
            }
            
            if (activeTab === 'analyst-ratings' && !analystRatingsData) {
              console.log(`ğŸ“Š Fetching comprehensive analyst data for ${stock.symbol}...`);
              
              // Fetch ALL available analyst endpoints
              const [
                ratingsSnap, 
                gradesSum, 
                gradesHist,
                gradesHistorical,
                gradesConsensus,
                priceTargetSummary,
                priceTargetConsensus
              ] = await Promise.all([
                fetch(`https://financialmodelingprep.com/stable/ratings-snapshot?symbol=${stock.symbol}&apikey=${FMP_API_KEY}`).then(r => r.json()).catch(() => null),
                fetch(`https://financialmodelingprep.com/stable/grades?symbol=${stock.symbol}&apikey=${FMP_API_KEY}`).then(r => r.json()).catch(() => null),
                fetch(`https://financialmodelingprep.com/stable/grades?symbol=${stock.symbol}&limit=20&apikey=${FMP_API_KEY}`).then(r => r.json()).catch(() => []),
                fetch(`https://financialmodelingprep.com/stable/grades-historical?symbol=${stock.symbol}&apikey=${FMP_API_KEY}`).then(r => r.json()).catch(() => []),
                fetch(`https://financialmodelingprep.com/stable/grades-consensus?symbol=${stock.symbol}&apikey=${FMP_API_KEY}`).then(r => r.json()).catch(() => null),
                fetch(`https://financialmodelingprep.com/stable/price-target-summary?symbol=${stock.symbol}&apikey=${FMP_API_KEY}`).then(r => r.json()).catch(() => null),
                fetch(`https://financialmodelingprep.com/stable/price-target-consensus?symbol=${stock.symbol}&apikey=${FMP_API_KEY}`).then(r => r.json()).catch(() => null)
              ]);
              
              const ratingsSnapshot = Array.isArray(ratingsSnap) ? ratingsSnap[0] : ratingsSnap;
              const gradesSummary = Array.isArray(gradesSum) ? gradesSum[0] : gradesSum;
              // Use /grades endpoint (has gradingCompany field) instead of /grades-historical (consensus data)
              const gradesHistoricalData = Array.isArray(gradesHist) && gradesHist.length > 0 ? gradesHist : (Array.isArray(gradesHistorical) ? gradesHistorical : []);
              const consensusData = Array.isArray(gradesConsensus) ? gradesConsensus[0] : gradesConsensus;
              const priceTargetSummaryData = Array.isArray(priceTargetSummary) ? priceTargetSummary[0] : priceTargetSummary;
              const priceTargetConsensusData = Array.isArray(priceTargetConsensus) ? priceTargetConsensus[0] : priceTargetConsensus;
              
              console.log(`âœ… Analyst data loaded:`, {
                ratingsSnapshot: ratingsSnapshot ? 'YES' : 'NO',
                gradesSummary: gradesSummary ? 'YES' : 'NO',
                gradesHistorical: gradesHistoricalData?.length || 0,
                gradesConsensus: consensusData ? 'YES' : 'NO',
                priceTargetSummary: priceTargetSummaryData ? 'YES' : 'NO',
                priceTargetConsensus: priceTargetConsensusData ? 'YES' : 'NO'
              });
              
              // Log first grade entry to see available fields
              if (gradesHistoricalData?.length > 0) {
                console.log(`ğŸ“‹ Sample grade data (first entry):`, gradesHistoricalData[0]);
                console.log(`ğŸ“‹ Available keys:`, Object.keys(gradesHistoricalData[0]));
                console.log(`ğŸ“‹ Full first 3 grades:`, gradesHistoricalData.slice(0, 3));
              }
              
              setAnalystRatingsData({
                snapshot: ratingsSnapshot,
                consensus: consensusData || gradesSummary,
                recentGrades: gradesHistoricalData || [],
                priceTarget: priceTargetConsensusData || priceTargetSummaryData,
                priceTargetSummary: priceTargetSummaryData,
                priceTargetConsensus: priceTargetConsensusData
              });
            }
            
                         if (activeTab === 'insider' && !insiderData) {
              try {
                console.log(`ğŸ“Š Fetching insider trading data for ${stock.symbol}...`);
                console.log(`ğŸ”‘ Using FMP API Key: ${FMP_API_KEY.substring(0, 10)}...`);
                
                // Fetch both statistics and latest transactions
                const [statsResponse, latestResponse] = await Promise.all([
                  fetch(`https://financialmodelingprep.com/stable/insider-trading/statistics?symbol=${stock.symbol}&apikey=${FMP_API_KEY}`),
                  fetch(`https://financialmodelingprep.com/stable/insider-trading/latest?symbol=${stock.symbol}&page=0&limit=50&apikey=${FMP_API_KEY}`)
                ]);
                
                console.log(`ğŸ“¡ Statistics response: ${statsResponse.status}`);
                console.log(`ğŸ“¡ Latest trades response: ${latestResponse.status}`);
                
                // Check for premium requirement
                if ((statsResponse.status === 403 || statsResponse.status === 402) && 
                    (latestResponse.status === 403 || latestResponse.status === 402)) {
                  console.warn("âš ï¸ Insider trading data requires FMP Premium subscription.");
                  setInsiderData('PREMIUM_REQUIRED');
                  return;
                }

                let statistics = null;
                let latestTrades = [];
                
                // Process statistics
                if (statsResponse.ok) {
                  const statsData = await statsResponse.json();
                  console.log(`âœ… Statistics data received, length: ${statsData?.length || 0}`);
                  
                  if (Array.isArray(statsData) && statsData.length > 0) {
                    // Calculate totals from recent quarters (last 4 quarters = 1 year)
                    const recentData = statsData.slice(0, 4);
                    const totalBought = recentData.reduce((sum, q) => sum + (q.totalAcquired || 0), 0);
                    const totalSold = recentData.reduce((sum, q) => sum + (q.totalDisposed || 0), 0);
                    const totalAcquiredTx = recentData.reduce((sum, q) => sum + (q.acquiredTransactions || 0), 0);
                    const totalDisposedTx = recentData.reduce((sum, q) => sum + (q.disposedTransactions || 0), 0);
                    
                    statistics = {
                      totalBought,
                      totalSold,
                      totalTransactions: totalAcquiredTx + totalDisposedTx,
                      totalBoughtValue: 0,
                      totalSoldValue: 0
                    };
                    console.log(`ğŸ“Š Statistics: ${totalAcquiredTx + totalDisposedTx} trades, ${totalBought} bought, ${totalSold} sold`);
                  }
                }
                
                // Process latest individual trades
                if (latestResponse.ok) {
                  const tradesData = await latestResponse.json();
                  console.log(`âœ… Latest trades received, length: ${tradesData?.length || 0}`);
                  
                  if (Array.isArray(tradesData) && tradesData.length > 0) {
                    latestTrades = tradesData;
                  }
                }
                
                // Set combined data
                if (statistics || latestTrades.length > 0) {
                  setInsiderData({
                    statistics,
                    latestTrades,
                    type: 'combined'
                  });
                } else {
                  console.warn('No insider data available');
                  setInsiderData([]);
                }

              } catch (error) {
                console.error(`âŒ Error fetching insider data for ${stock.symbol}:`, error);
                setInsiderData([]);
              }
            }
            
            if (activeTab === 'earnings' && !analystEstimates) {
              try {
                console.log(`ğŸ“Š Fetching earnings data for ${stock.symbol}...`);
                
                // Fetch earnings calendar (historical earnings with estimates and actuals)
                const earningsResp = await fetch(
                  `https://financialmodelingprep.com/stable/earnings?symbol=${stock.symbol}&apikey=${FMP_API_KEY}`
                );
                
                if (!earningsResp.ok) {
                  console.error('Failed to fetch earnings calendar');
                  setAnalystEstimates({ annual: [], quarterly: [] });
                  return;
                }
                
                const earningsData = await earningsResp.json();
                
                console.log(`âœ… Earnings raw data:`, {
                  total: Array.isArray(earningsData) ? earningsData.length : 0,
                  sample: earningsData[0],
                  fields: earningsData[0] ? Object.keys(earningsData[0]) : []
                });
                
                // Separate into annual and quarterly based on date patterns
                const quarterly = Array.isArray(earningsData) ? earningsData.slice(0, 12) : [];
                const annual = [];
                
                // Transform the data to match the expected format
                const transformedQuarterly = quarterly.map(item => ({
                  date: item.date,
                  estimatedEpsAvg: item.epsEstimated || 0,
                  eps: item.epsActual || null,
                  estimatedRevenueAvg: item.revenueEstimated || 0,
                  revenue: item.revenueActual || null,
                  numberAnalystEstimatedEps: 1
                }));
                
                setAnalystEstimates({
                  annual: annual,
                  quarterly: transformedQuarterly
                });
                
                console.log(`âœ… Transformed earnings data:`, {
                  quarterly: transformedQuarterly.length,
                  firstItem: transformedQuarterly[0]
                });
              } catch (error) {
                console.error(`âŒ Error fetching earnings data for ${stock.symbol}:`, error);
                setAnalystEstimates({ annual: [], quarterly: [] });
              }
            }
            
            if (activeTab === 'financials' && !incomeStatement) {
              const response = await fetch(`https://financialmodelingprep.com/stable/income-statement?symbol=${stock.symbol}&apikey=${FMP_API_KEY}`);
              if (!response.ok) throw new Error('Failed to fetch financials');
              setIncomeStatement(await response.json());
            }
            
            if (activeTab === 'charts') {
              const needsPrimary = (!historicalData) || (historicalMeta.symbol !== stock.symbol) || (historicalMeta.timeframe !== chartTimeframe);
              if (needsPrimary) {
                const response = await fetch(`https://financialmodelingprep.com/stable/historical-chart/${chartTimeframe}?symbol=${stock.symbol}&apikey=${FMP_API_KEY}`);
                if (!response.ok) throw new Error('Failed to fetch historical data');
                const data = await response.json();
                const normalized = Array.isArray(data) ? data.slice(0, 400).reverse() : [];
                setHistoricalData(normalized);
                setHistoricalMeta({ symbol: stock.symbol, timeframe: chartTimeframe });
              }

              const cmp = (comparisonSymbol || '').trim().toUpperCase();
              const needsCompare = cmp && ((comparisonMeta.symbol !== cmp) || (comparisonMeta.timeframe !== chartTimeframe));
              if (!cmp) {
                if (comparisonData) setComparisonData(null);
                if (comparisonMeta.symbol) setComparisonMeta({ symbol: null, timeframe: null });
              } else if (needsCompare) {
                setComparisonLoading(true);
                try {
                  const resp = await fetch(`https://financialmodelingprep.com/stable/historical-chart/${chartTimeframe}?symbol=${cmp}&apikey=${FMP_API_KEY}`);
                  if (!resp.ok) throw new Error('Failed to fetch comparison data');
                  const d = await resp.json();
                  setComparisonData(Array.isArray(d) ? d.slice(0, 400).reverse() : []);
                  setComparisonMeta({ symbol: cmp, timeframe: chartTimeframe });
                } catch (e) {
                  console.warn('Comparison fetch failed:', e?.message || e);
                  setComparisonData(null);
                  setComparisonMeta({ symbol: null, timeframe: null });
                } finally {
                  setComparisonLoading(false);
                }
              }
            }
            
            if (activeTab === 'technicals' && !technicalData) {
              const [sma50, sma200, ema20, rsi, stdDev, adx, ratingsSnap, ratingsHist] = await Promise.all([
                fetch(`https://financialmodelingprep.com/stable/technical-indicators/sma?symbol=${stock.symbol}&periodLength=50&timeframe=1day&apikey=${FMP_API_KEY}`).then(r => r.json()).catch(() => []),
                fetch(`https://financialmodelingprep.com/stable/technical-indicators/sma?symbol=${stock.symbol}&periodLength=200&timeframe=1day&apikey=${FMP_API_KEY}`).then(r => r.json()).catch(() => []),
                fetch(`https://financialmodelingprep.com/stable/technical-indicators/ema?symbol=${stock.symbol}&periodLength=20&timeframe=1day&apikey=${FMP_API_KEY}`).then(r => r.json()).catch(() => []),
                fetch(`https://financialmodelingprep.com/stable/technical-indicators/rsi?symbol=${stock.symbol}&periodLength=14&timeframe=1day&apikey=${FMP_API_KEY}`).then(r => r.json()).catch(() => []),
                fetch(`https://financialmodelingprep.com/stable/technical-indicators/standarddeviation?symbol=${stock.symbol}&periodLength=20&timeframe=1day&apikey=${FMP_API_KEY}`).then(r => r.json()).catch(() => []),
                fetch(`https://financialmodelingprep.com/stable/technical-indicators/adx?symbol=${stock.symbol}&periodLength=14&timeframe=1day&apikey=${FMP_API_KEY}`).then(r => r.json()).catch(() => []),
                fetch(`https://financialmodelingprep.com/stable/ratings-snapshot?symbol=${stock.symbol}&apikey=${FMP_API_KEY}`).then(r => r.json()).catch(() => null),
                fetch(`https://financialmodelingprep.com/stable/ratings-historical?symbol=${stock.symbol}&apikey=${FMP_API_KEY}`).then(r => r.json()).catch(() => [])
              ]);
              
              setTechnicalData({
                sma50: sma50[0]?.sma,
                sma200: sma200[0]?.sma,
                ema20: ema20[0]?.ema,
                rsi: rsi[0]?.rsi,
                stdDev: stdDev[0]?.standardDeviation,
                adx: adx[0]?.adx,
              });
              
              // Handle ratings data properly
              const snapshotData = Array.isArray(ratingsSnap) ? ratingsSnap[0] : ratingsSnap;
              
              console.log(`ğŸ“Š Ratings data for ${stock.symbol}:`, {
                snapshot: snapshotData ? 'LOADED' : 'MISSING',
                ratingScore: snapshotData?.ratingScore || 'N/A',
                recommendation: snapshotData?.ratingRecommendation || 'N/A'
              });
              
              setRatingsData({
                snapshot: snapshotData,
                history: ratingsHist || []
              });
            }
            
            if (activeTab === 'ai-predictions' && !aiAnalysis) {
              console.log(`ğŸ¤– AI PREDICTIONS TAB - Starting analysis for ${stock.symbol}`);
              console.log('ğŸ” Current aiAnalysis state:', aiAnalysis);
              console.log('ğŸ” Current aiLoading state:', aiLoading);
              setLoadingTabData(false); // AI tab has its own loading state
              setAiLoading(true);
              try {
                console.log('ğŸ“¡ Calling aiAnalyzer.analyzeStock...');
                const analysis = await aiAnalyzer.analyzeStock(stock);
                console.log('âœ… AI Analysis received:', analysis);
                console.log('âœ… Analysis has recommendations?', !!analysis?.recommendation);
                console.log('âœ… Analysis has predictions?', !!analysis?.predictions);
                setAiAnalysis(analysis);
                console.log('âœ… setAiAnalysis() called successfully');
              } catch (err) {
                console.error('âŒ AI Analysis error:', err);
                // Set fallback analysis on error
                console.log('ğŸ”„ Using fallback analysis...');
                const fallback = aiAnalyzer.getFallbackAnalysis(stock);
                console.log('ğŸ”„ Fallback data:', fallback);
                setAiAnalysis(fallback);
              } finally {
                setAiLoading(false);
                console.log('âœ… AI loading state set to false');
              }
            }
          } catch (err) {
            console.error(`Error loading ${activeTab} data:`, err);
            setError(err.message);
          }
          setLoadingTabData(false);
        };
        
        if (['insider', 'earnings', 'financials', 'charts', 'technicals', 'analyst-ratings', 'ai-predictions', 'news-sentiment'].includes(activeTab)) {
          loadTabData();
        }
        
        // Portfolio Analysis
        if (activeTab === 'portfolio' && !portfolioOptimization) {
          runPortfolioOptimization();
        }
        
        // Similar Stocks
        if (activeTab === 'similar' && selectedStock && !similarStocks) {
          findSimilarStocks();
        }
        
        // Heatmap (prepare data)
        if (activeTab === 'heatmap' && !heatmapData && stocks.length > 0) {
          setHeatmapData(stocks);
        }
      }, [activeTab, stock.symbol, chartTimeframe, comparisonSymbol]);
      
      // Cleanup news subscriptions when modal closes
      useEffect(() => {
        return () => {
          if (stock?.symbol) {
            console.log(`ğŸ§¹ Cleaning up news subscription for ${stock.symbol}`);
            newsManager.stopPolling(stock.symbol);
          }
        };
      }, [stock?.symbol]);

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div id="stock-modal-content" className="glass-elevated rounded-2xl max-w-6xl w-full mx-auto my-8 animate-slide-up max-h-[90vh] overflow-hidden flex flex-col" onClick={(e) => e.stopPropagation()}>
            {/* Header */}
            <div className="flex items-start justify-between p-6 border-b border-slate-700/30 flex-shrink-0">
              <div>
                <div className="flex items-center gap-4 mb-2">
                  <h2 className="text-3xl font-bold text-white">{stock.symbol}</h2>
                  <span className="chip bg-slate-700 text-slate-300">{stock.sector || 'Unknown'}</span>
                  <span className="chip bg-slate-700 text-slate-300">{stock.industry || 'Unknown'}</span>
                  {stock.index && <span className="chip bg-cyan-600/20 text-cyan-400 border border-cyan-500/30">{stock.index}</span>}
                </div>
                <div className="flex items-center gap-4 text-sm">
                  <span className="text-slate-400">{stock.companyName || stock.name || 'â€”'}</span>
                </div>
              </div>
              <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>

            {/* Tabs */}
            <div className="flex gap-2 px-6 pt-4 border-b border-slate-700/30 overflow-x-auto flex-shrink-0">
              {['overview', 'simplified', 'ai-analysis', 'news-sentiment', 'fundamentals', 'charts', 'technicals', 'analyst-ratings', 'insider', 'earnings', 'financials'].map(tab => (
                <button key={tab} onClick={() => setActiveTab(tab)} className={`tab-btn ${activeTab === tab ? 'active' : ''}`}>
                  {tab === 'simplified' ? 'ğŸ’¡ Simplified' :
                   tab === 'ai-analysis' ? 'ğŸ¤– AI Analysis' :
                   tab === 'news-sentiment' ? 'ğŸ“° News & Sentiment' :
                   tab === 'insider' ? 'ğŸ” Insider Â· Advanced' : 
                   tab === 'analyst-ratings' ? 'â­ Analyst Ratings' :
                   tab === 'earnings' ? 'ğŸ“ˆ Earnings' : 
                   tab === 'financials' ? 'ğŸ’° Financials Â· Advanced' :
                   tab === 'charts' ? 'ğŸ“ˆ Charts Â· Advanced' :
                   tab.charAt(0).toUpperCase() + tab.slice(1)}
                </button>
              ))}
            </div>

            {/* Tab Content */}
            <div className="p-6 overflow-y-auto flex-1">
              {error && (
                <div className="mb-4 p-4 bg-red-500/10 border border-red-500/20 rounded-lg">
                  <div className="flex items-center gap-2 text-red-400">
                    <i className="fas fa-exclamation-triangle"></i>
                    <span className="font-semibold">Error loading data:</span>
                  </div>
                  <p className="text-sm text-slate-300 mt-1">{error}</p>
                  <button 
                    onClick={() => setError(null)}
                    className="mt-2 text-xs text-red-400 hover:text-red-300"
                  >
                    Dismiss
                  </button>
                </div>
              )}
              
              {loadingTabData ? (
                <div className="text-center py-12">
                  <div className="animate-pulse text-cyan-400 text-4xl mb-4">
                    <i className="fas fa-spinner animate-spin"></i>
                  </div>
                  <div className="text-slate-400">Loading {activeTab} data...</div>
                </div>
              ) : activeTab === 'overview' ? (
                <div className="space-y-6">
                  {/* Price & Actions */}
                  <div className="grid grid-cols-4 gap-4">
                    <div className="glass-card p-5 rounded-xl relative">
                      <div className="text-xs text-slate-500 mb-1 flex items-center gap-2">
                        <span>Current Price</span>
                        {isLiveUpdating && (
                          <span className="flex items-center gap-1 text-green-400 animate-pulse">
                            <div className="w-1.5 h-1.5 bg-green-400 rounded-full"></div>
                            LIVE
                          </span>
                        )}
                      </div>
                      <div className={`text-3xl font-bold text-white transition-all ${isLiveUpdating ? 'scale-105' : ''}`}>
                        ${livePrice?.toFixed(2) || stock.price?.toFixed(2) || 'â€”'}
                      </div>
                      <div className={`text-sm font-semibold mt-1 ${getSentimentColor(liveChangePct || stock.changePct)}`}>
                        {formatPercent(liveChangePct || stock.changePct, 2)}
                      </div>
                      
                      {/* Mini price chart */}
                      {priceHistory.length > 5 && (
                        <div className="mt-2 h-8 flex items-end gap-0.5">
                          {priceHistory.slice(-20).map((point, i) => {
                            const min = Math.min(...priceHistory.slice(-20).map(p => p.price));
                            const max = Math.max(...priceHistory.slice(-20).map(p => p.price));
                            const range = max - min;
                            const height = range > 0 ? ((point.price - min) / range) * 100 : 50;
                            const color = i > 0 && point.price >= priceHistory[priceHistory.length - 20 + i - 1]?.price
                              ? 'bg-green-500'
                              : 'bg-red-500';
                            
                            return (
                              <div
                                key={i}
                                className={`flex-1 ${color} opacity-50 rounded-t`}
                                style={{ height: `${height}%`, minHeight: '2px' }}
                              ></div>
                            );
                          })}
                        </div>
                      )}
                    </div>
                    <div className="glass-card p-5 rounded-xl">
                      <div className="text-xs text-slate-500 mb-1">Market Cap</div>
                      <div className="text-2xl font-bold text-white">{formatNumber(stock.marketCap)}</div>
                    </div>
                    <div className="glass-card p-5 rounded-xl">
                      <div className="text-xs text-slate-500 mb-1 flex items-center gap-1">
                        ğŸ˜´ Sleep-Well Score
                        <span className="text-slate-600 cursor-help" title="How comfortable you can sleep owning this stock - based on volatility, debt, and technical signals">?</span>
                      </div>
                      <div className={`text-3xl font-bold ${
                        calcSleepWellScore(stock) >= 80 ? 'text-green-400' : 
                        calcSleepWellScore(stock) >= 60 ? 'text-yellow-400' : 
                        'text-red-400'
                      }`}>
                        {calcSleepWellScore(stock)}/100
                      </div>
                      <div className="text-xs text-slate-500 mt-1">
                        {calcSleepWellScore(stock) >= 80 ? 'Rest easy' : 
                         calcSleepWellScore(stock) >= 60 ? 'Fair volatility' : 
                         'Higher risk'}
                      </div>
                    </div>
                    <div className="glass-card p-5 rounded-xl">
                      <div className="text-xs text-slate-500 mb-1 flex items-center gap-1">
                        ğŸ“Š Stock Grade
                        <span className="text-slate-600 cursor-help" title="Overall grade based on valuation, growth, financial health, and profitability">?</span>
                      </div>
                      <div className={`text-3xl font-bold ${
                        calculateStockGrade(stock).letterGrade === 'A' ? 'text-green-400' : 
                        calculateStockGrade(stock).letterGrade === 'B' ? 'text-blue-400' : 
                        calculateStockGrade(stock).letterGrade === 'C' ? 'text-yellow-400' : 
                        calculateStockGrade(stock).letterGrade === 'D' ? 'text-orange-400' : 
                        'text-red-400'
                      }`}>
                        {calculateStockGrade(stock).letterGrade}
                      </div>
                      <div className="text-xs text-slate-500 mt-1">
                        {calculateStockGrade(stock).percentage}% score
                      </div>
                    </div>
                    <div className="glass-card p-5 rounded-xl flex items-center justify-center">
                      <button onClick={() => toggleWatchlist(stock.symbol)} className={`px-6 py-3 rounded-lg font-semibold text-sm transition ${isWatchlisted ? 'bg-cyan-500/20 text-cyan-400 border border-cyan-500/30' : 'bg-slate-700 text-slate-300 hover:bg-slate-600'}`}>
                        {isWatchlisted ? 'â˜… Watchlisted' : 'â˜† Add to Watchlist'}
                      </button>
                    </div>
                  </div>

                  {/* ML Price Prediction */}
                  {stock.mlPrediction && stock.mlPrediction.predPct != null && (
                    <div className="glass-card p-6 rounded-xl border border-purple-500/20">
                      <div className="flex items-center justify-between mb-4">
                        <div className="flex items-center gap-2">
                          <i className="fas fa-robot text-purple-400 text-xl"></i>
                          <h3 className="text-lg font-bold text-white">ML 30-Day Forecast</h3>
                          <span className="chip bg-purple-500/20 text-purple-400 text-xs">
                            <i className="fas fa-brain mr-1"></i>
                            TensorFlow.js
                          </span>
                        </div>
                      </div>
                      
                      <div className="grid grid-cols-3 gap-4">
                        <div className="glass-card p-4 rounded-lg text-center">
                          <div className="text-xs text-slate-500 mb-2">Predicted Change</div>
                          <div className={`text-3xl font-bold ${
                            stock.mlPrediction.predPct > 0 ? 'text-green-400' : 
                            stock.mlPrediction.predPct < 0 ? 'text-red-400' : 
                            'text-slate-400'
                          }`}>
                            {formatMLPrediction(stock.mlPrediction.predPct)}
                          </div>
                          {stock.mlPrediction.predictedPrice && (
                            <div className="text-xs text-slate-500 mt-2">
                              Target: ${stock.mlPrediction.predictedPrice}
                            </div>
                          )}
                        </div>
                        
                        <div className="glass-card p-4 rounded-lg text-center">
                          <div className="text-xs text-slate-500 mb-2">Confidence</div>
                          <div className="text-3xl font-bold text-white">
                            {stock.mlPrediction.conf}%
                          </div>
                          <div className="text-xs text-slate-500 mt-2">
                            {stock.mlPrediction.conf >= 70 ? 'High' : stock.mlPrediction.conf >= 50 ? 'Medium' : 'Low'}
                          </div>
                        </div>
                        
                        <div className="glass-card p-4 rounded-lg text-center">
                          <div className="text-xs text-slate-500 mb-2">Trend Signal</div>
                          <div className="text-2xl font-bold">
                            {stock.mlPrediction.trend === 'bullish' ? 'ğŸ”¼' : 
                             stock.mlPrediction.trend === 'bearish' ? 'ğŸ”½' : 'â¡ï¸'}
                          </div>
                          <div className={`text-sm font-semibold mt-2 ${
                            stock.mlPrediction.trend === 'bullish' ? 'text-green-400' : 
                            stock.mlPrediction.trend === 'bearish' ? 'text-red-400' : 
                            'text-slate-400'
                          }`}>
                            {stock.mlPrediction.trend.charAt(0).toUpperCase() + stock.mlPrediction.trend.slice(1)}
                          </div>
                        </div>
                      </div>
                      
                      {stock.mlPrediction.interpretation && (
                        <div className="mt-3 p-3 bg-gradient-to-r from-purple-900/30 to-blue-900/30 border border-purple-700/50 rounded-lg">
                          <div className="flex items-start gap-2">
                            <i className="fas fa-chart-line text-purple-400 text-sm mt-0.5"></i>
                            <div className="flex-1">
                              <div className="text-xs font-semibold text-purple-300 mb-1">Model Interpretation</div>
                              <div className="text-xs text-slate-300 leading-relaxed">
                                {stock.mlPrediction.interpretation}
                              </div>
                            </div>
                          </div>
                        </div>
                      )}
                      
                      <div className="mt-4 p-3 bg-slate-800/40 border border-slate-700/50 rounded-lg">
                        <div className="flex items-start gap-2">
                          <i className="fas fa-info-circle text-purple-400 text-sm mt-0.5"></i>
                          <div className="flex-1">
                            <div className="text-xs font-semibold text-purple-300 mb-1">How it works</div>
                            <div className="text-xs text-slate-400 leading-relaxed">
                              This prediction uses TensorFlow.js to analyze the last 60 days of price history with linear regression. 
                              It forecasts short-term price movement based on recent trends. Remember: ML predictions are estimates, 
                              not guarantees. Always combine with fundamental analysis.
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}

                  {/* AI Verdict */}
                  {stock.verdict && (
                    <div className={`p-6 rounded-xl ${stock.verdict === 'STRONG BUY' || stock.verdict === 'BUY' ? 'verdict-bullish' : stock.verdict === 'SELL' || stock.verdict === 'REDUCE' ? 'verdict-bearish' : 'verdict-neutral'}`}>
                      <div className="flex items-center justify-between mb-3">
                        <div className="flex items-center gap-3">
                          <span className="text-2xl font-bold text-white">{stock.verdict}</span>
                          <span className="badge bg-slate-800/50 text-slate-300">Score: {stock.aiScore || 0}/100</span>
                          <span className="badge bg-slate-800/50 text-slate-300">Confidence: {stock.confidence || 0}%</span>
                        </div>
                      </div>
                      <div className="text-sm text-slate-300 leading-relaxed mb-4">{stock.execSummary || 'AI analysis unavailable'}</div>
                      
                      {/* Subscores */}
                      {stock.subscores && (
                        <div className="grid grid-cols-3 gap-3 mb-4">
                          <div className="glass-card p-3 rounded-lg">
                            <div className="text-xs text-slate-500 mb-1">Fundamentals</div>
                            <div className="text-lg font-bold text-white">{Math.round(stock.subscores.fundamental)}/100</div>
                          </div>
                          <div className="glass-card p-3 rounded-lg">
                            <div className="text-xs text-slate-500 mb-1">Technicals</div>
                            <div className="text-lg font-bold text-white">{Math.round(stock.subscores.technical)}/100</div>
                          </div>
                          <div className="glass-card p-3 rounded-lg">
                            <div className="text-xs text-slate-500 mb-1">Risk Level</div>
                            <div className="text-lg font-bold text-white">{Math.round(stock.subscores.risk)}/100</div>
                          </div>
                        </div>
                      )}

                      {/* Explainable AI (why + changes + sensitivity) */}
                      <div className="mb-4">
                        <button
                          onClick={() => setShowExplainScore(v => !v)}
                          className="px-3 py-1.5 rounded-lg text-xs font-semibold bg-slate-800/60 hover:bg-slate-700/60 border border-slate-700/60 text-slate-200"
                        >
                          {showExplainScore ? 'Hide explanation' : 'Explain this rating'}
                        </button>
                      </div>

                      {showExplainScore && (
                        <div className="space-y-4 mb-4">
                          <div className="glass-card p-4 rounded-xl">
                            <div className="flex items-center justify-between mb-2">
                              <div className="text-xs font-bold text-slate-300 uppercase">How the score is computed</div>
                              <div className="text-xs text-slate-400">Weights: 55% Fundamentals Â· 35% Technicals Â· 10% Risk</div>
                            </div>
                            <div className="text-xs text-slate-300 leading-relaxed">
                              Deterministic rules adjust the subscores, then the final score is computed as{' '}
                              <span className="font-mono">0.55Ã—Fundamentals + 0.35Ã—Technicals + 0.10Ã—(100âˆ’Risk)</span>.
                            </div>
                          </div>

                          <div className="glass-card p-4 rounded-xl">
                            <div className="flex items-center justify-between mb-3">
                              <div className="text-xs font-bold text-slate-300 uppercase">Top drivers (impact on score)</div>
                              <div className="text-xs text-slate-400">
                                Current: {explainNow.score}/100
                                {explainThresholds?.nextUpScore != null ? ` Â· Next upgrade: ${explainThresholds.nextUpScore} (+${explainThresholds.toNextUp})` : ''}
                              </div>
                            </div>
                            <div className="space-y-2">
                              {(explainNow.topImpacts || []).length === 0 ? (
                                <div className="text-xs text-slate-500">No rule-level drivers available.</div>
                              ) : (explainNow.topImpacts || []).map((d, i) => (
                                <div key={i} className="flex items-start justify-between gap-3 text-xs">
                                  <div className="flex-1">
                                    <div className="font-semibold text-slate-200">{d.label}</div>
                                    <div className="text-slate-400 mt-0.5">{d.detail}</div>
                                  </div>
                                  <div className={`font-mono font-bold ${d.impact >= 0 ? 'text-green-300' : 'text-red-300'}`}>
                                    {d.impact >= 0 ? '+' : ''}{d.impact.toFixed(1)}
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>

                          <div className="glass-card p-4 rounded-xl">
                            <div className="text-xs font-bold text-slate-300 uppercase mb-2">What changed since last snapshot</div>
                            {!prevAnalysis ? (
                              <div className="text-xs text-slate-500">No previous snapshot found yet (refresh once to start tracking changes).</div>
                            ) : (
                              <div className="space-y-2 text-xs">
                                <div className="text-slate-400">
                                  Previous saved: {prevSnapshotEntry?.timestamp ? `${Math.max(1, Math.round((Date.now() - prevSnapshotEntry.timestamp) / 60000))} min ago` : 'â€”'}
                                </div>
                                <div className="flex items-center justify-between">
                                  <div className="text-slate-300">AI Score</div>
                                  <div className="font-mono font-bold text-white">
                                    {num(prevAnalysis.aiScore, 0)} â†’ {num(stock.aiScore, 0)}
                                    <span className={`ml-2 ${num(stock.aiScore, 0) - num(prevAnalysis.aiScore, 0) >= 0 ? 'text-green-300' : 'text-red-300'}`}>
                                      ({num(stock.aiScore, 0) - num(prevAnalysis.aiScore, 0) >= 0 ? '+' : ''}{num(stock.aiScore, 0) - num(prevAnalysis.aiScore, 0)})
                                    </span>
                                  </div>
                                </div>
                                <div className="grid grid-cols-3 gap-2">
                                  <div className="bg-slate-800/40 border border-slate-700/40 rounded-lg p-2">
                                    <div className="text-slate-500">Fundamentals</div>
                                    <div className="font-mono text-slate-200">{Math.round(num(prevAnalysis.subscores?.fundamental, 0))} â†’ {Math.round(num(stock.subscores?.fundamental, 0))}</div>
                                  </div>
                                  <div className="bg-slate-800/40 border border-slate-700/40 rounded-lg p-2">
                                    <div className="text-slate-500">Technicals</div>
                                    <div className="font-mono text-slate-200">{Math.round(num(prevAnalysis.subscores?.technical, 0))} â†’ {Math.round(num(stock.subscores?.technical, 0))}</div>
                                  </div>
                                  <div className="bg-slate-800/40 border border-slate-700/40 rounded-lg p-2">
                                    <div className="text-slate-500">Risk</div>
                                    <div className="font-mono text-slate-200">{Math.round(num(prevAnalysis.subscores?.risk, 0))} â†’ {Math.round(num(stock.subscores?.risk, 0))}</div>
                                  </div>
                                </div>
                              </div>
                            )}
                          </div>

                          <div className="glass-card p-4 rounded-xl">
                            <div className="text-xs font-bold text-slate-300 uppercase mb-2">Sensitivity (what would move the rating)</div>
                            {(sensitivity || []).length === 0 ? (
                              <div className="text-xs text-slate-500">No high-impact single-factor sensitivities detected.</div>
                            ) : (
                              <div className="space-y-2">
                                {(sensitivity || []).map((s, i) => (
                                  <div key={i} className="flex items-start justify-between gap-3 text-xs">
                                    <div className="flex-1">
                                      <div className="font-semibold text-slate-200">{s.title}</div>
                                      <div className="text-slate-400 mt-0.5">{s.note}</div>
                                    </div>
                                    <div className={`font-mono font-bold ${s.delta >= 0 ? 'text-green-300' : 'text-red-300'}`}>
                                      {s.delta >= 0 ? '+' : ''}{s.delta} â†’ {s.newScore}
                                    </div>
                                  </div>
                                ))}
                              </div>
                            )}
                            <div className="mt-3 text-xs text-slate-500">
                              Sensitivities change one input at a time to the nearest model threshold (not a forecast).
                            </div>
                          </div>
                        </div>
                      )}

                      {/* Reassurance (emotional safety) */}
                      {stock.reassurance && (
                        <div className="mb-4 p-3 bg-slate-800/40 border border-slate-700/50 rounded-lg text-xs text-slate-300">
                          <span className="font-semibold text-slate-200">Note:</span> {stock.reassurance}
                        </div>
                      )}

                      {/* Score Drivers */}
                      {stock.topDrivers && (
                        <div className="grid grid-cols-2 gap-4 mb-4">
                          <div className="glass-card p-4 rounded-xl">
                            <div className="text-xs font-bold text-green-400 mb-2 uppercase">What&apos;s helping</div>
                            <div className="space-y-2">
                              {(stock.topDrivers.positive || []).length === 0 ? (
                                <div className="text-xs text-slate-500">No strong positive drivers detected.</div>
                              ) : (stock.topDrivers.positive || []).map((d, i) => (
                                <div key={i} className="text-xs">
                                  <div className="font-semibold text-green-300">{d.factor}</div>
                                  <div className="text-slate-400 mt-0.5">{d.detail}</div>
                                </div>
                              ))}
                            </div>
                          </div>
                          <div className="glass-card p-4 rounded-xl">
                            <div className="text-xs font-bold text-red-400 mb-2 uppercase">What&apos;s hurting</div>
                            <div className="space-y-2">
                              {(stock.topDrivers.negative || []).length === 0 ? (
                                <div className="text-xs text-slate-500">No strong negative drivers detected.</div>
                              ) : (stock.topDrivers.negative || []).map((d, i) => (
                                <div key={i} className="text-xs">
                                  <div className="font-semibold text-red-300">{d.factor}</div>
                                  <div className="text-slate-400 mt-0.5">{d.detail}</div>
                                </div>
                              ))}
                            </div>
                          </div>
                        </div>
                      )}

                      {/* AI Takeaway (interpretive closure) */}
                      {stock.takeaway && (
                        <div className="mb-4 p-4 bg-cyan-500/10 border border-cyan-500/20 rounded-xl">
                          <div className="text-xs font-bold text-cyan-300 uppercase mb-2">AI Takeaway</div>
                          <div className="text-sm text-slate-200 leading-relaxed">{stock.takeaway}</div>
                        </div>
                      )}

                      {/* Bull/Bear Factors */}
                      {(stock.bullFactors || stock.bearFactors) && (
                        <div className="grid grid-cols-2 gap-4">
                          {/* Bullish Factors */}
                          <div>
                            <div className="text-xs font-bold text-green-400 mb-2 uppercase">Bullish Factors</div>
                            <div className="space-y-2">
                              {(showAllFactors ? (stock.bullFactors || []) : (stock.bullFactors || []).slice(0, 3)).map((f, i) => (
                                <div key={i} className="text-xs bg-green-500/10 border border-green-500/20 rounded-lg p-2">
                                  <div className="font-semibold text-green-300">{f.factor}</div>
                                  <div className="text-slate-400 mt-1">{f.detail}</div>
                                </div>
                              ))}
                            </div>
                          </div>

                          {/* Bearish Factors */}
                          <div>
                            <div className="text-xs font-bold text-red-400 mb-2 uppercase">Bearish Factors</div>
                            <div className="space-y-2">
                              {(showAllFactors ? (stock.bearFactors || []) : (stock.bearFactors || []).slice(0, 3)).map((f, i) => (
                                <div key={i} className="text-xs bg-red-500/10 border border-red-500/20 rounded-lg p-2">
                                  <div className="font-semibold text-red-300">{f.factor}</div>
                                  <div className="text-slate-400 mt-1">{f.detail}</div>
                                </div>
                              ))}
                            </div>
                          </div>
                        </div>
                      )}
                      
                      {((stock.bullFactors || []).length > 3 || (stock.bearFactors || []).length > 3) && (
                        <div className="mt-3 flex justify-center">
                          <button
                            onClick={() => setShowAllFactors(v => !v)}
                            className="px-3 py-1.5 rounded-lg text-xs font-semibold bg-slate-800/60 hover:bg-slate-700/60 border border-slate-700/60 text-slate-200"
                          >
                            {showAllFactors ? 'Show fewer factors' : 'Show all factors'}
                          </button>
                        </div>
                      )}
                    </div>
                  )}

                  {/* Thematic Context */}
                  {(() => {
                    const themesForStock = Object.values(THEMATIC_PORTFOLIOS).filter(theme => 
                      theme.stocks.includes(stock.symbol)
                    );
                    if (themesForStock.length === 0) return null;
                    return (
                      <div className="glass-card p-5 rounded-xl border border-cyan-500/20">
                        <div className="flex items-center gap-2 mb-3">
                          <i className="fas fa-layer-group text-cyan-400"></i>
                          <h4 className="text-sm font-bold text-cyan-400 uppercase tracking-wide">Part of Thematic Portfolios</h4>
                        </div>
                        <div className="flex flex-wrap gap-2">
                          {themesForStock.map(theme => (
                            <div
                              key={theme.id}
                              className="chip bg-cyan-500/10 text-cyan-400 border border-cyan-500/30 text-xs px-3 py-2 rounded-lg cursor-help"
                              title={theme.rationale}
                            >
                              <span className="mr-1">{theme.name}</span>
                              <span className="text-cyan-600">â€¢</span>
                              <span className="ml-1 text-slate-400">{theme.risk} risk</span>
                            </div>
                          ))}
                        </div>
                        <div className="mt-3 text-xs text-slate-400">
                          ğŸ’¡ This stock is included in our curated thematic baskets. Hover over a theme to see the investment rationale.
                        </div>
                      </div>
                    );
                  })()}

                  {/* Watchlist Guidance */}
                  {stock.watchlistGuidance && (
                    <div className="glass-card p-5 rounded-xl">
                      <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">{stock.watchlistGuidance.headline || 'What to watch next'}</h4>
                      <div className="grid grid-cols-3 gap-3">
                        {(stock.watchlistGuidance.items || []).map((it, idx) => (
                          <div key={idx} className="bg-slate-800/40 border border-slate-700/40 rounded-lg p-3">
                            <div className="text-xs text-slate-500 mb-1">{it.label}</div>
                            <div className="text-xs text-slate-200 leading-relaxed">{it.value}</div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* Export Actions */}
                  <div className="glass-card p-5 rounded-xl">
                    <div className="flex items-center justify-between">
                      <div>
                        <h4 className="text-sm font-bold text-white mb-1">Export Analysis</h4>
                        <p className="text-xs text-slate-400">Download this stock analysis as a professional PDF tear sheet</p>
                      </div>
                      <button 
                        onClick={() => exportStockTearSheet(stock)}
                        className="px-6 py-3 bg-gradient-to-r from-red-600 to-red-500 hover:from-red-500 hover:to-red-400 text-white rounded-lg font-bold flex items-center gap-2 shadow-lg shadow-red-500/20 transition-all"
                      >
                        <i className="fas fa-file-pdf text-lg"></i>
                        <span>Download PDF</span>
                      </button>
                    </div>
                  </div>

                  {/* Company Information */}
                  {(stock.description || stock.ceo || stock.website) && (
                    <div className="glass-card p-5 rounded-xl">
                      <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Company Info</h4>
                      {stock.description && (
                        <div className="mb-4">
                          <div className="text-xs text-slate-500 mb-1">Description</div>
                          <div className="text-sm text-slate-300 leading-relaxed">{stock.description}</div>
                        </div>
                      )}
                      <div className="grid grid-cols-2 gap-4 text-sm">
                        {stock.ceo && (
                          <div>
                            <div className="text-xs text-slate-500 mb-1">CEO</div>
                            <div className="text-white">{stock.ceo}</div>
                          </div>
                        )}
                        {stock.website && (
                          <div>
                            <div className="text-xs text-slate-500 mb-1">Website</div>
                            <a href={stock.website.startsWith('http') ? stock.website : `https://${stock.website}`} target="_blank" rel="noopener noreferrer" className="text-cyan-400 hover:underline">
                              {stock.website.replace(/^https?:\/\//, '')}
                            </a>
                          </div>
                        )}
                      </div>
                    </div>
                  )}
                </div>
              ) : activeTab === 'ai-analysis' ? (
                <div className="space-y-6">
                  {/* Header with Provider Selection */}
                  <div className="glass-card p-6 rounded-xl border border-purple-500/20">
                    <div className="flex items-center justify-between mb-4">
                      <div className="flex items-center gap-3">
                        <i className="fas fa-robot text-purple-400 text-2xl"></i>
                        <div>
                          <h3 className="text-xl font-bold text-white">AI Stock Analysis</h3>
                          <p className="text-sm text-slate-400">Professional analysis powered by advanced AI</p>
                        </div>
                      </div>
                      <button
                        onClick={async () => {
                          setAiLoading(true);
                          setDeepseekLoading(true);
                          setClaudeLoading(true);
                          
                          // Call both AIs simultaneously
                          Promise.all([
                            getDeepSeekAnalysis(stock)
                              .then(analysis => {
                                setDeepseekAnalysis(analysis);
                                setDeepseekLoading(false);
                              })
                              .catch(error => {
                                setDeepseekAnalysis(`Error: ${error.message}`);
                                setDeepseekLoading(false);
                              }),
                            getClaudeAnalysis(stock)
                              .then(analysis => {
                                setClaudeAnalysis(analysis);
                                setClaudeLoading(false);
                              })
                              .catch(error => {
                                setClaudeAnalysis(`Error: ${error.message}`);
                                setClaudeLoading(false);
                              })
                          ]).finally(() => {
                            setAiLoading(false);
                          });
                        }}
                        disabled={aiLoading}
                        className="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg font-semibold transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                      >
                        {aiLoading ? (
                          <>
                            <i className="fas fa-spinner animate-spin"></i>
                            Analyzing with Both AIs...
                          </>
                        ) : (
                          <>
                            <i className="fas fa-brain"></i>
                            {deepseekAnalysis || claudeAnalysis ? 'Refresh Dual Analysis' : 'Generate Dual AI Analysis'}
                          </>
                        )}
                      </button>
                    </div>
                    
                    {/* Dual AI Analysis Info */}
                    <div className="flex items-center gap-3 pt-4 border-t border-slate-700/30">
                      <i className="fas fa-info-circle text-blue-400"></i>
                      <span className="text-sm text-slate-400">Get independent analyses from both <strong className="text-blue-400">DeepSeek</strong> and <strong className="text-orange-400">Claude AI</strong> simultaneously</span>
                    </div>
                  </div>

                  {/* Dual AI Analysis Content */}
                  {aiLoading && !deepseekAnalysis && !claudeAnalysis ? (
                    <div className="glass-card p-12 rounded-xl text-center">
                      <i className="fas fa-robot text-purple-400 text-5xl mb-4 animate-pulse"></i>
                      <div className="text-xl font-bold text-white mb-2">Analyzing {stock.symbol}...</div>
                      <div className="text-slate-400">Both DeepSeek and Claude AIs are processing comprehensive stock data</div>
                    </div>
                  ) : deepseekAnalysis || claudeAnalysis ? (
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                      {/* DeepSeek Analysis */}
                      <div className="glass-card p-6 rounded-xl border-2 border-blue-500/30">
                        <div className="flex items-center gap-2 mb-4">
                          <span className="px-3 py-1 rounded-full font-semibold text-sm bg-blue-500/20 text-blue-400">
                            <i className="fas fa-rocket mr-2"></i>
                            DeepSeek AI
                          </span>
                          {deepseekLoading && (
                            <i className="fas fa-spinner animate-spin text-blue-400 ml-2"></i>
                          )}
                        </div>
                        {deepseekAnalysis ? (
                          <div className="prose prose-invert prose-slate max-w-none">
                            <div 
                              className="text-slate-200 leading-relaxed whitespace-pre-wrap"
                              style={{ 
                                fontFamily: 'system-ui, -apple-system, sans-serif',
                                fontSize: '0.9rem',
                                lineHeight: '1.6'
                              }}
                              dangerouslySetInnerHTML={{ 
                                __html: deepseekAnalysis
                                  .replace(/^# (.*?)$/gm, '<h1 class="text-xl font-bold text-white mt-4 mb-2">$1</h1>')
                                  .replace(/^## (.*?)$/gm, '<h2 class="text-lg font-bold text-white mt-3 mb-2">$1</h2>')
                                  .replace(/^### (.*?)$/gm, '<h3 class="text-base font-semibold text-white mt-3 mb-1">$1</h3>')
                                  .replace(/^\* (.*?)$/gm, '<li class="ml-4 mb-1 text-sm">â€¢ $1</li>')
                                  .replace(/^\d+\. (.*?)$/gm, '<li class="ml-4 mb-1 text-sm">$1</li>')
                                  .replace(/\*\*(.*?)\*\*/g, '<strong class="text-white font-semibold">$1</strong>')
                                  .replace(/\n\n/g, '<br/><br/>')
                              }}
                            />
                          </div>
                        ) : (
                          <div className="text-center py-8">
                            <i className="fas fa-spinner animate-spin text-blue-400 text-3xl mb-3"></i>
                            <div className="text-slate-400">Loading DeepSeek analysis...</div>
                          </div>
                        )}
                      </div>

                      {/* Claude Analysis */}
                      <div className="glass-card p-6 rounded-xl border-2 border-orange-500/30">
                        <div className="flex items-center gap-2 mb-4">
                          <span className="px-3 py-1 rounded-full font-semibold text-sm bg-orange-500/20 text-orange-400">
                            <i className="fas fa-brain mr-2"></i>
                            Claude AI
                          </span>
                          {claudeLoading && (
                            <i className="fas fa-spinner animate-spin text-orange-400 ml-2"></i>
                          )}
                        </div>
                        {claudeAnalysis ? (
                          <div className="prose prose-invert prose-slate max-w-none">
                            <div 
                              className="text-slate-200 leading-relaxed whitespace-pre-wrap"
                              style={{ 
                                fontFamily: 'system-ui, -apple-system, sans-serif',
                                fontSize: '0.9rem',
                                lineHeight: '1.6'
                              }}
                              dangerouslySetInnerHTML={{ 
                                __html: claudeAnalysis
                                  .replace(/^# (.*?)$/gm, '<h1 class="text-xl font-bold text-white mt-4 mb-2">$1</h1>')
                                  .replace(/^## (.*?)$/gm, '<h2 class="text-lg font-bold text-white mt-3 mb-2">$1</h2>')
                                  .replace(/^### (.*?)$/gm, '<h3 class="text-base font-semibold text-white mt-3 mb-1">$1</h3>')
                                  .replace(/^\* (.*?)$/gm, '<li class="ml-4 mb-1 text-sm">â€¢ $1</li>')
                                  .replace(/^\d+\. (.*?)$/gm, '<li class="ml-4 mb-1 text-sm">$1</li>')
                                  .replace(/\*\*(.*?)\*\*/g, '<strong class="text-white font-semibold">$1</strong>')
                                  .replace(/\n\n/g, '<br/><br/>')
                              }}
                            />
                          </div>
                        ) : (
                          <div className="text-center py-8">
                            <i className="fas fa-spinner animate-spin text-orange-400 text-3xl mb-3"></i>
                            <div className="text-slate-400">Loading Claude analysis...</div>
                          </div>
                        )}
                      </div>
                    </div>
                  ) : (
                    <div className="glass-card p-12 rounded-xl text-center border-2 border-dashed border-slate-700">
                      <i className="fas fa-magic text-purple-400 text-5xl mb-4 opacity-50"></i>
                      <div className="text-xl font-bold text-white mb-2">Ready for Dual AI Analysis</div>
                      <div className="text-slate-400 mb-4">Click "Generate Dual AI Analysis" to get insights from both AIs</div>
                      <div className="text-sm text-slate-500">
                        DeepSeek and Claude will independently analyze {stock.symbol}'s fundamentals, technicals, and market position
                      </div>
                    </div>
                  )}
                </div>
              ) : activeTab === 'news-sentiment' ? (
                <div className="space-y-6">
                  {/* Sentiment Overview Grid */}
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    {/* News Sentiment Card */}
                    {newsSentiment && (
                      <div className={`glass-card p-6 rounded-xl border-2 ${
                        newsSentiment.label === 'bullish' ? 'border-green-500/30 bg-green-500/5' :
                        newsSentiment.label === 'bearish' ? 'border-red-500/30 bg-red-500/5' :
                        'border-slate-500/30 bg-slate-500/5'
                      }`}>
                        <div className="flex items-center justify-between mb-4">
                          <div>
                            <h3 className="text-xl font-bold text-white mb-1">ğŸ“° News Sentiment</h3>
                            <p className="text-sm text-slate-400">Based on {newsSentiment.count} articles</p>
                          </div>
                          <div className="text-right">
                            <div className={`text-4xl font-bold ${
                              newsSentiment.label === 'bullish' ? 'text-green-400' :
                              newsSentiment.label === 'bearish' ? 'text-red-400' :
                              'text-slate-400'
                            }`}>
                              {newsSentiment.label === 'bullish' ? 'ğŸ“ˆ' : newsSentiment.label === 'bearish' ? 'ğŸ“‰' : 'â¡ï¸'}
                            </div>
                            <div className={`text-xl font-bold mt-2 ${
                              newsSentiment.label === 'bullish' ? 'text-green-400' :
                              newsSentiment.label === 'bearish' ? 'text-red-400' :
                              'text-slate-400'
                            }`}>
                              {newsSentiment.label.toUpperCase()}
                            </div>
                          </div>
                        </div>
                        
                        <div className="grid grid-cols-3 gap-3">
                          <div className="text-center p-2 bg-green-500/10 rounded-lg">
                            <div className="text-xl font-bold text-green-400">{newsSentiment.bullishCount}</div>
                            <div className="text-xs text-slate-400 mt-1">Bullish</div>
                          </div>
                          <div className="text-center p-2 bg-slate-700/30 rounded-lg">
                            <div className="text-xl font-bold text-slate-400">{newsSentiment.neutralCount}</div>
                            <div className="text-xs text-slate-400 mt-1">Neutral</div>
                          </div>
                          <div className="text-center p-2 bg-red-500/10 rounded-lg">
                            <div className="text-xl font-bold text-red-400">{newsSentiment.bearishCount}</div>
                            <div className="text-xs text-slate-400 mt-1">Bearish</div>
                          </div>
                        </div>
                        
                        <div className="mt-3 p-2 bg-slate-800/50 rounded-lg text-center">
                          <span className="text-xs text-slate-400">Score: </span>
                          <span className={`font-bold text-sm ${
                            newsSentiment.score > 0 ? 'text-green-400' : 
                            newsSentiment.score < 0 ? 'text-red-400' : 
                            'text-slate-400'
                          }`}>
                            {newsSentiment.score > 0 ? '+' : ''}{newsSentiment.score}/100
                          </span>
                        </div>
                      </div>
                    )}

                    {/* Social Sentiment Card */}
                    {socialLoading ? (
                      <div className="glass-card p-6 rounded-xl border-2 border-slate-500/30">
                        <div className="text-center">
                          <i className="fas fa-spinner animate-spin text-cyan-400 text-3xl mb-3"></i>
                          <p className="text-slate-400">Loading social sentiment...</p>
                        </div>
                      </div>
                    ) : socialSentiment && socialSentiment.totalMessages > 0 ? (
                      <div className={`glass-card p-6 rounded-xl border-2 ${
                        socialSentiment.overallSentiment === 'bullish' ? 'border-green-500/30 bg-green-500/5' :
                        socialSentiment.overallSentiment === 'bearish' ? 'border-red-500/30 bg-red-500/5' :
                        'border-slate-500/30 bg-slate-500/5'
                      }`}>
                        <div className="flex items-center justify-between mb-4">
                          <div>
                            <h3 className="text-xl font-bold text-white mb-1">
                              ğŸ’¬ Social Sentiment
                              {socialSentiment.trending && (
                                <span className="ml-2 text-xs bg-orange-500/20 text-orange-400 px-2 py-1 rounded">ğŸ”¥ TRENDING</span>
                              )}
                            </h3>
                            <p className="text-sm text-slate-400">
                              StockTwits: {socialSentiment.stockTwitsCount || 0} | 
                              Reddit: {socialSentiment.redditCount || 0} posts
                            </p>
                          </div>
                          <div className="text-right">
                            <div className={`text-4xl font-bold ${
                              socialSentiment.overallSentiment === 'bullish' ? 'text-green-400' :
                              socialSentiment.overallSentiment === 'bearish' ? 'text-red-400' :
                              'text-slate-400'
                            }`}>
                              {socialSentiment.overallSentiment === 'bullish' ? 'ğŸš€' : socialSentiment.overallSentiment === 'bearish' ? 'ğŸ»' : 'ğŸ˜'}
                            </div>
                            <div className={`text-xl font-bold mt-2 ${
                              socialSentiment.overallSentiment === 'bullish' ? 'text-green-400' :
                              socialSentiment.overallSentiment === 'bearish' ? 'text-red-400' :
                              'text-slate-400'
                            }`}>
                              {socialSentiment.overallSentiment.toUpperCase()}
                            </div>
                          </div>
                        </div>
                        
                        <div className="grid grid-cols-3 gap-3">
                          <div className="text-center p-2 bg-green-500/10 rounded-lg">
                            <div className="text-xl font-bold text-green-400">{socialSentiment.bullishPercent}%</div>
                            <div className="text-xs text-slate-400 mt-1">Bullish</div>
                          </div>
                          <div className="text-center p-2 bg-slate-700/30 rounded-lg">
                            <div className="text-xl font-bold text-slate-400">{socialSentiment.neutralPercent}%</div>
                            <div className="text-xs text-slate-400 mt-1">Neutral</div>
                          </div>
                          <div className="text-center p-2 bg-red-500/10 rounded-lg">
                            <div className="text-xl font-bold text-red-400">{socialSentiment.bearishPercent}%</div>
                            <div className="text-xs text-slate-400 mt-1">Bearish</div>
                          </div>
                        </div>
                        
                        <div className="mt-3 p-2 bg-slate-800/50 rounded-lg text-center">
                          <span className="text-xs text-slate-400">Combined Score: </span>
                          <span className={`font-bold text-sm ${
                            socialSentiment.sentimentScore > 0 ? 'text-green-400' : 
                            socialSentiment.sentimentScore < 0 ? 'text-red-400' : 
                            'text-slate-400'
                          }`}>
                            {socialSentiment.sentimentScore > 0 ? '+' : ''}{socialSentiment.sentimentScore}%
                          </span>
                        </div>
                        
                        {/* Reddit Posts Section */}
                        {socialSentiment.redditPosts && socialSentiment.redditPosts.length > 0 && (
                          <div className="mt-4 pt-4 border-t border-slate-700/50">
                            <h4 className="text-sm font-bold text-white mb-3 flex items-center gap-2">
                              <span>ğŸ¤– Top Reddit Discussions</span>
                            </h4>
                            <div className="space-y-2">
                              {socialSentiment.redditPosts.slice(0, 3).map((post, idx) => (
                                <div key={idx} className="bg-slate-800/50 rounded-lg p-3 hover:bg-slate-800/70 transition cursor-pointer"
                                     onClick={() => window.open(post.url, '_blank')}>
                                  <div className="flex items-start justify-between gap-2 mb-1">
                                    <div className="flex-1 min-w-0">
                                      <div className="text-xs font-semibold text-white truncate">{post.title}</div>
                                      <div className="text-xs text-slate-400 mt-1">
                                        r/{post.subreddit} â€¢ u/{post.author} â€¢ â¬†ï¸ {post.score} â€¢ ğŸ’¬ {post.comments}
                                      </div>
                                    </div>
                                    <div className={`chip text-xs flex-shrink-0 ${
                                      post.sentiment === 'bullish' ? 'bg-green-500/20 text-green-400' :
                                      post.sentiment === 'bearish' ? 'bg-red-500/20 text-red-400' :
                                      'bg-slate-500/20 text-slate-400'
                                    }`}>
                                      {post.sentiment === 'bullish' ? 'ğŸ“ˆ' : post.sentiment === 'bearish' ? 'ğŸ“‰' : 'â¡ï¸'}
                                    </div>
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
                    ) : (
                      <div className="glass-card p-6 rounded-xl border-2 border-slate-500/30">
                        <div className="text-center">
                          <div className="text-4xl mb-3">ğŸ’¬</div>
                          <p className="text-slate-400">No social sentiment data available</p>
                        </div>
                      </div>
                    )}
                  </div>
                  
                  {/* Aggregate Sentiment Overview */}
                  {newsSentiment && (
                    <div className={`glass-card p-6 rounded-xl border-2 ${
                      newsSentiment.label === 'bullish' ? 'border-green-500/30 bg-green-500/5' :
                      newsSentiment.label === 'bearish' ? 'border-red-500/30 bg-red-500/5' :
                      'border-slate-500/30 bg-slate-500/5'
                    }`} style={{display: 'none'}}>
                      <div className="flex items-center justify-between mb-4">
                        <div>
                          <h3 className="text-xl font-bold text-white mb-1">Market Sentiment</h3>
                          <p className="text-sm text-slate-400">Based on {newsSentiment.count} recent articles</p>
                        </div>
                        <div className="text-right">
                          <div className={`text-5xl font-bold ${
                            newsSentiment.label === 'bullish' ? 'text-green-400' :
                            newsSentiment.label === 'bearish' ? 'text-red-400' :
                            'text-slate-400'
                          }`}>
                            {newsSentiment.label === 'bullish' ? 'ğŸ“ˆ' : newsSentiment.label === 'bearish' ? 'ğŸ“‰' : 'â¡ï¸'}
                          </div>
                          <div className={`text-2xl font-bold mt-2 ${
                            newsSentiment.label === 'bullish' ? 'text-green-400' :
                            newsSentiment.label === 'bearish' ? 'text-red-400' :
                            'text-slate-400'
                          }`}>
                            {newsSentiment.label.toUpperCase()}
                          </div>
                        </div>
                      </div>
                      
                      <div className="grid grid-cols-3 gap-4">
                        <div className="text-center p-3 bg-green-500/10 rounded-lg">
                          <div className="text-2xl font-bold text-green-400">{newsSentiment.bullishCount}</div>
                          <div className="text-xs text-slate-400 mt-1">Bullish Articles</div>
                        </div>
                        <div className="text-center p-3 bg-slate-700/30 rounded-lg">
                          <div className="text-2xl font-bold text-slate-400">{newsSentiment.neutralCount}</div>
                          <div className="text-xs text-slate-400 mt-1">Neutral Articles</div>
                        </div>
                        <div className="text-center p-3 bg-red-500/10 rounded-lg">
                          <div className="text-2xl font-bold text-red-400">{newsSentiment.bearishCount}</div>
                          <div className="text-xs text-slate-400 mt-1">Bearish Articles</div>
                        </div>
                      </div>
                      
                      <div className="mt-4 p-3 bg-slate-800/50 rounded-lg">
                        <div className="text-xs text-slate-400">Sentiment Score: 
                          <span className={`font-bold ml-2 ${
                            newsSentiment.score > 0 ? 'text-green-400' : 
                            newsSentiment.score < 0 ? 'text-red-400' : 
                            'text-slate-400'
                          }`}>
                            {newsSentiment.score > 0 ? '+' : ''}{newsSentiment.score}/100
                          </span>
                        </div>
                      </div>
                    </div>
                  )}
                  
                  {/* News Feed */}
                  <div>
                    <div className="flex items-center justify-between mb-4">
                      <h3 className="text-lg font-bold text-white">Latest News</h3>
                      {newsLoading && (
                        <div className="text-sm text-cyan-400">
                          <i className="fas fa-spinner animate-spin mr-2"></i>
                          Loading news...
                        </div>
                      )}
                    </div>
                    
                    {newsData.length === 0 && !newsLoading ? (
                      <div className="glass-card p-8 rounded-xl text-center">
                        <div className="text-4xl mb-3">ğŸ“°</div>
                        <div className="text-slate-400">No recent news available</div>
                      </div>
                    ) : (
                      <div className="space-y-4">
                        {newsData.map((article, index) => (
                          <div key={index} className="glass-card p-4 rounded-xl hover:border-cyan-500/30 transition cursor-pointer"
                               onClick={() => window.open(article.url, '_blank')}>
                            <div className="flex gap-4">
                              {article.image && (
                                <img src={article.image} alt="" 
                                     className="w-24 h-24 object-cover rounded-lg flex-shrink-0"
                                     onError={(e) => e.target.style.display = 'none'} />
                              )}
                              <div className="flex-1 min-w-0">
                                <div className="flex items-start justify-between gap-3 mb-2">
                                  <h4 className="font-semibold text-white leading-tight hover:text-cyan-400 transition">
                                    {article.title}
                                  </h4>
                                  <div className={`chip flex-shrink-0 ${
                                    article.sentiment.label === 'bullish' ? 'bg-green-500/20 text-green-400 border-green-500/30' :
                                    article.sentiment.label === 'bearish' ? 'bg-red-500/20 text-red-400 border-red-500/30' :
                                    'bg-slate-500/20 text-slate-400 border-slate-500/30'
                                  }`}>
                                    {article.sentiment.label === 'bullish' ? 'ğŸ“ˆ Bullish' :
                                     article.sentiment.label === 'bearish' ? 'ğŸ“‰ Bearish' :
                                     'â¡ï¸ Neutral'}
                                  </div>
                                </div>
                                
                                {article.description && (
                                  <p className="text-sm text-slate-400 mb-2 line-clamp-2">
                                    {article.description}
                                  </p>
                                )}
                                
                                <div className="flex items-center gap-3 text-xs text-slate-500">
                                  <span className="font-medium text-cyan-400">{article.source}</span>
                                  <span>â€¢</span>
                                  <span>{formatDateSafe(article.publishedAt)}</span>
                                  <span>{(() => {
                                    const t = new Date(article.publishedAt).getTime();
                                    return Number.isFinite(t)
                                      ? new Date(t).toLocaleTimeString([], {hour: '2-digit', minute: '2-digit'})
                                      : 'â€”';
                                  })()}</span>
                                  {article.sentiment.confidence > 0 && (
                                    <>
                                      <span>â€¢</span>
                                      <span className="text-slate-400">
                                        Confidence: {article.sentiment.confidence}%
                                      </span>
                                    </>
                                  )}
                                </div>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>
                  
                  {/* Sentiment Explanation */}
                  <div className="glass-card p-4 rounded-xl bg-slate-800/50">
                    <div className="flex items-start gap-2">
                      <i className="fas fa-info-circle text-cyan-400 text-sm mt-0.5"></i>
                      <div className="flex-1">
                        <div className="text-xs font-semibold text-cyan-300 mb-1">About Sentiment Analysis</div>
                        <div className="text-xs text-slate-400 leading-relaxed">
                          News sentiment is analyzed using natural language processing to identify bullish, bearish, or neutral tones. 
                          This helps gauge market perception and potential price movements. Sentiment updates automatically every 5 minutes.
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              ) : activeTab === 'simplified' ? (
                <div>
                  {/* Header */}
                  <div className="glass-card p-6 mb-6 rounded-xl border border-cyan-500/20">
                    <div className="flex items-center gap-3 mb-3">
                      <i className="fas fa-lightbulb text-cyan-400 text-2xl"></i>
                      <h3 className="text-xl font-bold text-white">Simplified Analysis</h3>
                    </div>
                    <div className="text-sm text-slate-400 leading-relaxed">
                      We've translated complex financial metrics into plain English so you can understand what really matters.
                    </div>
                  </div>
                  
                  {/* Valuation Gauge */}
                  <div className="glass-card p-6 mb-6 rounded-xl">
                    <h4 className="text-lg font-bold text-white mb-4 text-center flex items-center justify-center gap-2">
                      <i className="fas fa-gauge"></i>
                      Overall Valuation
                    </h4>
                    {(() => {
                      const score = calculateValuationScore(stock);
                      const valuation = getValuationLabel(score);
                      return (
                        <div>
                          <div className="flex items-center justify-center gap-3 mb-4">
                            <span className="text-4xl">{valuation.emoji}</span>
                            <div>
                              <div className="text-3xl font-bold" style={{ color: valuation.color }}>
                                {valuation.label}
                              </div>
                              <div className="text-sm text-slate-400">
                                Valuation Score: {score}/100
                              </div>
                            </div>
                          </div>
                          <div className="relative h-24 mb-4">
                            <div className="absolute w-full h-3 top-10 rounded-full" style={{ background: 'linear-gradient(to right, #22c55e 0%, #eab308 50%, #ef4444 100%)' }}></div>
                            <div className="absolute w-1 h-10 bg-white shadow-lg top-4 transition-all duration-500" style={{ left: `${score}%`, transform: 'translateX(-50%)' }}>
                              <div className="absolute -top-2 left-1/2 -translate-x-1/2 w-0 h-0 border-l-8 border-r-8 border-t-8 border-transparent border-t-white"></div>
                            </div>
                            <div className="absolute w-full top-16 flex justify-between text-xs font-bold">
                              <span className="text-green-400">Undervalued</span>
                              <span className="text-yellow-400">Fair</span>
                              <span className="text-red-400">Overvalued</span>
                            </div>
                          </div>
                          <div className="text-xs text-slate-500 text-center">
                            Based on P/E ratio, price/book, free cash flow, and growth rate
                          </div>
                        </div>
                      );
                    })()}
                  </div>
                  
                  {/* Key Metrics */}
                  <div className="glass-card p-6 mb-6 rounded-xl">
                    <h4 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                      <i className="fas fa-traffic-light"></i>
                      Quick Health Check
                    </h4>
                    <div className="space-y-4">
                      {/* P/E Ratio */}
                      {stock.pe && (() => {
                        const color = getTrafficLight('pe', stock.pe);
                        const summary = getPlainEnglishSummary('pe', stock.pe);
                        const dotColor = color === 'green' ? '#22c55e' : color === 'yellow' ? '#eab308' : '#ef4444';
                        return (
                          <div className="p-4 bg-slate-800/50 rounded-lg">
                            <div className="flex justify-between items-center mb-3">
                              <div>
                                <div className="text-xs text-slate-500 mb-1">Price vs Earnings</div>
                                <div className="text-2xl font-bold text-white font-mono">{stock.pe.toFixed(1)}x</div>
                              </div>
                              <div className="flex items-center gap-2 px-3 py-2 rounded-lg" style={{ 
                                background: color === 'green' ? 'rgba(34,197,94,0.15)' : color === 'yellow' ? 'rgba(234,179,8,0.15)' : 'rgba(239,68,68,0.15)',
                                border: `1px solid ${color === 'green' ? 'rgba(34,197,94,0.3)' : color === 'yellow' ? 'rgba(234,179,8,0.3)' : 'rgba(239,68,68,0.3)'}`,
                                color: dotColor
                              }}>
                                <div className="w-2 h-2 rounded-full" style={{ background: dotColor }}></div>
                                <span className="text-xs font-bold">{color === 'green' ? 'Good' : color === 'yellow' ? 'OK' : 'Concern'}</span>
                              </div>
                            </div>
                            <div className="text-sm font-semibold text-white mb-1">{summary.text}</div>
                            <div className="text-xs text-slate-400 leading-relaxed">{summary.detail}</div>
                          </div>
                        );
                      })()}
                      
                      {/* Revenue Growth */}
                      {stock.revenueGrowth != null && (() => {
                        const color = getTrafficLight('revenueGrowth', stock.revenueGrowth);
                        const summary = getPlainEnglishSummary('revenueGrowth', stock.revenueGrowth);
                        const dotColor = color === 'green' ? '#22c55e' : color === 'yellow' ? '#eab308' : '#ef4444';
                        return (
                          <div className="p-4 bg-slate-800/50 rounded-lg">
                            <div className="flex justify-between items-center mb-3">
                              <div>
                                <div className="text-xs text-slate-500 mb-1">Revenue Growth</div>
                                <div className="text-2xl font-bold text-white font-mono">
                                  {stock.revenueGrowth > 0 ? '+' : ''}{stock.revenueGrowth.toFixed(1)}%
                                </div>
                              </div>
                              <div className="flex items-center gap-2 px-3 py-2 rounded-lg" style={{ 
                                background: color === 'green' ? 'rgba(34,197,94,0.15)' : color === 'yellow' ? 'rgba(234,179,8,0.15)' : 'rgba(239,68,68,0.15)',
                                border: `1px solid ${color === 'green' ? 'rgba(34,197,94,0.3)' : color === 'yellow' ? 'rgba(234,179,8,0.3)' : 'rgba(239,68,68,0.3)'}`,
                                color: dotColor
                              }}>
                                <div className="w-2 h-2 rounded-full" style={{ background: dotColor }}></div>
                                <span className="text-xs font-bold">{color === 'green' ? 'Good' : color === 'yellow' ? 'OK' : 'Concern'}</span>
                              </div>
                            </div>
                            <div className="text-sm font-semibold text-white mb-1">{summary.text}</div>
                            <div className="text-xs text-slate-400 leading-relaxed">{summary.detail}</div>
                          </div>
                        );
                      })()}
                      
                      {/* Debt Level */}
                      {stock.debtToEquity != null && (() => {
                        const color = getTrafficLight('debtToEquity', stock.debtToEquity);
                        const summary = getPlainEnglishSummary('debtToEquity', stock.debtToEquity);
                        const dotColor = color === 'green' ? '#22c55e' : color === 'yellow' ? '#eab308' : '#ef4444';
                        return (
                          <div className="p-4 bg-slate-800/50 rounded-lg">
                            <div className="flex justify-between items-center mb-3">
                              <div>
                                <div className="text-xs text-slate-500 mb-1">Debt Level</div>
                                <div className="text-2xl font-bold text-white font-mono">{stock.debtToEquity.toFixed(2)}</div>
                              </div>
                              <div className="flex items-center gap-2 px-3 py-2 rounded-lg" style={{ 
                                background: color === 'green' ? 'rgba(34,197,94,0.15)' : color === 'yellow' ? 'rgba(234,179,8,0.15)' : 'rgba(239,68,68,0.15)',
                                border: `1px solid ${color === 'green' ? 'rgba(34,197,94,0.3)' : color === 'yellow' ? 'rgba(234,179,8,0.3)' : 'rgba(239,68,68,0.3)'}`,
                                color: dotColor
                              }}>
                                <div className="w-2 h-2 rounded-full" style={{ background: dotColor }}></div>
                                <span className="text-xs font-bold">{color === 'green' ? 'Good' : color === 'yellow' ? 'OK' : 'Concern'}</span>
                              </div>
                            </div>
                            <div className="text-sm font-semibold text-white mb-1">{summary.text}</div>
                            <div className="text-xs text-slate-400 leading-relaxed">{summary.detail}</div>
                          </div>
                        );
                      })()}
                      
                      {/* ROE */}
                      {stock.roe != null && (() => {
                        const color = getTrafficLight('roe', stock.roe);
                        const summary = getPlainEnglishSummary('roe', stock.roe);
                        const dotColor = color === 'green' ? '#22c55e' : color === 'yellow' ? '#eab308' : '#ef4444';
                        return (
                          <div className="p-4 bg-slate-800/50 rounded-lg">
                            <div className="flex justify-between items-center mb-3">
                              <div>
                                <div className="text-xs text-slate-500 mb-1">Return on Equity</div>
                                <div className="text-2xl font-bold text-white font-mono">{stock.roe.toFixed(1)}%</div>
                              </div>
                              <div className="flex items-center gap-2 px-3 py-2 rounded-lg" style={{ 
                                background: color === 'green' ? 'rgba(34,197,94,0.15)' : color === 'yellow' ? 'rgba(234,179,8,0.15)' : 'rgba(239,68,68,0.15)',
                                border: `1px solid ${color === 'green' ? 'rgba(34,197,94,0.3)' : color === 'yellow' ? 'rgba(234,179,8,0.3)' : 'rgba(239,68,68,0.3)'}`,
                                color: dotColor
                              }}>
                                <div className="w-2 h-2 rounded-full" style={{ background: dotColor }}></div>
                                <span className="text-xs font-bold">{color === 'green' ? 'Good' : color === 'yellow' ? 'OK' : 'Concern'}</span>
                              </div>
                            </div>
                            <div className="text-sm font-semibold text-white mb-1">{summary.text}</div>
                            <div className="text-xs text-slate-400 leading-relaxed">{summary.detail}</div>
                          </div>
                        );
                      })()}
                    </div>
                  </div>
                  
                  {/* Disclaimer */}
                  <div className="p-4 bg-yellow-500/5 border border-yellow-500/20 rounded-lg">
                    <div className="flex items-start gap-2 text-sm">
                      <i className="fas fa-info-circle text-yellow-400 mt-0.5"></i>
                      <div className="text-slate-400 leading-relaxed">
                        <strong className="text-yellow-400">Remember:</strong> These simplified metrics are a starting point. 
                        Always review the full financials and do your own research before investing.
                      </div>
                    </div>
                  </div>
                </div>
              ) : activeTab === 'fundamentals' ? (
                <div className="space-y-6">
                  {/* Growth Metrics */}
                  <div className="grid grid-cols-3 gap-4">
                    <div className="glass-card p-4 rounded-xl">
                      <div className="text-xs text-slate-500 mb-2">Revenue Growth</div>
                      <div className={`text-3xl font-bold ${stock.revenueGrowth > 0 ? 'text-green-400' : 'text-red-400'}`}>
                        {stock.revenueGrowth > 0 ? '+' : ''}{stock.revenueGrowth?.toFixed(1) || 'â€”'}%
                      </div>
                    </div>
                    <div className="glass-card p-4 rounded-xl">
                      <div className="text-xs text-slate-500 mb-2">Income Growth</div>
                      <div className={`text-2xl font-bold ${stock.netIncomeGrowth > 0 ? 'text-green-400' : 'text-red-400'}`}>
                        {stock.netIncomeGrowth > 0 ? '+' : ''}{stock.netIncomeGrowth?.toFixed(1) || 'â€”'}%
                      </div>
                    </div>
                    <div className="glass-card p-4 rounded-xl">
                      <div className="text-xs text-slate-500 mb-2">EPS Growth</div>
                      <div className={`text-2xl font-bold ${stock.epsGrowth > 0 ? 'text-green-400' : 'text-red-400'}`}>
                        {stock.epsGrowth > 0 ? '+' : ''}{stock.epsGrowth?.toFixed(1) || 'â€”'}%
                      </div>
                    </div>
                  </div>

                  <div className="grid grid-cols-4 gap-6">
                    {/* Valuation Metrics */}
                    <div>
                      <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Valuation</h4>
                      <div className="space-y-2">
                        {[
                          { label: 'P/E Ratio', value: stock.pe, key: 'pe' },
                          { label: 'P/B Ratio', value: stock.priceToBook },
                          { label: 'P/S Ratio', value: stock.priceToSales },
                          { label: 'EV/EBITDA', value: stock.evToEbitda, key: 'evToEbitda' },
                        ].map(m => (
                          <div key={m.label} className="flex justify-between items-center py-2 border-b border-slate-700/20">
                            <span className="text-xs text-slate-400">
                              {m.label}
                              {m.key && <ExplainMetric metricKey={m.key} stock={stock} />}
                            </span>
                            <span className="font-mono text-white text-sm">{m.value?.toFixed(2) || 'â€”'}</span>
                          </div>
                        ))}
                      </div>
                    </div>

                    {/* Profitability */}
                    <div>
                      <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Profitability</h4>
                      <div className="space-y-2">
                        {[
                          { label: 'ROE', value: stock.roe, key: 'roe', unit: '%' },
                          { label: 'ROA', value: stock.roa, unit: '%' },
                          { label: 'ROIC', value: stock.roic, key: 'roic', unit: '%' },
                        ].map(m => (
                          <div key={m.label} className="flex justify-between items-center py-2 border-b border-slate-700/20">
                            <span className="text-xs text-slate-400">
                              {m.label}
                              {m.key && <ExplainMetric metricKey={m.key} stock={stock} />}
                            </span>
                            <span className="font-mono text-white text-sm">{m.value?.toFixed(2) || 'â€”'}{m.unit}</span>
                          </div>
                        ))}
                      </div>
                    </div>

                    {/* Margins */}
                    <div>
                      <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Margins</h4>
                      <div className="space-y-2">
                        {[
                          { label: 'Gross', value: stock.grossMargin, key: 'grossMargin', unit: '%' },
                          { label: 'Operating', value: stock.operatingMargin, unit: '%' },
                          { label: 'Net', value: stock.netMargin, unit: '%' },
                        ].map(m => (
                          <div key={m.label} className="flex justify-between items-center py-2 border-b border-slate-700/20">
                            <span className="text-xs text-slate-400">
                              {m.label}
                              {m.key && <ExplainMetric metricKey={m.key} stock={stock} />}
                            </span>
                            <span className="font-mono text-white text-sm">{m.value?.toFixed(2) || 'â€”'}{m.unit}</span>
                          </div>
                        ))}
                      </div>
                    </div>

                    {/* Financial Health */}
                    <div>
                      <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Financial Health</h4>
                      <div className="space-y-2">
                        {[
                          { label: 'Current Ratio', value: stock.currentRatio },
                          { label: 'Quick Ratio', value: stock.quickRatio },
                          { label: 'Debt/Equity', value: stock.debtToEquity, key: 'debtToEquity' },
                        ].map(m => (
                          <div key={m.label} className="flex justify-between items-center py-2 border-b border-slate-700/20">
                            <span className="text-xs text-slate-400">
                              {m.label}
                              {m.key && <ExplainMetric metricKey={m.key} stock={stock} />}
                            </span>
                            <span className="font-mono text-white text-sm">{m.value?.toFixed(2) || 'â€”'}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  </div>

                  {/* Latest News */}
                  {stock.latestNews && stock.latestNews.length > 0 && (
                    <div>
                      <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Latest News</h4>
                      <div className="space-y-2">
                        {stock.latestNews.slice(0, 10).map((article, i) => (
                          <div key={i} className="glass-card p-3 rounded-lg">
                            <a href={article.url} target="_blank" rel="noopener noreferrer" className="text-sm text-cyan-400 hover:underline">
                              {article.title}
                            </a>
                            <div className="text-xs text-slate-500 mt-1">{article.site} â€¢ {formatDateSafe(article.publishedDate)}</div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}

                  {/* Quality Scores */}
                  <div>
                    <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Quality Scores</h4>
                    <div className="grid grid-cols-3 gap-4">
                      <div className="glass-card p-4 rounded-xl">
                        <div className="text-xs text-slate-500 mb-2">FMP Rating</div>
                        <div className={`text-2xl font-bold mb-1 ${
                          stock.analystRating?.startsWith('A') ? 'text-green-400' :
                          stock.analystRating?.startsWith('B') ? 'text-blue-400' :
                          stock.analystRating?.startsWith('C') ? 'text-yellow-400' :
                          'text-red-400'
                        }`}>
                          {stock.analystRating || 'N/A'}
                        </div>
                        <div className="text-xs text-slate-500">Overall: {stock.overallScore || 0}/5</div>
                      </div>
                      <div className="glass-card p-4 rounded-xl">
                        <div className="text-xs text-slate-500 mb-2 flex items-center">
                          Piotroski Score
                          <ExplainMetric metricKey="piotroskiScore" stock={stock} />
                        </div>
                        <div className={`text-2xl font-bold mb-1 ${
                          stock.piotroskiScore >= 7 ? 'text-green-400' :
                          stock.piotroskiScore >= 4 ? 'text-yellow-400' :
                          'text-red-400'
                        }`}>
                          {stock.piotroskiScore || 0}/9
                        </div>
                        <div className="text-xs text-slate-500">
                          {stock.piotroskiScore >= 7 ? 'Strong' : stock.piotroskiScore >= 4 ? 'Average' : 'Weak'}
                        </div>
                      </div>
                      <div className="glass-card p-4 rounded-xl">
                        <div className="text-xs text-slate-500 mb-2">Altman Z-Score</div>
                        <div className={`text-2xl font-bold mb-1 ${
                          stock.altmanZScore > 3 ? 'text-green-400' :
                          stock.altmanZScore > 1.8 ? 'text-yellow-400' :
                          'text-red-400'
                        }`}>
                          {stock.altmanZScore?.toFixed(1) || 'â€”'}
                        </div>
                        <div className="text-xs text-slate-500">
                          {stock.altmanZScore > 3 ? 'Safe Zone' : stock.altmanZScore > 1.8 ? 'Grey Zone' : 'Distress'}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              ) : activeTab === 'technicals' ? (
                <div className="space-y-6">
                  {/* Quick Technical Read */}
                  <div className="p-4 bg-slate-800/40 border border-slate-700/50 rounded-xl text-sm text-slate-200">
                    <span className="font-semibold text-slate-100">Quick read:</span>{" "}
                    {(() => {
                      const rsi = Number.isFinite(stock.rsi) ? stock.rsi : (technicalData?.rsi ?? 50);
                      const sma50 = technicalData?.sma50;
                      const sma200 = technicalData?.sma200;
                      const above50 = sma50 ? (stock.price > sma50) : null;
                      const above200 = sma200 ? (stock.price > sma200) : null;
                      const rsiMsg = rsi > 72 ? "Momentum looks stretched (overbought)." : (rsi < 35 ? "Momentum looks washed out (oversold)." : "Momentum looks neutral.");
                      const trendMsg = (above50 == null || above200 == null) ? "Trend signals are limited." :
                        (above50 && above200 ? "Trend looks constructive (above key averages)." :
                         (!above50 && !above200 ? "Trend looks weak (below key averages)." :
                          "Trend is mixed (one average above, one below)."));
                      return `${trendMsg} ${rsiMsg}`;
                    })()}
                  </div>

                  {/* Technical Summary Cards */}
                  <div className="grid grid-cols-4 gap-4">
                    {/* RSI */}
                    <div className="glass-card p-4 rounded-xl">
                      <div className="text-xs text-slate-500 mb-2">RSI (14)</div>
                      <div className={`text-2xl font-bold ${
                        (technicalData?.rsi || stock.rsi) < 30 ? 'text-green-400' : 
                        (technicalData?.rsi || stock.rsi) > 70 ? 'text-red-400' : 
                        'text-cyan-400'
                      }`}>
                        {(technicalData?.rsi || stock.rsi)?.toFixed(0) || 'â€”'}
                      </div>
                      <div className="text-xs text-slate-500 mt-1">
                        {(technicalData?.rsi || stock.rsi) < 30 ? 'ğŸŸ¢ Oversold' : 
                         (technicalData?.rsi || stock.rsi) > 70 ? 'ğŸ”´ Overbought' : 
                         'ğŸŸ¡ Neutral'}
                      </div>
                    </div>

                    {/* ADX (Trend Strength) */}
                    <div className="glass-card p-4 rounded-xl">
                      <div className="text-xs text-slate-500 mb-2">ADX (14)</div>
                      <div className={`text-2xl font-bold ${
                        technicalData?.adx > 25 ? 'text-green-400' : 
                        technicalData?.adx > 20 ? 'text-yellow-400' : 
                        'text-slate-400'
                      }`}>
                        {technicalData?.adx?.toFixed(0) || 'â€”'}
                      </div>
                      <div className="text-xs text-slate-500 mt-1">
                        {technicalData?.adx > 25 ? 'ğŸ’ª Strong Trend' : 
                         technicalData?.adx > 20 ? 'ğŸ“Š Moderate' : 
                         'ğŸ˜´ Weak Trend'}
                      </div>
                    </div>

                    {/* Volatility */}
                    <div className="glass-card p-4 rounded-xl">
                      <div className="text-xs text-slate-500 mb-2">Volatility (20d)</div>
                      <div className={`text-2xl font-bold ${
                        technicalData?.stdDev > 5 ? 'text-red-400' :
                        technicalData?.stdDev > 2 ? 'text-yellow-400' :
                        'text-green-400'
                      }`}>
                        {technicalData?.stdDev?.toFixed(2) || 'â€”'}
                      </div>
                      <div className="text-xs text-slate-500 mt-1">
                        {technicalData?.stdDev > 5 ? 'âš ï¸ High' : 
                         technicalData?.stdDev > 2 ? 'âš¡ Medium' : 
                         'âœ… Low'}
                      </div>
                    </div>

                    {/* Price Change */}
                    <div className="glass-card p-4 rounded-xl">
                      <div className="text-xs text-slate-500 mb-2">Today's Change</div>
                      <div className={`text-2xl font-bold ${getSentimentColor(stock.changePct)}`}>
                        {formatPercent(stock.changePct, 2)}
                      </div>
                      <div className="text-xs text-slate-500 mt-1">
                        ${stock.change?.toFixed(2) || 'â€”'}
                      </div>
                    </div>
                  </div>

                  {/* Moving Averages Analysis */}
                  <div>
                    <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Moving Averages</h4>
                    <div className="glass-card p-5 rounded-xl">
                      <div className="space-y-4">
                        {/* Price vs MAs */}
                        <div className="grid grid-cols-4 gap-4">
                          <div className="text-center">
                            <div className="text-xs text-slate-500 mb-1">Current Price</div>
                            <div className="text-xl font-bold text-white">${stock.price?.toFixed(2)}</div>
                          </div>
                          <div className="text-center">
                            <div className="text-xs text-slate-500 mb-1">EMA (20)</div>
                            <div className={`text-xl font-bold ${
                              technicalData?.ema20 && stock.price > technicalData.ema20 ? 'text-green-400' : 'text-red-400'
                            }`}>
                              ${technicalData?.ema20?.toFixed(2) || 'â€”'}
                            </div>
                            <div className="text-xs mt-1">
                              {technicalData?.ema20 && stock.price > technicalData.ema20 ? 
                                <span className="text-green-400">â†‘ Above</span> : 
                                <span className="text-red-400">â†“ Below</span>
                              }
                            </div>
                          </div>
                          <div className="text-center">
                            <div className="text-xs text-slate-500 mb-1">SMA (50)</div>
                            <div className={`text-xl font-bold ${
                              technicalData?.sma50 && stock.price > technicalData.sma50 ? 'text-green-400' : 'text-red-400'
                            }`}>
                              ${technicalData?.sma50?.toFixed(2) || 'â€”'}
                            </div>
                            <div className="text-xs mt-1">
                              {technicalData?.sma50 && stock.price > technicalData.sma50 ? 
                                <span className="text-green-400">â†‘ Above</span> : 
                                <span className="text-red-400">â†“ Below</span>
                              }
                            </div>
                          </div>
                          <div className="text-center">
                            <div className="text-xs text-slate-500 mb-1">SMA (200)</div>
                            <div className={`text-xl font-bold ${
                              technicalData?.sma200 && stock.price > technicalData.sma200 ? 'text-green-400' : 'text-red-400'
                            }`}>
                              ${technicalData?.sma200?.toFixed(2) || 'â€”'}
                            </div>
                            <div className="text-xs mt-1">
                              {technicalData?.sma200 && stock.price > technicalData.sma200 ? 
                                <span className="text-green-400">â†‘ Above</span> : 
                                <span className="text-red-400">â†“ Below</span>
                              }
                            </div>
                          </div>
                        </div>

                        {/* Golden/Death Cross Indicator */}
                        {technicalData?.sma50 && technicalData?.sma200 && (
                          <div className="pt-4 border-t border-slate-700/30">
                            <div className={`p-3 rounded-lg ${
                              technicalData.sma50 > technicalData.sma200 ? 
                                'bg-green-500/10 border border-green-500/30' : 
                                'bg-red-500/10 border border-red-500/30'
                            }`}>
                              <div className="flex items-center justify-between">
                                <div>
                                  <div className={`text-sm font-bold ${
                                    technicalData.sma50 > technicalData.sma200 ? 'text-green-400' : 'text-red-400'
                                  }`}>
                                    {technicalData.sma50 > technicalData.sma200 ? 
                                      'âœ¨ Golden Cross Pattern' : 
                                      'ğŸ’€ Death Cross Pattern'
                                    }
                                  </div>
                                  <div className="text-xs text-slate-400 mt-1">
                                    {technicalData.sma50 > technicalData.sma200 ? 
                                      'SMA(50) above SMA(200) - Bullish long-term trend' : 
                                      'SMA(50) below SMA(200) - Bearish long-term trend'
                                    }
                                  </div>
                                </div>
                                <div className={`text-3xl ${
                                  technicalData.sma50 > technicalData.sma200 ? 'text-green-400' : 'text-red-400'
                                }`}>
                                  {technicalData.sma50 > technicalData.sma200 ? 'ğŸ“ˆ' : 'ğŸ“‰'}
                                </div>
                              </div>
                            </div>
                          </div>
                        )}
                      </div>
                    </div>
                  </div>

                  {/* Price Levels & Support/Resistance */}
                  <div className="grid grid-cols-2 gap-4">
                    {/* 52-Week Range */}
                    <div>
                      <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">52-Week Range</h4>
                      <div className="glass-card p-5 rounded-xl">
                        <div className="space-y-3">
                          <div className="flex justify-between items-center">
                            <span className="text-xs text-slate-400">High</span>
                            <span className="font-mono text-green-400 font-bold text-lg">${stock.yearHigh?.toFixed(2) || 'â€”'}</span>
                          </div>
                          
                          <div className="relative h-3 bg-slate-700 rounded-full overflow-hidden">
                            <div className="absolute h-full w-full bg-gradient-to-r from-red-500/30 via-yellow-500/30 to-green-500/30"></div>
                            {stock.yearLow && stock.yearHigh && stock.price && (
                              <div 
                                className="absolute w-1.5 h-full bg-cyan-400 border-2 border-white shadow-lg"
                                style={{ 
                                  left: `${((stock.price - stock.yearLow) / (stock.yearHigh - stock.yearLow)) * 100}%`
                                }}
                              ></div>
                            )}
                          </div>
                          
                          <div className="flex justify-between items-center">
                            <span className="text-xs text-slate-400">Low</span>
                            <span className="font-mono text-red-400 font-bold text-lg">${stock.yearLow?.toFixed(2) || 'â€”'}</span>
                          </div>
                          
                          <div className="pt-3 border-t border-slate-700/30 text-center">
                            <div className="text-xs text-slate-500 mb-1">Current Position</div>
                            <div className="text-cyan-400 font-bold text-xl">${stock.price?.toFixed(2)}</div>
                            {stock.yearLow && stock.yearHigh && stock.price && (
                              <div className="text-xs text-slate-500 mt-1">
                                {(((stock.price - stock.yearLow) / (stock.yearHigh - stock.yearLow)) * 100).toFixed(0)}% from low to high
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* Today's Range */}
                    <div>
                      <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Today's Range</h4>
                      <div className="glass-card p-5 rounded-xl">
                        <div className="space-y-3">
                          <div className="flex justify-between items-center">
                            <span className="text-xs text-slate-400">Day High</span>
                            <span className="font-mono text-white font-bold text-lg">${stock.dayHigh?.toFixed(2) || stock.price?.toFixed(2) || 'â€”'}</span>
                          </div>
                          
                          <div className="relative h-3 bg-slate-700 rounded-full overflow-hidden">
                            <div className="absolute h-full w-full bg-cyan-500/20"></div>
                            {stock.dayLow && stock.dayHigh && stock.price && (
                              <div 
                                className="absolute w-1.5 h-full bg-cyan-400 shadow-lg"
                                style={{ 
                                  left: `${((stock.price - stock.dayLow) / (stock.dayHigh - stock.dayLow)) * 100}%`
                                }}
                              ></div>
                            )}
                          </div>
                          
                          <div className="flex justify-between items-center">
                            <span className="text-xs text-slate-400">Day Low</span>
                            <span className="font-mono text-white font-bold text-lg">${stock.dayLow?.toFixed(2) || stock.price?.toFixed(2) || 'â€”'}</span>
                          </div>
                          
                          <div className="pt-3 border-t border-slate-700/30">
                            <div className="grid grid-cols-2 gap-3 text-center">
                              <div>
                                <div className="text-xs text-slate-500">Open</div>
                                <div className="text-white font-semibold">${stock.open?.toFixed(2) || 'â€”'}</div>
                              </div>
                              <div>
                                <div className="text-xs text-slate-500">Previous Close</div>
                                <div className="text-white font-semibold">${stock.previousClose?.toFixed(2) || 'â€”'}</div>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Momentum & Volume */}
                  <div className="grid grid-cols-2 gap-4">
                    {/* Momentum Indicators */}
                    <div>
                      <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Momentum Analysis</h4>
                      <div className="glass-card p-4 rounded-xl space-y-3">
                        {/* RSI with visual bar */}
                        <div>
                          <div className="flex justify-between items-center mb-2">
                            <span className="text-xs text-slate-400">RSI (14)</span>
                            <span className={`font-mono text-sm font-bold ${
                              (technicalData?.rsi || stock.rsi) < 30 ? 'text-green-400' : 
                              (technicalData?.rsi || stock.rsi) > 70 ? 'text-red-400' : 
                              'text-cyan-400'
                            }`}>
                              {(technicalData?.rsi || stock.rsi)?.toFixed(0) || 'â€”'}
                            </span>
                          </div>
                          <div className="relative h-2 bg-slate-700 rounded-full overflow-hidden">
                            <div className="absolute h-full w-[30%] bg-green-500/20"></div>
                            <div className="absolute h-full w-[40%] left-[30%] bg-slate-600/30"></div>
                            <div className="absolute h-full w-[30%] left-[70%] bg-red-500/20"></div>
                            {(technicalData?.rsi || stock.rsi) && (
                              <div 
                                className="absolute w-1 h-full bg-white shadow-lg"
                                style={{ left: `${(technicalData?.rsi || stock.rsi)}%` }}
                              ></div>
                            )}
                          </div>
                          <div className="flex justify-between text-[10px] text-slate-500 mt-1">
                            <span>Oversold</span>
                            <span>Neutral</span>
                            <span>Overbought</span>
                          </div>
                        </div>

                        {/* ADX Trend Strength */}
                        {technicalData?.adx && (
                          <div className="pt-3 border-t border-slate-700/30">
                            <div className="flex justify-between items-center">
                              <span className="text-xs text-slate-400">ADX Trend Strength</span>
                              <span className={`font-mono text-sm font-bold ${
                                technicalData.adx > 25 ? 'text-green-400' : 
                                technicalData.adx > 20 ? 'text-yellow-400' : 
                                'text-slate-400'
                              }`}>
                                {technicalData.adx.toFixed(0)}
                              </span>
                            </div>
                            <div className="mt-2 h-2 bg-slate-700 rounded-full overflow-hidden">
                              <div 
                                className={`h-full rounded-full ${
                                  technicalData.adx > 25 ? 'bg-green-500' : 
                                  technicalData.adx > 20 ? 'bg-yellow-500' : 
                                  'bg-slate-500'
                                }`}
                                style={{ width: `${Math.min(100, (technicalData.adx / 50) * 100)}%` }}
                              ></div>
                            </div>
                            <div className="text-xs text-slate-500 mt-1">
                              {technicalData.adx > 25 ? 'Strong directional movement' : 
                               technicalData.adx > 20 ? 'Moderate trend forming' : 
                               'Weak trend, ranging market'}
                            </div>
                          </div>
                        )}

                        {/* Price Momentum */}
                        <div className="pt-3 border-t border-slate-700/30">
                          <div className="flex justify-between items-center">
                            <span className="text-xs text-slate-400">Price Momentum</span>
                            <span className={`font-mono text-sm font-bold ${getSentimentColor(stock.changePct)}`}>
                              {formatPercent(stock.changePct, 2)}
                            </span>
                          </div>
                        </div>

                        {/* Volatility */}
                        {technicalData?.stdDev && (
                          <div className="pt-3 border-t border-slate-700/30">
                            <div className="flex justify-between items-center">
                              <span className="text-xs text-slate-400">Volatility (Ïƒ)</span>
                              <span className={`text-sm font-bold ${
                                technicalData.stdDev > 5 ? 'text-red-400' :
                                technicalData.stdDev > 2 ? 'text-yellow-400' :
                                'text-green-400'
                              }`}>
                                {technicalData.stdDev.toFixed(2)}
                              </span>
                            </div>
                          </div>
                        )}
                      </div>
                    </div>

                    {/* Volume Analysis */}
                    <div>
                      <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Volume</h4>
                      <div className="glass-card p-5 rounded-xl">
                        <div className="text-center">
                          <div className="text-xs text-slate-500 mb-2">Average Volume Traded</div>
                          <div className="text-3xl font-bold text-white font-mono">
                            {formatNumber(stock.avgVolume || 0, 0)}
                          </div>
                          <div className="text-xs text-slate-400 mt-2">shares per day</div>
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Ratings & Consensus (if available) */}



                </div>
              ) : activeTab === 'analyst-ratings' && analystRatingsData ? (
                <div className="space-y-6">
                  <h3 className="text-xl font-bold text-white">Comprehensive Analyst Ratings</h3>
                  
                  {/* Overall Rating from Ratings Snapshot */}
                  {analystRatingsData.snapshot && (
                    <div>
                      <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">FMP Overall Rating</h4>
                      <div className="glass-card p-6 rounded-xl">
                        {/* Main Rating & Overall Score */}
                        <div className="grid grid-cols-3 gap-6 mb-6 pb-6 border-b border-slate-700/30">
                          <div className="text-center">
                            <div className="text-xs text-slate-500 mb-2">Rating</div>
                            <div className={`text-6xl font-bold mb-2 ${
                              analystRatingsData.snapshot.rating?.startsWith('A') ? 'text-green-400' :
                              analystRatingsData.snapshot.rating?.startsWith('B') ? 'text-blue-400' :
                              analystRatingsData.snapshot.rating?.startsWith('C') ? 'text-yellow-400' :
                              analystRatingsData.snapshot.rating?.startsWith('D') ? 'text-orange-400' :
                              'text-red-400'
                            }`}>
                              {analystRatingsData.snapshot.rating || 'N/A'}
                            </div>
                            <div className="text-sm text-slate-400">
                              {analystRatingsData.snapshot.ratingRecommendation || 'N/A'}
                            </div>
                          </div>
                          <div className="text-center">
                            <div className="text-xs text-slate-500 mb-2">Overall Score</div>
                            <div className="text-5xl font-bold text-cyan-400">
                              {analystRatingsData.snapshot.ratingScore?.toFixed(1) || analystRatingsData.snapshot.overallScore || 'â€”'}
                            </div>
                            <div className="text-xs text-slate-400 mt-1">out of 5.0</div>
                          </div>
                          <div className="text-center">
                            <div className="text-xs text-slate-500 mb-2">Price Target (Last Quarter)</div>
                            <div className="text-3xl font-bold text-purple-400">
                              ${(analystRatingsData.priceTargetSummary?.lastQuarterAvgPriceTarget || 
                                  analystRatingsData.priceTargetConsensus?.targetConsensus || 
                                  analystRatingsData.priceTarget?.lastQuarterAvgPriceTarget)?.toFixed(2) || 'â€”'}
                            </div>
                            <div className="text-xs text-slate-400 mt-1">
                              {(analystRatingsData.priceTargetSummary?.lastQuarterCount || 
                                analystRatingsData.priceTarget?.lastQuarterCount) ? 
                                `${analystRatingsData.priceTargetSummary?.lastQuarterCount || analystRatingsData.priceTarget?.lastQuarterCount} analysts` : 
                                'Consensus'}
                            </div>
                            {stock.price && (analystRatingsData.priceTargetSummary?.lastQuarterAvgPriceTarget || analystRatingsData.priceTarget?.lastQuarterAvgPriceTarget) && (
                              <div className={`text-sm font-bold mt-1 ${
                                ((analystRatingsData.priceTargetSummary?.lastQuarterAvgPriceTarget || analystRatingsData.priceTarget?.lastQuarterAvgPriceTarget) / stock.price - 1) * 100 > 0
                                  ? 'text-green-400' : 'text-red-400'
                              }`}>
                                {(((analystRatingsData.priceTargetSummary?.lastQuarterAvgPriceTarget || analystRatingsData.priceTarget?.lastQuarterAvgPriceTarget) / stock.price - 1) * 100).toFixed(1)}% upside
                              </div>
                            )}
                          </div>
                        </div>
                        
                        {/* Enhanced Price Target Timeline */}
                        {(analystRatingsData.priceTargetSummary || analystRatingsData.priceTarget) && (
                          <div className="mt-6 pt-6 border-t border-slate-700/30">
                            <h5 className="text-xs font-bold text-slate-400 mb-3 uppercase tracking-wide">Price Target Timeline</h5>
                            <div className="grid grid-cols-4 gap-4">
                              {(analystRatingsData.priceTargetSummary?.lastMonthAvgPriceTarget || analystRatingsData.priceTarget?.lastMonthAvgPriceTarget) && (
                                <div className="glass-card p-4 rounded-lg text-center">
                                  <div className="text-xs text-slate-500 mb-2">Last Month</div>
                                  <div className="text-2xl font-bold text-green-400">
                                    ${(analystRatingsData.priceTargetSummary?.lastMonthAvgPriceTarget || analystRatingsData.priceTarget?.lastMonthAvgPriceTarget).toFixed(2)}
                                  </div>
                                  <div className="text-xs text-slate-400 mt-1">
                                    {analystRatingsData.priceTargetSummary?.lastMonthCount || analystRatingsData.priceTarget?.lastMonthCount || 0} analysts
                                  </div>
                                </div>
                              )}
                              {(analystRatingsData.priceTargetSummary?.lastQuarterAvgPriceTarget || analystRatingsData.priceTarget?.lastQuarterAvgPriceTarget) && (
                                <div className="glass-card p-4 rounded-lg text-center">
                                  <div className="text-xs text-slate-500 mb-2">Last Quarter</div>
                                  <div className="text-2xl font-bold text-cyan-400">
                                    ${(analystRatingsData.priceTargetSummary?.lastQuarterAvgPriceTarget || analystRatingsData.priceTarget?.lastQuarterAvgPriceTarget).toFixed(2)}
                                  </div>
                                  <div className="text-xs text-slate-400 mt-1">
                                    {analystRatingsData.priceTargetSummary?.lastQuarterCount || analystRatingsData.priceTarget?.lastQuarterCount || 0} analysts
                                  </div>
                                </div>
                              )}
                              {(analystRatingsData.priceTargetSummary?.lastYearAvgPriceTarget || analystRatingsData.priceTarget?.lastYearAvgPriceTarget) && (
                                <div className="glass-card p-4 rounded-lg text-center">
                                  <div className="text-xs text-slate-500 mb-2">Last Year</div>
                                  <div className="text-2xl font-bold text-blue-400">
                                    ${(analystRatingsData.priceTargetSummary?.lastYearAvgPriceTarget || analystRatingsData.priceTarget?.lastYearAvgPriceTarget).toFixed(2)}
                                  </div>
                                  <div className="text-xs text-slate-400 mt-1">
                                    {analystRatingsData.priceTargetSummary?.lastYearCount || analystRatingsData.priceTarget?.lastYearCount || 0} analysts
                                  </div>
                                </div>
                              )}
                              {(analystRatingsData.priceTargetSummary?.allTimeAvgPriceTarget || analystRatingsData.priceTarget?.allTimeAvgPriceTarget) && (
                                <div className="glass-card p-4 rounded-lg text-center">
                                  <div className="text-xs text-slate-500 mb-2">All Time</div>
                                  <div className="text-2xl font-bold text-purple-400">
                                    ${(analystRatingsData.priceTargetSummary?.allTimeAvgPriceTarget || analystRatingsData.priceTarget?.allTimeAvgPriceTarget).toFixed(2)}
                                  </div>
                                  <div className="text-xs text-slate-400 mt-1">
                                    {analystRatingsData.priceTargetSummary?.allTimeCount || analystRatingsData.priceTarget?.allTimeCount || 0} analysts
                                  </div>
                                </div>
                              )}
                            </div>
                            
                            {/* Price Target Trend */}
                            {(analystRatingsData.priceTargetSummary?.lastMonthAvgPriceTarget && 
                              analystRatingsData.priceTargetSummary?.lastQuarterAvgPriceTarget && 
                              analystRatingsData.priceTargetSummary?.lastYearAvgPriceTarget) && (
                              <div className="mt-4 text-center text-sm">
                                <span className="text-slate-400">Trend: </span>
                                {analystRatingsData.priceTargetSummary.lastMonthAvgPriceTarget > analystRatingsData.priceTargetSummary.lastQuarterAvgPriceTarget ? (
                                  <span className="text-green-400 font-bold">ğŸ“ˆ Increasing (Recent upgrades)</span>
                                ) : analystRatingsData.priceTargetSummary.lastMonthAvgPriceTarget < analystRatingsData.priceTargetSummary.lastQuarterAvgPriceTarget ? (
                                  <span className="text-red-400 font-bold">ğŸ“‰ Decreasing (Recent downgrades)</span>
                                ) : (
                                  <span className="text-yellow-400 font-bold">â¡ï¸ Stable</span>
                                )}
                              </div>
                            )}
                          </div>
                        )}
                        
                        {/* Consensus Data */}
                        {(analystRatingsData.priceTargetConsensus) && (
                          <div className="mt-6 pt-6 border-t border-slate-700/30">
                            <h5 className="text-xs font-bold text-slate-400 mb-3 uppercase tracking-wide">Consensus Range</h5>
                            <div className="grid grid-cols-3 gap-4 text-center">
                              {analystRatingsData.priceTargetConsensus.targetLow && (
                                <div className="glass-card p-3 rounded-lg">
                                  <div className="text-xs text-slate-500 mb-1">Low</div>
                                  <div className="text-xl font-bold text-red-400">
                                    ${analystRatingsData.priceTargetConsensus.targetLow.toFixed(2)}
                                  </div>
                                </div>
                              )}
                              {analystRatingsData.priceTargetConsensus.targetMedian && (
                                <div className="glass-card p-3 rounded-lg">
                                  <div className="text-xs text-slate-500 mb-1">Median</div>
                                  <div className="text-xl font-bold text-cyan-400">
                                    ${analystRatingsData.priceTargetConsensus.targetMedian.toFixed(2)}
                                  </div>
                                </div>
                              )}
                              {analystRatingsData.priceTargetConsensus.targetHigh && (
                                <div className="glass-card p-3 rounded-lg">
                                  <div className="text-xs text-slate-500 mb-1">High</div>
                                  <div className="text-xl font-bold text-green-400">
                                    ${analystRatingsData.priceTargetConsensus.targetHigh.toFixed(2)}
                                  </div>
                                </div>
                              )}
                            </div>
                          </div>
                        )}
                      </div>
                    </div>
                  )}
                  
                  {/* Price Target Details - Standalone Section */}
                  {(analystRatingsData.priceTargetSummary || analystRatingsData.priceTargetConsensus) && (
                    <div>
                      <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Analyst Price Targets</h4>
                      <div className="glass-card p-6 rounded-xl">
                        {/* Price Target Timeline */}
                        {analystRatingsData.priceTargetSummary && (
                          <div>
                            <h5 className="text-xs font-bold text-slate-400 mb-3 uppercase tracking-wide">Price Target Timeline</h5>
                            <div className="grid grid-cols-4 gap-4">
                              {analystRatingsData.priceTargetSummary.lastMonthAvgPriceTarget && (
                                <div className="glass-card p-4 rounded-lg text-center">
                                  <div className="text-xs text-slate-500 mb-2">Last Month</div>
                                  <div className="text-2xl font-bold text-green-400">
                                    ${analystRatingsData.priceTargetSummary.lastMonthAvgPriceTarget.toFixed(2)}
                                  </div>
                                  <div className="text-xs text-slate-400 mt-1">
                                    {analystRatingsData.priceTargetSummary.lastMonthCount || 0} analysts
                                  </div>
                                  {stock.price && (
                                    <div className={`text-xs font-bold mt-1 ${
                                      (analystRatingsData.priceTargetSummary.lastMonthAvgPriceTarget / stock.price - 1) * 100 > 0
                                        ? 'text-green-400' : 'text-red-400'
                                    }`}>
                                      {((analystRatingsData.priceTargetSummary.lastMonthAvgPriceTarget / stock.price - 1) * 100).toFixed(1)}%
                                    </div>
                                  )}
                                </div>
                              )}
                              {analystRatingsData.priceTargetSummary.lastQuarterAvgPriceTarget && (
                                <div className="glass-card p-4 rounded-lg text-center">
                                  <div className="text-xs text-slate-500 mb-2">Last Quarter</div>
                                  <div className="text-2xl font-bold text-cyan-400">
                                    ${analystRatingsData.priceTargetSummary.lastQuarterAvgPriceTarget.toFixed(2)}
                                  </div>
                                  <div className="text-xs text-slate-400 mt-1">
                                    {analystRatingsData.priceTargetSummary.lastQuarterCount || 0} analysts
                                  </div>
                                  {stock.price && (
                                    <div className={`text-xs font-bold mt-1 ${
                                      (analystRatingsData.priceTargetSummary.lastQuarterAvgPriceTarget / stock.price - 1) * 100 > 0
                                        ? 'text-green-400' : 'text-red-400'
                                    }`}>
                                      {((analystRatingsData.priceTargetSummary.lastQuarterAvgPriceTarget / stock.price - 1) * 100).toFixed(1)}%
                                    </div>
                                  )}
                                </div>
                              )}
                              {analystRatingsData.priceTargetSummary.lastYearAvgPriceTarget && (
                                <div className="glass-card p-4 rounded-lg text-center">
                                  <div className="text-xs text-slate-500 mb-2">Last Year</div>
                                  <div className="text-2xl font-bold text-blue-400">
                                    ${analystRatingsData.priceTargetSummary.lastYearAvgPriceTarget.toFixed(2)}
                                  </div>
                                  <div className="text-xs text-slate-400 mt-1">
                                    {analystRatingsData.priceTargetSummary.lastYearCount || 0} analysts
                                  </div>
                                  {stock.price && (
                                    <div className={`text-xs font-bold mt-1 ${
                                      (analystRatingsData.priceTargetSummary.lastYearAvgPriceTarget / stock.price - 1) * 100 > 0
                                        ? 'text-green-400' : 'text-red-400'
                                    }`}>
                                      {((analystRatingsData.priceTargetSummary.lastYearAvgPriceTarget / stock.price - 1) * 100).toFixed(1)}%
                                    </div>
                                  )}
                                </div>
                              )}
                              {analystRatingsData.priceTargetSummary.allTimeAvgPriceTarget && (
                                <div className="glass-card p-4 rounded-lg text-center">
                                  <div className="text-xs text-slate-500 mb-2">All Time</div>
                                  <div className="text-2xl font-bold text-purple-400">
                                    ${analystRatingsData.priceTargetSummary.allTimeAvgPriceTarget.toFixed(2)}
                                  </div>
                                  <div className="text-xs text-slate-400 mt-1">
                                    {analystRatingsData.priceTargetSummary.allTimeCount || 0} analysts
                                  </div>
                                  {stock.price && (
                                    <div className={`text-xs font-bold mt-1 ${
                                      (analystRatingsData.priceTargetSummary.allTimeAvgPriceTarget / stock.price - 1) * 100 > 0
                                        ? 'text-green-400' : 'text-red-400'
                                    }`}>
                                      {((analystRatingsData.priceTargetSummary.allTimeAvgPriceTarget / stock.price - 1) * 100).toFixed(1)}%
                                    </div>
                                  )}
                                </div>
                              )}
                            </div>
                            
                            {/* Price Target Trend */}
                            {(analystRatingsData.priceTargetSummary.lastMonthAvgPriceTarget && 
                              analystRatingsData.priceTargetSummary.lastQuarterAvgPriceTarget && 
                              analystRatingsData.priceTargetSummary.lastYearAvgPriceTarget) && (
                              <div className="mt-4 text-center text-sm">
                                <span className="text-slate-400">Trend: </span>
                                {analystRatingsData.priceTargetSummary.lastMonthAvgPriceTarget > analystRatingsData.priceTargetSummary.lastQuarterAvgPriceTarget ? (
                                  <span className="text-green-400 font-bold">ğŸ“ˆ Increasing (Recent upgrades)</span>
                                ) : analystRatingsData.priceTargetSummary.lastMonthAvgPriceTarget < analystRatingsData.priceTargetSummary.lastQuarterAvgPriceTarget ? (
                                  <span className="text-red-400 font-bold">ğŸ“‰ Decreasing (Recent downgrades)</span>
                                ) : (
                                  <span className="text-yellow-400 font-bold">â¡ï¸ Stable</span>
                                )}
                              </div>
                            )}
                          </div>
                        )}
                        
                        {/* Consensus Range */}
                        {analystRatingsData.priceTargetConsensus && (
                          <div className={analystRatingsData.priceTargetSummary ? "mt-6 pt-6 border-t border-slate-700/30" : ""}>
                            <h5 className="text-xs font-bold text-slate-400 mb-3 uppercase tracking-wide">Consensus Range</h5>
                            <div className="grid grid-cols-3 gap-4 text-center">
                              {analystRatingsData.priceTargetConsensus.targetLow && (
                                <div className="glass-card p-3 rounded-lg">
                                  <div className="text-xs text-slate-500 mb-1">Low</div>
                                  <div className="text-xl font-bold text-red-400">
                                    ${analystRatingsData.priceTargetConsensus.targetLow.toFixed(2)}
                                  </div>
                                </div>
                              )}
                              {analystRatingsData.priceTargetConsensus.targetMedian && (
                                <div className="glass-card p-3 rounded-lg">
                                  <div className="text-xs text-slate-500 mb-1">Median</div>
                                  <div className="text-xl font-bold text-cyan-400">
                                    ${analystRatingsData.priceTargetConsensus.targetMedian.toFixed(2)}
                                  </div>
                                </div>
                              )}
                              {analystRatingsData.priceTargetConsensus.targetHigh && (
                                <div className="glass-card p-3 rounded-lg">
                                  <div className="text-xs text-slate-500 mb-1">High</div>
                                  <div className="text-xl font-bold text-green-400">
                                    ${analystRatingsData.priceTargetConsensus.targetHigh.toFixed(2)}
                                  </div>
                                </div>
                              )}
                            </div>
                          </div>
                        )}
                      </div>
                    </div>
                  )}
                  
                  {/* Component Scores (Only if snapshot exists) */}
                  {analystRatingsData.snapshot && (
                    <div>
                      <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Component Scores</h4>
                      <div className="glass-card p-6 rounded-xl">
                        <div className="grid grid-cols-6 gap-4">
                          <div className="text-center glass-card p-3 rounded-lg">
                            <div className="text-xs text-slate-500 mb-1">DCF</div>
                            <div className="text-2xl font-bold text-cyan-400">
                              {analystRatingsData.snapshot.discountedCashFlowScore || 'â€”'}
                            </div>
                          </div>
                          <div className="text-center glass-card p-3 rounded-lg">
                            <div className="text-xs text-slate-500 mb-1">ROE</div>
                            <div className="text-2xl font-bold text-green-400">
                              {analystRatingsData.snapshot.returnOnEquityScore || 'â€”'}
                            </div>
                          </div>
                          <div className="text-center glass-card p-3 rounded-lg">
                            <div className="text-xs text-slate-500 mb-1">ROA</div>
                            <div className="text-2xl font-bold text-blue-400">
                              {analystRatingsData.snapshot.returnOnAssetsScore || 'â€”'}
                            </div>
                          </div>
                          <div className="text-center glass-card p-3 rounded-lg">
                            <div className="text-xs text-slate-500 mb-1">D/E</div>
                            <div className="text-2xl font-bold text-purple-400">
                              {analystRatingsData.snapshot.debtToEquityScore || 'â€”'}
                            </div>
                          </div>
                          <div className="text-center glass-card p-3 rounded-lg">
                            <div className="text-xs text-slate-500 mb-1">P/E</div>
                            <div className="text-2xl font-bold text-yellow-400">
                              {analystRatingsData.snapshot.priceToEarningsScore || 'â€”'}
                            </div>
                          </div>
                          <div className="text-center glass-card p-3 rounded-lg">
                            <div className="text-xs text-slate-500 mb-1">P/B</div>
                            <div className="text-2xl font-bold text-orange-400">
                              {analystRatingsData.snapshot.priceToBookScore || 'â€”'}
                            </div>
                          </div>
                        </div>
                        
                        {/* Score Legend */}
                        <div className="mt-4 pt-4 border-t border-slate-700/30 text-center text-xs text-slate-500">
                          Component Scores: DCF (Discounted Cash Flow) â€¢ ROE (Return on Equity) â€¢ ROA (Return on Assets) â€¢ D/E (Debt to Equity) â€¢ P/E (Price to Earnings) â€¢ P/B (Price to Book)
                        </div>
                      </div>
                    </div>
                  )}
                  
                  {/* Analyst Consensus from Grades Summary */}
                  {analystRatingsData.consensus && (
                    <div>
                      <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Analyst Consensus</h4>
                      <div className="glass-card p-6 rounded-xl">
                        <div className="grid grid-cols-2 gap-6">
                          {/* Consensus Breakdown */}
                          <div>
                            <div className="text-center mb-4">
                              <div className="text-xs text-slate-500 mb-2">Consensus</div>
                              <div className={`text-4xl font-bold ${
                                analystRatingsData.consensus.consensus === 'Strong Buy' || analystRatingsData.consensus.consensus === 'Buy' ? 'text-green-400' :
                                analystRatingsData.consensus.consensus === 'Hold' ? 'text-yellow-400' :
                                'text-red-400'
                              }`}>
                                {analystRatingsData.consensus.consensus || 'N/A'}
                              </div>
                            </div>
                            
                            <div className="grid grid-cols-3 gap-3 text-center text-xs">
                              <div className="glass-card p-3 rounded-lg">
                                <div className="text-green-400 font-bold text-2xl">
                                  {(analystRatingsData.consensus.strongBuy || 0) + (analystRatingsData.consensus.buy || 0)}
                                </div>
                                <div className="text-slate-500 mt-1">Buy</div>
                              </div>
                              <div className="glass-card p-3 rounded-lg">
                                <div className="text-yellow-400 font-bold text-2xl">
                                  {analystRatingsData.consensus.hold || 0}
                                </div>
                                <div className="text-slate-500 mt-1">Hold</div>
                              </div>
                              <div className="glass-card p-3 rounded-lg">
                                <div className="text-red-400 font-bold text-2xl">
                                  {(analystRatingsData.consensus.sell || 0) + (analystRatingsData.consensus.strongSell || 0)}
                                </div>
                                <div className="text-slate-500 mt-1">Sell</div>
                              </div>
                            </div>
                          </div>
                          
                          {/* Detailed Breakdown */}
                          <div className="space-y-3">
                            <div className="flex justify-between items-center">
                              <span className="text-sm text-slate-400">Strong Buy</span>
                              <span className="text-green-400 font-bold">{analystRatingsData.consensus.strongBuy || 0}</span>
                            </div>
                            <div className="flex justify-between items-center">
                              <span className="text-sm text-slate-400">Buy</span>
                              <span className="text-green-300 font-bold">{analystRatingsData.consensus.buy || 0}</span>
                            </div>
                            <div className="flex justify-between items-center">
                              <span className="text-sm text-slate-400">Hold</span>
                              <span className="text-yellow-400 font-bold">{analystRatingsData.consensus.hold || 0}</span>
                            </div>
                            <div className="flex justify-between items-center">
                              <span className="text-sm text-slate-400">Sell</span>
                              <span className="text-red-300 font-bold">{analystRatingsData.consensus.sell || 0}</span>
                            </div>
                            <div className="flex justify-between items-center">
                              <span className="text-sm text-slate-400">Strong Sell</span>
                              <span className="text-red-400 font-bold">{analystRatingsData.consensus.strongSell || 0}</span>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                  
                  {/* Price Target Details */}
                  {analystRatingsData.priceTarget && (
                    <div>
                      <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Price Target Details</h4>
                      <div className="glass-card p-6 rounded-xl">
                        <div className="grid grid-cols-3 gap-6">
                          <div className="text-center">
                            <div className="text-xs text-slate-500 mb-2">Last Month Average</div>
                            <div className="text-2xl font-bold text-blue-400">
                              ${analystRatingsData.priceTarget.lastMonthAvgPriceTarget?.toFixed(2) || 'â€”'}
                            </div>
                            <div className="text-xs text-slate-400 mt-1">
                              {analystRatingsData.priceTarget.lastMonthCount || 0} analysts
                            </div>
                          </div>
                          <div className="text-center">
                            <div className="text-xs text-slate-500 mb-2">Last Quarter Average</div>
                            <div className="text-2xl font-bold text-cyan-400">
                              ${analystRatingsData.priceTarget.lastQuarterAvgPriceTarget?.toFixed(2) || 'â€”'}
                            </div>
                            <div className="text-xs text-slate-400 mt-1">
                              {analystRatingsData.priceTarget.lastQuarterCount || 0} analysts
                            </div>
                          </div>
                          <div className="text-center">
                            <div className="text-xs text-slate-500 mb-2">Last Year Average</div>
                            <div className="text-2xl font-bold text-purple-400">
                              ${analystRatingsData.priceTarget.lastYearAvgPriceTarget?.toFixed(2) || 'â€”'}
                            </div>
                            <div className="text-xs text-slate-400 mt-1">
                              {analystRatingsData.priceTarget.lastYearCount || 0} analysts
                            </div>
                          </div>
                        </div>
                        
                        {/* Upside Calculation */}
                        <div className="mt-6 pt-6 border-t border-slate-700/30">
                          <div className="text-center">
                            <div className="text-sm text-slate-400 mb-2">
                              Current Price: <span className="text-white font-semibold">${stock.price?.toFixed(2)}</span>
                            </div>
                            <div className="text-xs text-slate-500">
                              Potential Upside: 
                              <span className={`ml-2 text-lg font-bold ${
                                stock.upside > 0 ? 'text-green-400' : 'text-red-400'
                              }`}>
                                {stock.upside?.toFixed(1) || ((analystRatingsData.priceTarget.lastQuarterAvgPriceTarget - stock.price) / stock.price * 100).toFixed(1)}%
                              </span>
                              {stock.upside > 0 ? ' ğŸ“ˆ' : ' ğŸ“‰'}
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                  
                  {/* Recent Analyst Grade Changes */}
                  {analystRatingsData.recentGrades && analystRatingsData.recentGrades.length > 0 && (
                    <div>
                      <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Recent Analyst Activity</h4>
                      <div className="space-y-2">
                        {analystRatingsData.recentGrades.slice(0, 10).map((grade, i) => (
                          <div key={i} className="glass-card p-4 rounded-xl">
                            <div className="flex items-start justify-between">
                              <div className="flex-1">
                                <div className="flex items-center gap-3 mb-2">
                                  <span className="font-semibold text-white">
                                    {grade.gradingCompany || grade.firm || grade.analystFirm || grade.analystName || grade.company || 'Unknown Analyst'}
                                  </span>
                                  <span className={`chip text-xs px-3 py-1 rounded-full ${
                                    grade.newGrade?.toLowerCase().includes('buy') || grade.newGrade?.toLowerCase().includes('outperform') || 
                                    grade.newGrade?.toLowerCase().includes('overweight') ? 
                                      'bg-green-500/20 text-green-400 border border-green-500/30' :
                                    grade.newGrade?.toLowerCase().includes('sell') || grade.newGrade?.toLowerCase().includes('underperform') ||
                                    grade.newGrade?.toLowerCase().includes('underweight') ?
                                      'bg-red-500/20 text-red-400 border border-red-500/30' :
                                      'bg-yellow-500/20 text-yellow-400 border border-yellow-500/30'
                                  }`}>
                                    {grade.newGrade || grade.grade || 'N/A'}
                                  </span>
                                  {grade.previousGrade && grade.previousGrade !== grade.newGrade && (
                                    <span className="text-xs text-slate-500">
                                      from {grade.previousGrade}
                                    </span>
                                  )}
                                </div>
                                <div className="text-sm text-slate-400">
                                  {grade.action === 'up' || grade.action === 'upgrade' ? 'ğŸ“ˆ Upgrade' : 
                                   grade.action === 'down' || grade.action === 'downgrade' ? 'ğŸ“‰ Downgrade' : 
                                   grade.action === 'init' || grade.action === 'initiated' ? 'ğŸ†• Initiated' : 
                                   grade.action === 'main' || grade.action === 'maintained' ? 'ğŸ”„ Maintained' :
                                   'ğŸ”„ ' + (grade.action || 'Update')}
                                </div>
                              </div>
                              <div className="text-xs text-slate-500 text-right">
                                {grade.date || grade.publishedDate ? new Date(grade.date || grade.publishedDate).toLocaleDateString() : 'N/A'}
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  )}
                  
                  {/* If no data at all */}
                  {!analystRatingsData.snapshot && !analystRatingsData.consensus && 
                   !analystRatingsData.priceTarget && (!analystRatingsData.recentGrades || analystRatingsData.recentGrades.length === 0) && (
                    <div className="glass-card p-8 rounded-xl text-center">
                      <div className="text-slate-400 text-lg mb-2">ğŸ“Š No Analyst Data Available</div>
                      <div className="text-slate-500 text-sm">
                        Analyst ratings data is not available for this stock.
                      </div>
                    </div>
                  )}
                </div>
              ) : activeTab === 'insider' && insiderData !== null && insiderData !== undefined ? (
                <div className="space-y-4">
                  <h3 className="text-lg font-bold text-white">Insider Trading Activity</h3>
                  {insiderData === 'PREMIUM_REQUIRED' ? (
                    <div className="glass-card p-8 rounded-xl text-center">
                      <div className="text-6xl mb-4">ğŸ”’</div>
                      <div className="text-xl font-bold text-white mb-2">Premium Feature</div>
                      <div className="text-slate-400 mb-4">
                        Insider trading data requires a paid Financial Modeling Prep subscription.
                      </div>
                      <div className="text-sm text-slate-500">
                        Available endpoints: Stock quotes, fundamentals, technical indicators
                      </div>
                    </div>
                  ) : insiderData?.type === 'combined' ? (
                    <div className="space-y-4">
                      {/* Statistics Summary */}
                      {insiderData.statistics && (
                        <div className="glass-card p-6 rounded-xl">
                          <h4 className="text-sm font-bold text-slate-400 mb-4">Last 4 Quarters Summary</h4>
                          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div className="text-center">
                              <div className="text-xs text-slate-500 mb-2">Total Trades</div>
                              <div className="text-3xl font-bold text-cyan-400">
                                {insiderData.statistics.totalTransactions || 0}
                              </div>
                            </div>
                            <div className="text-center">
                              <div className="text-xs text-slate-500 mb-2">Shares Purchased</div>
                              <div className="text-3xl font-bold text-green-400">
                                {formatNumber(insiderData.statistics.totalBought || 0, 0)}
                              </div>
                            </div>
                            <div className="text-center">
                              <div className="text-xs text-slate-500 mb-2">Shares Sold</div>
                              <div className="text-3xl font-bold text-red-400">
                                {formatNumber(insiderData.statistics.totalSold || 0, 0)}
                              </div>
                            </div>
                            <div className="text-center">
                              <div className="text-xs text-slate-500 mb-2">Net Position</div>
                              <div className={`text-3xl font-bold ${
                                (insiderData.statistics.totalBought - insiderData.statistics.totalSold) > 0 ? 'text-green-400' : 'text-red-400'
                              }`}>
                                {insiderData.statistics.totalBought - insiderData.statistics.totalSold > 0 ? '+' : ''}
                                {formatNumber((insiderData.statistics.totalBought - insiderData.statistics.totalSold) || 0, 0)}
                              </div>
                            </div>
                          </div>
                          
                          <div className="mt-4 pt-4 border-t border-slate-700">
                            <div className="flex justify-between items-center">
                              <span className="text-sm text-slate-400">Buy/Sell Ratio</span>
                              <span className="text-white font-bold">
                                {insiderData.statistics.totalSold > 0 
                                  ? (insiderData.statistics.totalBought / insiderData.statistics.totalSold).toFixed(2) 
                                  : 'N/A'}
                              </span>
                            </div>
                          </div>
                        </div>
                      )}
                      
                      {/* Latest Individual Transactions */}
                      {insiderData.latestTrades && insiderData.latestTrades.length > 0 && (
                        <>
                          <div className="flex items-center justify-between">
                            <h4 className="text-sm font-bold text-slate-400">Latest Transactions</h4>
                            <span className="text-xs text-slate-500">
                              Showing {insiderData.latestTrades.length} recent {insiderData.latestTrades.length === 1 ? 'trade' : 'trades'}
                            </span>
                          </div>
                          
                          <div className="space-y-2 max-h-[500px] overflow-y-auto">
                            {insiderData.latestTrades.map((trade, i) => (
                              <div key={i} className="glass-card p-4 rounded-xl hover:bg-slate-800/50 transition-all">
                                <div className="flex items-start justify-between">
                                  <div className="flex-1">
                                    <div className="flex items-center gap-2 mb-1">
                                      <span className="font-semibold text-white">{trade.reportingName || 'Unknown'}</span>
                                      <span className={`chip text-xs px-2 py-1 rounded ${
                                        trade.acquisitionOrDisposition === 'A' 
                                          ? 'bg-green-500/20 text-green-400 border border-green-500/30' 
                                          : 'bg-red-500/20 text-red-400 border border-red-500/30'
                                      }`}>
                                        {trade.acquisitionOrDisposition === 'A' ? 'ğŸ“ˆ Buy' : 'ğŸ“‰ Sell'}
                                      </span>
                                      <span className="text-xs text-slate-500 border border-slate-700 px-2 py-1 rounded">
                                        {trade.transactionType || 'N/A'}
                                      </span>
                                    </div>
                                    <div className="text-xs text-slate-400 mb-2">{trade.typeOfOwner || 'N/A'}</div>
                                    <div className="text-sm text-slate-300 flex items-center gap-3">
                                      <span className="font-mono">
                                        {formatNumber(trade.securitiesTransacted || 0, 0)} shares
                                      </span>
                                      {trade.price > 0 && (
                                        <>
                                          <span className="text-slate-600">@</span>
                                          <span className="font-mono">${(trade.price || 0).toFixed(2)}</span>
                                          <span className="text-slate-600">â€¢</span>
                                          <span className="text-slate-500">
                                            Total: {formatNumber((trade.securitiesTransacted || 0) * (trade.price || 0))}
                                          </span>
                                        </>
                                      )}
                                    </div>
                                    <div className="text-xs text-slate-500 mt-1">
                                      Holdings after: {formatNumber(trade.securitiesOwned || 0, 0)} shares
                                    </div>
                                  </div>
                                  <div className="text-xs text-slate-500 text-right">
                                    <div>{trade.filingDate ? new Date(trade.filingDate).toLocaleDateString() : 'N/A'}</div>
                                    {trade.transactionDate && trade.transactionDate !== trade.filingDate && (
                                      <div className="text-slate-600 text-xs">Trade: {new Date(trade.transactionDate).toLocaleDateString()}</div>
                                    )}
                                  </div>
                                </div>
                              </div>
                            ))}
                          </div>
                          
                          <div className="text-sm text-slate-500 bg-slate-800/50 p-3 rounded-lg text-center">
                            ğŸ’¡ Insider buying can signal confidence, while selling may be routine diversification. 
                            Look for unusual patterns or clusters of activity.
                          </div>
                        </>
                      )}
                      
                      {/* No trades but have statistics */}
                      {(!insiderData.latestTrades || insiderData.latestTrades.length === 0) && insiderData.statistics && (
                        <div className="glass-card p-6 rounded-xl text-center">
                          <div className="text-slate-400">No recent individual transactions available</div>
                        </div>
                      )}
                    </div>
                  ) : insiderData?.type === 'statistics' && insiderData?.statistics ? (
                    <div className="space-y-4">
                      <div className="glass-card p-6 rounded-xl">
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                          <div className="text-center">
                            <div className="text-xs text-slate-500 mb-2">Total Trades</div>
                            <div className="text-3xl font-bold text-cyan-400">
                              {insiderData.statistics.totalTransactions || 0}
                            </div>
                          </div>
                          <div className="text-center">
                            <div className="text-xs text-slate-500 mb-2">Purchases</div>
                            <div className="text-3xl font-bold text-green-400">
                              {insiderData.statistics.totalBought || 0}
                            </div>
                            <div className="text-xs text-slate-400 mt-1">
                              ${((insiderData.statistics.totalBoughtValue || 0) / 1000000).toFixed(1)}M
                            </div>
                          </div>
                          <div className="text-center">
                            <div className="text-xs text-slate-500 mb-2">Sales</div>
                            <div className="text-3xl font-bold text-red-400">
                              {insiderData.statistics.totalSold || 0}
                            </div>
                            <div className="text-xs text-slate-400 mt-1">
                              ${((insiderData.statistics.totalSoldValue || 0) / 1000000).toFixed(1)}M
                            </div>
                          </div>
                          <div className="text-center">
                            <div className="text-xs text-slate-500 mb-2">Net Position</div>
                            <div className={`text-3xl font-bold ${
                              (insiderData.statistics.totalBought - insiderData.statistics.totalSold) > 0 ? 'text-green-400' : 'text-red-400'
                            }`}>
                              {insiderData.statistics.totalBought - insiderData.statistics.totalSold > 0 ? '+' : ''}
                              {insiderData.statistics.totalBought - insiderData.statistics.totalSold}
                            </div>
                            <div className="text-xs text-slate-400 mt-1">
                              ${(((insiderData.statistics.totalBoughtValue || 0) - (insiderData.statistics.totalSoldValue || 0)) / 1000000).toFixed(1)}M
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <div className="glass-card p-6 rounded-xl">
                        <div className="text-sm font-bold text-slate-400 mb-4">Insider Sentiment</div>
                        <div className="space-y-4">
                          <div>
                            <div className="flex justify-between text-sm mb-2">
                              <span className="text-slate-400">Buy/Sell Ratio</span>
                              <span className="text-white font-bold">
                                {insiderData.statistics.totalSold > 0 
                                  ? (insiderData.statistics.totalBought / insiderData.statistics.totalSold).toFixed(2) 
                                  : 'N/A'}
                              </span>
                            </div>
                            <div className="flex justify-between text-sm">
                              <span className="text-slate-400">Period</span>
                              <span className="text-white font-bold">Last 6 Months</span>
                            </div>
                          </div>
                          
                          <div className="text-sm text-slate-500 bg-slate-800/50 p-3 rounded-lg">
                            ğŸ’¡ Insider buying can signal confidence, while selling may be routine diversification. 
                            Look for unusual patterns or clusters of activity.
                          </div>
                        </div>
                      </div>
                    </div>
                  ) : Array.isArray(insiderData) && insiderData.length === 0 ? (
                    <div className="glass-card p-8 rounded-xl text-center">
                      <div className="text-6xl mb-4">ğŸ“Š</div>
                      <div className="text-xl font-bold text-white mb-2">No Insider Trades Found</div>
                      <div className="text-slate-400 mb-4">
                        No insider trading activity found for {stock.symbol}.
                      </div>
                      <div className="text-sm text-slate-500">
                        This stock may have very low insider activity.
                      </div>
                    </div>
                  ) : (
                    <>
                      {/* Show date range if we have data */}
                      {Array.isArray(insiderData) && insiderData.length > 0 && (
                        <div className="glass-card p-3 rounded-lg mb-4 text-center">
                          <div className="text-sm text-slate-400">
                            Showing {insiderData.length} insider {insiderData.length === 1 ? 'trade' : 'trades'}
                            {insiderData[0]?.filingDate && insiderData[insiderData.length - 1]?.filingDate && (
                              <span className="ml-2">
                                ({new Date(insiderData[insiderData.length - 1].filingDate).toLocaleDateString()} - {new Date(insiderData[0].filingDate).toLocaleDateString()})
                              </span>
                            )}
                          </div>
                        </div>
                      )}
                      <div className="space-y-2 max-h-[600px] overflow-y-auto">
                        {(insiderData || []).map((trade, i) => (
                      <div key={i} className="glass-card p-4 rounded-xl">
                        <div className="flex items-start justify-between">
                          <div className="flex-1">
                            <div className="flex items-center gap-2 mb-1">
                              <span className="font-semibold text-white">{trade.reportingName || 'Unknown'}</span>
                              <span className={`chip text-xs ${trade.transactionType?.toLowerCase().includes('purchase') || trade.transactionType?.toLowerCase().includes('buy') ? 'bg-green-500/20 text-green-400 border border-green-500/30' : 'bg-red-500/20 text-red-400 border border-red-500/30'}`}>
                                {trade.transactionType || 'N/A'}
                              </span>
                            </div>
                            <div className="text-xs text-slate-400">{trade.typeOfOwner || 'N/A'}</div>
                            <div className="text-sm text-slate-300 mt-2">
                              <span className="font-mono">{formatNumber(trade.securitiesTransacted || 0, 0)} shares</span> @ 
                              <span className="font-mono ml-1">${(trade.price || 0).toFixed(2)}</span>
                              <span className="ml-2 text-slate-500">Total: {formatNumber((trade.securitiesTransacted || 0) * (trade.price || 0))}</span>
                            </div>
                          </div>
                          <div className="text-xs text-slate-500 text-right">
                            {trade.filingDate ? new Date(trade.filingDate).toLocaleDateString() : 'N/A'}
                          </div>
                        </div>
                      </div>
                      ))}
                    </div>
                    </>
                  )}
                </div>
              ) : activeTab === 'earnings' && analystEstimates ? (
                <div className="space-y-6">
                  <h3 className="text-xl font-bold text-white">Earnings Performance vs Estimates</h3>
                  
                  {/* Check if earnings data is available */}
                  {(!analystEstimates.quarterly || analystEstimates.quarterly.length === 0) ? (
                    <div className="glass-card p-8 rounded-xl text-center">
                      <div className="text-6xl mb-4">ğŸ“Š</div>
                      <div className="text-xl font-bold text-white mb-2">Earnings Data Not Available</div>
                      <div className="text-slate-400 mb-4">
                        Historical earnings data may require a premium Financial Modeling Prep subscription or may not be available for this stock.
                      </div>
                      <div className="text-sm text-slate-500">
                        Try viewing the Fundamentals or Financial tabs for other company data.
                      </div>
                    </div>
                  ) : (
                    <>
                      {/* Quarterly Earnings */}
                      {analystEstimates?.quarterly && analystEstimates.quarterly.length > 0 && (
                    <div>
                      <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Quarterly Earnings</h4>
                      <div className="space-y-3">
                        {(analystEstimates?.quarterly || []).slice(0, 8).map((est, i) => {
                          const epsEstimate = est.estimatedEpsAvg || 0;
                          const epsActual = est.eps || null;
                          const hasBeat = epsActual !== null;
                          const beat = hasBeat ? epsActual > epsEstimate : null;
                          const surprise = hasBeat ? ((epsActual - epsEstimate) / Math.abs(epsEstimate)) * 100 : null;
                          
                          const revenueEstimate = est.estimatedRevenueAvg || 0;
                          const revenueActual = est.revenue || null;
                          const hasRevenueBeat = revenueActual !== null;
                          const revenueBeat = hasRevenueBeat ? revenueActual > revenueEstimate : null;
                          const revenueSurprise = hasRevenueBeat ? ((revenueActual - revenueEstimate) / revenueEstimate) * 100 : null;
                          
                          return (
                            <div key={i} className="glass-card p-5 rounded-xl">
                              <div className="flex items-center justify-between mb-4">
                                <div>
                                  <div className="text-lg font-bold text-white">{est.date || 'N/A'}</div>
                                  <div className="text-xs text-slate-500">{est.numberAnalystEstimatedEps || 0} analysts</div>
                                </div>
                                {hasBeat && (
                                  <div className={`px-4 py-2 rounded-lg font-bold text-lg ${
                                    beat ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'
                                  }`}>
                                    {beat ? 'âœ“ BEAT' : 'âœ— MISS'}
                                  </div>
                                )}
                              </div>
                              
                              {/* EPS Row */}
                              <div className="grid grid-cols-2 gap-4 mb-3">
                                <div className="glass-card p-3 rounded-lg">
                                  <div className="text-xs text-slate-500 mb-1">EPS Estimate</div>
                                  <div className="text-xl font-bold text-cyan-400">${epsEstimate.toFixed(2)}</div>
                                </div>
                                <div className="glass-card p-3 rounded-lg">
                                  <div className="text-xs text-slate-500 mb-1">EPS Actual</div>
                                  <div className={`text-xl font-bold ${
                                    hasBeat ? (beat ? 'text-green-400' : 'text-red-400') : 'text-slate-400'
                                  }`}>
                                    {hasBeat ? `$${epsActual.toFixed(2)}` : 'â€”'}
                                  </div>
                                </div>
                              </div>
                              
                              {/* Revenue Row */}
                              <div className="grid grid-cols-2 gap-4 mb-3">
                                <div className="glass-card p-3 rounded-lg">
                                  <div className="text-xs text-slate-500 mb-1">Revenue Estimate</div>
                                  <div className="text-sm font-bold text-purple-400">{formatNumber(revenueEstimate)}</div>
                                </div>
                                <div className="glass-card p-3 rounded-lg">
                                  <div className="text-xs text-slate-500 mb-1">Revenue Actual</div>
                                  <div className={`text-sm font-bold ${
                                    hasRevenueBeat ? (revenueBeat ? 'text-green-400' : 'text-red-400') : 'text-slate-400'
                                  }`}>
                                    {hasRevenueBeat ? formatNumber(revenueActual) : 'â€”'}
                                  </div>
                                </div>
                              </div>
                              
                              {/* Surprise Percentage */}
                              {hasBeat && surprise !== null && (
                                <div className="pt-3 border-t border-slate-700/30">
                                  <div className="flex items-center justify-between">
                                    <span className="text-xs text-slate-400">EPS Surprise</span>
                                    <span className={`text-sm font-bold ${
                                      surprise > 0 ? 'text-green-400' : 'text-red-400'
                                    }`}>
                                      {surprise > 0 ? '+' : ''}{surprise.toFixed(1)}%
                                    </span>
                                  </div>
                                  {hasRevenueBeat && revenueSurprise !== null && (
                                    <div className="flex items-center justify-between mt-1">
                                      <span className="text-xs text-slate-400">Revenue Surprise</span>
                                      <span className={`text-sm font-bold ${
                                        revenueSurprise > 0 ? 'text-green-400' : 'text-red-400'
                                      }`}>
                                        {revenueSurprise > 0 ? '+' : ''}{revenueSurprise.toFixed(1)}%
                                      </span>
                                    </div>
                                  )}
                                </div>
                              )}
                              
                              {!hasBeat && (
                                <div className="pt-3 border-t border-slate-700/30 text-center text-sm text-slate-500">
                                  Earnings not yet reported
                                </div>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  )}
                  
                  {/* Annual Earnings */}
                  {analystEstimates?.annual && analystEstimates.annual.length > 0 && (
                    <div>
                      <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Annual Earnings Estimates</h4>
                      <div className="glass-card p-4 rounded-xl overflow-x-auto">
                        <table className="w-full text-sm">
                          <thead>
                            <tr className="text-slate-500 text-xs border-b border-slate-700/30">
                              <th className="text-left pb-3 px-2">Year</th>
                              <th className="text-right pb-3 px-2">Est. Revenue</th>
                              <th className="text-right pb-3 px-2">Est. EPS</th>
                              <th className="text-right pb-3 px-2">Est. EBITDA</th>
                              <th className="text-right pb-3 px-2">Analysts</th>
                            </tr>
                          </thead>
                          <tbody>
                            {(analystEstimates?.annual || []).slice(0, 4).map((est, i) => (
                              <tr key={i} className="border-b border-slate-700/20">
                                <td className="py-3 px-2 text-cyan-300 font-semibold">{est.date || 'N/A'}</td>
                                <td className="py-3 px-2 text-right font-mono">{formatNumber(est.estimatedRevenueAvg || 0)}</td>
                                <td className="py-3 px-2 text-right font-mono text-green-400">${(est.estimatedEpsAvg || 0).toFixed(2)}</td>
                                <td className="py-3 px-2 text-right font-mono">{formatNumber(est.estimatedEbitdaAvg || 0)}</td>
                                <td className="py-3 px-2 text-right text-slate-400">{est.numberAnalystEstimatedRevenue || 0}</td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  )}
                  
                  {/* Summary Stats */}
                  {analystEstimates?.quarterly && analystEstimates.quarterly.length > 0 && (
                    <div>
                      <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Performance Summary</h4>
                      <div className="glass-card p-6 rounded-xl">
                        <div className="grid grid-cols-3 gap-6">
                          <div className="text-center">
                            <div className="text-xs text-slate-500 mb-2">Total Quarters</div>
                            <div className="text-3xl font-bold text-white">
                              {(analystEstimates?.quarterly || []).filter(q => q.eps !== null).length}
                            </div>
                          </div>
                          <div className="text-center">
                            <div className="text-xs text-slate-500 mb-2">Earnings Beats</div>
                            <div className="text-3xl font-bold text-green-400">
                              {(analystEstimates?.quarterly || []).filter(q => q.eps !== null && q.eps > (q.estimatedEpsAvg || 0)).length}
                            </div>
                          </div>
                          <div className="text-center">
                            <div className="text-xs text-slate-500 mb-2">Earnings Misses</div>
                            <div className="text-3xl font-bold text-red-400">
                              {(analystEstimates?.quarterly || []).filter(q => q.eps !== null && q.eps <= (q.estimatedEpsAvg || 0)).length}
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  )}
                  </>
                  )}
                </div>
              ) : activeTab === 'financials' && incomeStatement ? (
                <div className="space-y-4">
                  <h3 className="text-lg font-bold text-white">Income Statement (Last 5 Years)</h3>
                  <div className="glass-card p-4 rounded-xl overflow-x-auto">
                    <table className="w-full text-sm">
                      <thead>
                        <tr className="text-slate-500 text-xs border-b border-slate-700/30">
                          <th className="text-left pb-3">Period</th>
                          <th className="text-right pb-3">Revenue</th>
                          <th className="text-right pb-3">Gross Profit</th>
                          <th className="text-right pb-3">Operating Income</th>
                          <th className="text-right pb-3">Net Income</th>
                          <th className="text-right pb-3">EPS</th>
                        </tr>
                      </thead>
                      <tbody>
                        {incomeStatement.slice(0, 5).map((stmt, i) => (
                          <tr key={i} className="border-b border-slate-700/20">
                            <td className="py-3 text-cyan-300 font-semibold">{stmt.calendarYear || stmt.date || 'N/A'}</td>
                            <td className="py-3 text-right font-mono">{formatNumber(stmt.revenue || 0)}</td>
                            <td className="py-3 text-right font-mono">{formatNumber(stmt.grossProfit || 0)}</td>
                            <td className="py-3 text-right font-mono">{formatNumber(stmt.operatingIncome || 0)}</td>
                            <td className="py-3 text-right font-mono">{formatNumber(stmt.netIncome || 0)}</td>
                            <td className="py-3 text-right font-mono">${(stmt.eps || 0).toFixed(2)}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              ) : activeTab === 'charts' && historicalData ? (
                <div className="space-y-4">
                  <h3 className="text-lg font-bold text-white">Advanced Charts (TradingView Lightweight Charts)</h3>
                  <AdvancedChartPanel
                    symbol={stock.symbol}
                    candles={historicalData}
                    timeframe={chartTimeframe}
                    onTimeframe={(tf) => {
                      setChartTimeframe(tf);
                      setHistoricalData(null);
                    }}
                    comparisonSymbol={comparisonSymbol}
                    onComparisonSymbol={(s) => {
                      setComparisonSymbol(s);
                      if (!s) {
                        setComparisonData(null);
                        setComparisonMeta({ symbol: null, timeframe: null });
                      }
                    }}
                    comparisonCandles={comparisonData}
                    comparisonLoading={comparisonLoading}
                  />
                </div>
              ) : activeTab === 'ai-predictions' ? (
                <div className="space-y-6">
                  <div className="flex items-center justify-between">
                    <h3 className="text-xl font-bold text-white flex items-center gap-2">
                      <span>ğŸ¤–</span>
                      AI-Powered Stock Analysis
                    </h3>
                    <button
                      onClick={async () => {
                        console.log('ğŸ”„ Manual refresh clicked');
                        setAiAnalysis(null);
                        setAiLoading(true);
                        try {
                          const analysis = await aiAnalyzer.analyzeStock(stock);
                          setAiAnalysis(analysis);
                        } catch (err) {
                          console.error('âŒ Refresh error:', err);
                          setAiAnalysis(aiAnalyzer.getFallbackAnalysis(stock));
                        } finally {
                          setAiLoading(false);
                        }
                      }}
                      className="px-3 py-1 bg-purple-600 hover:bg-purple-700 text-white text-sm rounded-lg transition-colors"
                    >
                      ğŸ”„ Refresh Analysis
                    </button>
                  </div>
                  
                  {(() => {
                    console.log('ğŸ¨ RENDER CHECK - aiLoading:', aiLoading, 'aiAnalysis:', !!aiAnalysis);
                    return null;
                  })()}

                  {aiLoading ? (
                    <div className="glass-card p-12 rounded-xl text-center">
                      <div className="inline-block animate-spin rounded-full h-12 w-12 border-4 border-purple-500 border-t-transparent mb-4"></div>
                      <div className="text-white font-semibold">Claude AI is analyzing {stock.symbol}...</div>
                      <div className="text-slate-400 text-sm mt-2">Considering fundamentals, technicals, and market sentiment</div>
                    </div>
                  ) : !aiAnalysis ? (
                    <div className="glass-card p-8 rounded-xl text-center">
                      <div className="text-6xl mb-4">ğŸ¤–</div>
                      <div className="text-xl font-bold text-white mb-2">Loading AI Analysis...</div>
                      <div className="text-slate-400 mb-4">Preparing stock analysis for {stock.symbol}</div>
                      <button
                        onClick={async () => {
                          console.log('ğŸ”„ Trigger analysis from empty state');
                          setAiLoading(true);
                          try {
                            const analysis = await aiAnalyzer.analyzeStock(stock);
                            setAiAnalysis(analysis);
                          } catch (err) {
                            console.error('âŒ Analysis error:', err);
                            setAiAnalysis(aiAnalyzer.getFallbackAnalysis(stock));
                          } finally {
                            setAiLoading(false);
                          }
                        }}
                        className="px-6 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold"
                      >
                        Generate AI Analysis
                      </button>
                    </div>
                  ) : (
                    <>
                      {/* FALLBACK MODE NOTICE */}
                      {aiAnalysis.aiModel === 'fallback' && (
                        <div className="glass-card p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/30 mb-6">
                          <div className="flex items-center gap-3">
                            <span className="text-2xl">âš ï¸</span>
                            <div className="flex-1">
                              <div className="text-yellow-400 font-bold text-sm mb-1">Limited Analysis Mode</div>
                              <div className="text-slate-300 text-xs">
                                Claude AI is temporarily unavailable. Showing basic rule-based analysis. 
                                Click "Refresh Analysis" to try again.
                              </div>
                            </div>
                          </div>
                        </div>
                      )}
                      
                      {/* OVERALL RECOMMENDATION */}
                      <div className="glass-card p-6 rounded-xl">
                        <div className="grid grid-cols-3 gap-6">
                          <div className="text-center">
                            <div className="text-xs text-slate-500 mb-2">AI Recommendation</div>
                            <div className={`text-5xl font-bold mb-2 ${
                              aiAnalysis.recommendation === 'BUY' ? 'text-green-400' :
                              aiAnalysis.recommendation === 'SELL' ? 'text-red-400' :
                              'text-yellow-400'
                            }`}>
                              {aiAnalysis.recommendation}
                            </div>
                            <div className="flex items-center justify-center gap-1 mt-2">
                              {[...Array(10)].map((_, i) => (
                                <div
                                  key={i}
                                  className={`w-2 h-6 rounded ${
                                    i < aiAnalysis.recommendationStrength
                                      ? aiAnalysis.recommendation === 'BUY' ? 'bg-green-500' :
                                        aiAnalysis.recommendation === 'SELL' ? 'bg-red-500' :
                                        'bg-yellow-500'
                                      : 'bg-slate-700'
                                  }`}
                                />
                              ))}
                            </div>
                            <div className="text-xs text-slate-400 mt-2">
                              Strength: {aiAnalysis.recommendationStrength}/10
                            </div>
                          </div>

                          <div className="text-center">
                            <div className="text-xs text-slate-500 mb-2">AI Price Target</div>
                            <div className="text-4xl font-bold text-purple-400">
                              ${aiAnalysis.targetPrice?.toFixed(2)}
                            </div>
                            <div className={`text-lg font-bold mt-2 ${
                              aiAnalysis.targetPrice > aiAnalysis.currentPrice ? 'text-green-400' : 'text-red-400'
                            }`}>
                              {((aiAnalysis.targetPrice / aiAnalysis.currentPrice - 1) * 100).toFixed(1)}% upside
                            </div>
                          </div>

                          <div className="text-center">
                            <div className="text-xs text-slate-500 mb-2">Suggested Stop Loss</div>
                            <div className="text-4xl font-bold text-red-400">
                              ${aiAnalysis.stopLoss?.toFixed(2)}
                            </div>
                            <div className="text-sm text-slate-400 mt-2">
                              {((1 - aiAnalysis.stopLoss / aiAnalysis.currentPrice) * 100).toFixed(1)}% downside protection
                            </div>
                          </div>
                        </div>
                      </div>

                      {/* PRICE PREDICTIONS */}
                      <div>
                        <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Price Predictions</h4>
                        <div className="grid grid-cols-3 gap-4">
                          <div className="glass-card p-5 rounded-xl">
                            <div className="flex items-center justify-between mb-3">
                              <div className="text-xs text-slate-500">1-Day Forecast</div>
                              <div className="text-xs text-cyan-400 font-semibold">
                                {aiAnalysis.predictions.oneDay.confidence}% confidence
                              </div>
                            </div>
                            <div className="text-3xl font-bold text-white mb-2">
                              ${aiAnalysis.predictions.oneDay.price?.toFixed(2)}
                            </div>
                            <div className={`text-lg font-bold ${
                              aiAnalysis.predictions.oneDay.change >= 0 ? 'text-green-400' : 'text-red-400'
                            }`}>
                              {aiAnalysis.predictions.oneDay.change >= 0 ? '+' : ''}{aiAnalysis.predictions.oneDay.change?.toFixed(2)}%
                            </div>
                            <div className="mt-3 h-2 bg-slate-700 rounded-full overflow-hidden">
                              <div
                                className="h-full bg-cyan-500"
                                style={{ width: `${aiAnalysis.predictions.oneDay.confidence}%` }}
                              />
                            </div>
                          </div>

                          <div className="glass-card p-5 rounded-xl">
                            <div className="flex items-center justify-between mb-3">
                              <div className="text-xs text-slate-500">7-Day Forecast</div>
                              <div className="text-xs text-blue-400 font-semibold">
                                {aiAnalysis.predictions.sevenDay.confidence}% confidence
                              </div>
                            </div>
                            <div className="text-3xl font-bold text-white mb-2">
                              ${aiAnalysis.predictions.sevenDay.price?.toFixed(2)}
                            </div>
                            <div className={`text-lg font-bold ${
                              aiAnalysis.predictions.sevenDay.change >= 0 ? 'text-green-400' : 'text-red-400'
                            }`}>
                              {aiAnalysis.predictions.sevenDay.change >= 0 ? '+' : ''}{aiAnalysis.predictions.sevenDay.change?.toFixed(2)}%
                            </div>
                            <div className="mt-3 h-2 bg-slate-700 rounded-full overflow-hidden">
                              <div
                                className="h-full bg-blue-500"
                                style={{ width: `${aiAnalysis.predictions.sevenDay.confidence}%` }}
                              />
                            </div>
                          </div>

                          <div className="glass-card p-5 rounded-xl">
                            <div className="flex items-center justify-between mb-3">
                              <div className="text-xs text-slate-500">30-Day Forecast</div>
                              <div className="text-xs text-purple-400 font-semibold">
                                {aiAnalysis.predictions.thirtyDay.confidence}% confidence
                              </div>
                            </div>
                            <div className="text-3xl font-bold text-white mb-2">
                              ${aiAnalysis.predictions.thirtyDay.price?.toFixed(2)}
                            </div>
                            <div className={`text-lg font-bold ${
                              aiAnalysis.predictions.thirtyDay.change >= 0 ? 'text-green-400' : 'text-red-400'
                            }`}>
                              {aiAnalysis.predictions.thirtyDay.change >= 0 ? '+' : ''}{aiAnalysis.predictions.thirtyDay.change?.toFixed(2)}%
                            </div>
                            <div className="mt-3 h-2 bg-slate-700 rounded-full overflow-hidden">
                              <div
                                className="h-full bg-purple-500"
                                style={{ width: `${aiAnalysis.predictions.thirtyDay.confidence}%` }}
                              />
                            </div>
                          </div>
                        </div>
                      </div>

                      {/* AI SCORES */}
                      <div>
                        <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">AI Analysis Scores</h4>
                        <div className="glass-card p-6 rounded-xl">
                          <div className="grid grid-cols-3 gap-6">
                            <div>
                              <div className="flex items-center justify-between mb-2">
                                <span className="text-sm text-slate-400">Technical Analysis</span>
                                <span className="text-lg font-bold text-cyan-400">{aiAnalysis.technicalScore}/100</span>
                              </div>
                              <div className="h-3 bg-slate-700 rounded-full overflow-hidden">
                                <div
                                  className={`h-full ${
                                    aiAnalysis.technicalScore >= 70 ? 'bg-green-500' :
                                    aiAnalysis.technicalScore >= 40 ? 'bg-yellow-500' :
                                    'bg-red-500'
                                  }`}
                                  style={{ width: `${aiAnalysis.technicalScore}%` }}
                                />
                              </div>
                            </div>

                            <div>
                              <div className="flex items-center justify-between mb-2">
                                <span className="text-sm text-slate-400">Fundamental Strength</span>
                                <span className="text-lg font-bold text-blue-400">{aiAnalysis.fundamentalScore}/100</span>
                              </div>
                              <div className="h-3 bg-slate-700 rounded-full overflow-hidden">
                                <div
                                  className={`h-full ${
                                    aiAnalysis.fundamentalScore >= 70 ? 'bg-green-500' :
                                    aiAnalysis.fundamentalScore >= 40 ? 'bg-yellow-500' :
                                    'bg-red-500'
                                  }`}
                                  style={{ width: `${aiAnalysis.fundamentalScore}%` }}
                                />
                              </div>
                            </div>

                            <div>
                              <div className="flex items-center justify-between mb-2">
                                <span className="text-sm text-slate-400">Market Sentiment</span>
                                <span className="text-lg font-bold text-purple-400">{aiAnalysis.sentimentScore}/100</span>
                              </div>
                              <div className="h-3 bg-slate-700 rounded-full overflow-hidden">
                                <div
                                  className={`h-full ${
                                    aiAnalysis.sentimentScore >= 70 ? 'bg-green-500' :
                                    aiAnalysis.sentimentScore >= 40 ? 'bg-yellow-500' :
                                    'bg-red-500'
                                  }`}
                                  style={{ width: `${aiAnalysis.sentimentScore}%` }}
                                />
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>

                      {/* KEY INSIGHTS */}
                      <div>
                        <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Key Insights</h4>
                        <div className="space-y-2">
                          {aiAnalysis.keyInsights?.map((insight, i) => (
                            <div key={i} className="glass-card p-4 rounded-lg flex items-start gap-3">
                              <span className="text-2xl">ğŸ’¡</span>
                              <span className="text-slate-300 flex-1">{insight}</span>
                            </div>
                          ))}
                        </div>
                      </div>

                      {/* OPPORTUNITIES & RISKS */}
                      <div className="grid grid-cols-2 gap-4">
                        <div>
                          <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide flex items-center gap-2">
                            <span>ğŸ“ˆ</span> Opportunities
                          </h4>
                          <div className="space-y-2">
                            {aiAnalysis.opportunities?.map((opp, i) => (
                              <div key={i} className="glass-card p-4 rounded-lg bg-green-500/10 border border-green-500/20">
                                <div className="text-green-400 text-sm">{opp}</div>
                              </div>
                            ))}
                          </div>
                        </div>

                        <div>
                          <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide flex items-center gap-2">
                            <span>âš ï¸</span> Risks
                          </h4>
                          <div className="space-y-2">
                            {aiAnalysis.risks?.map((risk, i) => (
                              <div key={i} className="glass-card p-4 rounded-lg bg-red-500/10 border border-red-500/20">
                                <div className="text-red-400 text-sm">{risk}</div>
                              </div>
                            ))}
                          </div>
                        </div>
                      </div>

                      {/* AI SUMMARY */}
                      <div className="glass-card p-6 rounded-xl bg-purple-500/10 border border-purple-500/20">
                        <div className="flex items-start gap-4">
                          <div className="text-4xl">ğŸ¤–</div>
                          <div className="flex-1">
                            <div className="text-sm font-bold text-purple-400 mb-2">AI Summary</div>
                            <div className="text-slate-300 leading-relaxed">{aiAnalysis.summary}</div>
                            <div className="mt-4 pt-4 border-t border-slate-700/30 flex items-center justify-between text-xs text-slate-500">
                              <span>Powered by {aiAnalysis.aiModel || 'Claude Sonnet 4'}</span>
                              <span>Generated: {new Date(aiAnalysis.timestamp).toLocaleString()}</span>
                            </div>
                          </div>
                        </div>
                      </div>

                      {/* DISCLAIMER */}
                      <div className="glass-card p-4 rounded-lg bg-yellow-500/10 border border-yellow-500/20 text-center">
                        <div className="text-yellow-400 text-sm font-semibold mb-1">âš ï¸ AI Prediction Disclaimer</div>
                        <div className="text-slate-400 text-xs">
                          AI predictions are educational estimates and should not be considered financial advice. 
                          Past performance does not guarantee future results. Always conduct your own research and 
                          consult with a financial advisor before making investment decisions.
                        </div>
                      </div>
                    </>
                  )}
                </div>
              ) : activeTab === 'portfolio' ? (
                <div className="space-y-6">
                  <h3 className="text-xl font-bold text-white">ğŸ“Š Portfolio Optimization</h3>
                  
                  {portfolio.length < 2 ? (
                    <div className="glass-card p-8 text-center">
                      <i className="fas fa-chart-pie text-4xl text-purple-400 mb-4"></i>
                      <div className="text-lg font-semibold text-white mb-2">Add stocks to analyze your portfolio</div>
                      <div className="text-slate-400 text-sm">You need at least 2 stocks in your portfolio to run optimization</div>
                    </div>
                  ) : !portfolioOptimization ? (
                    <div className="glass-card p-8 text-center">
                      <i className="fas fa-spinner fa-spin text-4xl text-purple-400 mb-4"></i>
                      <div className="text-slate-400">Running portfolio optimization...</div>
                    </div>
                  ) : (
                    <>
                      <div className="grid grid-cols-2 gap-6">
                        <div className="glass-card p-5 rounded-xl">
                          <div className="flex items-center gap-2 mb-3">
                            <div className="w-3 h-3 rounded-full bg-green-500"></div>
                            <h4 className="text-sm font-bold text-white uppercase tracking-wide">Max Sharpe Ratio</h4>
                          </div>
                          <div className="grid grid-cols-2 gap-3 text-sm mb-4">
                            <div className="text-slate-400">Return</div>
                            <div className="text-right font-semibold text-green-400">
                              {(portfolioOptimization.maxSharpePortfolio.return * 100).toFixed(1)}%
                            </div>
                            <div className="text-slate-400">Risk</div>
                            <div className="text-right font-semibold text-white">
                              {(portfolioOptimization.maxSharpePortfolio.volatility * 100).toFixed(1)}%
                            </div>
                            <div className="text-slate-400">Sharpe</div>
                            <div className="text-right font-semibold text-cyan-400">
                              {portfolioOptimization.maxSharpePortfolio.sharpeRatio.toFixed(2)}
                            </div>
                          </div>
                          <div className="text-xs text-slate-500 mb-2">Allocation:</div>
                          <div className="space-y-2">
                            {portfolioOptimization.maxSharpePortfolio.weights
                              .sort((a, b) => b.weight - a.weight)
                              .map((pos, i) => (
                                <div key={i} className="flex justify-between p-2 bg-slate-800/40 rounded">
                                  <span className="font-semibold text-cyan-300">{pos.symbol}</span>
                                  <span className="text-white font-mono">{pos.weight.toFixed(1)}%</span>
                                </div>
                              ))}
                          </div>
                        </div>
                        
                        <div className="glass-card p-5 rounded-xl">
                          <div className="flex items-center gap-2 mb-3">
                            <div className="w-3 h-3 rounded-full bg-red-500"></div>
                            <h4 className="text-sm font-bold text-white uppercase tracking-wide">Min Risk</h4>
                          </div>
                          <div className="grid grid-cols-2 gap-3 text-sm mb-4">
                            <div className="text-slate-400">Return</div>
                            <div className="text-right font-semibold text-yellow-400">
                              {(portfolioOptimization.minVolatilityPortfolio.return * 100).toFixed(1)}%
                            </div>
                            <div className="text-slate-400">Risk</div>
                            <div className="text-right font-semibold text-white">
                              {(portfolioOptimization.minVolatilityPortfolio.volatility * 100).toFixed(1)}%
                            </div>
                            <div className="text-slate-400">Sharpe</div>
                            <div className="text-right font-semibold text-cyan-400">
                              {portfolioOptimization.minVolatilityPortfolio.sharpeRatio.toFixed(2)}
                            </div>
                          </div>
                          <div className="text-xs text-slate-500 mb-2">Allocation:</div>
                          <div className="space-y-2">
                            {portfolioOptimization.minVolatilityPortfolio.weights
                              .sort((a, b) => b.weight - a.weight)
                              .map((pos, i) => (
                                <div key={i} className="flex justify-between p-2 bg-slate-800/40 rounded">
                                  <span className="font-semibold text-cyan-300">{pos.symbol}</span>
                                  <span className="text-white font-mono">{pos.weight.toFixed(1)}%</span>
                                </div>
                              ))}
                          </div>
                        </div>
                      </div>
                      
                      <div className="glass-card p-5 rounded-xl">
                        <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Individual Metrics</h4>
                        <div className="space-y-2">
                          {portfolioOptimization.individualMetrics.map((asset, i) => (
                            <div key={i} className="flex items-center justify-between p-3 bg-slate-800/40 rounded-lg">
                              <div className="font-semibold text-cyan-300">{asset.symbol}</div>
                              <div className="flex gap-4 text-sm">
                                <div>
                                  <span className="text-slate-500">Return: </span>
                                  <span className="text-green-400">{(asset.expectedReturn * 100).toFixed(1)}%</span>
                                </div>
                                <div>
                                  <span className="text-slate-500">Risk: </span>
                                  <span className="text-white">{(asset.volatility * 100).toFixed(1)}%</span>
                                </div>
                                <div>
                                  <span className="text-slate-500">Sharpe: </span>
                                  <span className="text-cyan-400">{asset.sharpeRatio.toFixed(2)}</span>
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                      </div>
                      
                      <div className="text-xs text-slate-500 text-center">
                        <i className="fas fa-info-circle mr-1"></i>
                        Portfolio optimization based on Modern Portfolio Theory. Sharpe Ratio measures risk-adjusted returns.
                      </div>
                    </>
                  )}
                </div>
              ) : activeTab === 'similar' ? (
                <div className="space-y-6">
                  <h3 className="text-xl font-bold text-white">ğŸ¯ Stocks Similar to {selectedStock?.symbol}</h3>
                  
                  {!similarStocks || similarStocks.length === 0 ? (
                    <div className="glass-card p-8 text-center">
                      <i className="fas fa-search text-4xl text-cyan-400 mb-4"></i>
                      <div className="text-slate-400">Finding similar stocks...</div>
                    </div>
                  ) : (
                    <div className="glass-card p-5 rounded-xl">
                      <h4 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">Top Matches</h4>
                      <div className="space-y-3">
                        {similarStocks.map((stock, i) => (
                          <div key={i} className="flex items-center justify-between p-3 bg-slate-800/40 rounded-lg hover:bg-slate-800/60 transition-colors cursor-pointer"
                            onClick={() => {
                              const fullStock = stocks.find(s => s.symbol === stock.symbol);
                              if (fullStock) setSelectedStock(fullStock);
                            }}>
                            <div className="flex items-center gap-4">
                              <div className="relative">
                                <div className="w-12 h-12 rounded-lg bg-gradient-to-br from-cyan-500 to-purple-500 flex items-center justify-center">
                                  <span className="font-bold text-white">{stock.symbol.substring(0, 3)}</span>
                                </div>
                                <div className="absolute -bottom-1 -right-1 w-6 h-6 bg-slate-800 rounded-full border-2 border-slate-900 flex items-center justify-center">
                                  <span className="text-xs font-bold text-white">{i + 1}</span>
                                </div>
                              </div>
                              <div>
                                <div className="font-semibold text-cyan-300">{stock.symbol}</div>
                                <div className="text-xs text-slate-400">{stock.companyName}</div>
                                <div className="text-xs text-slate-500">{stock.sector}</div>
                              </div>
                            </div>
                            
                            <div className="flex items-center gap-6">
                              <div className="text-center">
                                <div className="text-xs text-slate-500 mb-1">Similarity</div>
                                <div className={`text-lg font-bold ${
                                  stock.similarity > 80 ? 'text-green-400' : 
                                  stock.similarity > 60 ? 'text-yellow-400' : 'text-red-400'
                                }`}>
                                  {stock.similarity.toFixed(1)}%
                                </div>
                              </div>
                              <div className="text-xs">
                                <div><span className="text-slate-500">P/E:</span> <span className="text-white">{stock.pe?.toFixed(1) || 'N/A'}</span></div>
                                <div><span className="text-slate-500">ROE:</span> <span className="text-white">{stock.roe?.toFixed(1) || 'N/A'}%</span></div>
                                <div><span className="text-slate-500">Score:</span> <span className="text-cyan-400">{stock.aiScore || 'N/A'}</span></div>
                              </div>
                            </div>
                          </div>
                        ))}
                      </div>
                      <div className="mt-4 text-xs text-slate-500 text-center">
                        <i className="fas fa-info-circle mr-1"></i>
                        Similarity based on sector, financial metrics, and market cap
                      </div>
                    </div>
                  )}
                </div>
              ) : activeTab === 'heatmap' ? (
                <div className="space-y-6">
                  <h3 className="text-xl font-bold text-white">ğŸ—ºï¸ Market Heatmap</h3>
                  
                  <div className="glass-card p-5 rounded-xl">
                    <div className="grid grid-cols-3 gap-3">
                      {stocks.slice(0, 21).map((stock, i) => {
                        const changePct = stock.changePct || 0;
                        const bgColor = changePct > 0 ? 'bg-green-500' : changePct < 0 ? 'bg-red-500' : 'bg-slate-500';
                        const opacity = Math.min(Math.abs(changePct) / 5, 1) * 100;
                        
                        return (
                          <div
                            key={i}
                            className={`p-4 rounded-lg cursor-pointer hover:opacity-80 transition-opacity ${bgColor}`}
                            style={{ opacity: 0.3 + (opacity / 200) }}
                            onClick={() => openStockModal(stock)}
                          >
                            <div className="font-bold text-white mb-1">{stock.symbol}</div>
                            <div className="text-xs text-white/80 mb-2 truncate">{stock.companyName}</div>
                            <div className="text-sm font-semibold text-white">
                              {changePct > 0 ? '+' : ''}{changePct.toFixed(2)}%
                            </div>
                            <div className="text-xs text-white/70 mt-1">
                              ${(stock.marketCap / 1e9).toFixed(1)}B
                            </div>
                          </div>
                        );
                      })}
                    </div>
                    
                    <div className="mt-4 flex items-center justify-center gap-4 text-xs">
                      <div className="flex items-center gap-2">
                        <div className="w-3 h-3 bg-red-500 rounded"></div>
                        <span className="text-slate-400">Down</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <div className="w-3 h-3 bg-slate-500 rounded"></div>
                        <span className="text-slate-400">Flat</span>
                      </div>
                      <div className="flex items-center gap-2">
                        <div className="w-3 h-3 bg-green-500 rounded"></div>
                        <span className="text-slate-400">Up</span>
                      </div>
                      <span className="text-slate-500 ml-4">Color intensity = % change</span>
                    </div>
                  </div>
                  
                  <div className="text-xs text-slate-500 text-center">
                    <i className="fas fa-info-circle mr-1"></i>
                    Click any stock to view details. Size and color based on performance.
                  </div>
                </div>
              ) : (
                <div className="text-center py-12 text-slate-400">
                  {activeTab === 'insider' || activeTab === 'earnings' || activeTab === 'financials' || activeTab === 'charts' || activeTab === 'ai-predictions' ? 
                    'No data available for this stock' : 
                    'Select a tab to view data'}
                </div>
              )}
            </div>

            {/* Footer */}
            <div className="flex justify-end gap-3 p-6 border-t border-slate-700/30 flex-shrink-0">
              <button onClick={onClose} className="px-6 py-2.5 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold text-sm">Close</button>
            </div>
          </div>
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PORTFOLIO MODAL COMPONENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PORTFOLIO TRACKER MODAL (USING NEW PORTFOLIOMANAGER)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function PortfolioModal({ onClose, stocks }) {
      const [activeTab, setActiveTab] = useState('holdings');
      const [newPosition, setNewPosition] = useState({ symbol: '', quantity: '', buyPrice: '', buyDate: '' });
      const [editingId, setEditingId] = useState(null);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      const [refreshKey, setRefreshKey] = useState(0);

      // Get portfolio metrics using PortfolioManager
      const metrics = window.portfolioManager ? 
        window.portfolioManager.calculatePortfolioMetrics(stocks) : 
        { holdings: [], totalValue: 0, totalCost: 0, totalGainLoss: 0, totalGainLossPercent: 0 };

      // Health Check Logic
      const calculateHealth = () => {
        if (metrics.holdings.length === 0) return null;
        
        let weightedBeta = 0;
        const sectorWeights = {};
        
        metrics.holdings.forEach(h => {
          const stock = stocks.find(s => s.symbol === h.symbol);
          const weight = metrics.totalValue > 0 ? (h.currentValue / metrics.totalValue) : 0;
          const beta = stock?.beta || 1.0;
          
          weightedBeta += beta * weight;
          
          const sector = stock?.sector || 'Unknown';
          sectorWeights[sector] = (sectorWeights[sector] || 0) + weight;
        });
        
        const maxSector = Object.entries(sectorWeights).sort((a,b) => b[1] - a[1])[0];
        
        const insights = [];
        if (weightedBeta > 1.3) insights.push({ type: 'warning', text: 'High Portfolio Volatility (Beta > 1.3). Consider adding defensive stocks.' });
        if (weightedBeta < 0.8) insights.push({ type: 'info', text: 'Low Portfolio Volatility (Beta < 0.8). Good for capital preservation.' });
        if (maxSector && maxSector[1] > 0.30) insights.push({ type: 'warning', text: `High concentration in ${maxSector[0]} (${(maxSector[1]*100).toFixed(0)}%). Diversify!` });
        if (metrics.holdings.length < 5) insights.push({ type: 'warning', text: 'Portfolio is under-diversified (< 5 stocks).' });
        
        return { weightedBeta, maxSector, insights };
      };
      
      const health = calculateHealth();

      const addPosition = async () => {
        const { symbol, quantity, buyPrice, buyDate } = newPosition;
        
        if (!symbol || !quantity || !buyPrice) {
          setError('Please fill Symbol, Quantity, and Buy Price fields');
          return;
        }

        const symbolUpper = symbol.toUpperCase();
        const quantityNum = parseFloat(quantity);
        const priceNum = parseFloat(buyPrice);

        if (quantityNum <= 0 || priceNum <= 0) {
          setError('Quantity and buy price must be positive numbers');
          return;
        }

        setLoading(true);
        setError(null);

        try {
          // Add to PortfolioManager
          window.portfolioManager.addHolding(
            symbolUpper, 
            quantityNum, 
            priceNum, 
            buyDate || new Date().toISOString().split('T')[0]
          );
          
          setNewPosition({ symbol: '', quantity: '', buyPrice: '', buyDate: '' });
          setRefreshKey(k => k + 1); // Force refresh
          setError(null);
        } catch (err) {
          setError(err.message);
        } finally {
          setLoading(false);
        }
      };

      const removePosition = (id) => {
        window.portfolioManager.removeHolding(id);
        setRefreshKey(k => k + 1); // Force refresh
      };

      const exportPortfolioCSV = () => {
        const csvContent = window.portfolioManager.exportToCSV();
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `portfolio-${new Date().toISOString().split('T')[0]}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      };

      // Get top and worst performers
      const topPerformers = window.portfolioManager.getTopPerformers(metrics, 3);
      const worstPerformers = window.portfolioManager.getWorstPerformers(metrics, 3);

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="glass-elevated rounded-2xl max-w-6xl w-full mx-auto my-8 animate-slide-up max-h-[90vh] overflow-hidden flex flex-col" onClick={(e) => e.stopPropagation()}>
            {/* Header */}
            <div className="flex items-start justify-between p-6 border-b border-slate-700/30 flex-shrink-0">
              <div>
                <h2 className="text-3xl font-bold text-white mb-1">ğŸ“Š Portfolio Tracker</h2>
                <div className="text-sm text-slate-400">Track your investments with real-time P&L calculations</div>
              </div>
              <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>

            {/* Tabs */}
            <div className="flex gap-2 px-6 pt-4 border-b border-slate-700/30">
              <button 
                onClick={() => setActiveTab('holdings')} 
                className={`px-4 py-2 text-sm font-semibold border-b-2 transition-colors ${activeTab === 'holdings' ? 'border-cyan-400 text-cyan-400' : 'border-transparent text-slate-400 hover:text-slate-200'}`}
              >
                Holdings & Performance
              </button>
              <button 
                onClick={() => setActiveTab('health')} 
                className={`px-4 py-2 text-sm font-semibold border-b-2 transition-colors ${activeTab === 'health' ? 'border-cyan-400 text-cyan-400' : 'border-transparent text-slate-400 hover:text-slate-200'}`}
              >
                â¤ï¸ Health Check
              </button>
            </div>

            {activeTab === 'holdings' ? (
              <>
            {/* Portfolio Summary Cards */}
            <div className="p-6 border-b border-slate-700/30">
              <div className="grid grid-cols-4 gap-4">
                <div className="glass-card p-5 rounded-xl">
                  <div className="text-xs text-slate-500 mb-1 uppercase tracking-wide">Total Value</div>
                  <div className="text-3xl font-bold text-white">
                    ${metrics.totalValue.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                  </div>
                </div>
                <div className="glass-card p-5 rounded-xl">
                  <div className="text-xs text-slate-500 mb-1 uppercase tracking-wide">Total Cost</div>
                  <div className="text-2xl font-bold text-slate-300">
                    ${metrics.totalCost.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                  </div>
                </div>
                <div className="glass-card p-5 rounded-xl">
                  <div className="text-xs text-slate-500 mb-1 uppercase tracking-wide">Total Gain/Loss</div>
                  <div className={`text-3xl font-bold ${metrics.totalGainLoss >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                    {metrics.totalGainLoss >= 0 ? '+' : ''}${metrics.totalGainLoss.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                  </div>
                  <div className={`text-sm mt-1 font-semibold ${metrics.totalGainLossPercent >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                    {metrics.totalGainLossPercent >= 0 ? '+' : ''}{metrics.totalGainLossPercent.toFixed(2)}%
                  </div>
                </div>
                <div className="glass-card p-5 rounded-xl">
                  <div className="text-xs text-slate-500 mb-1 uppercase tracking-wide">Positions</div>
                  <div className="text-3xl font-bold text-white">{metrics.holdings.length}</div>
                  <div className="text-xs text-slate-500 mt-1">
                    {topPerformers.length > 0 && `Top: ${topPerformers[0].symbol} +${topPerformers[0].gainLossPercent.toFixed(1)}%`}
                  </div>
                </div>
              </div>
            </div>

            {/* Add Position Form */}
            <div className="p-6 border-b border-slate-700/30">
              <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                <i className="fas fa-plus-circle text-cyan-400"></i>
                Add New Position
              </h3>
              {error && (
                <div className="mb-4 p-3 bg-red-500/10 border border-red-500/20 rounded-lg flex items-center gap-2">
                  <i className="fas fa-exclamation-triangle text-red-400"></i>
                  <div className="text-red-400 text-sm">{error}</div>
                </div>
              )}
              <div className="grid grid-cols-5 gap-4">
                <div>
                  <label className="text-xs text-slate-500 mb-1 block uppercase tracking-wide">Symbol *</label>
                  <input
                    type="text"
                    value={newPosition.symbol}
                    onChange={(e) => setNewPosition({ ...newPosition, symbol: e.target.value.toUpperCase() })}
                    className="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded text-white focus:outline-none focus:border-cyan-500 font-mono"
                    placeholder="AAPL"
                  />
                </div>
                <div>
                  <label className="text-xs text-slate-500 mb-1 block uppercase tracking-wide">Quantity *</label>
                  <input
                    type="number"
                    value={newPosition.quantity}
                    onChange={(e) => setNewPosition({ ...newPosition, quantity: e.target.value })}
                    className="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded text-white focus:outline-none focus:border-cyan-500"
                    placeholder="10"
                    step="0.01"
                  />
                </div>
                <div>
                  <label className="text-xs text-slate-500 mb-1 block uppercase tracking-wide">Buy Price ($) *</label>
                  <input
                    type="number"
                    value={newPosition.buyPrice}
                    onChange={(e) => setNewPosition({ ...newPosition, buyPrice: e.target.value })}
                    className="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded text-white focus:outline-none focus:border-cyan-500"
                    placeholder="150.00"
                    step="0.01"
                  />
                </div>
                <div>
                  <label className="text-xs text-slate-500 mb-1 block uppercase tracking-wide">Buy Date</label>
                  <input
                    type="date"
                    value={newPosition.buyDate}
                    onChange={(e) => setNewPosition({ ...newPosition, buyDate: e.target.value })}
                    className="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded text-white focus:outline-none focus:border-cyan-500"
                  />
                </div>
                <div className="flex items-end">
                  <button
                    onClick={addPosition}
                    disabled={loading}
                    className="w-full px-4 py-2 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 disabled:from-slate-700 disabled:to-slate-700 text-white rounded-lg font-semibold flex items-center justify-center gap-2 transition"
                  >
                    {loading ? (
                      <>
                        <i className="fas fa-spinner animate-spin"></i>
                        Adding...
                      </>
                    ) : (
                      <>
                        <i className="fas fa-plus"></i>
                        Add
                      </>
                    )}
                  </button>
                </div>
              </div>
            </div>

            {/* Positions Table */}
            <div className="p-6 overflow-y-auto flex-1">
              <div className="flex justify-between items-center mb-4">
                <h3 className="text-lg font-bold text-white flex items-center gap-2">
                  <i className="fas fa-list text-cyan-400"></i>
                  Your Holdings
                </h3>
                <button
                  onClick={exportPortfolioCSV}
                  disabled={metrics.holdings.length === 0}
                  className="px-4 py-2 bg-slate-700 hover:bg-slate-600 disabled:bg-slate-800 disabled:cursor-not-allowed text-white rounded-lg font-semibold text-sm flex items-center gap-2 transition"
                >
                  <i className="fas fa-file-export"></i>
                  Export CSV
                </button>
              </div>

              {metrics.holdings.length === 0 ? (
                <div className="text-center py-16 text-slate-400">
                  <i className="fas fa-chart-line text-6xl mb-4 text-slate-700"></i>
                  <div className="text-xl font-semibold mb-2">No positions in your portfolio yet</div>
                  <div className="text-sm">Add your first position above to start tracking your investments</div>
                </div>
              ) : (
                <div className="space-y-4">
                  {/* Performance Highlights */}
                  {(topPerformers.length > 0 || worstPerformers.length > 0) && (
                    <div className="grid grid-cols-2 gap-4 mb-6">
                      {topPerformers.length > 0 && (
                        <div className="glass-card p-4 rounded-xl border border-green-500/20">
                          <div className="text-xs text-slate-500 mb-2 uppercase tracking-wide flex items-center gap-2">
                            <i className="fas fa-trophy text-green-400"></i>
                            Top Performers
                          </div>
                          {topPerformers.map((holding, idx) => (
                            <div key={holding.id} className="flex justify-between items-center mb-1">
                              <span className="text-sm font-mono text-cyan-300">{holding.symbol}</span>
                              <span className="text-sm font-semibold text-green-400">
                                +{holding.gainLossPercent.toFixed(2)}%
                              </span>
                            </div>
                          ))}
                        </div>
                      )}
                      {worstPerformers.length > 0 && (
                        <div className="glass-card p-4 rounded-xl border border-red-500/20">
                          <div className="text-xs text-slate-500 mb-2 uppercase tracking-wide flex items-center gap-2">
                            <i className="fas fa-arrow-down text-red-400"></i>
                            Needs Attention
                          </div>
                          {worstPerformers.map((holding, idx) => (
                            <div key={holding.id} className="flex justify-between items-center mb-1">
                              <span className="text-sm font-mono text-cyan-300">{holding.symbol}</span>
                              <span className="text-sm font-semibold text-red-400">
                                {holding.gainLossPercent.toFixed(2)}%
                              </span>
                            </div>
                          ))}
                        </div>
                      )}
                    </div>
                  )}

                  {/* Portfolio Allocation Charts */}
                  <div className="grid grid-cols-2 gap-4 mb-6">
                    {/* Allocation by Value Pie Chart */}
                    <div className="glass-card p-5 rounded-xl">
                      <h4 className="text-sm font-bold text-slate-400 mb-4 uppercase tracking-wide flex items-center gap-2">
                        <i className="fas fa-chart-pie text-cyan-400"></i>
                        Allocation by Value
                      </h4>
                      <div className="flex items-center justify-center mb-4">
                        <div className="relative w-48 h-48">
                          {/* SVG Donut Chart */}
                          <svg viewBox="0 0 100 100" className="transform -rotate-90">
                            {(() => {
                              let cumulativePercent = 0;
                              const colors = ['#06b6d4', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444', '#ec4899', '#6366f1', '#14b8a6'];
                              return metrics.holdings.map((holding, idx) => {
                                const percent = (holding.currentValue / metrics.totalValue) * 100;
                                const strokeDasharray = `${percent} ${100 - percent}`;
                                const strokeDashoffset = -cumulativePercent;
                                cumulativePercent += percent;
                                return (
                                  <circle
                                    key={holding.id}
                                    cx="50"
                                    cy="50"
                                    r="15.915"
                                    fill="transparent"
                                    stroke={colors[idx % colors.length]}
                                    strokeWidth="12"
                                    strokeDasharray={strokeDasharray}
                                    strokeDashoffset={strokeDashoffset}
                                    style={{ transition: 'all 0.3s ease' }}
                                  />
                                );
                              });
                            })()}
                          </svg>
                          {/* Center Text */}
                          <div className="absolute inset-0 flex flex-col items-center justify-center">
                            <div className="text-xs text-slate-500">Total</div>
                            <div className="text-lg font-bold text-white">
                              ${(metrics.totalValue / 1000).toFixed(1)}K
                            </div>
                          </div>
                        </div>
                      </div>
                      {/* Legend */}
                      <div className="space-y-1">
                        {metrics.holdings
                          .sort((a, b) => b.currentValue - a.currentValue)
                          .slice(0, 5)
                          .map((holding, idx) => {
                            const colors = ['#06b6d4', '#8b5cf6', '#10b981', '#f59e0b', '#ef4444'];
                            const percent = (holding.currentValue / metrics.totalValue) * 100;
                            return (
                              <div key={holding.id} className="flex items-center justify-between text-xs">
                                <div className="flex items-center gap-2">
                                  <div 
                                    className="w-3 h-3 rounded-full" 
                                    style={{ backgroundColor: colors[idx % colors.length] }}
                                  ></div>
                                  <span className="font-mono text-slate-300">{holding.symbol}</span>
                                </div>
                                <span className="font-semibold text-white">{percent.toFixed(1)}%</span>
                              </div>
                            );
                        })}
                        {metrics.holdings.length > 5 && (
                          <div className="text-xs text-slate-500 pt-1">
                            +{metrics.holdings.length - 5} more
                          </div>
                        )}
                      </div>
                    </div>

                    {/* Allocation by Sector */}
                    <div className="glass-card p-5 rounded-xl">
                      <h4 className="text-sm font-bold text-slate-400 mb-4 uppercase tracking-wide flex items-center gap-2">
                        <i className="fas fa-layer-group text-purple-400"></i>
                        Allocation by Sector
                      </h4>
                      {(() => {
                        // Group holdings by sector
                        const sectorAllocation = {};
                        metrics.holdings.forEach(holding => {
                          const stock = stocks.find(s => s.symbol === holding.symbol);
                          const sector = stock?.sector || 'Unknown';
                          if (!sectorAllocation[sector]) {
                            sectorAllocation[sector] = 0;
                          }
                          sectorAllocation[sector] += holding.currentValue;
                        });
                        
                        const sectors = Object.entries(sectorAllocation)
                          .map(([sector, value]) => ({
                            sector,
                            value,
                            percent: (value / metrics.totalValue) * 100
                          }))
                          .sort((a, b) => b.value - a.value);

                        return (
                          <div className="space-y-3">
                            {sectors.map((item, idx) => (
                              <div key={item.sector}>
                                <div className="flex items-center justify-between text-xs mb-1">
                                  <span className="font-semibold text-slate-300">{item.sector}</span>
                                  <span className="text-white font-mono">{item.percent.toFixed(1)}%</span>
                                </div>
                                <div className="w-full bg-slate-700/50 rounded-full h-2 overflow-hidden">
                                  <div 
                                    className="h-full rounded-full transition-all duration-500"
                                    style={{ 
                                      width: `${item.percent}%`,
                                      background: `linear-gradient(90deg, ${
                                        idx === 0 ? '#06b6d4, #3b82f6' :
                                        idx === 1 ? '#8b5cf6, #a855f7' :
                                        idx === 2 ? '#10b981, #34d399' :
                                        idx === 3 ? '#f59e0b, #fbbf24' :
                                        '#ef4444, #f87171'
                                      })`
                                    }}
                                  />
                                </div>
                              </div>
                            ))}
                            {sectors.length === 0 && (
                              <div className="text-center py-8 text-slate-500 text-sm">
                                Sector data not available
                              </div>
                            )}
                          </div>
                        );
                      })()}
                    </div>
                  </div>

                  {/* Performance Over Time Bar Chart */}
                  <div className="glass-card p-5 rounded-xl mb-6">
                    <h4 className="text-sm font-bold text-slate-400 mb-4 uppercase tracking-wide flex items-center gap-2">
                      <i className="fas fa-chart-bar text-green-400"></i>
                      Gain/Loss Distribution
                    </h4>
                    <div className="space-y-3">
                      {metrics.holdings
                        .sort((a, b) => b.gainLossPercent - a.gainLossPercent)
                        .map(holding => {
                          const maxPercent = Math.max(...metrics.holdings.map(h => Math.abs(h.gainLossPercent)));
                          const barWidth = Math.min((Math.abs(holding.gainLossPercent) / maxPercent) * 100, 100);
                          const isPositive = holding.gainLossPercent >= 0;
                          
                          return (
                            <div key={holding.id} className="flex items-center gap-3">
                              <div className="w-16 text-right">
                                <span className="font-mono text-xs text-cyan-300 font-semibold">
                                  {holding.symbol}
                                </span>
                              </div>
                              <div className="flex-1 flex items-center">
                                <div className="relative w-full h-8 bg-slate-700/30 rounded">
                                  <div 
                                    className={`absolute top-0 left-1/2 h-full rounded transition-all duration-500 ${
                                      isPositive ? 'bg-gradient-to-r from-green-500/80 to-green-400' : 'bg-gradient-to-l from-red-500/80 to-red-400'
                                    }`}
                                    style={{ 
                                      width: `${barWidth / 2}%`,
                                      [isPositive ? 'left' : 'right']: '50%',
                                      transform: isPositive ? 'none' : 'scaleX(-1)'
                                    }}
                                  ></div>
                                  <div className="absolute inset-0 flex items-center justify-center">
                                    <span className={`text-xs font-bold font-mono ${
                                      Math.abs(holding.gainLossPercent) > 5 ? 'text-white' : 
                                      isPositive ? 'text-green-400' : 'text-red-400'
                                    }`}>
                                      {isPositive ? '+' : ''}{holding.gainLossPercent.toFixed(2)}%
                                    </span>
                                  </div>
                                </div>
                              </div>
                              <div className="w-24 text-right">
                                <span className={`text-xs font-mono font-bold ${isPositive ? 'text-green-400' : 'text-red-400'}`}>
                                  {isPositive ? '+' : ''}${holding.gainLoss.toFixed(2)}
                                </span>
                              </div>
                            </div>
                          );
                        })}
                    </div>
                  </div>

                  {/* Holdings Table */}
                  <div className="glass rounded-xl overflow-hidden">
                    <table className="w-full text-sm">
                      <thead>
                        <tr className="bg-slate-800/50 text-slate-400 text-xs uppercase tracking-wide">
                          <th className="text-left p-4">Symbol</th>
                          <th className="text-right p-4">Qty</th>
                          <th className="text-right p-4">Buy Price</th>
                          <th className="text-right p-4">Current</th>
                          <th className="text-right p-4">Cost Basis</th>
                          <th className="text-right p-4">Current Value</th>
                          <th className="text-right p-4">Gain/Loss ($)</th>
                          <th className="text-right p-4">Gain/Loss (%)</th>
                          <th className="text-right p-4">Day Change</th>
                          <th className="text-center p-4">Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        {metrics.holdings.map((holding, index) => (
                          <tr key={holding.id} className="border-t border-slate-700/20 hover:bg-slate-800/30 transition">
                            <td className="p-4">
                              <div className="font-semibold text-cyan-300 font-mono">{holding.symbol}</div>
                              <div className="text-xs text-slate-500">{holding.buyDate}</div>
                            </td>
                            <td className="p-4 text-right font-mono text-white">{holding.quantity}</td>
                            <td className="p-4 text-right font-mono text-slate-300">
                              ${holding.buyPrice.toFixed(2)}
                            </td>
                            <td className="p-4 text-right font-mono text-white font-semibold">
                              ${holding.currentPrice?.toFixed(2) || 'â€”'}
                            </td>
                            <td className="p-4 text-right font-mono text-slate-300">
                              ${holding.costBasis?.toFixed(2) || 'â€”'}
                            </td>
                            <td className="p-4 text-right font-mono text-white font-semibold">
                              ${holding.currentValue?.toFixed(2) || 'â€”'}
                            </td>
                            <td className="p-4 text-right">
                              <span className={`font-mono font-bold ${holding.gainLoss >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                {holding.gainLoss >= 0 ? '+' : ''}${holding.gainLoss?.toFixed(2) || 'â€”'}
                              </span>
                            </td>
                            <td className="p-4 text-right">
                              <span className={`px-2 py-1 rounded font-mono font-bold text-sm ${
                                holding.gainLossPercent >= 10 ? 'bg-green-500/20 text-green-400' :
                                holding.gainLossPercent >= 0 ? 'bg-green-500/10 text-green-400' :
                                holding.gainLossPercent <= -10 ? 'bg-red-500/20 text-red-400' :
                                'bg-red-500/10 text-red-400'
                              }`}>
                                {holding.gainLossPercent >= 0 ? '+' : ''}{holding.gainLossPercent?.toFixed(2) || 'â€”'}%
                              </span>
                            </td>
                            <td className="p-4 text-right">
                              <span className={`font-mono text-sm ${holding.dayChange >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                                {holding.dayChange >= 0 ? '+' : ''}{holding.dayChange?.toFixed(2) || '0.00'}%
                              </span>
                            </td>
                            <td className="p-4 text-center">
                              <button
                                onClick={() => removePosition(holding.id)}
                                className="px-3 py-1 bg-red-600/20 hover:bg-red-600 text-red-400 hover:text-white rounded text-xs transition font-semibold"
                                title="Remove position"
                              >
                                <i className="fas fa-trash"></i>
                              </button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                      <tfoot>
                        <tr className="bg-slate-800/70 font-bold border-t-2 border-slate-600">
                          <td colSpan="4" className="p-4 text-right text-slate-300 uppercase tracking-wide">
                            Portfolio Total:
                          </td>
                          <td className="p-4 text-right font-mono text-white">
                            ${metrics.totalCost.toFixed(2)}
                          </td>
                          <td className="p-4 text-right font-mono text-white text-lg">
                            ${metrics.totalValue.toFixed(2)}
                          </td>
                          <td className="p-4 text-right">
                            <span className={`font-mono text-lg ${metrics.totalGainLoss >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                              {metrics.totalGainLoss >= 0 ? '+' : ''}${metrics.totalGainLoss.toFixed(2)}
                            </span>
                          </td>
                          <td className="p-4 text-right">
                            <span className={`px-3 py-1 rounded font-mono text-lg ${metrics.totalGainLossPercent >= 0 ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}`}>
                              {metrics.totalGainLossPercent >= 0 ? '+' : ''}{metrics.totalGainLossPercent.toFixed(2)}%
                            </span>
                          </td>
                          <td colSpan="2"></td>
                        </tr>
                      </tfoot>
                    </table>
                  </div>
                </div>
              )}
            </div>

            </>
            ) : (
              <div className="p-6 overflow-y-auto flex-1 space-y-6">
                {/* Health Check Content */}
                {!health ? (
                  <div className="text-center py-12 text-slate-400">
                    <i className="fas fa-heartbeat text-6xl mb-4 text-slate-700"></i>
                    <div className="text-xl font-semibold mb-2">No Data for Health Check</div>
                    <div className="text-sm">Add positions to your portfolio to see health metrics.</div>
                  </div>
                ) : (
                  <>
                    {/* Top Level Metrics */}
                    <div className="grid grid-cols-3 gap-4">
                      <div className="glass-card p-5 rounded-xl">
                        <div className="text-xs text-slate-500 mb-1 uppercase tracking-wide">Portfolio Beta</div>
                        <div className={`text-3xl font-bold ${health.weightedBeta > 1.2 ? 'text-red-400' : health.weightedBeta < 0.8 ? 'text-blue-400' : 'text-green-400'}`}>
                          {health.weightedBeta.toFixed(2)}
                        </div>
                        <div className="text-xs text-slate-500 mt-1">
                          {health.weightedBeta > 1.2 ? 'High Volatility' : health.weightedBeta < 0.8 ? 'Low Volatility' : 'Moderate Volatility'}
                        </div>
                      </div>
                      <div className="glass-card p-5 rounded-xl">
                        <div className="text-xs text-slate-500 mb-1 uppercase tracking-wide">Top Sector</div>
                        <div className="text-2xl font-bold text-white truncate">
                          {health.maxSector ? health.maxSector[0] : 'â€”'}
                        </div>
                        <div className="text-xs text-slate-500 mt-1">
                          {health.maxSector ? `${(health.maxSector[1] * 100).toFixed(1)}% Allocation` : 'â€”'}
                        </div>
                      </div>
                      <div className="glass-card p-5 rounded-xl">
                        <div className="text-xs text-slate-500 mb-1 uppercase tracking-wide">Diversification Score</div>
                        <div className="text-3xl font-bold text-cyan-400">
                          {Math.min(100, Math.max(0, 100 - (health.maxSector ? health.maxSector[1] * 100 : 0))).toFixed(0)}/100
                        </div>
                        <div className="text-xs text-slate-500 mt-1">
                          Based on concentration
                        </div>
                      </div>
                    </div>

                    {/* AI Insights */}
                    <div className="glass-card p-6 rounded-xl border border-cyan-500/20">
                      <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <i className="fas fa-robot text-cyan-400"></i>
                        AI Portfolio Insights
                      </h3>
                      <div className="space-y-3">
                        {health.insights.length === 0 ? (
                          <div className="text-slate-400 text-sm">
                            <i className="fas fa-check-circle text-green-400 mr-2"></i>
                            Your portfolio looks healthy! No critical warnings.
                          </div>
                        ) : (
                          health.insights.map((insight, idx) => (
                            <div key={idx} className={`p-3 rounded-lg flex items-start gap-3 ${
                              insight.type === 'warning' ? 'bg-red-500/10 border border-red-500/20' : 'bg-blue-500/10 border border-blue-500/20'
                            }`}>
                              <i className={`fas ${insight.type === 'warning' ? 'fa-exclamation-triangle text-red-400' : 'fa-info-circle text-blue-400'} mt-1`}></i>
                              <div className="text-sm text-slate-200">{insight.text}</div>
                            </div>
                          ))
                        )}
                      </div>
                    </div>

                    {/* Risk Analysis */}
                    <div className="glass-card p-6 rounded-xl">
                      <h3 className="text-lg font-bold text-white mb-4">Risk Analysis</h3>
                      <div className="space-y-4">
                        <div>
                          <div className="flex justify-between text-sm mb-1">
                            <span className="text-slate-400">Market Correlation (Beta)</span>
                            <span className="text-white font-bold">{health.weightedBeta.toFixed(2)}</span>
                          </div>
                          <div className="w-full bg-slate-700 rounded-full h-2">
                            <div 
                              className={`h-full rounded-full ${health.weightedBeta > 1 ? 'bg-red-400' : 'bg-green-400'}`}
                              style={{ width: `${Math.min(100, health.weightedBeta * 50)}%` }}
                            ></div>
                          </div>
                          <div className="flex justify-between text-xs text-slate-500 mt-1">
                            <span>Low Risk</span>
                            <span>Market Risk (1.0)</span>
                            <span>High Risk</span>
                          </div>
                        </div>
                      </div>
                    </div>

                    {/* Market Crash Simulator */}
                    {metrics.holdings.length > 0 && (
                      <div className="glass-card p-6 rounded-xl border border-purple-500/20">
                        <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                          <i className="fas fa-chart-line text-purple-400"></i>
                          Market Crash Simulator
                        </h3>
                        <MarketCrashSimulator holdings={metrics.holdings} totalValue={metrics.totalValue} />
                      </div>
                    )}
                  </>
                )}
              </div>
            )}

            {/* Footer */}
            <div className="flex justify-between items-center gap-3 p-6 border-t border-slate-700/30 flex-shrink-0">
              <div className="text-xs text-slate-500">
                <i className="fas fa-info-circle mr-1"></i>
                Portfolio data is stored locally in your browser
              </div>
              <button onClick={onClose} className="px-6 py-2.5 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold text-sm transition">
                Close
              </button>
            </div>
          </div>
        </div>
      );
    }


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MONTE CARLO SIMULATION FOR GOAL PLANNING
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Risk profiles with expected return and volatility
    const RISK_PROFILES = {
      conservative: { name: "Conservative", mu: 0.05, sigma: 0.08, desc: "Low risk, stable returns" },
      balanced: { name: "Balanced", mu: 0.07, sigma: 0.12, desc: "Moderate risk, balanced growth" },
      growth: { name: "Growth", mu: 0.085, sigma: 0.16, desc: "Higher risk, aggressive growth" }
    };
    
    // Random normal distribution (Box-Muller transform)
    function randn() {
      let u = 0, v = 0;
      while (u === 0) u = Math.random();
      while (v === 0) v = Math.random();
      return Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
    }
    
    // Monte Carlo simulation for goal planning
    function runMonteCarloGoalSimulation(goal, nSims = 6000) {
      const startAmount = Math.max(0, Number(goal.currentSavings || 0));
      const monthlyContribution = Math.max(0, Number(goal.monthlyContribution || 0));
      const targetAmount = Math.max(0, Number(goal.targetAmount || 0));
      const riskProfile = goal.riskProfile || 'balanced';
      
      const risk = RISK_PROFILES[riskProfile];
      const mu = risk.mu;        // annual expected return
      const sigma = risk.sigma;  // annual volatility
      
      // Calculate months to target date
      const today = new Date();
      const targetDate = goal.targetDate ? new Date(goal.targetDate) : new Date(today.getTime() + 10 * 365 * 24 * 60 * 60 * 1000);
      const months = Math.max(1, Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24 * 30)));
      
      const dt = 1/12;  // monthly timestep
      const drift = (mu - 0.5 * sigma * sigma) * dt;
      const volStep = sigma * Math.sqrt(dt);
      
      // Run simulations
      const terminal = new Float64Array(nSims);
      const valuesByMonth = Array.from({ length: months + 1 }, () => []);
      
      for (let i = 0; i < nSims; i++) {
        let value = startAmount;
        
        for (let m = 0; m <= months; m++) {
          if (m % Math.ceil(months / 60) === 0) { // Sample for chart
            valuesByMonth[m].push(value);
          }
          
          if (m === months) {
            terminal[i] = value;
            break;
          }
          
          const z = randn();
          const logReturn = drift + volStep * z;
          value = value * Math.exp(logReturn) + monthlyContribution;
        }
      }
      
      // Calculate success probability
      let successCount = 0;
      for (let i = 0; i < nSims; i++) {
        if (terminal[i] >= targetAmount) successCount++;
      }
      const successProb = successCount / nSims;
      
      // Terminal value percentiles
      const terminalSorted = Array.from(terminal).sort((a, b) => a - b);
      const p10 = percentileSorted(terminalSorted, 0.10);
      const p50 = percentileSorted(terminalSorted, 0.50);
      const p90 = percentileSorted(terminalSorted, 0.90);
      
      // Fan chart data
      const fanSeries = [];
      for (let m = 0; m <= months; m += Math.ceil(months / 60)) {
        const values = valuesByMonth[m].sort((a, b) => a - b);
        if (values.length > 0) {
          fanSeries.push({
            month: m,
            p10: percentileSorted(values, 0.10),
            p50: percentileSorted(values, 0.50),
            p90: percentileSorted(values, 0.90)
          });
        }
      }
      
      return {
        successProb,
        p10,
        p50,
        p90,
        fanSeries,
        months
      };
    }
    
    function percentileSorted(sortedArr, p) {
      if (!sortedArr.length) return 0;
      const idx = (sortedArr.length - 1) * p;
      const lo = Math.floor(idx), hi = Math.ceil(idx);
      if (lo === hi) return sortedArr[lo];
      const weight = idx - lo;
      return sortedArr[lo] * (1 - weight) + sortedArr[hi] * weight;
    }
    
    // Find required monthly contribution to reach target probability
    function findRequiredContribution(goal, targetProb = 0.80) {
      const baseContribution = Math.max(0, Number(goal.monthlyContribution || 0));
      let lo = baseContribution;
      let hi = baseContribution + 3000;
      
      // Ensure hi is enough
      for (let k = 0; k < 4; k++) {
        const testGoal = { ...goal, monthlyContribution: hi };
        const result = runMonteCarloGoalSimulation(testGoal, 3000);
        if (result.successProb >= targetProb) break;
        hi += 2000;
      }
      
      // Binary search
      for (let iter = 0; iter < 10; iter++) {
        const mid = (lo + hi) / 2;
        const testGoal = { ...goal, monthlyContribution: mid };
        const result = runMonteCarloGoalSimulation(testGoal, 3000);
        if (result.successProb >= targetProb) {
          hi = mid;
        } else {
          lo = mid;
        }
      }
      
      return Math.round(hi / 10) * 10;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FINANCIAL GOAL PLANNER MODAL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function GoalPlannerModal({ onClose, goals, setGoals }) {
      const [newGoal, setNewGoal] = useState({
        name: '',
        targetAmount: '',
        currentSavings: '',
        monthlyContribution: '',
        targetDate: '',
        type: 'retirement', // retirement, education, house, emergency, other
        riskProfile: 'balanced' // conservative, balanced, growth
      });
      
      const [showNewGoalForm, setShowNewGoalForm] = useState(false);
      const [selectedGoalForAnalysis, setSelectedGoalForAnalysis] = useState(null);
      const [simulationResults, setSimulationResults] = useState({});
      
      const GOAL_TYPES = {
        retirement: { icon: 'ğŸ–ï¸', color: 'text-blue-400', bg: 'bg-blue-500/10', border: 'border-blue-500/20' },
        education: { icon: 'ğŸ“', color: 'text-purple-400', bg: 'bg-purple-500/10', border: 'border-purple-500/20' },
        house: { icon: 'ğŸ ', color: 'text-green-400', bg: 'bg-green-500/10', border: 'border-green-500/20' },
        emergency: { icon: 'ğŸš¨', color: 'text-red-400', bg: 'bg-red-500/10', border: 'border-red-500/20' },
        other: { icon: 'ğŸ¯', color: 'text-cyan-400', bg: 'bg-cyan-500/10', border: 'border-cyan-500/20' }
      };
      
      // Run Monte Carlo simulation for a goal
      const runSimulationForGoal = (goal) => {
        const result = runMonteCarloGoalSimulation(goal, 6000);
        setSimulationResults(prev => ({ ...prev, [goal.id]: result }));
        return result;
      };
      
      // Render fan chart visualization
      const renderFanChart = (containerId, result, goal) => {
        setTimeout(() => {
          const container = document.getElementById(containerId);
          if (!container || !result) return;
          
          container.innerHTML = '';
          
          const margin = { top: 10, right: 14, bottom: 26, left: 56 };
          const width = container.clientWidth - margin.left - margin.right;
          const height = 240 - margin.top - margin.bottom;
          
          const svg = d3.select(container)
            .append('svg')
            .attr('width', width + margin.left + margin.right)
            .attr('height', height + margin.top + margin.bottom)
            .append('g')
            .attr('transform', `translate(${margin.left}, ${margin.top})`);
          
          const months = result.fanSeries.map(d => d.month);
          const allValues = result.fanSeries.flatMap(d => [d.p10, d.p50, d.p90]);
          const targetAmount = parseFloat(goal.targetAmount) || 0;
          
          const xScale = d3.scaleLinear()
            .domain([0, d3.max(months)])
            .range([0, width]);
          
          const yScale = d3.scaleLinear()
            .domain([0, Math.max(d3.max(allValues), targetAmount) * 1.1])
            .range([height, 0]);
          
          // Fan area (10th-90th percentile)
          const area = d3.area()
            .x(d => xScale(d.month))
            .y0(d => yScale(d.p10))
            .y1(d => yScale(d.p90))
            .curve(d3.curveMonotoneX);
          
          svg.append('path')
            .datum(result.fanSeries)
            .attr('d', area)
            .attr('fill', 'rgba(6,182,212,0.16)')
            .attr('stroke', 'none');
          
          // Median line (50th percentile)
          const medianLine = d3.line()
            .x(d => xScale(d.month))
            .y(d => yScale(d.p50))
            .curve(d3.curveMonotoneX);
          
          svg.append('path')
            .datum(result.fanSeries)
            .attr('d', medianLine)
            .attr('fill', 'none')
            .attr('stroke', '#a78bfa')
            .attr('stroke-width', 2);
          
          // Target line
          svg.append('line')
            .attr('x1', 0)
            .attr('x2', width)
            .attr('y1', yScale(targetAmount))
            .attr('y2', yScale(targetAmount))
            .attr('stroke', '#fbbf24')
            .attr('stroke-width', 2)
            .attr('stroke-dasharray', '4,4');
          
          // X-axis
          const xAxis = d3.axisBottom(xScale)
            .ticks(5)
            .tickFormat(d => `${(d/12).toFixed(0)}y`);
          
          svg.append('g')
            .attr('transform', `translate(0, ${height})`)
            .call(xAxis)
            .attr('color', '#64748b')
            .selectAll('text')
            .style('font-size', '11px');
          
          // Y-axis
          const yAxis = d3.axisLeft(yScale)
            .ticks(5)
            .tickFormat(d => `$${(d/1000).toFixed(0)}k`);
          
          svg.append('g')
            .call(yAxis)
            .attr('color', '#64748b')
            .selectAll('text')
            .style('font-size', '11px');
          
        }, 100);
      };
      
      // Find required contribution to hit 80% probability
      const calculateRequiredContribution = (goal) => {
        return findRequiredContribution(goal, 0.80);
      };
      
      // Calculate goal metrics
      const calculateGoalMetrics = (goal) => {
        const target = parseFloat(goal.targetAmount) || 0;
        const current = parseFloat(goal.currentSavings) || 0;
        const monthly = parseFloat(goal.monthlyContribution) || 0;
        const targetDate = goal.targetDate ? new Date(goal.targetDate) : null;
        const today = new Date();
        
        const remaining = target - current;
        const progress = target > 0 ? (current / target) * 100 : 0;
        
        let monthsRemaining = 0;
        if (targetDate) {
          monthsRemaining = Math.max(0, Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24 * 30)));
        }
        
        const requiredMonthly = monthsRemaining > 0 ? remaining / monthsRemaining : 0;
        const projectedTotal = current + (monthly * monthsRemaining);
        const onTrack = monthly >= requiredMonthly;
        
        // Calculate with 7% annual return (average stock market)
        const monthlyRate = 0.07 / 12;
        let futureValue = current;
        for (let i = 0; i < monthsRemaining; i++) {
          futureValue = futureValue * (1 + monthlyRate) + monthly;
        }
        
        return {
          target,
          current,
          monthly,
          remaining,
          progress: Math.min(100, progress),
          monthsRemaining,
          yearsRemaining: monthsRemaining / 12,
          requiredMonthly,
          projectedTotal,
          futureValueWithGrowth: futureValue,
          onTrack,
          shortfall: Math.max(0, target - futureValue),
          surplus: Math.max(0, futureValue - target)
        };
      };
      
      const addGoal = () => {
        if (!newGoal.name || !newGoal.targetAmount) {
          alert('Please enter goal name and target amount');
          return;
        }
        
        const goalWithId = {
          ...newGoal,
          id: Date.now(),
          createdAt: new Date().toISOString()
        };
        
        const updated = [...goals, goalWithId];
        setGoals(updated);
        localStorage.setItem('re_financial_goals', JSON.stringify(updated));
        
        setNewGoal({
          name: '',
          targetAmount: '',
          currentSavings: '',
          monthlyContribution: '',
          targetDate: '',
          type: 'retirement',
          riskProfile: 'balanced'
        });
        setShowNewGoalForm(false);
      };
      
      const deleteGoal = (id) => {
        const updated = goals.filter(g => g.id !== id);
        setGoals(updated);
        localStorage.setItem('re_financial_goals', JSON.stringify(updated));
      };
      
      const updateGoal = (id, field, value) => {
        const updated = goals.map(g => g.id === id ? { ...g, [field]: value } : g);
        setGoals(updated);
        localStorage.setItem('re_financial_goals', JSON.stringify(updated));
      };
      
      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="glass-elevated rounded-2xl max-w-6xl w-full mx-auto my-8 animate-slide-up max-h-[90vh] overflow-hidden flex flex-col" onClick={(e) => e.stopPropagation()}>
            {/* Header */}
            <div className="flex items-center justify-between p-6 border-b border-slate-700/30 flex-shrink-0">
              <div>
                <h2 className="text-3xl font-bold text-white mb-1 flex items-center gap-2">
                  <span>ğŸ¯</span> Financial Goal Planner
                </h2>
                <p className="text-sm text-slate-400">Plan and track your investment goals with retirement, education, and more</p>
              </div>
              <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            
            {/* Content */}
            <div className="p-6 overflow-y-auto flex-1">
              {/* Add New Goal Button */}
              {!showNewGoalForm && (
                <button
                  onClick={() => setShowNewGoalForm(true)}
                  className="w-full mb-6 px-6 py-4 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white rounded-xl font-semibold flex items-center justify-center gap-2 transition"
                >
                  <i className="fas fa-plus-circle"></i>
                  Add New Financial Goal
                </button>
              )}
              
              {/* New Goal Form */}
              {showNewGoalForm && (
                <div className="glass-goal-card p-6 mb-6">
                  <h3 className="text-lg font-bold text-white mb-4">Create New Goal</h3>
                  <div className="goal-input-grid mb-4">
                    <div>
                      <label className="text-xs text-slate-400 mb-1 block">Goal Name *</label>
                      <input
                        type="text"
                        value={newGoal.name}
                        onChange={(e) => setNewGoal({ ...newGoal, name: e.target.value })}
                        className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded text-white focus:outline-none focus:border-cyan-500"
                        placeholder="e.g., Retirement Fund"
                      />
                    </div>
                    <div>
                      <label className="text-xs text-slate-400 mb-1 block">Goal Type</label>
                      <select
                        value={newGoal.type}
                        onChange={(e) => setNewGoal({ ...newGoal, type: e.target.value })}
                        className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded text-white focus:outline-none focus:border-cyan-500"
                      >
                        <option value="retirement">ğŸ–ï¸ Retirement</option>
                        <option value="education">ğŸ“ Education</option>
                        <option value="house">ğŸ  House/Property</option>
                        <option value="emergency">ğŸš¨ Emergency Fund</option>
                        <option value="other">ğŸ¯ Other</option>
                      </select>
                    </div>
                    <div>
                      <label className="text-xs text-slate-400 mb-1 block">Risk Profile</label>
                      <select
                        value={newGoal.riskProfile}
                        onChange={(e) => setNewGoal({ ...newGoal, riskProfile: e.target.value })}
                        className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded text-white focus:outline-none focus:border-cyan-500"
                      >
                        <option value="conservative">Conservative (5% return, 8% vol)</option>
                        <option value="balanced">Balanced (7% return, 12% vol)</option>
                        <option value="growth">Growth (8.5% return, 16% vol)</option>
                      </select>
                    </div>
                    <div>
                      <label className="text-xs text-slate-400 mb-1 block">Target Amount ($) *</label>
                      <input
                        type="number"
                        value={newGoal.targetAmount}
                        onChange={(e) => setNewGoal({ ...newGoal, targetAmount: e.target.value })}
                        className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded text-white focus:outline-none focus:border-cyan-500"
                        placeholder="1000000"
                      />
                    </div>
                    <div>
                      <label className="text-xs text-slate-400 mb-1 block">Current Savings ($)</label>
                      <input
                        type="number"
                        value={newGoal.currentSavings}
                        onChange={(e) => setNewGoal({ ...newGoal, currentSavings: e.target.value })}
                        className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded text-white focus:outline-none focus:border-cyan-500"
                        placeholder="50000"
                      />
                    </div>
                    <div>
                      <label className="text-xs text-slate-400 mb-1 block">Monthly Contribution ($)</label>
                      <input
                        type="number"
                        value={newGoal.monthlyContribution}
                        onChange={(e) => setNewGoal({ ...newGoal, monthlyContribution: e.target.value })}
                        className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded text-white focus:outline-none focus:border-cyan-500"
                        placeholder="2000"
                      />
                    </div>
                    <div>
                      <label className="text-xs text-slate-400 mb-1 block">Target Date</label>
                      <input
                        type="date"
                        value={newGoal.targetDate}
                        onChange={(e) => setNewGoal({ ...newGoal, targetDate: e.target.value })}
                        className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded text-white focus:outline-none focus:border-cyan-500"
                      />
                    </div>
                  </div>
                  <div className="goal-action-buttons">
                    <button
                      onClick={addGoal}
                      className="px-6 py-2 bg-green-600 hover:bg-green-500 text-white rounded-lg font-semibold transition"
                    >
                      <i className="fas fa-check mr-2"></i>Save Goal
                    </button>
                    <button
                      onClick={() => setShowNewGoalForm(false)}
                      className="px-6 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold transition"
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              )}
              
              {/* Goals List */}
              {goals.length === 0 ? (
                <div className="text-center py-12">
                  <i className="fas fa-bullseye text-6xl text-slate-700 mb-4"></i>
                  <div className="text-xl font-semibold text-white mb-2">No Goals Yet</div>
                  <div className="text-sm text-slate-400">Start planning your financial future by adding your first goal</div>
                </div>
              ) : (
                <div className="space-y-6">
                  {goals.map(goal => {
                    const metrics = calculateGoalMetrics(goal);
                    const typeConfig = GOAL_TYPES[goal.type] || GOAL_TYPES.other;
                    const simResult = simulationResults[goal.id];
                    
                    // Run simulation if not yet done
                    if (!simResult && goal.targetDate && goal.targetAmount) {
                      setTimeout(() => runSimulationForGoal(goal), 100);
                    }
                    
                    // Render fan chart if simulation is complete
                    React.useEffect(() => {
                      if (simResult) {
                        renderFanChart(`fan-chart-${goal.id}`, simResult, goal);
                      }
                    }, [simResult]);
                    
                    const successProb = simResult ? simResult.successProb : null;
                    const probColor = successProb >= 0.8 ? 'text-green-400' : successProb >= 0.6 ? 'text-yellow-400' : 'text-red-400';
                    
                    return (
                      <div key={goal.id} className={`glass-goal-card p-6 border ${typeConfig.border}`}>
                        <div className="flex items-start justify-between mb-4">
                          <div className="flex items-center gap-3">
                            <span className="text-3xl">{typeConfig.icon}</span>
                            <div>
                              <h3 className="text-xl font-bold text-white">{goal.name}</h3>
                              <div className="text-xs text-slate-400 mt-1">
                                Created {new Date(goal.createdAt).toLocaleDateString()} â€¢ {RISK_PROFILES[goal.riskProfile || 'balanced'].name} Portfolio
                              </div>
                            </div>
                          </div>
                          <button
                            onClick={() => deleteGoal(goal.id)}
                            className="text-red-400 hover:text-red-300 text-sm"
                          >
                            <i className="fas fa-trash"></i>
                          </button>
                        </div>
                        
                        {/* Monte Carlo Probability */}
                        {simResult && (
                          <div className="mb-4 p-4 bg-slate-800/50 rounded-lg border border-slate-700">
                            <div className="flex items-center justify-between">
                              <span className="text-sm text-slate-300">Success Probability (Monte Carlo)</span>
                              <span className={`text-2xl font-bold ${probColor}`}>
                                {(successProb * 100).toFixed(0)}%
                              </span>
                            </div>
                            <div className="text-xs text-slate-500 mt-2">
                              Based on 6,000 simulations â€¢ {RISK_PROFILES[goal.riskProfile || 'balanced'].desc}
                            </div>
                            {successProb < 0.8 && (
                              <div className="mt-3 pt-3 border-t border-slate-700">
                                <div className="text-sm text-yellow-400">
                                  ğŸ’¡ To reach 80% probability, increase monthly to: <strong>${calculateRequiredContribution(goal).toLocaleString()}</strong>
                                </div>
                              </div>
                            )}
                          </div>
                        )}
                        
                        {/* Fan Chart */}
                        {simResult && (
                          <div className="mb-4">
                            <div className="text-sm font-semibold text-slate-300 mb-2">Projected Outcomes</div>
                            <div id={`fan-chart-${goal.id}`} className="bg-slate-900/50 rounded-lg p-2"></div>
                            <div className="flex items-center justify-between text-xs text-slate-500 mt-2">
                              <span>ğŸŸ¦ 10th-90th percentile range</span>
                              <span>ğŸŸª Median (50th)</span>
                              <span>ğŸŸ¨ Target ({formatCurrency(goal.targetAmount)})</span>
                            </div>
                          </div>
                        )}
                        
                        {/* Progress Bar */}
                        <div className="mb-4">
                          <div className="flex justify-between text-sm mb-2">
                            <span className="text-slate-400">Current Progress</span>
                            <span className="font-bold text-white">{metrics.progress.toFixed(1)}%</span>
                          </div>
                          <div className="w-full bg-slate-700 rounded-full h-3">
                            <div 
                              className={`h-full ${typeConfig.bg.replace('/10', '')} rounded-full transition-all ${metrics.progress >= 100 ? 'goal-complete-animation' : ''}`}
                              style={{ width: `${Math.min(100, metrics.progress)}%` }}
                            ></div>
                          </div>
                        </div>
                        
                        {/* Metrics Grid */}
                        <div className="goal-results-grid mb-4">
                          <div className="glass-card p-4 rounded-lg">
                            <div className="text-xs text-slate-500 mb-1">Target</div>
                            <div className="text-2xl font-bold text-white">
                              ${metrics.target.toLocaleString()}
                            </div>
                          </div>
                          <div className="glass-card p-4 rounded-lg">
                            <div className="text-xs text-slate-500 mb-1">Current</div>
                            <div className="text-2xl font-bold text-cyan-400">
                              ${metrics.current.toLocaleString()}
                            </div>
                          </div>
                          <div className="glass-card p-4 rounded-lg">
                            <div className="text-xs text-slate-500 mb-1">Monthly</div>
                            <div className="text-2xl font-bold text-green-400">
                              ${metrics.monthly.toLocaleString()}
                            </div>
                          </div>
                          <div className="glass-card p-4 rounded-lg">
                            <div className="text-xs text-slate-500 mb-1">Time Left</div>
                            <div className="text-2xl font-bold text-white">
                              {metrics.yearsRemaining.toFixed(1)} yrs
                            </div>
                          </div>
                        </div>
                        
                        {/* Percentile Projections */}
                        {simResult && (
                          <div className={`p-4 rounded-lg ${typeConfig.bg} border ${typeConfig.border}`}>
                            <div className="text-sm space-y-2">
                              <div className="flex justify-between">
                                <span className="text-slate-300">10th Percentile (Pessimistic):</span>
                                <span className="font-bold text-red-300">
                                  ${simResult.p10.toLocaleString(undefined, { maximumFractionDigits: 0 })}
                                </span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-slate-300">50th Percentile (Median):</span>
                                <span className="font-bold text-white">
                                  ${simResult.p50.toLocaleString(undefined, { maximumFractionDigits: 0 })}
                                </span>
                              </div>
                              <div className="flex justify-between">
                                <span className="text-slate-300">90th Percentile (Optimistic):</span>
                                <span className="font-bold text-green-300">
                                  ${simResult.p90.toLocaleString(undefined, { maximumFractionDigits: 0 })}
                                </span>
                              </div>
                            </div>
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
            
            {/* Footer */}
            <div className="flex justify-between items-center p-6 border-t border-slate-700/30 flex-shrink-0">
              <div className="text-xs text-slate-500">
                <i className="fas fa-info-circle mr-1"></i>
                Projections use Monte Carlo simulation with 6,000 runs â€¢ Risk-adjusted returns based on selected profile
              </div>
              <button onClick={onClose} className="px-6 py-2.5 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold text-sm transition">
                Close
              </button>
            </div>
          </div>
        </div>
      );
    }


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // HEATMAP MODAL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function HeatmapModal({ onClose, stocks }) {
      const [timeframe, setTimeframe] = useState('1D'); // 1D, 1W, 1M, YTD
      
      // Group stocks by sector
      const sectors = useMemo(() => {
        const groups = {};
        stocks.forEach(stock => {
          const sector = stock.sector || 'Unknown';
          if (!groups[sector]) groups[sector] = [];
          groups[sector].push(stock);
        });
        
        // Calculate sector metrics
        return Object.entries(groups).map(([name, items]) => {
          const totalMarketCap = items.reduce((sum, s) => sum + (s.marketCap || 0), 0);
          const avgChange = items.reduce((sum, s) => sum + (s.changePct || 0), 0) / items.length;
          
          // Sort items by market cap within sector
          items.sort((a, b) => (b.marketCap || 0) - (a.marketCap || 0));
          
          return {
            name,
            items,
            totalMarketCap,
            avgChange,
            weight: items.length // simplified weight for now
          };
        }).sort((a, b) => b.totalMarketCap - a.totalMarketCap);
      }, [stocks]);

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="glass-elevated rounded-2xl max-w-7xl w-full mx-auto my-8 animate-slide-up max-h-[90vh] overflow-hidden flex flex-col" onClick={(e) => e.stopPropagation()}>
            {/* Header */}
            <div className="flex items-center justify-between p-6 border-b border-slate-700/30 flex-shrink-0">
              <div>
                <h2 className="text-2xl font-bold text-white mb-1">ğŸ—ºï¸ Sector Rotation Heatmap</h2>
                <p className="text-sm text-slate-400">
                  Visualizing {stocks.length} stocks across {sectors.length} sectors
                </p>
              </div>
              <div className="flex items-center gap-3">
                <div className="bg-slate-800 rounded-lg p-1 flex text-xs font-semibold">
                  {['1D'].map(t => (
                    <button 
                      key={t}
                      onClick={() => setTimeframe(t)}
                      className={`px-3 py-1.5 rounded-md transition ${timeframe === t ? 'bg-slate-600 text-white shadow' : 'text-slate-400 hover:text-slate-200'}`}
                    >
                      {t}
                    </button>
                  ))}
                </div>
                <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl leading-none">&times;</button>
              </div>
            </div>

            {/* Heatmap Content */}
            <div className="p-6 overflow-y-auto flex-1 bg-slate-900/50">
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                {sectors.map(sector => (
                  <div key={sector.name} className="glass-card flex flex-col overflow-hidden h-[300px]">
                    {/* Sector Header */}
                    <div className="p-3 border-b border-slate-700/30 flex justify-between items-center bg-slate-800/40">
                      <span className="font-bold text-sm text-slate-200 truncate" title={sector.name}>{sector.name}</span>
                      <span className={`text-xs font-bold px-2 py-0.5 rounded ${sector.avgChange >= 0 ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}`}>
                        {sector.avgChange > 0 ? '+' : ''}{sector.avgChange.toFixed(2)}%
                      </span>
                    </div>
                    
                    {/* Stock Grid (Treemap-ish) */}
                    <div className="flex-1 p-2 flex flex-wrap content-start gap-1 overflow-y-auto">
                      {sector.items.map(stock => {
                        // Size based on relative market cap within sector (simplified)
                        // We'll use a simple grid for now, but color is key
                        const change = stock.changePct || 0;
                        const colorClass = change >= 3 ? 'bg-green-500' :
                                         change >= 1 ? 'bg-green-600' :
                                         change >= 0 ? 'bg-green-700' :
                                         change <= -3 ? 'bg-red-500' :
                                         change <= -1 ? 'bg-red-600' :
                                         'bg-red-700';
                        
                        // Dynamic sizing based on market cap rank in sector
                        const isLarge = stock.marketCap > sector.totalMarketCap * 0.2;
                        
                        return (
                          <div 
                            key={stock.symbol}
                            className={`${colorClass} ${isLarge ? 'w-full h-16' : 'flex-1 min-w-[60px] h-12'} rounded p-2 flex flex-col justify-center items-center cursor-pointer hover:brightness-110 transition relative group overflow-hidden`}
                            onClick={() => window.open(`https://financialmodelingprep.com/financial-summary/${stock.symbol}`, '_blank')}
                            title={`${stock.companyName}: ${change.toFixed(2)}%`}
                          >
                            <span className="font-bold text-white text-xs shadow-black drop-shadow-md">{stock.symbol}</span>
                            <span className="text-[10px] text-white/90 font-semibold drop-shadow-md">
                              {change > 0 ? '+' : ''}{change.toFixed(1)}%
                            </span>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                ))}
              </div>
            </div>
            
            {/* Legend */}
            <div className="p-4 border-t border-slate-700/30 bg-slate-800/30 flex justify-center gap-6 text-xs">
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 bg-red-600 rounded"></div>
                <span className="text-slate-400">-1% to -3%</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 bg-red-500 rounded"></div>
                <span className="text-slate-400">&lt; -3%</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 bg-green-700 rounded"></div>
                <span className="text-slate-400">0% to +1%</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 bg-green-600 rounded"></div>
                <span className="text-slate-400">+1% to +3%</span>
              </div>
              <div className="flex items-center gap-2">
                <div className="w-4 h-4 bg-green-500 rounded"></div>
                <span className="text-slate-400">&gt; +3%</span>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // PORTFOLIO ALLOCATION MODAL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function PortfolioAllocationModal({ onClose, stocks, watchlist }) {
      const portfolioData = computePortfolioAllocation(stocks, watchlist);
      
      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="glass-elevated rounded-2xl max-w-4xl w-full mx-auto my-8 animate-slide-up max-h-[90vh] overflow-hidden flex flex-col" onClick={(e) => e.stopPropagation()}>
            {/* Header */}
            <div className="flex items-center justify-between p-6 border-b border-slate-700/30 flex-shrink-0">
              <div>
                <h2 className="text-2xl font-bold text-white mb-1">Portfolio Allocation</h2>
                <p className="text-sm text-slate-400">
                  {portfolioData.isEmpty 
                    ? 'Add stocks to your watchlist to see allocation breakdown'
                    : `${portfolioData.totalStocks} stocks across ${portfolioData.sectorCount} sectors`
                  }
                </p>
              </div>
              <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            
            {/* Content */}
            <div className="p-6 overflow-y-auto flex-1">
              {portfolioData.isEmpty ? (
                <div className="text-center py-12">
                  <div className="text-6xl mb-4">ğŸ“Š</div>
                  <h3 className="text-xl font-bold text-white mb-2">No Stocks in Watchlist</h3>
                  <p className="text-slate-400 mb-6">
                    Add stocks to your watchlist to see your portfolio allocation breakdown by sector.
                  </p>
                  <button 
                    onClick={onClose}
                    className="px-6 py-3 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg font-semibold transition"
                  >
                    Browse Stocks
                  </button>
                </div>
              ) : (
                <div className="space-y-6">
                  {/* Sector Allocation Bars */}
                  <div>
                    <h3 className="text-sm font-bold text-slate-400 mb-4 uppercase tracking-wide">
                      Sector Allocation
                    </h3>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                      {Object.entries(portfolioData.sectorWeights)
                        .sort((a, b) => b[1] - a[1])
                        .map(([sector, weight]) => (
                        <div key={sector} className="glass-card p-4 rounded-xl">
                          <div className="flex items-center justify-between mb-2">
                            <span className="font-semibold text-white">{sector}</span>
                            <span className="text-cyan-400 font-mono font-bold">{weight.toFixed(1)}%</span>
                          </div>
                          <div className="w-full bg-slate-700/50 rounded-full h-3 overflow-hidden">
                            <div 
                              className={`h-full rounded-full bg-gradient-to-r ${getSectorColor(sector)} transition-all duration-500`}
                              style={{ width: `${weight}%` }}
                            />
                          </div>
                          <div className="text-xs text-slate-500 mt-1">
                            {portfolioData.stocks.filter(s => s.sector === sector).length} stock{portfolioData.stocks.filter(s => s.sector === sector).length !== 1 ? 's' : ''}
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                  
                  {/* Diversification Insights */}
                  <div className="glass-card p-5 rounded-xl">
                    <h3 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">
                      Diversification Analysis
                    </h3>
                    <div className="grid grid-cols-3 gap-4">
                      <div>
                        <div className="text-xs text-slate-500 mb-1">Total Stocks</div>
                        <div className="text-2xl font-bold text-white">{portfolioData.totalStocks}</div>
                      </div>
                      <div>
                        <div className="text-xs text-slate-500 mb-1">Sectors</div>
                        <div className="text-2xl font-bold text-white">{portfolioData.sectorCount}</div>
                      </div>
                      <div>
                        <div className="text-xs text-slate-500 mb-1">Avg per Stock</div>
                        <div className="text-2xl font-bold text-white">{(100 / portfolioData.totalStocks).toFixed(1)}%</div>
                      </div>
                    </div>
                    
                    {/* Risk Assessment */}
                    {(() => {
                      const maxWeight = Math.max(...Object.values(portfolioData.sectorWeights));
                      const isConcentrated = maxWeight > 50;
                      const isDiversified = portfolioData.sectorCount >= 3 && maxWeight < 40;
                      
                      return (
                        <div className={`mt-4 p-3 rounded-lg ${isConcentrated ? 'bg-yellow-500/10 border border-yellow-500/20' : isDiversified ? 'bg-green-500/10 border border-green-500/20' : 'bg-slate-700/30 border border-slate-600/30'}`}>
                          <div className="flex items-start gap-2">
                            <span className="text-lg">
                              {isConcentrated ? 'âš ï¸' : isDiversified ? 'âœ…' : 'â„¹ï¸'}
                            </span>
                            <div className="flex-1">
                              <div className={`text-xs font-bold uppercase mb-1 ${isConcentrated ? 'text-yellow-400' : isDiversified ? 'text-green-400' : 'text-slate-400'}`}>
                                {isConcentrated ? 'Concentration Risk' : isDiversified ? 'Well Diversified' : 'Moderate Diversification'}
                              </div>
                              <div className="text-xs text-slate-300 leading-relaxed">
                                {isConcentrated 
                                  ? `Over ${maxWeight.toFixed(0)}% allocated to one sector. Consider diversifying to reduce risk.`
                                  : isDiversified
                                  ? `Good sector diversification with no single sector exceeding ${maxWeight.toFixed(0)}%.`
                                  : `Consider adding stocks from other sectors to improve diversification.`
                                }
                              </div>
                            </div>
                          </div>
                        </div>
                      );
                    })()}
                  </div>
                  
                  {/* Stock Holdings Table */}
                  <div>
                    <h3 className="text-sm font-bold text-slate-400 mb-3 uppercase tracking-wide">
                      Holdings Breakdown
                    </h3>
                    <div className="glass-card rounded-xl overflow-hidden">
                      <table className="w-full text-sm">
                        <thead>
                          <tr className="bg-slate-800/50 text-slate-400 text-xs">
                            <th className="text-left p-3">Symbol</th>
                            <th className="text-left p-3">Name</th>
                            <th className="text-left p-3">Sector</th>
                            <th className="text-right p-3">Weight</th>
                            <th className="text-right p-3">Price</th>
                            <th className="text-center p-3">AI Score</th>
                          </tr>
                        </thead>
                        <tbody>
                          {portfolioData.stocks
                            .sort((a, b) => b.weight - a.weight)
                            .map(stock => (
                            <tr key={stock.symbol} className="border-t border-slate-700/20 hover:bg-slate-700/20 transition">
                              <td className="p-3 font-semibold text-cyan-300">{stock.symbol}</td>
                              <td className="p-3 text-slate-300">{stock.name}</td>
                              <td className="p-3">
                                <span className="chip bg-slate-700/50 text-slate-300 text-xs">
                                  {stock.sector}
                                </span>
                              </td>
                              <td className="p-3 text-right font-mono text-white font-semibold">
                                {stock.weight.toFixed(1)}%
                              </td>
                              <td className="p-3 text-right font-mono text-white">
                                ${stock.price?.toFixed(2) || 'â€”'}
                              </td>
                              <td className="p-3 text-center">
                                <span className={`chip ${
                                  stock.aiScore >= 80 ? 'bg-green-500/20 text-green-400' :
                                  stock.aiScore >= 65 ? 'bg-cyan-500/20 text-cyan-400' :
                                  stock.aiScore >= 45 ? 'bg-yellow-500/20 text-yellow-400' :
                                  'bg-red-500/20 text-red-400'
                                }`}>
                                  {stock.aiScore || 'â€”'}
                                </span>
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              )}
            </div>
            
            {/* Footer */}
            <div className="p-6 border-t border-slate-700/30 flex justify-between items-center flex-shrink-0">
              <div className="text-xs text-slate-500">
                Equal-weight allocation assumed. Actual portfolio allocation may vary.
              </div>
              <button 
                onClick={onClose}
                className="px-6 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold transition"
              >
                Close
              </button>
            </div>
          </div>
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ALERTS MODAL COMPONENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function AlertsModal({ onClose, alerts, setAlerts, stocks }) {
      const [newAlert, setNewAlert] = useState({
        symbol: '',
        condition: 'price_above',
        value: '',
        frequency: 'once',
        email: ''
      });
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);

      const conditionOptions = [
        { value: 'price_above', label: 'Price Above' },
        { value: 'price_below', label: 'Price Below' },
        { value: 'price_change_up', label: 'Price Up %' },
        { value: 'price_change_down', label: 'Price Down %' },
        { value: 'rsi_above', label: 'RSI Above' },
        { value: 'rsi_below', label: 'RSI Below' },
        { value: 'pe_above', label: 'P/E Above' },
        { value: 'pe_below', label: 'P/E Below' },
      ];

      const frequencyOptions = [
        { value: 'once', label: 'Once' },
        { value: 'daily', label: 'Daily' },
        { value: 'weekly', label: 'Weekly' },
      ];

      const addAlert = () => {
        const { symbol, condition, value, frequency, email } = newAlert;
        
        if (!symbol || !value) {
          setError('Please fill all required fields');
          return;
        }

        const symbolUpper = symbol.toUpperCase();
        const valueNum = parseFloat(value);

        if (isNaN(valueNum)) {
          setError('Value must be a number');
          return;
        }

        // Check if email is valid for email alerts
        if (email && !/\S+@\S+\.\S+/.test(email)) {
          setError('Please enter a valid email address');
          return;
        }

        const alertObj = {
          id: Date.now().toString(),
          symbol: symbolUpper,
          condition,
          value: valueNum,
          frequency,
          email: email || null,
          created: new Date().toISOString(),
          lastTriggered: null,
          active: true
        };

        const updated = [...alerts, alertObj];
        setAlerts(updated);
        localStorage.setItem('alerts', JSON.stringify(updated));
        
        setNewAlert({
          symbol: '',
          condition: 'price_above',
          value: '',
          frequency: 'once',
          email: ''
        });
        setError(null);
      };

      const toggleAlert = (id) => {
        const updated = alerts.map(alert => 
          alert.id === id ? { ...alert, active: !alert.active } : alert
        );
        setAlerts(updated);
        localStorage.setItem('alerts', JSON.stringify(updated));
      };

      const removeAlert = (id) => {
        const updated = alerts.filter(alert => alert.id !== id);
        setAlerts(updated);
        localStorage.setItem('alerts', JSON.stringify(updated));
      };

      const testAlert = (alert) => {
        const stock = stocks.find(s => s.symbol === alert.symbol);
        if (!stock) {
          alert(`Stock ${alert.symbol} not found in current data`);
          return;
        }

        let triggered = false;
        let message = '';

        switch (alert.condition) {
          case 'price_above':
            triggered = stock.price > alert.value;
            message = `${alert.symbol} price $${stock.price.toFixed(2)} is ${triggered ? 'above' : 'below'} $${alert.value}`;
            break;
          case 'price_below':
            triggered = stock.price < alert.value;
            message = `${alert.symbol} price $${stock.price.toFixed(2)} is ${triggered ? 'below' : 'above'} $${alert.value}`;
            break;
          case 'price_change_up':
            triggered = stock.changePct > alert.value;
            message = `${alert.symbol} change ${stock.changePct.toFixed(2)}% is ${triggered ? 'above' : 'below'} ${alert.value}%`;
            break;
          case 'price_change_down':
            triggered = stock.changePct < -alert.value;
            message = `${alert.symbol} change ${stock.changePct.toFixed(2)}% is ${triggered ? 'below' : 'above'} -${alert.value}%`;
            break;
          case 'rsi_above':
            triggered = stock.rsi > alert.value;
            message = `${alert.symbol} RSI ${stock.rsi?.toFixed(0) || 'N/A'} is ${triggered ? 'above' : 'below'} ${alert.value}`;
            break;
          case 'rsi_below':
            triggered = stock.rsi < alert.value;
            message = `${alert.symbol} RSI ${stock.rsi?.toFixed(0) || 'N/A'} is ${triggered ? 'below' : 'above'} ${alert.value}`;
            break;
          case 'pe_above':
            triggered = stock.pe > alert.value;
            message = `${alert.symbol} P/E ${stock.pe?.toFixed(1) || 'N/A'} is ${triggered ? 'above' : 'below'} ${alert.value}`;
            break;
          case 'pe_below':
            triggered = stock.pe < alert.value;
            message = `${alert.symbol} P/E ${stock.pe?.toFixed(1) || 'N/A'} is ${triggered ? 'below' : 'above'} ${alert.value}`;
            break;
        }

        if (triggered) {
          alert(`âœ… Alert would trigger: ${message}`);
        } else {
          alert(`âŒ Alert would not trigger: ${message}`);
        }
      };

      const exportAlertsCSV = () => {
        const data = alerts.map(a => ({
          Symbol: a.symbol,
          Condition: conditionOptions.find(c => c.value === a.condition)?.label || a.condition,
          Value: a.value,
          Frequency: frequencyOptions.find(f => f.value === a.frequency)?.label || a.frequency,
          Email: a.email || 'No email',
          Active: a.active ? 'Yes' : 'No',
          Created: new Date(a.created).toLocaleDateString(),
          'Last Triggered': a.lastTriggered ? new Date(a.lastTriggered).toLocaleDateString() : 'Never'
        }));
        
        exportToCSV(data, 'alerts.csv');
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="glass-elevated rounded-2xl max-w-4xl w-full mx-auto my-8 animate-slide-up max-h-[90vh] overflow-hidden flex flex-col" onClick={(e) => e.stopPropagation()}>
            {/* Header */}
            <div className="flex items-start justify-between p-6 border-b border-slate-700/30 flex-shrink-0">
              <div>
                <h2 className="text-3xl font-bold text-white">Alerts & Notifications</h2>
                <div className="text-sm text-slate-400 mt-2">Set up price and metric alerts</div>
              </div>
              <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>

            {/* Add Alert Form */}
            <div className="p-6 border-b border-slate-700/30">
              <h3 className="text-lg font-bold text-white mb-4">Create New Alert</h3>
              {error && (
                <div className="mb-4 p-3 bg-red-500/10 border border-red-500/20 rounded-lg">
                  <div className="text-red-400 text-sm">{error}</div>
                </div>
              )}
              <div className="grid grid-cols-5 gap-4">
                <div>
                  <label className="text-xs text-slate-500 mb-1 block">Symbol</label>
                  <input
                    type="text"
                    value={newAlert.symbol}
                    onChange={(e) => setNewAlert({ ...newAlert, symbol: e.target.value })}
                    className="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded text-white focus:outline-none focus:border-cyan-500"
                    placeholder="AAPL"
                  />
                </div>
                <div>
                  <label className="text-xs text-slate-500 mb-1 block">Condition</label>
                  <select
                    value={newAlert.condition}
                    onChange={(e) => setNewAlert({ ...newAlert, condition: e.target.value })}
                    className="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded text-white focus:outline-none focus:border-cyan-500"
                  >
                    {conditionOptions.map(opt => (
                      <option key={opt.value} value={opt.value}>{opt.label}</option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="text-xs text-slate-500 mb-1 block">Value</label>
                  <input
                    type="number"
                    value={newAlert.value}
                    onChange={(e) => setNewAlert({ ...newAlert, value: e.target.value })}
                    className="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded text-white focus:outline-none focus:border-cyan-500"
                    placeholder="100"
                    step="0.01"
                  />
                </div>
                <div>
                  <label className="text-xs text-slate-500 mb-1 block">Frequency</label>
                  <select
                    value={newAlert.frequency}
                    onChange={(e) => setNewAlert({ ...newAlert, frequency: e.target.value })}
                    className="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded text-white focus:outline-none focus:border-cyan-500"
                  >
                    {frequencyOptions.map(opt => (
                      <option key={opt.value} value={opt.value}>{opt.label}</option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="text-xs text-slate-500 mb-1 block">Email (optional)</label>
                  <input
                    type="email"
                    value={newAlert.email}
                    onChange={(e) => setNewAlert({ ...newAlert, email: e.target.value })}
                    className="w-full px-3 py-2 bg-slate-800/50 border border-slate-700 rounded text-white focus:outline-none focus:border-cyan-500"
                    placeholder="you@example.com"
                  />
                </div>
              </div>
              <div className="mt-4">
                <button
                  onClick={addAlert}
                  className="px-6 py-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg font-semibold"
                >
                  Add Alert
                </button>
              </div>
            </div>

            {/* Alerts List */}
            <div className="p-6 overflow-y-auto flex-1">
              <div className="flex justify-between items-center mb-4">
                <h3 className="text-lg font-bold text-white">Active Alerts ({alerts.filter(a => a.active).length})</h3>
                <button
                  onClick={exportAlertsCSV}
                  className="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold text-sm flex items-center gap-2"
                >
                  <i className="fas fa-file-export"></i>
                  Export CSV
                </button>
              </div>

              {alerts.length === 0 ? (
                <div className="text-center py-12 text-slate-400">
                  <i className="fas fa-bell-slash text-4xl mb-4"></i>
                  <div>No alerts set up yet</div>
                  <div className="text-sm mt-2">Create your first alert above</div>
                </div>
              ) : (
                <div className="space-y-3">
                  {alerts.map((alert, index) => (
                    <div key={alert.id} className="glass-card p-4 rounded-xl">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-4">
                          <div className={`w-3 h-3 rounded-full ${alert.active ? 'bg-green-500' : 'bg-slate-600'}`}></div>
                          <div>
                            <div className="flex items-center gap-2">
                              <span className="font-semibold text-cyan-300">{alert.symbol}</span>
                              <span className="text-xs text-slate-500">
                                {conditionOptions.find(c => c.value === alert.condition)?.label || alert.condition}: {alert.value}
                              </span>
                            </div>
                            <div className="text-xs text-slate-500 mt-1">
                              {frequencyOptions.find(f => f.value === alert.frequency)?.label || alert.frequency} â€¢ 
                              {alert.email ? ` Email: ${alert.email}` : ' Browser notification only'} â€¢ 
                              Created: {new Date(alert.created).toLocaleDateString()}
                            </div>
                          </div>
                        </div>
                        <div className="flex gap-2">
                          <button
                            onClick={() => testAlert(alert)}
                            className="px-3 py-1 bg-slate-700 hover:bg-slate-600 text-white rounded text-xs"
                            title="Test alert with current data"
                          >
                            Test
                          </button>
                          <button
                            onClick={() => toggleAlert(alert.id)}
                            className={`px-3 py-1 rounded text-xs ${alert.active ? 'bg-yellow-600 hover:bg-yellow-500' : 'bg-green-600 hover:bg-green-500'} text-white`}
                          >
                            {alert.active ? 'Disable' : 'Enable'}
                          </button>
                          <button
                            onClick={() => removeAlert(alert.id)}
                            className="px-3 py-1 bg-red-600 hover:bg-red-500 text-white rounded text-xs"
                          >
                            Remove
                          </button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>

            {/* Footer */}
            <div className="flex justify-between items-center p-6 border-t border-slate-700/30 flex-shrink-0">
              <div className="text-xs text-slate-500">
                Note: Email alerts require a backend service. Browser alerts will work immediately.
              </div>
              <div className="flex gap-3">
                <button onClick={onClose} className="px-6 py-2.5 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold text-sm">Close</button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // COMPARATIVE ANALYSIS COMPONENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function ComparativeAnalysisModal({ onClose, stocks, selectedSymbols }) {
      const [selectedStocks, setSelectedStocks] = useState(selectedSymbols || []);
      const [comparisonData, setComparisonData] = useState([]);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);

      useEffect(() => {
        if (selectedStocks.length > 0) {
          loadComparisonData();
        }
      }, [selectedStocks]);

      const loadComparisonData = () => {
        setLoading(true);
        setError(null);
        
        try {
          const data = selectedStocks.map(symbol => {
            const stock = stocks.find(s => s.symbol === symbol);
            if (!stock) return null;
            
            return {
              symbol: stock.symbol,
              companyName: stock.companyName,
              sector: stock.sector,
              price: stock.price,
              changePct: stock.changePct,
              marketCap: stock.marketCap,
              pe: stock.pe,
              roe: stock.roe,
              revenueGrowth: stock.revenueGrowth,
              grossMargin: stock.grossMargin,
              rsi: stock.rsi,
              aiScore: stock.aiScore,
              verdict: stock.verdict,
              confidence: stock.confidence
            };
          }).filter(Boolean);
          
          setComparisonData(data);
        } catch (err) {
          setError(err.message);
        } finally {
          setLoading(false);
        }
      };

      const addStockToComparison = (symbol) => {
        if (!selectedStocks.includes(symbol) && selectedStocks.length < 5) {
          setSelectedStocks([...selectedStocks, symbol]);
        }
      };

      const removeStockFromComparison = (symbol) => {
        setSelectedStocks(selectedStocks.filter(s => s !== symbol));
      };

      const exportComparisonCSV = () => {
        const data = comparisonData.map(stock => ({
          Symbol: stock.symbol,
          Company: stock.companyName,
          Sector: stock.sector,
          Price: stock.price,
          'Change %': stock.changePct,
          'Market Cap': stock.marketCap,
          'P/E Ratio': stock.pe,
          'ROE %': stock.roe,
          'Revenue Growth %': stock.revenueGrowth,
          'Gross Margin %': stock.grossMargin,
          RSI: stock.rsi,
          'AI Score': stock.aiScore,
          Verdict: stock.verdict,
          'Confidence %': stock.confidence
        }));
        
        exportToCSV(data, 'comparison.csv');
      };

      const getBestValue = (metric, higherIsBetter = true) => {
        if (comparisonData.length === 0) return null;
        
        return comparisonData.reduce((best, current) => {
          const currentVal = current[metric];
          const bestVal = best[metric];
          
          if (currentVal == null || isNaN(currentVal)) return best;
          if (bestVal == null || isNaN(bestVal)) return current;
          
          return higherIsBetter ? 
            (currentVal > bestVal ? current : best) :
            (currentVal < bestVal ? current : best);
        });
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div id="stock-modal-content" className="glass-elevated rounded-2xl max-w-6xl w-full mx-auto my-8 animate-slide-up max-h-[90vh] overflow-hidden flex flex-col" onClick={(e) => e.stopPropagation()}>
            {/* Header */}
            <div className="flex items-start justify-between p-6 border-b border-slate-700/30 flex-shrink-0">
              <div>
                <h2 className="text-3xl font-bold text-white">Comparative Analysis</h2>
                <div className="text-sm text-slate-400 mt-2">Compare up to 5 stocks side by side</div>
              </div>
              <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>

            {/* Stock Selection */}
            <div className="p-6 border-b border-slate-700/30">
              <div className="flex justify-between items-center mb-4">
                <h3 className="text-lg font-bold text-white">Select Stocks to Compare</h3>
                <div className="text-sm text-slate-400">
                  {selectedStocks.length}/5 stocks selected
                </div>
              </div>
              
              <div className="flex flex-wrap gap-2 mb-4">
                {selectedStocks.map(symbol => (
                  <div key={symbol} className="flex items-center gap-2 px-3 py-2 bg-cyan-600/20 border border-cyan-500/30 rounded-lg">
                    <span className="text-cyan-300 font-semibold">{symbol}</span>
                    <button
                      onClick={() => removeStockFromComparison(symbol)}
                      className="text-cyan-400 hover:text-cyan-300 text-sm"
                    >
                      âœ•
                    </button>
                  </div>
                ))}
              </div>
              
              <div className="grid grid-cols-5 gap-2">
                {stocks
                  .filter(stock => !selectedStocks.includes(stock.symbol))
                  .slice(0, 15)
                  .map(stock => (
                    <button
                      key={stock.symbol}
                      onClick={() => addStockToComparison(stock.symbol)}
                      disabled={selectedStocks.length >= 5}
                      className={`px-3 py-2 rounded-lg text-sm font-semibold transition ${
                        selectedStocks.length >= 5 
                          ? 'bg-slate-800/50 text-slate-500 cursor-not-allowed' 
                          : 'bg-slate-700 hover:bg-slate-600 text-white'
                      }`}
                    >
                      {stock.symbol}
                    </button>
                  ))}
              </div>
            </div>

            {/* Comparison Results */}
            <div className="p-6 overflow-y-auto flex-1">
              {loading ? (
                <div className="text-center py-12">
                  <i className="fas fa-spinner animate-spin text-4xl text-cyan-400 mb-4"></i>
                  <div className="text-slate-400">Loading comparison data...</div>
                </div>
              ) : error ? (
                <div className="text-center py-12">
                  <div className="text-red-400 mb-4">Error: {error}</div>
                  <button
                    onClick={loadComparisonData}
                    className="px-4 py-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg"
                  >
                    Retry
                  </button>
                </div>
              ) : comparisonData.length === 0 ? (
                <div className="text-center py-12 text-slate-400">
                  <i className="fas fa-balance-scale text-4xl mb-4"></i>
                  <div>Select stocks to compare from the list above</div>
                </div>
              ) : (
                <>
                  {/* Best Values Summary */}
                  <div className="mb-6">
                    <h3 className="text-lg font-bold text-white mb-4">Best Values</h3>
                    <div className="grid grid-cols-4 gap-4">
                      <div className="glass-card p-4 rounded-xl">
                        <div className="text-xs text-slate-500 mb-1">Best Value (P/E)</div>
                        <div className="text-lg font-bold text-cyan-300">
                          {getBestValue('pe', false)?.symbol || 'â€”'}
                        </div>
                        <div className="text-sm text-slate-400">
                          {getBestValue('pe', false)?.pe?.toFixed(1) || 'â€”'} P/E
                        </div>
                      </div>
                      <div className="glass-card p-4 rounded-xl">
                        <div className="text-xs text-slate-500 mb-1">Best Quality (ROE)</div>
                        <div className="text-lg font-bold text-cyan-300">
                          {getBestValue('roe', true)?.symbol || 'â€”'}
                        </div>
                        <div className="text-sm text-slate-400">
                          {getBestValue('roe', true)?.roe?.toFixed(1) || 'â€”'}%
                        </div>
                      </div>
                      <div className="glass-card p-4 rounded-xl">
                        <div className="text-xs text-slate-500 mb-1">Best Growth</div>
                        <div className="text-lg font-bold text-cyan-300">
                          {getBestValue('revenueGrowth', true)?.symbol || 'â€”'}
                        </div>
                        <div className="text-sm text-slate-400">
                          {getBestValue('revenueGrowth', true)?.revenueGrowth?.toFixed(1) || 'â€”'}%
                        </div>
                      </div>
                      <div className="glass-card p-4 rounded-xl">
                        <div className="text-xs text-slate-500 mb-1">Best AI Score</div>
                        <div className="text-lg font-bold text-cyan-300">
                          {getBestValue('aiScore', true)?.symbol || 'â€”'}
                        </div>
                        <div className="text-sm text-slate-400">
                          {getBestValue('aiScore', true)?.aiScore || 'â€”'}/100
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Comparison Table */}
                  <div className="glass rounded-xl overflow-hidden">
                    <div className="overflow-x-auto">
                      <table className="w-full text-sm">
                        <thead>
                          <tr className="bg-slate-800/50 text-slate-400">
                            <th className="text-left p-4">Metric</th>
                            {comparisonData.map(stock => (
                              <th key={stock.symbol} className="text-center p-4">
                                <div className="font-semibold text-cyan-300">{stock.symbol}</div>
                                <div className="text-xs text-slate-500">{stock.companyName}</div>
                              </th>
                            ))}
                          </tr>
                        </thead>
                        <tbody>
                          {[
                            { label: 'Price', key: 'price', format: (v) => `$${v?.toFixed(2) || 'â€”'}` },
                            { label: 'Change %', key: 'changePct', format: (v) => formatPercent(v) },
                            { label: 'Market Cap', key: 'marketCap', format: (v) => formatNumber(v) },
                            { label: 'P/E Ratio', key: 'pe', format: (v) => v?.toFixed(1) || 'â€”' },
                            { label: 'ROE %', key: 'roe', format: (v) => v?.toFixed(1) + '%' || 'â€”' },
                            { label: 'Revenue Growth %', key: 'revenueGrowth', format: (v) => v?.toFixed(1) + '%' || 'â€”' },
                            { label: 'Gross Margin %', key: 'grossMargin', format: (v) => v?.toFixed(1) + '%' || 'â€”' },
                            { label: 'RSI', key: 'rsi', format: (v) => v?.toFixed(0) || 'â€”' },
                            { label: 'AI Score', key: 'aiScore', format: (v) => v?.toFixed(0) + '/100' || 'â€”' },
                            { label: 'Verdict', key: 'verdict', format: (v) => v || 'â€”' },
                            { label: 'Confidence %', key: 'confidence', format: (v) => v?.toFixed(0) + '%' || 'â€”' },
                          ].map((row, rowIndex) => (
                            <tr key={row.key} className="border-t border-slate-700/20">
                              <td className="p-4 text-slate-400 font-medium">{row.label}</td>
                              {comparisonData.map((stock, colIndex) => {
                                const value = stock[row.key];
                                let cellClass = 'text-center p-4 font-mono';
                                
                                // Add color coding for some metrics
                                if (row.key === 'changePct') {
                                  cellClass += ` ${getSentimentColor(value)}`;
                                } else if (row.key === 'rsi') {
                                  if (value < 30) cellClass += ' text-green-400';
                                  else if (value > 70) cellClass += ' text-red-400';
                                  else cellClass += ' text-white';
                                } else if (row.key === 'aiScore') {
                                  if (value >= 70) cellClass += ' text-green-400';
                                  else if (value >= 55) cellClass += ' text-yellow-400';
                                  else cellClass += ' text-red-400';
                                } else {
                                  cellClass += ' text-white';
                                }
                                
                                return (
                                  <td key={`${row.key}-${colIndex}`} className={cellClass}>
                                    {row.format(value)}
                                  </td>
                                );
                              })}
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                  </div>

                  {/* Sector Distribution */}
                  <div className="mt-6">
                    <h3 className="text-lg font-bold text-white mb-4">Sector Distribution</h3>
                    <div className="grid grid-cols-3 gap-4">
                      {Array.from(new Set(comparisonData.map(s => s.sector))).map(sector => {
                        const sectorStocks = comparisonData.filter(s => s.sector === sector);
                        const avgPE = sectorStocks.reduce((sum, s) => sum + (s.pe || 0), 0) / sectorStocks.length;
                        const avgROE = sectorStocks.reduce((sum, s) => sum + (s.roe || 0), 0) / sectorStocks.length;
                        
                        return (
                          <div key={sector} className="glass-card p-4 rounded-xl">
                            <div className="text-sm font-semibold text-white mb-2">{sector}</div>
                            <div className="text-xs text-slate-500 mb-1">Stocks: {sectorStocks.length}</div>
                            <div className="text-xs text-slate-400">Avg P/E: {avgPE.toFixed(1)}</div>
                            <div className="text-xs text-slate-400">Avg ROE: {avgROE.toFixed(1)}%</div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                </>
              )}
            </div>

            {/* Footer */}
            <div className="flex justify-between items-center p-6 border-t border-slate-700/30 flex-shrink-0">
              <div className="text-sm text-slate-400">
                {comparisonData.length} stocks compared
              </div>
              <div className="flex gap-3">
                <button
                  onClick={exportComparisonCSV}
                  className="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold text-sm flex items-center gap-2"
                >
                  <i className="fas fa-file-export"></i>
                  Export CSV
                </button>
                <button onClick={onClose} className="px-6 py-2.5 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold text-sm">Close</button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // AUTOMATED REBALANCING & TAX OPTIMIZATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function RebalancingDashboard({ portfolio, stocks, onClose }) {
      const [targetAllocation, setTargetAllocation] = useState({});
      const [rebalanceFrequency, setRebalanceFrequency] = useState('quarterly');
      const [rebalanceThreshold, setRebalanceThreshold] = useState(5); // %
      const [rebalancePlan, setRebalancePlan] = useState(null);
      const [taxImpact, setTaxImpact] = useState(null);
      
      // Calculate current allocation
      const currentAllocation = React.useMemo(() => {
        if (!portfolio || portfolio.length === 0) return {};
        
        const total = portfolio.reduce((sum, p) => sum + (p.shares * p.currentPrice), 0);
        const allocation = {};
        
        portfolio.forEach(p => {
          const value = p.shares * p.currentPrice;
          allocation[p.symbol] = {
            value,
            percentage: (value / total) * 100,
            shares: p.shares,
            costBasis: p.costBasis || p.currentPrice
          };
        });
        
        return allocation;
      }, [portfolio]);
      
      // Initialize target allocation based on current
      React.useEffect(() => {
        if (Object.keys(targetAllocation).length === 0 && Object.keys(currentAllocation).length > 0) {
          const initial = {};
          Object.keys(currentAllocation).forEach(symbol => {
            initial[symbol] = currentAllocation[symbol].percentage;
          });
          setTargetAllocation(initial);
        }
      }, [currentAllocation]);
      
      // Calculate rebalancing trades
      const calculateRebalancePlan = () => {
        if (!portfolio || portfolio.length === 0) return;
        
        const totalValue = portfolio.reduce((sum, p) => sum + (p.shares * p.currentPrice), 0);
        const trades = [];
        let totalTaxImpact = 0;
        
        Object.keys(targetAllocation).forEach(symbol => {
          const current = currentAllocation[symbol];
          const target = targetAllocation[symbol];
          const diff = target - current.percentage;
          
          // Only rebalance if difference exceeds threshold
          if (Math.abs(diff) > rebalanceThreshold) {
            const targetValue = (target / 100) * totalValue;
            const currentValue = current.value;
            const deltaValue = targetValue - currentValue;
            const deltaShares = deltaValue / current.costBasis;
            
            // Calculate tax impact (assuming 20% long-term capital gains)
            let taxCost = 0;
            if (deltaShares < 0) { // Selling
              const gainPerShare = current.costBasis - (current.value / current.shares);
              const totalGain = Math.abs(deltaShares) * gainPerShare;
              taxCost = totalGain * 0.20; // 20% capital gains tax
            }
            
            totalTaxImpact += taxCost;
            
            trades.push({
              symbol,
              action: deltaShares > 0 ? 'BUY' : 'SELL',
              shares: Math.abs(deltaShares),
              value: Math.abs(deltaValue),
              currentAllocation: current.percentage,
              targetAllocation: target,
              drift: diff,
              taxImpact: taxCost
            });
          }
        });
        
        setRebalancePlan(trades.sort((a, b) => Math.abs(b.drift) - Math.abs(a.drift)));
        setTaxImpact(totalTaxImpact);
      };
      
      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="glass-elevated rounded-2xl max-w-6xl w-full mx-auto my-8 animate-slide-up max-h-[90vh] overflow-hidden flex flex-col" onClick={(e) => e.stopPropagation()}>
            {/* Header */}
            <div className="flex items-center justify-between p-6 border-b border-slate-700/30 flex-shrink-0">
              <div>
                <h2 className="text-3xl font-bold text-white mb-1 flex items-center gap-2">
                  <i className="fas fa-balance-scale text-cyan-400"></i> Portfolio Rebalancing
                </h2>
                <p className="text-sm text-slate-400">Maintain your target allocation with automated rebalancing</p>
              </div>
              <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            
            {/* Content */}
            <div className="p-6 overflow-y-auto flex-1">
              {/* Settings */}
              <div className="glass-card p-6 mb-6 rounded-xl">
                <h3 className="text-lg font-bold text-white mb-4">Rebalancing Settings</h3>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="text-sm text-slate-400 mb-2 block">Rebalancing Frequency</label>
                    <select
                      value={rebalanceFrequency}
                      onChange={(e) => setRebalanceFrequency(e.target.value)}
                      className="w-full px-4 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white focus:outline-none focus:border-cyan-500"
                    >
                      <option value="monthly">Monthly</option>
                      <option value="quarterly">Quarterly (Recommended)</option>
                      <option value="semiannual">Semi-Annual</option>
                      <option value="annual">Annual</option>
                    </select>
                  </div>
                  <div>
                    <label className="text-sm text-slate-400 mb-2 block">Drift Threshold (%)</label>
                    <input
                      type="number"
                      value={rebalanceThreshold}
                      onChange={(e) => setRebalanceThreshold(Number(e.target.value))}
                      className="w-full px-4 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white focus:outline-none focus:border-cyan-500"
                      min="1"
                      max="20"
                    />
                    <p className="text-xs text-slate-500 mt-1">Only rebalance if drift exceeds this %</p>
                  </div>
                </div>
              </div>
              
              {/* Current vs Target Allocation */}
              <div className="grid grid-cols-2 gap-6 mb-6">
                <div className="glass-card p-6 rounded-xl">
                  <h3 className="text-lg font-bold text-white mb-4">Current Allocation</h3>
                  {Object.entries(currentAllocation).map(([symbol, data]) => (
                    <div key={symbol} className="mb-3">
                      <div className="flex justify-between items-center mb-1">
                        <span className="text-sm font-semibold text-white">{symbol}</span>
                        <span className="text-sm text-slate-400">{data.percentage.toFixed(1)}%</span>
                      </div>
                      <div className="w-full bg-slate-700 rounded-full h-2">
                        <div
                          className="bg-gradient-to-r from-cyan-500 to-blue-500 h-full rounded-full"
                          style={{ width: `${data.percentage}%` }}
                        ></div>
                      </div>
                    </div>
                  ))}
                </div>
                
                <div className="glass-card p-6 rounded-xl">
                  <h3 className="text-lg font-bold text-white mb-4">Target Allocation</h3>
                  {Object.entries(currentAllocation).map(([symbol, data]) => (
                    <div key={symbol} className="mb-3">
                      <div className="flex justify-between items-center mb-1">
                        <span className="text-sm font-semibold text-white">{symbol}</span>
                        <input
                          type="number"
                          value={targetAllocation[symbol] || data.percentage}
                          onChange={(e) => setTargetAllocation({
                            ...targetAllocation,
                            [symbol]: Number(e.target.value)
                          })}
                          className="w-20 px-2 py-1 bg-slate-800 border border-slate-700 rounded text-white text-sm text-right focus:outline-none focus:border-cyan-500"
                          min="0"
                          max="100"
                          step="0.1"
                        />
                      </div>
                      <div className="w-full bg-slate-700 rounded-full h-2">
                        <div
                          className="bg-gradient-to-r from-green-500 to-emerald-500 h-full rounded-full"
                          style={{ width: `${targetAllocation[symbol] || data.percentage}%` }}
                        ></div>
                      </div>
                    </div>
                  ))}
                  <div className="mt-4 pt-4 border-t border-slate-700">
                    <div className="flex justify-between text-sm">
                      <span className="text-slate-400">Total:</span>
                      <span className={`font-bold ${
                        Math.abs(Object.values(targetAllocation).reduce((sum, val) => sum + val, 0) - 100) < 0.1
                          ? 'text-green-400'
                          : 'text-red-400'
                      }`}>
                        {Object.values(targetAllocation).reduce((sum, val) => sum + val, 0).toFixed(1)}%
                      </span>
                    </div>
                  </div>
                </div>
              </div>
              
              {/* Calculate Button */}
              <div className="text-center mb-6">
                <button
                  onClick={calculateRebalancePlan}
                  className="px-8 py-3 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white rounded-xl font-semibold transition"
                >
                  <i className="fas fa-calculator mr-2"></i>
                  Calculate Rebalancing Plan
                </button>
              </div>
              
              {/* Rebalancing Plan */}
              {rebalancePlan && rebalancePlan.length > 0 && (
                <div className="glass-card p-6 rounded-xl mb-6">
                  <div className="flex items-center justify-between mb-4">
                    <h3 className="text-lg font-bold text-white">Rebalancing Trades</h3>
                    <span className="chip bg-cyan-500/20 text-cyan-400">
                      {rebalancePlan.length} trades needed
                    </span>
                  </div>
                  
                  <div className="space-y-3">
                    {rebalancePlan.map((trade, idx) => (
                      <div key={idx} className={`p-4 rounded-lg border ${
                        trade.action === 'BUY'
                          ? 'bg-green-500/10 border-green-500/30'
                          : 'bg-red-500/10 border-red-500/30'
                      }`}>
                        <div className="flex items-center justify-between">
                          <div className="flex-1">
                            <div className="flex items-center gap-3 mb-2">
                              <span className={`px-3 py-1 rounded-lg font-bold text-sm ${
                                trade.action === 'BUY'
                                  ? 'bg-green-600 text-white'
                                  : 'bg-red-600 text-white'
                              }`}>
                                {trade.action}
                              </span>
                              <span className="text-lg font-bold text-white">{trade.symbol}</span>
                              <span className="text-slate-400">
                                {trade.shares.toFixed(2)} shares
                              </span>
                            </div>
                            <div className="grid grid-cols-4 gap-4 text-sm">
                              <div>
                                <span className="text-slate-500">Value:</span>
                                <span className="text-white ml-1 font-semibold">
                                  ${trade.value.toFixed(2)}
                                </span>
                              </div>
                              <div>
                                <span className="text-slate-500">Current:</span>
                                <span className="text-white ml-1 font-semibold">
                                  {trade.currentAllocation.toFixed(1)}%
                                </span>
                              </div>
                              <div>
                                <span className="text-slate-500">Target:</span>
                                <span className="text-white ml-1 font-semibold">
                                  {trade.targetAllocation.toFixed(1)}%
                                </span>
                              </div>
                              <div>
                                <span className="text-slate-500">Tax Impact:</span>
                                <span className="text-yellow-400 ml-1 font-semibold">
                                  ${trade.taxImpact.toFixed(2)}
                                </span>
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                  
                  {/* Summary */}
                  <div className="mt-4 p-4 bg-slate-800/50 rounded-lg border border-slate-700">
                    <div className="grid grid-cols-3 gap-4 text-center">
                      <div>
                        <div className="text-xs text-slate-500 mb-1">Total Trades</div>
                        <div className="text-2xl font-bold text-white">{rebalancePlan.length}</div>
                      </div>
                      <div>
                        <div className="text-xs text-slate-500 mb-1">Est. Tax Impact</div>
                        <div className="text-2xl font-bold text-yellow-400">
                          ${taxImpact?.toFixed(2) || '0.00'}
                        </div>
                      </div>
                      <div>
                        <div className="text-xs text-slate-500 mb-1">Next Rebalance</div>
                        <div className="text-sm font-bold text-cyan-400">
                          {rebalanceFrequency === 'monthly' ? '1 month' :
                           rebalanceFrequency === 'quarterly' ? '3 months' :
                           rebalanceFrequency === 'semiannual' ? '6 months' : '12 months'}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}
              
              {rebalancePlan && rebalancePlan.length === 0 && (
                <div className="glass-card p-6 rounded-xl text-center">
                  <i className="fas fa-check-circle text-6xl text-green-400 mb-4"></i>
                  <h3 className="text-xl font-bold text-white mb-2">Portfolio Balanced</h3>
                  <p className="text-slate-400">
                    All positions are within {rebalanceThreshold}% of target allocation. No rebalancing needed.
                  </p>
                </div>
              )}
            </div>
            
            {/* Footer */}
            <div className="flex justify-between items-center p-6 border-t border-slate-700/30 flex-shrink-0">
              <div className="text-xs text-slate-500">
                <i className="fas fa-info-circle mr-1"></i>
                Tax estimates assume 20% long-term capital gains rate
              </div>
              <button onClick={onClose} className="px-6 py-2.5 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold text-sm transition">
                Close
              </button>
            </div>
          </div>
        </div>
      );
    }

    function TaxOptimizationCenter({ portfolio, onClose }) {
      const [taxYear, setTaxYear] = useState(new Date().getFullYear());
      const [taxBracket, setTaxBracket] = useState(22); // Default 22% bracket
      const [filingStatus, setFilingStatus] = useState('single');
      const [state, setState] = useState('CA');
      const [activeTab, setActiveTab] = useState('overview');
      const [harvests, setHarvests] = useState([]);
      
      // State tax rates
      const stateTaxRates = {
        'CA': { min: 1, max: 13.3, name: 'California' },
        'TX': { min: 0, max: 0, name: 'Texas (No State Tax)' },
        'NY': { min: 4, max: 8.82, name: 'New York' },
        'FL': { min: 0, max: 0, name: 'Florida (No State Tax)' },
        'IL': { min: 4.95, max: 4.95, name: 'Illinois' },
        'WA': { min: 0, max: 0, name: 'Washington (No State Tax)' }
      };
      
      // Calculate federal tax
      const calculateFederalTax = (income, status) => {
        const brackets = {
          single: [[0, 0.10], [11000, 0.12], [44725, 0.22], [95375, 0.24], [182100, 0.32], [231250, 0.35], [578125, 0.37]],
          married_joint: [[0, 0.10], [22000, 0.12], [89450, 0.22], [190750, 0.24], [364200, 0.32], [462500, 0.35], [693750, 0.37]],
          married_separate: [[0, 0.10], [11000, 0.12], [44725, 0.22], [95375, 0.24], [182100, 0.32], [231250, 0.35], [346875, 0.37]],
          head_of_household: [[0, 0.10], [15700, 0.12], [59850, 0.22], [95350, 0.24], [182100, 0.32], [231250, 0.35], [578100, 0.37]]
        };
        
        const bracket = brackets[status] || brackets.single;
        let tax = 0;
        let previousLimit = 0;
        
        for (let i = 0; i < bracket.length; i++) {
          const [limit, rate] = bracket[i];
          if (income > limit) {
            const nextLimit = i < bracket.length - 1 ? bracket[i + 1][0] : income;
            const taxableInThisBracket = Math.min(nextLimit, income) - limit;
            tax += taxableInThisBracket * rate;
          }
        }
        
        return tax;
      };
      
      // Calculate dividend income and taxes
      const dividendAnalysis = React.useMemo(() => {
        if (!portfolio || portfolio.length === 0) return null;
        
        let qualifiedDividends = 0;
        let ordinaryDividends = 0;
        
        portfolio.forEach(position => {
          const estimatedAnnualDividend = position.currentPrice * position.shares * 0.02; // Assume 2% yield
          qualifiedDividends += estimatedAnnualDividend * 0.8; // Assume 80% qualified
          ordinaryDividends += estimatedAnnualDividend * 0.2;
        });
        
        const qualifiedTax = qualifiedDividends * 0.15; // 15% for qualified
        const ordinaryTax = ordinaryDividends * (taxBracket / 100);
        
        return {
          qualifiedDividends,
          ordinaryDividends,
          totalDividends: qualifiedDividends + ordinaryDividends,
          qualifiedTax,
          ordinaryTax,
          totalTax: qualifiedTax + ordinaryTax
        };
      }, [portfolio, taxBracket]);
      
      // Calculate tax loss harvesting opportunities
      const calculateTaxHarvests = React.useMemo(() => {
        if (!portfolio || portfolio.length === 0) return [];
        
        const opportunities = [];
        
        portfolio.forEach(position => {
          const currentValue = position.shares * position.currentPrice;
          const costBasis = position.shares * (position.costBasis || position.currentPrice);
          const unrealizedGain = currentValue - costBasis;
          
          if (unrealizedGain < 0) {
            // Loss position - tax loss harvesting opportunity
            const taxSavings = Math.abs(unrealizedGain) * (taxBracket / 100);
            
            opportunities.push({
              symbol: position.symbol,
              shares: position.shares,
              currentPrice: position.currentPrice,
              costBasis: position.costBasis || position.currentPrice,
              unrealizedLoss: Math.abs(unrealizedGain),
              taxSavings,
              recommendation: 'HARVEST',
              washSaleRisk: 'medium'
            });
          }
        });
        
        return opportunities.sort((a, b) => b.taxSavings - a.taxSavings);
      }, [portfolio, taxBracket]);
      
      // Calculate capital gains summary
      const capitalGainsSummary = React.useMemo(() => {
        if (!portfolio || portfolio.length === 0) return null;
        
        let shortTermGains = 0;
        let longTermGains = 0;
        let unrealizedGains = 0;
        let unrealizedLosses = 0;
        
        portfolio.forEach(position => {
          const currentValue = position.shares * position.currentPrice;
          const costBasis = position.shares * (position.costBasis || position.currentPrice);
          const gain = currentValue - costBasis;
          
          if (gain > 0) {
            unrealizedGains += gain;
            // Assume long-term if held > 1 year (simplified)
            longTermGains += gain;
          } else {
            unrealizedLosses += Math.abs(gain);
          }
        });
        
        return {
          shortTermGains,
          longTermGains,
          unrealizedGains,
          unrealizedLosses,
          netGains: unrealizedGains - unrealizedLosses,
          estimatedTax: longTermGains * 0.20 + shortTermGains * (taxBracket / 100)
        };
      }, [portfolio, taxBracket]);
      
      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="glass-elevated rounded-2xl max-w-6xl w-full mx-auto my-8 animate-slide-up max-h-[90vh] overflow-hidden flex flex-col" onClick={(e) => e.stopPropagation()}>
            {/* Header */}
            <div className="flex items-center justify-between p-6 border-b border-slate-700/30 flex-shrink-0">
              <div>
                <h2 className="text-3xl font-bold text-white mb-1 flex items-center gap-2">
                  <i className="fas fa-file-invoice-dollar text-green-400"></i> Tax Optimization Center
                </h2>
                <p className="text-sm text-slate-400">Minimize taxes with loss harvesting and strategic planning</p>
              </div>
              <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            
            {/* Content */}
            <div className="p-6 overflow-y-auto flex-1">
              {/* Settings Row */}
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div className="glass-card p-4 rounded-xl">
                  <label className="text-xs text-slate-400 mb-2 block">Tax Year</label>
                  <select
                    value={taxYear}
                    onChange={(e) => setTaxYear(Number(e.target.value))}
                    className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white text-sm focus:outline-none focus:border-cyan-500"
                  >
                    <option value={2026}>2026</option>
                    <option value={2025}>2025</option>
                    <option value={2024}>2024</option>
                  </select>
                </div>
                <div className="glass-card p-4 rounded-xl">
                  <label className="text-xs text-slate-400 mb-2 block">Filing Status</label>
                  <select
                    value={filingStatus}
                    onChange={(e) => setFilingStatus(e.target.value)}
                    className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white text-sm focus:outline-none focus:border-cyan-500"
                  >
                    <option value="single">Single</option>
                    <option value="married_joint">Married Filing Jointly</option>
                    <option value="married_separate">Married Filing Separately</option>
                    <option value="head_of_household">Head of Household</option>
                  </select>
                </div>
                <div className="glass-card p-4 rounded-xl">
                  <label className="text-xs text-slate-400 mb-2 block">State</label>
                  <select
                    value={state}
                    onChange={(e) => setState(e.target.value)}
                    className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white text-sm focus:outline-none focus:border-cyan-500"
                  >
                    {Object.entries(stateTaxRates).map(([code, data]) => (
                      <option key={code} value={code}>{data.name}</option>
                    ))}
                  </select>
                </div>
                <div className="glass-card p-4 rounded-xl">
                  <label className="text-xs text-slate-400 mb-2 block">Federal Tax Bracket</label>
                  <select
                    value={taxBracket}
                    onChange={(e) => setTaxBracket(Number(e.target.value))}
                    className="w-full px-3 py-2 bg-slate-800 border border-slate-700 rounded-lg text-white text-sm focus:outline-none focus:border-cyan-500"
                  >
                    <option value={10}>10%</option>
                    <option value={12}>12%</option>
                    <option value={22}>22%</option>
                    <option value={24}>24%</option>
                    <option value={32}>32%</option>
                    <option value={35}>35%</option>
                    <option value={37}>37%</option>
                  </select>
                </div>
              </div>
              
              {/* Tabs */}
              <div className="flex gap-2 mb-6 overflow-x-auto pb-2">
                {['overview', 'harvesting', 'dividends', 'projections'].map(tab => (
                  <button
                    key={tab}
                    onClick={() => setActiveTab(tab)}
                    className={`px-4 py-2 rounded-lg font-semibold text-sm whitespace-nowrap transition ${
                      activeTab === tab 
                        ? 'bg-cyan-600 text-white' 
                        : 'bg-slate-800/40 text-slate-400 hover:text-white hover:bg-slate-700/40'
                    }`}
                  >
                    {tab === 'overview' && 'ğŸ“Š Overview'}
                    {tab === 'harvesting' && 'ğŸŒ¾ Tax Loss Harvesting'}
                    {tab === 'dividends' && 'ğŸ’° Dividend Tax'}
                    {tab === 'projections' && 'ğŸ“ˆ Tax Projections'}
                  </button>
                ))}
              </div>
              
              {/* Overview Tab */}
              {activeTab === 'overview' && (
                <div className="space-y-6">
                  {/* Tax Summary Cards */}
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div className="glass-card p-4 rounded-xl">
                      <div className="text-xs text-slate-500 mb-1">Federal Bracket</div>
                      <div className="text-2xl font-bold text-cyan-400">{taxBracket}%</div>
                      <div className="text-xs text-slate-400 mt-1">{filingStatus.replace('_', ' ')}</div>
                    </div>
                    <div className="glass-card p-4 rounded-xl">
                      <div className="text-xs text-slate-500 mb-1">State Tax Rate</div>
                      <div className="text-2xl font-bold text-purple-400">
                        {stateTaxRates[state].max > 0 ? `${stateTaxRates[state].max}%` : 'No Tax'}
                      </div>
                      <div className="text-xs text-slate-400 mt-1">{stateTaxRates[state].name}</div>
                    </div>
                    <div className="glass-card p-4 rounded-xl">
                      <div className="text-xs text-slate-500 mb-1">Long-Term Capital Gains</div>
                      <div className="text-2xl font-bold text-green-400">15-20%</div>
                      <div className="text-xs text-slate-400 mt-1">Held &gt;1 year</div>
                    </div>
                    <div className="glass-card p-4 rounded-xl">
                      <div className="text-xs text-slate-500 mb-1">Harvesting Opportunities</div>
                      <div className="text-2xl font-bold text-yellow-400">{calculateTaxHarvests.length}</div>
                      <div className="text-xs text-slate-400 mt-1">Loss positions</div>
                    </div>
                  </div>
                  
                  {/* Dividend Analysis */}
                  {dividendAnalysis && (
                    <div className="glass-card p-6 rounded-xl">
                      <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                        <i className="fas fa-money-bill-wave text-green-400"></i>
                        Estimated Annual Dividend Income
                      </h3>
                      <div className="grid grid-cols-3 gap-4">
                        <div className="text-center p-4 bg-green-500/10 rounded-lg border border-green-500/30">
                          <div className="text-xs text-slate-500 mb-1">Qualified Dividends</div>
                          <div className="text-xl font-bold text-green-400">
                            ${dividendAnalysis.qualifiedDividends.toFixed(2)}
                          </div>
                          <div className="text-xs text-slate-400 mt-1">Tax: ${dividendAnalysis.qualifiedTax.toFixed(2)} (15%)</div>
                        </div>
                        <div className="text-center p-4 bg-orange-500/10 rounded-lg border border-orange-500/30">
                          <div className="text-xs text-slate-500 mb-1">Ordinary Dividends</div>
                          <div className="text-xl font-bold text-orange-400">
                            ${dividendAnalysis.ordinaryDividends.toFixed(2)}
                          </div>
                          <div className="text-xs text-slate-400 mt-1">Tax: ${dividendAnalysis.ordinaryTax.toFixed(2)} ({taxBracket}%)</div>
                        </div>
                        <div className="text-center p-4 bg-cyan-500/10 rounded-lg border border-cyan-500/30">
                          <div className="text-xs text-slate-500 mb-1">Total Dividend Tax</div>
                          <div className="text-xl font-bold text-cyan-400">
                            ${dividendAnalysis.totalTax.toFixed(2)}
                          </div>
                          <div className="text-xs text-slate-400 mt-1">
                            Effective rate: {((dividendAnalysis.totalTax / dividendAnalysis.totalDividends) * 100).toFixed(1)}%
                          </div>
                        </div>
                      </div>
                      <div className="mt-4 p-3 bg-blue-500/10 border border-blue-500/30 rounded-lg text-xs text-slate-300">
                        <i className="fas fa-lightbulb text-blue-400 mr-1"></i>
                        <strong>Tax-Efficient Strategy:</strong> Hold dividend-paying stocks in tax-advantaged accounts (IRA, 401k) to defer or eliminate dividend taxes.
                      </div>
                    </div>
                  )}
                  
                  {/* Tax-Efficient Account Allocation */}
                  <div className="glass-card p-6 rounded-xl">
                    <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                      <i className="fas fa-sitemap text-purple-400"></i>
                      Tax-Efficient Account Allocation Strategy
                    </h3>
                    <div className="space-y-3">
                      <div className="p-4 bg-slate-800/50 rounded-lg border border-slate-700">
                        <div className="flex items-center gap-3 mb-2">
                          <div className="w-10 h-10 rounded-full bg-green-500/20 flex items-center justify-center">
                            <i className="fas fa-piggy-bank text-green-400"></i>
                          </div>
                          <div>
                            <div className="text-white font-bold">Tax-Deferred Accounts (IRA, 401k)</div>
                            <div className="text-xs text-slate-400">Traditional IRA, 401(k), 403(b)</div>
                          </div>
                        </div>
                        <div className="text-sm text-slate-300 ml-13">
                          <strong className="text-cyan-400">Best for:</strong> High-dividend stocks, REITs, bonds, actively traded positions. 
                          Taxes deferred until withdrawal.
                        </div>
                      </div>
                      
                      <div className="p-4 bg-slate-800/50 rounded-lg border border-slate-700">
                        <div className="flex items-center gap-3 mb-2">
                          <div className="w-10 h-10 rounded-full bg-blue-500/20 flex items-center justify-center">
                            <i className="fas fa-shield-halved text-blue-400"></i>
                          </div>
                          <div>
                            <div className="text-white font-bold">Tax-Free Accounts (Roth IRA, Roth 401k)</div>
                            <div className="text-xs text-slate-400">Roth IRA, Roth 401(k), HSA</div>
                          </div>
                        </div>
                        <div className="text-sm text-slate-300 ml-13">
                          <strong className="text-cyan-400">Best for:</strong> High-growth stocks, small-caps, investments with huge potential. 
                          Tax-free growth and withdrawals in retirement.
                        </div>
                      </div>
                      
                      <div className="p-4 bg-slate-800/50 rounded-lg border border-slate-700">
                        <div className="flex items-center gap-3 mb-2">
                          <div className="w-10 h-10 rounded-full bg-purple-500/20 flex items-center justify-center">
                            <i className="fas fa-wallet text-purple-400"></i>
                          </div>
                          <div>
                            <div className="text-white font-bold">Taxable Brokerage Accounts</div>
                            <div className="text-xs text-slate-400">Individual, Joint, Custodial</div>
                          </div>
                        </div>
                        <div className="text-sm text-slate-300 ml-13">
                          <strong className="text-cyan-400">Best for:</strong> Tax-efficient index funds, growth stocks held long-term (>1 year), 
                          municipal bonds. Benefit from lower long-term capital gains rates.
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}
              
              {/* Tax Loss Harvesting Tab */}
              {activeTab === 'harvesting' && (
                <div className="space-y-6">
                  {/* Capital Gains Summary */}
                  {capitalGainsSummary && (
                    <div className="glass-card p-6 rounded-xl">
                      <h3 className="text-lg font-bold text-white mb-4">Capital Gains Summary</h3>
                      <div className="grid grid-cols-4 gap-4">
                    <div className="text-center p-4 bg-green-500/10 rounded-lg border border-green-500/30">
                      <div className="text-xs text-slate-500 mb-1">Unrealized Gains</div>
                      <div className="text-2xl font-bold text-green-400">
                        ${capitalGainsSummary.unrealizedGains.toFixed(2)}
                      </div>
                    </div>
                    <div className="text-center p-4 bg-red-500/10 rounded-lg border border-red-500/30">
                      <div className="text-xs text-slate-500 mb-1">Unrealized Losses</div>
                      <div className="text-2xl font-bold text-red-400">
                        ${capitalGainsSummary.unrealizedLosses.toFixed(2)}
                      </div>
                    </div>
                    <div className="text-center p-4 bg-blue-500/10 rounded-lg border border-blue-500/30">
                      <div className="text-xs text-slate-500 mb-1">Net Gains</div>
                      <div className={`text-2xl font-bold ${
                        capitalGainsSummary.netGains > 0 ? 'text-green-400' : 'text-red-400'
                      }`}>
                        ${capitalGainsSummary.netGains.toFixed(2)}
                      </div>
                    </div>
                    <div className="text-center p-4 bg-yellow-500/10 rounded-lg border border-yellow-500/30">
                      <div className="text-xs text-slate-500 mb-1">Est. Tax Liability</div>
                      <div className="text-2xl font-bold text-yellow-400">
                        ${capitalGainsSummary.estimatedTax.toFixed(2)}
                      </div>
                    </div>
                  </div>
                </div>
              )}
              
              {/* Tax Loss Harvesting Opportunities */}
              <div className="glass-card p-6 rounded-xl">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-bold text-white">Tax Loss Harvesting Opportunities</h3>
                  {calculateTaxHarvests.length > 0 && (
                    <span className="chip bg-green-500/20 text-green-400">
                      {calculateTaxHarvests.length} opportunities
                    </span>
                  )}
                </div>
                
                {calculateTaxHarvests.length > 0 ? (
                  <div className="space-y-3">
                    {calculateTaxHarvests.map((harvest, idx) => (
                      <div key={idx} className="p-4 bg-slate-800/50 rounded-lg border border-slate-700">
                        <div className="flex items-center justify-between mb-3">
                          <div>
                            <span className="text-lg font-bold text-white">{harvest.symbol}</span>
                            <span className="ml-3 chip bg-red-500/20 text-red-400">
                              Loss Position
                            </span>
                          </div>
                          <div className="text-right">
                            <div className="text-sm text-slate-500">Potential Tax Savings</div>
                            <div className="text-2xl font-bold text-green-400">
                              ${harvest.taxSavings.toFixed(2)}
                            </div>
                          </div>
                        </div>
                        
                        <div className="grid grid-cols-4 gap-4 text-sm mb-3">
                          <div>
                            <span className="text-slate-500">Shares:</span>
                            <span className="text-white ml-1 font-semibold">
                              {harvest.shares.toFixed(2)}
                            </span>
                          </div>
                          <div>
                            <span className="text-slate-500">Cost Basis:</span>
                            <span className="text-white ml-1 font-semibold">
                              ${harvest.costBasis.toFixed(2)}
                            </span>
                          </div>
                          <div>
                            <span className="text-slate-500">Current Price:</span>
                            <span className="text-white ml-1 font-semibold">
                              ${harvest.currentPrice.toFixed(2)}
                            </span>
                          </div>
                          <div>
                            <span className="text-slate-500">Unrealized Loss:</span>
                            <span className="text-red-400 ml-1 font-semibold">
                              -${harvest.unrealizedLoss.toFixed(2)}
                            </span>
                          </div>
                        </div>
                        
                        <div className="flex items-center justify-between p-3 bg-yellow-500/10 border border-yellow-500/30 rounded">
                          <div className="flex items-center gap-2">
                            <i className="fas fa-exclamation-triangle text-yellow-400"></i>
                            <span className="text-sm text-slate-300">
                              Wash Sale Risk: <strong className="text-yellow-400">{harvest.washSaleRisk.toUpperCase()}</strong>
                            </span>
                          </div>
                          <button className="px-4 py-2 bg-green-600 hover:bg-green-500 text-white rounded-lg font-semibold text-sm transition">
                            Harvest Loss
                          </button>
                        </div>
                      </div>
                    ))}
                    
                    <div className="mt-4 p-4 bg-gradient-to-r from-green-900/30 to-blue-900/30 border border-green-700/50 rounded-lg">
                      <div className="flex items-center gap-2 mb-2">
                        <i className="fas fa-lightbulb text-yellow-400"></i>
                        <span className="text-sm font-bold text-white">Total Tax Savings Potential</span>
                      </div>
                      <div className="text-3xl font-bold text-green-400">
                        ${calculateTaxHarvests.reduce((sum, h) => sum + h.taxSavings, 0).toFixed(2)}
                      </div>
                      <p className="text-xs text-slate-400 mt-2">
                        By harvesting these losses, you can offset capital gains and reduce your tax liability.
                      </p>
                    </div>
                  </div>
                ) : (
                  <div className="text-center py-12">
                    <i className="fas fa-search text-6xl text-slate-700 mb-4"></i>
                    <div className="text-xl font-semibold text-white mb-2">No Harvesting Opportunities</div>
                    <div className="text-sm text-slate-400">
                      All positions are currently profitable. Check back when you have losses to harvest.
                    </div>
                  </div>
                )}
              </div>
              
              {/* Wash Sale Warning */}
              <div className="mt-6 p-4 bg-red-500/10 border border-red-500/30 rounded-lg">
                <div className="flex items-start gap-3">
                  <i className="fas fa-exclamation-circle text-red-400 text-xl mt-0.5"></i>
                  <div>
                    <div className="text-sm font-bold text-red-400 mb-1">Wash Sale Rule Warning</div>
                    <div className="text-xs text-slate-300 leading-relaxed">
                      The IRS wash sale rule prevents you from claiming a tax loss if you buy the same or substantially identical security 
                      within 30 days before or after the sale. Wait 31 days before repurchasing, or consider buying a similar (but not identical) 
                      stock to maintain market exposure.
                    </div>
                  </div>
                </div>
              </div>
                </div>
              )}
              
              {/* Dividends Tab */}
              {activeTab === 'dividends' && dividendAnalysis && (
                <div className="space-y-6">
                  <div className="glass-card p-6 rounded-xl">
                    <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                      <i className="fas fa-coins text-yellow-400"></i>
                      Dividend Income Breakdown
                    </h3>
                    <div className="grid grid-cols-2 gap-6 mb-6">
                      <div className="p-5 bg-gradient-to-br from-green-500/10 to-emerald-500/10 border border-green-500/30 rounded-xl">
                        <div className="text-sm text-slate-400 mb-2">Qualified Dividends</div>
                        <div className="text-3xl font-bold text-green-400 mb-3">
                          ${dividendAnalysis.qualifiedDividends.toFixed(2)}
                        </div>
                        <div className="space-y-2 text-sm">
                          <div className="flex justify-between">
                            <span className="text-slate-400">Tax Rate:</span>
                            <span className="text-white font-semibold">15%</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-slate-400">Estimated Tax:</span>
                            <span className="text-red-400 font-semibold">${dividendAnalysis.qualifiedTax.toFixed(2)}</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-slate-400">After-Tax Income:</span>
                            <span className="text-green-400 font-bold">
                              ${(dividendAnalysis.qualifiedDividends - dividendAnalysis.qualifiedTax).toFixed(2)}
                            </span>
                          </div>
                        </div>
                      </div>
                      
                      <div className="p-5 bg-gradient-to-br from-orange-500/10 to-red-500/10 border border-orange-500/30 rounded-xl">
                        <div className="text-sm text-slate-400 mb-2">Ordinary Dividends</div>
                        <div className="text-3xl font-bold text-orange-400 mb-3">
                          ${dividendAnalysis.ordinaryDividends.toFixed(2)}
                        </div>
                        <div className="space-y-2 text-sm">
                          <div className="flex justify-between">
                            <span className="text-slate-400">Tax Rate:</span>
                            <span className="text-white font-semibold">{taxBracket}%</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-slate-400">Estimated Tax:</span>
                            <span className="text-red-400 font-semibold">${dividendAnalysis.ordinaryTax.toFixed(2)}</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-slate-400">After-Tax Income:</span>
                            <span className="text-orange-400 font-bold">
                              ${(dividendAnalysis.ordinaryDividends - dividendAnalysis.ordinaryTax).toFixed(2)}
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <div className="p-4 bg-cyan-500/10 border border-cyan-500/30 rounded-lg">
                      <div className="flex items-center justify-between mb-2">
                        <span className="text-sm font-bold text-white">Total Annual Dividend Income</span>
                        <span className="text-2xl font-bold text-cyan-400">
                          ${dividendAnalysis.totalDividends.toFixed(2)}
                        </span>
                      </div>
                      <div className="flex items-center justify-between text-sm">
                        <span className="text-slate-400">Total Dividend Tax</span>
                        <span className="text-red-400 font-semibold">${dividendAnalysis.totalTax.toFixed(2)}</span>
                      </div>
                      <div className="flex items-center justify-between text-sm mt-1">
                        <span className="text-slate-400">After-Tax Dividend Income</span>
                        <span className="text-green-400 font-bold">
                          ${(dividendAnalysis.totalDividends - dividendAnalysis.totalTax).toFixed(2)}
                        </span>
                      </div>
                    </div>
                  </div>
                  
                  <div className="glass-card p-6 rounded-xl">
                    <h3 className="text-lg font-bold text-white mb-4">Optimization Strategies</h3>
                    <div className="space-y-3">
                      <div className="p-4 bg-slate-800/50 rounded-lg border border-slate-700">
                        <div className="flex items-start gap-3">
                          <div className="w-8 h-8 rounded-full bg-blue-500/20 flex items-center justify-center flex-shrink-0">
                            <i className="fas fa-lightbulb text-blue-400"></i>
                          </div>
                          <div>
                            <div className="text-white font-bold mb-1">Hold dividend stocks in tax-advantaged accounts</div>
                            <div className="text-sm text-slate-300">
                              Moving dividend-paying stocks to IRAs or 401(k)s can eliminate or defer dividend taxes completely.
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <div className="p-4 bg-slate-800/50 rounded-lg border border-slate-700">
                        <div className="flex items-start gap-3">
                          <div className="w-8 h-8 rounded-full bg-green-500/20 flex items-center justify-center flex-shrink-0">
                            <i className="fas fa-chart-line text-green-400"></i>
                          </div>
                          <div>
                            <div className="text-white font-bold mb-1">Focus on growth stocks in taxable accounts</div>
                            <div className="text-sm text-slate-300">
                              Growth stocks that don't pay dividends allow you to control when you realize gains (via long-term capital gains rates).
                            </div>
                          </div>
                        </div>
                      </div>
                      
                      <div className="p-4 bg-slate-800/50 rounded-lg border border-slate-700">
                        <div className="flex items-start gap-3">
                          <div className="w-8 h-8 rounded-full bg-purple-500/20 flex items-center justify-center flex-shrink-0">
                            <i className="fas fa-shield-halved text-purple-400"></i>
                          </div>
                          <div>
                            <div className="text-white font-bold mb-1">Qualified dividends are tax-advantaged</div>
                            <div className="text-sm text-slate-300">
                              Qualified dividends (held >60 days) are taxed at lower capital gains rates (0%, 15%, or 20%) vs ordinary income rates.
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}
              
              {/* Projections Tab */}
              {activeTab === 'projections' && capitalGainsSummary && (
                <div className="space-y-6">
                  <div className="glass-card p-6 rounded-xl">
                    <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2">
                      <i className="fas fa-calculator text-cyan-400"></i>
                      {taxYear} Tax Projections
                    </h3>
                    <div className="space-y-4">
                      <div className="p-4 bg-slate-800/50 rounded-lg border border-slate-700">
                        <div className="flex items-center justify-between mb-2">
                          <span className="text-slate-400">Federal Income Tax (Ordinary Income)</span>
                          <span className="text-white font-mono">{taxBracket}% bracket</span>
                        </div>
                        <div className="text-xs text-slate-500">Based on your selected tax bracket for {filingStatus.replace('_', ' ')}</div>
                      </div>
                      
                      <div className="p-4 bg-slate-800/50 rounded-lg border border-slate-700">
                        <div className="flex items-center justify-between mb-2">
                          <span className="text-slate-400">State Income Tax</span>
                          <span className="text-white font-mono">{stateTaxRates[state].max}%</span>
                        </div>
                        <div className="text-xs text-slate-500">{stateTaxRates[state].name}</div>
                      </div>
                      
                      <div className="p-4 bg-green-500/10 rounded-lg border border-green-500/30">
                        <div className="flex items-center justify-between mb-2">
                          <span className="text-slate-300">Long-Term Capital Gains Tax</span>
                          <span className="text-green-400 font-mono font-bold">15-20%</span>
                        </div>
                        <div className="text-xs text-slate-400">
                          Unrealized long-term gains: ${capitalGainsSummary.longTermGains.toFixed(2)}
                        </div>
                        <div className="text-xs text-slate-400">
                          Estimated tax if realized: ${capitalGainsSummary.estimatedTax.toFixed(2)}
                        </div>
                      </div>
                      
                      <div className="p-4 bg-yellow-500/10 rounded-lg border border-yellow-500/30">
                        <div className="flex items-center justify-between mb-2">
                          <span className="text-slate-300">Tax Savings Opportunities</span>
                          <span className="text-yellow-400 font-mono font-bold">
                            ${calculateTaxHarvests.reduce((sum, h) => sum + h.taxSavings, 0).toFixed(2)}
                          </span>
                        </div>
                        <div className="text-xs text-slate-400">
                          Available from {calculateTaxHarvests.length} tax loss harvesting opportunities
                        </div>
                      </div>
                    </div>
                  </div>
                  
                  <div className="glass-card p-6 rounded-xl">
                    <h3 className="text-lg font-bold text-white mb-4">Key Tax Planning Considerations</h3>
                    <div className="space-y-3 text-sm">
                      <div className="flex items-start gap-2">
                        <i className="fas fa-check-circle text-green-400 mt-0.5"></i>
                        <div className="text-slate-300">
                          <strong className="text-white">Harvest losses before year-end</strong> to offset gains and reduce tax liability
                        </div>
                      </div>
                      <div className="flex items-start gap-2">
                        <i className="fas fa-check-circle text-green-400 mt-0.5"></i>
                        <div className="text-slate-300">
                          <strong className="text-white">Hold investments >1 year</strong> to qualify for lower long-term capital gains rates
                        </div>
                      </div>
                      <div className="flex items-start gap-2">
                        <i className="fas fa-check-circle text-green-400 mt-0.5"></i>
                        <div className="text-slate-300">
                          <strong className="text-white">Max out tax-advantaged accounts</strong> (401k, IRA, HSA) before investing in taxable accounts
                        </div>
                      </div>
                      <div className="flex items-start gap-2">
                        <i className="fas fa-check-circle text-green-400 mt-0.5"></i>
                        <div className="text-slate-300">
                          <strong className="text-white">Consider tax-loss harvesting throughout the year</strong>, not just in December
                        </div>
                      </div>
                      <div className="flex items-start gap-2">
                        <i className="fas fa-check-circle text-green-400 mt-0.5"></i>
                        <div className="text-slate-300">
                          <strong className="text-white">Donate appreciated securities</strong> to charity for a double tax benefit (deduction + avoid capital gains)
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </div>
            
            {/* Footer */}
            <div className="flex justify-between items-center p-6 border-t border-slate-700/30 flex-shrink-0">
              <div className="text-xs text-slate-500">
                <i className="fas fa-info-circle mr-1"></i>
                Tax calculations are estimates. Consult a tax professional for personalized advice.
              </div>
              <button onClick={onClose} className="px-6 py-2.5 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold text-sm transition">
                Close
              </button>
            </div>
          </div>
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SMART ALERTS & NOTIFICATIONS SYSTEM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Alert Manager - Store and manage all alerts
    class AlertManager {
      constructor() {
        this.alerts = this.loadAlerts();
        this.subscribers = [];
      }
      
      loadAlerts() {
        const stored = localStorage.getItem('investmentAlerts');
        return stored ? JSON.parse(stored) : [];
      }
      
      saveAlerts() {
        localStorage.setItem('investmentAlerts', JSON.stringify(this.alerts));
        this.notifySubscribers();
      }
      
      addAlert(alert) {
        const newAlert = {
          id: Date.now().toString(),
          timestamp: new Date().toISOString(),
          read: false,
          ...alert
        };
        this.alerts.unshift(newAlert);
        if (this.alerts.length > 100) {
          this.alerts = this.alerts.slice(0, 100); // Keep last 100 alerts
        }
        this.saveAlerts();
        return newAlert;
      }
      
      markAsRead(alertId) {
        const alert = this.alerts.find(a => a.id === alertId);
        if (alert) {
          alert.read = true;
          this.saveAlerts();
        }
      }
      
      markAllAsRead() {
        this.alerts.forEach(a => a.read = true);
        this.saveAlerts();
      }
      
      deleteAlert(alertId) {
        this.alerts = this.alerts.filter(a => a.id !== alertId);
        this.saveAlerts();
      }
      
      clearAll() {
        this.alerts = [];
        this.saveAlerts();
      }
      
      getUnreadCount() {
        return this.alerts.filter(a => !a.read).length;
      }
      
      subscribe(callback) {
        this.subscribers.push(callback);
        return () => {
          this.subscribers = this.subscribers.filter(cb => cb !== callback);
        };
      }
      
      notifySubscribers() {
        this.subscribers.forEach(cb => cb(this.alerts));
      }
    }
    
    // Initialize global alert manager
    if (!window.alertManager) {
      window.alertManager = new AlertManager();
    }
    
    // Monitor portfolio for alerts
    const checkPortfolioAlerts = (portfolio, prevPrices = {}) => {
      if (!portfolio || portfolio.length === 0) return;
      
      portfolio.forEach(position => {
        const currentPrice = position.currentPrice;
        const prevPrice = prevPrices[position.symbol];
        
        if (prevPrice && currentPrice) {
          const changePercent = ((currentPrice - prevPrice) / prevPrice) * 100;
          
          // Alert on significant price movements (>5%)
          if (Math.abs(changePercent) >= 5) {
            window.alertManager.addAlert({
              type: 'price',
              symbol: position.symbol,
              title: `${position.symbol} ${changePercent > 0 ? 'Up' : 'Down'} ${Math.abs(changePercent).toFixed(1)}%`,
              message: `Price moved from $${prevPrice.toFixed(2)} to $${currentPrice.toFixed(2)}`,
              priority: Math.abs(changePercent) >= 10 ? 'high' : 'medium',
              data: { price: currentPrice, change: changePercent }
            });
          }
          
          // Alert on reaching profit/loss thresholds
          const costBasis = position.costBasis || position.currentPrice;
          const gainPercent = ((currentPrice - costBasis) / costBasis) * 100;
          
          if (gainPercent >= 20 && !prevPrices[`alerted_gain_${position.symbol}`]) {
            window.alertManager.addAlert({
              type: 'profit',
              symbol: position.symbol,
              title: `${position.symbol} Up 20%+ from Cost Basis`,
              message: `Consider taking profits. Current gain: ${gainPercent.toFixed(1)}%`,
              priority: 'medium',
              data: { gain: gainPercent }
            });
            prevPrices[`alerted_gain_${position.symbol}`] = true;
          }
          
          if (gainPercent <= -15 && !prevPrices[`alerted_loss_${position.symbol}`]) {
            window.alertManager.addAlert({
              type: 'loss',
              symbol: position.symbol,
              title: `${position.symbol} Down 15%+ from Cost Basis`,
              message: `Consider tax-loss harvesting or reassessing position. Current loss: ${Math.abs(gainPercent).toFixed(1)}%`,
              priority: 'high',
              data: { loss: Math.abs(gainPercent) }
            });
            prevPrices[`alerted_loss_${position.symbol}`] = true;
          }
        }
      });
    };
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // FINANCIAL CALCULATOR UTILITIES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Helper function for "What if I waited?" calculator
    async function getPriceOnDate(symbol, date) {
      try {
        const response = await fetch(
          `https://financialmodelingprep.com/stable/historical-price-full/${symbol}?from=${date}&to=${date}&apikey=${FMP_API_KEY}`
        );
        const data = await response.json();
        return data?.historical?.[0]?.close || null;
      } catch (error) {
        console.error('Error fetching historical price:', error);
        return null;
      }
    }

    // Helper function for DCA simulation
    async function getHistoricalDataForDCA(symbol, months = 12) {
      try {
        const endDate = new Date();
        const startDate = new Date();
        startDate.setMonth(startDate.getMonth() - months);
        
        const response = await fetch(
          `https://financialmodelingprep.com/stable/historical-price-full/${symbol}?from=${startDate.toISOString().split('T')[0]}&to=${endDate.toISOString().split('T')[0]}&apikey=${FMP_API_KEY}`
        );
        const data = await response.json();
        return data?.historical || [];
      } catch (error) {
        console.error('Error fetching historical data:', error);
        return [];
      }
    }

    // Savings rate calculator
    function calculateSavingsRate(income, expenses, investments = 0) {
      const savings = income - expenses;
      const totalSavings = savings + investments;
      return (totalSavings / income) * 100;
    }

    // Financial independence calculator
    function calculateFIProgress(currentAssets, annualExpenses) {
      const fiTarget = annualExpenses * 25; // 4% rule
      const progress = (currentAssets / fiTarget) * 100;
      const yearsToFI = currentAssets > 0 ? Math.log(fiTarget / currentAssets) / Math.log(1.07) : Infinity; // 7% assumed return
      
      return {
        progress: Math.min(100, Math.max(0, progress)),
        yearsToFI: Math.max(0, yearsToFI),
        fiTarget,
        monthlySavingsNeeded: yearsToFI < Infinity ? (fiTarget - currentAssets) / (yearsToFI * 12) : 0
      };
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // UX ENHANCEMENT UTILITIES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Filter persistence manager
    class FilterManager {
      constructor() {
        this.STORAGE_KEY = 'retailedge_filters';
      }

      saveFilters(filters) {
        try {
          localStorage.setItem(this.STORAGE_KEY, JSON.stringify(filters));
        } catch (e) {
          console.warn('Failed to save filters:', e);
        }
      }

      loadFilters() {
        try {
          const saved = localStorage.getItem(this.STORAGE_KEY);
          return saved ? JSON.parse(saved) : null;
        } catch (e) {
          console.warn('Failed to load filters:', e);
          return null;
        }
      }

      clearFilters() {
        localStorage.removeItem(this.STORAGE_KEY);
      }
    }
    
    // Export manager for CSV/JSON
    const ExportManager = {
      exportToCSV(stocks, filename = 'stocks.csv') {
        const headers = ['Symbol', 'Name', 'Price', 'Change%', 'P/E', 'ROE%', 'Market Cap', 'Sector'];
        const csvRows = [
          headers.join(','),
          ...stocks.map(stock => [
            stock.symbol,
            `"${stock.companyName?.replace(/"/g, '""') || stock.name || ''}"`,
            stock.price || stock.currentPrice || 0,
            stock.changePct || 0,
            stock.pe || 0,
            stock.roe || 0,
            stock.marketCap || 0,
            stock.sector || ''
          ].join(','))
        ];

        const csv = csvRows.join('\\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      },

      exportToJSON(stocks, filename = 'stocks.json') {
        const data = {
          exportDate: new Date().toISOString(),
          count: stocks.length,
          stocks: stocks
        };
        
        const json = JSON.stringify(data, null, 2);
        const blob = new Blob([json], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        a.click();
        URL.revokeObjectURL(url);
      }
    };
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SYMBOL CLEANING UTILITY
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Remove exchange suffixes from stock symbols
    function cleanSymbol(symbol) {
      if (!symbol || typeof symbol !== 'string') return symbol;
      
      // Remove common exchange suffixes
      // Examples: AAPL.O -> AAPL, MSFT.K -> MSFT, GOOGL.US -> GOOGL
      return symbol
        .toUpperCase()
        .replace(/\.(O|K|US|NS|PK|F|DE|TO|L|HK|T|SS|SZ|AX|NZ|MI|PA|AS|BR|MC|SW|CO|ST|HE|OL|LS|IC|V|WA|PR|MX|BA|SA|SN|CA|CN|JK|BK|KL|TW|KS|KQ|BO|NE)$/i, '')
        .trim();
    }
    
    // Watchlist groups manager
    class WatchlistManager {
      constructor() {
        this.STORAGE_KEY = 'retailedge_watchlist_groups';
        this.groups = this.loadGroups();
      }

      loadGroups() {
        try {
          const saved = localStorage.getItem(this.STORAGE_KEY);
          return saved ? JSON.parse(saved) : {
            'My Watchlist': [],
            'Tech Stocks': [],
            'Dividend Stocks': [],
            'Growth Stocks': []
          };
        } catch (e) {
          console.warn('Failed to load watchlist groups:', e);
          return {};
        }
      }

      saveGroups() {
        try {
          localStorage.setItem(this.STORAGE_KEY, JSON.stringify(this.groups));
        } catch (e) {
          console.warn('Failed to save watchlist groups:', e);
        }
      }

      addGroup(name, symbols = []) {
        this.groups[name] = symbols;
        this.saveGroups();
      }

      removeGroup(name) {
        delete this.groups[name];
        this.saveGroups();
      }

      addToGroup(groupName, symbol) {
        if (!this.groups[groupName]) {
          this.groups[groupName] = [];
        }
        if (!this.groups[groupName].includes(symbol)) {
          this.groups[groupName].push(symbol);
          this.saveGroups();
        }
      }

      removeFromGroup(groupName, symbol) {
        if (this.groups[groupName]) {
          this.groups[groupName] = this.groups[groupName].filter(s => s !== symbol);
          this.saveGroups();
        }
      }

      getGroupsForSymbol(symbol) {
        return Object.entries(this.groups)
          .filter(([_, symbols]) => symbols.includes(symbol))
          .map(([name]) => name);
      }

      getAllGroups() {
        return this.groups;
      }

      // Import watchlist from various formats
      importFromText(text, groupName = 'Imported Watchlist') {
        try {
          // Clean and split the text by common delimiters
          const symbols = text
            .replace(/[,;\s\n\r\t]+/g, ',') // Replace delimiters with comma
            .split(',')
            .map(s => cleanSymbol(s.trim())) // Clean exchange suffixes
            .filter(s => s && s.length > 0 && s.length <= 10 && /^[A-Z]+$/.test(s)); // Validate symbols (no dots after cleaning)
          
          if (symbols.length === 0) {
            throw new Error('No valid symbols found');
          }
          
          this.addGroup(groupName, symbols);
          return { success: true, count: symbols.length, symbols };
        } catch (error) {
          return { success: false, error: error.message };
        }
      }

      // Import from CSV file
      async importFromCSV(file, groupName = 'CSV Import') {
        try {
          const text = await file.text();
          const lines = text.split('\n');
          const symbols = [];
          
          // Try to detect symbol column
          for (const line of lines) {
            const parts = line.split(',').map(p => p.trim().replace(/"/g, ''));
            // Look for valid stock symbols (1-10 chars, letters only after cleaning)
            for (const part of parts) {
              const cleaned = cleanSymbol(part);
              if (cleaned && cleaned.length > 0 && cleaned.length <= 10 && /^[A-Z]+$/.test(cleaned)) {
                if (!symbols.includes(cleaned)) {
                  symbols.push(cleaned);
                }
              }
            }
          }
          
          if (symbols.length === 0) {
            throw new Error('No valid symbols found in CSV');
          }
          
          this.addGroup(groupName, symbols);
          return { success: true, count: symbols.length, symbols };
        } catch (error) {
          return { success: false, error: error.message };
        }
      }

      // Import from JSON file
      async importFromJSON(file, groupName = 'JSON Import') {
        try {
          const text = await file.text();
          const data = JSON.parse(text);
          
          let symbols = [];
          
          // Handle different JSON structures
          if (Array.isArray(data)) {
            // Array of symbols or objects with symbol property
            symbols = data
              .map(item => typeof item === 'string' ? item : item.symbol || item.Symbol)
              .filter(s => s)
              .map(s => cleanSymbol(s.trim()));
          } else if (data.symbols && Array.isArray(data.symbols)) {
            symbols = data.symbols.map(s => cleanSymbol(s.trim()));
          } else if (data.watchlist && Array.isArray(data.watchlist)) {
            symbols = data.watchlist.map(s => cleanSymbol(s.trim()));
          }
          
          if (symbols.length === 0) {
            throw new Error('No valid symbols found in JSON');
          }
          
          this.addGroup(groupName, symbols);
          return { success: true, count: symbols.length, symbols };
        } catch (error) {
          return { success: false, error: error.message };
        }
      }

      // Export watchlist to various formats
      exportToText(groupName) {
        const symbols = this.groups[groupName] || [];
        return symbols.join('\n');
      }

      exportToCSV(groupName) {
        const symbols = this.groups[groupName] || [];
        return 'Symbol\n' + symbols.join('\n');
      }

      exportToJSON(groupName) {
        const symbols = this.groups[groupName] || [];
        return JSON.stringify({
          name: groupName,
          exportDate: new Date().toISOString(),
          count: symbols.length,
          symbols: symbols
        }, null, 2);
      }
    }
    
    // Data quality validator
    class DataValidator {
      static validateStock(stock) {
        const warnings = [];
        
        if (!stock.symbol) warnings.push('Missing symbol');
        if (stock.price <= 0) warnings.push('Invalid price');
        if (Math.abs(stock.changePct) > 100) warnings.push('Suspicious price change');
        if (stock.pe && stock.pe > 1000) warnings.push('Extreme P/E ratio');
        if (stock.roe && Math.abs(stock.roe) > 1000) warnings.push('Extreme ROE');
        
        return {
          isValid: warnings.length === 0,
          warnings,
          score: this.calculateDataQualityScore(stock)
        };
      }

      static calculateDataQualityScore(stock) {
        let score = 0;
        const fields = [
          'symbol', 'price', 'changePct', 'marketCap', 'pe', 'roe',
          'revenueGrowth', 'grossMargin', 'debtToEquity', 'rsi'
        ];

        fields.forEach(field => {
          if (stock[field] !== undefined && stock[field] !== null) {
            score += 10;
          }
        });

        return Math.min(100, score);
      }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // KEYBOARD SHORTCUTS SYSTEM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    class KeyboardShortcuts {
      constructor() {
        this.shortcuts = new Map();
        this.enabled = true;
      }

      init() {
        document.addEventListener('keydown', this.handleKeyDown.bind(this));
        console.log('âŒ¨ï¸ Keyboard shortcuts enabled');
      }

      register(shortcut, callback, description) {
        this.shortcuts.set(shortcut, { callback, description });
      }

      handleKeyDown(e) {
        if (!this.enabled || e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
          return;
        }

        const key = e.key.toLowerCase();
        const ctrl = e.ctrlKey || e.metaKey;
        const shift = e.shiftKey;
        const alt = e.altKey;

        let shortcut = '';
        if (ctrl) shortcut += 'ctrl+';
        if (shift) shortcut += 'shift+';
        if (alt) shortcut += 'alt+';
        shortcut += key;

        const handler = this.shortcuts.get(shortcut);
        if (handler) {
          e.preventDefault();
          handler.callback();
        }
      }

      getHelp() {
        return Array.from(this.shortcuts.entries()).map(([key, { description }]) => ({ key, description }));
      }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ENHANCED TOOLTIP COMPONENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function EnhancedTooltip({ content, children, position = 'top', width = 280, delay = 300 }) {
      const [visible, setVisible] = useState(false);
      const [coords, setCoords] = useState({ x: 0, y: 0 });
      const timeoutRef = useRef(null);
      const tooltipRef = useRef(null);

      const showTooltip = (e) => {
        const rect = e.currentTarget.getBoundingClientRect();
        setCoords({
          x: rect.left + rect.width / 2,
          y: rect.top
        });
        
        clearTimeout(timeoutRef.current);
        timeoutRef.current = setTimeout(() => setVisible(true), delay);
      };

      const hideTooltip = () => {
        clearTimeout(timeoutRef.current);
        setVisible(false);
      };

      useEffect(() => {
        return () => clearTimeout(timeoutRef.current);
      }, []);

      // Position tooltip
      useEffect(() => {
        if (visible && tooltipRef.current) {
          const tooltip = tooltipRef.current;
          let left = coords.x - width / 2;
          let top = coords.y - tooltip.offsetHeight - 10;

          // Keep within viewport
          if (left < 10) left = 10;
          if (left + width > window.innerWidth - 10) {
            left = window.innerWidth - width - 10;
          }
          if (top < 10) {
            top = coords.y + 30; // Show below instead
          }

          tooltip.style.left = `${left}px`;
          tooltip.style.top = `${top}px`;
        }
      }, [visible, coords, width]);

      return React.createElement('div', {
        className: 'relative inline-block',
        onMouseEnter: showTooltip,
        onMouseLeave: hideTooltip,
        onFocus: showTooltip,
        onBlur: hideTooltip
      },
        children,
        visible && React.createElement('div', {
          ref: tooltipRef,
          className: 'fixed z-[9999] glass-card p-3 rounded-lg border border-slate-700 shadow-xl animate-fade-in',
          style: { width: `${width}px` }
        },
          React.createElement('div', {
            className: 'text-xs text-slate-200 leading-relaxed'
          }, content),
          React.createElement('div', {
            className: 'absolute bottom-0 left-1/2 transform -translate-x-1/2 translate-y-1/2 rotate-45 w-3 h-3 bg-slate-800 border-r border-b border-slate-700'
          })
        )
      );
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // DATA QUALITY INDICATOR
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function DataQualityIndicator({ stock }) {
      if (!stock || !stock.symbol) return null;
      
      const validation = DataValidator.validateStock(stock);
      const score = validation.score;
      
      const getColor = (score) => {
        if (score >= 80) return 'text-green-400 bg-green-400';
        if (score >= 60) return 'text-yellow-400 bg-yellow-400';
        return 'text-red-400 bg-red-400';
      };
      
      const colors = getColor(score);

      return (
        <div className="flex items-center gap-2">
          <div className="text-xs text-slate-500">Data Quality:</div>
          <div className={`text-xs font-bold ${colors.split(' ')[0]}`}>
            {score}%
          </div>
          <div className="w-16 bg-slate-700 rounded-full h-1.5 overflow-hidden">
            <div 
              className={`h-full ${colors.split(' ')[1]}`}
              style={{ width: `${score}%` }}
            ></div>
          </div>
        </div>
      );
    }
    
    // Initialize global managers
    if (!window.filterManager) {
      window.filterManager = new FilterManager();
    }
    if (!window.watchlistManager) {
      window.watchlistManager = new WatchlistManager();
    }
    if (!window.keyboardShortcuts) {
      window.keyboardShortcuts = new KeyboardShortcuts();
      window.keyboardShortcuts.init();
    }
    
    // Watchlist Import/Export Component
    function WatchlistImporter({ onClose, onImportSuccess }) {
      const [importMethod, setImportMethod] = useState('text'); // text, csv, json
      const [textInput, setTextInput] = useState('');
      const [groupName, setGroupName] = useState('Imported Watchlist');
      const [loading, setLoading] = useState(false);
      const [result, setResult] = useState(null);
      const fileInputRef = useRef(null);

      const handleTextImport = async () => {
        setLoading(true);
        setResult(null);
        
        const importResult = window.watchlistManager.importFromText(textInput, groupName);
        setResult(importResult);
        setLoading(false);
        
        if (importResult.success && onImportSuccess) {
          setTimeout(() => {
            onImportSuccess(importResult);
            onClose();
          }, 1500);
        }
      };

      const handleFileImport = async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        setLoading(true);
        setResult(null);

        let importResult;
        if (importMethod === 'csv') {
          importResult = await window.watchlistManager.importFromCSV(file, groupName);
        } else if (importMethod === 'json') {
          importResult = await window.watchlistManager.importFromJSON(file, groupName);
        }

        setResult(importResult);
        setLoading(false);

        if (importResult.success && onImportSuccess) {
          setTimeout(() => {
            onImportSuccess(importResult);
            onClose();
          }, 1500);
        }
      };

      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="glass-elevated rounded-2xl max-w-2xl w-full mx-auto my-8 animate-slide-up" onClick={(e) => e.stopPropagation()}>
            <div className="flex items-center justify-between p-6 border-b border-slate-700/30">
              <div>
                <h2 className="text-2xl font-bold text-white mb-1 flex items-center gap-2">
                  <i className="fas fa-file-import text-cyan-400"></i>
                  Import Watchlist
                </h2>
                <p className="text-sm text-slate-400">Add stocks from text, CSV, or JSON file</p>
              </div>
              <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>

            <div className="p-6 space-y-6">
              {/* Import Method Selection */}
              <div>
                <label className="text-sm text-slate-400 mb-2 block">Import Method</label>
                <div className="flex gap-2">
                  {[
                    { id: 'text', label: 'Paste Text', icon: 'fa-keyboard' },
                    { id: 'csv', label: 'CSV File', icon: 'fa-file-csv' },
                    { id: 'json', label: 'JSON File', icon: 'fa-file-code' }
                  ].map(method => (
                    <button
                      key={method.id}
                      onClick={() => setImportMethod(method.id)}
                      className={`flex-1 py-3 px-4 rounded-lg font-semibold text-sm transition flex items-center justify-center gap-2 ${
                        importMethod === method.id
                          ? 'bg-cyan-500/20 border-2 border-cyan-500/50 text-cyan-300'
                          : 'bg-slate-800/50 border-2 border-slate-700/50 text-slate-400 hover:bg-slate-700/50'
                      }`}
                    >
                      <i className={`fas ${method.icon}`}></i>
                      {method.label}
                    </button>
                  ))}
                </div>
              </div>

              {/* Group Name Input */}
              <div>
                <label className="text-sm text-slate-400 mb-2 block">Watchlist Group Name</label>
                <input
                  type="text"
                  value={groupName}
                  onChange={(e) => setGroupName(e.target.value)}
                  className="w-full px-4 py-2.5 bg-slate-900/50 border border-slate-700/50 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:border-cyan-500/50"
                  placeholder="Enter group name..."
                />
              </div>

              {/* Text Input Method */}
              {importMethod === 'text' && (
                <div>
                  <label className="text-sm text-slate-400 mb-2 block">
                    Paste Stock Symbols (comma, space, or newline separated)
                  </label>
                  <textarea
                    value={textInput}
                    onChange={(e) => setTextInput(e.target.value)}
                    className="w-full h-40 px-4 py-3 bg-slate-900/50 border border-slate-700/50 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:border-cyan-500/50 font-mono text-sm"
                    placeholder="AAPL, MSFT, GOOGL&#10;TSLA NVDA AMD&#10;META AMZN"
                  />
                  <div className="text-xs text-slate-500 mt-2">
                    <i className="fas fa-info-circle"></i> Supports: AAPL, MSFT GOOGL or AAPL\nMSFT\nGOOGL formats
                  </div>
                </div>
              )}

              {/* File Input Methods */}
              {(importMethod === 'csv' || importMethod === 'json') && (
                <div>
                  <label className="text-sm text-slate-400 mb-2 block">
                    Select {importMethod.toUpperCase()} File
                  </label>
                  <input
                    ref={fileInputRef}
                    type="file"
                    accept={importMethod === 'csv' ? '.csv' : '.json'}
                    onChange={handleFileImport}
                    className="hidden"
                  />
                  <button
                    onClick={() => fileInputRef.current?.click()}
                    className="w-full py-12 border-2 border-dashed border-slate-700/50 rounded-lg hover:border-cyan-500/50 hover:bg-slate-800/30 transition flex flex-col items-center justify-center gap-3 text-slate-400 hover:text-cyan-400"
                  >
                    <i className={`fas fa-cloud-upload-alt text-4xl`}></i>
                    <div className="font-semibold">Click to upload {importMethod.toUpperCase()} file</div>
                    <div className="text-xs text-slate-500">or drag and drop</div>
                  </button>
                </div>
              )}

              {/* Result Message */}
              {result && (
                <div className={`p-4 rounded-lg border ${
                  result.success
                    ? 'bg-green-500/10 border-green-500/30 text-green-400'
                    : 'bg-red-500/10 border-red-500/30 text-red-400'
                }`}>
                  <div className="flex items-center gap-2 font-semibold mb-1">
                    <i className={`fas ${result.success ? 'fa-check-circle' : 'fa-exclamation-circle'}`}></i>
                    {result.success ? 'Import Successful!' : 'Import Failed'}
                  </div>
                  <div className="text-sm">
                    {result.success
                      ? `Imported ${result.count} symbol${result.count !== 1 ? 's' : ''} to "${groupName}"`
                      : result.error}
                  </div>
                  {result.success && result.symbols && (
                    <div className="mt-2 text-xs opacity-75">
                      {result.symbols.slice(0, 10).join(', ')}
                      {result.symbols.length > 10 && ` ... +${result.symbols.length - 10} more`}
                    </div>
                  )}
                </div>
              )}
            </div>

            {/* Footer */}
            <div className="flex justify-between items-center p-6 border-t border-slate-700/30">
              <button
                onClick={onClose}
                className="px-6 py-2.5 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold text-sm transition"
              >
                Cancel
              </button>
              {importMethod === 'text' && (
                <button
                  onClick={handleTextImport}
                  disabled={loading || !textInput.trim()}
                  className={`px-6 py-2.5 rounded-lg font-semibold text-sm transition flex items-center gap-2 ${
                    loading || !textInput.trim()
                      ? 'bg-slate-700/50 text-slate-500 cursor-not-allowed'
                      : 'bg-cyan-600 hover:bg-cyan-500 text-white'
                  }`}
                >
                  {loading ? (
                    <>
                      <i className="fas fa-spinner animate-spin"></i>
                      Importing...
                    </>
                  ) : (
                    <>
                      <i className="fas fa-file-import"></i>
                      Import Watchlist
                    </>
                  )}
                </button>
              )}
            </div>
          </div>
        </div>
      );
    }
    
    // Notification Bell Component
    function NotificationBell({ onClose }) {
      const [alerts, setAlerts] = useState(window.alertManager.alerts);
      
      useEffect(() => {
        const unsubscribe = window.alertManager.subscribe(setAlerts);
        return unsubscribe;
      }, []);
      
      const unreadCount = window.alertManager.getUnreadCount();
      
      const getPriorityColor = (priority) => {
        switch(priority) {
          case 'high': return '#ef4444';
          case 'medium': return '#f59e0b';
          case 'low': return '#06b6d4';
          default: return '#64748b';
        }
      };
      
      const getAlertIcon = (type) => {
        switch(type) {
          case 'price': return 'fa-chart-line';
          case 'earnings': return 'fa-calendar-alt';
          case 'dividend': return 'fa-money-bill-wave';
          case 'news': return 'fa-newspaper';
          case 'analyst': return 'fa-user-tie';
          default: return 'fa-bell';
        }
      };
      
      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="glass-elevated rounded-2xl max-w-2xl w-full mx-auto my-8 animate-slide-up max-h-[90vh] overflow-hidden flex flex-col" onClick={(e) => e.stopPropagation()}>
            <div className="flex items-center justify-between p-6 border-b border-slate-700/30 flex-shrink-0">
              <div>
                <h2 className="text-2xl font-bold text-white mb-1 flex items-center gap-2">
                  <i className="fas fa-bell text-cyan-400"></i>
                  Notifications
                  {unreadCount > 0 && (
                    <span className="px-3 py-1 bg-red-500 text-white text-xs font-bold rounded-full">
                      {unreadCount}
                    </span>
                  )}
                </h2>
                <p className="text-sm text-slate-400">Stay updated with important portfolio alerts</p>
              </div>
              <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            
            <div className="flex items-center justify-between px-6 py-3 border-b border-slate-700/30 bg-slate-800/30">
              <div className="text-sm text-slate-400">
                {alerts.length} notification{alerts.length !== 1 ? 's' : ''}
              </div>
              <div className="flex gap-2">
                {unreadCount > 0 && (
                  <button
                    onClick={() => window.alertManager.markAllAsRead()}
                    className="px-3 py-1.5 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg text-xs font-semibold transition"
                  >
                    Mark All Read
                  </button>
                )}
                {alerts.length > 0 && (
                  <button
                    onClick={() => {
                      if (confirm('Clear all notifications?')) {
                        window.alertManager.clearAll();
                      }
                    }}
                    className="px-3 py-1.5 bg-red-600 hover:bg-red-500 text-white rounded-lg text-xs font-semibold transition"
                  >
                    Clear All
                  </button>
                )}
              </div>
            </div>
            
            <div className="overflow-y-auto flex-1 p-4">
              {alerts.length === 0 ? (
                <div className="text-center py-20">
                  <i className="far fa-bell text-6xl text-slate-700 mb-4"></i>
                  <div className="text-lg font-semibold text-white mb-2">No Notifications</div>
                  <div className="text-sm text-slate-400">You're all caught up!</div>
                </div>
              ) : (
                <div className="space-y-2">
                  {alerts.map(alert => (
                    <div
                      key={alert.id}
                      className={`p-4 rounded-lg border cursor-pointer transition ${
                        alert.read 
                          ? 'bg-slate-800/30 border-slate-700/50' 
                          : 'bg-cyan-500/10 border-cyan-500/30'
                      }`}
                      onClick={() => window.alertManager.markAsRead(alert.id)}
                    >
                      <div className="flex items-start gap-3">
                        <div 
                          className="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0"
                          style={{ background: `${getPriorityColor(alert.priority)}20` }}
                        >
                          <i 
                            className={`fas ${getAlertIcon(alert.type)}`}
                            style={{ color: getPriorityColor(alert.priority) }}
                          ></i>
                        </div>
                        <div className="flex-1 min-w-0">
                          <div className="flex items-start justify-between gap-2 mb-1">
                            <div className="text-white font-bold">{alert.title}</div>
                            {!alert.read && (
                              <div className="w-2 h-2 bg-cyan-400 rounded-full flex-shrink-0 mt-2"></div>
                            )}
                          </div>
                          <div className="text-sm text-slate-300 mb-2">{alert.message}</div>
                          <div className="flex items-center justify-between">
                            <div className="text-xs text-slate-500">
                              {new Date(alert.timestamp).toLocaleString()}
                            </div>
                            {alert.symbol && (
                              <div className="px-2 py-0.5 bg-slate-700 text-white text-xs font-bold rounded">
                                {alert.symbol}
                              </div>
                            )}
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
            
            <div className="flex justify-end items-center p-4 border-t border-slate-700/30 flex-shrink-0">
              <button onClick={onClose} className="px-6 py-2.5 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold text-sm transition">
                Close
              </button>
            </div>
          </div>
        </div>
      );
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // REAL-TIME PRICE TICKER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function LivePriceTicker({ stocks, watchlist, isConnected }) {
      const [tickerStocks, setTickerStocks] = useState([]);
      const [currentIndex, setCurrentIndex] = useState(0);
      
      useEffect(() => {
        const watchlistStocks = stocks.filter(s => watchlist.includes(s.symbol));
        setTickerStocks(watchlistStocks);
      }, [stocks, watchlist]);
      
      useEffect(() => {
        if (tickerStocks.length === 0) return;
        
        const interval = setInterval(() => {
          setCurrentIndex(prev => (prev + 1) % tickerStocks.length);
        }, 3000);
        
        return () => clearInterval(interval);
      }, [tickerStocks.length]);
      
      if (tickerStocks.length === 0) return null;
      
      const visibleStocks = tickerStocks.slice(0, 5);
      
      return (
        <div className="bg-slate-900/50 border-b border-slate-700/30 py-2 overflow-hidden">
          <div className="max-w-7xl mx-auto px-4">
            <div className="flex items-center gap-6 overflow-x-auto">
              <div className="flex items-center gap-2 flex-shrink-0">
                <div className={`w-2 h-2 rounded-full ${isConnected ? 'bg-green-500 animate-pulse' : 'bg-yellow-500'}`}></div>
                <span className="text-xs text-slate-400 font-semibold uppercase tracking-wide">
                  {isConnected ? 'Live' : 'Delayed'}
                </span>
              </div>
              
              {visibleStocks.map(stock => {
                const changePct = stock.changePct || stock.changesPercentage || 0;
                const isPositive = changePct >= 0;
                
                return (
                  <div key={stock.symbol} className="flex items-center gap-3 flex-shrink-0 animate-fade-in">
                    <span className="text-white font-bold text-sm">{stock.symbol}</span>
                    <span className="text-white text-sm">
                      ${stock.price?.toFixed(2) || 'â€”'}
                    </span>
                    <span className={`text-sm font-semibold ${isPositive ? 'text-green-400' : 'text-red-400'}`}>
                      {isPositive ? 'â–²' : 'â–¼'} {Math.abs(changePct).toFixed(2)}%
                    </span>
                  </div>
                );
              })}
              
              {tickerStocks.length > 5 && (
                <span className="text-slate-500 text-xs">
                  +{tickerStocks.length - 5} more
                </span>
              )}
            </div>
          </div>
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // SOCIAL & COMMUNITY FEATURES
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Achievement Badges System
    const BADGES = {
      first_stock: { icon: 'ğŸ¯', title: 'First Stock', description: 'Added your first stock to watchlist', type: 'milestone' },
      portfolio_starter: { icon: 'ğŸ“Š', title: 'Portfolio Starter', description: 'Created your first portfolio position', type: 'milestone' },
      diversified: { icon: 'ğŸŒˆ', title: 'Diversified', description: 'Portfolio spans 5+ sectors', type: 'milestone' },
      long_term: { icon: 'ğŸ’', title: 'Diamond Hands', description: 'Held a position for 90+ days', type: 'milestone' },
      streak_7: { icon: 'ğŸ”¥', title: '7-Day Streak', description: 'Checked the app 7 days in a row', type: 'streak' },
      streak_30: { icon: 'âš¡', title: '30-Day Streak', description: 'Checked the app 30 days in a row', type: 'streak' },
      goal_achieved: { icon: 'ğŸ†', title: 'Goal Crusher', description: 'Reached a financial goal', type: 'milestone' },
      analyst: { icon: 'ğŸ”¬', title: 'The Analyst', description: 'Analyzed 50+ stocks', type: 'milestone' },
      bull: { icon: 'ğŸ‚', title: 'Perma-Bull', description: 'Portfolio up 20%+', type: 'cosmetic' },
      bear: { icon: 'ğŸ»', title: 'Bear Survivor', description: 'Survived a 20%+ drawdown', type: 'cosmetic' }
    };
    
    function checkAndUnlockBadges(portfolio, watchlist, goals, stats) {
      const unlocked = JSON.parse(localStorage.getItem('unlockedBadges') || '[]');
      const newBadges = [];
      
      // First stock
      if (watchlist.length >= 1 && !unlocked.includes('first_stock')) {
        newBadges.push('first_stock');
      }
      
      // Portfolio starter
      if (portfolio.length >= 1 && !unlocked.includes('portfolio_starter')) {
        newBadges.push('portfolio_starter');
      }
      
      // Diversified
      if (portfolio.length >= 5 && !unlocked.includes('diversified')) {
        const sectors = new Set(portfolio.map(p => p.sector));
        if (sectors.size >= 5) newBadges.push('diversified');
      }
      
      // Goal achieved
      if (goals && goals.some(g => g.progress >= 100) && !unlocked.includes('goal_achieved')) {
        newBadges.push('goal_achieved');
      }
      
      // Analyst
      const viewedStocks = JSON.parse(localStorage.getItem('viewedStocks') || '[]');
      if (viewedStocks.length >= 50 && !unlocked.includes('analyst')) {
        newBadges.push('analyst');
      }
      
      // Save new badges
      if (newBadges.length > 0) {
        const updated = [...unlocked, ...newBadges];
        localStorage.setItem('unlockedBadges', JSON.stringify(updated));
        return newBadges;
      }
      
      return [];
    }
    
    function BadgesShowcase({ onClose }) {
      const [unlocked, setUnlocked] = useState(() => 
        JSON.parse(localStorage.getItem('unlockedBadges') || '[]')
      );
      
      const unlockedBadges = Object.entries(BADGES).filter(([id]) => unlocked.includes(id));
      const lockedBadges = Object.entries(BADGES).filter(([id]) => !unlocked.includes(id));
      
      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="glass-elevated rounded-2xl max-w-4xl w-full mx-auto my-8 animate-slide-up max-h-[90vh] overflow-hidden flex flex-col" onClick={(e) => e.stopPropagation()}>
            {/* Header */}
            <div className="flex items-center justify-between p-6 border-b border-slate-700/30 flex-shrink-0">
              <div>
                <h2 className="text-3xl font-bold text-white mb-1 flex items-center gap-2">
                  <i className="fas fa-trophy text-yellow-400"></i> Achievement Badges
                </h2>
                <p className="text-sm text-slate-400">Unlock badges by reaching milestones</p>
              </div>
              <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            
            {/* Content */}
            <div className="p-6 overflow-y-auto flex-1">
              {/* Stats */}
              <div className="glass-card p-4 mb-6 rounded-xl text-center">
                <div className="text-4xl font-bold text-cyan-400">{unlocked.length}/{Object.keys(BADGES).length}</div>
                <div className="text-sm text-slate-400 mt-1">Badges Unlocked</div>
              </div>
              
              {/* Unlocked Badges */}
              {unlockedBadges.length > 0 && (
                <div className="mb-6">
                  <h3 className="text-lg font-bold text-white mb-4">ğŸ† Unlocked</h3>
                  <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                    {unlockedBadges.map(([id, badge]) => (
                      <div key={id} className="glass-card p-4 rounded-xl text-center border-2 border-cyan-500/30">
                        <div className="text-5xl mb-2">{badge.icon}</div>
                        <div className="text-white font-bold text-sm mb-1">{badge.title}</div>
                        <div className="text-xs text-slate-400">{badge.description}</div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
              
              {/* Locked Badges */}
              {lockedBadges.length > 0 && (
                <div>
                  <h3 className="text-lg font-bold text-white mb-4">ğŸ”’ Locked</h3>
                  <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                    {lockedBadges.map(([id, badge]) => (
                      <div key={id} className="glass-card p-4 rounded-xl text-center opacity-50">
                        <div className="text-5xl mb-2 grayscale">{badge.icon}</div>
                        <div className="text-white font-bold text-sm mb-1">{badge.title}</div>
                        <div className="text-xs text-slate-400">{badge.description}</div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
            
            {/* Footer */}
            <div className="flex justify-between items-center p-6 border-t border-slate-700/30 flex-shrink-0">
              <div className="text-xs text-slate-500">
                <i className="fas fa-info-circle mr-1"></i>
                Keep using the app to unlock more badges!
              </div>
              <button onClick={onClose} className="px-6 py-2.5 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold text-sm transition">
                Close
              </button>
            </div>
          </div>
        </div>
      );
    }
    
    function SharePortfolioModal({ portfolio, onClose }) {
      const [shareLink, setShareLink] = useState(null);
      const [generating, setGenerating] = useState(false);
      
      const generateShareCard = () => {
        setGenerating(true);
        
        // Calculate portfolio composition
        const sectors = {};
        let total = 0;
        
        portfolio.forEach(position => {
          const value = position.shares * position.currentPrice;
          sectors[position.sector] = (sectors[position.sector] || 0) + value;
          total += value;
        });
        
        const sectorPercentages = {};
        Object.keys(sectors).forEach(sector => {
          sectorPercentages[sector] = ((sectors[sector] / total) * 100).toFixed(1);
        });
        
        // Generate share data
        const shareData = {
          id: Date.now().toString(36),
          portfolioValue: total,
          sectors: sectorPercentages,
          positions: portfolio.length,
          createdAt: new Date().toISOString()
        };
        
        // Save to localStorage
        const shares = JSON.parse(localStorage.getItem('sharedPortfolios') || '[]');
        shares.push(shareData);
        localStorage.setItem('sharedPortfolios', JSON.stringify(shares));
        
        const link = `${window.location.origin}?share=${shareData.id}`;
        setShareLink(link);
        setGenerating(false);
      };
      
      const copyLink = () => {
        navigator.clipboard.writeText(shareLink);
        alert('Link copied to clipboard!');
      };
      
      const shareToTwitter = () => {
        const text = `Check out my portfolio on RetailEdge Pro! ğŸ“Š ${portfolio.length} positions across ${Object.keys(sectors).length} sectors.`;
        window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(shareLink)}`, '_blank');
      };
      
      // Calculate sectors for display
      const sectors = {};
      let total = 0;
      portfolio.forEach(position => {
        const value = position.shares * position.currentPrice;
        sectors[position.sector] = (sectors[position.sector] || 0) + value;
        total += value;
      });
      
      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="glass-elevated rounded-2xl max-w-2xl w-full mx-auto my-8 animate-slide-up max-h-[90vh] overflow-hidden flex flex-col" onClick={(e) => e.stopPropagation()}>
            {/* Header */}
            <div className="flex items-center justify-between p-6 border-b border-slate-700/30 flex-shrink-0">
              <div>
                <h2 className="text-3xl font-bold text-white mb-1 flex items-center gap-2">
                  <i className="fas fa-share-nodes text-cyan-400"></i> Share Portfolio
                </h2>
                <p className="text-sm text-slate-400">Create a shareable link to your portfolio composition</p>
              </div>
              <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            
            {/* Content */}
            <div className="p-6 overflow-y-auto flex-1">
              {/* Portfolio Preview Card */}
              <div className="glass-card p-6 rounded-xl mb-6 border border-cyan-500/30">
                <h3 className="text-xl font-bold text-white mb-4 text-center">My Portfolio</h3>
                <div className="grid grid-cols-3 gap-4 mb-4">
                  <div className="text-center">
                    <div className="text-3xl font-bold text-cyan-400">{portfolio.length}</div>
                    <div className="text-xs text-slate-400">Positions</div>
                  </div>
                  <div className="text-center">
                    <div className="text-3xl font-bold text-green-400">
                      ${(total).toLocaleString(undefined, { maximumFractionDigits: 0 })}
                    </div>
                    <div className="text-xs text-slate-400">Total Value</div>
                  </div>
                  <div className="text-center">
                    <div className="text-3xl font-bold text-purple-400">{Object.keys(sectors).length}</div>
                    <div className="text-xs text-slate-400">Sectors</div>
                  </div>
                </div>
                
                {/* Sector breakdown */}
                <div className="space-y-2">
                  {Object.entries(sectors)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(([sector, value]) => {
                      const percentage = (value / total) * 100;
                      return (
                        <div key={sector}>
                          <div className="flex justify-between text-sm mb-1">
                            <span className="text-slate-300">{sector}</span>
                            <span className="text-white font-semibold">{percentage.toFixed(1)}%</span>
                          </div>
                          <div className="w-full bg-slate-700 rounded-full h-2">
                            <div 
                              className="bg-gradient-to-r from-cyan-500 to-blue-500 h-full rounded-full transition-all"
                              style={{ width: `${percentage}%` }}
                            ></div>
                          </div>
                        </div>
                      );
                    })}
                </div>
              </div>
              
              {/* Generate/Share Section */}
              {!shareLink ? (
                <button
                  onClick={generateShareCard}
                  disabled={generating}
                  className="w-full px-6 py-4 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white rounded-xl font-semibold text-lg transition disabled:opacity-50"
                >
                  {generating ? (
                    <>
                      <i className="fas fa-spinner animate-spin mr-2"></i>
                      Generating...
                    </>
                  ) : (
                    <>
                      <i className="fas fa-share mr-2"></i>
                      Generate Share Link
                    </>
                  )}
                </button>
              ) : (
                <div>
                  <div className="glass-card p-4 rounded-lg mb-4">
                    <div className="text-sm text-slate-400 mb-2">Share Link:</div>
                    <div className="flex gap-2">
                      <input
                        type="text"
                        value={shareLink}
                        readOnly
                        className="flex-1 px-3 py-2 bg-slate-800 border border-slate-700 rounded text-white text-sm"
                      />
                      <button
                        onClick={copyLink}
                        className="px-4 py-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded font-semibold text-sm transition"
                      >
                        <i className="fas fa-copy"></i>
                      </button>
                    </div>
                  </div>
                  
                  <div className="grid grid-cols-2 gap-3">
                    <button
                      onClick={shareToTwitter}
                      className="px-4 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-semibold transition"
                    >
                      <i className="fab fa-twitter mr-2"></i>
                      Share on Twitter
                    </button>
                    <button
                      onClick={() => {
                        if (navigator.share) {
                          navigator.share({
                            title: 'My Portfolio',
                            text: 'Check out my investment portfolio!',
                            url: shareLink
                          });
                        } else {
                          copyLink();
                        }
                      }}
                      className="px-4 py-3 bg-purple-600 hover:bg-purple-500 text-white rounded-lg font-semibold transition"
                    >
                      <i className="fas fa-share-nodes mr-2"></i>
                      Share
                    </button>
                  </div>
                </div>
              )}
              
              <div className="mt-4 p-3 bg-cyan-500/10 border border-cyan-500/30 rounded-lg text-xs text-slate-400">
                <i className="fas fa-shield-alt text-cyan-400 mr-1"></i>
                Your share link only shows portfolio composition (sectors & allocation). Individual holdings and values remain private.
              </div>
            </div>
            
            {/* Footer */}
            <div className="flex justify-end items-center p-6 border-t border-slate-700/30 flex-shrink-0">
              <button onClick={onClose} className="px-6 py-2.5 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold text-sm transition">
                Close
              </button>
            </div>
          </div>
        </div>
      );
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // COMMUNITY DASHBOARD & LEADERBOARD
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    function CommunityDashboard({ portfolio, watchlist, goals, onClose }) {
      const [activeTab, setActiveTab] = useState('stats');
      const [userStats, setUserStats] = useState(null);
      const [communityStats, setCommunityStats] = useState(null);
      
      useEffect(() => {
        // Calculate user stats
        const portfolioValue = portfolio.reduce((sum, p) => sum + (p.shares * p.currentPrice), 0);
        const unlockedBadges = JSON.parse(localStorage.getItem('unlockedBadges') || '[]');
        const viewedStocks = JSON.parse(localStorage.getItem('viewedStocks') || '[]');
        const sharedPortfolios = JSON.parse(localStorage.getItem('sharedPortfolios') || '[]');
        const firstUseDate = localStorage.getItem('firstUseDate') || new Date().toISOString();
        
        if (!localStorage.getItem('firstUseDate')) {
          localStorage.setItem('firstUseDate', new Date().toISOString());
        }
        
        const daysSinceStart = Math.floor((Date.now() - new Date(firstUseDate).getTime()) / (1000 * 60 * 60 * 24));
        
        setUserStats({
          portfolioValue,
          positions: portfolio.length,
          watchlistSize: watchlist.length,
          goalsSet: goals?.length || 0,
          badgesUnlocked: unlockedBadges.length,
          stocksAnalyzed: viewedStocks.length,
          portfoliosShared: sharedPortfolios.length,
          daysSinceStart,
          totalBadges: Object.keys(BADGES).length
        });
        
        // Simulate community stats
        setCommunityStats({
          totalUsers: 2847,
          portfoliosShared: 1523,
          stocksTracked: 892,
          avgPortfolioSize: 12,
          topSectors: [
            { name: 'Technology', percentage: 32 },
            { name: 'Healthcare', percentage: 18 },
            { name: 'Financial Services', percentage: 15 },
            { name: 'Consumer Cyclical', percentage: 12 },
            { name: 'Communication Services', percentage: 10 }
          ]
        });
      }, [portfolio, watchlist, goals]);
      
      if (!userStats || !communityStats) return null;
      
      // Calculate user level
      const activityScore = 
        (userStats.positions * 10) +
        (userStats.watchlistSize * 5) +
        (userStats.goalsSet * 15) +
        (userStats.badgesUnlocked * 20) +
        (userStats.stocksAnalyzed * 2) +
        (userStats.portfoliosShared * 25);
      
      const level = Math.floor(activityScore / 100) + 1;
      const nextLevelProgress = (activityScore % 100);
      
      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="glass-elevated rounded-2xl max-w-5xl w-full mx-auto my-8 animate-slide-up max-h-[90vh] overflow-hidden flex flex-col" onClick={(e) => e.stopPropagation()}>
            <div className="flex items-center justify-between p-6 border-b border-slate-700/30 flex-shrink-0">
              <div>
                <h2 className="text-3xl font-bold text-white mb-1 flex items-center gap-2">
                  <i className="fas fa-users text-purple-400"></i> Community Hub
                </h2>
                <p className="text-sm text-slate-400">Your journey and community insights</p>
              </div>
              <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            
            <div className="flex gap-2 px-6 pt-4 border-b border-slate-700/30 flex-shrink-0">
              {['stats', 'milestones', 'community'].map(tab => (
                <button key={tab} onClick={() => setActiveTab(tab)} className={`px-4 py-2 font-semibold text-sm rounded-t-lg transition ${activeTab === tab ? 'bg-cyan-600 text-white' : 'text-slate-400 hover:text-white hover:bg-slate-700/30'}`}>
                  {tab === 'stats' ? 'ğŸ“Š My Stats' : tab === 'milestones' ? 'ğŸ¯ Milestones' : 'ğŸŒ Community'}
                </button>
              ))}
            </div>
            
            <div className="p-6 overflow-y-auto flex-1">
              {activeTab === 'stats' && (
                <div className="space-y-6">
                  <div className="glass-card p-6 rounded-xl border-2 border-purple-500/30">
                    <div className="flex items-center justify-between mb-4">
                      <div>
                        <h3 className="text-2xl font-bold text-white flex items-center gap-2">
                          <span className="text-purple-400">Level {level}</span> <span className="text-slate-500">Investor</span>
                        </h3>
                        <p className="text-sm text-slate-400 mt-1">{nextLevelProgress}% to Level {level + 1}</p>
                      </div>
                      <div className="text-5xl">{level >= 10 ? 'ğŸ‘‘' : level >= 5 ? 'â­' : 'ğŸŒŸ'}</div>
                    </div>
                    <div className="w-full bg-slate-700 rounded-full h-3">
                      <div className="bg-gradient-to-r from-purple-500 to-pink-500 h-full rounded-full transition-all" style={{ width: `${nextLevelProgress}%` }}></div>
                    </div>
                  </div>
                  
                  <div className="grid grid-cols-3 gap-4">
                    {[
                      { icon: 'ğŸ’¼', value: userStats.positions, label: 'Portfolio Positions' },
                      { icon: 'ğŸ‘€', value: userStats.watchlistSize, label: 'Stocks Watching' },
                      { icon: 'ğŸ¯', value: userStats.goalsSet, label: 'Goals Set' },
                      { icon: 'ğŸ†', value: `${userStats.badgesUnlocked}/${userStats.totalBadges}`, label: 'Badges Unlocked' },
                      { icon: 'ğŸ”¬', value: userStats.stocksAnalyzed, label: 'Stocks Analyzed' },
                      { icon: 'ğŸ“¤', value: userStats.portfoliosShared, label: 'Portfolios Shared' }
                    ].map((stat, i) => (
                      <div key={i} className="glass-card p-4 rounded-xl text-center">
                        <div className="text-3xl mb-2">{stat.icon}</div>
                        <div className="text-2xl font-bold text-white">{stat.value}</div>
                        <div className="text-xs text-slate-400">{stat.label}</div>
                      </div>
                    ))}
                  </div>
                  
                  <div className="glass-card p-6 rounded-xl">
                    <h4 className="text-lg font-bold text-white mb-4">ğŸ“ˆ Your Portfolio</h4>
                    <div className="text-4xl font-bold text-green-400 mb-2">${userStats.portfolioValue.toLocaleString(undefined, { maximumFractionDigits: 0 })}</div>
                    <div className="text-sm text-slate-400">Active for {userStats.daysSinceStart} days</div>
                  </div>
                </div>
              )}
              
              {activeTab === 'milestones' && (
                <div className="space-y-4">
                  <div className="glass-card p-4 rounded-xl">
                    <h4 className="text-lg font-bold text-white mb-4">ğŸ¯ Next Milestones</h4>
                    <div className="space-y-3">
                      {[
                        { condition: userStats.positions < 5, icon: 'ğŸŒˆ', title: 'Diversified Portfolio', desc: 'Build a portfolio with 5+ positions', progress: userStats.positions, max: 5 },
                        { condition: userStats.stocksAnalyzed < 50, icon: 'ğŸ”¬', title: 'The Analyst', desc: 'Analyze 50 different stocks', progress: userStats.stocksAnalyzed, max: 50 },
                        { condition: userStats.goalsSet === 0, icon: 'ğŸ¯', title: 'Goal Setter', desc: 'Set your first financial goal', progress: userStats.goalsSet, max: 1 },
                        { condition: userStats.portfoliosShared === 0, icon: 'ğŸ“¤', title: 'Community Member', desc: 'Share your portfolio', progress: userStats.portfoliosShared, max: 1 }
                      ].filter(m => m.condition).map((milestone, i) => (
                        <div key={i} className="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg">
                          <div className="flex items-center gap-3">
                            <div className="text-2xl">{milestone.icon}</div>
                            <div>
                              <div className="text-white font-semibold">{milestone.title}</div>
                              <div className="text-xs text-slate-400">{milestone.desc}</div>
                            </div>
                          </div>
                          <div className="text-cyan-400 font-bold">{milestone.progress}/{milestone.max}</div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              )}
              
              {activeTab === 'community' && (
                <div className="space-y-6">
                  <div className="glass-card p-6 rounded-xl">
                    <h4 className="text-lg font-bold text-white mb-4">ğŸŒ RetailEdge Community</h4>
                    <div className="grid grid-cols-4 gap-4 mb-4">
                      {[
                        { value: communityStats.totalUsers.toLocaleString(), label: 'Active Users', color: 'cyan' },
                        { value: communityStats.portfoliosShared.toLocaleString(), label: 'Portfolios Shared', color: 'purple' },
                        { value: communityStats.stocksTracked, label: 'Stocks Tracked', color: 'green' },
                        { value: communityStats.avgPortfolioSize, label: 'Avg Portfolio Size', color: 'yellow' }
                      ].map((stat, i) => (
                        <div key={i} className="text-center">
                          <div className={`text-3xl font-bold text-${stat.color}-400`}>{stat.value}</div>
                          <div className="text-xs text-slate-400">{stat.label}</div>
                        </div>
                      ))}
                    </div>
                  </div>
                  
                  <div className="glass-card p-6 rounded-xl">
                    <h4 className="text-lg font-bold text-white mb-4">ğŸ“Š Popular Sectors</h4>
                    <div className="space-y-3">
                      {communityStats.topSectors.map((sector, index) => (
                        <div key={sector.name}>
                          <div className="flex justify-between text-sm mb-1">
                            <span className="text-slate-300 flex items-center gap-2">
                              <span className="text-lg">{index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : 'ğŸ“'}</span>
                              {sector.name}
                            </span>
                            <span className="text-white font-semibold">{sector.percentage}%</span>
                          </div>
                          <div className="w-full bg-slate-700 rounded-full h-2">
                            <div className={`h-full rounded-full ${index === 0 ? 'bg-gradient-to-r from-yellow-500 to-orange-500' : index === 1 ? 'bg-gradient-to-r from-gray-400 to-gray-500' : index === 2 ? 'bg-gradient-to-r from-orange-600 to-orange-700' : 'bg-gradient-to-r from-cyan-500 to-blue-500'}`} style={{ width: `${sector.percentage}%` }}></div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              )}
            </div>
            
            <div className="flex justify-end items-center p-6 border-t border-slate-700/30 flex-shrink-0">
              <button onClick={onClose} className="px-6 py-2.5 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold text-sm transition">Close</button>
            </div>
          </div>
        </div>
      );
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // INVESTOR GUARDRAILS + REBALANCING
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const DEFAULT_GUARDRAILS = {
      template: 'Balanced',
      rebalanceMode: 'drift',
      driftThresholdPct: 5,
      maxSingleStockPct: 20,
      maxSectorPct: 45,
      maxLossFromCostPct: 20,
      lastRebalanceISO: null
    };
    
    const GUARDRAIL_TEMPLATES = {
      Conservative: { Technology: 15, Healthcare: 15, Financials: 15, Consumer: 20, Industrials: 15, Energy: 5, Materials: 5, Utilities: 5, 'Real Estate': 5, Communication: 10, Other: 5 },
      Balanced: { Technology: 22, Healthcare: 15, Financials: 15, Consumer: 18, Industrials: 10, Energy: 5, Materials: 5, Utilities: 3, 'Real Estate': 3, Communication: 12, Other: 2 },
      Growth: { Technology: 32, Healthcare: 12, Financials: 10, Consumer: 18, Industrials: 8, Energy: 3, Materials: 3, Utilities: 1, 'Real Estate': 2, Communication: 10, Other: 1 }
    };
    
    function loadGuardrails() {
      try {
        const saved = localStorage.getItem('retailedge_guardrails');
        return saved ? { ...DEFAULT_GUARDRAILS, ...JSON.parse(saved) } : { ...DEFAULT_GUARDRAILS };
      } catch {
        return { ...DEFAULT_GUARDRAILS };
      }
    }
    
    function saveGuardrails(value) {
      try {
        localStorage.setItem('retailedge_guardrails', JSON.stringify(value));
      } catch (e) {
        console.warn('Could not save guardrails', e);
      }
    }
    
    function safeSectorName(sector) {
      if (!sector || typeof sector !== 'string') return 'Other';
      if (sector.toLowerCase().includes('tech')) return 'Technology';
      if (sector.toLowerCase().includes('health')) return 'Healthcare';
      if (sector.toLowerCase().includes('fin')) return 'Financials';
      if (sector.toLowerCase().includes('indust')) return 'Industrials';
      if (sector.toLowerCase().includes('util')) return 'Utilities';
      if (sector.toLowerCase().includes('material')) return 'Materials';
      if (sector.toLowerCase().includes('energy')) return 'Energy';
      if (sector.toLowerCase().includes('real estate')) return 'Real Estate';
      if (sector.toLowerCase().includes('comm')) return 'Communication';
      if (sector.toLowerCase().includes('cons')) return 'Consumer';
      return sector;
    }
    
    function computeCurrentWeightsFromHoldings(portfolio) {
      if (!portfolio || portfolio.length === 0) {
        return { stockWeights: [], sectorWeights: {}, totalValue: 0, totalCost: 0, totalGainLoss: 0, totalGainLossPercent: 0 };
      }
      
      let totalValue = 0;
      let totalCost = 0;
      
      const stockWeights = portfolio.map(h => {
        const value = (h.shares || 0) * (h.currentPrice || 0);
        const cost = (h.shares || 0) * (h.costBasis || h.currentPrice || 0);
        totalValue += value;
        totalCost += cost;
        
        return {
          symbol: h.symbol,
          name: h.companyName || h.name || h.symbol,
          sector: safeSectorName(h.sector || 'Other'),
          value: value,
          weight: 0
        };
      });
      
      stockWeights.forEach(s => {
        s.weight = totalValue > 0 ? (s.value / totalValue) * 100 : 0;
      });
      stockWeights.sort((a, b) => b.weight - a.weight);
      
      const sectorWeights = {};
      stockWeights.forEach(s => {
        sectorWeights[s.sector] = (sectorWeights[s.sector] || 0) + s.weight;
      });
      
      const totalGainLoss = totalValue - totalCost;
      const totalGainLossPercent = totalCost > 0 ? (totalGainLoss / totalCost) * 100 : 0;
      
      return { stockWeights, sectorWeights, totalValue, totalCost, totalGainLoss, totalGainLossPercent };
    }
    
    function normalizeTargetSectors(templateObj, allSectors) {
      const base = { ...templateObj };
      const target = {};
      allSectors.forEach(sec => {
        target[sec] = base[sec] ?? 0;
      });
      Object.keys(base).forEach(sec => {
        if (!(sec in target)) target[sec] = base[sec];
      });
      const sum = Object.values(target).reduce((a, b) => a + (Number.isFinite(b) ? b : 0), 0);
      const factor = sum > 0 ? (100 / sum) : 1;
      Object.keys(target).forEach(sec => { target[sec] = (target[sec] || 0) * factor; });
      return target;
    }
    
    function computeDrift(current, target) {
      const sectors = new Set([...Object.keys(current || {}), ...Object.keys(target || {})]);
      const drift = [];
      sectors.forEach(sec => {
        const c = current?.[sec] || 0;
        const t = target?.[sec] || 0;
        drift.push({ sector: sec, current: c, target: t, diff: c - t });
      });
      drift.sort((a, b) => Math.abs(b.diff) - Math.abs(a.diff));
      return drift;
    }
    
    function InvestorGuardrailsModal({ onClose, portfolio }) {
      const [settings, setSettings] = useState(loadGuardrails());
      const [refreshKey, setRefreshKey] = useState(0);
      
      const metrics = computeCurrentWeightsFromHoldings(portfolio);
      const { stockWeights, sectorWeights, totalValue, totalCost, totalGainLoss, totalGainLossPercent } = metrics;
      
      const sectorUniverse = Array.from(new Set([
        ...Object.keys(GUARDRAIL_TEMPLATES.Balanced),
        ...Object.keys(sectorWeights || {})
      ]));
      
      const templateName = settings.template in GUARDRAIL_TEMPLATES ? settings.template : 'Balanced';
      const targetWeights = normalizeTargetSectors(GUARDRAIL_TEMPLATES[templateName], sectorUniverse);
      const driftRows = computeDrift(sectorWeights, targetWeights);
      
      const breaches = [];
      
      // Concentration: single stock
      stockWeights.forEach(s => {
        if (s.weight > settings.maxSingleStockPct) {
          breaches.push({
            type: 'Concentration',
            title: `${s.symbol} is ${s.weight.toFixed(1)}% of your portfolio`,
            detail: `Your single-stock limit is ${settings.maxSingleStockPct}%. Consider diversifying new contributions away from ${s.symbol}.`
          });
        }
      });
      
      // Sector concentration
      Object.entries(sectorWeights || {}).forEach(([sec, w]) => {
        if (w > settings.maxSectorPct) {
          breaches.push({
            type: 'Sector limit',
            title: `${sec} is ${w.toFixed(1)}% of your portfolio`,
            detail: `Your sector limit is ${settings.maxSectorPct}%. Consider directing new contributions to other sectors.`
          });
        }
      });
      
      // Loss-from-cost guardrail
      const lossFromCost = totalGainLossPercent < 0 ? -totalGainLossPercent : 0;
      if (totalCost > 0 && totalGainLossPercent < 0 && lossFromCost > settings.maxLossFromCostPct) {
        breaches.push({
          type: 'Downside',
          title: `Portfolio is down ${Math.abs(totalGainLossPercent).toFixed(1)}% vs cost basis`,
          detail: `Your downside guardrail is ${settings.maxLossFromCostPct}%. Consider reducing risk or extending your time horizon.`
        });
      }
      
      // Rebalancing alert: drift
      const driftBreaches = driftRows.filter(r => Math.abs(r.diff) >= settings.driftThresholdPct && r.sector !== 'Other');
      if (settings.rebalanceMode === 'drift' && driftBreaches.length > 0) {
        breaches.push({
          type: 'Rebalancing',
          title: `Allocation drift exceeds ${settings.driftThresholdPct}%`,
          detail: `You have ${driftBreaches.length} sector(s) drifting beyond your threshold.`
        });
      }
      
      // Next best actions
      const actions = [];
      driftRows
        .filter(r => r.target > 0.1)
        .sort((a, b) => a.diff - b.diff)
        .slice(0, 3)
        .forEach(r => {
          if (r.diff < -1) {
            actions.push({
              title: `Add to underweight: ${r.sector}`,
              detail: `You're ~${Math.abs(r.diff).toFixed(1)}% under target. Direct your next contributions toward this sector.`
            });
          }
        });
      
      if (stockWeights[0] && stockWeights[0].weight > settings.maxSingleStockPct) {
        actions.push({
          title: `Diversify away from single-name risk`,
          detail: `${stockWeights[0].symbol} is your largest holding (${stockWeights[0].weight.toFixed(1)}%). Keep adding elsewhere.`
        });
      }
      
      const topSector = Object.entries(sectorWeights || {}).sort((a, b) => b[1] - a[1])[0];
      if (topSector && topSector[1] > settings.maxSectorPct) {
        actions.push({
          title: `Reduce overlapping exposure`,
          detail: `A big chunk sits in ${topSector[0]}. Consider spreading new contributions across other sectors.`
        });
      }
      
      const update = (patch) => {
        setSettings(prev => {
          const next = { ...prev, ...patch };
          saveGuardrails(next);
          return next;
        });
      };
      
      const markRebalanced = () => {
        update({ lastRebalanceISO: new Date().toISOString() });
        setRefreshKey(k => k + 1);
      };
      
      const badgeClass = (status) => {
        if (status === 'OK') return 'bg-green-500/15 text-green-400 border border-green-500/20';
        if (status === 'WARN') return 'bg-yellow-500/15 text-yellow-300 border border-yellow-500/20';
        return 'bg-red-500/15 text-red-300 border border-red-500/20';
      };
      
      const planStatus = breaches.length === 0 ? 'OK' : (breaches.length <= 2 ? 'WARN' : 'ALERT');
      
      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="glass-elevated rounded-2xl max-w-5xl w-full mx-auto my-8 animate-slide-up max-h-[90vh] overflow-hidden flex flex-col" onClick={(e) => e.stopPropagation()}>
            {/* Header */}
            <div className="flex items-center justify-between p-6 border-b border-slate-700/30 flex-shrink-0">
              <div>
                <div className="flex items-center gap-3">
                  <h2 className="text-2xl font-bold text-white mb-1">Investor Guardrails</h2>
                  <span className={`px-3 py-1 rounded-lg text-xs font-bold uppercase tracking-wide ${badgeClass(planStatus)}`}>
                    {planStatus === 'OK' ? 'On track' : planStatus === 'WARN' ? 'Needs attention' : 'Off track'}
                  </span>
                </div>
                <p className="text-sm text-slate-400">
                  Threshold-based rebalancing + risk limits. Guidance is contribution-focused (not trade signals).
                </p>
              </div>
              <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            
            <div className="p-6 overflow-y-auto flex-1 space-y-6" key={refreshKey}>
              {/* Summary */}
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div className="glass-card p-5 rounded-xl">
                  <div className="text-xs text-slate-500 mb-1">Portfolio Value</div>
                  <div className="text-2xl font-bold text-white font-mono">${totalValue.toFixed(2)}</div>
                  <div className="text-xs text-slate-500 mt-2">
                    P/L vs cost: <span className={totalGainLoss >= 0 ? 'text-green-400 font-mono' : 'text-red-400 font-mono'}>
                      {totalGainLoss >= 0 ? '+' : ''}${totalGainLoss.toFixed(2)} ({totalGainLossPercent >= 0 ? '+' : ''}{totalGainLossPercent.toFixed(2)}%)
                    </span>
                  </div>
                </div>
                <div className="glass-card p-5 rounded-xl">
                  <div className="text-xs text-slate-500 mb-1">Largest Holding</div>
                  <div className="text-2xl font-bold text-white">
                    {stockWeights[0]?.symbol || 'â€”'}
                    <span className="text-cyan-400 font-mono ml-2">{stockWeights[0] ? `${stockWeights[0].weight.toFixed(1)}%` : ''}</span>
                  </div>
                  <div className="text-xs text-slate-500 mt-2">Single-stock limit: <span className="text-white font-mono">{settings.maxSingleStockPct}%</span></div>
                </div>
                <div className="glass-card p-5 rounded-xl">
                  <div className="text-xs text-slate-500 mb-1">Rebalancing Mode</div>
                  <div className="text-2xl font-bold text-white">{settings.rebalanceMode === 'quarterly' ? 'Quarterly' : 'Drift-based'}</div>
                  <div className="text-xs text-slate-500 mt-2">
                    Drift threshold: <span className="text-white font-mono">{settings.driftThresholdPct}%</span>
                    {settings.lastRebalanceISO && (
                      <span className="ml-2">â€¢ last: <span className="text-white">{new Date(settings.lastRebalanceISO).toLocaleDateString()}</span></span>
                    )}
                  </div>
                </div>
              </div>
              
              {/* Settings */}
              <div className="glass-card p-6 rounded-xl">
                <h3 className="text-sm font-bold text-slate-400 mb-4 uppercase tracking-wide flex items-center gap-2">
                  <i className="fas fa-sliders-h text-emerald-400"></i>
                  Settings
                </h3>
                
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <label className="text-xs text-slate-400 font-semibold">Target template</label>
                    <select
                      className="mt-2 w-full bg-slate-900/60 border border-slate-700/60 rounded-lg px-3 py-2 text-white text-sm"
                      value={templateName}
                      onChange={(e) => update({ template: e.target.value })}
                    >
                      {Object.keys(GUARDRAIL_TEMPLATES).map(k => <option key={k} value={k}>{k}</option>)}
                    </select>
                    <div className="text-[11px] text-slate-500 mt-2">Templates are sector-weight heuristics for an equity-only portfolio.</div>
                  </div>
                  
                  <div>
                    <label className="text-xs text-slate-400 font-semibold">Rebalancing</label>
                    <div className="mt-2 flex gap-2">
                      <button
                        onClick={() => update({ rebalanceMode: 'drift' })}
                        className={`px-3 py-2 rounded-lg text-sm font-semibold border ${settings.rebalanceMode === 'drift' ? 'bg-emerald-600/20 text-emerald-300 border-emerald-500/30' : 'bg-slate-900/60 text-slate-300 border-slate-700/60 hover:border-slate-600'}`}
                      >
                        Drift-based
                      </button>
                      <button
                        onClick={() => update({ rebalanceMode: 'quarterly' })}
                        className={`px-3 py-2 rounded-lg text-sm font-semibold border ${settings.rebalanceMode === 'quarterly' ? 'bg-emerald-600/20 text-emerald-300 border-emerald-500/30' : 'bg-slate-900/60 text-slate-300 border-slate-700/60 hover:border-slate-600'}`}
                      >
                        Quarterly
                      </button>
                    </div>
                    
                    <div className="mt-4">
                      <div className="flex justify-between text-xs text-slate-400">
                        <span>Drift threshold</span>
                        <span className="font-mono text-white">{settings.driftThresholdPct}%</span>
                      </div>
                      <input
                        type="range"
                        className="w-full"
                        min="2"
                        max="15"
                        value={settings.driftThresholdPct}
                        onChange={(e) => update({ driftThresholdPct: parseInt(e.target.value, 10) })}
                      />
                      <div className="text-[11px] text-slate-500 mt-1">Only flag rebalancing when a sector drifts more than this.</div>
                    </div>
                  </div>
                  
                  <div>
                    <label className="text-xs text-slate-400 font-semibold">Risk limits</label>
                    
                    <div className="mt-4">
                      <div className="flex justify-between text-xs text-slate-400">
                        <span>Max single stock</span>
                        <span className="font-mono text-white">{settings.maxSingleStockPct}%</span>
                      </div>
                      <input
                        type="range"
                        className="w-full"
                        min="5"
                        max="40"
                        value={settings.maxSingleStockPct}
                        onChange={(e) => update({ maxSingleStockPct: parseInt(e.target.value, 10) })}
                      />
                    </div>
                    
                    <div className="mt-4">
                      <div className="flex justify-between text-xs text-slate-400">
                        <span>Max sector</span>
                        <span className="font-mono text-white">{settings.maxSectorPct}%</span>
                      </div>
                      <input
                        type="range"
                        className="w-full"
                        min="20"
                        max="70"
                        value={settings.maxSectorPct}
                        onChange={(e) => update({ maxSectorPct: parseInt(e.target.value, 10) })}
                      />
                    </div>
                    
                    <div className="mt-4">
                      <div className="flex justify-between text-xs text-slate-400">
                        <span>Max loss vs cost</span>
                        <span className="font-mono text-white">{settings.maxLossFromCostPct}%</span>
                      </div>
                      <input
                        type="range"
                        className="w-full"
                        min="5"
                        max="50"
                        value={settings.maxLossFromCostPct}
                        onChange={(e) => update({ maxLossFromCostPct: parseInt(e.target.value, 10) })}
                      />
                      <div className="text-[11px] text-slate-500 mt-1">
                        Simple, transparent proxy (not peak-to-trough drawdown).
                      </div>
                    </div>
                  </div>
                </div>
                
                <div className="flex justify-end mt-5 gap-3">
                  <button
                    onClick={markRebalanced}
                    className="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-semibold text-sm flex items-center gap-2"
                  >
                    <i className="fas fa-check"></i>
                    Mark rebalanced
                  </button>
                </div>
              </div>
              
              {/* Allocation drift */}
              <div className="glass-card p-6 rounded-xl">
                <h3 className="text-sm font-bold text-slate-400 mb-4 uppercase tracking-wide flex items-center gap-2">
                  <i className="fas fa-balance-scale text-cyan-400"></i>
                  Allocation drift vs target
                </h3>
                
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                  <div>
                    <div className="text-xs text-slate-500 mb-3">Sectors (current vs target)</div>
                    <div className="space-y-2">
                      {driftRows.slice(0, 10).map(r => (
                        <div key={r.sector} className="flex items-center justify-between p-3 bg-slate-900/40 rounded-lg border border-slate-800/60">
                          <div className="min-w-0">
                            <div className="font-semibold text-white truncate">{r.sector}</div>
                            <div className="text-[11px] text-slate-500">
                              Target <span className="font-mono text-slate-300">{r.target.toFixed(1)}%</span> â€¢ Current <span className="font-mono text-slate-300">{r.current.toFixed(1)}%</span>
                            </div>
                          </div>
                          <div className={`font-mono font-bold ${r.diff > 0 ? 'text-yellow-300' : 'text-emerald-300'}`}>
                            {r.diff > 0 ? '+' : ''}{r.diff.toFixed(1)}%
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                  
                  <div>
                    <div className="text-xs text-slate-500 mb-3">Largest holdings</div>
                    <div className="space-y-2">
                      {stockWeights.slice(0, 8).map(s => (
                        <div key={s.symbol} className="flex items-center justify-between p-3 bg-slate-900/40 rounded-lg border border-slate-800/60">
                          <div className="min-w-0">
                            <div className="font-semibold text-white truncate">{s.symbol}</div>
                            <div className="text-[11px] text-slate-500 truncate">{s.sector}</div>
                          </div>
                          <div className="font-mono font-bold text-cyan-300">{s.weight.toFixed(1)}%</div>
                        </div>
                      ))}
                      {stockWeights.length === 0 && (
                        <div className="text-slate-400 text-sm">Add holdings to Portfolio first.</div>
                      )}
                    </div>
                  </div>
                </div>
              </div>
              
              {/* Breaches */}
              <div className="glass-card p-6 rounded-xl">
                <h3 className="text-sm font-bold text-slate-400 mb-4 uppercase tracking-wide flex items-center gap-2">
                  <i className="fas fa-exclamation-triangle text-yellow-400"></i>
                  Alerts & guardrails
                </h3>
                
                {breaches.length === 0 ? (
                  <div className="p-4 bg-green-500/10 border border-green-500/20 rounded-lg text-green-300 font-semibold">
                    âœ… No guardrails triggered. You're within your limits.
                  </div>
                ) : (
                  <div className="space-y-3">
                    {breaches.map((b, i) => (
                      <div key={i} className="p-4 bg-slate-900/40 border border-slate-800/60 rounded-lg">
                        <div className="flex items-center justify-between">
                          <div className="font-bold text-white">{b.title}</div>
                          <span className="text-[11px] text-slate-400 uppercase tracking-wide">{b.type}</span>
                        </div>
                        <div className="text-sm text-slate-300 mt-1">{b.detail}</div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
              
              {/* Next best actions */}
              <div className="glass-card p-6 rounded-xl">
                <h3 className="text-sm font-bold text-slate-400 mb-4 uppercase tracking-wide flex items-center gap-2">
                  <i className="fas fa-list-check text-emerald-400"></i>
                  Next best actions (contribution-first)
                </h3>
                
                {actions.length === 0 ? (
                  <div className="text-slate-400 text-sm">
                    You're close to target and within limits. Keep contributing and review quarterly.
                  </div>
                ) : (
                  <div className="space-y-3">
                    {actions.slice(0, 4).map((a, i) => (
                      <div key={i} className="p-4 bg-slate-900/40 border border-slate-800/60 rounded-lg">
                        <div className="font-bold text-white">{a.title}</div>
                        <div className="text-sm text-slate-300 mt-1">{a.detail}</div>
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>
            
            {/* Footer */}
            <div className="flex justify-between items-center gap-3 p-6 border-t border-slate-700/30 flex-shrink-0">
              <div className="text-xs text-slate-500">
                <i className="fas fa-info-circle mr-1"></i>
                Guardrails are saved locally in your browser
              </div>
              <button onClick={onClose} className="px-6 py-2.5 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold text-sm transition">
                Close
              </button>
            </div>
          </div>
        </div>
      );
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ADVANCED PORTFOLIO ANALYTICS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    // Calculate portfolio beta
    const calculatePortfolioBeta = (portfolio) => {
      if (portfolio.length === 0) return 1.0;
      const totalValue = portfolio.reduce((sum, p) => sum + (p.shares * p.currentPrice), 0);
      if (totalValue === 0) return 1.0;
      
      const weightedBeta = portfolio.reduce((sum, p) => {
        const weight = (p.shares * p.currentPrice) / totalValue;
        const beta = p.beta || 1.0;
        return sum + (weight * beta);
      }, 0);
      
      return weightedBeta;
    };
    
    // Calculate portfolio volatility
    const calculatePortfolioVolatility = (portfolio) => {
      const beta = calculatePortfolioBeta(portfolio);
      return beta * 0.15; // Estimate: Market std dev of 15%
    };
    
    // Calculate Sharpe Ratio
    const calculateSharpeRatio = (portfolioReturn, volatility, riskFreeRate = 0.04) => {
      if (volatility === 0) return 0;
      return (portfolioReturn - riskFreeRate) / volatility;
    };
    
    function AdvancedPortfolioAnalytics({ portfolio, onClose }) {
      const [activeTab, setActiveTab] = useState('risk');
      
      if (!portfolio || portfolio.length === 0) {
        return (
          <div className="modal-overlay" onClick={onClose}>
            <div className="glass-elevated rounded-2xl max-w-4xl w-full mx-auto my-8 p-8" onClick={(e) => e.stopPropagation()}>
              <div className="text-center">
                <i className="fas fa-chart-line text-slate-500 text-5xl mb-4"></i>
                <h3 className="text-xl font-bold text-white mb-2">No Portfolio Data</h3>
                <p className="text-slate-400 mb-4">Add positions to your portfolio to see advanced analytics</p>
                <button onClick={onClose} className="px-6 py-2.5 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg font-semibold">Close</button>
              </div>
            </div>
          </div>
        );
      }
      
      // Calculate metrics
      const totalValue = portfolio.reduce((sum, p) => sum + (p.shares * p.currentPrice), 0);
      const totalCost = portfolio.reduce((sum, p) => sum + (p.shares * (p.costBasis || p.currentPrice)), 0);
      const portfolioReturn = totalCost > 0 ? (totalValue - totalCost) / totalCost : 0;
      const beta = calculatePortfolioBeta(portfolio);
      const volatility = calculatePortfolioVolatility(portfolio);
      const sharpeRatio = calculateSharpeRatio(portfolioReturn, volatility);
      
      // Group by sector
      const sectorAllocation = {};
      portfolio.forEach(p => {
        const sector = p.sector || 'Unknown';
        const value = p.shares * p.currentPrice;
        sectorAllocation[sector] = (sectorAllocation[sector] || 0) + value;
      });
      
      const sectors = Object.entries(sectorAllocation)
        .map(([sector, value]) => ({
          sector,
          value,
          percentage: (value / totalValue) * 100
        }))
        .sort((a, b) => b.value - a.value);
      
      // Risk levels
      const getRiskLevel = (beta) => {
        if (beta < 0.8) return { label: 'Conservative', color: '#22c55e', emoji: 'ğŸ›¡ï¸' };
        if (beta < 1.2) return { label: 'Moderate', color: '#eab308', emoji: 'âš–ï¸' };
        return { label: 'Aggressive', color: '#ef4444', emoji: 'âš¡' };
      };
      
      const riskLevel = getRiskLevel(beta);
      
      // Calculate correlation (simplified)
      const calculateCorrelation = () => {
        const correlations = [];
        for (let i = 0; i < portfolio.length; i++) {
          for (let j = i + 1; j < portfolio.length; j++) {
            const stock1 = portfolio[i];
            const stock2 = portfolio[j];
            
            // Simplified: stocks in same sector have higher correlation
            let correlation = 0.3; // Base correlation
            if (stock1.sector === stock2.sector) {
              correlation = 0.75 + (Math.random() * 0.15); // 0.75-0.9
            } else {
              correlation = 0.2 + (Math.random() * 0.3); // 0.2-0.5
            }
            
            correlations.push({
              stock1: stock1.symbol,
              stock2: stock2.symbol,
              correlation: correlation,
              color: correlation > 0.7 ? '#ef4444' : correlation > 0.4 ? '#eab308' : '#22c55e'
            });
          }
        }
        return correlations.sort((a, b) => b.correlation - a.correlation).slice(0, 5);
      };
      
      const topCorrelations = calculateCorrelation();
      
      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="glass-elevated rounded-2xl max-w-6xl w-full mx-auto my-8 animate-slide-up max-h-[90vh] overflow-hidden flex flex-col" onClick={(e) => e.stopPropagation()}>
            {/* Header */}
            <div className="flex items-center justify-between p-6 border-b border-slate-700/30 flex-shrink-0">
              <div>
                <h2 className="text-3xl font-bold text-white mb-1 flex items-center gap-2">
                  <i className="fas fa-chart-line text-cyan-400"></i> Advanced Analytics
                </h2>
                <p className="text-sm text-slate-400">Deep dive into portfolio risk and performance metrics</p>
              </div>
              <button onClick={onClose} className="text-slate-400 hover:text-white text-2xl leading-none">&times;</button>
            </div>
            
            {/* Tabs */}
            <div className="flex gap-2 px-6 pt-4 border-b border-slate-700/30 flex-shrink-0">
              {['risk', 'diversification', 'performance'].map(tab => (
                <button key={tab} onClick={() => setActiveTab(tab)} className={`px-4 py-2 font-semibold text-sm rounded-t-lg transition ${activeTab === tab ? 'bg-cyan-600 text-white' : 'text-slate-400 hover:text-white hover:bg-slate-700/30'}`}>
                  {tab === 'risk' ? 'ğŸ“Š Risk Metrics' : tab === 'diversification' ? 'ğŸ¯ Diversification' : 'ğŸ“ˆ Performance'}
                </button>
              ))}
            </div>
            
            {/* Content */}
            <div className="p-6 overflow-y-auto flex-1">
              {activeTab === 'risk' && (
                <div className="space-y-6">
                  {/* Risk Overview */}
                  <div className="glass-card p-6 rounded-xl border-2 border-purple-500/30">
                    <h3 className="text-xl font-bold text-white mb-4 flex items-center gap-2">
                      <i className="fas fa-shield-halved text-purple-400"></i>
                      Portfolio Risk Profile
                    </h3>
                    <div className="grid grid-cols-3 gap-4">
                      <div className="glass-card p-4 rounded-xl">
                        <div className="text-xs text-slate-400 mb-2">Portfolio Beta</div>
                        <div className="text-3xl font-bold mb-1" style={{ color: riskLevel.color }}>
                          {beta.toFixed(2)}
                        </div>
                        <div className="flex items-center gap-2">
                          <span className="text-2xl">{riskLevel.emoji}</span>
                          <span className="text-sm font-semibold" style={{ color: riskLevel.color }}>
                            {riskLevel.label}
                          </span>
                        </div>
                      </div>
                      
                      <div className="glass-card p-4 rounded-xl">
                        <div className="text-xs text-slate-400 mb-2">Volatility</div>
                        <div className="text-3xl font-bold text-white mb-1">
                          {(volatility * 100).toFixed(1)}%
                        </div>
                        <div className="text-xs text-slate-500">Annual Std Deviation</div>
                      </div>
                      
                      <div className="glass-card p-4 rounded-xl">
                        <div className="text-xs text-slate-400 mb-2">Sharpe Ratio</div>
                        <div className="text-3xl font-bold text-cyan-400 mb-1">
                          {sharpeRatio.toFixed(2)}
                        </div>
                        <div className="text-xs text-slate-500">Risk-Adjusted Returns</div>
                      </div>
                    </div>
                  </div>
                  
                  {/* Risk Explanation */}
                  <div className="space-y-3">
                    <div className="glass-card p-4 rounded-xl">
                      <div className="flex items-start gap-3">
                        <div className="text-2xl">ğŸ’¡</div>
                        <div>
                          <div className="text-white font-semibold mb-1">What does Beta mean?</div>
                          <div className="text-sm text-slate-400">
                            {beta < 0.8 && 'Your portfolio is less volatile than the market. If the market drops 10%, your portfolio typically drops less than 8%.'}
                            {beta >= 0.8 && beta < 1.2 && 'Your portfolio moves roughly in line with the market. If the market moves 10%, your portfolio typically moves around 10%.'}
                            {beta >= 1.2 && 'Your portfolio is more volatile than the market. If the market moves 10%, your portfolio typically moves more than 12%.'}
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <div className="glass-card p-4 rounded-xl">
                      <div className="flex items-start gap-3">
                        <div className="text-2xl">ğŸ“‰</div>
                        <div>
                          <div className="text-white font-semibold mb-1">Expected Range</div>
                          <div className="text-sm text-slate-400">
                            In a typical year, your portfolio return will likely be between{' '}
                            <strong className="text-red-400">{((portfolioReturn - volatility) * 100).toFixed(1)}%</strong> and{' '}
                            <strong className="text-green-400">+{((portfolioReturn + volatility) * 100).toFixed(1)}%</strong>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}
              
              {activeTab === 'diversification' && (
                <div className="space-y-6">
                  {/* Sector Allocation */}
                  <div className="glass-card p-6 rounded-xl">
                    <h3 className="text-xl font-bold text-white mb-4">
                      <i className="fas fa-pie-chart text-cyan-400 mr-2"></i>
                      Sector Allocation
                    </h3>
                    <div className="space-y-3">
                      {sectors.map((sector, idx) => (
                        <div key={sector.sector}>
                          <div className="flex justify-between text-sm mb-1">
                            <span className="text-slate-300">{sector.sector}</span>
                            <span className="text-white font-semibold">{sector.percentage.toFixed(1)}%</span>
                          </div>
                          <div className="w-full bg-slate-700 rounded-full h-3">
                            <div 
                              className={`h-full rounded-full bg-gradient-to-r ${
                                idx === 0 ? 'from-cyan-500 to-blue-500' :
                                idx === 1 ? 'from-purple-500 to-pink-500' :
                                idx === 2 ? 'from-green-500 to-emerald-500' :
                                'from-yellow-500 to-orange-500'
                              }`}
                              style={{ width: `${sector.percentage}%` }}
                            ></div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                  
                  {/* Top Correlations */}
                  <div className="glass-card p-6 rounded-xl">
                    <h3 className="text-xl font-bold text-white mb-4">
                      <i className="fas fa-project-diagram text-purple-400 mr-2"></i>
                      Stock Correlations
                    </h3>
                    <p className="text-sm text-slate-400 mb-4">
                      Shows how your holdings move together. High correlation = less diversification.
                    </p>
                    <div className="space-y-2">
                      {topCorrelations.map((corr, idx) => (
                        <div key={idx} className="flex items-center justify-between p-3 glass-card rounded-lg">
                          <div className="flex items-center gap-3">
                            <div className="text-white font-semibold">{corr.stock1}</div>
                            <i className="fas fa-arrows-left-right text-slate-500 text-xs"></i>
                            <div className="text-white font-semibold">{corr.stock2}</div>
                          </div>
                          <div className="flex items-center gap-2">
                            <div 
                              className="px-3 py-1 rounded-lg font-bold text-sm"
                              style={{ 
                                background: `${corr.color}20`,
                                color: corr.color,
                                border: `1px solid ${corr.color}40`
                              }}
                            >
                              {corr.correlation.toFixed(2)}
                            </div>
                            <div className="text-xs text-slate-500">
                              {corr.correlation > 0.7 ? 'High' : corr.correlation > 0.4 ? 'Medium' : 'Low'}
                            </div>
                          </div>
                        </div>
                      ))}
                    </div>
                    
                    <div className="mt-4 p-3 bg-cyan-500/10 border border-cyan-500/30 rounded-lg text-xs text-slate-400">
                      <i className="fas fa-lightbulb text-cyan-400 mr-1"></i>
                      Lower correlation is better for diversification. Consider adding assets that move differently from your current holdings.
                    </div>
                  </div>
                </div>
              )}
              
              {activeTab === 'performance' && (
                <div className="space-y-6">
                  {/* Performance Overview */}
                  <div className="grid grid-cols-3 gap-4">
                    <div className="glass-card p-5 rounded-xl">
                      <div className="text-xs text-slate-400 mb-2">Total Value</div>
                      <div className="text-2xl font-bold text-white">
                        ${totalValue.toLocaleString(undefined, { maximumFractionDigits: 0 })}
                      </div>
                    </div>
                    
                    <div className="glass-card p-5 rounded-xl">
                      <div className="text-xs text-slate-400 mb-2">Total Cost</div>
                      <div className="text-2xl font-bold text-white">
                        ${totalCost.toLocaleString(undefined, { maximumFractionDigits: 0 })}
                      </div>
                    </div>
                    
                    <div className="glass-card p-5 rounded-xl">
                      <div className="text-xs text-slate-400 mb-2">Total Return</div>
                      <div className={`text-2xl font-bold ${portfolioReturn >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                        {portfolioReturn >= 0 ? '+' : ''}{(portfolioReturn * 100).toFixed(1)}%
                      </div>
                    </div>
                  </div>
                  
                  {/* Holdings Performance */}
                  <div className="glass-card p-6 rounded-xl">
                    <h3 className="text-xl font-bold text-white mb-4">
                      <i className="fas fa-trophy text-yellow-400 mr-2"></i>
                      Top Performers
                    </h3>
                    <div className="space-y-2">
                      {portfolio
                        .map(p => {
                          const cost = p.shares * (p.costBasis || p.currentPrice);
                          const value = p.shares * p.currentPrice;
                          const return_ = cost > 0 ? ((value - cost) / cost) * 100 : 0;
                          return { ...p, return: return_, value, cost };
                        })
                        .sort((a, b) => b.return - a.return)
                        .slice(0, 5)
                        .map((p, idx) => (
                          <div key={p.symbol} className="flex items-center justify-between p-3 glass-card rounded-lg">
                            <div className="flex items-center gap-3">
                              <div className="text-2xl">{idx === 0 ? 'ğŸ¥‡' : idx === 1 ? 'ğŸ¥ˆ' : idx === 2 ? 'ğŸ¥‰' : 'ğŸ“Š'}</div>
                              <div>
                                <div className="text-white font-bold">{p.symbol}</div>
                                <div className="text-xs text-slate-400">${p.value.toLocaleString(undefined, { maximumFractionDigits: 0 })}</div>
                              </div>
                            </div>
                            <div className={`text-xl font-bold ${p.return >= 0 ? 'text-green-400' : 'text-red-400'}`}>
                              {p.return >= 0 ? '+' : ''}{p.return.toFixed(1)}%
                            </div>
                          </div>
                        ))}
                    </div>
                  </div>
                </div>
              )}
            </div>
            
            {/* Footer */}
            <div className="flex justify-end items-center p-6 border-t border-slate-700/30 flex-shrink-0">
              <button onClick={onClose} className="px-6 py-2.5 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold text-sm transition">Close</button>
            </div>
          </div>
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // MAIN APP
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function App() {
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // STATE
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const [stocks, setStocks] = useState([]);
      const [isDarkMode, setIsDarkMode] = useState(() => {
        const saved = localStorage.getItem('darkMode');
        return saved !== null ? saved === 'true' : true;
      });
      
      // Toggle dark/light mode
      const toggleTheme = () => {
        const newMode = !isDarkMode;
        setIsDarkMode(newMode);
        localStorage.setItem('darkMode', newMode);
        document.body.classList.toggle('light-mode', !newMode);
      };
      
      // Apply theme on mount
      useEffect(() => {
        if (!isDarkMode) {
          document.body.classList.add('light-mode');
        } else {
          document.body.classList.remove('light-mode');
        }
      }, [isDarkMode]);
      const [loading, setLoading] = useState(true);
      const [loadingProgress, setLoadingProgress] = useState({ current: 0, total: 0 });
      const [search, setSearch] = useState('');
      const [selectedSector, setSelectedSector] = useState('');
      const [selectedTheme, setSelectedTheme] = useState('');
      const [selectedPreset, setSelectedPreset] = useState('');
      const [sortBy, setSortBy] = useState({ key: 'marketCap', dir: 'desc' });
      const [visibleColumns, setVisibleColumns] = useState(DEFAULT_VISIBLE);
      const [selectedStock, setSelectedStock] = useState(null);

      
      // Portfolio Analysis
      const [portfolioOptimization, setPortfolioOptimization] = useState(null);
      const [portfolioMetrics, setPortfolioMetrics] = useState(null);
      
      // Heatmap  
      const [heatmapData, setHeatmapData] = useState(null);
      
      // Similar Stocks
      const [similarStocks, setSimilarStocks] = useState(null);      const [watchlist, setWatchlist] = useState(() => JSON.parse(localStorage.getItem('watchlist') || '[]'));

          
          // Find Similar Stocks
          const findSimilarStocks = () => {
            if (!selectedStock || stocks.length < 2) {
              setSimilarStocks([]);
              return;
            }
            
            const similarities = stocks
              .filter(s => s.symbol !== selectedStock.symbol)
              .map(stock => {
                let score = 0;
                let factors = 0;
                
                // Sector match
                if (stock.sector === selectedStock.sector) score += 30;
                factors++;
                
                // PE similarity
                if (selectedStock.pe && stock.pe) {
                  const peDiff = Math.abs(selectedStock.pe - stock.pe);
                  score += Math.max(0, 20 - peDiff);
                  factors++;
                }
                
                // ROE similarity
                if (selectedStock.roe && stock.roe) {
                  const roeDiff = Math.abs(selectedStock.roe - stock.roe);
                  score += Math.max(0, 20 - roeDiff / 5);
                  factors++;
                }
                
                // Market Cap similarity
                if (selectedStock.marketCap && stock.marketCap) {
                  const ratio = selectedStock.marketCap / stock.marketCap;
                  if (ratio >= 0.5 && ratio <= 2) score += 15;
                  factors++;
                }
                
                const similarity = (score / (factors * 20)) * 100;
                
                return {
                  symbol: stock.symbol,
                  companyName: stock.companyName,
                  sector: stock.sector,
                  similarity: similarity,
                  pe: stock.pe,
                  roe: stock.roe,
                  aiScore: stock.aiScore
                };
              })
              .sort((a, b) => b.similarity - a.similarity)
              .slice(0, 10);
            
            setSimilarStocks(similarities);
          };
          
          // Run Portfolio Optimization
          const runPortfolioOptimization = async () => {
            setLoadingTabData(true);
            try {
              if (portfolio.length < 2) {
                setPortfolioOptimization(null);
                return;
              }
              
              const positions = portfolio.map(pos => {
                const stock = stocks.find(s => s.symbol === pos.symbol);
                return {
                  symbol: pos.symbol,
                  expectedReturn: (stock?.aiScore || 50) / 1000 + 0.05,
                  volatility: (100 - (stock?.confidence || 50)) / 100
                };
              });
              
              const optimization = MLModels.optimizePortfolio(positions);
              setPortfolioOptimization(optimization);
            } catch (err) {
              console.error('Portfolio error:', err);
              setPortfolioOptimization(null);
            } finally {
              setLoadingTabData(false);
            }
          };
      const [showHeatmap, setShowHeatmap] = useState(false);
      const [showSettings, setShowSettings] = useState(false);
      const [showAlerts, setShowAlerts] = useState(false);
      const [showPortfolio, setShowPortfolio] = useState(false);
      const [showPortfolioAllocation, setShowPortfolioAllocation] = useState(false);
      const [showStockManager, setShowStockManager] = useState(false);
      const [showComparison, setShowComparison] = useState(false);
      const [showEducation, setShowEducation] = useState(false);
      const [showGoalPlanner, setShowGoalPlanner] = useState(false);
      const [showRebalancing, setShowRebalancing] = useState(false);
      const [showTaxCenter, setShowTaxCenter] = useState(false);
      const [showBadges, setShowBadges] = useState(false);
      const [showSharePortfolio, setShowSharePortfolio] = useState(false);
      const [showCommunity, setShowCommunity] = useState(false);
      const [showAdvancedAnalytics, setShowAdvancedAnalytics] = useState(false);
      const [showInvestorGuardrails, setShowInvestorGuardrails] = useState(false);
      const [showNotifications, setShowNotifications] = useState(false);
      const [showWatchlistImporter, setShowWatchlistImporter] = useState(false);
      const [notificationCount, setNotificationCount] = useState(0);
      
      // Subscribe to alert updates
      useEffect(() => {
        const updateCount = () => {
          setNotificationCount(window.alertManager.getUnreadCount());
        };
        updateCount();
        const unsubscribe = window.alertManager.subscribe(updateCount);
        return unsubscribe;
      }, []);
      
      // Initialize keyboard shortcuts
      useEffect(() => {
        if (!window.keyboardShortcuts) return;
        
        // Register useful shortcuts
        window.keyboardShortcuts.register('/', () => {
          document.querySelector('input[type="text"]')?.focus();
        }, 'Focus search input');
        
        window.keyboardShortcuts.register('ctrl+r', () => {
          manualRefresh();
        }, 'Refresh stock data');
        
        window.keyboardShortcuts.register('ctrl+i', () => {
          setShowWatchlistImporter(true);
        }, 'Open import dialog');
        
        window.keyboardShortcuts.register('ctrl+p', () => {
          setShowPortfolio(true);
        }, 'Open portfolio');
        
        window.keyboardShortcuts.register('ctrl+h', () => {
          const shortcuts = window.keyboardShortcuts.getHelp();
          alert('âŒ¨ï¸ KEYBOARD SHORTCUTS:\n\n' + shortcuts.map(s => `${s.key.padEnd(15)} ${s.description}`).join('\n'));
        }, 'Show this help');
        
        window.keyboardShortcuts.register('esc', () => {
          // Close any open modals
          setShowPortfolio(false);
          setShowAlerts(false);
          setShowSettings(false);
          setShowEducation(false);
          setShowStockManager(false);
          setShowWatchlistImporter(false);
        }, 'Close modals');
        
        console.log('âŒ¨ï¸ Keyboard shortcuts registered');
      }, []);
      
      const [comparisonSymbols, setComparisonSymbols] = useState([]);
      const [isWebSocketConnected, setIsWebSocketConnected] = useState(false);
      const [curatedStocks, setCuratedStocks] = useState(() => {
        const saved = localStorage.getItem('curatedStocks');
        // Reduced default list for faster initial load - users can import more
        return saved ? JSON.parse(saved) : ['NVDA','TSLA','AAPL','MSFT','GOOGL','AMZN','META','AMD','NFLX','UBER'];
      });
      const [newStockSymbol, setNewStockSymbol] = useState('');
      const [toasts, setToasts] = useState([]);
      const [portfolio, setPortfolio] = useState(() => JSON.parse(localStorage.getItem('portfolio') || '[]'));
      const [alerts, setAlerts] = useState(() => JSON.parse(localStorage.getItem('alerts') || '[]'));
      const [goals, setGoals] = useState(() => {
        const saved = localStorage.getItem('re_financial_goals');
        return saved ? JSON.parse(saved) : [];
      });
      const [portfolioRecs, setPortfolioRecs] = useState([]);
      const [detailedDataLoading, setDetailedDataLoading] = useState(false);
      const [lastUpdateTime, setLastUpdateTime] = useState(null);
      const [nextUpdateTime, setNextUpdateTime] = useState(null);
      const [errors, setErrors] = useState([]);

      // Monitor portfolio for price alerts
      useEffect(() => {
        if (!portfolio || portfolio.length === 0) return;
        
        const prevPrices = {};
        
        // Initialize previous prices
        portfolio.forEach(pos => {
          prevPrices[pos.symbol] = pos.currentPrice;
        });
        
        // Check every 5 minutes during market hours
        const interval = setInterval(() => {
          const now = new Date();
          const hours = now.getHours();
          const day = now.getDay();
          
          // Only check during market hours (9:30 AM - 4 PM ET, Mon-Fri)
          if (day === 0 || day === 6 || hours < 9 || hours >= 16) return;
          
          checkPortfolioAlerts(portfolio, prevPrices);
          
          // Update previous prices
          portfolio.forEach(pos => {
            prevPrices[pos.symbol] = pos.currentPrice;
          });
        }, 5 * 60 * 1000); // 5 minutes
        
        return () => clearInterval(interval);
      }, [portfolio]);

      // Filter State
      const [filters, setFilters] = useState({
        pe_min: '', pe_max: '',
        roe_min: '', roe_max: '',
        marketCap_min: '', marketCap_max: '',
        changePct_min: '', changePct_max: '',
        rsi_min: '', rsi_max: '',
      });

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // FIREBASE AUTH (Optional - graceful fallback to guest mode)
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      const [firebaseUser, setFirebaseUser] = useState(null);
      const [authLoading, setAuthLoading] = useState(true);

      // Firebase auth listener
      useEffect(() => {
        if (window.firebaseUtils) {
          const { auth, onAuthStateChanged } = window.firebaseUtils;
          const unsubscribe = onAuthStateChanged(auth, (user) => {
            setFirebaseUser(user);
            setAuthLoading(false);
            if (user) {
              console.log('âœ… User signed in:', user.email);
              loadUserDataFromFirebase(user.uid);
            }
          });
          return () => unsubscribe();
        } else {
          setAuthLoading(false);
        }
      }, []);

      const signInWithGoogle = async () => {
        if (!window.firebaseUtils) {
          alert('Firebase not configured. Running in guest mode.');
          return;
        }
        const { auth, provider, signInWithPopup } = window.firebaseUtils;
        try {
          await signInWithPopup(auth, provider);
        } catch (error) {
          console.error('Auth error:', error);
          alert('Sign-in failed. Continue in guest mode.');
        }
      };

      const signOutUser = async () => {
        if (window.firebaseUtils?.auth) {
          await window.firebaseUtils.auth.signOut();
        }
        setFirebaseUser(null);
        console.log('âœ… User signed out');
      };

      const loadUserDataFromFirebase = async (uid) => {
        if (!window.firebaseUtils?.db) return;
        try {
          const { db, doc, getDoc } = window.firebaseUtils;
          const userDoc = await getDoc(doc(db, 'users', uid));
          if (userDoc.exists()) {
            const data = userDoc.data();
            if (data.watchlist) {
              setWatchlist(data.watchlist);
              console.log('âœ… Loaded watchlist from Firebase');
            }
            if (data.portfolio) {
              setPortfolio(data.portfolio);
              console.log('âœ… Loaded portfolio from Firebase');
            }
          }
        } catch (error) {
          console.warn('Failed to load user data:', error);
        }
      };

      const saveUserDataToFirebase = async (uid) => {
        if (!window.firebaseUtils?.db) return;
        try {
          const { db, doc, setDoc } = window.firebaseUtils;
          const data = {
            watchlist,
            portfolio,
            lastUpdated: new Date().toISOString()
          };
          await setDoc(doc(db, 'users', uid), data, { merge: true });
          console.log('âœ… Saved to Firebase');
        } catch (error) {
          console.warn('Failed to save user data:', error);
        }
      };

      // Auto-save to Firebase when watchlist/portfolio changes
      useEffect(() => {
        if (firebaseUser) {
          saveUserDataToFirebase(firebaseUser.uid);
        }
      }, [watchlist, portfolio, firebaseUser]);
      
      // Check and unlock badges
      useEffect(() => {
        const newBadges = checkAndUnlockBadges(portfolio, watchlist, goals, {});
        if (newBadges.length > 0) {
          newBadges.forEach(badgeId => {
            const badge = BADGES[badgeId];
            if (badge) {
              addToast(`ğŸ† Badge Unlocked: ${badge.title}!`, 'success');
            }
          });
        }
      }, [portfolio, watchlist, goals]);

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // WATCHLIST SHARING
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      // Load shared watchlist from URL on mount
      useEffect(() => {
        const urlParams = new URLSearchParams(window.location.search);
        const shared = urlParams.get('watchlist');
        if (shared) {
          const symbols = shared.split(',').map(s => cleanSymbol(s.trim()));
          setWatchlist(symbols);
          addToast('ğŸ“‹ Imported shared watchlist', 'success');
          console.log('âœ… Loaded shared watchlist:', symbols);
        }
      }, []);

      const shareWatchlist = () => {
        const url = `${window.location.origin}${window.location.pathname}?watchlist=${encodeURIComponent(watchlist.join(','))}`;
        navigator.clipboard.writeText(url)
          .then(() => {
            addToast('ğŸ”— Watchlist link copied to clipboard!', 'success');
          })
          .catch(() => {
            prompt('Copy this shareable link:', url);
          });
      };
      
      // Track stock views for analyst badge
      const openStockModal = (stock) => {
        setSelectedStock(stock);
        
        // Track this view
        const viewedStocks = JSON.parse(localStorage.getItem('viewedStocks') || '[]');
        if (!viewedStocks.includes(stock.symbol)) {
          viewedStocks.push(stock.symbol);
          localStorage.setItem('viewedStocks', JSON.stringify(viewedStocks));
        }
      };

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // DATA FETCHING WITH ERROR HANDLING
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      useEffect(() => {
        // Initial fetch
        fetchStocks();
        
        // Set up hourly refresh (60 minutes = 3,600,000 milliseconds)
        const refreshInterval = setInterval(() => {
          console.log('â° Hourly auto-refresh triggered');
          fetchStocks();
        }, 60 * 60 * 1000); // 1 hour
        
        // Cleanup on unmount
        return () => clearInterval(refreshInterval);
      }, [curatedStocks]);

      // Update next refresh time whenever stocks are fetched
      useEffect(() => {
        if (lastUpdateTime) {
          const nextUpdate = new Date(lastUpdateTime.getTime() + 60 * 60 * 1000);
          setNextUpdateTime(nextUpdate);
        }
      }, [lastUpdateTime]);

      const addError = (message, details = '') => {
        const id = Date.now().toString();
        setErrors(prev => [...prev, { id, message, details, timestamp: new Date() }]);
        
        // Auto-remove error after 10 seconds
        setTimeout(() => {
          setErrors(prev => prev.filter(e => e.id !== id));
        }, 10000);
      };

      const fetchSingleStockData = async (symbol) => {
        // Clean symbol to remove exchange suffixes (.O, .K, etc.)
        symbol = cleanSymbol(symbol);
        
        // CHECK CACHE FIRST - Dramatically speeds up loading!
        const cached = Cache.get(symbol, 'stock');
        if (cached) {
          console.log(`âš¡ Using cached data for ${symbol}`);
          return cached;
        }
        
        try {
          console.log(`ğŸ“¡ Fetching comprehensive data for ${symbol}... (Paid FMP API)`);
          
          // SEQUENTIAL API CALLS - FMP paid version doesn't allow batch calling
          const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));
          
          const quoteRes = await fetch(`https://financialmodelingprep.com/stable/quote?symbol=${symbol}&apikey=${FMP_API_KEY}`);
          
          // Check for API errors
          if (!quoteRes.ok) {
            console.error(`âŒ Quote API failed for ${symbol}: ${quoteRes.status} ${quoteRes.statusText}`);
            if (quoteRes.status === 429) {
              throw new Error(`Rate limited by FMP API (status 429). Please wait a moment.`);
            }
            throw new Error(`Stock data not available for ${symbol} (status ${quoteRes.status})`);
          }
          
          const quoteData = await quoteRes.json();
          await delay(100);
          
          const metricsRes = await fetch(`https://financialmodelingprep.com/stable/key-metrics-ttm?symbol=${symbol}&apikey=${FMP_API_KEY}`);
          const metricsData = metricsRes.ok ? await metricsRes.json() : null;
          await delay(100);
          
          const scoresRes = await fetch(`https://financialmodelingprep.com/stable/score?symbol=${symbol}&apikey=${FMP_API_KEY}`);
          const scoresData = scoresRes.ok ? await scoresRes.json() : null;
          await delay(100);
          
          const ratingsRes = await fetch(`https://financialmodelingprep.com/stable/rating?symbol=${symbol}&apikey=${FMP_API_KEY}`);
          const ratingsData = ratingsRes.ok ? await ratingsRes.json() : null;
          await delay(100);
          
          const targetRes = await fetch(`https://financialmodelingprep.com/stable/price-target-consensus?symbol=${symbol}&apikey=${FMP_API_KEY}`);
          const targetData = targetRes.ok ? await targetRes.json() : null;
          await delay(100);
          
          const profileRes = await fetch(`https://financialmodelingprep.com/stable/profile?symbol=${symbol}&apikey=${FMP_API_KEY}`);
          const profileData = profileRes.ok ? await profileRes.json() : null;
          await delay(100);
          
          const gradesRes = await fetch(`https://financialmodelingprep.com/stable/grades?symbol=${symbol}&limit=10&apikey=${FMP_API_KEY}`);
          const grades = gradesRes.ok ? await gradesRes.json() : [];
          await delay(100);
          
          const gradesConsensusRes = await fetch(`https://financialmodelingprep.com/stable/grades-consensus?symbol=${symbol}&apikey=${FMP_API_KEY}`);
          const gradesConsensusData = gradesConsensusRes.ok ? await gradesConsensusRes.json() : null;
          await delay(100);
          
          const ratiosRes = await fetch(`https://financialmodelingprep.com/stable/ratios?symbol=${symbol}&limit=1&apikey=${FMP_API_KEY}`);
          const ratiosData = ratiosRes.ok ? await ratiosRes.json() : null;
          await delay(100);
          
          const growthRes = await fetch(`https://financialmodelingprep.com/stable/financial-growth?symbol=${symbol}&limit=5&apikey=${FMP_API_KEY}`);
          const growthData = growthRes.ok ? await growthRes.json() : null;
          
          if (!quoteData || quoteData.length === 0) {
            throw new Error('Stock not found - empty response');
          }
          
          const quote = quoteData[0];
          const quoteFetchedAt = Date.now();
          const metrics = metricsData && metricsData.length > 0 ? metricsData[0] : null;
          const scores = scoresData && scoresData.length > 0 ? scoresData[0] : null;
          const ratings = ratingsData && ratingsData.length > 0 ? ratingsData[0] : null;
          const target = targetData && targetData.length > 0 ? targetData[0] : null;
          const profile = profileData && profileData.length > 0 ? profileData[0] : null;
          const ratios = ratiosData && ratiosData.length > 0 ? ratiosData[0] : null;
          const gradesConsensus = gradesConsensusData && gradesConsensusData.length > 0 ? gradesConsensusData[0] : gradesConsensusData;

          const toFiniteNumberOrNull = (v) => {
            if (v === '' || v === undefined || v === null) return null;
            const n = Number(v);
            return Number.isFinite(n) ? n : null;
          };

          const pickFirstField = (obj, keys) => {
            for (const key of keys) {
              const n = toFiniteNumberOrNull(obj?.[key]);
              if (n !== null) return n;
            }
            return null;
          };

          const pickGrowthRecord = (arr) => {
            if (!Array.isArray(arr) || arr.length === 0) return null;
            const keys = {
              revenue: ['revenueGrowth', 'revenuegrowth', 'revenueGrowthYoY'],
              income: ['netIncomeGrowth', 'netincomegrowth', 'netIncomeGrowthYoY'],
              eps: ['epsGrowth', 'epsgrowth', 'epsGrowthYoY', 'epsgrowthYoY']
            };
            return (
              arr.find(g => (
                pickFirstField(g, keys.revenue) !== null ||
                pickFirstField(g, keys.income) !== null ||
                pickFirstField(g, keys.eps) !== null
              )) || arr[0]
            );
          };

          const growth = pickGrowthRecord(growthData);
          const revenueGrowthRaw = pickFirstField(growth, ['revenueGrowth', 'revenuegrowth', 'revenueGrowthYoY']);
          const netIncomeGrowthRaw = pickFirstField(growth, ['netIncomeGrowth', 'netincomegrowth', 'netIncomeGrowthYoY']);
          const epsGrowthRaw = pickFirstField(growth, ['epsGrowth', 'epsgrowth', 'epsGrowthYoY', 'epsgrowthYoY']);

          const revenueGrowthPct = revenueGrowthRaw !== null ? (revenueGrowthRaw * 100) : null;
          const netIncomeGrowthPct = netIncomeGrowthRaw !== null ? (netIncomeGrowthRaw * 100) : null;
          const epsGrowthPct = epsGrowthRaw !== null ? (epsGrowthRaw * 100) : null;
          await new Promise(r => setTimeout(r, 100));
          
          // Earnings
          const earningsRes = await fetch(`https://financialmodelingprep.com/stable/earning_calendar/${symbol}?apikey=${FMP_API_KEY}`);
          const earnings = earningsRes.ok ? await earningsRes.json() : [];
          await new Promise(r => setTimeout(r, 100));
          
          // Stock Peers
          const peersRes = await fetch(`https://financialmodelingprep.com/stable/stock_peers?symbol=${symbol}&apikey=${FMP_API_KEY}`);
          const peersData = peersRes.ok ? await peersRes.json() : null;
          const peers = peersData && peersData.length > 0 ? peersData[0]?.peersList : [];
          await new Promise(r => setTimeout(r, 100));
          
          // Latest News (stock-specific)
          let news = [];
          try {
            // Prefer the unified news manager (more sources; already filtered to last 30 days)
            if (window.newsManager && typeof window.newsManager.fetchNews === 'function') {
              const nmArticles = await window.newsManager.fetchNews(symbol, 10);
              news = (nmArticles || []).map(a => ({
                title: a.title,
                url: a.url,
                site: a.source || a.site || 'News',
                publishedDate: a.publishedAt || a.publishedDate || a.date,
                image: a.image
              }));
            } else {
              const newsRes = await fetch(`https://financialmodelingprep.com/stable/stock_news?tickers=${symbol}&limit=20&apikey=${FMP_API_KEY}`);
              if (newsRes.ok) {
                let articles = await newsRes.json();
                
                // Filter to ensure news mentions the stock
                const companyName = profile?.companyName?.toLowerCase() || '';
                news = articles.filter(article => {
                  if (!article.title) return false;
                  const text = (article.title + ' ' + (article.text || '')).toLowerCase();
                  const sym = symbol.toLowerCase();
                  // Check if article mentions symbol or company name
                  return text.includes(sym) || (companyName && text.includes(companyName));
                });

                // Keep only last 30 days
                const cutoff = Date.now() - (30 * 24 * 60 * 60 * 1000);
                news = (news || []).filter(a => {
                  const dt = new Date(a.publishedDate || a.date || 0).getTime();
                  return Number.isFinite(dt) && dt >= cutoff;
                });
                
                // If no relevant news found, take recent general results
                if (news.length === 0 && articles.length > 0) {
                  console.warn(`No recent filtered news (30d) for ${symbol}, using general recent results`);
                  news = (articles || []).filter(a => {
                    const dt = new Date(a.publishedDate || a.date || 0).getTime();
                    return Number.isFinite(dt) && dt >= cutoff;
                  }).slice(0, 10);
                } else {
                  // Prioritize analyst/rating/price-target updates within the relevant set
                  if (window.newsManager && typeof window.newsManager.getAnalystUpdateScore === 'function') {
                    news.sort((a, b) => {
                      const scoreB = window.newsManager.getAnalystUpdateScore(
                        { title: b.title, description: b.text || b.content || '' },
                        symbol
                      );
                      const scoreA = window.newsManager.getAnalystUpdateScore(
                        { title: a.title, description: a.text || a.content || '' },
                        symbol
                      );
                      if (scoreB !== scoreA) return scoreB - scoreA;
                      return new Date(b.publishedDate || b.date || 0) - new Date(a.publishedDate || a.date || 0);
                    });
                  }

                  news = news.slice(0, 10);
                }
              }
            }
          } catch (err) {
            console.warn(`News fetch failed for ${symbol}:`, err);
            news = [];
          }
          
          console.log(`âœ… ${symbol}: Fetched 13 endpoints (${news.length} news articles)`);
          
          // DEBUG: Log raw API data to verify what we're getting
          console.log(`   ğŸ“Š Raw API Data for ${symbol}:`);
          console.log(`      Quote priceToEarnings: ${quote.priceToEarnings}`);
          console.log(`      Quote pe: ${quote.pe}`);
          console.log(`      Metrics peRatioTTM: ${metrics?.peRatioTTM}`);
          console.log(`      Ratios priceEarningsRatio: ${ratios?.priceEarningsRatio}`);
          console.log(`      Ratios peRatio: ${ratios?.peRatio}`);
          console.log(`      Metrics returnOnEquityTTM: ${metrics?.returnOnEquityTTM}`);
          console.log(`      Ratios returnOnEquityTTM: ${ratios?.returnOnEquityTTM}`);
          console.log(`      Ratios returnOnEquity: ${ratios?.returnOnEquity}`);
          console.log(`      Ratings rating: ${ratings?.rating}`);
          console.log(`      Ratings ratingRecommendation: ${ratings?.ratingRecommendation}`);
          console.log(`      GradesConsensus consensus: ${gradesConsensus?.consensus}`);
          console.log(`      GradesConsensus object:`, gradesConsensus);
          
          // DEBUG: Log price data to verify API values
          console.log(`   ğŸ“Š Price Data for ${symbol}:`);
          console.log(`      Current: $${quote.price}`);
          console.log(`      Day High: $${quote.dayHigh || 'MISSING'}`);
          console.log(`      Day Low: $${quote.dayLow || 'MISSING'}`);
          console.log(`      Year High: $${quote.yearHigh || 'MISSING'}`);
          console.log(`      Year Low: $${quote.yearLow || 'MISSING'}`);
          console.log(`      Open: $${quote.open || 'MISSING'}`);
          console.log(`      Prev Close: $${quote.previousClose || 'MISSING'}`);
          console.log(`      Avg Volume: ${profile?.averageVolume || 'MISSING'}`);
          
          // Build comprehensive stock object
          const stockData = {
            symbol: quote.symbol,
            companyName: profile?.companyName || quote.name || symbol,
            sector: profile?.sector || quote.sector || 'Unknown',
            industry: profile?.industry || quote.industry || 'Unknown',
            description: profile?.description || '',
            website: profile?.website || '',
            ceo: profile?.ceo || '',

            // Data freshness
            quoteFetchedAt,
            fetchedAt: Date.now(),
            
            // Price Data
            price: quote.price,
            changePct: quote.changesPercentage || 0,
            volume: quote.volume,
            avgVolume: profile?.averageVolume || 0,
            marketCap: quote.marketCap,
            beta: profile?.beta || 1.0,
            
            // Daily Range
            dayHigh: quote.dayHigh || 0,
            dayLow: quote.dayLow || 0,
            open: quote.open || 0,
            previousClose: quote.previousClose || 0,
            
            // 52-Week Range
            yearHigh: quote.yearHigh || 0,
            yearLow: quote.yearLow || 0,
            
            // Valuation Metrics - Improved PE calculation
            pe: (() => {
              // Try multiple sources for PE ratio - FMP API uses different field names
              if (quote.priceToEarnings && quote.priceToEarnings > 0 && quote.priceToEarnings < 1000) return quote.priceToEarnings;
              if (quote.pe && quote.pe > 0 && quote.pe < 1000) return quote.pe;
              if (metrics?.peRatioTTM && metrics.peRatioTTM > 0 && metrics.peRatioTTM < 1000) return metrics.peRatioTTM;
              if (ratios?.priceEarningsRatio && ratios.priceEarningsRatio > 0 && ratios.priceEarningsRatio < 1000) return ratios.priceEarningsRatio;
              if (ratios?.peRatio && ratios.peRatio > 0 && ratios.peRatio < 1000) return ratios.peRatio;
              if (metrics?.earningsYieldTTM && metrics.earningsYieldTTM > 0) {
                const calculatedPE = 1 / metrics.earningsYieldTTM;
                return (calculatedPE > 0 && calculatedPE < 1000) ? calculatedPE : null;
              }
              return null;
            })(),
            priceToBook: ratios?.priceToBookRatio || 0,
            priceToSales: ratios?.priceToSalesRatio || 0,
            enterpriseValue: metrics?.enterpriseValueTTM || 0,
            evToEbitda: metrics?.evToEBITDATTM || 0,
            
            // Profitability - Improved ROE calculation
            roe: (() => {
              // Try multiple sources for ROE
              const roeValue = metrics?.returnOnEquityTTM || ratios?.returnOnEquityTTM || ratios?.returnOnEquity;
              if (!roeValue) return null;
              
              // If already in percentage (>1), use as is
              if (roeValue > 1) return roeValue;
              
              // If decimal (0-1), convert to percentage
              const roePercent = roeValue * 100;
              return (roePercent >= -100 && roePercent <= 500) ? roePercent : null;
            })(),
            roa: metrics?.returnOnAssetsTTM ? (metrics.returnOnAssetsTTM * 100) : 0,
            roic: metrics?.returnOnInvestedCapitalTTM ? (metrics.returnOnInvestedCapitalTTM * 100) : 0,
            grossMargin: ratios?.grossProfitMargin ? (ratios.grossProfitMargin * 100) : 0,
            operatingMargin: ratios?.operatingProfitMargin ? (ratios.operatingProfitMargin * 100) : 0,
            netMargin: ratios?.netProfitMargin ? (ratios.netProfitMargin * 100) : 0,
            
            // Financial Health
            currentRatio: metrics?.currentRatioTTM || ratios?.currentRatio || 0,
            quickRatio: metrics?.quickRatioTTM || ratios?.quickRatio || 0,
            debtToEquity: ratios?.debtEquityRatio || metrics?.netDebtToEBITDATTM || 0,
            debtToAssets: ratios?.debtRatio || 0,
            cashRatio: ratios?.cashRatio || 0,
            
            // Growth Metrics
            revenueGrowth: revenueGrowthPct,
            netIncomeGrowth: netIncomeGrowthPct,
            epsGrowth: epsGrowthPct,
            
            // Quality Scores
            piotroskiScore: scores?.piotroskiScore || 0,
            altmanZScore: scores?.altmanZScore || 0,
            
            // Analyst Data - Improved rating extraction
            analystRating: (() => {
              // Try grades-consensus first (most reliable for FMP rating)
              if (gradesConsensus?.consensus) {
                const consensus = String(gradesConsensus.consensus).trim().toUpperCase();
                if (consensus.includes('STRONG BUY') || consensus === 'A+') return 'A+';
                if (consensus.includes('BUY') || consensus === 'A') return 'A';
                if (consensus.includes('HOLD') || consensus === 'B') return 'B';
                if (consensus.includes('SELL') || consensus === 'C') return 'C';
                if (consensus.includes('STRONG SELL') || consensus === 'D') return 'D';
                return consensus;
              }
              
              // Fallback to ratings endpoint
              const rating = ratings?.rating || ratings?.ratingRecommendation;
              if (!rating || rating === 'N/A') return null;
              
              // Clean up rating text
              const cleanRating = String(rating).trim().toUpperCase();
              
              // Map common rating formats
              if (cleanRating.includes('STRONG BUY') || cleanRating.includes('A+')) return 'A+';
              if (cleanRating.includes('BUY') || cleanRating.includes('A')) return 'A';
              if (cleanRating.includes('HOLD') || cleanRating.includes('B')) return 'B';
              if (cleanRating.includes('SELL') || cleanRating.includes('C')) return 'C';
              if (cleanRating.includes('STRONG SELL') || cleanRating.includes('D')) return 'D';
              
              return cleanRating.length > 0 ? cleanRating : null;
            })(),
            overallScore: ratings?.overallScore || 0,
            priceTarget: target?.lastQuarterAvgPriceTarget || 0,
            priceTargetLow: target?.lastMonthAvgPriceTarget || 0,
            priceTargetAvg: target?.lastQuarterAvgPriceTarget || 0,
            analystCount: target?.lastQuarterCount || 0,
            upside: target?.lastQuarterAvgPriceTarget && quote.price 
              ? ((target.lastQuarterAvgPriceTarget - quote.price) / quote.price * 100)
              : 0,
            
            // Latest Analyst Grade
            latestGrade: grades && grades.length > 0 ? grades[0] : null,
            analystGradeHistory: grades.slice(0, 10),
            
            // Earnings
            lastEarnings: earnings && earnings.length > 0 ? earnings[0] : null,
            earningsHistory: earnings.slice(0, 4),
            
            // Peers
            peers: peers || [],
            
            // News
            latestNews: news.slice(0, 10),
            
            // Additional
            exchange: quote.exchange,
            index: 'Search Result',
            rsi: 50,
            sparkline: Array.from({length: 20}, () => quote.price * (0.98 + Math.random() * 0.04))
          };
          
          // Preserve previous snapshot for explainability diffs
          try {
            const currentKey = Cache.key(symbol, 'stock');
            const prevKey = Cache.key(symbol, 'stock_prev');
            const existing = localStorage.getItem(currentKey);
            if (existing) localStorage.setItem(prevKey, existing);
          } catch (e) {
            // ignore localStorage issues
          }

          // CACHE THE DATA for faster subsequent loads
          Cache.set(symbol, stockData, 'stock');
          
          // DEBUG: Log final mapped values
          console.log(`   âœ… Final mapped values for ${symbol}:`);
          console.log(`      PE: ${stockData.pe} (from ${quote.priceToEarnings ? 'quote.priceToEarnings' : metrics?.peRatioTTM ? 'metrics.peRatioTTM' : ratios?.priceEarningsRatio ? 'ratios.priceEarningsRatio' : 'null'})`);
          console.log(`      ROE: ${stockData.roe}% (from ${metrics?.returnOnEquityTTM ? 'metrics.returnOnEquityTTM' : ratios?.returnOnEquityTTM ? 'ratios.returnOnEquityTTM' : ratios?.returnOnEquity ? 'ratios.returnOnEquity' : 'null'})`);
          console.log(`      Analyst Rating: ${stockData.analystRating} (from ${gradesConsensus?.consensus ? 'gradesConsensus.consensus' : ratings?.rating ? 'ratings.rating' : 'null'})`);
          
          return stockData;
        } catch (error) {
          console.error(`Error fetching ${symbol}:`, error);
          throw error;
        }
      };

      const addToCurated = () => {
        const symbol = newStockSymbol.trim().toUpperCase();
        if (!symbol) return;
        if (curatedStocks.includes(symbol)) {
          addError('Stock already in list', `${symbol} is already in your curated list`);
          return;
        }
        const updated = [...curatedStocks, symbol];
        setCuratedStocks(updated);
        localStorage.setItem('curatedStocks', JSON.stringify(updated));
        setNewStockSymbol('');
        fetchStocks(); // Reload with new stock
      };

      const removeFromCurated = (symbol) => {
        const updated = curatedStocks.filter(s => s !== symbol);
        setCuratedStocks(updated);
        localStorage.setItem('curatedStocks', JSON.stringify(updated));
        fetchStocks(); // Reload without removed stock
      };

      const fetchStocks = async () => {
        setLoading(true);
        setLoadingProgress({ current: 0, total: curatedStocks.length });
        setErrors([]);
        const startTime = new Date();
        
        try {
          console.log('ğŸ”„ Loading', curatedStocks.length, 'stocks with full data...');
          
          const allStocks = [];
          let completedCount = 0;
          
          // Parallel fetching with error handling
          const promises = curatedStocks.map(async (symbol, index) => {
            console.log(`ğŸ“¡ [${index + 1}/${curatedStocks.length}] Fetching ${symbol}...`);
            
            try {
              const stockData = await fetchSingleStockData(symbol);
              stockData.index = 'Curated'; // Override index for curated stocks
              
              const ai = generateAIAnalysis(stockData);
              
              // Compute ML prediction (async, but don't block on it)
              let mlPrediction = { predPct: null, conf: null, trend: null };
              try {
                mlPrediction = await computeMLPrediction(symbol);
              } catch (e) {
                console.warn(`ML prediction failed for ${symbol}:`, e);
              }
              
              // Create completely fresh object for each stock to avoid reference issues
              const stockWithAnalysis = {
                ...stockData,
                ...ai,
                aiScore: ai.aiScore,
                mlPrediction,
                // Deep copy AI analysis objects (from ai)
                subscores: ai.subscores ? { ...ai.subscores } : null,
                topDrivers: ai.topDrivers ? {
                  positive: ai.topDrivers.positive ? [...ai.topDrivers.positive] : [],
                  negative: ai.topDrivers.negative ? [...ai.topDrivers.negative] : []
                } : null,
                bullFactors: ai.bullFactors ? [...ai.bullFactors] : [],
                bearFactors: ai.bearFactors ? [...ai.bearFactors] : [],
                // Deep copy arrays from stockData
                latestNews: stockData.latestNews ? [...stockData.latestNews] : [],
                peers: stockData.peers ? [...stockData.peers] : [],
                earningsHistory: stockData.earningsHistory ? [...stockData.earningsHistory] : [],
                analystGradeHistory: stockData.analystGradeHistory ? [...stockData.analystGradeHistory] : [],
              };
              allStocks.push(stockWithAnalysis);
              
              // Update progress
              completedCount++;
              setLoadingProgress({ current: completedCount, total: curatedStocks.length });
              
              console.log(`âœ… ${symbol}: $${stockData.price} | P/E: ${stockData.pe.toFixed(1)} | ROE: ${stockData.roe.toFixed(1)}% | Rating: ${stockData.analystRating}`);
              
            } catch (err) {
              console.error(`âŒ ${symbol} failed:`, err);
              addError(`Failed to fetch ${symbol}`, err.message);
              completedCount++;
              setLoadingProgress({ current: completedCount, total: curatedStocks.length });
            }
          });
          
// Execute in optimized batches even for paid FMP (10 stocks at a time to avoid overwhelming API)
    const BATCH_SIZE = 10; // Optimal for paid FMP
    const BATCH_DELAY = 100; // Minimal delay between batches
    
    for (let i = 0; i < promises.length; i += BATCH_SIZE) {
      const batch = promises.slice(i, i + BATCH_SIZE);
      const batchNum = Math.floor(i / BATCH_SIZE) + 1;
      const totalBatches = Math.ceil(promises.length / BATCH_SIZE);
      
      console.log(`âš¡ Processing batch ${batchNum}/${totalBatches} (${batch.length} stocks with paid FMP)...`);
      await Promise.all(batch);
      
      // Small delay between batches to avoid rate limiting
      if (i + BATCH_SIZE < promises.length) {
        await new Promise(r => setTimeout(r, BATCH_DELAY));
      }
    }
          
          console.log('âœ… Total loaded:', allStocks.length, 'with full data');
          
          allStocks.sort((a,b) => b.marketCap - a.marketCap);
          setStocks(allStocks);
          setLastUpdateTime(startTime);
          
          if (allStocks.length === 0) {
            addError('No stocks loaded', 'Check your API key and curated stocks list');
          }
          
          console.log('âœ… COMPLETE!');
          
        } catch (err) {
          console.error('âŒ Error:', err);
          addError('Failed to fetch stocks', err.message);
          setStocks([]);
        } finally {
          setLoading(false);
        }
      };

      const manualRefresh = () => {
        console.log('ğŸ”„ Manual refresh triggered');
        fetchStocks();
      };

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // FILTERING & SORTING
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      const filtered = useMemo(() => {
        let result = stocks;

        // Search
        if (search) {
          const lower = search.toLowerCase();
          result = result.filter(s => 
            s.symbol.toLowerCase().includes(lower) ||
            (s.companyName || '').toLowerCase().includes(lower)
          );
        }

        // Sector
        if (selectedSector) {
          result = result.filter(s => s.sector === selectedSector);
        }

        // Theme
        if (selectedTheme) {
          const theme = THEMES.find(t => t.id === selectedTheme);
          if (theme) {
            result = result.filter(s => {
              const text = `${s.companyName} ${s.sector} ${s.industry}`.toLowerCase();
              return theme.keywords.some(kw => text.includes(kw.toLowerCase()));
            });
          }
        }

        // Preset
        if (selectedPreset) {
          const preset = PRESET_SCREENS[selectedPreset];
          if (preset) {
            Object.entries(preset.filters).forEach(([key, val]) => {
              if (key.endsWith('_min')) {
                const field = key.replace('_min', '');
                result = result.filter(s => (s[field] || 0) >= val);
              } else if (key.endsWith('_max')) {
                const field = key.replace('_max', '');
                result = result.filter(s => (s[field] || 0) <= val);
              }
            });
          }
        }

        // Manual Filters
        Object.entries(filters).forEach(([key, val]) => {
          if (val === '') return;
          const numVal = parseFloat(val);
          if (isNaN(numVal)) return;

          if (key.endsWith('_min')) {
            const field = key.replace('_min', '');
            result = result.filter(s => (s[field] || 0) >= numVal);
          } else if (key.endsWith('_max')) {
            const field = key.replace('_max', '');
            result = result.filter(s => (s[field] || 0) <= numVal);
          }
        });

        // Sort
        result.sort((a, b) => {
          const aVal = a[sortBy.key] || 0;
          const bVal = b[sortBy.key] || 0;
          return sortBy.dir === 'asc' ? aVal - bVal : bVal - aVal;
        });

        return result;
      }, [stocks, search, selectedSector, selectedTheme, selectedPreset, filters, sortBy]);

      const sectorAverages = useMemo(() => {
        const byS = {};
        stocks.forEach(s => {
          if (!s.sector) return;
          if (!byS[s.sector]) byS[s.sector] = { pe: [], roe: [] };
          if (s.pe) byS[s.sector].pe.push(s.pe);
          if (s.roe) byS[s.sector].roe.push(s.roe);
        });
        Object.keys(byS).forEach(sec => {
          byS[sec] = {
            pe: byS[sec].pe.reduce((a, b) => a + b, 0) / (byS[sec].pe.length || 1),
            roe: byS[sec].roe.reduce((a, b) => a + b, 0) / (byS[sec].roe.length || 1),
          };
        });
        return byS;
      }, [stocks]);

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // ACTIONS
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      const toggleWatchlist = (symbol) => {
        setWatchlist(prev => {
          const updated = prev.includes(symbol) ? prev.filter(s => s !== symbol) : [...prev, symbol];
          localStorage.setItem('watchlist', JSON.stringify(updated));
          return updated;
        });
      };

      const applyPreset = (presetId) => {
        setSelectedPreset(presetId);
        const preset = PRESET_SCREENS[presetId];
        if (preset) {
          setFilters(prev => ({ ...prev, ...preset.filters }));
        }
      };

      const clearFilters = () => {
        setFilters({
          pe_min: '', pe_max: '',
          roe_min: '', roe_max: '',
          marketCap_min: '', marketCap_max: '',
          changePct_min: '', changePct_max: '',
          rsi_min: '', rsi_max: '',
        });
        setSelectedPreset('');
        setSelectedTheme('');
        setSelectedSector('');
      };

      const dismissToast = (id) => {
        setToasts(prev => prev.filter(t => t.id !== id));
      };

      const dismissError = (id) => {
        setErrors(prev => prev.filter(e => e.id !== id));
      };

      const computePortfolioRecs = () => {
        const watchlistedStocks = stocks.filter(s => watchlist.includes(s.symbol));
        if (!watchlistedStocks.length) return [];

        const recs = watchlistedStocks.map(s => ({
          symbol: s.symbol,
          sector: s.sector,
          edgeScore: (s.aiScore || 50) / 100, // Use unified aiScore (0-100)
          riskScore: (s.subscores?.risk || 50) / 100, // Use risk subscore
        }));

        const totalEdge = recs.reduce((sum, r) => sum + r.edgeScore, 0) || 1;
        recs.forEach(r => {
          r.suggestedWeight = (r.edgeScore / totalEdge) * 100;
        });

        return recs.sort((a, b) => b.suggestedWeight - a.suggestedWeight);
      };

      useEffect(() => {
        if (showPortfolio) {
          setPortfolioRecs(computePortfolioRecs());
        }
      }, [showPortfolio]);
      
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // REAL-TIME DATA CONNECTION MANAGEMENT
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      
      useEffect(() => {
        // Listen to WebSocket connection status
        const handleConnectionChange = (connected) => {
          console.log(`ğŸ“¡ WebSocket connection status: ${connected ? 'CONNECTED' : 'DISCONNECTED'}`);
          setIsWebSocketConnected(connected);
        };
        
        realtimeData.onConnectionChange(handleConnectionChange);

        // Attempt WebSocket connection (falls back to smart polling if it fails)
        realtimeData.connect();
        
        // Set initial connection status
        setIsWebSocketConnected(realtimeData.isConnected);
        
        // Cleanup on unmount
        return () => {
          console.log('ğŸ§¹ Cleaning up real-time data subscriptions...');
          realtimeData.disconnect();
          smartPoller.stopAll();
        };
      }, []);
      
      // Subscribe to real-time updates for watchlist stocks
      useEffect(() => {
        if (watchlist.length === 0) return;
        
        const updateCallbacks = new Map();
        
        watchlist.forEach(symbol => {
          const callback = (update) => {
            // Update the stock in the stocks array
            setStocks(prevStocks => {
              const index = prevStocks.findIndex(s => s.symbol === symbol);
              if (index !== -1) {
                const updated = [...prevStocks];
                updated[index] = {
                  ...updated[index],
                  price: update.price,
                  change: update.change,
                  changePct: update.changesPercentage || update.change,
                  volume: update.volume,
                  quoteFetchedAt: update.quoteFetchedAt
                };
                return updated;
              }
              return prevStocks;
            });
          };
          
          updateCallbacks.set(symbol, callback);
          
          // Subscribe to WebSocket updates
          if (isWebSocketConnected) {
            realtimeData.subscribe(symbol, callback);
          } else {
            // Fallback to smart polling if WebSocket not available
            smartPoller.startPolling(symbol, callback);
          }
        });
        
        // Cleanup subscriptions when watchlist changes
        return () => {
          watchlist.forEach(symbol => {
            const callback = updateCallbacks.get(symbol);
            if (callback) {
              realtimeData.unsubscribe(symbol, callback);
              smartPoller.stopPolling(symbol);
            }
          });
        };
      }, [watchlist, isWebSocketConnected]);

      const exportTableCSV = () => {
        const data = filtered.map(stock => {
          const row = {};
          ALL_COLUMNS.forEach(col => {
            if (visibleColumns.includes(col.key)) {
              row[col.label] = stock[col.key] || 'â€”';
            }
          });
          return row;
        });
        
        exportToCSV(data, 'stocks.csv');
      };

      const openComparison = (symbols = []) => {
        setComparisonSymbols(symbols);
        setShowComparison(true);
      };

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // RENDER
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      const connectionLabel = isWebSocketConnected ? 'LIVE' : (lastUpdateTime ? 'POLLING' : 'CONNECTING');
      const showOfflineStyle = !isWebSocketConnected && !lastUpdateTime;
      const connectionTitle = isWebSocketConnected
        ? 'Real-time updates via Finnhub WebSocket'
        : (lastUpdateTime ? 'Updates running via smart polling' : 'Initializing data connection...');

      return (
        <div className="min-h-screen p-6">
          {/* Error Display */}
          {errors.length > 0 && (
            <div className="mb-6 space-y-2">
              {errors.map(error => (
                <div key={error.id} className="glass p-4 rounded-xl border border-red-500/20 bg-red-500/10">
                  <div className="flex items-start justify-between">
                    <div className="flex-1">
                      <div className="flex items-center gap-2 text-red-400 font-semibold">
                        <i className="fas fa-exclamation-triangle"></i>
                        <span>{error.message}</span>
                      </div>
                      {error.details && (
                        <div className="text-sm text-slate-300 mt-1">{error.details}</div>
                      )}
                      <div className="text-xs text-slate-500 mt-2">
                        {new Date(error.timestamp).toLocaleTimeString()}
                      </div>
                    </div>
                    <button 
                      onClick={() => dismissError(error.id)}
                      className="text-slate-400 hover:text-white ml-4"
                    >
                      âœ•
                    </button>
                  </div>
                </div>
              ))}
            </div>
          )}
          
          {/* Live Price Ticker */}
          {watchlist.length > 0 && (
            <LivePriceTicker stocks={stocks} watchlist={watchlist} isConnected={isWebSocketConnected} />
          )}

          {/* Header */}
          <header className="glass rounded-2xl p-6 mb-6 animate-slide-up">
            <div className="flex items-center justify-between mb-3">
              <div>
                <h1 className="text-3xl font-bold text-white mb-1">
                  RetailEdge Pro <span className="text-xs text-slate-500 font-normal ml-2">v2.0</span>
                </h1>
                <p className="text-sm text-slate-400">Portfolio Tracking â€¢ Alerts â€¢ Sector-Aware AI</p>
              </div>
              <div className="flex items-center gap-3">
                {/* Firebase Auth Button */}
                {!authLoading && (
                  <div className="flex items-center gap-2">
                    {firebaseUser ? (
                      <>
                        <span className="text-xs text-slate-400">
                          <i className="fas fa-user-circle mr-1"></i>
                          {firebaseUser.email}
                        </span>
                        <button 
                          onClick={signOutUser} 
                          className="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg text-sm flex items-center gap-2 transition"
                          title="Sign out"
                        >
                          <i className="fas fa-sign-out-alt"></i>
                          Sign Out
                        </button>
                      </>
                    ) : (
                      <button 
                        onClick={signInWithGoogle} 
                        className="px-3 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-sm flex items-center gap-2 transition"
                        title="Sign in with Google to sync across devices"
                      >
                        <i className="fab fa-google"></i>
                        Sign In
                      </button>
                    )}
                  </div>
                )}
                
                {/* Share Watchlist Button */}
                {watchlist.length > 0 && (
                  <button 
                    onClick={shareWatchlist} 
                    className="px-3 py-2 bg-violet-600 hover:bg-violet-500 text-white rounded-lg text-sm flex items-center gap-2 transition"
                    title="Share your watchlist via link"
                  >
                    <i className="fas fa-share-alt"></i>
                    Share
                  </button>
                )}
              </div>
            </div>
            
            {/* Status indicators row */}
            <div className="flex items-center gap-3 flex-wrap mb-4 text-xs">
              {/* Real-Time Connection Status */}
              <div className={`live-indicator ${showOfflineStyle ? 'offline' : ''}`} title={connectionTitle}>
                <div className="live-dot"></div>
                <span>{connectionLabel}</span>
              </div>
              
              {lastUpdateTime && (
                <>
                  <span className="text-slate-600">â€¢</span>
                  <div className="flex items-center gap-2">
                    <span className="text-slate-500">
                      Updated: {lastUpdateTime.toLocaleTimeString()}
                    </span>
                  </div>
                  {nextUpdateTime && (
                    <>
                      <span className="text-slate-600">â€¢</span>
                      <span className="text-slate-500">
                        Next: {nextUpdateTime.toLocaleTimeString()}
                      </span>
                    </>
                  )}
                  <span className="text-slate-600">â€¢</span>
                  <span className="text-emerald-400" title={`${Cache.stats().count} stocks cached, ${Cache.stats().sizeKB}KB used. ${Cache.isMarketOpen() ? 'Market is OPEN - cache expires faster' : 'Market CLOSED - using 24hr cache'}`}>
                    <i className="fas fa-database mr-1"></i>
                    {Cache.stats().count} cached
                  </span>
                  {Cache.isMarketOpen() && (
                    <>
                      <span className="text-slate-600">â€¢</span>
                      <span className="text-green-400">
                        <i className="fas fa-circle text-xs mr-1 animate-pulse"></i>
                        Market Open
                      </span>
                    </>
                  )}
                  
                  {/* Data Delay Badge */}
                  <span className="text-slate-600">â€¢</span>
                  <DelayBadge />
                </>
              )}
            </div>
            
            <div className="flex items-center gap-3 flex-wrap">
                <button 
                  onClick={manualRefresh} 
                  disabled={loading}
                  className="px-4 py-2 bg-slate-700 hover:bg-slate-600 disabled:bg-slate-800 disabled:cursor-not-allowed text-white rounded-lg font-semibold text-sm flex items-center gap-2 transition"
                  title="Refresh stock data now"
                >
                  {loading ? (
                    <>
                      <i className="fas fa-spinner animate-spin"></i>
                      Refreshing...
                    </>
                  ) : (
                    <>
                      <i className="fas fa-sync-alt"></i>
                      Refresh
                    </>
                  )}
                </button>
                <button 
                  onClick={() => {
                    Cache.clear();
                    manualRefresh();
                  }} 
                  disabled={loading}
                  className="px-4 py-2 bg-orange-600 hover:bg-orange-500 disabled:bg-orange-800 disabled:cursor-not-allowed text-white rounded-lg font-semibold text-sm flex items-center gap-2 transition"
                  title={`Clear cache (${Cache.stats().count} items, ${Cache.stats().sizeKB}KB)`}
                >
                  <i className="fas fa-trash"></i>
                  Clear Cache
                </button>
                <button onClick={() => setShowComparison([])} className="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg font-semibold text-sm flex items-center gap-2">
                  <i className="fas fa-balance-scale"></i>
                  Compare
                </button>
                <button onClick={() => setShowHeatmap(true)} className="px-4 py-2 bg-pink-600 hover:bg-pink-500 text-white rounded-lg font-semibold text-sm flex items-center gap-2">
                  <i className="fas fa-th"></i>
                  Heatmap
                </button>
                <button onClick={() => setShowStockManager(true)} className="px-4 py-2 bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg font-semibold text-sm flex items-center gap-2">
                  <i className="fas fa-edit"></i>
                  Stocks ({curatedStocks.length})
                </button>
                <button onClick={() => setShowWatchlistImporter(true)} className="px-4 py-2 bg-teal-600 hover:bg-teal-500 text-white rounded-lg font-semibold text-sm flex items-center gap-2" title="Import watchlist from text, CSV, or JSON">
                  <i className="fas fa-file-import"></i>
                  Import
                </button>
                <button onClick={() => setShowAlerts(true)} className="px-4 py-2 bg-yellow-600 hover:bg-yellow-500 text-white rounded-lg font-semibold text-sm flex items-center gap-2">
                  <i className="fas fa-bell"></i>
                  Alerts ({alerts.filter(a => a.active).length})
                </button>
                <button onClick={() => setShowPortfolio(true)} className="px-4 py-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg font-semibold text-sm flex items-center gap-2">
                  <i className="fas fa-chart-line"></i>
                  Portfolio ({window.portfolioManager?.holdings?.length || 0})
                </button>
                <button onClick={() => setShowGoalPlanner(true)} className="px-4 py-2 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white rounded-lg font-semibold text-sm flex items-center gap-2">
                  <i className="fas fa-bullseye"></i>
                  Goals
                </button>
                <button onClick={() => setShowRebalancing(true)} className="px-4 py-2 bg-gradient-to-r from-cyan-600 to-teal-600 hover:from-cyan-500 hover:to-teal-500 text-white rounded-lg font-semibold text-sm flex items-center gap-2">
                  <i className="fas fa-balance-scale"></i>
                  Rebalance
                </button>
                <button onClick={() => setShowTaxCenter(true)} className="px-4 py-2 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white rounded-lg font-semibold text-sm flex items-center gap-2">
                  <i className="fas fa-file-invoice-dollar"></i>
                  Tax
                </button>
                <button onClick={() => setShowCommunity(true)} className="px-4 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-500 hover:to-indigo-500 text-white rounded-lg font-semibold text-sm flex items-center gap-2">
                  <i className="fas fa-users"></i>
                  Community
                </button>
                <button onClick={() => setShowAdvancedAnalytics(true)} className="px-4 py-2 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white rounded-lg font-semibold text-sm flex items-center gap-2" disabled={portfolio.length === 0}>
                  <i className="fas fa-chart-line"></i>
                  Advanced Analytics
                </button>
                <button onClick={() => setShowInvestorGuardrails(true)} className="px-4 py-2 bg-gradient-to-r from-emerald-600 to-teal-600 hover:from-emerald-500 hover:to-teal-500 text-white rounded-lg font-semibold text-sm flex items-center gap-2" disabled={portfolio.length === 0}>
                  <i className="fas fa-shield-halved"></i>
                  Guardrails
                </button>
                <button onClick={() => setShowBadges(true)} className="px-4 py-2 bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-500 hover:to-orange-500 text-white rounded-lg font-semibold text-sm flex items-center gap-2">
                  <i className="fas fa-trophy"></i>
                  Badges
                </button>
                <button onClick={() => setShowSharePortfolio(true)} className="px-4 py-2 bg-gradient-to-r from-pink-600 to-purple-600 hover:from-pink-500 hover:to-purple-500 text-white rounded-lg font-semibold text-sm flex items-center gap-2" disabled={portfolio.length === 0}>
                  <i className="fas fa-share-nodes"></i>
                  Share
                </button>
                <button onClick={() => setShowPortfolioAllocation(true)} className="px-4 py-2 bg-emerald-600 hover:bg-emerald-500 text-white rounded-lg font-semibold text-sm flex items-center gap-2">
                  <i className="fas fa-chart-pie"></i>
                  Allocation ({watchlist.length})
                </button>
                <button onClick={() => setShowEducation(true)} className="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg font-semibold text-sm flex items-center gap-2">
                  <i className="fas fa-graduation-cap"></i>
                  Learn
                </button>
                <button 
                  onClick={() => setShowNotifications(true)} 
                  className="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold text-sm relative"
                >
                  <i className="fas fa-bell"></i>
                  {notificationCount > 0 && (
                    <span className="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full min-w-[20px] text-center">
                      {notificationCount}
                    </span>
                  )}
                </button>
                <button onClick={() => setShowSettings(true)} className="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold text-sm">
                  <i className="fas fa-cog"></i>
                </button>
                <button 
                  onClick={() => {
                    const shortcuts = window.keyboardShortcuts?.getHelp() || [];
                    const helpText = shortcuts.length > 0 
                      ? 'âŒ¨ï¸ KEYBOARD SHORTCUTS:\n\n' + shortcuts.map(s => `${s.key.padEnd(15)} ${s.description}`).join('\n')
                      : 'No shortcuts registered yet';
                    alert(helpText);
                  }}
                  className="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold text-sm flex items-center gap-2"
                  title="Keyboard shortcuts"
                >
                  <i className="fas fa-keyboard"></i>
                </button>
              </div>
            </header>

          {/* Controls */}
          <div className="glass rounded-2xl p-6 mb-6 space-y-4 animate-slide-up">
            {/* Search & Quick Filters */}
            <div className="flex gap-3">
              <div className="flex-1 relative">
                <input 
                  type="text" 
                  value={search} 
                  onChange={(e) => setSearch(e.target.value)}
                  onKeyDown={async (e) => {
                    if (e.key === 'Enter' && search.trim()) {
                      e.preventDefault();
                      let symbol = search.trim().toUpperCase();
                      
                      // Common company name to ticker mappings
                      const nameToTicker = {
                        'NVIDIA': 'NVDA', 'APPLE': 'AAPL', 'MICROSOFT': 'MSFT', 
                        'AMAZON': 'AMZN', 'GOOGLE': 'GOOGL', 'TESLA': 'TSLA',
                        'META': 'META', 'FACEBOOK': 'META', 'NETFLIX': 'NFLX',
                        'GAMESTOP': 'GME', 'COINBASE': 'COIN', 'PALANTIR': 'PLTR',
                        'WALMART': 'WMT', 'DISNEY': 'DIS', 'MCDONALDS': 'MCD',
                        'STARBUCKS': 'SBUX', 'INTEL': 'INTC', 'AMD': 'AMD',
                        'BOEING': 'BA', 'FORD': 'F', 'GM': 'GM', 'GENERAL MOTORS': 'GM'
                      };
                      
                      // Convert company name to ticker if found
                      if (nameToTicker[symbol]) {
                        symbol = nameToTicker[symbol];
                        console.log(`ğŸ“ Converted "${search.trim()}" to ${symbol}`);
                      }
                      
                      // Check if stock already exists
                      const exists = stocks.find(s => s.symbol === symbol);
                      if (exists) {
                        console.log('âœ… Stock already loaded:', symbol);
                        setSearch('');
                        return;
                      }
                      
                      try {
                        console.log('ğŸ” Fetching comprehensive data for:', symbol);
                        
                        const stockData = await fetchSingleStockData(symbol);
                        const ai = generateAIAnalysis(stockData);
                        let mlPrediction = { predPct: null, conf: null, trend: null };
                        try {
                          mlPrediction = await computeMLPrediction(symbol);
                        } catch (e) {
                          console.warn(`ML prediction failed for ${symbol}:`, e);
                        }
                        // Create fresh analysis object to avoid reference sharing
                        const finalStock = {
                          ...stockData,
                          ...ai,
                          aiScore: ai.aiScore,
                          mlPrediction,
                          // Deep copy AI analysis
                          subscores: ai.subscores ? { ...ai.subscores } : null,
                          topDrivers: ai.topDrivers ? {
                            positive: [...(ai.topDrivers.positive || [])],
                            negative: [...(ai.topDrivers.negative || [])]
                          } : null,
                          bullFactors: [...(ai.bullFactors || [])],
                          bearFactors: [...(ai.bearFactors || [])],
                          // Deep copy stockData arrays
                          latestNews: stockData.latestNews ? [...stockData.latestNews] : [],
                          peers: stockData.peers ? [...stockData.peers] : [],
                          earningsHistory: stockData.earningsHistory ? [...stockData.earningsHistory] : [],
                          analystGradeHistory: stockData.analystGradeHistory ? [...stockData.analystGradeHistory] : [],
                        };
                        
                        setStocks(prev => [finalStock, ...prev]);
                        setSearch('');
                        
                        // Auto-add to curated list
                        if (!curatedStocks.includes(symbol)) {
                          const updated = [...curatedStocks, symbol];
                          setCuratedStocks(updated);
                          localStorage.setItem('curatedStocks', JSON.stringify(updated));
                          console.log('ğŸ’¾ Added to curated list:', symbol);
                        }
                        
                        console.log('âœ… Added:', symbol, '-', finalStock.companyName);
                        
                      } catch (err) {
                        console.error('Search error:', err);
                        addError(`Failed to fetch ${symbol}`, err.message || 'Stock not found.');
                      }
                    }
                  }}
                  placeholder="Type ticker or company name & press Enter (e.g., NVDA or Nvidia)..." 
                  className="w-full px-4 py-2.5 bg-slate-800/50 border border-slate-700 rounded-lg text-white placeholder-slate-500 focus:outline-none focus:border-cyan-500" 
                />
                <div className="absolute right-3 top-1/2 -translate-y-1/2 text-xs text-slate-500 pointer-events-none">
                  â†µ Enter
                </div>
              </div>
              
              <select value={selectedSector} onChange={(e) => setSelectedSector(e.target.value)} className="px-4 py-2.5 bg-slate-800/50 border border-slate-700 rounded-lg text-white focus:outline-none focus:border-cyan-500">
                <option value="">All Sectors</option>
                {SECTORS.map(s => <option key={s} value={s}>{s}</option>)}
              </select>

              <button onClick={clearFilters} className="px-4 py-2.5 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold text-sm">Clear</button>
            </div>

            {/* Themes */}
            <div className="flex flex-wrap gap-2">
              {THEMES.map(t => (
                <button key={t.id} onClick={() => setSelectedTheme(selectedTheme === t.id ? '' : t.id)} className={`theme-pill ${selectedTheme === t.id ? 'active' : ''}`}>
                  {t.label}
                </button>
              ))}
            </div>

            {/* Presets */}
            <div className="grid grid-cols-5 gap-3">
              {Object.entries(PRESET_SCREENS).map(([key, preset]) => (
                <div key={key} onClick={() => applyPreset(key)} className={`preset-card ${selectedPreset === key ? 'active' : ''}`}>
                  <div className="font-semibold text-white text-sm">{preset.name}</div>
                  <div className="text-xs text-slate-400 mt-1">Click to apply</div>
                </div>
              ))}
            </div>

            {/* Manual Filters */}
            <details className="text-sm">
              <summary className="cursor-pointer text-slate-400 hover:text-white">Advanced Filters</summary>
              <div className="grid grid-cols-4 gap-4 mt-3">
                {[
                  { label: 'P/E', min: 'pe_min', max: 'pe_max' },
                  { label: 'ROE %', min: 'roe_min', max: 'roe_max' },
                  { label: 'Market Cap', min: 'marketCap_min', max: 'marketCap_max' },
                  { label: 'Change %', min: 'changePct_min', max: 'changePct_max' },
                  { label: 'RSI', min: 'rsi_min', max: 'rsi_max' },
                ].map(f => (
                  <div key={f.label}>
                    <label className="text-xs text-slate-500 mb-1 block">{f.label}</label>
                    <div className="flex gap-2">
                      <input type="number" value={filters[f.min]} onChange={(e) => setFilters(prev => ({ ...prev, [f.min]: e.target.value }))} placeholder="Min" className="w-1/2 px-2 py-1.5 bg-slate-800/50 border border-slate-700 rounded text-white text-xs focus:outline-none focus:border-cyan-500" />
                      <input type="number" value={filters[f.max]} onChange={(e) => setFilters(prev => ({ ...prev, [f.max]: e.target.value }))} placeholder="Max" className="w-1/2 px-2 py-1.5 bg-slate-800/50 border border-slate-700 rounded text-white text-xs focus:outline-none focus:border-cyan-500" />
                    </div>
                  </div>
                ))}
              </div>
            </details>
          </div>

          {/* Thematic Portfolios Section */}
          <div className="glass rounded-2xl p-6 mb-6 animate-fade-in">
            <div className="flex items-center gap-2 mb-4">
              <i className="fas fa-layer-group text-cyan-400"></i>
              <h2 className="text-xl font-bold text-white">ğŸ¯ Thematic Investing Portfolios</h2>
            </div>
            <p className="text-sm text-slate-400 mb-4">
              Pre-built baskets for major megatrends. Each is equally weighted and ready to add to your watchlist.
            </p>
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
              {Object.values(THEMATIC_PORTFOLIOS).map(theme => {
                // Calculate average upside from stocks data
                const avgUpside = theme.stocks.reduce((sum, sym) => {
                  const stock = filtered.find(s => s.symbol === sym);
                  return sum + (stock?.['2_Year_Upside_Percent'] || 0);
                }, 0) / theme.stocks.length;

                return (
                  <div key={theme.id} className="glass-card p-5 rounded-xl hover:border-cyan-500/30 transition">
                    <div className="flex items-start justify-between mb-3">
                      <div>
                        <h3 className="font-bold text-white">{theme.name}</h3>
                        <p className="text-xs text-slate-400 mt-1">{theme.description}</p>
                      </div>
                      <span className={`chip text-xs ${
                        theme.risk === 'low' ? 'bg-green-500/20 text-green-400' :
                        theme.risk === 'medium' ? 'bg-yellow-500/20 text-yellow-400' :
                        'bg-red-500/20 text-red-400'
                      }`}>
                        {theme.risk.charAt(0).toUpperCase() + theme.risk.slice(1)} Risk
                      </span>
                    </div>
                    <div className="text-xs text-slate-500 mb-2">Avg 2-Year Upside</div>
                    <div className={`text-lg font-bold mb-3 ${
                      avgUpside > 30 ? 'text-green-400' : avgUpside > 15 ? 'text-yellow-400' : 'text-slate-400'
                    }`}>
                      +{avgUpside.toFixed(1)}%
                    </div>
                    <div className="text-xs text-slate-500 mb-3">
                      <strong>{theme.stocks.length} stocks:</strong> {theme.stocks.slice(0, 4).join(', ')}
                      {theme.stocks.length > 4 && ` +${theme.stocks.length - 4} more`}
                    </div>
                    <button
                      onClick={() => {
                        // Add all stocks in this theme to watchlist
                        theme.stocks.forEach(sym => {
                          if (!watchlist.includes(sym)) {
                            setWatchlist(prev => [...prev, sym]);
                          }
                        });
                        localStorage.setItem('watchlist', JSON.stringify([...new Set([...watchlist, ...theme.stocks])]));
                        setToasts(prev => [...prev, {
                          id: Date.now(),
                          message: `Added ${theme.stocks.length} stocks from ${theme.name} to watchlist`,
                          timestamp: new Date()
                        }]);
                      }}
                      className="w-full px-3 py-2 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white text-sm rounded-lg font-semibold transition"
                    >
                      <i className="fas fa-eye mr-1"></i> Add All to Watchlist
                    </button>
                  </div>
                );
              })}
            </div>
          </div>

          {/* Sector Heatmap (Collapsible) */}
          {showHeatmap && (
            <div className="glass rounded-2xl p-6 mb-6 animate-slide-up">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-bold text-white flex items-center gap-2">
                  <i className="fas fa-th text-pink-400"></i>
                  Sector Rotation Heatmap
                </h3>
                <button onClick={() => setShowHeatmap(false)} className="text-slate-400 hover:text-white">
                  <i className="fas fa-times"></i>
                </button>
              </div>
              
              {(() => {
                // Group stocks by sector
                const sectorGroups = {};
                stocks.forEach(stock => {
                  const sector = stock.sector || 'Unknown';
                  if (!sectorGroups[sector]) sectorGroups[sector] = [];
                  sectorGroups[sector].push(stock);
                });
                
                // Calculate sector performance
                const sectorPerf = Object.entries(sectorGroups).map(([sector, items]) => {
                  const avgChange = items.reduce((sum, s) => sum + (s.changePct || 0), 0) / items.length;
                  return { sector, items, avgChange };
                }).sort((a, b) => b.avgChange - a.avgChange);
                
                return (
                  <div className="space-y-4">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                      {sectorPerf.map(({ sector, items, avgChange }) => (
                        <div key={sector} className="bg-slate-800/50 rounded-xl p-3 border border-slate-700/50">
                          <div className="flex justify-between items-center mb-2 pb-2 border-b border-slate-700/30">
                            <span className="font-bold text-slate-200 text-sm truncate" title={sector}>{sector}</span>
                            <span className={`text-xs font-bold px-2 py-0.5 rounded ${avgChange >= 0 ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}`}>
                              {avgChange > 0 ? '+' : ''}{avgChange.toFixed(2)}%
                            </span>
                          </div>
                          <div className="grid grid-cols-3 gap-1">
                            {items.sort((a,b) => Math.abs(b.changePct) - Math.abs(a.changePct)).slice(0, 9).map(stock => (
                              <div 
                                key={stock.symbol}
                                onClick={() => openStockModal(stock)}
                                className={`aspect-square rounded flex flex-col items-center justify-center cursor-pointer hover:opacity-80 transition p-1 ${
                                  stock.changePct >= 3 ? 'bg-green-500' :
                                  stock.changePct >= 1 ? 'bg-green-600/80' :
                                  stock.changePct >= 0 ? 'bg-green-800/60' :
                                  stock.changePct >= -1 ? 'bg-red-800/60' :
                                  stock.changePct >= -3 ? 'bg-red-600/80' :
                                  'bg-red-500'
                                }`}
                                title={`${stock.symbol}: ${stock.changePct?.toFixed(2)}%`}
                              >
                                <span className="text-[10px] font-bold text-white leading-none">{stock.symbol}</span>
                                <span className="text-[9px] text-white/90 leading-none mt-0.5">
                                  {Math.abs(stock.changePct).toFixed(1)}%
                                </span>
                              </div>
                            ))}
                          </div>
                          {items.length > 9 && (
                            <div className="text-[10px] text-slate-500 text-center mt-2">
                              + {items.length - 9} more
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                    <div className="flex justify-center gap-4 text-xs text-slate-400">
                      <div className="flex items-center gap-2">
                        <div className="w-3 h-3 bg-green-500 rounded"></div> &gt; +3%
                      </div>
                      <div className="flex items-center gap-2">
                        <div className="w-3 h-3 bg-green-600/80 rounded"></div> +1% to +3%
                      </div>
                      <div className="flex items-center gap-2">
                        <div className="w-3 h-3 bg-green-800/60 rounded"></div> 0% to +1%
                      </div>
                      <div className="flex items-center gap-2">
                        <div className="w-3 h-3 bg-red-800/60 rounded"></div> -1% to 0%
                      </div>
                      <div className="flex items-center gap-2">
                        <div className="w-3 h-3 bg-red-600/80 rounded"></div> -3% to -1%
                      </div>
                      <div className="flex items-center gap-2">
                        <div className="w-3 h-3 bg-red-500 rounded"></div> &lt; -3%
                      </div>
                    </div>
                  </div>
                );
              })()}
            </div>
          )}

          {/* Results */}
          <main className="animate-slide-up">
            {loading ? (
              <div className="glass rounded-xl p-12 text-center">
                <i className="fas fa-spinner animate-spin text-4xl text-cyan-400 mb-4"></i>
                <p className="text-lg text-slate-300">Loading stocks...</p>
                <p className="text-sm text-slate-500 mt-2">
                  {loadingProgress.current > 0 
                    ? `Loaded ${loadingProgress.current} of ${loadingProgress.total} stocks` 
                    : `Fetching data from ${curatedStocks.length} stocks`}
                </p>
                {loadingProgress.total > 0 && (
                  <div className="mt-4 w-full max-w-md mx-auto">
                    <div className="w-full bg-slate-700/50 rounded-full h-2 overflow-hidden">
                      <div 
                        className="bg-gradient-to-r from-cyan-500 to-blue-500 h-full transition-all duration-300"
                        style={{ width: `${(loadingProgress.current / loadingProgress.total) * 100}%` }}
                      ></div>
                    </div>
                    <div className="text-xs text-slate-400 mt-2">
                      {Math.round((loadingProgress.current / loadingProgress.total) * 100)}% Complete
                    </div>
                  </div>
                )}
              </div>
            ) : filtered.length > 0 ? (
              <>
                <div className="flex justify-between items-center mb-4">
                  <div className="text-sm text-slate-400">
                    Showing {filtered.length} of {stocks.length} stocks
                  </div>
                  <div className="flex gap-3">
                    <button
                      onClick={() => openComparison(filtered.slice(0, 3).map(s => s.symbol))}
                      className="px-4 py-2 bg-purple-600 hover:bg-purple-500 text-white rounded-lg font-semibold text-sm flex items-center gap-2"
                    >
                      <i className="fas fa-balance-scale"></i>
                      Compare Top 3
                    </button>
                    <button
                      onClick={exportTableCSV}
                      className="px-4 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold text-sm flex items-center gap-2"
                    >
                      <i className="fas fa-file-export"></i>
                      Export CSV
                    </button>
                  </div>
                </div>
                <div className="glass rounded-xl overflow-hidden">
                  <div className="overflow-x-auto">
                    <table className="w-full text-sm">
                      <thead>
                        <tr className="bg-slate-800/50 text-slate-400">
                          {ALL_COLUMNS.filter(c => visibleColumns.includes(c.key)).map(col => {
                            const glossaryEntry = FINANCIAL_GLOSSARY[col.key];
                            return (
                              <th 
                                key={col.key} 
                                onClick={() => setSortBy({ key: col.key, dir: sortBy.key === col.key && sortBy.dir === 'asc' ? 'desc' : 'asc' })} 
                                className="text-left p-4 cursor-pointer hover:text-white transition relative group"
                              >
                                <div className="flex items-center gap-2">
                                  {col.label}
                                  {glossaryEntry && (
                                    <div className="relative inline-block">
                                      <i className="fas fa-info-circle text-xs text-slate-500 group-hover:text-cyan-400 transition"></i>
                                      <div className="absolute left-1/2 -translate-x-1/2 bottom-full mb-2 w-64 p-3 bg-slate-900 border border-cyan-500/30 rounded-lg shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-50 pointer-events-none">
                                        <div 
                                          className="text-xs text-slate-200 leading-relaxed text-left"
                                          dangerouslySetInnerHTML={{ __html: glossaryEntry }}
                                        />
                                        <div className="absolute left-1/2 -translate-x-1/2 top-full w-0 h-0 border-l-8 border-l-transparent border-r-8 border-r-transparent border-t-8 border-t-slate-900"></div>
                                      </div>
                                    </div>
                                  )}
                                  {sortBy.key === col.key && <span>{sortBy.dir === 'asc' ? 'â†‘' : 'â†“'}</span>}
                                </div>
                              </th>
                            );
                          })}
                        </tr>
                      </thead>
                      <tbody>
                        {filtered.map(stock => (
                          <tr key={stock.symbol} className="table-row border-t border-slate-700/20" onClick={() => openStockModal(stock)}>
                            {visibleColumns.includes('symbol') && (
                              <td className="p-4">
                                <div className="font-semibold text-cyan-300">{stock.symbol}</div>
                                <div className="text-xs text-slate-500">{stock.companyName}</div>
                                <div className="mt-1 flex items-center gap-2">
                                  <span
                                    className="text-[11px] text-slate-500"
                                    title={(stock.quoteFetchedAt || stock.fetchedAt) ? `Updated: ${new Date(stock.quoteFetchedAt || stock.fetchedAt).toLocaleString()}` : 'Updated: â€”'}
                                  >
                                    Updated {(stock.quoteFetchedAt || stock.fetchedAt) ? formatTimeAgo(stock.quoteFetchedAt || stock.fetchedAt) : 'â€”'}
                                  </span>
                                  {isStaleTimestamp(stock.quoteFetchedAt || stock.fetchedAt, 'quote') && (
                                    <span className="text-[10px] font-semibold px-2 py-0.5 rounded-full bg-red-500/15 text-red-300 border border-red-500/20">
                                      STALE
                                    </span>
                                  )}
                                </div>
                              </td>
                            )}
                            {visibleColumns.includes('smartInsight') && (
                              <td className="p-4">
                                {(() => {
                                  const insight = getSmartInsight(stock);
                                  return (
                                    <div className="flex items-center gap-2">
                                      <span className="text-lg">{insight.icon}</span>
                                      <span className={`text-xs font-medium ${insight.color} bg-slate-800/50 px-2 py-1 rounded-full border border-slate-700/50`}>
                                        {insight.text}
                                      </span>
                                    </div>
                                  );
                                })()}
                              </td>
                            )}
                            {visibleColumns.includes('price') && (
                              <td className="p-4 font-mono text-white">${stock.price?.toFixed(2) || 'â€”'}</td>
                            )}
                            {visibleColumns.includes('changePct') && (
                              <td className="p-4">
                                <span className={`font-mono font-semibold ${getSentimentColor(stock.changePct)}`}>
                                  {formatPercent(stock.changePct, 2)}
                                </span>
                              </td>
                            )}
                            {visibleColumns.includes('sparkline') && (
                              <td className="p-4">
                                {stock.sparkline && stock.sparkline.length > 0 ? (
                                  <div className="sparkline">
                                    {stock.sparkline.slice(-10).map((val, i) => {
                                      const max = Math.max(...stock.sparkline.slice(-10));
                                      const min = Math.min(...stock.sparkline.slice(-10));
                                      const range = max - min || 1;
                                      const height = ((val - min) / range) * 28;
                                      const isGreen = i === 0 ? true : val >= stock.sparkline.slice(-10)[i - 1];
                                      return <div key={i} className="sparkline-bar" style={{ height: `${height}px`, background: isGreen ? '#22c55e' : '#ef4444' }}></div>;
                                    })}
                                  </div>
                                ) : (
                                  <span className="text-slate-500">â€”</span>
                                )}
                              </td>
                            )}
                            {visibleColumns.includes('pe') && (
                              <td className="p-4 font-mono text-white">{stock.pe?.toFixed(2) || 'â€”'}</td>
                            )}
                            {visibleColumns.includes('roe') && (
                              <td className="p-4 font-mono text-white">{stock.roe?.toFixed(2) || 'â€”'}%</td>
                            )}
                            {visibleColumns.includes('roa') && (
                              <td className="p-4 font-mono text-white">{stock.roa?.toFixed(2) || 'â€”'}%</td>
                            )}
                            {visibleColumns.includes('roic') && (
                              <td className="p-4 font-mono text-white">{stock.roic?.toFixed(2) || 'â€”'}%</td>
                            )}
                            {visibleColumns.includes('grossMargin') && (
                              <td className="p-4 font-mono text-white">{stock.grossMargin?.toFixed(2) || 'â€”'}%</td>
                            )}
                            {visibleColumns.includes('operatingMargin') && (
                              <td className="p-4 font-mono text-white">{stock.operatingMargin?.toFixed(2) || 'â€”'}%</td>
                            )}
                            {visibleColumns.includes('netMargin') && (
                              <td className="p-4 font-mono text-white">{stock.netMargin?.toFixed(2) || 'â€”'}%</td>
                            )}
                            {visibleColumns.includes('revenueGrowth') && (
                              <td className="p-4">
                                <span className={`font-mono font-semibold ${stock.revenueGrowth > 0 ? 'text-green-400' : 'text-red-400'}`}>
                                  {stock.revenueGrowth > 0 ? '+' : ''}{stock.revenueGrowth?.toFixed(1) || 'â€”'}%
                                </span>
                              </td>
                            )}
                            {visibleColumns.includes('netIncomeGrowth') && (
                              <td className="p-4">
                                <span className={`font-mono font-semibold ${stock.netIncomeGrowth > 0 ? 'text-green-400' : 'text-red-400'}`}>
                                  {stock.netIncomeGrowth > 0 ? '+' : ''}{stock.netIncomeGrowth?.toFixed(1) || 'â€”'}%
                                </span>
                              </td>
                            )}
                            {visibleColumns.includes('epsGrowth') && (
                              <td className="p-4">
                                <span className={`font-mono font-semibold ${stock.epsGrowth > 0 ? 'text-green-400' : 'text-red-400'}`}>
                                  {stock.epsGrowth > 0 ? '+' : ''}{stock.epsGrowth?.toFixed(1) || 'â€”'}%
                                </span>
                              </td>
                            )}
                            {visibleColumns.includes('priceToBook') && (
                              <td className="p-4 font-mono text-white">{stock.priceToBook?.toFixed(2) || 'â€”'}</td>
                            )}
                            {visibleColumns.includes('priceToSales') && (
                              <td className="p-4 font-mono text-white">{stock.priceToSales?.toFixed(2) || 'â€”'}</td>
                            )}
                            {visibleColumns.includes('evToEbitda') && (
                              <td className="p-4 font-mono text-white">{stock.evToEbitda?.toFixed(2) || 'â€”'}</td>
                            )}
                            {visibleColumns.includes('quickRatio') && (
                              <td className="p-4 font-mono text-white">{stock.quickRatio?.toFixed(2) || 'â€”'}</td>
                            )}
                            {visibleColumns.includes('debtToAssets') && (
                              <td className="p-4 font-mono text-white">{stock.debtToAssets?.toFixed(2) || 'â€”'}</td>
                            )}
                            {visibleColumns.includes('cashRatio') && (
                              <td className="p-4 font-mono text-white">{stock.cashRatio?.toFixed(2) || 'â€”'}</td>
                            )}
                            {visibleColumns.includes('volume') && (
                              <td className="p-4 font-mono text-slate-300">{formatNumber(stock.volume)}</td>
                            )}
                            {visibleColumns.includes('analystCount') && (
                              <td className="p-4 font-mono text-cyan-300">{stock.analystCount || 'â€”'}</td>
                            )}
                            {visibleColumns.includes('rsi') && (
                              <td className="p-4">
                                <span className={`font-mono ${stock.rsi < 30 ? 'text-green-400' : stock.rsi > 70 ? 'text-red-400' : 'text-slate-300'}`}>
                                  {stock.rsi?.toFixed(0) || 'â€”'}
                                </span>
                              </td>
                            )}
                            {visibleColumns.includes('analystRating') && (
                              <td className="p-4">
                                <span className={`chip text-xs ${
                                  stock.analystRating?.startsWith('A') ? 'bg-green-500/20 text-green-400' :
                                  stock.analystRating?.startsWith('B') ? 'bg-blue-500/20 text-blue-400' :
                                  stock.analystRating?.startsWith('C') ? 'bg-yellow-500/20 text-yellow-400' :
                                  'bg-red-500/20 text-red-400'
                                }`}>
                                  {stock.analystRating || 'â€”'}
                                </span>
                              </td>
                            )}
                            {visibleColumns.includes('priceTargetAvg') && (
                              <td className="p-4 font-mono text-cyan-300">${stock.priceTargetAvg?.toFixed(2) || 'â€”'}</td>
                            )}
                            {visibleColumns.includes('piotroskiScore') && (
                              <td className="p-4">
                                <span className={`font-mono font-semibold ${
                                  stock.piotroskiScore >= 7 ? 'text-green-400' :
                                  stock.piotroskiScore >= 4 ? 'text-yellow-400' :
                                  'text-red-400'
                                }`}>
                                  {stock.piotroskiScore || 'â€”'}/9
                                </span>
                            </td>
                            )}
                            {visibleColumns.includes('altmanZScore') && (
                              <td className="p-4">
                                <span className={`font-mono ${
                                  stock.altmanZScore > 3 ? 'text-green-400' :
                                  stock.altmanZScore > 1.8 ? 'text-yellow-400' :
                                  'text-red-400'
                                }`}>
                                  {stock.altmanZScore?.toFixed(1) || 'â€”'}
                                </span>
                              </td>
                            )}
                            {visibleColumns.includes('debtToEquity') && (
                              <td className="p-4 font-mono text-white">{stock.debtToEquity?.toFixed(2) || 'â€”'}</td>
                            )}
                            {visibleColumns.includes('currentRatio') && (
                              <td className="p-4 font-mono text-white">{stock.currentRatio?.toFixed(2) || 'â€”'}</td>
                            )}
                            {visibleColumns.includes('index') && (
                              <td className="p-4">
                                <span className="chip bg-cyan-600/20 text-cyan-400 text-xs">
                                  {stock.index || 'â€”'}
                                </span>
                              </td>
                            )}
                            {visibleColumns.includes('mlPrediction') && (
                              <td className="p-4">
                                {stock.mlPrediction && stock.mlPrediction.predPct != null ? (
                                  <div className="flex flex-col">
                                    <span className={`font-mono font-semibold ${
                                      stock.mlPrediction.predPct > 0 ? 'text-green-400' : 
                                      stock.mlPrediction.predPct < 0 ? 'text-red-400' : 
                                      'text-slate-400'
                                    }`}>
                                      {formatMLPrediction(stock.mlPrediction.predPct)}
                                    </span>
                                    <span className="text-xs text-slate-500 mt-0.5">
                                      Conf: {stock.mlPrediction.conf}%
                                    </span>
                                  </div>
                                ) : (
                                  <span className="text-slate-600 font-mono">â€”</span>
                                )}
                              </td>
                            )}
                            {visibleColumns.includes('verdict') && (
                              <td className="p-4">
                                <span className={`chip ${
                                  stock.verdict === 'STRONG BUY' || stock.verdict === 'BUY' ? 'bg-green-500/20 text-green-400' : 
                                  stock.verdict === 'SELL' || stock.verdict === 'REDUCE' ? 'bg-red-500/20 text-red-400' : 
                                  'bg-yellow-500/20 text-yellow-400'
                                }`}>
                                  {stock.verdict}
                                </span>
                              </td>
                            )}
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              </>
            ) : (
              <div className="glass rounded-xl p-12 text-center">
                <i className="fas fa-search text-4xl mb-4 text-slate-500"></i>
                <p className="text-lg text-slate-300">No stocks match your criteria</p>
                <p className="text-sm text-slate-500 mt-2">Try adjusting your filters</p>
              </div>
            )}
          </main>

          {/* Toast Stack */}
          <div className="fixed bottom-4 right-4 z-[999] space-y-2">
            {toasts.map(t => (
              <div key={t.id} className="glass-elevated rounded-xl p-4 border border-cyan-500/20 w-[320px]">
                <div className="flex items-start justify-between gap-3">
                  <div>
                    <div className="text-sm font-semibold text-white">{t.symbol}</div>
                    <div className="text-xs text-slate-300 mt-0.5">{t.message}</div>
                    <div className="text-xs text-slate-500 mt-2">{new Date(t.timestamp).toLocaleTimeString()}</div>
                  </div>
                  <button onClick={() => dismissToast(t.id)} className="text-slate-400 hover:text-white">âœ•</button>
                </div>
              </div>
            ))}
          </div>

          {/* Portfolio Modal */}
          {showPortfolio && (
            <PortfolioModal 
              onClose={() => setShowPortfolio(false)} 
              stocks={stocks}
            />
          )}

          {/* Portfolio Allocation Modal */}
          {showPortfolioAllocation && (
            <PortfolioAllocationModal 
              onClose={() => setShowPortfolioAllocation(false)} 
              stocks={stocks}
              watchlist={watchlist}
            />
          )}

          {/* Alerts Modal */}
          {showAlerts && (
            <AlertsModal 
              onClose={() => setShowAlerts(false)} 
              alerts={alerts}
              setAlerts={setAlerts}
              stocks={stocks}
            />
          )}

          {/* Comparative Analysis Modal */}
          {showComparison && (
            <ComparativeAnalysisModal 
              onClose={() => setShowComparison(false)} 
              stocks={stocks}
              selectedSymbols={comparisonSymbols}
            />
          )}

          {/* Stock Manager Modal */}
          {showStockManager && (
            <div className="fixed inset-0 bg-black/60 flex items-center justify-center p-4 z-50" onClick={() => setShowStockManager(false)}>
              <div className="glass-elevated rounded-2xl p-6 max-w-2xl w-full max-h-[80vh] overflow-y-auto" onClick={(e) => e.stopPropagation()}>
                <h2 className="text-2xl font-bold text-white mb-4">
                  <i className="fas fa-edit mr-2"></i>
                  Manage Your Stock List
                </h2>
                
                {/* Add New Stock */}
                <div className="mb-6 p-4 bg-slate-800/50 rounded-lg">
                  <h3 className="text-lg font-semibold text-white mb-3">Add New Stock</h3>
                  <div className="flex gap-3">
                    <input
                      type="text"
                      value={newStockSymbol}
                      onChange={(e) => setNewStockSymbol(e.target.value)}
                      onKeyDown={(e) => e.key === 'Enter' && addToCurated()}
                      placeholder="Enter ticker symbol (e.g., AAPL)"
                      className="flex-1 px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 focus:outline-none focus:border-cyan-500"
                    />
                    <button
                      onClick={addToCurated}
                      className="px-6 py-2 bg-cyan-600 hover:bg-cyan-500 text-white rounded-lg font-semibold"
                    >
                      Add
                    </button>
                  </div>
                </div>

                {/* Current Stock List */}
                <div>
                  <h3 className="text-lg font-semibold text-white mb-3">Your Stocks ({curatedStocks.length})</h3>
                  <div className="grid grid-cols-2 gap-2">
                    {curatedStocks.map(symbol => (
                      <div key={symbol} className="flex items-center justify-between p-3 bg-slate-800/50 rounded-lg">
                        <span className="text-cyan-300 font-mono font-semibold">{symbol}</span>
                        <button
                          onClick={() => removeFromCurated(symbol)}
                          className="px-3 py-1 bg-red-600 hover:bg-red-500 text-white rounded text-sm"
                        >
                          Remove
                        </button>
                      </div>
                    ))}
                  </div>
                </div>

                {/* Close Button */}
                <div className="mt-6 flex justify-end">
                  <button
                    onClick={() => setShowStockManager(false)}
                    className="px-6 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded-lg font-semibold"
                  >
                    Close
                  </button>
                </div>
              </div>
            </div>
          )}

          {/* Settings Modal */}
          {showSettings && (
            <div className="fixed inset-0 bg-black/90 backdrop-blur-sm z-[998] flex items-center justify-center p-4" onClick={() => setShowSettings(false)}>
              <div className="glass-elevated rounded-2xl p-6 max-w-2xl w-full" onClick={(e) => e.stopPropagation()}>
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-bold text-white">Column Settings</h3>
                  <button onClick={() => setShowSettings(false)} className="text-slate-400 hover:text-white">âœ•</button>
                </div>
                <div className="space-y-3">
                  {ALL_COLUMNS.map(col => (
                    <label key={col.key} className={`column-toggle ${visibleColumns.includes(col.key) ? 'active' : ''}`}>
                      <input type="checkbox" checked={visibleColumns.includes(col.key)} onChange={(e) => {
                        setVisibleColumns(prev => e.target.checked ? [...prev, col.key] : prev.filter(k => k !== col.key));
                      }} className="w-4 h-4" />
                      <span className="text-sm text-white">{col.label}</span>
                      <span className="text-xs text-slate-500 ml-auto">{col.category}</span>
                    </label>
                  ))}
                </div>
                <div className="flex justify-end mt-4">
                  <button onClick={() => setShowSettings(false)} className="px-4 py-2 bg-slate-800 hover:bg-slate-700 border border-slate-700 text-slate-300 rounded-lg text-sm">Close</button>
                </div>
              </div>
            </div>
          )}

          {/* Watchlist Importer Modal */}
          {showWatchlistImporter && (
            <WatchlistImporter 
              onClose={() => setShowWatchlistImporter(false)}
              onImportSuccess={(result) => {
                console.log(`Imported ${result.count} symbols to group "${result.group}"`);
                
                // Add imported symbols to curatedStocks so they appear on main screen
                const newSymbols = result.symbols || [];
                setCuratedStocks(prev => {
                  const updated = [...new Set([...prev, ...newSymbols])]; // Remove duplicates
                  localStorage.setItem('curatedStocks', JSON.stringify(updated));
                  return updated;
                });
                
                // Also add to watchlist for favoriting
                setWatchlist(prev => {
                  const updated = [...new Set([...prev, ...newSymbols])]; // Remove duplicates
                  localStorage.setItem('watchlist', JSON.stringify(updated));
                  return updated;
                });
                
                setShowWatchlistImporter(false);
                
                // Show success message
                alert(`âœ… Successfully imported ${result.count} symbols!\n\nSymbols added to:\nâ€¢ Main stocks list (will be fetched)\nâ€¢ Watchlist (starred)\n\nRefreshing data...`);
                
                // Trigger data refresh
                setTimeout(() => {
                  manualRefresh();
                }, 500);
              }}
            />
          )}

          {/* Education Center Modal */}
          {showEducation && (
            <ErrorBoundary>
              <EducationCenterModal onClose={() => setShowEducation(false)} />
            </ErrorBoundary>
          )}

          {/* Financial Goal Planner Modal */}
          {showGoalPlanner && (
            <ErrorBoundary>
              <GoalPlannerModal 
                onClose={() => setShowGoalPlanner(false)}
                goals={goals}
                setGoals={setGoals}
              />
            </ErrorBoundary>
          )}

          {/* Rebalancing Dashboard */}
          {showRebalancing && (
            <ErrorBoundary>
              <RebalancingDashboard 
                portfolio={portfolio}
                stocks={stocks}
                onClose={() => setShowRebalancing(false)} 
              />
            </ErrorBoundary>
          )}

          {/* Tax Optimization Center */}
          {showTaxCenter && (
            <ErrorBoundary>
              <TaxOptimizationCenter 
                portfolio={portfolio}
                onClose={() => setShowTaxCenter(false)} 
              />
            </ErrorBoundary>
          )}
          
          {/* Badges Showcase */}
          {showBadges && (
            <ErrorBoundary>
              <BadgesShowcase 
                onClose={() => setShowBadges(false)} 
              />
            </ErrorBoundary>
          )}
          
          {/* Share Portfolio */}
          {showSharePortfolio && (
            <ErrorBoundary>
              <SharePortfolioModal 
                portfolio={portfolio}
                onClose={() => setShowSharePortfolio(false)} 
              />
            </ErrorBoundary>
          )}
          
          {/* Community Dashboard */}
          {showCommunity && (
            <ErrorBoundary>
              <CommunityDashboard 
                portfolio={portfolio}
                watchlist={watchlist}
                goals={goals}
                onClose={() => setShowCommunity(false)} 
              />
            </ErrorBoundary>
          )}
          
          {/* Advanced Portfolio Analytics */}
          {showAdvancedAnalytics && (
            <ErrorBoundary>
              <AdvancedPortfolioAnalytics 
                portfolio={portfolio}
                onClose={() => setShowAdvancedAnalytics(false)} 
              />
            </ErrorBoundary>
          )}
          
          {/* Investor Guardrails */}
          {showInvestorGuardrails && (
            <ErrorBoundary>
              <InvestorGuardrailsModal 
                portfolio={portfolio}
                onClose={() => setShowInvestorGuardrails(false)} 
              />
            </ErrorBoundary>
          )}
          
          {/* Notifications */}
          {showNotifications && (
            <ErrorBoundary>
              <NotificationBell 
                onClose={() => setShowNotifications(false)} 
              />
            </ErrorBoundary>
          )}

          {/* Stock Modal */}
          {selectedStock && (
            <ErrorBoundary>
              <StockModal 
                stock={selectedStock} 
                onClose={() => setSelectedStock(null)} 
                watchlist={watchlist} 
                toggleWatchlist={toggleWatchlist} 
                detailedDataLoading={detailedDataLoading} 
                sectorAverages={sectorAverages}
                portfolio={portfolio}
                stocks={stocks}
              />
            </ErrorBoundary>
          )}

          {/* Footer */}
          <Footer />
        </div>
      );
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // APP RENDER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    ReactDOM.createRoot(document.getElementById('root')).render(
      <ErrorBoundary>
        <App />
      </ErrorBoundary>
    );
  </script>
</body>
</html>